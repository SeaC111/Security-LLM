<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p><strong>作者: lcark、keanu</strong></p>
<h1 data-content="1" id="2959f3467042cd648e409ccd530b89cd">概述</h1>
<p><a href="https://github.com/pascal-lab/Tai-e" target="_blank">Tai-e</a>是针对java的静态程序分析框架，支持包括指针分析、数据流分析、污点分析在内的诸多静态程序分析。由于Tai-e并非专门用来做静态代码安全分析，所以并非开箱即用，在实际安全分析中使用有许多问题。准备通过大致如下多篇文章，逐渐将Tai-e改造为开箱即用的静态代码安全分析框架。</p>
<ul>
<li>分析SpringBoot应用，支持控制翻转、依赖注入、面向切面编程等特性</li>
<li>分析基于Mybatis框架的sql注入漏洞</li>
<li>优化输出结果</li>
<li>Java Api提取,更偏向于支持企业Api安全。</li>
<li>Pointer Analysis And Taint Analysis  Flow Analysis</li>
</ul>
<p>由于spring-boot实现了控制反转与面向切面编程的设计思想，使得程序并非顺序执行，因此很难通过程序入口来顺序分析所有代码。本篇文章旨在解决依赖注入、控制反转问题。<br/>
实验代码为<a href="https://github.com/lcark/Tai-e-demo" target="_blank">https://github.com/lcark/Tai-e-demo</a><br/>
本文章使用的被分析代码为<a href="https://github.com/JoyChou93/java-sec-code" target="_blank">https://github.com/JoyChou93/java-sec-code</a><br/>
阅读本篇文章前请先阅读<a href="https://xz.aliyun.com/t/13775" target="_blank">使用太阿（Tai-e）进行静态代码安全分析（spring-boot篇一）</a></p>
<h1 data-content="1" id="8feab6124616de14d55e1cedab240683">原理分析</h1>
<h2 data-content="1" id="a2c49306401588ddf03c6d65e708c783">控制反转</h2>
<p>什么是控制反转？控制反转（IoC）是一种设计原则，其中应用程序的控制权被反转，由框架或容器负责管理对象的生命周期和控制对象之间的关系。这意味着应用程序不再负责直接实例化和管理对象，而是将这些任务委托给外部的框架或容器。<br/>
以如下代码如例：</p>
<div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">MyServiceImpl</span> <span class="nf">myService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MyServiceImpl</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieRecommenderController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MyServiceImpl</span> <span class="n">service</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomeAction</span><span class="o">(){</span>
        <span class="n">service</span><span class="o">.</span><span class="na">action</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
<p>观察上面两段代码， 发现<code>service</code>的实例化和管理被Spring框架控制，而不是由应用程序直接控制。使用控制反转这样的技术可以使代码的对象的创建与使用解耦，降低组件之间的耦合度，使系统更易于维护、扩展和测试。而依赖注入是IoC的一种实现方式。它是指将一个对象的依赖关系通过构造函数、方法参数或属性注入到对象中，而不是在对象内部硬编码这些依赖关系。通过依赖注入，对象变得更加灵活和可配置。</p>
<h2 data-content="1" id="84c02480306a4f496d4901f8b24e3985">指针分析如何处理函数调用？</h2>
<p>在Tai-e，污点分析是作为指针分析的一个插件，在指针分析中完成了污点分析。所以在进一步分析控制反转前，我们需要先了解一下指针分析的基础。<br/>
指针分析就是计算指针（变量、字段）可以指向哪个对象的过程。指针分析首先需要对New语句进行分析，然后才能对Assign、store、load语句进行分析，在此基础上进行指针分析传播，以及后续method call的处理。而对New语句初始化就需要用到堆抽象技术。</p>
<h3 data-content="1" id="1eace62e08d586522bcd3d3a6ef17c9c">堆抽象</h3>
<p>指针分析首先要进行堆抽象。对指针所代表的内存内容进行建模，Tai-e使用New Stmt创建一个新的对象(NewObj) 来实现堆抽象，即将指针所代表内容用对象构造时的Stmt代替。该New Stmt如下是是构建一个堆抽象的案例。</p>
<div class="highlight"><pre><span></span><span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">A</span><span class="o">();</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">PT</span><span class="o">(</span><span class="n">a</span><span class="o">)={</span><span class="n">NewObj</span><span class="o">{&lt;</span><span class="n">New</span><span class="o">:</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[])&gt;[</span><span class="mi">0</span><span class="nd">@L4</span><span class="o">]</span> <span class="k">new</span> <span class="n">A</span><span class="o">}}</span>
</pre></div>
<p>这种堆抽象方法又叫做Allocation-Site abstraction，这是指针分析中最常见的堆抽象方法。</p>
<h3 data-content="1" id="af9b01eb41c5410d0089215094a9923c">函数调用处理</h3>
<p>在指针分析中会碰到许多函数调用，对象会沿着函数调用进行传播。在处理方法调用时时，需要分析出指针调用的具体方法。java的方法调用大概有以下四种，具体所调用方法的解析原理如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101500-aa94d57c-dcf1-1.png"/></p>
<h3 data-content="1" id="90c4e5603b0c6946d837e05fd3ab5c6f">invokeinterface和invokevirtual</h3>
<div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="na">f</span><span class="o">(</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">)</span>
</pre></div>
<p>当分析如上语句时，<code>a.f</code>所对应的函数就是指针a所对应Method即类A的方法。而在分析控制反转中，无法将<code>service</code>与其调用点关联起来，便无法分析出<code>a.f</code>实际所调用的函数<br/>
如上代码便是Tai-e中处理方法调用的相关代码：</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processCall</span><span class="o">(</span><span class="n">CSVar</span> <span class="n">recv</span><span class="o">,</span> <span class="n">PointsToSet</span> <span class="n">pts</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">recv</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">recv</span><span class="o">.</span><span class="na">getVar</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Invoke</span> <span class="n">callSite</span> <span class="o">:</span> <span class="n">var</span><span class="o">.</span><span class="na">getInvokes</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">pts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">recvObj</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// resolve callee</span>
            <span class="n">JMethod</span> <span class="n">callee</span> <span class="o">=</span> <span class="n">CallGraphs</span><span class="o">.</span><span class="na">resolveCallee</span><span class="o">(</span>
                    <span class="n">recvObj</span><span class="o">.</span><span class="na">getObject</span><span class="o">().</span><span class="na">getType</span><span class="o">(),</span> <span class="n">callSite</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">callee</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// select context</span>
                <span class="n">CSCallSite</span> <span class="n">csCallSite</span> <span class="o">=</span> <span class="n">csManager</span><span class="o">.</span><span class="na">getCSCallSite</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">callSite</span><span class="o">);</span>
                <span class="n">Context</span> <span class="n">calleeContext</span> <span class="o">=</span> <span class="n">contextSelector</span><span class="o">.</span><span class="na">selectContext</span><span class="o">(</span>
                        <span class="n">csCallSite</span><span class="o">,</span> <span class="n">recvObj</span><span class="o">,</span> <span class="n">callee</span><span class="o">);</span>
                <span class="o">......</span>
                <span class="o">......</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">plugin</span><span class="o">.</span><span class="na">onUnresolvedCall</span><span class="o">(</span><span class="n">recvObj</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">callSite</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>首先遍历pts（指针所指向堆抽象的集合），然后根据obj类型与当前函数调用callSite解析出具体调用的方法。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">JMethod</span> <span class="nf">resolveCallee</span><span class="o">(</span><span class="n">Type</span> <span class="n">type</span><span class="o">,</span> <span class="n">Invoke</span> <span class="n">callSite</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">MethodRef</span> <span class="n">methodRef</span> <span class="o">=</span> <span class="n">callSite</span><span class="o">.</span><span class="na">getMethodRef</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">callSite</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">||</span> <span class="n">callSite</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">()</span>
                <span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">methodRef</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">callSite</span><span class="o">.</span><span class="na">isSpecial</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">()</span>
                <span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">methodRef</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">(),</span> <span class="n">methodRef</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">callSite</span><span class="o">.</span><span class="na">isStatic</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">methodRef</span><span class="o">.</span><span class="na">resolveNullable</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">AnalysisException</span><span class="o">(</span><span class="s">"Cannot resolve Invoke: "</span> <span class="o">+</span> <span class="n">callSite</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><code>resolveCallee</code>对应的源码如上，如果<code>callSite</code>所调用的方法为<code>interface</code>或者<code>virtual</code>，就会根据obj的类型与方法引用派生出具体的方法。</p>
<p>dispatch会调用<code>lookupMethod</code>，其核心逻辑如下：</p>
<ol>
<li>遍历超类，如果超类含有该方法，则返回超类中的该方法</li>
<li>遍历超类的所实现的所有接口，返回接口中的该方法</li>
</ol>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">JMethod</span> <span class="nf">lookupMethod</span><span class="o">(</span><span class="n">JClass</span> <span class="n">jclass</span><span class="o">,</span> <span class="n">Subsignature</span> <span class="n">subsignature</span><span class="o">,</span>
                             <span class="kt">boolean</span> <span class="n">allowAbstract</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// JVM Spec. (11 Ed.), 5.4.3.3 Method Resolution</span>
    <span class="c1">// 1. If C is an interface, method resolution throws</span>
    <span class="c1">// an IncompatibleClassChangeError. TODO: what does this mean???</span>

    <span class="c1">// 2. Otherwise, method resolution attempts to locate the</span>
    <span class="c1">// referenced method in C and its superclasses</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">JClass</span> <span class="n">c</span> <span class="o">=</span> <span class="n">jclass</span><span class="o">;</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getSuperClass</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">JMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="n">subsignature</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">allowAbstract</span> <span class="o">||</span> <span class="o">!</span><span class="n">method</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 3. Otherwise, method resolution attempts to locate the</span>
    <span class="c1">// referenced method in the superinterfaces of the specified class C</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">JClass</span> <span class="n">c</span> <span class="o">=</span> <span class="n">jclass</span><span class="o">;</span> <span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getSuperClass</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">JClass</span> <span class="n">iface</span> <span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">JMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">lookupMethodFromSuperinterfaces</span><span class="o">(</span>
                    <span class="n">iface</span><span class="o">,</span> <span class="n">subsignature</span><span class="o">,</span> <span class="n">allowAbstract</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">method</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// TODO:</span>
    <span class="c1">//  1. check accessibility</span>
    <span class="c1">//  2. handle phantom methods</span>
    <span class="c1">//  3. double-check correctness</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="d21872fe1e114412ac619f1ff3081e6c">问题分析</h2>
<p>在使用控制反转时，类的实例化是由spring的IoC容器控制，而不是应用程序自身控制。这使得在指针分析中，无法通过传统的dispatch获取到callsite具体调用的方法，而无法解析控制反转所控制的实例。<br/>
如果我们可以分析出当前对象所对应的具体实现类，那便可以在指针分析处理call调用时获取到具体的方法调用。<br/>
代码的具体实现如下：</p>
<div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="na">addPointsTo</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">var</span><span class="o">),</span>
                                        <span class="n">solver</span><span class="o">.</span><span class="na">getHeapModel</span><span class="o">().</span><span class="na">getMockObj</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"DEPENDENCY_INJECTION"</span><span class="o">,</span> <span class="n">cls</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">cls</span><span class="o">.</span><span class="na">getType</span><span class="o">()));</span>
</pre></div>
<p>问题的关键就是<strong>如何找出，当前被注入者所对应的具体实现类</strong>。</p>
<p>spring支持两种依赖注入的配置方式:</p>
<p><strong>通过注解配置</strong></p>
<div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomizedService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">HttpService</span> <span class="n">httpService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/restTemplate/vuln1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RestTemplateUrlBanRedirects</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">){</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">httpService</span><span class="o">.</span><span class="na">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpServiceImpl</span> <span class="kd">implements</span> <span class="n">HttpService</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;&gt;(</span><span class="n">headers</span><span class="o">);</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">re</span> <span class="o">=</span> <span class="n">restTemplateBanRedirects</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">entity</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>如上代码会将字段<code>httpService</code>的配置为<code>HttpServiceImpl</code>的实例，无需在CustomizedService.java添加构造<code>httpService</code>的代码。</p>
<p><strong>通过xml文件配置</strong></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">x.y</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThingOne</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">ThingOne</span><span class="o">(</span><span class="n">ThingTwo</span> <span class="n">thingTwo</span><span class="o">,</span> <span class="n">ThingThree</span> <span class="n">thingThree</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nt">&lt;beans&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanOne"</span> <span class="na">class=</span><span class="s">"x.y.ThingOne"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"beanTwo"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"beanThree"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanTwo"</span> <span class="na">class=</span><span class="s">"x.y.ThingTwo"</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanThree"</span> <span class="na">class=</span><span class="s">"x.y.ThingThree"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
<p>通过如上配置，便可以将<code>beanTwo</code>、<code>beanThree</code> 自动配置为<code>ThingOne</code>构造参数，不需要在<code>ThingOne</code>中添加<code>beanTwo</code>、<code>beanThree</code>的构造过程。</p>
<h1 data-content="1" id="4a0f7c851f12f8d5969a65c382b1c2c8">控制反转处理</h1>
<p>如下为仓库<a href="https://github.com/JoyChou93/java-sec-code" target="_blank">https://github.com/JoyChou93/java-sec-code</a>中包含SSRF漏洞且利用了控制反转特性的代码片段</p>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/ssrf"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SSRF</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">SSRF</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">HttpService</span> <span class="n">httpService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/restTemplate/vuln1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RestTemplateUrlBanRedirects</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">){</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">httpService</span><span class="o">.</span><span class="na">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/restTemplate/vuln2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RestTemplateUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">){</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">httpService</span><span class="o">.</span><span class="na">RequestHttp</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>这个SSRF漏洞对应的调用链如下，sink点的方法为<code>org.springframework.web.client.RestTemplate#exchange</code>，所以需要把该方法加入污点分析的配置文件</p>
<div class="highlight"><pre><span></span><span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">SSRF</span><span class="err">#</span><span class="n">RestTemplateUrlBanRedirects</span>
<span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">HttpServiceImpl</span><span class="err">#</span><span class="n">RequestHttpBanRedirects</span>
<span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">RestTemplate</span><span class="err">#</span><span class="n">exchange</span>
</pre></div>
<p>另一个漏洞的sink点所调用方法与上个漏洞一致，不过调用链有所区别</p>
<div class="highlight"><pre><span></span><span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">SSRF</span><span class="err">#</span><span class="n">RestTemplateUrl</span>
<span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">HttpServiceImpl</span><span class="err">#</span><span class="n">RequestHttp</span>
<span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">RestTemplate</span><span class="err">#</span><span class="n">exchange</span>
</pre></div>
<h2 data-content="1" id="9b5908bbd40a0c2a11697591636fdf27">类CHA（Class Hierarchy Analysis）实现方式</h2>
<p>根据原理分析一节中的描述，方法调用是通过堆抽象（用obj代表具体的类）所对应的类型解析出来的，当我们分析出当前指针所对应的实际类时，需要构造如下的MockObj，并将类型配置为我们解析出来的类型。</p>
<div class="highlight"><pre><span></span><span class="k">default</span> <span class="n">Obj</span> <span class="nf">getMockObj</span><span class="o">(</span><span class="n">Descriptor</span> <span class="n">desc</span><span class="o">,</span> <span class="n">Object</span> <span class="n">alloc</span><span class="o">,</span> <span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">getMockObj</span><span class="o">(</span><span class="n">desc</span><span class="o">,</span> <span class="n">alloc</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="na">addPointsTo</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">var</span><span class="o">),</span>
                                        <span class="n">solver</span><span class="o">.</span><span class="na">getHeapModel</span><span class="o">().</span><span class="na">getMockObj</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"DEPENDENCY_INJECTION"</span><span class="o">,</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getType</span><span class="o">()));</span>
</pre></div>
<p>实际代码如上，其中<code>implementor</code>为我们所分析出的具体的实现类。本质是将解析出的实际类所代表的MockObj添加为对应指针的指向集中。<br/>
具体实现思路如下：<br/>
遍历被分析代码中的所有方法，提取出<code>Invoke</code>语句即方法调用语句</p>
<div class="highlight"><pre><span></span><span class="n">solver</span><span class="o">.</span><span class="na">getCallGraph</span><span class="o">().</span><span class="na">reachableMethods</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span>
    <span class="n">csMethod</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="s">"^(java\\.|sun\\.|javax\\.|com\\.sun\\.).+$"</span><span class="o">)){</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getIR</span><span class="o">().</span><span class="na">getStmts</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span>
            <span class="n">stmt</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="o">}</span>
    <span class="o">)</span>
<span class="o">)</span>
</pre></div>
<p>如果语句是静态方法调用或special调用，那不用分析</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="o">(</span><span class="n">stmt</span> <span class="k">instanceof</span> <span class="n">Invoke</span> <span class="n">invoke</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">invoke</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">()</span> <span class="o">||</span> <span class="n">invoke</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
        <span class="n">invoke</span><span class="o">.</span><span class="na">getRValue</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">InvokeInstanceExp</span> <span class="n">invokeInstanceExp</span><span class="o">){</span>
       <span class="c1">//执行分析逻辑</span>
<span class="o">}</span>
</pre></div>
<p>如果接受者已经有了指向信息，代表接受者并不是由控制反转构造，不用分析</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">var</span><span class="o">).</span><span class="na">getPointsToSet</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">var</span><span class="o">).</span><span class="na">getPointsToSet</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>如果对象的类型为接口，那么可能的类就是所有实现类；<br/>
如果对象的类型为类，而非接口，那么可能的类就是所有子类。</p>
<div class="highlight"><pre><span></span><span class="n">JClass</span> <span class="n">jClass</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getClass</span><span class="o">(</span><span class="n">var</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
<span class="n">Collection</span><span class="o">&lt;</span><span class="n">JClass</span><span class="o">&gt;</span> <span class="n">implementors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">if</span><span class="o">(</span><span class="n">invoke</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()){</span>
    <span class="n">implementors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getDirectImplementorsOf</span><span class="o">(</span><span class="n">jClass</span><span class="o">));</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>
    <span class="n">implementors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jClass</span><span class="o">);</span>
    <span class="n">implementors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getDirectSubclassesOf</span><span class="o">(</span><span class="n">jClass</span><span class="o">));</span>
<span class="o">}</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s %s %s\n"</span><span class="o">,</span> <span class="n">var</span><span class="o">,</span> <span class="n">jClass</span><span class="o">,</span> <span class="n">implementors</span><span class="o">);</span>
</pre></div>
<p>运行相关代码，成功获取到了<code>HttpSerivce</code>的实际类<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101550-c8b1918a-dcf1-1.png"/></p>
<p>最后将可能的类加到对象的指向集中，指针分析会再分析方法调用中找到真实调用的方法</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="o">(</span><span class="n">implementors</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">implementors</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
        <span class="n">implementor</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">solver</span><span class="o">.</span><span class="na">addPointsTo</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">var</span><span class="o">),</span>
                    <span class="n">solver</span><span class="o">.</span><span class="na">getHeapModel</span><span class="o">().</span><span class="na">getMockObj</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"DEPENDENCY_INJECTION"</span><span class="o">,</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getType</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>还有最后一个问题，对应的分析代码应该放在指针分析的哪个阶段？</p>
<p>根据<code>DefaultSolver.java</code>analyze方法的源码，指针分析会在完毕前调用<code>onPhaseFinish</code>，如果把代码放在此处，此时除控制反转外的其他分析都已经完成，会使我们的判断准确。</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">analyze</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">workList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// phase starts</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">workList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isTimeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">......</span>
            <span class="o">......</span>
        <span class="o">}</span>
        <span class="n">plugin</span><span class="o">.</span><span class="na">onPhaseFinish</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">workList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">isTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Pointer analysis stops early as it reaches time limit ({} seconds),"</span> <span class="o">+</span>
                <span class="s">" and the result may be unsound!"</span><span class="o">,</span> <span class="n">timeLimit</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">timeLimiter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// finish normally but time limiter is still running</span>
        <span class="n">timeLimiter</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">plugin</span><span class="o">.</span><span class="na">onFinish</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>完整代码如下</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">pascal.taie.analysis.pta.plugin.taint</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">pascal.taie.World</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.analysis.pta.core.cs.context.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.analysis.pta.core.solver.Solver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.analysis.pta.plugin.Plugin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.ir.exp.InvokeInstanceExp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.ir.exp.Var</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.ir.stmt.Invoke</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">pascal.taie.language.classes.JClass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DependencyInjectionHandler</span> <span class="kd">implements</span> <span class="n">Plugin</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Solver</span> <span class="n">solver</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isCalled</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DependencyInjectionHandler</span><span class="o">(){</span>
        <span class="n">isCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSolver</span><span class="o">(</span><span class="n">Solver</span> <span class="n">solver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">solver</span> <span class="o">=</span> <span class="n">solver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onPhaseFinish</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">isCalled</span><span class="o">){</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">isCalled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">solver</span><span class="o">.</span><span class="na">getCallGraph</span><span class="o">().</span><span class="na">reachableMethods</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span>
            <span class="n">csMethod</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="s">"^(java\\.|sun\\.|javax\\.|com\\.sun\\.).+$"</span><span class="o">)){</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getIR</span><span class="o">().</span><span class="na">getStmts</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span>
                    <span class="n">stmt</span> <span class="o">-&gt;</span> <span class="o">{</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">stmt</span> <span class="k">instanceof</span> <span class="n">Invoke</span> <span class="n">invoke</span> <span class="o">&amp;&amp;</span>
                                <span class="o">(</span><span class="n">invoke</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">()</span> <span class="o">||</span> <span class="n">invoke</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                                <span class="n">invoke</span><span class="o">.</span><span class="na">getRValue</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">InvokeInstanceExp</span> <span class="n">invokeInstanceExp</span><span class="o">){</span>
                            <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">invokeInstanceExp</span><span class="o">.</span><span class="na">getBase</span><span class="o">();</span>
                            <span class="n">Context</span> <span class="n">context</span> <span class="o">=</span> <span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">var</span><span class="o">).</span><span class="na">getPointsToSet</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                                    <span class="o">!</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">var</span><span class="o">).</span><span class="na">getPointsToSet</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                                <span class="k">return</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">JClass</span> <span class="n">jClass</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getClass</span><span class="o">(</span><span class="n">var</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">JClass</span><span class="o">&gt;</span> <span class="n">implementors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">invoke</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()){</span>
                                <span class="n">implementors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getDirectImplementorsOf</span><span class="o">(</span><span class="n">jClass</span><span class="o">));</span>
                            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                                <span class="n">implementors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jClass</span><span class="o">);</span>
                                <span class="n">implementors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getDirectSubclassesOf</span><span class="o">(</span><span class="n">jClass</span><span class="o">));</span>
                            <span class="o">}</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">invoke</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"RequestHttp"</span><span class="o">)){</span>
                                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s %s %s\n"</span><span class="o">,</span> <span class="n">var</span><span class="o">,</span> <span class="n">jClass</span><span class="o">,</span> <span class="n">implementors</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">implementors</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">implementors</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
                                    <span class="n">implementor</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                        <span class="n">solver</span><span class="o">.</span><span class="na">addPointsTo</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">var</span><span class="o">),</span>
                                                <span class="n">solver</span><span class="o">.</span><span class="na">getHeapModel</span><span class="o">().</span><span class="na">getMockObj</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"DEPENDENCY_INJECTION"</span><span class="o">,</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getType</span><span class="o">()));</span>
                                    <span class="o">}</span>
                                <span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>运行该代码，可以扫描出依赖于控制反转的漏洞<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101619-da0bd83c-dcf1-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101636-e41e2618-dcf1-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101725-0101ff2a-dcf2-1.png"/><br/>
但是上述方式缺乏准确性，如果一个接口有多个实现类，就无法准确识别出该指针所对应的实现类。</p>
<h2 data-content="1" id="5338a6bee9e6e81e679b41b5468ce6fc">基于注解的配置解析</h2>
<p>在代码中，控制反转是通过xml、注解进行实际配置。因此通过解析xml、注解的实际含义，会使结果更加准确。<br/>
实现思路为识别注入点以及依赖实现类，然后将依赖实现类构造成的obj添加到注入点变量的的指向集中。</p>
<div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomizedService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">HttpService</span> <span class="n">httpService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/restTemplate/vuln1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RestTemplateUrlBanRedirects</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">){</span>
        <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="o">();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON_UTF8</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">httpService</span><span class="o">.</span><span class="na">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HttpServiceImpl</span> <span class="kd">implements</span> <span class="n">HttpService</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="n">String</span> <span class="nf">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">HttpHeaders</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpEntity</span><span class="o">&lt;&gt;(</span><span class="n">headers</span><span class="o">);</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">re</span> <span class="o">=</span> <span class="n">restTemplateBanRedirects</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="n">entity</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>对于如上代码而言，需要识别出<code>CustomizedService</code>的注入点<code>httpService</code>，然后找到<code>HttpService</code>的实现类，最后把实现类<code>HttpServiceImpl</code>已obj的形式添加到变量的指向集中。<br/>
实现方法如下：</p>
<h3 data-content="1" id="d2c5a9461ba82e0209987b16844794a4">注入点识别</h3>
<div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">JField</span><span class="o">&gt;</span> <span class="n">injectedFields</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">allClasses</span><span class="o">()</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">JClass</span><span class="o">::</span><span class="n">getDeclaredFields</span><span class="o">)</span>
        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">Collection</span><span class="o">::</span><span class="n">stream</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">field</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">isInjectedField</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="s">"javax.annotation.Resource"</span><span class="o">)</span> <span class="o">||</span>
                    <span class="n">field</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="s">"org.springframework.beans.factory.annotation.Autowired"</span><span class="o">)</span> <span class="o">||</span>
                    <span class="n">field</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="s">"javax.inject.Inject"</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">isInjectedField</span><span class="o">){</span>
                <span class="n">injectedFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
</pre></div>
<p>遍历所有类的所有字段，若字段包含以下注解，则说明该字段是注入点</p>
<ul>
<li><code>javax.annotation.Resource</code></li>
<li><code>org.springframework.beans.factory.annotation.Autowired</code></li>
<li><code>javax.inject.Inject</code></li>
</ul>
<h3 data-content="1" id="2157d883c6d196a07edfc48de76fcd1c">寻找实现类</h3>
<div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">JClass</span><span class="o">&gt;</span> <span class="n">implementationClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">implementationClasses</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span>
    <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">allClasses</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">cls</span> <span class="o">-&gt;</span> <span class="n">cls</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="s">"org.springframework.stereotype.Service"</span><span class="o">)</span> <span class="o">||</span>
                    <span class="n">cls</span><span class="o">.</span><span class="na">hasAnnotation</span><span class="o">(</span><span class="s">"org.springframework.stereotype.Component"</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">())</span>
<span class="o">);</span>
</pre></div>
<p>遍历所有类，若类包含以下注解，则说明该类为实现类</p>
<ul>
<li><code>org.springframework.stereotype.Service</code></li>
<li><code>org.springframework.stereotype.Component</code></li>
</ul>
<h3 data-content="1" id="715f6f09a9f2f49575bd630e2b311ffe">将实现类与注入点关联起来</h3>
<p>如果在方法中要使用当前类的字段，会从<code>%this</code>变量中载入该字段，然后使用。<br/>
<code>[4@L281] $r4 = %this.&lt;org.joychou.controller.SSRF: org.joychou.service.HttpService httpService&gt;;</code></p>
<div class="highlight"><pre><span></span><span class="nd">@org.springframework.web.bind.annotation.GetMapping</span><span class="o">({</span><span class="s">"/restTemplate/vuln1"</span><span class="o">})</span>
<span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">RestTemplateUrlBanRedirects</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpHeaders</span> <span class="n">$r0</span><span class="o">;</span>
    <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span> <span class="n">$r1</span><span class="o">;</span>
    <span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">HttpService</span> <span class="n">$r4</span><span class="o">;</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">$r5</span><span class="o">;</span>
    <span class="o">[</span><span class="mi">0</span><span class="nd">@L279</span><span class="o">]</span> <span class="n">$r0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpHeaders</span><span class="o">;</span>
    <span class="o">[</span><span class="mi">1</span><span class="nd">@L279</span><span class="o">]</span> <span class="n">invokespecial</span> <span class="n">$r0</span><span class="o">.&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpHeaders</span><span class="o">:</span> <span class="kt">void</span> <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;()&gt;();</span>
    <span class="o">[</span><span class="mi">2</span><span class="nd">@L280</span><span class="o">]</span> <span class="n">$r1</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span><span class="o">:</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span> <span class="n">APPLICATION_JSON_UTF8</span><span class="o">&gt;;</span>
    <span class="o">[</span><span class="mi">3</span><span class="nd">@L280</span><span class="o">]</span> <span class="n">invokevirtual</span> <span class="n">$r0</span><span class="o">.&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpHeaders</span><span class="o">:</span> <span class="kt">void</span> <span class="nf">setContentType</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">MediaType</span><span class="o">)&gt;(</span><span class="n">$r1</span><span class="o">);</span>
    <span class="o">[</span><span class="mi">4</span><span class="nd">@L281</span><span class="o">]</span> <span class="n">$r4</span> <span class="o">=</span> <span class="o">%</span><span class="k">this</span><span class="o">.&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">controller</span><span class="o">.</span><span class="na">SSRF</span><span class="o">:</span> <span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">HttpService</span> <span class="n">httpService</span><span class="o">&gt;;</span>
    <span class="o">[</span><span class="mi">5</span><span class="nd">@L281</span><span class="o">]</span> <span class="n">$r5</span> <span class="o">=</span> <span class="n">invokeinterface</span> <span class="n">$r4</span><span class="o">.&lt;</span><span class="n">org</span><span class="o">.</span><span class="na">joychou</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">HttpService</span><span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">RequestHttpBanRedirects</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">,</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">HttpHeaders</span><span class="o">)&gt;(</span><span class="n">url</span><span class="o">,</span> <span class="n">$r0</span><span class="o">);</span>
    <span class="o">[</span><span class="mi">6</span><span class="nd">@L281</span><span class="o">]</span> <span class="k">return</span> <span class="n">$r5</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>如果要将实现类与注入点关联起来，就相当于把实现类与<code>LoadField</code>的返回值关联起来。具体关联代码如下：</p>
<div class="highlight"><pre><span></span><span class="n">injectedFields</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">field</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">JClass</span> <span class="n">jClass</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">();</span>

    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">JClass</span><span class="o">&gt;</span> <span class="n">subClasses</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getAllSubclassesOf</span><span class="o">(</span>
            <span class="n">World</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getClassHierarchy</span><span class="o">().</span><span class="na">getClass</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getName</span><span class="o">())</span>
    <span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">JClass</span><span class="o">&gt;</span> <span class="n">implementors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">subClasses</span><span class="o">);</span>
    <span class="n">implementors</span><span class="o">.</span><span class="na">retainAll</span><span class="o">(</span><span class="n">implementationClasses</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s %s\n"</span><span class="o">,</span> <span class="n">field</span><span class="o">,</span> <span class="n">implementors</span><span class="o">);</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">CSMethod</span><span class="o">&gt;</span> <span class="n">csMethodSet</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="na">getCallGraph</span><span class="o">().</span><span class="na">reachableMethods</span><span class="o">()</span>
            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">csMethod</span> <span class="o">-&gt;</span> <span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">jClass</span><span class="o">))</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
    <span class="n">csMethodSet</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
            <span class="n">csMethod</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Var</span><span class="o">&gt;</span> <span class="n">vars</span> <span class="o">=</span> <span class="n">csMethod</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getIR</span><span class="o">().</span><span class="na">getStmts</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">stmt</span> <span class="o">-&gt;</span> <span class="n">stmt</span> <span class="k">instanceof</span> <span class="n">LoadField</span> <span class="n">loadField</span> <span class="o">&amp;&amp;</span>
                                <span class="n">loadField</span><span class="o">.</span><span class="na">getFieldAccess</span><span class="o">().</span><span class="na">getFieldRef</span><span class="o">().</span><span class="na">resolve</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">field</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">stmt</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">LoadField</span><span class="o">)</span> <span class="n">stmt</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">AssignStmt</span><span class="o">::</span><span class="n">getLValue</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
                <span class="n">implementors</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
                        <span class="n">implementor</span> <span class="o">-&gt;</span> <span class="o">{</span>
                            <span class="n">vars</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span>
                                    <span class="n">var</span> <span class="o">-&gt;</span> <span class="o">{</span>
                                        <span class="n">solver</span><span class="o">.</span><span class="na">addPointsTo</span><span class="o">(</span><span class="n">solver</span><span class="o">.</span><span class="na">getCSManager</span><span class="o">().</span><span class="na">getCSVar</span><span class="o">(</span><span class="n">csMethod</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">var</span><span class="o">),</span>
                                                <span class="n">solver</span><span class="o">.</span><span class="na">getHeapModel</span><span class="o">().</span><span class="na">getMockObj</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"DEPENDENCY_INJECTION"</span><span class="o">,</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">implementor</span><span class="o">.</span><span class="na">getType</span><span class="o">()));</span>
                                    <span class="o">}</span>
                            <span class="o">);</span>
                        <span class="o">}</span>
                <span class="o">);</span>
            <span class="o">}</span>
    <span class="o">);</span>
<span class="o">});</span>
</pre></div>
<ol>
<li>获取注入点字段的所属类，然后获取该类中所有上下文有关的方法；</li>
<li>获取字段类型的所有子类，如果是接口，则获取所有实现类。与之前所有的实现类取交集，这个交集就是控制反转中该字段的实现类；</li>
<li>遍历第一步获取到的方法的所有语句，若语句的类型是<code>LoadField</code>，则判断其<code>FieldAccess</code>的字段是否为注入点的字段，若是，则用第二步的实现类构造<code>MockObj</code>，将其添加到<code>LoadField</code>语句的返回值的指向集中。</li>
</ol>
<p>运行代码，成功将实现类添加到指向集中并扫描出相关漏洞。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101757-147f7d84-dcf2-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101826-258f95dc-dcf2-1.png"/></p>
<h2 data-content="1" id="318e85514bc2652fdaff83d933140658">基于XML的配置解析</h2>
<p>原理与基于注解的配置解析一样，只是需要解析XML文件的具体内容。本篇文章不在赘述。</p>
<h1 data-content="1" id="6cbf83e2a780f7b293178e999883ddd2">结果展示</h1>
<p>更改的相关代码以及配置文件已经上传至github，见<a href="https://github.com/lcark/Tai-e-demo/tree/main/spring-boot-2" target="_blank">https://github.com/lcark/Tai-e-demo/tree/main/spring-boot-2</a><br/>
具体食用方法如下：</p>
<p>1.下载代码，并移动至spring-boot-2目录下</p>
<div class="highlight"><pre><span></span>git clone https://github.com/lcark/Tai-e-demo
<span class="nb">cd</span> Tai-e-demo/spring-boot-2
git submodule update --init
</pre></div>
<p>2.将DependencyInjectionHandler.java移动至Tai-e源码的src/main/java/pascal/taie/analysis/pta/plugin/taint/目录下，并重新编译打包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101846-313d3fe2-dcf2-1.png"/></p>
<p>3.使用如下命令运行tai-e便可以成功获取到扫描结果</p>
<div class="highlight"><pre><span></span>java -cp ~/Downloads/Tai-e/build/tai-e-all-0.5.1-SNAPSHOT.jar pascal.taie.Main --options-file<span class="o">=</span>options.yml
</pre></div>
<p>4.如下图所示，两个测试案例都被检测到</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240308101915-4300f066-dcf2-1.png"/></p>
<h1 data-content="1" id="47dd3f8c75a6d816dad1c0f8ba1f71ed">参考链接</h1>
<p>[0]. <a href="https://docs.spring.io/spring-framework/reference/core/beans/child-bean-definitions.html" target="_blank">https://docs.spring.io/spring-framework/reference/core/beans/child-bean-definitions.html</a><br/>
[1]. <a href="https://tai-e.pascal-lab.net/pa4.html" target="_blank">https://tai-e.pascal-lab.net/pa4.html</a><br/>
[2]. <a href="https://github.com/lcark/Tai-e-demo" target="_blank">https://github.com/lcark/Tai-e-demo</a></p>
</div>
</div>