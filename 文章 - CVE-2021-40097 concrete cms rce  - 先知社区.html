<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p><strong>前言</strong><br/>
某日逛cve，发现一个后台的rce，挺感兴趣就跟了一下，记录一些当时的过程。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419161358-a9916ef4-bfb8-1.png"/><br/>
<strong>概况</strong><br/>
参考<a href="https://hackerone.com/reports/1102067" target="_blank">https://hackerone.com/reports/1102067</a>的说法，这是一个Authenticated path traversal to RCE,就还是路径的问题，导致后台在渲染页面的时候包含了可以通过路径穿越抵达的任意文件，造成了rce。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419161822-47618830-bfb9-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419162425-1f4b9d12-bfba-1.png"/><br/>
通过描述，bFilename参数是在editing layout design过程中可以通过抓包工具进行赋值，在后台渲染页面返回给前端的时候包含了该文件，前提要通过后台上传一个图片格式文件（内含php马），拿到返回路径后通过../../的格式设置路径，从而达到包含。<br/>
<strong>主要记录的原因</strong><br/>
这里我复现完之后想看下代码的主要原因在于，渲染过程是如何调用到通过bFilename设置的文件，顺带想想自己如何通过整个流程，拓宽一些代码审计的思路。<br/>
<strong>简单分析</strong><br/>
<strong>一是设置bFilename：</strong><br/>
观察save layout design的请求，传递了一些重要的参数，bID和cID等，（因为部分截图在记录前，所以实际有出入）并且post bFilename，</p>
<pre><code>POST /index.php/ccm/system/dialogs/block/design/submit?ccm_token=1650357492:7676740d3352aabc79c4f5a0be7581d0&amp;cID=230&amp;arHandle=Main&amp;bID=195 HTTP/1.1
Host: www.concretetest.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 383
Origin: http://www.concretetest.com
Connection: close
Referer: http://www.concretetest.com/index.php?cID=230&amp;ctask=check-out-first&amp;ccm_token=1650357434:13fd818e280cd778e785055e257ed9e6
Cookie: CONCRETE5=0cba5r25gampmlu1glq65fgmk7; CONCRETE5_LOGIN=1; ConcreteSitemapTreeID=1

bFilename=&amp;textColor=&amp;linkColor=&amp;alignment=&amp;backgroundColor=&amp;backgroundImageFileID=0&amp;backgroundRepeat=no-repeat&amp;backgroundSize=auto&amp;backgroundPosition=left+top&amp;borderColor=&amp;borderStyle=&amp;boxShadowColor=&amp;hideOnDevice%5B10%5D=0&amp;hideOnDevice%5B20%5D=0&amp;hideOnDevice%5B30%5D=0&amp;hideOnDevice%5B40%5D=0&amp;customID=&amp;customElementAttribute=&amp;enableBlockContainer=-1&amp;__ccm_consider_request_as_xhr=1</code></pre>
<p>通过路由请求到后台的concrete/controllers/dialog/block/design.php：36 submit()<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419164622-309906ba-bfbd-1.png"/><br/>
简单分析一下（多的也不会）：38行鉴权，通过47行获取到了传递进来的参数，68行bFilename进入了$data数组，紧接着调用updateBlockInformation($data)<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419165126-e5b0411c-bfbd-1.png"/><br/>
看注释，这是一个数据库更新的操作，通过bID进行更新，通过这一步就将文件路径写入到数据库中。（文件可以通过后台任意上传功能上传）<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419165854-f08f1cd8-bfbe-1.png"/></p>
<p><strong>二是渲染执行的过程：</strong><br/>
也没有从头开始跟，因为最后是include，所以我就直接把上传的文件改成php后缀，然后在代码执行处打上断点，便直接开始了：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419170507-cf35c662-bfbf-1.png"/><br/>
因为返回的过程中只传入了一个参数（后面分析得到也就是cID），这里想看看最后是如何引用bFilename指定的文件。<br/>
请求site/index.php/!drafts/229中，在concrete/src/Http/Middleware/DispatcherDelegate.php：39会对请求进行处理：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419193045-270af22c-bfd4-1.png"/><br/>
concrete/src/Http/DefaultDispatcher.php：59进一步处理请求：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419193215-5d016a64-bfd4-1.png"/><br/>
跟进concrete/src/Http/DefaultDispatcher.php handleDispatch：130：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419193338-8e741d94-bfd4-1.png"/><br/>
concrete/src/Page/Page.php getFromRequest：476数据库查询语句：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419193635-f7dba2a2-bfd4-1.png"/></p>
<div class="highlight"><pre><span></span><span class="x">$row = $db-&gt;fetchAssoc('select pp.cID, ppIsCanonical from PagePaths pp inner join Pages p on pp.cID = p.cID where cPath = ? and siteTreeID in (' . $treeIDs . ')', [$path]);</span>
</pre></div>
<p>$path通过460行返回，该查询语句实现从请求到返回cID。<br/>
然后看返回页面的过程，<br/>
从concrete/src/Http/DefaultDispatcher.php handleDispatch：131进入，这里列出一些关键地方，从concrete/src/View/View.php：288 renderTemplate函数开始，先是包含了 concrete/themes/elemental/default.php，进行一些页面头文件的渲染，之后9行进入正题：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419203425-0c71b5e6-bfdd-1.png"/><br/>
这里的$c根据前面的分析，已经带入了cID,跟进到11行：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419215520-59fc0234-bfe8-1.png"/><br/>
load：771中调用了getAreaBlocks：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419215704-97f14af4-bfe8-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419215812-c07ee6ac-bfe8-1.png"/><br/>
getBlocks：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220419215839-d0c3e346-bfe8-1.png"/><br/>
跟进getBlockIDs：</p>
<div class="highlight"><pre><span></span><span class="x">/**</span>
<span class="x">     * List the block IDs and the associated area handles in the currently loaded collection version (or in a specific area within it).</span>
<span class="x">     *</span>
<span class="x">     * @param string|false $arHandle The handle if the area (or falsy to get all the blocks in the collection version)</span>
<span class="x">     *</span>
<span class="x">     * @return array Return a list of arrays, each one is a dictionary like ['bID' =&gt; &lt;block ID&gt;, 'arHandle' =&gt; &lt;area handle&gt;]</span>
<span class="x">     */</span>
<span class="x">    public function getBlockIDs($arHandle = false)</span>
<span class="x">    {</span>
<span class="x">        $blockIDs = CacheLocal::getEntry(</span>
<span class="x">                              'collection_block_ids',</span>
<span class="x">                              $this-&gt;getCollectionID() . ':' . $this-&gt;getVersionID()</span>
<span class="x">        );</span>

<span class="x">        if (!is_array($blockIDs)) {</span>
<span class="x">            $v = [$this-&gt;getCollectionID(), $this-&gt;getVersionID()]; //cID</span>
<span class="x">            $db = Loader::db();</span>
<span class="x">            $q = 'select Blocks.bID, CollectionVersionBlocks.arHandle from CollectionVersionBlocks inner join Blocks on (CollectionVersionBlocks.bID = Blocks.bID) inner join BlockTypes on (Blocks.btID = BlockTypes.btID) where CollectionVersionBlocks.cID = ? and (CollectionVersionBlocks.cvID = ? or CollectionVersionBlocks.cbIncludeAll=1) order by CollectionVersionBlocks.cbDisplayOrder asc';</span>
<span class="x">            $r = $db-&gt;GetAll($q, $v);</span>
<span class="x">            $blockIDs = [];</span>
<span class="x">            if (is_array($r)) {</span>
<span class="x">                foreach ($r as $bl) {</span>
<span class="x">                    $blockIDs[strtolower($bl['arHandle'])][] = $bl;</span>
<span class="x">                }</span>
<span class="x">            }</span>
<span class="x">            CacheLocal::set('collection_block_ids', $this-&gt;getCollectionID() . ':' . $this-&gt;getVersionID(), $blockIDs);</span>
<span class="x">        }</span>

<span class="x">        $result = [];</span>
<span class="x">        if ($arHandle != false) {</span>
<span class="x">            $key = strtolower($arHandle);</span>
<span class="x">            if (isset($blockIDs[$key])) {</span>
<span class="x">                $result = $blockIDs[$key];</span>
<span class="x">            }</span>
<span class="x">        } else {</span>
<span class="x">            foreach ($blockIDs as $arHandle =&gt; $row) {</span>
<span class="x">                foreach ($row as $brow) {</span>
<span class="x">                    if (!in_array($brow, $blockIDs)) {</span>
<span class="x">                        $result[] = $brow;</span>
<span class="x">                    }</span>
<span class="x">                }</span>
<span class="x">            }</span>
<span class="x">        }</span>

<span class="x">        return $result;</span>
<span class="x">    }</span>
</pre></div>
<p>这里通过cID关联到了bID,接着，getBlocks函数的894：</p>
<div class="highlight"><pre><span></span><span class="x">foreach ($blockIDs as $row) {</span>
<span class="x">                $ab = Block::getByID($row['bID'], $this, $row['arHandle']);</span>
</pre></div>
<p>concrete/src/Block/Block.php：168，getByID函数的数据库查询：</p>
<div class="highlight"><pre><span></span><span class="x">$q = 'select CollectionVersionBlocks.isOriginal, CollectionVersionBlocks.cbIncludeAll, Blocks.btCachedBlockRecord, BlockTypes.pkgID, CollectionVersionBlocks.cbOverrideAreaPermissions, CollectionVersionBlocks.cbOverrideBlockTypeCacheSettings, CollectionVersionBlocks.cbRelationID,</span>
<span class="x"> CollectionVersionBlocks.cbOverrideBlockTypeContainerSettings, CollectionVersionBlocks.cbEnableBlockContainer, CollectionVersionBlocks.cbDisplayOrder, Blocks.bIsActive, Blocks.bID, Blocks.btID, bName, bDateAdded, bDateModified, bFilename, btHandle, Blocks.uID from CollectionVersionBlocks inner join Blocks on (CollectionVersionBlocks.bID = Blocks.bID) inner join BlockTypes on (Blocks.btID = BlockTypes.btID) where CollectionVersionBlocks.arHandle = ? and CollectionVersionBlocks.cID = ? and (CollectionVersionBlocks.cvID = ? or CollectionVersionBlocks.cbIncludeAll=1) and CollectionVersionBlocks.bID = ?';</span>
<span class="x">        }</span>
</pre></div>
<p>至此成功获取了写入到数据库的bFilename。<br/>
那么一开始说了，其实这个核心还是在于路径穿越导致的任意文件包含，写入到数据库的bFilename也只是个../../../开头的文件路径，那么必然还有一个类似.拼接的操作，带着疑问，又调试了一波。<br/>
前面得出是在concrete/src/Area/Area.php：824 加载到了bFilename，接着853$bv-&gt;render('view');<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220420171642-97ef501c-c08a-1.png"/><br/>
跟进161的setupRender:<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220420172042-26c437a8-c08b-1.png"/><br/>
153通过$this-&gt;block-&gt;getBlockFilename()返回了$bFilename，这里还是../../的形式，接着往下进入BlockViewTemplate的构造函数：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220420172333-8cf946a8-c08b-1.png"/><br/>
在computeView：105行断点的地方，最终发现了罪魁祸首。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220420172727-17fc6af0-c08c-1.png"/><br/>
后面就简单了，在renderViewContents中include：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220420183437-7a1a9d2a-c095-1.png"/><br/>
<strong>结语</strong><br/>
偶然遇到的rce对学习代码又有了一些新的认识。<br/>
<strong>参考</strong><br/>
<a href="https://hackerone.com/reports/1102067" target="_blank">https://hackerone.com/reports/1102067</a></p>
</div>
</div>