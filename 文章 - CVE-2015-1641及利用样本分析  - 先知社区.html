<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="9c3432862fdbf420dfec9f9dadcfd9a9">0x01 漏洞描述</h2>
<ul>
<li>
<p>漏洞成因：类型混淆漏洞。Word在处理<code>displacedByCustomXml</code>属性时未对<code>customXml</code>标签对象进行有效性验证，可以通过传入其他标签对象，由类型混淆进而达到任意内存写。故可以借由精心构造的标签对象及对应属性值实现RCE。</p>
</li>
<li>
<p>影响版本：Microsoft Word 2007 SP3, Office 2010 SP2, Word 2010 SP2, Word 2013 SP1, Word 2013 RT SP1, Word for Mac 2011, Office Compatibility Pack SP3, Word Automation Services on SharePoint Server 2010 SP2 &amp; 2013 SP1, Office Web Apps Server 2010 SP2 &amp; 2013 SP1</p>
</li>
</ul>
<h2 data-content="1" id="76ac9da78b2f33530dbdcb29b7a5c5d7">0x02 漏洞分析</h2>
<p>样本信息及分析环境如下：</p>
<blockquote>
<p>MD5:A69F778D1F511268019B1080F5E3B98B</p>
<p>OS版本：Windows 7 SP1(x86)</p>
<p>Word版本：2007</p>
<p>WWLIB.DLL版本：12.0.4518.1014</p>
</blockquote>
<h4 data-content="1" id="d32b0a51a901b03719aae1cfe61ca436">0x02.1 类型混淆—&gt;任意地址写</h4>
<p>通过rtfobj查看该文档的OLE对象：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105533-5adbb392-2d37-1.png"/></p>
<p>手动提取出来2号对象存为一RTF文档，Windbg附加Word 2007并打开该文档，崩溃点如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105534-5b7f8e40-2d37-1.png"/></p>
<p>之后将0号与2号对象提取出来存为一RTF文档：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105536-5c63cb28-2d37-1.png"/></p>
<p>设断<code>bp wwlib!DllGetClassObject+0x50e6 ".if(ecx=7c38bd50){}.else{gc}"</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105538-5da0b0f0-2d37-1.png"/></p>
<p>待执行<code>call wwlib!DllGetClassObject+0x50fe</code>前查看栈中参数如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105539-5e51daec-2d37-1.png"/></p>
<p>通过<code>rtfobj.py -s 2</code>将2号对象存为一Word文档，查看其<code>word</code>目录下<code>document.xml</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105541-5fd2c9b2-2d37-1.png"/></p>
<p>可以看到smartTag标签属性值与栈中参数对应关系。</p>
<p>根据微软文档，<code>displacedByCustomXml</code>属性指定替换标签应为customXml：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105543-6099ac44-2d37-1.png"/></p>
<p>继续跟进分析，计算写入地址：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105546-62475ec4-2d37-1.png"/></p>
<p>计算公式为[[Parameter 1]+0x8]*[Parameter 2]+[[Parameter 1]+0xC]+[Parameter 1]，具体参数值见图5。直接步过该函数，可以看到其结果与公式结果无异：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105547-632bf336-2d37-1.png"/></p>
<p>跟进，查看其<code>memcpy</code>传递参数：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105549-64330cd8-2d37-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105550-651d9096-2d37-1.png"/></p>
<p>向0x7c38bd74地址处写入0xffffe696，该值用于第二次计算Dst Address。</p>
<p>重新设断<code>bp wwlib!DllGetClassObject+0x50e6 ".if(ecx=7c38bd68){}.else{gc}"</code>，断下之后跟进到其计算Dst Address函数：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105551-65bc5db6-2d37-1.png"/></p>
<p>可以看到[[Parameter 1]+0xC]为之前写入值。第二次写入覆盖MSVCR71.DLL虚函数表中函数调用地址：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105553-67054fc0-2d37-1.png"/></p>
<p>第三次写入：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105555-67b25828-2d37-1.png"/></p>
<p>该值用于第四次计算Dst Address：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105556-6873b90a-2d37-1.png"/></p>
<p>第四次写入：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105557-694cfcb0-2d37-1.png"/></p>
<h4 data-content="1" id="cbf439a985b1eed63a363a5cf8dc6d2a">0x02.2 劫持执行流</h4>
<p>继续向下执行，崩溃点如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105558-69eace68-2d37-1.png"/></p>
<p>重新载入RTF文档，于0x7c376fc4处设断：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105559-6a897e00-2d37-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105601-6bb9b060-2d37-1.png"/></p>
<p>由上图可知第二次内存写入——覆盖MSVCR71.DLL虚函数表中函数调用地址，第四次内存写入——覆盖传递参数。</p>
<p>将1号对象加入后存为RTF文档，重新载入分析，<code>bp 0x7c376fc8</code>设断：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105602-6c54f2e6-2d37-1.png"/></p>
<p>可以看到堆喷布局如上，该布局由1号对象<code>\word\activeX</code>目录中<code>activeX1.bin</code>完成：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105605-6dd60600-2d37-1.png"/></p>
<p>根据其布局，不断执行<code>ret</code>，到<code>0x7c3651EB</code>处开始ROP链：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105607-6f089e34-2d37-1.png"/></p>
<p>执行VirtualProtect以绕过DEP保护：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105608-6fa0a7e2-2d37-1.png"/></p>
<p>然后开始执行<code>activeX1.bin</code>内Shellcode部分：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105610-70ad249e-2d37-1.png"/></p>
<h4 data-content="1" id="ae1af66852fd070e78dc7dff60829edc">0x02.3 Shellcode of activeX1.bin</h4>
<p>遍历当前进程中打开文件句柄，查找其Size符合如下条件的文件：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105611-71ab72c4-2d37-1.png"/></p>
<p>映射到内存中：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105614-7318150e-2d37-1.png"/></p>
<p>通过文件头与<code>FEFEFEFE FEFEFEFE FFFFFFFF</code>判断是否为样本文件及Shellcode起始位置：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105616-74abe0f8-2d37-1.png"/></p>
<p>复制Shellcode到VirtualAlloc开辟空间内，之后跳转到第二部分Shellcode执行。</p>
<h4 data-content="1" id="425dcee50daa705d1e8676a908b4fc79">0x02.4 Shellcode of  RTF</h4>
<p>解密后续Shellcode：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105618-75c89daa-2d37-1.png"/></p>
<p>由ANY.RUN可见其后续行为(有兴趣的读者请自行下载样本分析)：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105620-76d98a24-2d37-1.png"/></p>
<h4 data-content="1" id="4d0edc340c93d83d77e79c58f81c4b9a">附</h4>
<p>正常情况下，Word在解析customXml标签时会开辟一新空间：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105623-786088d4-2d37-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105624-7923bf20-2d37-1.png"/></p>
<p>而在解析smartTag时：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105625-79f35762-2d37-1.png"/></p>
<p>故借此可以控制目标写入地址。</p>
<h2 data-content="1" id="b1a8b30d02e55841070e11dafe6f65d1">0x03 Patchwork组织某利用样本分析</h2>
<h4 data-content="1" id="da716c3b2421519a2a5df426b8253430">0x03.1 RTF文档分析</h4>
<blockquote>
<p>MD5：2C22EA1CED258346351EAD09B1DC6074</p>
</blockquote>
<p>查看OLE对象：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105626-7a8bc100-2d37-1.png"/></p>
<p>0号对象用以加载OTKLOADR.DLL以引入MSVCR71.DLL绕过ASLR；</p>
<p>1号对象用以完成堆喷及Shellcode布局；</p>
<p>2号对象用以触发CVE-2015-1641漏洞，触发点位于<code>styles.xml</code>中：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105628-7b8da1e0-2d37-1.png"/></p>
<p>载入RTF文档，<code>bp 0x7c376fc8</code>设断，执行ROP链后调用VirtualProtect更改内存属性，跳转到Shellcode：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105629-7c571976-2d37-1.png"/></p>
<p>通过<code>jmp</code>+<code>call</code>+<code>pop</code>给传参，解密后续Shellcode：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105630-7cf13b96-2d37-1.png"/></p>
<p>解密逻辑如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105631-7d7be5ac-2d37-1.png"/></p>
<p>开辟内存空间，复制加密Shellcode并解密：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105633-7e49d4c6-2d37-1.png"/></p>
<p>通过<code>call</code>指令为函数传递参数：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105634-7f4c2e6e-2d37-1.png"/></p>
<p>后续仍有数次解密Shellcode过程，不再一 一列出。于<code>C:\Users\xxx\AppData\Roaming\Microsoft\Templates</code>目录下创建文件：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105636-803df2bc-2d37-1.png"/></p>
<p>写入文件内容：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105637-811d4d36-2d37-1.png"/></p>
<p>之后于相同目录下创建<code>~$Normal.dat</code>并写入内容：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105638-81c60ec6-2d37-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105640-82873a60-2d37-1.png"/></p>
<p>该文件具有隐藏属性：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105641-83540f90-2d37-1.png"/></p>
<p>于<code>HKEY_CURRENT_USER</code>下创建注册表项：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105642-843379e6-2d37-1.png"/></p>
<p>设置注册表键值：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105644-84eaa990-2d37-1.png"/></p>
<p>删除注册表禁用项：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105645-858696c0-2d37-1.png"/></p>
<p>后续将由<code>wscript.exe</code>执行<code>C:\Users\xxx\AppData\Roaming\Microsoft\Templates\Normal.domx</code>，该文件实际为VBE格式：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105646-8677022c-2d37-1.png"/></p>
<p>可借由<a href="https://gist.github.com/bcse/1834878" target="_blank">scrdec18</a>工具解密：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105648-876d0924-2d37-1.png"/></p>
<h4 data-content="1" id="78823dd138ee9ba6382637f6c18ba83b">0x03.2 Normal.domx分析</h4>
<p>该文件本质为VBE格式，可由<code>wscript.exe</code>正常加载。分析时需通过工具解密出VBS脚本。</p>
<p>读取<code>~$Normal.dat</code>第一部分内容并解密，写入<code>%USERPROFILE%\AppData\Local\Microsoft\Windows\Temporary Internet Files\Content.Word\PLAs_NEW_ORBAT.doc</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105649-883c0af8-2d37-1.png"/></p>
<p>该文档用于迷惑受害者：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105650-88d5143c-2d37-1.png"/></p>
<p>之后释放三个PE文件并设置隐藏属性：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105651-89920c72-2d37-1.png"/></p>
<p>执行<code>MicroScMgmt.exe</code>并删除自身以及<code>~$Normal.dat</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105652-8a1765fc-2d37-1.png"/></p>
<h4 data-content="1" id="2e06cd4c087a089a5cceb927290137c0">0x03.3 MicroScMgmt.exe分析</h4>
<p>查看导入表：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105653-8aab555a-2d37-1.png"/></p>
<p>该文件为带有数字签名的白文件：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105654-8b42f5f4-2d37-1.png"/></p>
<p>其用于加载恶意DLL——<code>jli.dll</code>。</p>
<h4 data-content="1" id="ad637cc70dd1efb013dcc9c0c6dd71a9">0x03.4 jli.dll分析</h4>
<blockquote>
<p>MD5：051573B9173DE6886E0575F81778EA03</p>
</blockquote>
<p>查看其导出函数：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105656-8c306096-2d37-1.png"/></p>
<p>该文件带有无效签名：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105657-8d0f2786-2d37-1.png"/></p>
<p>其与Patchwork组织之前使用过的BADNEWS木马存在相似性，此处暂不展开分析。完整攻击链如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20201123105659-8dd19ed8-2d37-1.png"/></p>
<h2 data-content="1" id="a9d293fa7c676fd2210e51e98b98855f">0x04 参阅链接</h2>
<ul>
<li>
<p><a href="https://paper.seebug.org/351/" target="_blank">CVE-2015-1641 Word 利用样本分析</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/previous-versions/office/developer/office-2010/cc847826(v=office.14" target="_blank">Microsoft Docs——displacedByCustomXml</a>?redirectedfrom=MSDN)</p>
</li>
<li>
<p><a href="https://www.anquanke.com/post/id/85031" target="_blank">手把手教你如何构造office漏洞EXP（第四期）</a></p>
</li>
</ul>
</div>
</div>