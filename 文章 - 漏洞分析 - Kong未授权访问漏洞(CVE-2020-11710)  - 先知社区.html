<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h3 data-content="1" id="044db581d7096673cf0c5f4fdca14dde">简介</h3>
<p>Kong是开源的、"云原生"(cloud-native)的API Gateway应用程序，使用Kong gateway的各种插件可实现对访问流量的精细控制、访问鉴权。</p>
<p>其官方称Kong是针对与云与混合架构的下一代API平台.<br/>
Next-Generation API Platform for Multi-Cloud and Hybrid Organizations.</p>
<ul>
<li>为什么要用API Gateway ?  举个例子:业务web提供了一个"微服务"API接口，可查看全国天气数据<ul>
<li>用API Gateway对该API接口设置 访问频率限制(如5分钟1次)，可避免被频繁访问</li>
<li>用API Gateway对该API接口设置 鉴权(Basic auth等)，可允许有预定义的凭据的client访问</li>
<li>用API Gateway对该API接口设置 Proxy Caching ，可避免重复请求带来的压力</li>
<li>用API Gateway对该API接口设置 负载均衡</li>
<li>用API Gateway对该API接口设置 数据转换</li>
<li>...</li>
</ul>
</li>
</ul>
<p>更多Fetures参考Kong官方资料:</p>
<p><a href="https://konghq.com/learning-center/api-gateway/?itm_source=website&amp;itm_medium=nav" target="_blank">What is an API Gateway? - KongHQ</a></p>
<p><a href="https://github.com/Kong/kong#features" target="_blank">Fetures</a></p>
<h3 data-content="1" id="33e9fcf1403c19bec051c9a666c9eeb1">基本信息</h3>
<ul>
<li>版本分类<ul>
<li>Kong Gateway Community - 社区版，使用默认配置存在未授权漏洞的是社区版 version &lt;=2.0.2</li>
<li>Kong Enterprise - 企业版，支持角色控制和鉴权，不存在该漏洞。目前2020.4.16的最新版本号是1.5.x</li>
</ul>
</li>
</ul>
<ul>
<li>默认端口，Kong的默认端口与用途如下。</li>
</ul>
<table>
<thead>
<tr>
<th style="">端口用途</th>
<th>HTTP port</th>
<th>HTTPS port</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="">Admin Restful API</td>
<td>8001</td>
<td>8444</td>
<td>Kong社区版 Admin Restful API端口 应<strong>仅能被管理员访问</strong>
</td>
</tr>
<tr>
<td style="">Proxy Port</td>
<td>8000</td>
<td>8443</td>
<td>提供给公网访问</td>
</tr>
</tbody>
</table>
<p>该漏洞根本原因：不恰当的配置导致"Admin Restful API的端口可被公网访问".</p>
<h3 data-content="1" id="5b463043812221cfc6dc1c9974e3b740">漏洞分析</h3>
<p>根据修复漏洞CVE-2020-11710的diff <a href="https://github.com/Kong/docker-kong/commit/18c4029ee3d4acfece679fa87b5dd081fb56fdd5" target="_blank">https://github.com/Kong/docker-kong/commit/18c4029ee3d4acfece679fa87b5dd081fb56fdd5</a></p>
<p>可知修复方法是把Admin Restful API端口(8001 和 8444) 的监听从0.0.0.0改成了127.0.0.1</p>
<p>复现漏洞：根据<strong>修复漏洞前</strong>的<a href="https://docs.konghq.com/install/docker/" target="_blank">官方安装步骤 - 使用docker安装Kong Gateway Community</a>进行安装：</p>
<p>可发现，以下命令中有不恰当的配置，导致了<strong>"Admin Restful API的端口可被公网访问"</strong>：<br/>
（1）倒数第3行的<code>8001:8001</code>表明，访问 0.0.0.0:8001 就等于访问容器"kong"的8001端口。<br/>
（2）倒数第2行的<code>8444:8444</code>存在同样的情况。</p>
<pre><code>$ docker run -d --name kong \
     --network=kong-net \
     -e "KONG_DATABASE=postgres" \
     -e "KONG_PG_HOST=kong-database" \
     -e "KONG_PG_PASSWORD=kong" \
     -e "KONG_CASSANDRA_CONTACT_POINTS=kong-database" \
     -e "KONG_PROXY_ACCESS_LOG=/dev/stdout" \
     -e "KONG_ADMIN_ACCESS_LOG=/dev/stdout" \
     -e "KONG_PROXY_ERROR_LOG=/dev/stderr" \
     -e "KONG_ADMIN_ERROR_LOG=/dev/stderr" \
     -e "KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl" \
     -p 8000:8000 \
     -p 8443:8443 \
     -p 8001:8001 \
     -p 8444:8444 \
     kong:latest</code></pre>
<p>所以根据<strong>修复漏洞前</strong>的安装步骤进行安装后，默认情况下，Kong的4个端口可被公开访问，其中包括了Admin Restful API所用的2个端口(HTTP port:8001 , HTTPS port:8444)，攻击者可利用Admin Restful API来管理Kong Gateway的全部功能。</p>
<h3 data-content="1" id="506031bd3f8a01512f8fcca0e1e7c943">漏洞检测</h3>
<p><a href="https://github.com/1135/Kong_exploit/" target="_blank">https://github.com/1135/Kong_exploit/</a></p>
<p>通过Kong的未授权漏洞实现了<strong>可回显的SSRF</strong>，几乎等于突破了网络边界，危害巨大！</p>
<p>如，对某内网系统进行访问:<br/>
(页面内的css资源使用了相对路径,没获取到,如果需要获取再创建一个"服务"即可)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200417225501-6a0874f0-80bb-1.png"/></p>
<h3 data-content="1" id="4911c1612f89dae405baeb371d8ff06c">漏洞危害</h3>
<ul>
<li>攻击者利用"Kong未授权访问漏洞"可以执行的操作包括但不限于：<ul>
<li>信息泄露 - 查看当前配置信息("服务"地址等)</li>
<li>Basic SSRF - 可回显Response的SSRF: 通过添加Route到内网其他重要"(web)服务"实现</li>
<li>MITM - 如获取所有普通用户发向某个"(web)服务"的HTTP/HTTPS请求、响应</li>
</ul>
</li>
</ul>
<p>因为Kong常搭建在云环境中，云环境中的SSRF漏洞的危害更大，参考<a href="https://xz.aliyun.com/t/7198#toc-1" target="_blank">云安全 - 研究云环境下对SSRF的检测与防御（以AWS为例 </a>，简单说就是<code>利用SSRF漏洞-&gt;访问云提供商自带的管理API-&gt;获取云服务器访问权限</code>。</p>
<h3 data-content="1" id="f100857385c781f0283fdfce1afec553">MITM全过程原理</h3>
<h4 data-content="1" id="bb9c451cb1b01974adb6af73e4a94a16">正常逻辑</h4>
<p>一个普通用户的正常访问过程<br/>
请求过程 <code>client --request--&gt; Kong api_1 --request--&gt; service 1</code><br/>
响应过程 <code>client &lt;--response-- Kong api_1 &lt;--response-- service 1</code></p>
<h4 data-content="1" id="4ad3d1d56209eb2207939d914984075c">实现MITM全过程</h4>
<p>只看"请求"劫持的全过程("响应“劫持也是类似的)</p>
<ul>
<li>第1步<ul>
<li>"复制" 原本就存在的Kong api_1 得到Kong api_2  它们都指向 service 1</li>
<li>此时，如果普通用户发出HTTP请求到api_2，与访问api_1得到的Response Body完全相同</li>
</ul>
</li>
<li>第2步 创建并配置MITM站点<ul>
<li>(1) 创建中间人站点 <code>mitm.evil.com</code>
</li>
<li>(2) 配置MITM站点，实现请求处理(保存/修改/丢弃...) ; 最后将处理后的请求 转发到 Kong api_2</li>
</ul>
</li>
<li>第3步 修改Kong api_1指向的服务<ul>
<li>Kong api_1原本指向 <code>service 1</code>
</li>
<li>Kong api_1(hijacking) 现在指向 <code>mitm.evil.com</code>
</li>
<li>这一步是MITM全过程中最后进行的一步,放到最后做可以避免正常用户访问失败</li>
</ul>
</li>
</ul>
<h4 data-content="1" id="4f7bbc07d74e294b1dbb01b68730fc5f">MITM的效果</h4>
<p>一个普通用户的访问过程(Kong api_1已被劫持)<br/>
请求过程 <code>client --request--&gt; Kong api_1(hijacking) --request--&gt;  mitm.evil.com(forwarding) --request--&gt; api_2 --request--&gt;  service 1</code><br/>
响应过程 <code>client &lt;--response-- Kong api_1(hijacking) &lt;--response--  mitm.evil.com(forwarding)  &lt;--response--  api_2 &lt;--response-- service 1</code></p>
<ul>
<li>一个普通用户的访问(被劫持全过程):<ul>
<li>(1)一个普通用户的请求发向 Kong api_1(hijacking) ，Kong把请求发到其指向的"web服务":MITM站点</li>
<li>(2)MTIM站点实现Request处理(保存/修改/丢弃...)并将Request转发到 Kong api_2</li>
<li>(3) Kong api_2 将请求发到其指向的"web服务":service 1 得到Response,返回给:MTIM站点</li>
<li>(4)  MTIM站点实现Response处理(保存/修改/丢弃...)并将Response转发到 Kong api_1(hijacking)</li>
<li>(5) 这个普通用户得到了Response</li>
</ul>
</li>
</ul>
<h4 data-content="1" id="8dd34585a9db7f5def1c8cad624fd2b0">检测MTIM</h4>
<ul>
<li>如何检测这种MTIM？本次MITM攻击会产生这些异常:<ul>
<li>Kong api_2指向的那个正常服务service 1，正常情况下会收到来自不同源IP的请求，如上MITM攻击后，只能收到来自<code>mitm.evil.com</code>的请求。</li>
<li>kong的服务器会主动连接互联网的<code>mitm.evil.com</code>(流量大小 取决于被劫持接口的正常流量大小)</li>
</ul>
</li>
</ul>
<h3 data-content="1" id="3ce0a753140894899d9d31b720ff651d">修复方法</h3>
<p>1.仅本机可访问Admin Restful API. 修改 docker-compose.yaml: 将<code>8001:8001</code> 改为<code>127.0.0.1:8001:8001</code>,将<code>8444:8444</code> 改为<code>127.0.0.1:8444:8444</code><br/>
2.设置严格的ACL,仅允许必要的访问</p>
<h3 data-content="1" id="fcfb1246483f4e21d2d0f8ee37f65155">总结</h3>
<p>Kong未授权漏洞根本原因：不恰当的配置导致"Admin Restful API的端口可被公网访问"。<br/>
所以不管使用哪个版本，只要进行了不恰当的配置，导致Admin Restful API可被攻击者访问，都会存在风险。</p>
<p>Kong的用途决定了它可以管理一些南北向流量，内网可访问的范围大。<br/>
而且Kong是"云原生"(cloud-native)应用，常部署在云环境上，如果Kong不恰当配置导致存在未授权漏洞，危害更大。</p>
<p>漏洞原理简单，但应重视不恰当配置导致的漏洞。</p>
</div>
</div>