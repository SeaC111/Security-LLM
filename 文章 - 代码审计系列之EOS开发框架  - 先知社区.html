<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="d7b98cf4e3af7d7a319d26b7adf01fca">代码审计系列之EOS开发框架</h1>
<h2 data-content="1" id="a8d3fad30a564d550b99d3439f4b5af5">EOS框架简介</h2>
<p>Primeton EOS（Entriprise Operation System），以下简称EOS，是基于J2EE平台、采用面向构件技术实现企业级应用开发、运行、管理、监控、维护的中间件平台。EOS6是普元公司推出的基于SOA架构，支持SCA1.0、SDO2.1规范的新一代EOS产品。基于EOS6开发的应用具备符合国际标准，易于扩展，易于集成的特性。</p>
<p>参考链接：<a href="http://www.primeton.com/products/ep/overview.php" target="_blank">http://www.primeton.com/products/ep/overview.php</a></p>
<h2 data-content="1" id="71e4989eb52dd6395a2d597bf48945e9">前言</h2>
<p>今天要说的是一个通用型的开发框架，涉及领域比较宽泛，不讲解漏洞，只讲解整个框架的调用流程</p>
<h2 data-content="1" id="945769b13a511d56258f39ddf3e317da">默认配置&amp;&amp;安全</h2>
<p>根据官网给出来的默认配置如下web.xml</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/j2ee"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">id=</span><span class="s">"defaultWebApp"</span>
         <span class="na">version=</span><span class="s">"2.4"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>rest.config.locations<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>
            classpath*:META-INF/services/restconfig.properties
        <span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>resteasy.injector.factory<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>com.primeton.components.rest.extend.JSONInjectorFactoryImpl<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>InterceptorFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>com.eos.access.http.InterceptorFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>com.primeton.sca.host.webapp.SCAWebServiceServletListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>com.primeton.ext.runtime.core.RuntimeJ2EEHost<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>com.primeton.engine.core.impl.process.SessionListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>com.eos.access.http.UserObjectSessionListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>InterceptorFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
        <span class="nt">&lt;dispatcher&gt;</span>FORWARD<span class="nt">&lt;/dispatcher&gt;</span>
        <span class="nt">&lt;dispatcher&gt;</span>REQUEST<span class="nt">&lt;/dispatcher&gt;</span>
        <span class="nt">&lt;dispatcher&gt;</span>INCLUDE<span class="nt">&lt;/dispatcher&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>
            com.eos.access.http.ControllerServlet
        <span class="nt">&lt;/servlet-class&gt;</span>
        <span class="nt">&lt;load-on-startup&gt;</span>10<span class="nt">&lt;/load-on-startup&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/WSActivityInstManagerService<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    ......
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/WSWorklistQueryManagerService<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.flow<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.flowx<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.gzip<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.ajax<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.beanx<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.debug<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/common.remote<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.precompile<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.ext<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>ControllerServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>*.terminate<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>resteasyservlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>
            com.primeton.components.rest.extend.CustomHttpServletDispatcher
        <span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>resteasyservlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/rest/services/*<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
    <span class="nt">&lt;session-config&gt;</span>
        <span class="nt">&lt;session-timeout&gt;</span>30<span class="nt">&lt;/session-timeout&gt;</span>
    <span class="nt">&lt;/session-config&gt;</span>
    <span class="nt">&lt;welcome-file-list&gt;</span>
        <span class="nt">&lt;welcome-file&gt;</span>index.jsp<span class="nt">&lt;/welcome-file&gt;</span>
        <span class="nt">&lt;welcome-file&gt;</span>coframe/index.jsp<span class="nt">&lt;/welcome-file&gt;</span>
    <span class="nt">&lt;/welcome-file-list&gt;</span>
    <span class="nt">&lt;mime-mapping&gt;</span>
        <span class="nt">&lt;extension&gt;</span>xml<span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;mime-type&gt;</span>application/xml<span class="nt">&lt;/mime-type&gt;</span>
    <span class="nt">&lt;/mime-mapping&gt;</span>
    <span class="nt">&lt;mime-mapping&gt;</span>
        <span class="nt">&lt;extension&gt;</span>war<span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;mime-type&gt;</span>application/zip<span class="nt">&lt;/mime-type&gt;</span>
    <span class="nt">&lt;/mime-mapping&gt;</span>
    <span class="nt">&lt;mime-mapping&gt;</span>
        <span class="nt">&lt;extension&gt;</span>ear<span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;mime-type&gt;</span>application/zip<span class="nt">&lt;/mime-type&gt;</span>
    <span class="nt">&lt;/mime-mapping&gt;</span>
    <span class="nt">&lt;mime-mapping&gt;</span>
        <span class="nt">&lt;extension&gt;</span>zip<span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;mime-type&gt;</span>application/zip<span class="nt">&lt;/mime-type&gt;</span>
    <span class="nt">&lt;/mime-mapping&gt;</span>
    <span class="nt">&lt;error-page&gt;</span>
        <span class="nt">&lt;error-code&gt;</span>404<span class="nt">&lt;/error-code&gt;</span>
        <span class="nt">&lt;location&gt;</span>/common/notFound.jsp<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/error-page&gt;</span>
    <span class="c">&lt;!--</span>
<span class="c">    &lt;jsp-config&gt;</span>
<span class="c">    &lt;jsp-property-group&gt;</span>
<span class="c">    &lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;</span>
<span class="c">    &lt;page-encoding&gt;UTF-8&lt;/page-encoding&gt;</span>
<span class="c">    &lt;/jsp-property-group&gt;</span>
<span class="c">    &lt;/jsp-config&gt;</span>
<span class="c">    --&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
<p>上面的配置效果，再加上程序开发者的拿来主义习惯，可能会造成以下2个问题</p>
<ol>
<li>webservice接口泄露</li>
<li>rest接口泄露</li>
</ol>
<p>rest接口是通过一个配置文件映射（restconfig.properties）：</p>
<div class="highlight"><pre><span></span><span class="n">resteasy</span><span class="o">.</span><span class="na">resources</span><span class="o">=</span><span class="n">com</span><span class="o">.</span><span class="na">primeton</span><span class="o">.</span><span class="na">bps</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">control</span><span class="o">.</span><span class="na">restful</span><span class="o">.</span><span class="na">WebControlRestService</span>

<span class="nd">@Path</span><span class="o">(</span><span class="s">"/rest/services/bps/webcontrol"</span><span class="o">)</span>
<span class="nd">@Consumes</span><span class="o">({</span><span class="s">"application/json"</span><span class="o">,</span> <span class="s">"application/x-www-form-urlencoded"</span><span class="o">})</span>
<span class="nd">@Produces</span><span class="o">({</span><span class="s">"application/json"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebControlRestService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">WebControlRestService</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@POST</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"/queryParticipants"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">queryParticipants</span><span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapObject</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">WFServiceException</span><span class="o">,</span> <span class="n">JSONException</span> <span class="o">{</span>

        <span class="n">HashMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">nodeBody</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getJsonFromMap</span><span class="o">(</span><span class="n">mapObject</span><span class="o">));</span>
        <span class="n">DataObject</span> <span class="n">node</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataObject</span><span class="o">)</span> <span class="n">changeToDataObject</span><span class="o">(</span><span class="s">"node"</span><span class="o">,</span> <span class="n">nodeBody</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
        <span class="n">DataObject</span> <span class="n">otherParamObj</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataObject</span><span class="o">)</span> <span class="n">changeToDataObject</span><span class="o">(</span><span class="s">"otherParamObj"</span><span class="o">,</span> <span class="n">nodeBody</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"childNodes"</span><span class="o">,</span> <span class="n">ServiceUtil</span><span class="o">.</span><span class="na">queryParticipants</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">otherParamObj</span><span class="o">))</span>
        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@POST</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"/searchParticipants"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">searchParticipants</span><span class="o">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">mapObject</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">WFServiceException</span> <span class="o">{</span>

        <span class="n">HashMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">mapObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
        <span class="n">Map</span> <span class="n">extData</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">mapObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"extData"</span><span class="o">);</span>
        <span class="n">PageCond</span> <span class="n">page</span> <span class="o">=</span> <span class="o">(</span><span class="n">PageCond</span><span class="o">)</span> <span class="n">mapObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"page"</span><span class="o">);</span>
        <span class="n">resultMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"childNodes"</span><span class="o">,</span> <span class="n">ServiceUtil</span><span class="o">.</span><span class="na">searchParticipants</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">extData</span><span class="o">,</span> <span class="n">page</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">resultMap</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">..................</span>
<span class="o">..................</span>
</pre></div>
<p>调用方式参数通过json传递</p>
<pre><code>POST /rest/services/bps/webcontrol/queryProcessAndActivity HTTP/1.1
Host: localhost: 8080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:56.0) Gecko/ 20100101 Firefox/56.
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.
Accept-Language: en-US,en;q=0.
Content-Type: application/json
Content-Length: 16
Cookie: 
Connection: close
Upgrade-Insecure-Requests: 1

{"workItemID":1}</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165151-fd2a3c98-b6a7-1.jpg"/></p>
<p>webservice接口就相对简单了这里总共有十处</p>
<pre><code>&lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSActivityInstManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSAgentManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSAppointActivityManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSBackActivityManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSDefinitionQueryManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSDelegateManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSFreeFlowManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSProcessInstManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSRelativeDataManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSWorkItemDrawbackManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSWorkItemManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
     &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ControllerServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/WSWorklistQueryManagerService&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;</code></pre>
<p>调用方式可以通过wsdl进行解析</p>
<p>访问<a href="http://localhost:8080/WSActivityInstManagerService?wsdl" target="_blank">http://localhost:8080/WSActivityInstManagerService?wsdl</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165204-04ecb366-b6a8-1.jpg"/></p>
<p>注意：EOS框架整体上来讲都是需要授权登陆的，只有这两个接口调用方式不需要授权，webservice通过ControllerServlet进行映射，这里一章节放到框架讲解里面</p>
<h2 data-content="1" id="e7d05fd67ee317bf1f11055a9fb0e740">EOS框架讲解</h2>
<p>整个框架通过拦截器com.eos.access.http.InterceptorFilter和com.eos.access.http.ControllerServlet来实现的</p>
<h4 data-content="1" id="597c27af97bb528724526c929223296f">拦截器的调用流程</h4>
<p>初始化子拦截器</p>
<pre><code>public void init(FilterConfig arg0) throws ServletException {
        this.init();
    }

    public void init() {
        logger.info("init InterceptorFilter.");
        Map processors = RequstProcessors.INSTANCE.getAllProcessors();
        Iterator e = processors.entrySet().iterator();
        while (e.hasNext()) {
            Entry interceptors = (Entry) e.next();
            WebInterceptorConfig i$ = new WebInterceptorConfig();
            i$.setFilterId("ProcessorInterceptor_" + (String) interceptors.getKey());
            i$.setSortIdx(2147483647);
            i$.setPattern((String) interceptors.getKey());
            i$.setClassName(ProcessorWebInterceptor.class.getName());
            WebInterceptorManager.INSTANCE.addInterceptorConfig(i$);
            ProcessorWebInterceptor interceptor = (ProcessorWebInterceptor) WebInterceptorManager.INSTANCE.getInterceptor("ProcessorInterceptor_" + (String) interceptors.getKey())
            if (interceptor != null) {
                interceptor.setProcessor((IProcessor) interceptors.getValue());
            }
        }
        try {
            Field e1 = ClassUtil.getField(WebInterceptorManager.class, "interceptors");
            e1.setAccessible(true);
            List interceptors1 = (List) e1.get(WebInterceptorManager.INSTANCE);
            Iterator i$1 = interceptors1.iterator();
            while (i$1.hasNext()) {
                IWebInterceptor interceptor1 = (IWebInterceptor) i$1.next();
                if (interceptor1 instanceof ILifeCycleWebInterceptor) {
                    try {
                        ((ILifeCycleWebInterceptor) interceptor1).init();
                    } catch (Throwable var7) {
                        logger.error(var7);
                    }
                }
            }
        } catch (Throwable var8) {
            logger.error(var8);
        }
    }</code></pre>
<p>里面两次初始化了调用链对象</p>
<p>第一层：</p>
<pre><code>Map processors = RequstProcessors.INSTANCE.getAllProcessors();</code></pre>
<p>跟进代码分析：</p>
<pre><code>public static final RequstProcessors INSTANCE = new RequstProcessors();

    private RequstProcessors() {
        File configDir = new File(ApplicationContext.getInstance().getApplicationConfigPath());
        HandlerRegistry processorRegistry = HandlerRegistry.load(RequstProcessors.class.getClassLoader, configDir, "handler-processor.xml", IProcessor.class, "handler", "id", "class", "sortIdx", 0.false);
        Iterator i$ = processorRegistry.getEffectiveHandlerModels().iterator();
        while (i$.hasNext()) {
            HandlerModel model = (HandlerModel) i$.next();
            Element handlerElement = model.getHandlerElement();
            String suffix = handlerElement.getAttribute("suffix");
            String processorClassName = handlerElement.getAttribute("class");
            StringTokenizer stk = new StringTokenizer(suffix, ",");
            try {
                while (stk.hasMoreElements()) {
                    String e = stk.nextToken();
                    IProcessor processor = (IProcessor) Class.forName(processorClassName).newInstance();
                    processor.setRequestSuffix(e);
                    logger.info("the url suffix with [" + e + "] will be processed by [" + processorClassName + "].");
                    this.requestProcessors.put(e, processor);
                }
            } catch (Throwable var11) {
                logger.error("create processor instance fail!", var11);
            }
        }
    }</code></pre>
<p>这里进行了配置文件的解析，并且初始化了配置信息，映射信息来自handler-processor.xml</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;handlers&gt;
    &lt;handler id="flowProcessor" suffix=".flow" sortIdx="0"
             class="com.primeton.ext.engine.core.processor.HttpPageFlowProcessor"/&gt;
    &lt;handler id="actionProcessor" suffix=".action" sortIdx="0"
             class="com.primeton.ext.engine.core.processor.ActionProcessor"/&gt;
    &lt;handler id="downloadProcessor" suffix=".download" sortIdx="0"
             class="com.primeton.access.http.impl.processor.DownloadProcessor"/&gt;
    &lt;handler id="downloadConfigProcessor" suffix=".configdownload" sortIdx="0"
             class="com.primeton.access.http.impl.processor.DownloadConfigProcessor"/&gt;
    &lt;handler id="ConfigurationDownloadProcessor" suffix=".governordownload" sortIdx="0"
             class="com.primeton.access.http.impl.processor.GovernorDownloadConfigProcessor"/&gt;
    &lt;handler id="GovernorDownloadConfigurationProcessor" suffix=".governordownload" sortIdx="0"
             class="com.primeton.access.http.impl.processor.GovernorDownloadConfigProcessor"/&gt;   
    &lt;!--    &lt;handler id="ajaxFlowProcessor" suffix=".flow.ajax,.flowx.ajax"      sortIdx="0"        
                  class="com.primeton.ext.engine.core.processor.AjaxPageflowProcessor" /&gt;     --&gt;
    &lt;handler id="commonServiceProcessor" suffix=".remote" sortIdx="0"
             class="com.primeton.access.client.impl.processor.CommonServiceProcessor"/&gt;
    &lt;handler id="ajaxBizProcessor" suffix=".biz.ajax" sortIdx="0"
             class="com.primeton.ext.engine.core.processor.AjaxBizProcessor"/&gt;
    ...............
    ...............</code></pre>
<p>第二层：</p>
<pre><code>ProcessorWebInterceptor interceptor = (ProcessorWebInterceptor)WebInterceptorManager.INSTANCE.getInterceptor("ProcessorInterceptor_" + (String)interceptors.getKey());</code></pre>
<p>跟进代码进行分析：</p>
<pre><code>public static final WebInterceptorManager INSTANCE = new WebInterceptorManager();
    private List&lt;WebInterceptorConfig&gt; configs = new ArrayList();
    private List&lt;IWebInterceptor&gt; interceptors = new ArrayList();
    private ReentrantReadWriteLock lock = new ReentrantReadWriteLock(true);

    private WebInterceptorManager() {
        this.readConfigFile();
    }

    private void readConfigFile() {
        File configDir = new File(ApplicationContext.getInstance().getApplicationConfigPath());
        HandlerRegistry inteceptorRegistry = HandlerRegistry.load(WebInterceptorManager.class.getClassLoader(), configDir, "handler-web.xml", IWebInterceptor.class, "handler", "id", "class", "sortIdx", 100, false);
        Iterator i$ = inteceptorRegistry.getEffectiveHandlerModels().iterator();
        while (i$.hasNext()) {
            HandlerModel model = (HandlerModel) i$.next();
            try {
                Element e = model.getHandlerElement();
                String className = e.getAttribute("class");
                String pattern = e.getAttribute("pattern");
                WebInterceptorConfig config = new WebInterceptorConfig();
                config.setFilterId(model.getId());
                config.setClassName(className);
                if (pattern != null &amp;&amp; !pattern.equals("")) {
                    config.setPattern(pattern);
                }
                int idx = model.getIndex();
                if (idx &lt; 0) {
                    logger.error("the WebInterceptor\'s sortIdx not allow lower than 0!");
                } else {
                    config.setSortIdx(idx);
                    this.addInterceptorConfig(config);
                }
            } catch (Exception var10) {
                logger.error("the WebInterceptor config has error!", var10);
            }
        }
    }

    public void addInterceptorConfig(WebInterceptorConfig config) {
        this.lock.writeLock().lock();
        try {
            IWebInterceptor interceptor = this.createInterceptor(config.getClassName());
            int idx;
            int willAddPos;
            int i;
            if (config.isDefaultSortIdx()) {
                idx = 0;
                boolean e = false;
                willAddPos = 0;
                for (i = this.configs.size(); willAddPos &lt; i; ++willAddPos) {
                    WebInterceptorConfig length = (WebInterceptorConfig) this.configs.get(willAddPos);
                    if (length.getSortIdx() &gt; idx &amp;&amp; !length.isDefaultSortIdx()) {
                        this.configs.add(idx, config);
                        this.interceptors.add(idx, interceptor);</code></pre>
<p>在这个类中我们初始化了handler-web.xml里面对应的拦截器，存放在参数this.interceptors里面</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;handlers&gt;
    &lt;handler id="WSInterceptor" sortIdx="0" pattern="/*"
             class="com.primeton.sca.host.webapp.SCAWebServiceServletFilter"/&gt;
    &lt;handler id="WebI18NInterceptor" sortIdx="1" pattern="/*" class="com.primeton.access.http.impl.WebI18NInterceptor"/&gt;
    &lt;handler id="HttpSecurityWebInterceptor" sortIdx="2" pattern="*.flow,*.jsp"
             class="com.eos.access.http.security.HttpSecurityWebInterceptor"/&gt;
    &lt;handler id="HttpRefererWebInterceptor" sortIdx="3" pattern="/*"
             class="com.eos.access.http.security.HttpRefererWebInterceptor"/&gt;
    &lt;handler id="UserLoginInterceptor" sortIdx="100" pattern="/*" class="com.eos.access.http.UserLoginCheckedFilter"/&gt;
    &lt;handler id="AccessedResourceInterceptor" sortIdx="101" pattern="/*"
             class="com.primeton.access.authorization.impl.AccessedHttpResourceFilter"/&gt;
&lt;/handlers&gt;</code></pre>
<p>跟进调用doFilter</p>
<pre><code>public void doFilter(ServletRequest arg0, ServletResponse arg1, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) arg0;
        HttpServletResponse response = (HttpServletResponse) arg1;
        request.setCharacterEncoding(MultipartResolver.getEncoding());
        if (UserLoginCheckedFilter.isPortal() &amp;&amp; request.getSession().getAttribute("userObject") == null) {
            IUserObject session = CustomObjectProviderProvider.getProvider().getVirtualUserObject(VirtualUserObjectTypes.PORTAL_USER);
            ((UserObject) session).setUserRemoteIP(HttpHelper.getRemoteAddr(request));
            ((UserObject) session).setSessionId(request.getSession().getId());
            ((UserObject) session).setUniqueId(request.getSession().getId());
            OnlineUserManager.login(session);
            request.getSession().setAttribute("userObject", session);
        } ............... ............... ...............try {
            Throwable e;
            try {
                if (var15 != null) {
                    muo = MUODataContextHelper.create(var15);
                    DataContextManager.current().setMUODataContext(muo);
                }
                WebInterceptorChainImpl var16 = (WebInterceptorChainImpl) WebInterceptorManager.INSTANCE.createChain(request, response);
                var16.setFilterChain(filterChain);
                var16.doIntercept(request, response);</code></pre>
<p>这里追踪一下doIntercept方法</p>
<pre><code>public class WebInterceptorChainImpl implements IWebInterceptorChain {
        private List&lt;IWebInterceptor&gt; interceptors = new ArrayList();
        private static final int DEFAULT_IDX = -1;
        private int pos = 0;
        private FilterChain filterChain;

        public WebInterceptorChainImpl() {
        }

        public void doIntercept(HttpServletRequest servletrequest, HttpServletResponse servletresponse) throws IOException, ServletException {
            if (this.pos == this.interceptors.size()) {
                if (this.filterChain != null) {
                    this.filterChain.doFilter(servletrequest, servletresponse);
                }
            } else {
                IWebInterceptor interceptor = (IWebInterceptor) this.interceptors.get(this.pos);
                ++this.pos;
                interceptor.doIntercept(servletrequest, servletresponse, this);
            }
        }</code></pre>
<p>从最后一句可以看出来，不管任何一个请求，都要遍历两个映射文件对应的拦截器的doIntercept</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165226-11c0bf10-b6a8-1.jpg"/></p>
<p>上面是一个整体的调用逻辑，说明一下这几个filter的作用</p>
<ol>
<li>WSInterceptor webservice的请求路由</li>
<li>WebI18NInterceptor</li>
<li>HttpSecurityWebInterceptor 整体的框架路由</li>
<li>HttpRefererWebInterceptor referer检查</li>
<li>UserLoginInterceptor 登陆检查</li>
<li>AccessedResourceInterceptor 资源的访问权限检查</li>
</ol>
<p>webservice直接forward到了axis2请求上的</p>
<pre><code>public void doIntercept(HttpServletRequest request, HttpServletResponse response, IWebInterceptorChain chain) throws IOException, ServletException {        ..........        ..........
        ..........
        ..........
        RequestDispatcher dispatcher = WebAppServletHost.getInstance().getRequestDispatcher(path);
        if (dispatcher != null) {
            String url = request.getRequestURL().toString();
            String serviceName;
            try {
                URI contextPath = new URI(url);
                serviceName = contextPath.getHost();
                String e = this.getIpAddress();
                url = url.replaceAll(serviceName, e);
            } catch (URISyntaxException var14) {
                ;
            }
            String contextPath1 = request.getContextPath();
            if (StringUtils.isEmpty(contextPath1)) {
                serviceName = this.getServiceName(url);
            } else {
                serviceName = this.getServiceName(contextPath1, url);
            }
            try {
                IDataObjectType e1 = DataObjectTypeFactory.createDataObjectType();
                String servicePath = AegisFileCache.getFilePath(serviceName);
                Class clazz = WebServiceMapping.getServiceClass(serviceName);
                DefinitionFactory.createDefinition(serviceName, servicePath, clazz, url, e1);
            } catch (Exception var13) {
                var13.printStackTrace();
            }
            dispatcher.forward(request, response);</code></pre>
<p>整体的框架调用基本上分析完了，接下来就是业务层的东西，重点看handler-processor.xml</p>
<pre><code>&lt;handler id="flowProcessor" suffix=".flow" sortIdx="0"        class="com.primeton.ext.engine.core.processor.HttpPageFlowProcessor" /&gt;


public class HttpPageFlowProcessor extends AbstractPageFlowProcessor {
        public HttpPageFlowProcessor() {
        }

        public IParameterSet createParameterSet(HttpServletRequest request, HttpServletResponse response) {
            return ParameterBuilder.createHttpParamSet(request);
        }
    }</code></pre>
<p>分析父类解析参数规则：</p>
<pre><code>public abstract class AbstractPageFlowProcessor extends AbstractProcessor {
        private static final Logger logger = TraceLoggerFactory.getLogger(AbstractPageFlowProcessor.class);
        public static final String CACHE_EOS_PAGEFLOW = "_eosFlowCache";
        public static final String EOS_PAGEFLOW_KEY = "_eosFlowKey";
        public static final String EOS_PAGEFLOW_ACTION = "_eosFlowAction";
        public static final String EOS_PAGEFLOW_AJAX = "_eosAjax";
        public static final String EOS_CURRENT_PAGEFLOW_INSTANCE = "_eosCurrentInstanceID";
        public static final String EOS_PARENT_PAGEFLOW_INSTANCE = "_eosParentInstanceID";
        public static final String EOS_PAGEFLOW_DATACONTEXT = "_eosFlowDataContext";
        public static final String EOS_REQUEST_DATACONTEXT = "_eosRequestDataContext";
        private static final List&lt;String&gt; innerVariables = new ArrayList();

        public AbstractPageFlowProcessor() {
        }

        public void process(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
            try {
                HttpServletRequest e = MultipartResolverFactory.getMultipartResolver().resolveMultipart(request);
                HttpMapContextFactory config1 = new HttpMapContextFactory(e, response);
                DataContextManager.current().setMapContextFactory(config1);
                this.doProcess(e, response, (IParameterSet) null);</code></pre>
<p>继续跟进这里面的doProcess</p>
<pre><code>public abstract class AbstractPageFlowProcessor extends AbstractProcessor {
        .....
        public void process(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
            try {
                .....
                this.doProcess(e, response, (IParameterSet) null);
            } catch (Throwable var7) {
            .....
            }
        }

        public void doProcess(HttpServletRequest request, HttpServletResponse response, IParameterSet parameterSetA) throws IOException, ServletException {
            .....
            try {
                .....
                Object var35 = request.getAttribute("_eosRequestDataContext");
                if (var35 != null &amp;&amp; var35 instanceof PageflowRuntimeContext) {
                    .....
                    .....
                    if (!this.hasUserDataConvert(pageFlowInstance, var32.getStateName(), current_error_uri, this.getRequestedFlowID(request))) {
                        IParameterSet var42 = this.createParameterSet(request, response);
                        IVariable[] var44 = this.moveInnerParams((IVariable[]) var38);
                        var42.build(var44, context);</code></pre>
<p>build函数里面对参数_eosRequestDataContext进行了解析：</p>
<pre><code>public void build(IVariable[] vars, IDataContext context) {
        Map serverTypeMapping = this.getTypeMapping(vars);
        IVariable _eosFlowKey;
        Class _eosFlowDataContext;
        for (int customerTypeMapping = 0; customerTypeMapping &lt; this.customVars.size(); ++customerTypeMapping) {
            IVariable typeMapping = (IVariable) this.customVars.get(customerTypeMapping);
            String varsMap = typeMapping.getName();
            _eosFlowKey = this.getDefinedVariable(varsMap, vars);
            if (_eosFlowKey != null) {
                _eosFlowDataContext = _eosFlowKey.getTypeClass();
                if (varsMap.equals(_eosFlowKey.getName()) &amp;&amp; (_eosFlowKey.isDataObject() || isConcreteClass(_eosFlowDataContext))) {
                    this.customVars.remove(customerTypeMapping);
                    --customerTypeMapping;
                }
            } else {
                this.customVars.remove(customerTypeMapping);
                --customerTypeMapping;
            }
        }
        Map var26 = this.getTypeMapping((IVariable[]) this.customVars.toArray(new IVariable[this.customVars.size()]));
        HashMap var25 = new HashMap(serverTypeMapping);
        var25.putAll(var26);
        context.setTypeMappings(var25);
        HashMap var27 = new HashMap();
        if (vars != null) {
            IVariable[] var28 = vars;
            int var30 = vars.length;
            for (int _eosFlowAction = 0; _eosFlowAction &lt; var30; ++_eosFlowAction) {
                IVariable xpathSorter = var28[_eosFlowAction];
                String fixedMap = xpathSorter.getName();
                var27.put(fixedMap, xpathSorter);
            }
        }
        Iterator var29 = this.customVars.iterator();
        String var34;
        while (var29.hasNext()) {
            IVariable var32 = (IVariable) var29.next();
            var34 = var32.getName();
            var27.put(var34, var32);
        }
        _eosFlowKey = null;
        String var31;
        try {
            var31 = (String) this.values.get("_eosFlowKey");
        } catch (Exception var22) {
            throw new RuntimeException("process _eosFlowKey has exception!", var22);
        }
        _eosFlowDataContext = null;
        String var33;
        try {
            var33 = (String) this.values.get("_eosFlowDataContext");
        } catch (Exception var21) {
            throw new RuntimeException("process _eosFlowDataContext has exception!", var21);
        }
        var34 = null;
        try {
            var34 = (String) this.values.get("_eosFlowAction");
        } catch (Exception var20) {
            throw new RuntimeException("process _eosFlowAction has exception!", var20);
        }
        if (var34 != null &amp;&amp; !var34.equals("")) {
            context.set("_eosFlowAction", var34);
        }
        if (var31 != null &amp;&amp; !var31.equals("")) {
            context.set("_eosFlowKey", var31);
        }
        Iterator i$;
        Map var37;
        if (var33 != null &amp;&amp; !var33.equals("")) {
            try {
                Object var35 = ContextSerializer.deserialize(var33);</code></pre>
<p>最终代码逻辑流入了反序列化里面：</p>
<pre><code>public static Object deserialize(String codedString) throws IOException, ClassNotFoundException {
        BASE64Decoder decoder = new BASE64Decoder();
        byte[] buf = decoder.decodeBuffer(codedString);
        ByteArrayInputStream bais = new ByteArrayInputStream(buf);
        ObjectInputStream oos = new ObjectInputStream(bais);
        Object o = oos.readObject();
        oos.close();
        return o;
    }</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165251-2084e04e-b6a8-1.jpg"/></p>
<p>继续跟进分析第二点：</p>
<pre><code>&lt;handler id="ajaxBizProcessor" suffix=".biz.ajax"        sortIdx="0"        class="com.primeton.ext.engine.core.processor.AjaxBizProcessor" /&gt;</code></pre>
<p>映射类里面代码逻辑如下：</p>
<pre><code>public class AjaxBizProcessor extends AbstractBizProcessor {
        public AjaxBizProcessor() {
        }

        public IParameterSet createParameterSet(HttpServletRequest request, HttpServletResponse response) {
            response.setCharacterEncoding("UTF-8");
            return ParameterBuilder.createAjaxParamSet(request);
        }
    }

    public static IParameterSet createAjaxParamSet(HttpServletRequest request) {
        AjaxParameterSet parameterSet = new AjaxParameterSet();
        parameterSet.setRequest(request);
        buildParameterSet(parameterSet);
        return parameterSet;
    }

    private static void buildParameterSet(AbstractParameterSet parameterSet) {
        parameterSet.init();
    }

    public void init() {
        new StringBuffer();
        StringBuffer buffer;
        String e;
        try {
            e = this.request.getParameter("__ajaxParam");
            if (e == null) {
                e = "&lt;root&gt;&lt;params&gt;&lt;/params&gt;&lt;data&gt;&lt;/data&gt;&lt;/root&gt;";
            }
            buffer = new StringBuffer(URLDecoder.decode(e, "UTF-8"));
        } catch (UnsupportedEncodingException var10) {
            logger.error(var10);
            throw new RuntimeException(var10);
        }
        try {
            if (buffer.toString().trim().equals("")) {
                buffer.append("&lt;root&gt;&lt;params&gt;&lt;/params&gt;&lt;data&gt;&lt;/data&gt;&lt;/root&gt;");
            }
            e = null;
            String xml = buffer.toString();
            Document var11;
            if (!getXMLHeader(xml).contains("encoding")) {
                String paramNode = MultipartResolver.getEncoding();
                var11 = XmlUtil.parseStringThrowsException(xml, paramNode);
            } else {
                var11 = XmlUtil.parseString(xml);
            }</code></pre>
<p>这里进行了xml的解析，没有进行实体的转换</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165311-2cdfe1ae-b6a8-1.jpg"/></p>
<p>根据后台日志信息可以看出来跟我们分析的一样，报错文件找不到，说明xxe执行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240119165328-3710b716-b6a8-1.jpg"/></p>
<h4 data-content="1" id="ee2ca181c0378b86e2ddfebbec3c4124">总结</h4>
<ol>
<li>发布网站要避免默认配置保留发布      </li>
<li>对于rest定义的接口尽量采用复杂命名，防止由于默认配置导致的接口泄露      </li>
<li>禁用xml解析库的实体，如果从第三方库没有禁用标志，可以尝试在filter里面添加       </li>
<li>对于反序列化漏洞，升级jdk，或者相关反序列化调用的类库</li>
</ol>
<p>原文链接：<a href="https://mp.weixin.qq.com/s/4Ejshk7x71L9INB0grj5mw" target="_blank">https://mp.weixin.qq.com/s/4Ejshk7x71L9INB0grj5mw</a></p>
</div>
</div>