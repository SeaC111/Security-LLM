<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>这个漏洞可能导致认证后 RCE。</p>
<blockquote>
<p>[!error] Hyper-V 的影响</p>
<p>在一些开启了 Hyper-V 的电脑上，RouterOS 可能无法在 VMWare Workstation 中模拟运行或启动非常缓慢，如果遇到无法运行的情况，请酌情考虑关闭 Hyper-V，如果能成功运行但是启动缓慢，可以及时拍摄快照。</p>
</blockquote>
<h2 data-content="1" id="106d43b09bebd65305933a0ef4e661eb">漏洞描述</h2>
<blockquote>
<p>Mikrotik RouterOs before stable v7.6 was discovered to contain an out-of-bounds read in the snmp process. This vulnerability allows attackers to execute arbitrary code via a crafted packet.</p>
</blockquote>
<p>目标二进制为 <code>/nova/bin/snmp</code>。</p>
<h2 data-content="1" id="ed51b9aae710a596a11cd1fb350a14af">前置知识</h2>
<p>RouterOS 有一些交互方式，这里我们可能会用到 JS 交互和 Winbox 交互。</p>
<p>JS 交互本质上就是通过 http 协议走 80 端口，RouterOS 中的 www 进程负责解析用户请求并发给指定的进程 。</p>
<p>Winbox 交互是通过 8291 端口进行的，RouterOS 中的 mproxy 进程负责接收请求并解析，发送给指定的进程。</p>
<p>这些协议的加密细节在此不做讨论，感兴趣的读者可以自行研究。</p>
<h3 data-content="1" id="1baa86dd0a5e1167bd2a5d9a6569d45c">Nova Message</h3>
<p>Nova Message 是 RouterOS 中的自定义消息格式，它被用来进程之间的通信。Nova Message 的格式是 Type Key-Value Pairs，这里举个栗子：</p>
<pre><code>{bff0005:1, uff0006:0x1, uff0007:0xfe000d, s1:'admin', Uff0001:[13,7]}</code></pre>
<h4 data-content="1" id="0f5fa32e265c0765a4eb03fb9986f3f9">Type</h4>
<p>在上面的例子中，每一个 Key 的首字母是类型（Type），剩下的部分才是真正的 Key。Nova Message 中有若干种类型（Type）：</p>
<pre><code>b: bool
u: 32bit integer
q: 64bit integer
s: string
r: raw
a: IPv6
m: message
B: bool array
U: 32bit integer array
Q: 64bit integer array
S: string array
R: raw array
A: IPv6 array
M: message array</code></pre>
<h4 data-content="1" id="ebfa01bbc565e53be81ed2f49cee1bd1">Key</h4>
<p>根据上面的例子，Key 中的低 24 位才是真正的 Key。而这低 24 位也有自己的说法：</p>
<pre><code>key = 0xGGVVVV, G=group, V=value</code></pre>
<p>其中 <code>GG</code> 代表的是命令的组，在 RouterOS 中，<code>GG</code> 可能的值包括：</p>
<pre><code>0xFF - SYS
0xFE - STD
0xFD - LOCAL
0x01 - NET
0x02 - MODULER
0x03 - SERMGR
0x04 - NOTIFY
0x05 - RADV
0x06 - SYSTEM
0x07 - PING
0x08 - UNDO
0x09 - LOG
0x0A - MEPTY
0x0B - PPPMAN
0x0C - RADIUS
0x0D - HOTPLUG
0x0E - BRIDGE
0x0F - DISKD
0x10 - DUDE
0x11 - CONSOLE
0x12 - CERM
0x2C - ROUTE</code></pre>
<p>以 Group 为 0xFF(SYS) 为例，不同的值也有不同的含义：</p>
<pre><code>SYS_TO: 0xFF0001
SYS_FROM: 0xFF0002
SYS_TYPE: 0xFF0003
SYS_STATUS: 0xFF0004
SYS_REPLYEXP: 0xFF0005
SYS_REQID: 0xFF0006
SYS_CMD: 0xFF0007
SYS_ERRNO: 0xFF0008
SYS_ERRSTR: 0xFF0009
SYS_USER: 0xFF000A
SYS_POLICY: 0xFF000B;用于表示当前用户的权限
SYS_CTRL: 0xFF000D
SYS_CTRL_ARG: 0xFF000F
SYS_USER_ID: 0xFF0010
SYS_NOTIFYCMD: 0xFF0011
SYS_ORIGINATOR: 0xFF0012
SYS_RADDR6: 0xFF0013
SYS_DREASON: 0xFF0016</code></pre>
<p>对于 <code>SYS_CMD</code>，我们可以设置不同的值完成不同的功能：</p>
<pre><code>0xfe0000 - NOP
0xfe0001 - getPolicies
0xfe0002 - getObj
0xfe0003 - setObj
0xfe0004 - getAll
0xfe0005 - addObj
0xfe0006 - removeObj
0xfe0007 - moveObj
0xfe0008 - setForm
0xfe000b - notify
0xfe000c - shutdown
0xfe000d - get
0xfe000e - set
0xfe000f - start
0xfe0010 - poll
0xfe0011 - cancel
0xfe0012 - subscribe
0xfe0013 - unsubscribe
0xfe0014 - disconnected
0xfe0015 - getCount</code></pre>
<h3 data-content="1" id="5eab840e547e39c7c968c47c298c6900">进程关系</h3>
<p>在 RouterOS 中，init 只负责启动 loader，由 loader 启动和管理其他进程。</p>
<pre><code>init-+-busybox-+-ash---pstree
     |         `-ash
     |-loader-+-agent
     |        |-arpd
     |        |-bluetooth
     |        |-bridge2
     |        |-btest
     |        |-cerm-worker
     |        |-console
     |        |-discover
...  ...  ...
     |        |-snmp
...  ...  ...</code></pre>
<h4 data-content="1" id="3caa0375c0e58016566a29a0416b803e">RouterOS Namespaces</h4>
<p>那么 loader 具体是怎样管理进程呢？RouterOS 将子进程的信息写在了 <code>/nova/etc/loader/system.x3</code> 中，它可以通过 <a href="https://github.com/tenable/routeros/tree/master/msg_re/parse_x3" target="_blank">Loader X3 Parser</a> 这个工具解析。一些子进程的信息如下所示：</p>
<pre><code>./x3_parse -f ../example/system_6_43_45.x3 
/nova/bin/log -&gt; 3
/nova/bin/radius -&gt; 5
/nova/bin/moduler -&gt; 6
/nova/bin/user -&gt; 13
...
/nova/bin/snmp -&gt; 34
...</code></pre>
<h2 data-content="1" id="e297873d07a0eade013062fc4e52e347">环境搭建</h2>
<p>我使用的环境为 MikroTik RouterOS 7.1.1。</p>
<h3 data-content="1" id="7af70f7277b0bfaa80719e68886ceecf">常用指令</h3>
<p>我们先配置一下环境，下面列出了一些参考指令：</p>
<div class="highlight"><pre><span></span><span class="c1"># 查看网卡</span>
interface print
<span class="c1"># 配置动态 IP</span>
ip dhcp-client add <span class="nv">interface</span><span class="o">=</span>ether1 <span class="nv">disable</span><span class="o">=</span>no
<span class="c1"># 查看网络信息</span>
ip dhcp-client print detail
<span class="c1"># 查看授权</span>
system licens print
<span class="c1"># 关机</span>
system shutdown
<span class="c1"># 重启</span>
system reboot
<span class="c1"># 重置系统</span>
system reset
</pre></div>
<h3 data-content="1" id="078eed6fbc5523078840dec5f9da3c8e">开启 SNMP</h3>
<p>RouterOS 中的 SNMP 不是默认开启的，我们需要手动开启，下面提供了一些参考指令，也可以参考<a href="https://wiki.mikrotik.com/wiki/Manual:SNMP" target="_blank">官方文档</a>：</p>
<div class="highlight"><pre><span></span><span class="c1"># 开启 SNMP</span>
snmp <span class="nb">set</span> <span class="nv">enabled</span><span class="o">=</span>yes
<span class="c1"># 查看当前配置的 SNMP 团体信息</span>
snmp community/print
<span class="c1"># 更改团体名字</span>
snmp community <span class="nb">set</span> <span class="nv">name</span><span class="o">=</span>&lt;name&gt; &lt;id&gt;
<span class="c1"># 添加新的团体</span>
snmp community add <span class="nv">name</span><span class="o">=</span>VegetaRocks
<span class="c1"># 设置联系方式</span>
snmp <span class="nb">set</span> <span class="nv">contact</span><span class="o">=</span><span class="s2">"Contact info"</span>
<span class="c1"># 设置地址</span>
snmp <span class="nb">set</span> <span class="nv">location</span><span class="o">=</span><span class="s2">"Location"</span>
<span class="c1"># 查看 SNMP 配置信息</span>
snmp print
</pre></div>
<h3 data-content="1" id="95d0d2cfb543495f97f2d43139ce05cd">获取 root shell</h3>
<p>这里列举了一些获取 root shell 的方法。</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Virtual Machine</th>
<th>Real Device</th>
</tr>
</thead>
<tbody>
<tr>
<td>cleaner_wrasse <sup class="footnote-ref" id="fnref-1"><a href="#fn-1" target="_blank">1</a></sup>
</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>netboot jailbreak <sup class="footnote-ref" id="fnref-2"><a href="#fn-2" target="_blank">2</a></sup>
</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>FOISted <sup class="footnote-ref" id="fnref-3"><a href="#fn-3" target="_blank">3</a></sup>
</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>container_mount <sup class="footnote-ref" id="fnref-4"><a href="#fn-4" target="_blank">4</a></sup>
</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>execute_milo <sup class="footnote-ref" id="fnref-5"><a href="#fn-5" target="_blank">5</a></sup>
</td>
<td>√</td>
<td>×</td>
</tr>
<tr>
<td>memory patch [^2] <sup class="footnote-ref" id="fnref-6"><a href="#fn-6" target="_blank">6</a></sup>
</td>
<td>√</td>
<td>×</td>
</tr>
</tbody>
</table>
<p>本文使用了 execute_milo 获取 root，它来自 <a href="https://github.com/tenable/routeros" target="_blank">tenable/routeros</a>。</p>
<p>我们首先下载并安装必要的包：</p>
<div class="highlight"><pre><span></span>git clone https://github.com/tenable/routeros.git
sudo apt install libboost-all-dev cmake libboost-dev
</pre></div>
<p>我们通过里面的 <a href="https://github.com/tenable/routeros/tree/master/poc/execute_milo" target="_blank">Execute Milo</a> 工具获取 root shell，它利用了 <code>/flash/bin</code> 下的 milo 文件可被覆盖且启动时不会做完整性校验的 feature。</p>
<p>接下来我们用 FTP 将一些必要文件传到 RouterOS 上。FTP 传输文件支持<a href="https://en.wikipedia.org/wiki/File_Transfer_Protocol#Data_types" target="_blank">四种文件类型</a>传输，这里我只使用了 binary mode。我写了一个小工具帮助上传/下载文件：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ftplib</span> <span class="kn">import</span> <span class="n">FTP</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">get_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">ftpFileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">localFileName</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">localFileName</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
        <span class="n">localFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ftpFileName</span><span class="p">)</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">retrbinary</span><span class="p">(</span><span class="s2">"RETR {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ftpFileName</span><span class="p">),</span>
                   <span class="nb">open</span><span class="p">(</span><span class="n">localFileName</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">put_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">localFileName</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ftpFileName</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ftpFileName</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
        <span class="n">ftpFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">localFileName</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"putting {} to {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">localFileName</span><span class="p">,</span> <span class="n">ftpFileName</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">localFileName</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">ftp</span><span class="o">.</span><span class="n">storbinary</span><span class="p">(</span><span class="s2">"STOR {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ftpFileName</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>


<span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>


<span class="sd">"""</span>
<span class="sd">python mftp.py [--ip remote_ip] [-o operation] [-f file [file ...]] [-r renamed_file [renamed_file ...]]</span>
<span class="sd">"""</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">'Simple FTP script for RouterOS.'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--ip"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"ip"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Remote IP"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-u"</span><span class="p">,</span> <span class="s2">"--user"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"user"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Username"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-p"</span><span class="p">,</span> <span class="s2">"--password"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"password"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Password"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-o"</span><span class="p">,</span> <span class="s2">"--op"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store"</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"op"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Operation"</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-f"</span><span class="p">,</span> <span class="s2">"--file"</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"file"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"To transferred filename."</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-r"</span><span class="p">,</span> <span class="s2">"--rename"</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">"rename"</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Renamed filename."</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ip</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">op</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span>
    <span class="n">rename_list</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rename</span>
    <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"get"</span><span class="p">,</span> <span class="s2">"put"</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">())</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">rename_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rename_list</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Transfer file number not equal to renamed file number"</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span> <span class="k">else</span> <span class="s2">"admin"</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">ftp</span> <span class="o">=</span> <span class="n">FTP</span><span class="p">()</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="n">ftp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">"put"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rename_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)):</span>
                <span class="n">put_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">file_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rename_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">put_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">"get"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rename_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)):</span>
                <span class="n">get_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">file_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rename_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">get_bin</span><span class="p">(</span><span class="n">ftp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">ftp</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>上传 <code>vm_bins</code> 目录下的文件：</p>
<div class="highlight"><pre><span></span>python mftp.py -u &lt;uname&gt; -p &lt;pwd&gt; --ip &lt;ip&gt; -o put -f vm_bins/busybox vm_bins/milo vm_bins/gdb
</pre></div>
<p>好，在上传文件之后，关闭虚拟机，然后随便用一个 Linux 的 Live CD 附加到虚拟机上，启动到虚拟机中。（PS：由于这一步需要修改磁盘文件，在实体机上无法做到修改，我想这就是为什么这种方法只能用于虚拟机的原因吧。）</p>
<blockquote>
<p>[!warning] 内存分配</p>
<p>可能由于虚拟机内存不足不能启动 LiveCD，如果遇到无法启动的情况，请考虑增大分配给虚拟机的内存。</p>
</blockquote>
<p>我们要做的事情很简单：FTP 上传后的文件没有可执行权限，因此我们在 LiveCD 中给它们加上可执行权限，再将 <code>/flash/bin</code> 中的 milo 覆盖即可：</p>
<div class="highlight"><pre><span></span>sudo su
<span class="nb">cd</span> rw/disk/
chmod +x busybox
chmod +x gdb
chmod <span class="m">755</span> milo
mv milo ../../bin/milo
ln -s /rw/disk/busybox ash
<span class="nb">exit</span>
</pre></div>
<p>接下来我们编译 <a href="https://github.com/tenable/routeros/tree/master/poc/execute_milo" target="_blank">Execute Milo</a> 中的文件（参考 <a href="https://github.com/tenable/routeros/tree/master/poc/execute_milo#step-6---build-and-execute-execute_milo" target="_blank">Readme 中的第六步</a>）我们最终会获得一个 <code>execute_milo</code> 文件，同时重启到 RouterOS 中。</p>
<p>接下来执行我们获取到的二进制。</p>
<pre><code>./execute_milo -i &lt;ip&gt; -p &lt;port&gt; -u &lt;username&gt; --password &lt;password&gt;</code></pre>
<blockquote>
<p>[!bug] WinboxSession</p>
<p>在较新版本的 RouterOS 上（版本可能 &gt;= 6.44.6），由于 Winbox 协议的变化，milo 不应该使用 WinboxSession 登录而应该使用 JSProxySession。同时，使用的端口也应当修改为 80 端口。</p>
</blockquote>
<p>最后 telnet 到 1270 端口即可获得 shell：</p>
<div class="highlight"><pre><span></span>telnet &lt;target ip&gt; <span class="m">1270</span>
</pre></div>
<h2 data-content="1" id="28ede842a905e64cb01e9407e0a9d18d">漏洞触发</h2>
<h3 data-content="1" id="82f9c181b2a0c3c058b8cd218324affb">上传 gdb/gdbserver</h3>
<p><a href="https://github.com/hugsy/gdb-static" target="_blank">hugsy/gdb-static</a>  中有一些编译好的静态 gdb 和 gdbserver，各取所需即可。</p>
<div class="highlight"><pre><span></span>wget https://github.com/hugsy/gdb-static/raw/master/gdbserver-7.10.1-x64
python mftp.py -u &lt;uname&gt; -p &lt;pwd&gt; --ip &lt;ip&gt; -o put -f gdbserver-7.10.1-x64 -r gdbserver
</pre></div>
<h3 data-content="1" id="fb1a86445a377e9caae2a6147fe9dde9">获取目标程序</h3>
<p>目标程序为 <code>/nova/bin/snmp</code>，我们将它复制到 <code>/rw/disk</code> 目录下面然后用上面的小脚本获取即可。</p>
<div class="highlight"><pre><span></span><span class="c1"># in RouterOS root shell</span>
cp /nova/bin/snmp /rw/disk

<span class="c1"># in host shell</span>
python mftp.py -u &lt;uname&gt; -p &lt;pwd&gt; --ip &lt;ip&gt; -o get -f snmp
</pre></div>
<h3 data-content="1" id="186aea74f3704af3ed1a8e2eb5b59ab9">调试目标</h3>
<pre><code>./gdbserver :12345 --attach $(pidof snmp)</code></pre>
<h3 data-content="1" id="fd2801be31f9626c3dd5b684213c676c">触发漏洞</h3>
<p>这里不提供完整 PoC，只给出触发漏洞的关键部分（这一部分也可以在 <a href="https://github.com/cq674350529/pocs_slides/blob/master/slides/POC2022-MikroTik_RouterOS_Security-The_Forgotten_IPC_Message.pdf" target="_blank">pocs_slides/slides/POC2022-MikroTik_RouterOS_Security-The_Forgotten_IPC_Message.pdf</a> 中找到）：</p>
<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">513</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="mi">512</span><span class="p">);</span>
    <span class="n">WinboxMessage</span> <span class="n">msg</span><span class="p">;</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">set_to</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">set_command</span><span class="p">(</span><span class="mh">0xfe0005</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">add_u32</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfffffffe</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">add_string</span><span class="p">(</span><span class="mh">0x5</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">.</span><span class="n">set_request_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
<p>这个 payload 的 JSON 构造为：</p>
<pre><code>{u14:0xfffffffe,uff0006:1,uff0007:0xfe0005,s5:'a'*512,Uff0001:[34,1]}</code></pre>
<p>根据前置知识，我们可以了解到：</p>
<ol>
<li>它要访问的是 <code>/bin/snmp</code> 的第一个 handler；</li>
<li>它希望添加对象；</li>
<li>它定义了一个 u32 数字 0xfffffffe；</li>
<li>它定义了一个字符串 payload；</li>
<li>它设置了 <code>SYS_REQID</code> 为 1。</li>
</ol>
<p>可以触发崩溃：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230807222355-0a642ee2-352e-1.png"/></p>
<p>RouterOS 内部也提供了一个日志工具，可以查看崩溃信息，位于 <code>/flash/rw/logs/</code>。</p>
<h2 data-content="1" id="479a5b3b11250c4ea39cd08149a8cc3c">漏洞分析</h2>
<h3 data-content="1" id="cca94920ba560b60f9fe1a9b26165ee5">第一层栈帧</h3>
<p>先跟踪到 0x77f1fbb3，根据 vmmap，可以发现它位于 <code>/lib/libuc++.so</code> 中：</p>
<pre><code>0x77f18000 0x77f29000 r-xp    11000 0      /lib/libuc++.so
0x77f29000 0x77f2a000 r-xp     1000 10000  /lib/libuc++.so
0x77f2a000 0x77f2b000 rwxp     1000 11000  /lib/libuc++.so</code></pre>
<p>之后求得这个位置的偏移为 0x7bb3，我们进入到函数 <code>sub_7BA4@&lt;eax&gt;</code> 中：</p>
<pre><code>.text:00007BA4                               ; int __usercall sub_7BA4@&lt;eax&gt;(int@&lt;eax&gt;, int@&lt;edx&gt;, int@&lt;ecx&gt;)
.text:00007BA4                               sub_7BA4 proc near                      ; CODE XREF: 
... ...
.text:00007BA4                               var_4= dword ptr -4
.text:00007BA4
.text:00007BA4 55                            push    ebp
.text:00007BA5 89 E5                         mov     ebp, esp
.text:00007BA7 53                            push    ebx
.text:00007BA8 83 EC 08                      sub     esp, 8
.text:00007BAB 51                            push    ecx
.text:00007BAC 52                            push    edx
.text:00007BAD FF 70 18                      push    dword ptr [eax+18h]
.text:00007BB0 FF 50 10                      call    dword ptr [eax+10h]
.text:00007BB0
.text:00007BB3 8B 5D FC                      mov     ebx, [ebp+var_4]
.text:00007BB6 C9                            leave
.text:00007BB7 C3                            retn
.text:00007BB7
.text:00007BB7                               sub_7BA4 endp</code></pre>
<p>可以看到是在执行到 0x00007BB0 这个位置时触发了崩溃，调用的地址值为 <code>[eax+10h]</code>。我们往前跟一下 eax。</p>
<h3 data-content="1" id="b7e7ab54664b90ba0f9e85e4ad37ece7">第二层栈帧</h3>
<p>再往前就是 0x77f227b9，求得它的偏移为：0xa7b9，位于函数 <code>tree_base::insert_unique</code> 中：</p>
<div class="highlight"><pre><span></span><span class="n">_DWORD</span> <span class="o">*</span><span class="n">__userpurge</span> <span class="n">tree_base</span><span class="o">::</span><span class="n">insert_unique</span><span class="err">@</span><span class="o">&lt;</span><span class="n">eax</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="n">_DWORD</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="n">_DWORD</span> <span class="o">*</span><span class="n">a3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a4</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span> <span class="o">*</span><span class="n">a5</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
<span class="p">...</span> <span class="p">...</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">sub_7BA4</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">a2</span><span class="p">,</span> <span class="n">a2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">a2</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a4</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
<span class="p">...</span> <span class="p">...</span>
    <span class="p">}</span>
</pre></div>
<p>可以看到 <code>a2</code> 是被调用的地址，它是 <code>insert_unique</code> 的第二个参数</p>
<h3 data-content="1" id="292fa3433585fa3c271c4227a3279f4a">第三层栈帧</h3>
<p>再往前追，我们可以追到 <code>Item::regenerateKeys</code> 函数：</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="n">Item</span><span class="o">::</span><span class="n">regenerateKeys</span><span class="p">(</span><span class="n">Item</span> <span class="o">*</span><span class="k">this</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span> <span class="p">...</span>

  <span class="n">v1</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">*</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">v12</span> <span class="o">=</span> <span class="p">(</span><span class="n">Item</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="k">this</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
  <span class="n">v11</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_80859C0</span> <span class="o">+</span> <span class="n">v1</span><span class="p">;</span>
<span class="p">...</span> <span class="p">...</span>
    <span class="n">tree_base</span><span class="o">::</span><span class="n">insert_unique</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v13</span><span class="p">,</span> <span class="n">v11</span><span class="p">,</span> <span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v18</span><span class="p">,</span> <span class="n">map_node_move_constr</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">);</span>
<span class="p">...</span> <span class="p">...</span>
</pre></div>
<p>在这里，<code>insert_unique</code> 函数的第二个参数是 <code>v11</code>，再往前追可以追到上面的三条赋值语句，我们调试看一下这里面的赋值情况：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230807222417-1746fffe-352e-1.png"/></p>
<p>可以看到，在执行到</p>
<pre><code>v1 = 28 * *((_DWORD *)this + 6);</code></pre>
<p>时，我们发现 <code>*((_DWORD *)this + 6)</code> 正是我们输入的 <code>u14:0xfffffffe</code>，这里有我们可以控制的输入！</p>
<h3 data-content="1" id="e7daf2720ff604ea3dd157ccc82f77a3">第四层栈帧</h3>
<p>此时我们再往前追一下，可以跟到函数 <code>Item::setConfig</code> 中：</p>
<pre><code>int __cdecl Item::setConfig(Item *this, const nv::message *message)
{
  ... ...
  *((_DWORD *)this + 6) = nv::message::get&lt;nv::u32_id&gt;(message, 20);
  ... ...</code></pre>
<p>这条语句会设置 <code>*((_DWORD *)this + 6)</code> 的值：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230807222432-2058481e-352e-1.png"/></p>
<h3 data-content="1" id="4cb8e362a0a6071ab682ec6ce13b272e">分析总结</h3>
<p>由此，这个漏洞的触发链已经非常清晰：</p>
<p><code>/nova/bin/snmp</code> 侧：</p>
<ul>
<li>在 <code>Item::setConfig</code> 函数中通过 <code>*((_DWORD *)this + 6)</code> 通过输入控制该位置的值；</li>
<li>在 <code>Item::regenerateKeys</code> 函数中通过偏移控制函数地址。</li>
</ul>
<p><code>/lib/libuc++.so</code> 侧：</p>
<ul>
<li>进入函数 <code>tree_base::insert_unique</code> 中，满足条件后调用 <code>sub_7BA4@&lt;eax&gt;</code> 触发漏洞。</li>
</ul>
<h2 data-content="1" id="606af508243d50832c708db141881bf3">漏洞利用</h2>
<p>在上面的漏洞分析中，我们可以通过输入间接地控制执行流，理论上我们可以做到任意地址执行，这是多么令人惊喜啊！</p>
<p>但很可惜的是，我们也就只能控制执行流了，其他的参数都不可控，因此也许只有比较极限的 ROP 才能完成攻击。一种可能的利用思路是找到一个合适的 ROPChain，它可以布置寄存器指向堆上我们的输入地址，做栈迁移后实现完整的攻击。由于 RouterOS 是通过 RPC 通信的，进程中有很多函数操作 Nova Message，因此我觉得大概率是有满足条件的 ROP chain 的。</p>
<p>限于时间关系本文就不在利用上展开深入研究了，感兴趣的读者可以根据上文的思路自行寻找实现完整的利用。</p>
<h2 data-content="1" id="ed990cf68bf59e25059978c1fb5f15ae">总结</h2>
<p>虽然这是 RouterOS 上 SNMP 进程的漏洞，但它并不是一个 SNMP 协议漏洞或者 SNMP 协议实现导致的漏洞，而是 RouterOS 自定义的协议不正确导致的漏洞。借助此文我简单介绍了 RouterOS 协议的相关知识，以及 CVE-2022-45315 的漏洞成因，希望可以帮到大家。</p>
<h2 data-content="1" id="537d1fea73e341b910f2b1657ee0eff6">参考资料</h2>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-45315" target="_blank">CVE-2022-45315 Detail (nvd.nist.gov)</a></li>
<li><a href="https://github.com/cq674350529/pocs_slides" target="_blank">cq674350529/pocs_slides (github.com)</a></li>
<li><a href="https://github.com/tenable/routeros" target="_blank">tenable/routeros (github.com)</a></li>
<li><a href="https://margin.re/2022/06/pulling-mikrotik-into-the-limelight/" target="_blank">Pulling MikroTik into the Limelight (margin.re)</a></li>
<li><a href="https://github.com/MarginResearch/resources" target="_blank">MarginResearch/resources (github.com)</a></li>
</ul>
<div class="footnotes">
<hr/>
<ol>
<li id="fn-1"><p><a href="https://github.com/tenable/routeros/tree/master/cleaner_wrasse" target="_blank">https://github.com/tenable/routeros/tree/master/cleaner_wrasse</a><a href="#fnref-1" target="_blank">↩</a></p></li>
<li id="fn-2"><p><a href="http://ufo.stealien.com/2022-06-01/how-to-root-your-routeros-v7-virtual-machine" target="_blank">http://ufo.stealien.com/2022-06-01/how-to-root-your-routeros-v7-virtual-machine</a><a href="#fnref-2" target="_blank">↩</a></p></li>
<li id="fn-3"><p><a href="https://margin.re/blog/pulling-mikrotik-into-the-limelight.aspx" target="_blank">https://margin.re/blog/pulling-mikrotik-into-the-limelight.aspx</a><a href="#fnref-3" target="_blank">↩</a></p></li>
<li id="fn-4"><p><a href="https://nns.ee/blog/2022/08/05/routeros-container-rce.html" target="_blank">https://nns.ee/blog/2022/08/05/routeros-container-rce.html</a><a href="#fnref-4" target="_blank">↩</a></p></li>
<li id="fn-5"><p><a href="https://github.com/tenable/routeros/tree/master/poc/execute_milo" target="_blank">https://github.com/tenable/routeros/tree/master/poc/execute_milo</a><a href="#fnref-5" target="_blank">↩</a></p></li>
<li id="fn-6"><p><a href="https://github.com/pedrib/PoC/blob/master/tools/mikrotik_jailbreak.py" target="_blank">https://github.com/pedrib/PoC/blob/master/tools/mikrotik_jailbreak.py</a><a href="#fnref-6" target="_blank">↩</a></p></li>
</ol>
</div>
</div>
</div>