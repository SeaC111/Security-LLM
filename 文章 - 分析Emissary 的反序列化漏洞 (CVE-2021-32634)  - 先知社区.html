<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h4 data-content="1" id="799b56782f262694409aeaea24e0e22a">简介</h4>
<p>NSA的项目 Emissary 中文"密使".<br/>
地址是 <a href="https://github.com/NationalSecurityAgency/emissary" target="_blank">https://github.com/NationalSecurityAgency/emissary</a></p>
<p>Emissary是一个基于P2P的数据驱动工作流引擎，运行在异构的、可能广泛分散的、多层的P2P计算资源网络中。<br/>
工作流行程不像传统的工作流引擎那样预先计划，而是随着数据的更多信息被发现而被确定(发现)。在Emissary工作流中通常没有用户交互，而是以面向目标的方式处理数据，直到它达到完成状态。</p>
<p>Emissary 是高度可配置的，但在这个"基本实现"(base implementation)中几乎什么都不做。<br/>
这个框架的用户应提供扩展<code>emissary.place.ServiceProviderPlace</code> 的类，以在 <code>emissary.core.IBaseDataObject</code> 有效负载上执行工作。</p>
<p>可以做各种各样的事情，工作流是分阶段管理的，例如:STUDY, ID, COORDINATE, TRANSFORM, ANALYZE, IO, REVIEW.</p>
<p><code>emissary.core.MobileAgent</code>是负责指挥工作流的类、和从它派生的类，它们管理一组相关的负载对象的路径通过工作流。<br/>
通过工作流管理一组相关的"负载对象"(payload objects)的路径。</p>
<p><code>emissary.directory.DirectoryPlace</code> 管理可用的"服务"(services)、它们的成本和质量，并保持 P2P 网络的连接。</p>
<p>参考<a href="https://securitylab.github.com/research/NSA-emissary/" target="_blank">https://securitylab.github.com/research/NSA-emissary/</a></p>
<h4 data-content="1" id="06706559c0c5cb2519a02bd431db76f0">不安全的反序列化(CVE-2021-32634) 漏洞1</h4>
<p>第一个。<br/>
位于<code>WorkSpaceClientEnqueueAction</code> REST端点中。</p>
<p>看代码<br/>
<a href="https://github.com/NationalSecurityAgency/emissary/blob/30c54ef16c6eb6ed09604a929939fb9f66868382/src/main/java/emissary/server/mvc/internal/WorkSpaceClientEnqueueAction.java#L52" target="_blank">https://github.com/NationalSecurityAgency/emissary/blob/30c54ef16c6eb6ed09604a929939fb9f66868382/src/main/java/emissary/server/mvc/internal/WorkSpaceClientEnqueueAction.java#L52</a></p>
<p>可见<code>WorkSpaceClientEnqueueAction</code>类的实现：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorkSpaceClientEnqueueAction</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

    <span class="cm">/*</span>
<span class="cm">     * &lt;!-- Put a file on a work PickUpPlaceClient queue --&gt; &lt;Use-Case source="*" action="/WorkSpaceClientEnque.action"&gt;</span>
<span class="cm">     * &lt;Work type="Bean" target="emissary.comms.http.worker.LogWorker"/&gt; &lt;Work type="Bean"</span>
<span class="cm">     * target="emissary.comms.http.worker.WorkSpaceClientEnqueWorker"/&gt; &lt;View status="0" view="/success.jsp"/&gt; &lt;View</span>
<span class="cm">     * status="-1" view="/error.jsp"/&gt; &lt;/Use-Case&gt;</span>
<span class="cm">     */</span>

    <span class="c1">// TODO This is an initial crack at the new endpoint, I haven't seen it called an am unsure when/if it does</span>
    <span class="nd">@POST</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"/WorkSpaceClientEnqueue.action"</span><span class="o">)</span>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
    <span class="nd">@Produces</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">TEXT_PLAIN</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">workspaceClientEnqueue</span><span class="o">(</span><span class="nd">@FormParam</span><span class="o">(</span><span class="n">WorkSpaceAdapter</span><span class="o">.</span><span class="na">CLIENT_NAME</span><span class="o">)</span> <span class="n">String</span> <span class="n">clientName</span><span class="o">,</span>
            <span class="nd">@FormParam</span><span class="o">(</span><span class="n">WorkSpaceAdapter</span><span class="o">.</span><span class="na">WORK_BUNDLE_OBJ</span><span class="o">)</span> <span class="n">String</span> <span class="n">workBundleString</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"TPWorker incoming execute! check prio={}"</span><span class="o">,</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getPriority</span><span class="o">());</span>
        <span class="c1">// TODO Doesn't look like anything is actually calling this, should we remove this?</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">success</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Look up the place reference</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">nsName</span> <span class="o">=</span> <span class="n">KeyManipulator</span><span class="o">.</span><span class="na">getServiceLocation</span><span class="o">(</span><span class="n">clientName</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">IPickUpSpace</span> <span class="n">place</span> <span class="o">=</span> <span class="o">(</span><span class="n">IPickUpSpace</span><span class="o">)</span> <span class="n">Namespace</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">nsName</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">place</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"No client place found using name "</span> <span class="o">+</span> <span class="n">clientName</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">final</span> <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">workBundleString</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"8859_1"</span><span class="o">)));</span>
            <span class="n">WorkBundle</span> <span class="n">paths</span> <span class="o">=</span> <span class="o">(</span><span class="n">WorkBundle</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">place</span><span class="o">.</span><span class="na">enque</span><span class="o">(</span><span class="n">paths</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"WorkSpaceClientEnqueWorker exception"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">serverError</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span><span class="s">"WorkSpaceClientEnqueWorker exception:\n"</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// old success from WorkSpaceClientEnqueWorker</span>
            <span class="c1">// return WORKER_SUCCESS;</span>
            <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span><span class="s">"Successful add to the PickUpPlaceClient queue"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// old failure from WorkSpaceClientEnqueWorker</span>
            <span class="c1">// return new WorkerStatus(WorkerStatus.FAILURE, "WorkSpaceClientEnqueWorker failed, queue full");</span>
            <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">serverError</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span><span class="s">"WorkSpaceClientEnqueWorker failed, queue full"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<p>可以通过对 的经过身份验证的 POST 请求访问此端点<code>/WorkSpaceClientEnqueue.action</code>。<br/>
正如上面源代码中所看到的，表单参数<code>WorkSpaceAdapterWORK_BUNDLE_OBJ</code> (即tpObj) 在第52行 被解码 并 反序列化。(可以看到<code>readObject</code>)</p>
<p>也就是最关键的这一行<code>final ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(workBundleString.getBytes("8859_1")));</code></p>
<p>幸运的是，这是一个身份验证后的问题(post-authentication issue)，由于SonarSource报告修复了跨站请求伪造(CSRF)漏洞，因此无法通过CSRF代表已登录用户利用该漏洞。</p>
<p>CodeQL还报告了另外2个不安全的反序列化操作，这些操作目前没有在代码中执行。然而，它们是定时炸弹，可能在未来的版本中启用，因此安全实验室团队也报告了它们。</p>
<p>第一个起源于<code>MoveToAction</code>类，它没有被Jersey server公开。<br/>
正如在comment中描述的:</p>
<pre><code>// TODO This is an initial crack at the new endpoint, I haven’t seen it called an am unsure when/if it does</code></pre>
<p>MoveToAction:<br/>
见<a href="https://github.com/NationalSecurityAgency/emissary/blob/22744ec91ef759078b14975df74a66243f1ce679/src/main/java/emissary/server/mvc/internal/MoveToAction.java" target="_blank">https://github.com/NationalSecurityAgency/emissary/blob/22744ec91ef759078b14975df74a66243f1ce679/src/main/java/emissary/server/mvc/internal/MoveToAction.java</a></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">Response</span> <span class="nf">moveTo</span><span class="o">(</span><span class="nd">@Context</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span>
 <span class="kd">final</span> <span class="n">MoveToAdapter</span> <span class="n">mt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MoveToAdapter</span><span class="o">();</span>
 <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">status</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="na">inboundMoveTo</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
 <span class="o">...</span>
</pre></div>
<p>MoveToAdapter:</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">inboundMoveTo</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span>
 <span class="kd">final</span> <span class="n">MoveToRequestBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MoveToRequestBean</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
   <span class="n">MoveToRequestBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span>
   <span class="kd">final</span> <span class="n">String</span> <span class="n">agentData</span> <span class="o">=</span> <span class="n">RequestUtil</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">AGENT_SERIAL</span><span class="o">);</span>
   <span class="n">setPayload</span><span class="o">(</span><span class="n">agentData</span><span class="o">);</span>
   <span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">=</span> <span class="n">PayloadUtil</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
  <span class="o">...</span>
</pre></div>
<p>PayloadUtil:</p>
<div class="highlight"><pre><span></span><span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"8859_1"</span><span class="o">)));</span>
</pre></div>
<h4 data-content="1" id="c3a14f38e721303c96c9bd818cda2f98">不安全的反序列化(CVE-2021-32634) 漏洞2</h4>
<p>第二个方法来源于<code>WorkSpaceAdapter</code>类的<code>inboundEnque</code>方法。<br/>
该漏洞需要调用<code>inboundEnque()</code>，但目前尚未执行该调用。</p>
<p>WorkspaceAdapter类:<br/>
见<a href="https://github.com/NationalSecurityAgency/emissary/blob/2e7939f3540f47f0374e77f083af8a657023de35/src/main/java/emissary/server/mvc/adapters/WorkSpaceAdapter.java" target="_blank">https://github.com/NationalSecurityAgency/emissary/blob/2e7939f3540f47f0374e77f083af8a657023de35/src/main/java/emissary/server/mvc/adapters/WorkSpaceAdapter.java</a></p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">   * Process the enque coming remotely over HTTP request params onto the specified (local) pickup client place</span>
<span class="cm">   */</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">inboundEnque</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NamespaceException</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"TPA incoming elements! check prio={}"</span><span class="o">,</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getPriority</span><span class="o">());</span>
    <span class="c1">// Parse parameters</span>
    <span class="kd">final</span> <span class="n">EnqueRequestBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnqueRequestBean</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
    <span class="c1">// Look up the place reference</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">nsName</span> <span class="o">=</span> <span class="n">KeyManipulator</span><span class="o">.</span><span class="na">getServiceLocation</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getPlace</span><span class="o">());</span>
    <span class="kd">final</span> <span class="n">IPickUpSpace</span> <span class="n">place</span> <span class="o">=</span> <span class="n">lookupPlace</span><span class="o">(</span><span class="n">nsName</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">place</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"No client place found using name "</span> <span class="o">+</span> <span class="n">bean</span><span class="o">.</span><span class="na">getPlace</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">place</span><span class="o">.</span><span class="na">enque</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getPaths</span><span class="o">());</span>
  <span class="o">}</span>
</pre></div>
<p>WorkspaceAdapter:</p>
<div class="highlight"><pre><span></span><span class="n">EnqueRequestBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">setPlace</span><span class="o">(</span><span class="n">RequestUtil</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">CLIENT_NAME</span><span class="o">));</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">getPlace</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"No 'place' specified"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">setPaths</span><span class="o">(</span><span class="n">RequestUtil</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">WORK_BUNDLE_OBJ</span><span class="o">));</span>
    <span class="o">}</span>
</pre></div>
<p>WorkspaceAdapter:</p>
<div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">     * Sets the WorkBundle object from serialized data</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">setPaths</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"8859_1"</span><span class="o">)));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">paths</span> <span class="o">=</span> <span class="o">(</span><span class="n">WorkBundle</span><span class="o">)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Cannot deserialize WorkBundle using {} bytes"</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">"Cannot deserialize WorkBundle"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<p>可以看到<code>readObject</code></p>
<h4 data-content="1" id="6fde28c277014f423300149a9f807b0d">修复与总结</h4>
<p>不安全的反序列化会造成安全隐患。</p>
</div>
</div>