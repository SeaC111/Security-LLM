<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="1e08ca59fe4fb89b3e54840950e5acf6"><strong>漏洞影响范围：</strong></h1>
<p>phpMyAdmin 4.8.0和4.8.1</p>
<h1 data-content="1" id="301a57b6be8ad6edd8826ec6754c07c6"><strong>漏洞分析：</strong></h1>
<p>index.php 55-63行</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">empty</span><span class="p">(</span><span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">])</span>
    <span class="o">&amp;&amp;</span> <span class="nx">is_string</span><span class="p">(</span><span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">])</span>
    <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">preg_match</span><span class="p">(</span><span class="s1">'/^index/'</span><span class="p">,</span> <span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">])</span>
    <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nx">in_array</span><span class="p">(</span><span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">],</span> <span class="o">$</span><span class="nx">target_blacklist</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="nx">Core</span><span class="err">::</span><span class="nx">checkPageValidity</span><span class="p">(</span><span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">])</span> 
<span class="p">)</span> <span class="p">{</span>
    <span class="nx">include</span> <span class="o">$</span><span class="nx">_REQUEST</span><span class="p">[</span><span class="s1">'target'</span><span class="p">];</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>这里需要满足如下5个条件便可以执行包含文件代码<code>include $_REQUEST['target'];</code></p>
<p>1.<code>$_REQUEST['target']</code>不为空<br/>
2.<code>$_REQUEST['target']</code>是字符串<br/>
3.<code>$_REQUEST['target']</code>开头不是<code>index</code><br/>
4.<code>$_REQUEST['target']</code>不在<code>$target_blacklist</code>中<br/>
5.<code>Core::checkPageValidity($_REQUEST['target'])</code>为真</p>
<p>定位到<code>checkPageValidity</code>函数在<code>Core.php 443-476</code>行</p>
<div class="highlight"><pre><span></span><span class="x">public static function checkPageValidity(&amp;$page, array $whitelist = [])</span>
<span class="x">    {</span>
<span class="x">        if (empty($whitelist)) {</span>
<span class="x">            $whitelist = self::$goto_whitelist;</span>
<span class="x">        }</span>
<span class="x">        if (! isset($page) || !is_string($page)) {</span>
<span class="x">            return false;</span>
<span class="x">        }</span>

<span class="x">        if (in_array($page, $whitelist)) {</span>
<span class="x">            return true;</span>
<span class="x">        }</span>

<span class="x">        $_page = mb_substr(</span>
<span class="x">            $page,</span>
<span class="x">            0,</span>
<span class="x">            mb_strpos($page . '?', '?')</span>
<span class="x">        );</span>
<span class="x">        if (in_array($_page, $whitelist)) {</span>
<span class="x">            return true;</span>
<span class="x">        }</span>

<span class="x">        $_page = urldecode($page);</span>
<span class="x">        $_page = mb_substr(</span>
<span class="x">            $_page,</span>
<span class="x">            0,</span>
<span class="x">            mb_strpos($_page . '?', '?')</span>
<span class="x">        );</span>
<span class="x">        if (in_array($_page, $whitelist)) {</span>
<span class="x">            return true;</span>
<span class="x">        }</span>

<span class="x">        return false;</span>
<span class="x">    }</span>
</pre></div>
<p>一开始没有<code>$whitelist</code>，所以<code>$whitelist</code>被赋值为<code>self::$goto_whitelist</code>，追踪一下<code>$goto_whitelist</code></p>
<div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">static</span> <span class="n">$goto_whitelist</span> <span class="p">=</span> <span class="n">array</span><span class="p">(</span>
        <span class="nd">'db_datadict</span><span class="err">.php',</span>
        <span class="nd">'db_sql</span><span class="err">.php',</span>
        <span class="nd">'db_events</span><span class="err">.php',</span>
        <span class="nd">'db_export</span><span class="err">.php',</span>
        <span class="nd">'db_importdocsql</span><span class="err">.php',</span>
        <span class="nd">'db_multi_table_query</span><span class="err">.php',</span>
        <span class="nd">'db_structure</span><span class="err">.php',</span>
        <span class="nd">'db_import</span><span class="err">.php',</span>
        <span class="nd">'db_operations</span><span class="err">.php',</span>
        <span class="nd">'db_search</span><span class="err">.php',</span>
        <span class="nd">'db_routines</span><span class="err">.php',</span>
        <span class="nd">'export</span><span class="err">.php',</span>
        <span class="nd">'import</span><span class="err">.php',</span>
        <span class="nd">'index</span><span class="err">.php',</span>
        <span class="nd">'pdf_pages</span><span class="err">.php',</span>
        <span class="nd">'pdf_schema</span><span class="err">.php',</span>
        <span class="nd">'server_binlog</span><span class="err">.php',</span>
        <span class="nd">'server_collations</span><span class="err">.php',</span>
        <span class="nd">'server_databases</span><span class="err">.php',</span>
        <span class="nd">'server_engines</span><span class="err">.php',</span>
        <span class="nd">'server_export</span><span class="err">.php',</span>
        <span class="nd">'server_import</span><span class="err">.php',</span>
        <span class="nd">'server_privileges</span><span class="err">.php',</span>
        <span class="nd">'server_sql</span><span class="err">.php',</span>
        <span class="nd">'server_status</span><span class="err">.php',</span>
        <span class="nd">'server_status_advisor</span><span class="err">.php',</span>
        <span class="nd">'server_status_monitor</span><span class="err">.php',</span>
        <span class="nd">'server_status_queries</span><span class="err">.php',</span>
        <span class="nd">'server_status_variables</span><span class="err">.php',</span>
        <span class="nd">'server_variables</span><span class="err">.php',</span>
        <span class="nd">'sql</span><span class="err">.php',</span>
        <span class="nd">'tbl_addfield</span><span class="err">.php',</span>
        <span class="nd">'tbl_change</span><span class="err">.php',</span>
        <span class="nd">'tbl_create</span><span class="err">.php',</span>
        <span class="nd">'tbl_import</span><span class="err">.php',</span>
        <span class="nd">'tbl_indexes</span><span class="err">.php',</span>
        <span class="nd">'tbl_sql</span><span class="err">.php',</span>
        <span class="nd">'tbl_export</span><span class="err">.php',</span>
        <span class="nd">'tbl_operations</span><span class="err">.php',</span>
        <span class="nd">'tbl_structure</span><span class="err">.php',</span>
        <span class="nd">'tbl_relation</span><span class="err">.php',</span>
        <span class="nd">'tbl_replace</span><span class="err">.php',</span>
        <span class="nd">'tbl_row_action</span><span class="err">.php',</span>
        <span class="nd">'tbl_select</span><span class="err">.php',</span>
        <span class="nd">'tbl_zoom_select</span><span class="err">.php',</span>
        <span class="nd">'transformation_overview</span><span class="err">.php',</span>
        <span class="nd">'transformation_wrapper</span><span class="err">.php',</span>
        <span class="nd">'user_password</span><span class="err">.php',</span>
    <span class="p">);</span>
</pre></div>
<p>再次回到checkPageValidity函数里面知道传入的参数$page必须在上面的白名单里面才会返回true，考虑到可能会带有参数，所以有了下面的判断</p>
<div class="highlight"><pre><span></span><span class="nv">$_page</span> <span class="o">=</span> mb_substr<span class="o">(</span>
            <span class="nv">$page</span>,
            <span class="m">0</span>,
            mb_strpos<span class="o">(</span><span class="nv">$page</span> . <span class="s1">'?'</span>, <span class="s1">'?'</span><span class="o">)</span>
        <span class="o">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="o">(</span>in_array<span class="o">(</span><span class="nv">$_page</span>, <span class="nv">$whitelist</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> true<span class="p">;</span>
        <span class="o">}</span>

        <span class="nv">$_page</span> <span class="o">=</span> urldecode<span class="o">(</span><span class="nv">$page</span><span class="o">)</span><span class="p">;</span>
        <span class="nv">$_page</span> <span class="o">=</span> mb_substr<span class="o">(</span>
            <span class="nv">$_page</span>,
            <span class="m">0</span>,
            mb_strpos<span class="o">(</span><span class="nv">$_page</span> . <span class="s1">'?'</span>, <span class="s1">'?'</span><span class="o">)</span>
        <span class="o">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="o">(</span>in_array<span class="o">(</span><span class="nv">$_page</span>, <span class="nv">$whitelist</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> true<span class="p">;</span>
        <span class="o">}</span>

        <span class="k">return</span> false<span class="p">;</span>
</pre></div>
<p><code>mb_strpos</code>：是一个定位函数，获取指定的字符在一个字符串中首次出现的位置</p>
<p><code>mb_substr</code>：截取指定字符串中某一段</p>
<p><code>$_page</code>传入的是<code>?</code>之前的内容，如果<code>$_page</code>在白名单中则返回<code>true</code><br/>
例如传入<code>?target=db_datadict.php%253f</code>，<code>%253f</code>开始服务器自动解码一次为<code>%3f</code>，然后<code>urldecode</code>函数再解码一次为?，则满足截取?之前的内容在白名单中，返回<code>true</code>。而在<code>index.php</code>中只解码一次为<code>db_datadict.php%3f</code>，然后进行包含</p>
<h1 data-content="1" id="3a6f05d9727a2f9229226f563bf6dad7"><strong>漏洞复现：</strong></h1>
<p>任意文件包含：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20191018143410-4b037b9c-f171-1.png"/></p>
<p>任意代码执行：<br/>
查看当前数据库路径：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20191018143420-50ebffe8-f171-1.png"/><br/>
执行SQL命令，创建数据库，创建表，创建列，插入字段代码<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20191018143428-561c29fc-f171-1.png"/><br/>
然后包含该文件<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20191018143439-5c3397c6-f171-1.png"/></p>
</div>
</div>