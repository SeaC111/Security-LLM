<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="761df0d4e7c2e0f765a49239e8768a8d">0x00概述</h1>
<p>202108，网上曝出cobaltstrike的DOS漏洞CVE-2021-36798，又名hotcobalt。<br/>
<a href="https://blog.cobaltstrike.com/2021/08/04/cobalt-strike-dos-vulnerability-cve-2021-36798/" target="_blank">https://blog.cobaltstrike.com/2021/08/04/cobalt-strike-dos-vulnerability-cve-2021-36798/</a><br/>
原因是对截屏（或keylogger）功能的返回数据解析处理不当，可被攻击者控制截屏大小，使teamserver不断申请内存以致outofmemory，从而被DOS。</p>
<h1 data-content="1" id="1a357167a8a0ad6b98bbb46251162cc5">0x01 影响范围</h1>
<p>cobaltstrike4.2/4.3</p>
<h1 data-content="1" id="4c66b09270c1e89088068a7a9f5d379e">0x02 前置知识</h1>
<p>先安装一些要用的东西<br/>
<a href="https://files.pythonhosted.org/packages/2c/52/c35ec79dd97a8ecf6b2bbd651df528abb47705def774a4a15b99977274e8/M2Crypto-0.38.0.tar.gz" target="_blank">https://files.pythonhosted.org/packages/2c/52/c35ec79dd97a8ecf6b2bbd651df528abb47705def774a4a15b99977274e8/M2Crypto-0.38.0.tar.gz</a><br/>
sudo<br/>
cd M2Crypto-0.38.0<br/>
python setup.py install</p>
<p>pip install pycryptodome<br/>
pip3 install hexdump<br/>
pip3 install pycryptodome<br/>
//pip install M2Crypto<br/>
pip install typing<br/>
pip install --upgrade setuptools<br/>
pip install hexdump</p>
<p>sudo apt-get install jq<br/>
sudo apt-get install python-dev<br/>
  //710  sudo apt-get install python-m2crypto<br/>
sudo apt-get install libssl-dev swig<br/>
sudo apt-get install ghex</p>
<h2 data-content="1" id="a610a58754030c0ab1f1c8b9dd90bd9e">stage和stageless/unstage/full staged</h2>
<blockquote>
<p>Beacon是Cobalt Strike运行在目标主机上的payload，Beacon在隐蔽信道上我们提供服务，用于长期控制受感染主机。它的工作方式与Metasploit Framework Payload类似。在实际渗透过程中，我们可以将其嵌入到可执行文件、添加到Word文档或者通过利用主机漏洞来传递Beacon</p>
<p>很多攻击框架都是使用分段的shellcode，以防止shellcode过长，覆盖到了上一函数栈帧的数据，导致引发异常。要说分段shellcode就不得不提stager，stager是一段很精短的代码，它可以连接下载真正的payload并将其注入内存。我们使用stager就可以解决shellcode过长的问题。</p>
<p>The payload stagers in Cobalt Strike do not authenticate the controller or verify the payload they download</p>
<p>Cobalt Strike 3.5.1后的版本可以通过在Malleable C2中添加host_stage选项，以限制分段payload</p>
<p>在Cobalt Strike 4中应该尽可能多的使用unstage<br/>
一方面以保证安全性（因为你无法确保stager下载的stage是否受到中间人攻击，除非像MSF一样使用SSL保证安全性）。另一方面如果我们通过层层的代理，在内网进行漫游，这个时候使用分段的payload如果网络传输出现问题，stage没有加载过去，可能就会错失一个Beacon，unstage的payload会让人放心不少</p>
<p>Stageless Beacon artifacts include: an executable, a service executable, DLLs, PowerShell, and a blob of shellcode that initializes and runs the Beacon payload.</p>
<p>payload staging : The first stage is called a stager. The stager is a very tiny program, often written in hand-optimized assembly, that: connects to Cobalt Strike, downloads the Beacon payload (also called the stage), and executes it.</p>
</blockquote>
<p>//上述内容引用自：<br/>
<a href="https://cloud.tencent.com/developer/article/1595548" target="_blank">https://cloud.tencent.com/developer/article/1595548</a><br/>
<a href="https://blog.cobaltstrike.com/2016/06/15/what-is-a-stageless-payload-artifact/" target="_blank">https://blog.cobaltstrike.com/2016/06/15/what-is-a-stageless-payload-artifact/</a><br/>
<a href="https://blog.cobaltstrike.com/2016/06/22/talk-to-your-children-about-payload-staging/" target="_blank">https://blog.cobaltstrike.com/2016/06/22/talk-to-your-children-about-payload-staging/</a></p>
<p>简单说：<br/>
stage就是分段下载payload，类似先小马（stager）后大马（stage/beacon-payload）的操作。<br/>
stageless就是包含了所有的payload，类似直接传大马。</p>
<h2 data-content="1" id="fccca271a4dfec2cb6f099f4222f2952">beacon交互</h2>
<p>.cobaltstrike.beacon_keys这个文件里有teamserver生成的公私钥，每一个beacon都内嵌了公钥。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915152922-a5600d5c-15f6-1.png"/></p>
<p>beacon解析<br/>
python3 parse_beacon_config.py <a href="http://192.168.57.88/" target="_blank">http://192.168.57.88/</a> --json --version 4 | zsh -c jq *<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915153306-2afbd66c-15f7-1.png"/></p>
<p>通过这个listener/host_stage就可以获取到beacon的设置信息，就可以伪造beacon/session上线。<br/>
在目标受害机器运行cs生成的后门时，会向c2发出一个get的checksum8格式的请求下载剩余的payload（shellcode分段，另一种是stageless）<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915153452-6a0dd8e6-15f7-1.png"/></p>
<p>beacon在目标受害机器运行时会通过http get向cs的c2传回（元数据metadata）目标机器的一些信息如cpu，ip，AES密钥等（用该rsa公钥加密），姑且称为beacon注册。<br/>
之后攻击者就可以和beacon交互了，通常是用http get接收指令，用http post返回信息。这些任务用了之前beacon注册请求发送的AES key加密。</p>
<p>先获取公私钥：<br/>
<a href="https://gist.github.com/olliencc/af056560e943bafa145120103a0947a3#file-dump-java" target="_blank">https://gist.github.com/olliencc/af056560e943bafa145120103a0947a3#file-dump-java</a><br/>
javac -cp "cobaltstrike.jar" DumpKeys.java<br/>
java -cp ".:./cobaltstrike.jar" DumpKeys</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915153818-e531f8d6-15f7-1.png"/></p>
<p>抓包：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154012-28def7b4-15f8-1.png"/></p>
<p>用rsa私钥解密的数据：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154112-4cf48452-15f8-1.png"/></p>
<p>可以看到部分信息，更具体的解析要逆出cs的通信格式。<br/>
//beacon会不停发这个get请求获取teamserver的任务信息</p>
<p>解密beacon的metadata：<br/>
<a href="https://github.com/WBGlIl/CS_Decrypt/blob/main/Beacon_metadata_RSA_Decrypt.py" target="_blank">https://github.com/WBGlIl/CS_Decrypt/blob/main/Beacon_metadata_RSA_Decrypt.py</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154428-c1adc218-15f8-1.png"/></p>
<p>AES key:1f6a1085fc9544467b78546215e97282<br/>
HMAC key:6b7712a4ab24b25e9347ab82fc073438</p>
<p>解密teamserver-&gt;beacon的任务：<br/>
通过wireshark抓包保存数据包为bin文件，这是个文件浏览的任务<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154542-edb8c0ce-15f8-1.png"/></p>
<p>再利用ghex提取body数据，这是一个下载phpinfo.php文件的任务。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154640-10222ef2-15f9-1.png"/></p>
<p>解密之：<br/>
<a href="https://github.com/WBGlIl/CS_Decrypt/blob/main/CS_Task_AES_Decrypt.py" target="_blank">https://github.com/WBGlIl/CS_Decrypt/blob/main/CS_Task_AES_Decrypt.py</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154737-327e4fe4-15f9-1.png"/></p>
<p>该请求对应的beacon响应解密（beacon-&gt;teamserver）：<br/>
<a href="https://github.com/WBGlIl/CS_Decrypt/blob/main/Beacon_Task_return_AES_Decrypt.py" target="_blank">https://github.com/WBGlIl/CS_Decrypt/blob/main/Beacon_Task_return_AES_Decrypt.py</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915154922-71075c38-15f9-1.png"/></p>
<p>同理解密一个文件浏览请求的beacon响应：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155031-99e3680e-15f9-1.png"/></p>
<h1 data-content="1" id="4bd3c03f6e02d168f76facbaac2eda73">0x03 漏洞重现</h1>
<p><a href="https://github.com/Sentinel-One/CobaltStrikeParser/blob/master/extra/communication_poc.py" target="_blank">https://github.com/Sentinel-One/CobaltStrikeParser/blob/master/extra/communication_poc.py</a><br/>
用这个poc可以注册一个假beacon<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155210-d536953e-15f9-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155221-db309fde-15f9-1.png"/></p>
<p>exp:<br/>
<a href="https://github.com/JamVayne/CobaltStrikeDos" target="_blank">https://github.com/JamVayne/CobaltStrikeDos</a><br/>
python3 CobaltStrikeDos.py <a href="http://192.168.57.88/" target="_blank">http://192.168.57.88/</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155440-2e7b8ef6-15fa-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155452-35623aee-15fa-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155500-3a4dc8f2-15fa-1.png"/></p>
<p>成功DOS！</p>
<h1 data-content="1" id="aa45da7d8f57099d5c6e01815af7ba1e">0x04 EXP流量分析</h1>
<p>先请求checksum8 url<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155651-7c73006c-15fa-1.png"/></p>
<p>接着发出大量beacon注册请求<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915155755-a284d410-15fa-1.png"/></p>
<p>再发出大量beacon响应的截屏任务<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160002-ee38c0ba-15fa-1.png"/></p>
<p>尝试解密一个metadata<br/>
Rhm3p3/UZFiJbU0fOjQKPHcD3AoYy7OyB8p+3Py7l6WDazCa/fl/V4gCsdIhKYAT4XN60kNzUndaDbCflqqmsSjJts0rK70SjRGRdfTkBhNOASLVR34/+Cy3SuiO0CPL30yhHBDBAKRNZVo+inA3Qjvtyvu9emD9hVWwy7gkwlU=</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160103-12877010-15fb-1.png"/></p>
<p>用这个exp要注释掉process变量。<br/>
找到有96m截屏的一个流量：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160218-3f7d6ba6-15fb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160229-45c4dd6e-15fb-1.png"/></p>
<p>再通过beaconid找到对应的submit.php<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160335-6d19dc16-15fb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160345-7335adaa-15fb-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20210915160355-78e00c8c-15fb-1.png"/></p>
<h1 data-content="1" id="ead0875f1a4f0789a8bbc0e880077838">0x05 漏洞分析</h1>
<h2 data-content="1" id="88073ee2349d3f214b8ce7d3bdb021b1">decompiled-src/beacon/BeaconC2.java</h2>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">process_beacon_callback_decrypted</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">int1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">AssertUtils</span><span class="o">.</span><span class="na">TestIsNumber</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">AssertUtils</span><span class="o">.</span><span class="na">TestNotNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">""</span><span class="o">),</span> <span class="s">"process output for beacon session"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">DataInputStream</span> <span class="n">dataInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">array</span><span class="o">));</span>
            <span class="n">int1</span> <span class="o">=</span> <span class="n">dataInputStream</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">int1</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">String</span> <span class="n">process</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getCharsets</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">CommonUtils</span><span class="o">.</span><span class="na">readAll</span><span class="o">(</span><span class="n">dataInputStream</span><span class="o">));</span>
                <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">output</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">Output</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"received output:\n"</span> <span class="o">+</span> <span class="n">process</span><span class="o">));</span>
                <span class="k">this</span><span class="o">.</span><span class="na">runParsers</span><span class="o">(</span><span class="n">process</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">int1</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="o">......</span>

            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">int1</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">DataParser</span> <span class="n">dataParser2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataParser</span><span class="o">(</span><span class="n">CommonUtils</span><span class="o">.</span><span class="na">readAll</span><span class="o">(</span><span class="n">dataInputStream</span><span class="o">));</span>
                <span class="n">dataParser2</span><span class="o">.</span><span class="na">little</span><span class="o">();</span>
                <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">countedBytes</span> <span class="o">=</span> <span class="n">dataParser2</span><span class="o">.</span><span class="na">readCountedBytes</span><span class="o">();</span>   <span class="c1">//取头4个字节整数作为截图大小</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">int3</span> <span class="o">=</span> <span class="n">dataParser2</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
                <span class="kd">final</span> <span class="n">String</span> <span class="n">process5</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getCharsets</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">dataParser2</span><span class="o">.</span><span class="na">readCountedBytes</span><span class="o">());</span>
                <span class="kd">final</span> <span class="n">String</span> <span class="n">process6</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getCharsets</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">dataParser2</span><span class="o">.</span><span class="na">readCountedBytes</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">countedBytes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">output</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">Error</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"screenshot from desktop "</span> <span class="o">+</span> <span class="n">int3</span> <span class="o">+</span> <span class="s">" is empty"</span><span class="o">));</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kd">final</span> <span class="n">BeaconEntry</span> <span class="n">resolve2</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">resolve</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">resolve2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kd">final</span> <span class="n">Screenshot</span> <span class="n">screenshot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Screenshot</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">countedBytes</span><span class="o">,</span> <span class="n">process6</span><span class="o">,</span> <span class="n">resolve2</span><span class="o">.</span><span class="na">getComputer</span><span class="o">(),</span> <span class="n">int3</span><span class="o">,</span> <span class="n">process5</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">screenshot</span><span class="o">(</span><span class="n">screenshot</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">process5</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">output</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">OutputB</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"received screenshot of "</span> <span class="o">+</span> <span class="n">process5</span> <span class="o">+</span> <span class="s">" from "</span> <span class="o">+</span> <span class="n">process6</span> <span class="o">+</span> <span class="s">" ("</span> <span class="o">+</span> <span class="n">CommonUtils</span><span class="o">.</span><span class="na">formatSize</span><span class="o">(</span><span class="n">countedBytes</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">+</span> <span class="s">")"</span><span class="o">));</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">archive</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">Activity</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"screenshot of "</span> <span class="o">+</span> <span class="n">process5</span> <span class="o">+</span> <span class="s">" from "</span> <span class="o">+</span> <span class="n">process6</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">output</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">OutputB</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"received screenshot from "</span> <span class="o">+</span> <span class="n">process6</span> <span class="o">+</span> <span class="s">" ("</span> <span class="o">+</span> <span class="n">CommonUtils</span><span class="o">.</span><span class="na">formatSize</span><span class="o">(</span><span class="n">countedBytes</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">+</span> <span class="s">")"</span><span class="o">));</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">archive</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">Activity</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"screenshot from "</span> <span class="o">+</span> <span class="n">process6</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">this</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="k">new</span> <span class="n">ScreenshotEvent</span><span class="o">(</span><span class="n">screenshot</span><span class="o">));</span>
            <span class="o">}</span>
</pre></div>
<h2 data-content="1" id="de421f2ccdcb8b5c10cfe0984159816c">decompiled-src/common/DataParser.java</h2>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readCountedBytes</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">int1</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>   <span class="c1">//取4个字节整数</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">int1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">int1</span><span class="o">);</span>   <span class="c1">//返回这4个字节整数的大小</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="o">}</span>
</pre></div>
<p>接着会分配一个足够大的缓冲区来读取截屏数据。</p>
<h1 data-content="1" id="1e13b91fbcb39e0048aa1e151aa966ce">0x06 修复方案</h1>
<p>1.更新至4.4版本。<br/>
/<br/>
2.host_stage=false<br/>
防止beacon设置信息被获取从而防御被dos。<br/>
/<br/>
3.只允许可信的源访问teamserver。<br/>
/<br/>
4.添加防御代码：（未测试是否可行）<br/>
在用<br/>
<a href="https://github.com/Sentinel-One/CobaltStrikeParser/blob/master/extra/communication_poc.py" target="_blank">https://github.com/Sentinel-One/CobaltStrikeParser/blob/master/extra/communication_poc.py</a><br/>
和<br/>
<a href="https://github.com/M-Kings/CVE-2021-36798/blob/main/CVE-2021-36798.py" target="_blank">https://github.com/M-Kings/CVE-2021-36798/blob/main/CVE-2021-36798.py</a><br/>
这两个poc测试时候dos不成功。<br/>
发现teamserver会出现<br/>
Dropped responses from session 111 [type: 222] (no interaction with this session yet)</p>
<p>搜索源代码：<br/>
decompiled-src/beacon/BeaconC2.java</p>
<div class="highlight"><pre><span></span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">int1</span> <span class="o">==</span> <span class="mi">29</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">parts</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">CommonUtils</span><span class="o">.</span><span class="na">readAll</span><span class="o">(</span><span class="n">dataInputStream</span><span class="o">));</span>
                <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">parts</span><span class="o">.</span><span class="na">isReady</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">process_beacon_callback_decrypted</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">parts</span><span class="o">.</span><span class="na">data</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">isNewSession</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getCheckinListener</span><span class="o">().</span><span class="na">output</span><span class="o">(</span><span class="n">BeaconOutput</span><span class="o">.</span><span class="na">Error</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="s">"Dropped responses from session. Didn't expect "</span> <span class="o">+</span> <span class="n">int1</span> <span class="o">+</span> <span class="s">" prior to first task."</span><span class="o">));</span>
                    <span class="n">CommonUtils</span><span class="o">.</span><span class="na">print_error</span><span class="o">(</span><span class="s">"Dropped responses from session "</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" [type: "</span> <span class="o">+</span> <span class="n">int1</span> <span class="o">+</span> <span class="s">"] (no interaction with this session yet)"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
</pre></div>
<p>这个好像是对cobaltstrike3.5的rce的修复方案之一，判断beacon和c2要有至少一次交互，而cobaltstrikeparser中parse_beacon_config这个库的poc是没有交互直接发payload的。<br/>
//from parse_beacon_config import cobaltstrikeConfig<br/>
所以这两个poc不成功应该就是利用了parse_beacon_config库从而被这段代码防住了。<br/>
所以或许可以用这个代码来防御利用了parse_beacon_config的poc，复制代码到截屏和keylogger的if分支即可<br/>
else if (int1 == 3)   //截图功能</p>
<p>else if (int1 == 1) {   //keylogger</p>
<h1 data-content="1" id="59a5d0ddc492bc803e91a8b2980744fe">0x07 参考资料</h1>
<p><a href="https://www.sentinelone.com/labs/hotcobalt-new-cobalt-strike-dos-vulnerability-that-lets-you-halt-operations/" target="_blank">https://www.sentinelone.com/labs/hotcobalt-new-cobalt-strike-dos-vulnerability-that-lets-you-halt-operations/</a><br/>
<a href="https://f5.pm/go-81984.html" target="_blank">https://f5.pm/go-81984.html</a><br/>
<a href="https://hub.fastgit.org/Sentinel-One/CobaltStrikeParser" target="_blank">https://hub.fastgit.org/Sentinel-One/CobaltStrikeParser</a><br/>
<a href="https://hub.fastgit.org/JamVayne/CobaltStrikeDos" target="_blank">https://hub.fastgit.org/JamVayne/CobaltStrikeDos</a><br/>
<a href="https://www.cobaltstrike.com/help-malleable-c2" target="_blank">https://www.cobaltstrike.com/help-malleable-c2</a></p>
<p><a href="https://blog.cobaltstrike.com/2016/06/15/what-is-a-stageless-payload-artifact/" target="_blank">https://blog.cobaltstrike.com/2016/06/15/what-is-a-stageless-payload-artifact/</a><br/>
<a href="https://blog.cobaltstrike.com/2013/06/28/staged-payloads-what-pen-testers-should-know/" target="_blank">https://blog.cobaltstrike.com/2013/06/28/staged-payloads-what-pen-testers-should-know/</a><br/>
<a href="https://blog.cobaltstrike.com/2016/06/22/talk-to-your-children-about-payload-staging/" target="_blank">https://blog.cobaltstrike.com/2016/06/22/talk-to-your-children-about-payload-staging/</a></p>
<p><a href="https://wbglil.gitbook.io/cobalt-strike/cobalt-strike-yuan-li-jie-shao/cs-mu-biao-shang-xian-guo-cheng" target="_blank">https://wbglil.gitbook.io/cobalt-strike/cobalt-strike-yuan-li-jie-shao/cs-mu-biao-shang-xian-guo-cheng</a><br/>
<a href="https://github.com/WBGlIl/CS_Decrypt" target="_blank">https://github.com/WBGlIl/CS_Decrypt</a></p>
</div>
</div>