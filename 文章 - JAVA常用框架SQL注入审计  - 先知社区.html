<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="694687cef5e4b1e52ed8617dbb8bb0eb">SQL注入代码审计</h1>
<h2 data-content="1" id="d61c75bf45a7e592dc81cc82c1367d62">一、JDBC拼接不当造成sql注入</h2>
<p>​       JDBC存在两种方法执行SQL语句，分别为PreparedStatement和Statement，相比Statement ，PreparedStatement会对SQL语句进行预编译，Statement会直接拼接sql语句造成SQL注入漏洞</p>
<h3 data-content="1" id="1ded6b94a4f5defe77a656fdb0c912b4">1.Statement</h3>
<p>​       示例代码中直接使用statement.executeQuery(sql)，存在sql注入漏洞</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/jdbc/vuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">jdbc_sqli_vul</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="c1">// sqli vuln code</span>
        <span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">;</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">res_name</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">res_pwd</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">info</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s: %s\n"</span><span class="o">,</span> <span class="n">res_name</span><span class="o">,</span> <span class="n">res_pwd</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Sorry,can`t find the Driver!"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>​       此处存在sql注入漏洞，执行SQL语句为select * from users where username = 'joychoun' or '1' = '1'</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/9ae54354-5008-4008-8f43-b53cfeaaa7df.png"/><br/>
<img src="https://storage.tttang.com/media/attachment/2022/08/30/c020cb7a-c323-4015-b701-af3b38abc68c.png"/></p>
<h3 data-content="1" id="17e582c3abcccd47dc1604cb3bcf1860">2.PreparedStatement</h3>
<p>​       与Statement的区别在于PrepareStatement会对SQL语句进行预编译，预编译的好处不仅在于在一定程度上防止了sql注入，还减少了sql语句的编译次数，提高了性能，其原理是先去编译sql语句，无论最后输入为何，预编译的语句只是作为字符串来执行，而SQL注入只对编译过程有破坏作用，执行阶段只是把输入串作为数据处理，不需要再对SQL语句进行解析，因此解决了注入问题。</p>
<p>​       PrepareStatement防御预编译的写法是使用?作为占位符然后将SQL语句进行预编译，由于"?"作为占位符已经告诉数据库整个SQL语句的结构，即?处传入的是参数，而不会是sql语句，所以即使攻击者传入sql语句也不会被数据库解析。</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/jdbc/sec"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">jdbc_sqli_sec</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">con</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connecting to Database successfully."</span><span class="o">);</span>
        <span class="c1">// fix code</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username = ?"</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="n">st</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>  <span class="c1">// sql after prepare statement</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">res_name</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">res_pwd</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">info</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s: %s\n"</span><span class="o">,</span> <span class="n">res_name</span><span class="o">,</span> <span class="n">res_pwd</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Sorry, can`t find the Driver!"</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
<p>​       此时不存在SQL注入漏洞，传入的payload已进行转义</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/223bd571-ba98-48fe-b7ed-477dc1164522.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/48240d60-2b82-4775-9a79-4db4ce12b05d.png"/></p>
<h3 data-content="1" id="339102917752d55b04a1e4483ddaf0f3">3.JDBC易产生漏洞点</h3>
<h4 data-content="1" id="23ecf6ad70c0e0731b009ea42b2aa29a">3.1.未使用占位符</h4>
<p>​               PreparedStatement只有在使用"?"作为占位符才能预防sql注入，直接拼接仍会存在sql注入漏洞</p>
<h4 data-content="1" id="d1aa6bb23c9956294a24eed62edd20c7">3.2.使用in语句</h4>
<p>​               删除语句中可能会存在此类语句,由于无法确定delIds含有对象个数而直接拼接sql语句，造成sql注入。</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"delete from users where id in("</span><span class="o">+</span><span class="n">delIds</span><span class="o">+</span><span class="err">"</span><span class="o">);</span> <span class="c1">//存在sql注入</span>
</pre></div>
<p>​           解决方法为遍历传入的 对象个数，使用“?”占位符。</p>
<h4 data-content="1" id="4d69ef338d576d07b36f8ac65b3168c2">3.3.使用like语句</h4>
<p>​           使用like语句直接拼接会造成sql注入</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where password like '%"</span> <span class="o">+</span> <span class="n">con</span> <span class="o">+</span> <span class="s">"%'"</span><span class="o">;</span> <span class="c1">//存在sql注入</span>
</pre></div>
<h4 data-content="1" id="bbe372e4bb5ffceb337b6a55aecca7b5">3.4.%和_</h4>
<p>​               没有手动过滤%。预编译是不能处理这个符号的， 所以需要手动过滤，否则会造成慢查询，造成 dos。</p>
<h4 data-content="1" id="a3d677f4bc67c6e2e9679a2b5051923a">3.5.Order by、from等无法预编译</h4>
<p>​               通过上面对使用in关键字和like关键字发现，只需要对要传参的位置使用占位符进行预编译时似乎就可以完全防止SQL注入，然而事实并非如此，当使用order by语句时是无法使用预编译的，原因是order by子句后面需要加字段名或者字段位置，而字段名是不能带引号的，否则就会被认为是一个字符串而不是字段名，然而使用PreapareStatement将会强制给参数加上'，所以，在使用order by语句时就必须得使用拼接的Statement，所以就会造成SQL注入，需要进行手动过滤，否则存在sql注入。</p>
<p>​               <code>String sql = "Select * from news where title =?" + "order by '" + time + "' asc"</code></p>
<h2 data-content="1" id="d9abe9357b51d032eb5fff614c4a7ed2">二.Mybatis框架下的sql注入</h2>
<p>​       Mybatis使用parameterType向sql语句传参，在sql引用传参可以使用#{Parameter}和${Parameter}两种方式</p>
<h3 data-content="1" id="67b476485171c5cd05b02ef58a1a03ab">1 .${Parameter}方式</h3>
<p>​   ${Parameter}采用拼接的方式构造SQL语句，在对用户输入过滤不严格的前提下，存在sql注入漏洞</p>
<div class="highlight"><pre><span></span><span class="c1">//Mybatis </span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from users where username = '${username}'"</span><span class="o">)</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findByUserNameVuln01</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/mybatis/vuln01"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">mybatisVuln01</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findByUserNameVuln01</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/90de4f00-6463-40c3-b6d7-72977655f813.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/cd1566fc-0a42-4033-a101-a1529f2ac28e.png"/></p>
<h3 data-content="1" id="47ca0b8cb3dd5977e9a9dd92b007e2d8">2.#{Parameter}方式</h3>
<p>​   #{Parameter}采用预编译的方式构造SQL语句，避免了SQL注入的产生</p>
<div class="highlight"><pre><span></span><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/mybatis/sec01"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">User</span> <span class="nf">mybatisSec01</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findByUserName</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1">//Mybatis </span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from users where username = #{username}"</span><span class="o">)</span>
<span class="n">User</span> <span class="nf">findByUserName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/2fb71066-732f-4e82-9877-28973a1ee1f8.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/a3e6d9a0-a84c-45f6-afc3-a3ae5f0ba8c3.png"/></p>
<h3 data-content="1" id="8ad27913035519f35068f4f0ccf0e3ab">3.MyBatis易产生SQL注入的三种情况</h3>
<h4 data-content="1" id="c17811078ac8c65897807795caa2219f">3.1 模糊查询</h4>
<p>​       在这种情况下使用#{}程序会报错，新手程序员就把#号改成了$,这样如果java代码层面没有对用户输入的内容做处理势必会产生SQL注入漏洞。</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">select</span> <span class="n">id</span><span class="o">=</span><span class="s">"findByUserNameVuln02"</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">"String"</span> <span class="n">resultMap</span><span class="o">=</span><span class="s">"User"</span><span class="o">&gt;</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">username</span> <span class="n">like</span> <span class="err">'</span><span class="o">%</span><span class="n">$</span><span class="o">{</span><span class="n">_parameter</span><span class="o">}%</span><span class="err">'</span>
<span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/94f4b8cf-533d-4371-bdfa-441c69a95954.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/fa2241df-0501-46fc-a718-dfb5a985ef3e.png"/></p>
<p>​       正确写法如下：</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">select</span> <span class="n">id</span><span class="o">=</span><span class="s">"findByUserNamesec"</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">"String"</span> <span class="n">resultMap</span><span class="o">=</span><span class="s">"User"</span><span class="o">&gt;</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">username</span> <span class="n">like</span> <span class="nf">concat</span><span class="o">(</span><span class="sc">'%'</span><span class="o">,</span><span class="err">#</span><span class="o">{</span><span class="n">_parameter</span><span class="o">},</span> <span class="sc">'%'</span><span class="o">)</span>
<span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
</pre></div>
<p>​       这样拼接就不会存在sql注入。<br/>
<img src="https://storage.tttang.com/media/attachment/2022/08/30/9c8cf36c-172e-44ff-9e91-21a0b3eb66e4.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/39844fe6-a3c7-42d3-a572-81c8ebb64f36.png"/></p>
<p>​       正确写法：</p>
<div class="highlight"><pre><span></span><span class="nl">mysql:</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">username</span> <span class="n">like</span> <span class="nf">concat</span><span class="o">(</span><span class="sc">'%'</span><span class="o">,</span><span class="err">#</span><span class="o">{</span><span class="n">username</span><span class="o">},</span><span class="sc">'%'</span><span class="o">)</span>
<span class="nl">oracle:</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">username</span> <span class="n">like</span> <span class="sc">'%'</span><span class="o">||</span><span class="err">#</span><span class="o">{</span><span class="n">username</span><span class="o">}||</span><span class="sc">'%'</span>
<span class="nl">sqlserver:</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">username</span> <span class="n">like</span> <span class="sc">'%'</span><span class="o">+</span><span class="err">#</span><span class="o">{</span><span class="n">username</span><span class="o">}+</span><span class="sc">'%'</span>
</pre></div>
<h4 data-content="1" id="9e48acdc909d0b5ea92771e84e4d0af4">3.2 使用in语句</h4>
<p>​       使用in语句时直接使用#{}会报错，可能会存在使用${}直接拼接，造成sql注入</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">select</span> <span class="n">id</span><span class="o">=</span><span class="s">"findByUserNameVuln04"</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">"String"</span> <span class="n">resultMap</span><span class="o">=</span><span class="s">"User"</span><span class="o">&gt;</span>
    <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">id</span> <span class="nf">in</span> <span class="o">(</span><span class="n">$</span><span class="o">{</span><span class="n">id</span><span class="o">})</span>
<span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1">// http://localhost:8080/sqli/mybatis/vuln04?id=1)%20AND%201=1%23</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/mybatis/vuln04"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">mybatisVuln04</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">findByUserNameVuln04</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/ecb91bc7-1f17-4692-a1a6-dfe04776ee58.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/8b38e22c-8e3a-4c80-9159-ea0f98e0e2fb.png"/></p>
<p>​       正确用法为使用foreach，而不是将#替换为$</p>
<div class="highlight"><pre><span></span><span class="n">id</span> <span class="n">in</span><span class="o">&lt;</span><span class="n">foreach</span> <span class="n">collection</span><span class="o">=</span><span class="s">"ids"</span> <span class="n">item</span><span class="o">=</span><span class="s">"item"</span> <span class="n">open</span><span class="o">=</span><span class="s">"("</span><span class="n">separatosr</span><span class="o">=</span><span class="s">","</span> <span class="n">close</span><span class="o">=</span><span class="s">")"</span><span class="o">&gt;</span><span class="err">#</span><span class="o">{</span><span class="n">ids</span><span class="o">}</span> <span class="o">&lt;/</span><span class="n">foreach</span><span class="o">&gt;</span>
</pre></div>
<h4 data-content="1" id="f6846532a79ee5229a6a862eaca4b4ce">3.3使用order by 语句</h4>
<p>​       和JDBC同理，使用#{}方式传参会导致order by语句失效，所以使用order by语句的时候还是需要做好过滤</p>
<h2 data-content="1" id="6c4e7b6d21c8e58b00193e306e0f2951">三.Mybatis-plus框架下的sql注入</h2>
<p>​       与SpringDataJpa类似，mybatis-plus提供了相关的funciton进行sql的操作，例如like("name","tks")——&gt;name like '%tks%'，同时也很贴心的考虑到了SQL注入问题，对绝大部分场景进行了预编译处理。但是类似动态表名、orderby这种需要拼接的场景在实际开发中还是需要额外的注意。</p>
<h2 data-content="1" id="50a7249907390de7efc423cf0b0493f2">1.条件构造器Wrapper</h2>
<p>​       条件构造器Wrapper可以用于复杂的数据库操作：大于、小于、模糊查询等等。</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/c4b6465e-94a8-4fe4-9884-c58aa4ad56b9.png"/></p>
<p>​       比较常用的是QueryWrapper和UpdateWrapper：</p>
<ul>
<li>Wrapper ： 条件构造抽象类，最顶端父类，抽象类中提供4个方法</li>
<li>AbstractWrapper ： 用于查询条件封装，生成 sql 的 where 条件</li>
<li>AbstractLambdaWrapper ： Lambda 语法使用 Wrapper统一处理解析 lambda 获取 column。</li>
<li>LambdaQueryWrapper ：用于Lambda语法使用的查询Wrapper</li>
<li>LambdaUpdateWrapper ： Lambda 更新封装Wrapper</li>
<li>QueryWrapper ： Entity 对象封装操作类，不是用lambda语法</li>
<li>UpdateWrapper ： Update 条件封装，用于Entity对象更新操作</li>
</ul>
<h3 data-content="1" id="735d8682070a6b0c024182b89846a7f2">1.1基础使用</h3>
<p>配置基础类</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.annotation.TableName</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@TableName</span><span class="o">(</span><span class="s">"tutorials"</span><span class="o">)</span>
<span class="c1">//tutorials</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Tutorial</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">Id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">Title</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">Author</span><span class="o">;</span>

<span class="o">}</span>
</pre></div>
<p>配置Mapper</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.mapper.BaseMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Tutorial</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TutorialMapper</span> <span class="kd">extends</span> <span class="n">BaseMapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
<p>调用相关的api进行操作</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"selectauthor"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Tutorial</span> <span class="nf">mybatisselect</span><span class="o">(</span><span class="n">String</span> <span class="n">author</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span><span class="n">author</span><span class="o">);</span>
    <span class="n">Tutorial</span> <span class="n">tutorial</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">tutorial</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="16972602418ed0570aa91673a6864a72">1.2mybatis-puls预编译</h3>
<p>传统的mybaits框架对于in范围查询和like模糊查询需要做额外的处理：</p>
<p>  like模糊查询需要在mapperxml配置中用sql的内置函数进行拼接，拼接后再采用#预编译的方式进行查询；</p>
<p>    in范围查询的话需要在进行同条件多值查询的时候，可以使用MyBatis自带的循环指令foreach来解决SQL语句动态拼接的问题；</p>
<p>mybatis-puls已经考虑到sql注入的影响，相关wrapper的function已进行了相关的预编译处理。例如mybatis常见的like和in注入场景，均进行了预编译处理，例如如下例子：<br/>
        like模糊查询</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/like"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatislike</span><span class="o">(</span><span class="n">String</span> <span class="n">author</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">"*"</span><span class="o">).</span><span class="na">like</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span><span class="n">author</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">tutorials</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">tutorials</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>打印相关的查询log，可以看到相关查询已使用?进行预编译处理：</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/1203b36f-b2d7-451c-aa3a-539915bc4694.png"/></p>
<p>​       in范围查询</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/in"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatisin</span><span class="o">(</span><span class="n">String</span> <span class="n">author1</span><span class="o">,</span><span class="n">String</span> <span class="n">author2</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">"*"</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span><span class="n">author1</span><span class="o">,</span><span class="n">author2</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">tutorials</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">tutorials</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>打印相关的查询log，可以看到相关查询已使用?进行预编译处理：</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/0bef8b83-bc8b-4ff1-bfa7-615074ccd71d.png"/></p>
<h2 data-content="1" id="28984c6cf95d99da4b8a71042db8bf2b">2.常见注入场景</h2>
<h3 data-content="1" id="29d29b045c6377b19adc9479050e2ccc">1.条件构造器常见注入场景</h3>
<h4 data-content="1" id="2cc4a6b71d66c1cd88a43eab73cbae83">apply</h4>
<div class="highlight"><pre><span></span><span class="n">apply</span><span class="o">(</span><span class="n">String</span> <span class="n">applySql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span>
<span class="n">apply</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">String</span> <span class="n">applySql</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span>
</pre></div>
<ul>
<li>拼接sql</li>
<li>注:该方法可用于数据库<strong>函数</strong> 动态入参的<code>params</code>对应前面<code>applySql</code>内部的<code>{index}</code>部分.这样是不会有sql注入风险的,反之会有!</li>
<li>示例：</li>
</ul>
<p>​       apply()直接拼接sql语句存在sql注入</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/applyvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Tutorial</span> <span class="nf">mybatisapplyvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">author</span><span class="o">,</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span><span class="n">author</span><span class="o">).</span><span class="na">apply</span><span class="o">(</span><span class="s">"title="</span><span class="o">+</span><span class="n">title</span><span class="o">);</span>
    <span class="n">Tutorial</span> <span class="n">tutorial</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">tutorial</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/3761f9e0-5076-485d-9183-73a823fd9f7d.png"/></p>
<p>​       使用{index}params进行预编译处理,不存在sql注入</p>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/applysec"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Tutorial</span> <span class="nf">mybatisapplysec</span><span class="o">(</span><span class="n">String</span> <span class="n">author</span><span class="o">,</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"author"</span><span class="o">,</span><span class="n">author</span><span class="o">).</span><span class="na">apply</span><span class="o">(</span><span class="s">"title={0}"</span><span class="o">,</span><span class="n">title</span><span class="o">);</span>
    <span class="n">Tutorial</span> <span class="n">tutorial</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">tutorial</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/15303ff3-8154-4b77-acb5-3534850c040e.png"/></p>
<h4 data-content="1" id="bbb4ecc804c6cbda70a275d13484a69f">last</h4>
<div class="highlight"><pre><span></span><span class="n">last</span><span class="o">(</span><span class="n">String</span> <span class="n">lastSql</span><span class="o">)</span>
<span class="n">last</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">String</span> <span class="n">lastSql</span><span class="o">)</span>
</pre></div>
<ul>
<li>无视优化规则直接拼接到 sql 的最后</li>
</ul>
<ul>
<li>注：只能调用一次,多次调用以最后一次为准 ，若相关内容用户可控，则存在sql注入风险</li>
</ul>
<ul>
<li>示例：</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/lastvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatislastvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">last</span><span class="o">(</span><span class="s">"order by "</span> <span class="o">+</span> <span class="n">column</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="27aa398cd9847500ca921c2bd08f52ce">exists/notExists</h4>
<div class="highlight"><pre><span></span><span class="n">exists</span><span class="o">(</span><span class="n">String</span> <span class="n">existsSql</span><span class="o">)</span>
<span class="n">exists</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">String</span> <span class="n">existsSql</span><span class="o">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">notExists</span><span class="o">(</span><span class="n">String</span> <span class="n">notExistsSql</span><span class="o">)</span>
<span class="n">notExists</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">String</span> <span class="n">notExistsSql</span><span class="o">)</span>
</pre></div>
<ul>
<li>
<p>拼接EXISTX / NOT EXISTS ( sql语句 )</p>
</li>
<li>
<p>注：若existsSql或notExistsSql中有关内容用户可控，则存在sql注入风险</p>
</li>
<li>
<p>示例：</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/existsvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatisexistsvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="s">"select title from tutorials where title = "</span> <span class="o">+</span> <span class="n">title</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="e44de067f5f7764e876f64fd123e0aa9">having</h4>
<div class="highlight"><pre><span></span><span class="n">having</span><span class="o">(</span><span class="n">String</span> <span class="n">sqlHaving</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span>
<span class="n">having</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">String</span> <span class="n">sqlHaving</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span>
</pre></div>
<ul>
<li>HAVING ( sql语句 ),用于Having查询，一般用配合groupby在对分组统计函数进行过滤的场景中</li>
<li>注：与apply一样，动态入参的params对应前面applySql内部的{index}部分，可以进行预编译防止SQL注入问题。</li>
<li>示例：</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/havingvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatishavingvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"author"</span><span class="o">).</span><span class="na">having</span><span class="o">(</span><span class="s">"id &gt; "</span> <span class="o">+</span><span class="n">id</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="e00e223b789bbb07bc81989eed161c8e">order by</h4>
<ul>
<li>orderBy</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">orderBy</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isAsc</span><span class="o">,</span> <span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
</pre></div>
<ul>
<li>orderByAsc</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">orderByAsc</span><span class="o">(</span><span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
<span class="n">orderByAsc</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
</pre></div>
<ul>
<li>orderByDesc</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">orderByDesc</span><span class="o">(</span><span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
<span class="n">orderByDesc</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
</pre></div>
<ul>
<li>排序：ORDER BY 字段, (ASC/DESC) </li>
<li>注：Order by排序时不能进行预编译处理,故相关内容用户可控的话会存在sql注入风险。</li>
<li>示例：</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/orderbyvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatishorderbyvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">orderBy</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/orderbyAscvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatishorderbyAscvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">orderByAsc</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/orderbyDescvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatishorderbyDescvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">orderByDesc</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="f01bdb168df8c3f792e5ca2efad47e94">group By</h4>
<div class="highlight"><pre><span></span><span class="n">groupBy</span><span class="o">(</span><span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
<span class="n">groupBy</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">R</span><span class="o">...</span> <span class="n">columns</span><span class="o">)</span>
</pre></div>
<ul>
<li>分组：GROUP BY 字段, ...  主要用于用于结合聚合函数，根据一个或多个列对结果集进行分组</li>
<li>示例：</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/gropbycvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatishsgropbycvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">groupBy</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h4 data-content="1" id="a3ba6db9ab0475d95de4085c78b01a86">insql/notinsql</h4>
<div class="highlight"><pre><span></span><span class="n">inSql</span><span class="o">(</span><span class="n">R</span> <span class="n">column</span><span class="o">,</span> <span class="n">String</span> <span class="n">inValue</span><span class="o">)</span>
<span class="n">inSql</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">R</span> <span class="n">column</span><span class="o">,</span> <span class="n">String</span> <span class="n">inValue</span><span class="o">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="n">notInSql</span><span class="o">(</span><span class="n">R</span> <span class="n">column</span><span class="o">,</span> <span class="n">String</span> <span class="n">inValue</span><span class="o">)</span>
<span class="n">notInSql</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">condition</span><span class="o">,</span> <span class="n">R</span> <span class="n">column</span><span class="o">,</span> <span class="n">String</span> <span class="n">inValue</span><span class="o">)</span>
</pre></div>
<ul>
<li>字段IN / NOT IN ( sql语句 )</li>
<li>column字段、inValue字段可控的情况下存在注入风险。</li>
<li>示例：</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/insqlcvuln"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="nf">mybatisinsqlvuln</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">,</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="na">select</span><span class="o">().</span><span class="na">inSql</span><span class="o">(</span><span class="n">column</span><span class="o">,</span><span class="s">"select id from tutorials where id &gt;"</span> <span class="o">+</span> <span class="n">id</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tutorial</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">tutorialMapper</span><span class="o">.</span><span class="na">selectList</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="e2a6512c9c6df3b0694dfdd17d0751f5">2.使用 Wrapper 自定义SQL（特殊的预编译场景）</h3>
<p>​       Wrapper提供了自定义SQL场景，与传统的mybatis一样使用$进行注解，但实际上ew已经做了预编译处理。同样的也支持注解&amp;xml配置。</p>
<p>注：需要mybatis-plus版本 &gt;= 3.0.7 param 参数名要么叫ew,要么加上注解@Param(Constants.WRAPPER) 使用${ew.customSqlSegment} 不支持 Wrapper 内的entity生成where语句</p>
<p>示例：</p>
<h4 data-content="1" id="e40cd97242089d89eb8425ccdafdffda">1.注解模式</h4>
<ul>
<li>配置mapper</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.conditions.Wrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.toolkit.Constants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Person</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonMapper</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from persons ${ew.customSqlSegment}"</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPerson</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">WRAPPER</span><span class="o">)</span> <span class="n">Wrapper</span> <span class="n">wrapper</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
<ul>
<li>​     配置controller</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.conditions.query.QueryWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Person</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Tutorial</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.mapper.PersonMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/sqlimybatis_plus"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mybatis_Plus_SQLI_2</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">PersonMapper</span> <span class="n">personMapper</span><span class="o">;</span>

    <span class="c1">//orderby  R... columns 可控，存在SQL注入风险</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectperson"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPerson</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">){</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">orderByAsc</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//like 自动进行预编译，不存在SQL注入风险</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectpersonlike"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonlike</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">like</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>​       Wrapper自定义模式下like、in等会自动进行预编译，但若存在last、orderby等未进行预编译方法，若相应数据用户可控仍会存在SQL注入风险，风险API仍为2.1中常见注入场景。</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/594737b7-64a7-4ba1-8ce8-e2ceffe4ed31.png"/></p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/c0d99114-1512-49cd-a44c-042202335310.png"/></p>
<h4 data-content="1" id="21d5eb15a41c5eb18536205848c390b8">2.XML模式</h4>
<ul>
<li>配置mapper</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.conditions.Wrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.toolkit.Constants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Person</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonMapper</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from persons ${ew.customSqlSegment}"</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPerson</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">WRAPPER</span><span class="o">)</span> <span class="n">Wrapper</span> <span class="n">wrapper</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXML1</span><span class="o">(</span><span class="n">Wrapper</span> <span class="n">ew</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXML2</span><span class="o">(</span><span class="n">Wrapper</span> <span class="n">ew</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXMLOrdeyBy</span><span class="o">(</span><span class="n">Wrapper</span> <span class="n">ew</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
<ul>
<li>配置XXXXMapper.xml</li>
</ul>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>

<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"org.joychou.mapper.UserMapper"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">type=</span><span class="s">"org.joychou.dao.Person"</span> <span class="na">id=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">"id"</span> <span class="na">property=</span><span class="s">"id"</span> <span class="na">javaType=</span><span class="s">"java.lang.Integer"</span> <span class="na">jdbcType=</span><span class="s">"NUMERIC"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">"name"</span> <span class="na">property=</span><span class="s">"name"</span> <span class="na">javaType=</span><span class="s">"java.lang.String"</span> <span class="na">jdbcType=</span><span class="s">"VARCHAR"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">"address"</span> <span class="na">property=</span><span class="s">"address"</span> <span class="na">javaType=</span><span class="s">"java.lang.String"</span> <span class="na">jdbcType=</span><span class="s">"VARCHAR"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">"city"</span> <span class="na">property=</span><span class="s">"city"</span> <span class="na">javaType=</span><span class="s">"java.lang.String"</span> <span class="na">jdbcType=</span><span class="s">"VARCHAR"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectPersonXML1"</span>  <span class="na">resultMap=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
        select * from persons where ${ew.customSqlSegment}
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectPersonXML2"</span>  <span class="na">resultMap=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
        select * from persons
        <span class="nt">&lt;where&gt;</span>
            ${ew.SqlSegment}
        <span class="nt">&lt;/where&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"selectPersonXMLOrdeyBy"</span>  <span class="na">resultMap=</span><span class="s">"Person"</span><span class="nt">&gt;</span>
        select * from persons ${ew.SqlSegment}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
<ul>
<li>配置controller</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.conditions.query.QueryWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Person</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.dao.Tutorial</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joychou.mapper.PersonMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/sqlimybatis_plus"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mybatis_Plus_SQLI_2</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">PersonMapper</span> <span class="n">personMapper</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectperson"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPerson</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">){</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">orderByAsc</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectperson1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXML1</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectperson2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXML2</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectperson3"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">selectPersonXMLOrderBy</span><span class="o">(</span><span class="n">String</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">wrapper</span><span class="o">.</span><span class="na">orderByAsc</span><span class="o">(</span><span class="n">column</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPerson</span><span class="o">(</span><span class="n">wrapper</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>​       以上selectPersonXML1、selectPersonXML2均实现相同功能，SQL注入问题与注解模式相同。</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/fe61b5f1-b9f5-4919-a5e0-a5f84ca02a34.png"/><br/>
<img src="https://storage.tttang.com/media/attachment/2022/08/30/b22d2fac-51c5-4fcd-958f-0c4161c3fa91.png"/></p>
<h3 data-content="1" id="efa9526dd2bd7ba03847e03b3794ed43">3.分页插件</h3>
<h4 data-content="1" id="acce08f9715f4222f5b971a4614722b6">1.PaginationInnerInterceptor</h4>
<ul>
<li>配置分页插件</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.annotation.DbType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisPlusConfig</span> <span class="o">{</span>

    <span class="cm">/**</span>
<span class="cm">     * 注册插件</span>
<span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">MybatisPlusInterceptor</span> <span class="nf">mybatisPlusInterceptor</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">MybatisPlusInterceptor</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MybatisPlusInterceptor</span><span class="o">();</span>
        <span class="c1">// 添加分页插件</span>
        <span class="n">PaginationInnerInterceptor</span> <span class="n">pageInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PaginationInnerInterceptor</span><span class="o">();</span>
        <span class="c1">// 设置请求的页面大于最大页后操作，true调回到首页，false继续请求。默认false</span>
        <span class="n">pageInterceptor</span><span class="o">.</span><span class="na">setOverflow</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 单页分页条数限制，默认无限制</span>
        <span class="n">pageInterceptor</span><span class="o">.</span><span class="na">setMaxLimit</span><span class="o">(</span><span class="mi">500L</span><span class="o">);</span>
        <span class="c1">// 设置数据库类型</span>
        <span class="n">pageInterceptor</span><span class="o">.</span><span class="na">setDbType</span><span class="o">(</span><span class="n">DbType</span><span class="o">.</span><span class="na">MYSQL</span><span class="o">);</span>

        <span class="n">interceptor</span><span class="o">.</span><span class="na">addInnerInterceptor</span><span class="o">(</span><span class="n">pageInterceptor</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">interceptor</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<ul>
<li>配置controller</li>
</ul>
<div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/selectpage"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="nf">mybatispluspage</span><span class="o">(</span><span class="n">Long</span> <span class="n">page</span><span class="o">,</span><span class="n">Long</span> <span class="n">size</span><span class="o">,</span><span class="n">String</span> <span class="n">order</span><span class="o">){</span>

    <span class="n">QueryWrapper</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">qw</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryWrapper</span><span class="o">&lt;&gt;();</span>
    <span class="n">Page</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personPage</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Page</span><span class="o">&lt;&gt;(</span><span class="n">page</span><span class="o">,</span><span class="n">size</span><span class="o">);</span>
    <span class="n">personPage</span><span class="o">.</span><span class="na">addOrder</span><span class="o">(</span><span class="n">OrderItem</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">order</span><span class="o">));</span>
    <span class="n">IPage</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">iPage</span> <span class="o">=</span> <span class="n">personMapper</span><span class="o">.</span><span class="na">selectPage</span><span class="o">(</span><span class="n">personPage</span><span class="o">,</span> <span class="n">qw</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">persons</span> <span class="o">=</span> <span class="n">iPage</span><span class="o">.</span><span class="na">getRecords</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">persons</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>​       若直接使用addOrder()未进行过滤，则存在SQL注入漏洞。</p>
<p><img src="https://storage.tttang.com/media/attachment/2022/08/30/2432a547-62d3-4132-9076-20ecdb7a90ee.png"/></p>
<h4 data-content="1" id="934a63b772d0cd0b8f583cc3c65ffbf5">2.pagehelper</h4>
<p>因为Order by排序时不能进行预编译处理，所以在使用插件时需要额外注意如下function，同样会存在SQL注入风险：</p>
<ul>
<li>
<strong>com.github.pagehelper.Page</strong><ul>
<li>主要是setOrderBy(java.lang.String)方法</li>
</ul>
</li>
<li>
<strong>com.github.pagehelper.page.PageMethod</strong><ul>
<li>主要是startPage(int,int,java.lang.String)方法</li>
</ul>
</li>
<li>
<strong>com.github.pagehelper.PageHelper</strong><ul>
<li>主要是startPage(int,int,java.lang.String)方法</li>
</ul>
</li>
</ul>
<h2 data-content="1" id="ade3b24b063e8226387c304dc2a3448a">四.Hibernate框架下的SQL注入</h2>
<p>​       Hibernate是一个开放源代码的对象关系映射框架，它对JDBC进行了非常轻量级的对象封装，使得Java程序员可以随心所欲的使用对象编程思维来操纵数据库。</p>
<p>Hibernate可以使用hql来执行SQL语句，也可以直接执行SQL语句，无论是哪种方式都有可能导致SQL注入</p>
<h3 data-content="1" id="bb48eb32eb3daaea9a5081b409f56ee4">HQL</h3>
<p>hql语句：</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">hql</span> <span class="o">=</span> <span class="s">"from People where username = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"' and password = '"</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">;</span>
</pre></div>
<p>这种拼接方式存在SQL注入</p>
<p>正确使用以下几种HQL参数绑定的方式可以有效避免注入的产生：</p>
<h4 data-content="1" id="49655bc3d2a9b96b4b10762d3788c436">1.命名参数（named parameter）</h4>
<div class="highlight"><pre><span></span><span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from users name = ?1"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">String</span> <span class="n">parameter</span> <span class="o">=</span> <span class="s">"g1ts"</span><span class="o">;</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from users name = :name"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</pre></div>
<h4 data-content="1" id="e0131635c37a497aaa85707110ac0e41">2.位置参数（Positional parameter）</h4>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">parameter</span> <span class="o">=</span> <span class="s">"g1ts"</span><span class="o">;</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from users name = ?1"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
</pre></div>
<h4 data-content="1" id="14925140886b9fec9adec78b3b5436e5">3.命名参数列表（named parameter list）</h4>
<div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"g1ts"</span><span class="o">,</span> <span class="s">"g2ts"</span><span class="o">);</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from users where name in (:names)"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"names"</span><span class="o">,</span> <span class="n">names</span><span class="o">);</span>
</pre></div>
<h4 data-content="1" id="9d4ee053f6313d5c11e8bbfa270c09f3">4.类实例（JavaBean）</h4>
<div class="highlight"><pre><span></span><span class="n">user1</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"g1ts"</span><span class="o">);</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from users where name =:name"</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setProperties</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
</pre></div>
<h4 data-content="1" id="d5436ea719dbf5f42c6c03fcba0c7cd8">5.HQL拼接方法</h4>
<p>​       这种方式是最常用，而且容易忽视且容易被注入的，通常做法就是对参数的特殊字符进行过滤，推荐大家使用 Spring工具包的StringEscapeUtils.escapeSql()方法对参数进行过滤：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.commons.lang.StringEscapeUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">StringEscapeUtils</span><span class="o">.</span><span class="na">escapeSql</span><span class="o">(</span><span class="s">"'"</span><span class="o">);</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<h3 data-content="1" id="7064bf7857c602e703138c5fea00ffa1">SQL</h3>
<p>Hibernate支持使用原生SQL语句执行，所以其风险和JDBC是一致的，直接使用拼接的方法时会导致SQL注入</p>
<p>语句如下：</p>
<div class="highlight"><pre><span></span><span class="n">Query</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from user where username = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"' and password = '"</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
</pre></div>
<p>正确写法：</p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">parameter</span> <span class="o">=</span> <span class="s">"g1ts"</span><span class="o">;</span>
<span class="n">Query</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createNativeQuery</span><span class="o">(</span><span class="s">"select * from user where name = :name"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="n">parameter</span><span class="o">);</span>
</pre></div>
<p>注：此文为总结多位师傅文章，包括不限于以下文章：<br/>
<a href="https://www.sec-in.com/article/1073" target="_blank">https://www.sec-in.com/article/1073</a><br/>
<a href="https://www.cnblogs.com/klslb/p/7146889.html" target="_blank">https://www.cnblogs.com/klslb/p/7146889.html</a><br/>
.......</p>
</div>
</div>