<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="70bc79dee09c1b5dc5a5fed25754396f">SQL注入</h2>
<p>漏洞示例代码（代码上下文就不展示了，只看查询数据库操作的类）</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">jdbc_sqli_vul</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"username"</span><span class="o">)</span> <span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
        <span class="n">Connection</span> <span class="n">con</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">con</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Connect to database successfully."</span><span class="o">);</span>

        <span class="c1">// sqli vuln code</span>
        <span class="n">Statement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">;</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span> 
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">res_name</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">res_pwd</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">info</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s: %s\n"</span><span class="o">,</span> <span class="n">res_name</span><span class="o">,</span> <span class="n">res_pwd</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">info</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">con</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Sorry,can`t find the Driver!"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
<p>直接看sql语句<br/>
<code>String sql = "select * from users where username = '" + username + "'";</code><br/>
没有做任何的过滤就只是吧username拼接了一下，一定存在SQL注入的，简单测试一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171104-40fea342-6d6a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171109-43db1078-6d6a-1.png"/></p>
<h3 data-content="1" id="53b9fdde75992d98b34cb027d1101fda">Security code</h3>
<p>预防的方法是 加上预处理方法 防止sql注入<br/>
重复代码就不看了 直接看预处理部分</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username = ?"</span><span class="o">;</span>
            <span class="n">PreparedStatement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">st</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>

            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>  <span class="c1">// sql after prepare statement</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">();</span>
            <span class="o">...</span>
</pre></div>
<p>在sql语句的构造中 直接加上一个问号当作占位符。<code>st.setString(1, username);</code>将占位符替换为我们传入的值 然后执行sql语句</p>
<h3 data-content="1" id="9372c25be685d7cf28f133810018612f">错误使用案例</h3>
<h4 data-content="1" id="53f604699b99831fb47a5886bfb931bc">Demo</h4>
<p>相同代码不再展示</p>
<div class="highlight"><pre><span></span><span class="o">......</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from users where username = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">;</span>
            <span class="n">PreparedStatement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="o">......</span>
</pre></div>
<p>虽然使用了预处理 但是没有使用占位符 我们依旧可以在username处 传入sql语句 达到我们的目的</p>
<h4 data-content="1" id="f6b947a0f97786c8f10ebb0d150d19c6">ofcms  后台SQL注入</h4>
<p>漏洞位置：<br/>
<code>ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/system/SystemGenerateController.java</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171123-4c3fa79c-6d6a-1.png"/></p>
<p>跟踪Db.update函数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171132-51a77692-6d6a-1.png"/></p>
<p>继续跟踪<em>MAIN</em>.update</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171143-587e5832-6d6a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171149-5c39411c-6d6a-1.png"/></p>
<p>一直跟踪update到如下的方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171157-60c1f4d6-6d6a-1.png"/></p>
<p>可以看到这里对sql没有进行任何的过滤<br/>
所以可以直接导致sql注入</p>
<h2 data-content="1" id="63526eee588c20f821f3a8494c0853e9">XSS</h2>
<h3 data-content="1" id="2a39e84821b1be191b7b6fe3bddb7cca">Demo</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">reflect</span><span class="o">(</span><span class="n">String</span> <span class="n">xss</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">xss</span><span class="o">;</span>
    <span class="o">}</span> 
    <span class="c1">//反射型XSS</span>

<span class="kd">public</span> <span class="n">String</span> <span class="nf">store</span><span class="o">(</span><span class="n">String</span> <span class="n">xss</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="s">"xss"</span><span class="o">,</span> <span class="n">xss</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"Set param into cookie"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//存储型XSS</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">show</span><span class="o">(</span><span class="nd">@CookieValue</span><span class="o">(</span><span class="s">"xss"</span><span class="o">)</span> <span class="n">String</span> <span class="n">xss</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">xss</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//将cookie中的XSS展示到页面中</span>
</pre></div>
<p>这里的存储型XSS是存储到cookie中 正常网站的存储型XSS一般都是存储到数据库中<br/>
反射型XSS图示：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171211-69068bf2-6d6a-1.png"/></p>
<p>存储型XSS图示：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171220-6e2f463c-6d6a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171224-708a508e-6d6a-1.png"/></p>
<h3 data-content="1" id="c3d7d890ca398f0f31c10a1a87b9ea7a">ofcms 1.1.3版本文章评论功能存在XSS</h3>
<p>漏洞存在处：<br/>
<code>ofcms-admin\ofcms-api\src\main\java\com\ofsoft\cms\api\v1\CommentApi.java</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171233-75eed8f6-6d6a-1.png"/></p>
<p>save方法中 将值传入params中 并且添加评论者的ip地址之后 直接保存到数据库中<br/>
通过跟踪<code>Db._getSqlPara_</code>方法和<code>Db._update_</code>方法 并未发现其对评论者的评论进行任何过滤<br/>
payload：&lt;script&gt;alert(1)&lt;/script&gt;</p>
<h3 data-content="1" id="8333f9f94d9d8a9f09de0f4710b0f60a">Security code</h3>
<p>写入一个替换特殊符号的方法</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">safe</span><span class="o">(</span><span class="n">String</span> <span class="n">xss</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">encode</span><span class="o">(</span><span class="n">xss</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">encode</span><span class="o">(</span><span class="n">String</span> <span class="n">origin</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"&amp;"</span><span class="o">,</span> <span class="s">"&amp;amp;"</span><span class="o">);</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"&lt;"</span><span class="o">,</span> <span class="s">"&amp;lt;"</span><span class="o">);</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"&gt;"</span><span class="o">,</span> <span class="s">"&amp;gt;"</span><span class="o">);</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"\""</span><span class="o">,</span> <span class="s">"&amp;quot;"</span><span class="o">);</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"'"</span><span class="o">,</span> <span class="s">"&amp;#x27;"</span><span class="o">);</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">origin</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="s">"&amp;#x2F;"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">origin</span><span class="o">;</span>
         <span class="c1">//将各个符号进行替换</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>替换符号只是一种方法<br/>
或者可以检测不合法的符号，如果字段里存在不合法的符号就返回此字段不合法。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">safe</span><span class="o">(</span><span class="n">String</span> <span class="n">xss</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">code</span><span class="o">(</span><span class="n">xss</span><span class="o">)==</span><span class="s">"false"</span><span class="o">){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"参数不合法"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">code</span><span class="o">(</span><span class="n">String</span> <span class="n">origin</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">origin</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">""</span><span class="o">+</span><span class="sc">'&amp;'</span><span class="o">)||</span><span class="n">origin</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">""</span><span class="o">+</span><span class="sc">'&lt;'</span><span class="o">)||</span><span class="n">origin</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">""</span><span class="o">+</span><span class="sc">'&gt;'</span><span class="o">)||</span><span class="n">origin</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">""</span><span class="o">+</span><span class="sc">'&amp;'</span><span class="o">)||</span><span class="n">origin</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">""</span><span class="o">+</span><span class="sc">'"'</span><span class="o">)){</span>
            <span class="k">return</span> <span class="s">"false"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"true"</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>这只是这个想法的简单实现，对特殊符号的过滤都没写全</p>
<h2 data-content="1" id="bca3150069832d48cc1ec52fd82427c9">文件上传</h2>
<h3 data-content="1" id="e2ccc7d4e426aeb96149c17f9801d7e1">Demo</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">singleFileUpload</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"file"</span><span class="o">)</span> <span class="n">MultipartFile</span> <span class="n">file</span><span class="o">,</span>
                                   <span class="n">RedirectAttributes</span> <span class="n">redirectAttributes</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 赋值给uploadStatus.html里的动态参数message</span>
            <span class="n">redirectAttributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"Please select a file to upload"</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"redirect:/file/status"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Get the file and save it somewhere</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">UPLOADED_FOLDER</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>

            <span class="n">redirectAttributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span>
                    <span class="s">"You successfully uploaded '"</span> <span class="o">+</span> <span class="n">UPLOADED_FOLDER</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">redirectAttributes</span><span class="o">.</span><span class="na">addFlashAttribute</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"upload failed"</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="s">"redirect:/file/status"</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>可以看到就是正常上传<br/>
可以上传任何文件 没有任何过滤之类的</p>
<h3 data-content="1" id="f5ac9bf45f57aa4838e3ce83aa0e579b">security code</h3>
<p>判断文件后缀是否为白名单 文件类型是否在黑名单中（或者在文件类型中也做一个白名单）</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">uploadPicture</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"file"</span><span class="o">)</span> <span class="n">MultipartFile</span> <span class="n">multifile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">multifile</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Please select a file to upload"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">multifile</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">Suffix</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">));</span> <span class="c1">// 获取文件后缀名</span>
        <span class="n">String</span> <span class="n">mimeType</span> <span class="o">=</span> <span class="n">multifile</span><span class="o">.</span><span class="na">getContentType</span><span class="o">();</span> <span class="c1">// 获取MIME类型</span>
        <span class="n">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">UPLOADED_FOLDER</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">;</span>
        <span class="n">File</span> <span class="n">excelFile</span> <span class="o">=</span> <span class="n">convert</span><span class="o">(</span><span class="n">multifile</span><span class="o">);</span>


        <span class="c1">// 判断文件后缀名是否在白名单内  校验1</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">picSuffixList</span> <span class="o">=</span> <span class="o">{</span><span class="s">".jpg"</span><span class="o">,</span> <span class="s">".png"</span><span class="o">,</span> <span class="s">".jpeg"</span><span class="o">,</span> <span class="s">".gif"</span><span class="o">,</span> <span class="s">".bmp"</span><span class="o">,</span> <span class="s">".ico"</span><span class="o">};</span>
        <span class="kt">boolean</span> <span class="n">suffixFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">white_suffix</span> <span class="o">:</span> <span class="n">picSuffixList</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Suffix</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">white_suffix</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">//转为小写 和白名单中的后缀进行对比</span>
                <span class="n">suffixFlag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">suffixFlag</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"[-] Suffix error: "</span> <span class="o">+</span> <span class="n">Suffix</span><span class="o">);</span>
            <span class="n">deleteFile</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"Upload failed. Illeagl picture."</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="c1">// 判断MIME类型是否在黑名单内 校验2</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">mimeTypeBlackList</span> <span class="o">=</span> <span class="o">{</span>
                <span class="s">"text/html"</span><span class="o">,</span>
                <span class="s">"text/javascript"</span><span class="o">,</span>
                <span class="s">"application/javascript"</span><span class="o">,</span>
                <span class="s">"application/ecmascript"</span><span class="o">,</span>
                <span class="s">"text/xml"</span><span class="o">,</span>
                <span class="s">"application/xml"</span>
        <span class="o">};</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">blackMimeType</span> <span class="o">:</span> <span class="n">mimeTypeBlackList</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 用contains是为了防止text/html;charset=UTF-8绕过</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">SecurityUtil</span><span class="o">.</span><span class="na">replaceSpecialStr</span><span class="o">(</span><span class="n">mimeType</span><span class="o">).</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">blackMimeType</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"[-] Mime type error: "</span> <span class="o">+</span> <span class="n">mimeType</span><span class="o">);</span>
                <span class="n">deleteFile</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
                <span class="k">return</span> <span class="s">"Upload failed. Illeagl picture."</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// 判断文件内容是否是图片 校验3</span>
        <span class="kt">boolean</span> <span class="n">isImageFlag</span> <span class="o">=</span> <span class="n">isImage</span><span class="o">(</span><span class="n">excelFile</span><span class="o">);</span>
        <span class="n">deleteFile</span><span class="o">(</span><span class="n">randomFilePath</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">isImageFlag</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"[-] File is not Image"</span><span class="o">);</span>
            <span class="n">deleteFile</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"Upload failed. Illeagl picture."</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Get the file and save it somewhere</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">multifile</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">UPLOADED_FOLDER</span> <span class="o">+</span> <span class="n">multifile</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">());</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">deleteFile</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"Upload failed"</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[+] Safe file. Suffix: {}, MIME: {}"</span><span class="o">,</span> <span class="n">Suffix</span><span class="o">,</span> <span class="n">mimeType</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[+] Successfully uploaded {}"</span><span class="o">,</span> <span class="n">filePath</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"You successfully uploaded '%s'"</span><span class="o">,</span> <span class="n">filePath</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">deleteFile</span><span class="o">(</span><span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">delFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">delFile</span><span class="o">.</span><span class="na">isFile</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">delFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">delFile</span><span class="o">.</span><span class="na">delete</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"[+] "</span> <span class="o">+</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s">" delete successfully!"</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">filePath</span> <span class="o">+</span> <span class="s">" delete failed!"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 为了使用ImageIO.read()</span>
<span class="cm">     *</span>
<span class="cm">     * 不建议使用transferTo，因为原始的MultipartFile会被覆盖</span>
<span class="cm">     * https://stackoverflow.com/questions/24339990/how-to-convert-a-multipart-file-to-file</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">File</span> <span class="nf">convert</span><span class="o">(</span><span class="n">MultipartFile</span> <span class="n">multiFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">multiFile</span><span class="o">.</span><span class="na">getOriginalFilename</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">fileName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">));</span>
        <span class="n">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">Generators</span><span class="o">.</span><span class="na">timeBasedGenerator</span><span class="o">().</span><span class="na">generate</span><span class="o">();</span>
        <span class="n">randomFilePath</span> <span class="o">=</span> <span class="n">UPLOADED_FOLDER</span> <span class="o">+</span> <span class="n">uuid</span> <span class="o">+</span> <span class="n">suffix</span><span class="o">;</span>
        <span class="c1">// 随机生成一个同后缀名的文件</span>
        <span class="n">File</span> <span class="n">convFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">randomFilePath</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">convFile</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">ret</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">convFile</span><span class="o">);</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">multiFile</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
        <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">convFile</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Check if the file is a picture.</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isImage</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">BufferedImage</span> <span class="n">bi</span> <span class="o">=</span> <span class="n">ImageIO</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">file</span><span class="o">);</span> <span class="c1">//读取图片内容</span>
        <span class="k">return</span> <span class="n">bi</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>这一串代码很完美的解决了文件上传产生的各种问题<br/>
文件被使用UUID库随机常见一个名字 可以防止恶意文件上传被连接访问<br/>
1.通过suffixFlag来判断文件的后缀名是否处于白名单中<br/>
2.然后使用<code>SecurityUtil.replaceSpecialStr</code>方法处理一下<code>mimeType</code>，将非0-9a-zA-Z/-.的字符替换为空，然后和黑名单类型做对比<br/>
3.通过<code>isImage</code>方法 判断文件是否为图片文件<br/>
以上者三个校验 有一个无法通过就会将文件直接删除。</p>
<h2 data-content="1" id="85fe92c1276d0eea65b279600cb682c6">XXE</h2>
<p>XXE：XML External Entity 即外部实体从安全角度理解成XML External Entity attack 外部实体注入攻击。可以导致读取任意文件或SSRF、端口探测、DoS拒绝服务攻击、执行系统命令、攻击内部网站等。</p>
<h3 data-content="1" id="b8a36bee8a703a23f11b00ebcd1560a9">Demo</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">DocumentBuilderVuln01</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">WebUtils</span><span class="o">.</span><span class="na">getRequestBody</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="n">DocumentBuilderFactory</span> <span class="n">dbf</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">DocumentBuilder</span> <span class="n">db</span> <span class="o">=</span> <span class="n">dbf</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
            <span class="n">StringReader</span> <span class="n">sr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="n">InputSource</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">sr</span><span class="o">);</span>
            <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>  <span class="c1">// parse xml</span>

            <span class="c1">// 遍历xml节点name和value</span>
            <span class="n">StringBuilder</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
            <span class="n">NodeList</span> <span class="n">rootNodeList</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rootNodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">Node</span> <span class="n">rootNode</span> <span class="o">=</span> <span class="n">rootNodeList</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">NodeList</span> <span class="n">child</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">child</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                    <span class="n">buf</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s: %s\n"</span><span class="o">,</span> <span class="n">node</span><span class="o">.</span><span class="na">getNodeName</span><span class="o">(),</span> <span class="n">node</span><span class="o">.</span><span class="na">getTextContent</span><span class="o">()));</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">sr</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">EXCEPT</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<p>可以看到，没有进行过滤和防护，直接解析我们传入的XML文件，导致XXE<br/>
payload：</p>
<div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">book</span> <span class="n">id</span><span class="o">=</span><span class="s">"1"</span><span class="o">&gt;</span>       
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">Good</span> <span class="n">Job</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>       
    <span class="o">&lt;</span><span class="n">author</span><span class="o">&gt;</span><span class="n">ol4three</span><span class="o">&lt;/</span><span class="n">author</span><span class="o">&gt;</span>       
    <span class="o">&lt;</span><span class="n">year</span><span class="o">&gt;</span><span class="mi">2021</span><span class="o">&lt;/</span><span class="n">year</span><span class="o">&gt;</span>       
    <span class="o">&lt;</span><span class="n">price</span><span class="o">&gt;</span><span class="mf">100.00</span><span class="o">&lt;/</span><span class="n">price</span><span class="o">&gt;</span>   
<span class="o">&lt;/</span><span class="n">book</span><span class="o">&gt;</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171303-87c3f5ca-6d6a-1.png"/></p>
<h3 data-content="1" id="d73e2b1528c4f27f116d0ac08b58c475">Security code</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">DocumentBuilderSec</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">WebUtils</span><span class="o">.</span><span class="na">getRequestBody</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>

            <span class="n">DocumentBuilderFactory</span> <span class="n">dbf</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-general-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">dbf</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s">"http://xml.org/sax/features/external-parameter-entities"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">DocumentBuilder</span> <span class="n">db</span> <span class="o">=</span> <span class="n">dbf</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
            <span class="n">StringReader</span> <span class="n">sr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="n">InputSource</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">sr</span><span class="o">);</span>
            <span class="n">db</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>  <span class="c1">// parse xml</span>
            <span class="n">sr</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">EXCEPT</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">"DocumentBuilder xxe security code"</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>serFeature是关键，设置了过后，再解析xml时会直接报错<br/>
因为我对XXE了解不是很深刻 所以对于此漏洞的审计也是比较浅薄<br/>
对XXE有兴趣的师傅可以移步<br/>
<a href="https://www.freebuf.com/articles/web/318984.html" target="_blank">https://www.freebuf.com/articles/web/318984.html</a><br/>
<a href="https://blog.spoock.com/2018/10/23/java-xxe/" target="_blank">https://blog.spoock.com/2018/10/23/java-xxe/</a></p>
<h2 data-content="1" id="97852ed59ff33ba190ee57b438002791">路径遍历漏洞</h2>
<h3 data-content="1" id="6f3b07379fcb377232abf70d19304d80">Demo</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">getImage</span><span class="o">(</span><span class="n">String</span> <span class="n">filepath</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getImgBase64</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
    <span class="o">}</span>
<span class="kd">private</span> <span class="n">String</span> <span class="nf">getImgBase64</span><span class="o">(</span><span class="n">String</span> <span class="n">imgFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Working directory: "</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">));</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"File path: "</span> <span class="o">+</span> <span class="n">imgFile</span><span class="o">);</span>

        <span class="n">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">imgFile</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">exists</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">imgFile</span><span class="o">));</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">encodeBase64</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"File doesn't exist or is not a file."</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<p>对路径参数没有进行任何过滤。简单的判断传入的路径参数存不存在，然后将文件内容base64加密返回。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171334-9a5dcdbe-6d6a-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221126171338-9cdcde36-6d6a-1.png"/></p>
<h3 data-content="1" id="1e6a977b2604c83fc4b8bededcc6a4cf">Security code</h3>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">getImageSec</span><span class="o">(</span><span class="n">String</span> <span class="n">filepath</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">SecurityUtil</span><span class="o">.</span><span class="na">pathFilter</span><span class="o">(</span><span class="n">filepath</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Illegal file path: "</span> <span class="o">+</span> <span class="n">filepath</span><span class="o">);</span>
            <span class="k">return</span> <span class="s">"Bad boy. Illegal file path."</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">getImgBase64</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
    <span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">pathFilter</span><span class="o">(</span><span class="n">String</span> <span class="n">filepath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">;</span>

        <span class="c1">// use while to sovle multi urlencode</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">temp</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">'%'</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span> <span class="s">"utf-8"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Unsupported encoding exception: "</span> <span class="o">+</span> <span class="n">filepath</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">".."</span><span class="o">)</span> <span class="o">||</span> <span class="n">temp</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="sc">'/'</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="c1">//对url传入的参数进行判断</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">filepath</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p>可以看到<code>pathFilter</code>方法对URL传入的路径参数进行判断 ，但是判断并不完全，只是一个示例，应该根据实际情况进行改变，比如系统 Linux或者Windows又或者是业务逻辑情况，进行自定义的更改。<br/>
如果是Linux系统应该禁用<code>/  ,  ..</code><br/>
<code>temp.contains("..") || temp.contains("/")</code><br/>
Windows系统应该禁用<code>:  ,  ..  , c , d , e, /</code> 防止切换不同盘符进行文件读取<br/>
<code>temp.contains("..") || temp.contains("/") || temp.contains(":") ||temp.charAt(0) == "c" ...</code></p>
<h2 data-content="1" id="ae70355f2ee34d4a0b87f5daa3fcbe67">参考</h2>
<p><a href="https://github.com/JoyChou93/java-sec-code" target="_blank">java-sec-code</a></p>
</div>
</div>